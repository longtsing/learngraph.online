# LangGraph Time Travel è¯¦ç»†è§£è¯»

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£è¯» LangGraph ä¸­çš„ **Time Travelï¼ˆæ—¶é—´æ—…è¡Œï¼‰** åŠŸèƒ½ã€‚è¿™æ˜¯ä¸€é¡¹å¼ºå¤§çš„è°ƒè¯•å’ŒçŠ¶æ€ç®¡ç†èƒ½åŠ›ï¼Œå…è®¸ä½ æŸ¥çœ‹ã€å›æ”¾ï¼Œç”šè‡³ä»å›¾çš„å†å²çŠ¶æ€ä¸­"åˆ†å‰"å‡ºæ–°çš„æ‰§è¡Œè·¯å¾„ã€‚é€šè¿‡ Time Travelï¼Œä½ å¯ä»¥åƒæ“ä½œç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸€æ ·ç®¡ç† Agent çš„æ‰§è¡Œå†å²ã€‚

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **Time Travel** | å›¾å†å²çŠ¶æ€çš„æµè§ˆã€å›æ”¾å’Œåˆ†å‰èƒ½åŠ›ï¼Œå…è®¸ä»ä»»æ„å†å²ç‚¹é‡æ–°æ‰§è¡Œæˆ–åˆ›å»ºæ–°åˆ†æ”¯ | åŸºäº checkpointer ä¿å­˜çš„çŠ¶æ€å¿«ç…§å®ç° | â­â­â­â­â­ |
| **get_state_history()** | è·å–å›¾å®Œæ•´æ‰§è¡Œå†å²çš„æ–¹æ³•ï¼Œè¿”å›æŒ‰æ—¶é—´å€’åºæ’åˆ—çš„æ‰€æœ‰ StateSnapshot | `list(graph.get_state_history(config))` | â­â­â­â­â­ |
| **StateSnapshot** | çŠ¶æ€å¿«ç…§å¯¹è±¡ï¼ŒåŒ…å« values(çŠ¶æ€æ•°æ®)ã€config(å« checkpoint_id)ã€metadata ç­‰ | LangGraph è¿”å›çš„çŠ¶æ€å¿«ç…§æ•°æ®ç»“æ„ | â­â­â­â­â­ |
| **Checkpoint** | å›¾æ‰§è¡Œè¿‡ç¨‹ä¸­æŸä¸ªæ—¶åˆ»çš„å®Œæ•´çŠ¶æ€å¤‡ä»½ï¼Œç”± checkpointer è‡ªåŠ¨åœ¨æ¯ä¸ªèŠ‚ç‚¹åä¿å­˜ | æŒä¹…åŒ–çš„çŠ¶æ€å¿«ç…§ï¼ŒåŒ…å«å”¯ä¸€çš„ checkpoint_id | â­â­â­â­â­ |
| **checkpoint_id** | æ£€æŸ¥ç‚¹çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºæŒ‡å®šå›æ”¾æˆ–åˆ†å‰çš„èµ·ç‚¹ | å­—ç¬¦ä¸²ç±»å‹ï¼Œé€šå¸¸æ˜¯ UUID æ ¼å¼ | â­â­â­â­â­ |
| **å›æ”¾(Replaying)** | ä»å†å² checkpoint é‡æ–°æ‰§è¡Œå›¾ï¼Œä¸ä¿®æ”¹çŠ¶æ€ï¼Œç”¨äºé‡ç°æ‰§è¡Œè¿‡ç¨‹ | `graph.stream(None, checkpoint_config)` | â­â­â­â­â­ |
| **åˆ†å‰(Forking)** | ä»å†å² checkpoint åˆ›å»ºæ–°æ‰§è¡Œåˆ†æ”¯ï¼Œä¿®æ”¹çŠ¶æ€åç»§ç»­æ‰§è¡Œï¼Œæ¢ç´¢æ›¿ä»£è·¯å¾„ | update_state() + stream(None) ç»„åˆ | â­â­â­â­â­ |
| **parent_config** | StateSnapshot çš„å±æ€§ï¼ŒæŒ‡å‘çˆ¶ checkpoint çš„é…ç½®ï¼Œç”¨äºè¿½æº¯å†å²é“¾ | å­—å…¸ç±»å‹ï¼ŒåŒ…å«çˆ¶ checkpoint_id | â­â­â­â­ |
| **æ¶ˆæ¯è¦†ç›–æœºåˆ¶** | åˆ†å‰æ—¶ä¿æŒç›¸åŒçš„ Message ID å®ç°æ¶ˆæ¯æ›¿æ¢ï¼Œè€Œéè¿½åŠ æ–°æ¶ˆæ¯ | åˆ©ç”¨ add_messages reducer çš„ ID åŒ¹é…é€»è¾‘ | â­â­â­â­â­ |
| **å†å²åˆ†æ”¯** | åˆ†å‰æ“ä½œåˆ›å»ºçš„æ–°æ‰§è¡Œè·¯å¾„ï¼Œä¸åŸå§‹å†å²å¹¶å­˜ï¼Œäº’ä¸å½±å“ | ç±»ä¼¼ Git çš„åˆ†æ”¯æ¦‚å¿µ | â­â­â­â­ |
| **Thread éš”ç¦»** | ä¸åŒ thread_id æ‹¥æœ‰ç‹¬ç«‹çš„çŠ¶æ€å’Œå†å²ï¼Œäº’ä¸å¹²æ‰° | é€šè¿‡ configurable.thread_id åŒºåˆ† | â­â­â­â­â­ |
| **MemorySaver** | å†…å­˜ç‰ˆ checkpointerï¼Œé€‚åˆå¼€å‘æµ‹è¯•ï¼Œæ•°æ®ä¸æŒä¹…åŒ– | `from langgraph.checkpoint.memory import MemorySaver` | â­â­â­â­ |

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ Time Travelï¼Ÿ

Time Travel æ˜¯ LangGraph æä¾›çš„ä¸€ç§é«˜çº§çŠ¶æ€ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…å«ä¸‰ä¸ªæ ¸å¿ƒèƒ½åŠ›ï¼š

1. **æµè§ˆå†å²ï¼ˆBrowsing Historyï¼‰**
   - æŸ¥çœ‹å›¾æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰å†å²çŠ¶æ€
   - è®¿é—®æ¯ä¸ª checkpointï¼ˆæ£€æŸ¥ç‚¹ï¼‰çš„å®Œæ•´æ•°æ®
   - äº†è§£å›¾åœ¨æ¯ä¸ªæ­¥éª¤çš„çŠ¶æ€å¿«ç…§

2. **å›æ”¾ï¼ˆReplayingï¼‰**
   - ä»å†å²ä¸­çš„æŸä¸ª checkpoint é‡æ–°æ‰§è¡Œå›¾
   - ç”¨äºå¤ç°é—®é¢˜æˆ–éªŒè¯ä¿®å¤
   - ä¸æ”¹å˜å†å²ï¼Œåªæ˜¯é‡æ–°è¿è¡Œ

3. **åˆ†å‰ï¼ˆForkingï¼‰**
   - ä»å†å²çŠ¶æ€åˆ›å»ºæ–°çš„æ‰§è¡Œåˆ†æ”¯
   - ä¿®æ”¹å†å²çŠ¶æ€å¹¶ç»§ç»­æ‰§è¡Œ
   - æ¢ç´¢"å¦‚æœå½“æ—¶è¾“å…¥ä¸åŒä¼šæ€æ ·"çš„åœºæ™¯

### ä¸ºä»€ä¹ˆéœ€è¦ Time Travelï¼Ÿ

åœ¨å¼€å‘ AI Agent æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°è¿™äº›éœ€æ±‚ï¼š

- **è°ƒè¯•é—®é¢˜**ï¼šAgent åœ¨ç¬¬ 5 æ­¥å‡ºé”™äº†ï¼Œæƒ³å›åˆ°ç¬¬ 3 æ­¥é‡æ–°æ‰§è¡Œ
- **æ¢ç´¢å‡è®¾**ï¼šå¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯ "5 * 3" è€Œä¸æ˜¯ "2 * 3"ï¼Œç»“æœä¼šæ€æ ·ï¼Ÿ
- **æ¢å¤æ‰§è¡Œ**ï¼šAgent æ„å¤–ä¸­æ–­ï¼Œæƒ³ä»ä¸Šæ¬¡çš„çŠ¶æ€ç»§ç»­
- **æµ‹è¯•ä¿®æ”¹**ï¼šä¿®æ”¹äº† Agent é€»è¾‘ï¼Œæƒ³ç”¨å†å²æ•°æ®æµ‹è¯•æ–°ç‰ˆæœ¬

### Human-in-the-Loop çš„ä¸‰å¤§åº”ç”¨

Time Travel æ˜¯ Human-in-the-Loop æ¨¡å¼çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼š

| åº”ç”¨ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|---------|
| **Approvalï¼ˆå®¡æ‰¹ï¼‰** | åœ¨å…³é”®èŠ‚ç‚¹æš‚åœï¼Œç­‰å¾…äººç±»æ‰¹å‡† | æ‰§è¡Œæ•æ„Ÿæ“ä½œå‰ç¡®è®¤ |
| **Debuggingï¼ˆè°ƒè¯•ï¼‰** | å›æ”¾å†å²çŠ¶æ€ï¼Œé‡ç°é—®é¢˜ | æ’æŸ¥ bugï¼ŒéªŒè¯ä¿®å¤ |
| **Editingï¼ˆç¼–è¾‘ï¼‰** | ä¿®æ”¹çŠ¶æ€ï¼Œæ”¹å˜æ‰§è¡Œè·¯å¾„ | çº æ­£é”™è¯¯ï¼Œæ¢ç´¢å¯èƒ½æ€§ |

---

## ğŸ­ å®æˆ˜æ¡ˆä¾‹ï¼šæ•°å­¦è®¡ç®— Agent

æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªç®€å•çš„æ•°å­¦è®¡ç®— Agentï¼Œæ¼”ç¤º Time Travel çš„å®Œæ•´åŠŸèƒ½ï¼š

**Agent åŠŸèƒ½ï¼š**
1. æ¥æ”¶ç”¨æˆ·çš„æ•°å­¦é—®é¢˜ï¼ˆå¦‚ "Multiply 2 and 3"ï¼‰
2. è°ƒç”¨å·¥å…·æ‰§è¡Œè®¡ç®—
3. è¿”å›ç»“æœ

**Time Travel æ¼”ç¤ºï¼š**
1. æµè§ˆ Agent çš„æ‰§è¡Œå†å²
2. å›æ”¾æŸä¸ªå†å²çŠ¶æ€
3. åˆ†å‰å†å²çŠ¶æ€å¹¶ä¿®æ”¹è¾“å…¥

### ç³»ç»Ÿæ¶æ„å›¾

```
ç”¨æˆ·è¾“å…¥ï¼š"Multiply 2 and 3"
        â†“
    [assistant] è§£ææ„å›¾ â†’ è°ƒç”¨ multiply tool
        â†“
     [tools] æ‰§è¡Œè®¡ç®— â†’ è¿”å›ç»“æœ
        â†“
    [assistant] ç”Ÿæˆå›å¤ â†’ "The result is 6"
        â†“
      (END)

æ¯ä¸€æ­¥éƒ½ä¼šä¿å­˜ checkpointï¼Œå¯ä»¥éšæ—¶å›æº¯ï¼
```

---

## ğŸ”§ ä»£ç å®ç°è¯¦è§£

### 1. å®šä¹‰å·¥å…·å‡½æ•°

```python
def multiply(a: int, b: int) -> int:
    """Multiply a and b.

    Args:
        a: first int
        b: second int
    """
    return a * b

def add(a: int, b: int) -> int:
    """Adds a and b.

    Args:
        a: first int
        b: second int
    """
    return a + b

def divide(a: int, b: int) -> float:
    """Divide a by b.

    Args:
        a: first int
        b: second int
    """
    return a / b

tools = [add, multiply, divide]
```

**è¯´æ˜ï¼š**
- å®šä¹‰ä¸‰ä¸ªåŸºæœ¬æ•°å­¦è¿ç®—å·¥å…·
- ä½¿ç”¨æ ‡å‡†çš„ docstring æ ¼å¼æè¿°å·¥å…·åŠŸèƒ½
- LLM ä¼šæ ¹æ® docstring ç†è§£å·¥å…·çš„ç”¨é€”

---

### 2. ç»‘å®šå·¥å…·åˆ° LLM

```python
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(model="gpt-5-nano")
llm_with_tools = llm.bind_tools(tools)
```

**LangChain çŸ¥è¯†ç‚¹ï¼šbind_tools**

`bind_tools()` å°†å·¥å…·æ³¨å†Œåˆ° LLMï¼Œä½¿å…¶èƒ½å¤Ÿï¼š
- ç†è§£å·¥å…·çš„åŠŸèƒ½
- å†³å®šä½•æ—¶è°ƒç”¨å·¥å…·
- ç”Ÿæˆå·¥å…·è°ƒç”¨çš„å‚æ•°

---

### 3. å®šä¹‰å›¾ç»“æ„

```python
from langgraph.checkpoint.memory import MemorySaver
from langgraph.graph import MessagesState, StateGraph, START, END
from langgraph.prebuilt import tools_condition, ToolNode
from langchain_core.messages import AIMessage, HumanMessage, SystemMessage

# ç³»ç»Ÿæç¤ºè¯
sys_msg = SystemMessage(content="You are a helpful assistant tasked with performing arithmetic on a set of inputs.")

# å®šä¹‰ assistant èŠ‚ç‚¹
def assistant(state: MessagesState):
    return {"messages": [llm_with_tools.invoke([sys_msg] + state["messages"])]}

# åˆ›å»ºå›¾
builder = StateGraph(MessagesState)

# æ·»åŠ èŠ‚ç‚¹
builder.add_node("assistant", assistant)
builder.add_node("tools", ToolNode(tools))

# æ·»åŠ è¾¹
builder.add_edge(START, "assistant")
builder.add_conditional_edges(
    "assistant",
    tools_condition,  # è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·
)
builder.add_edge("tools", "assistant")

# ç¼–è¯‘å›¾ï¼ˆå¸¦ checkpointerï¼‰
memory = MemorySaver()
graph = builder.compile(checkpointer=memory)
```

**å…³é”®æ¦‚å¿µè§£æï¼š**

#### MessagesState

è¿™æ˜¯ LangGraph å†…ç½®çš„çŠ¶æ€ç±»ï¼Œä¸“é—¨ç”¨äºç®¡ç†å¯¹è¯æ¶ˆæ¯ï¼š

```python
class MessagesState(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]
    # add_messages æ˜¯å†…ç½® reducerï¼Œè‡ªåŠ¨åˆå¹¶æ¶ˆæ¯
```

#### MemorySaver

è¿™æ˜¯ LangGraph çš„ **checkpointerï¼ˆæ£€æŸ¥ç‚¹ç®¡ç†å™¨ï¼‰**ï¼š

```python
checkpointer=MemorySaver()
```

**ä½œç”¨ï¼š**
- åœ¨æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåè‡ªåŠ¨ä¿å­˜çŠ¶æ€
- å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆé€‚åˆå¼€å‘æµ‹è¯•ï¼‰
- ç”Ÿäº§ç¯å¢ƒå¯ä»¥ä½¿ç”¨æŒä¹…åŒ–çš„ checkpointerï¼ˆå¦‚æ•°æ®åº“ï¼‰

**é‡è¦ï¼š** Time Travel åŠŸèƒ½ä¾èµ– checkpointerï¼æ²¡æœ‰ checkpointer å°±æ²¡æœ‰å†å²çŠ¶æ€ã€‚

#### tools_condition

è¿™æ˜¯ LangGraph é¢„æ„å»ºçš„æ¡ä»¶å‡½æ•°ï¼š

```python
tools_condition(state)
```

**åŠŸèƒ½ï¼š**
- æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦åŒ…å«å·¥å…·è°ƒç”¨
- å¦‚æœæ˜¯å·¥å…·è°ƒç”¨ â†’ è·¯ç”±åˆ° "tools" èŠ‚ç‚¹
- å¦‚æœä¸æ˜¯ â†’ è·¯ç”±åˆ° END

---

### 4. æ‰§è¡Œå›¾

```python
# è¾“å…¥
initial_input = {"messages": HumanMessage(content="Multiply 2 and 3")}

# çº¿ç¨‹é…ç½®ï¼ˆç”¨äºæ ‡è¯†ä¼šè¯ï¼‰
thread = {"configurable": {"thread_id": "1"}}

# è¿è¡Œå›¾
for event in graph.stream(initial_input, thread, stream_mode="values"):
    event['messages'][-1].pretty_print()
```

**è¾“å‡ºï¼š**
```
================================ Human Message =================================
Multiply 2 and 3

================================== Ai Message ==================================
Tool Calls:
  multiply (call_ikJxMpb777bKMYgmM3d9mYjW)
  Args:
    a: 2
    b: 3

================================= Tool Message =================================
Name: multiply
6

================================== Ai Message ==================================
The result of multiplying 2 and 3 is 6.
```

**æ‰§è¡Œæµç¨‹ï¼š**
1. ç”¨æˆ·è¾“å…¥ "Multiply 2 and 3"
2. Assistant èŠ‚ç‚¹è¯†åˆ«éœ€è¦è°ƒç”¨ `multiply` å·¥å…·
3. Tools èŠ‚ç‚¹æ‰§è¡Œ `multiply(2, 3)` è¿”å› `6`
4. Assistant èŠ‚ç‚¹ç”Ÿæˆæœ€ç»ˆå›å¤

**Python çŸ¥è¯†ç‚¹ï¼šthread_id**

```python
thread = {"configurable": {"thread_id": "1"}}
```

- `thread_id` ç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªä¼šè¯
- åŒä¸€ä¸ª `thread_id` çš„æ‰€æœ‰æ‰§è¡Œå…±äº«å†å²çŠ¶æ€
- ä¸åŒçš„ `thread_id` æ‹¥æœ‰ç‹¬ç«‹çš„çŠ¶æ€å’Œå†å²

---

## ğŸ” æµè§ˆå†å²ï¼ˆBrowsing Historyï¼‰

### æŸ¥çœ‹å½“å‰çŠ¶æ€

```python
graph.get_state({'configurable': {'thread_id': '1'}})
```

**è¿”å›çš„ StateSnapshotï¼š**

```python
StateSnapshot(
    values={
        'messages': [
            HumanMessage(content='Multiply 2 and 3', id='4ee8c440-...'),
            AIMessage(content='', tool_calls=[...], id='run-bc24d334-...'),
            ToolMessage(content='6', name='multiply', id='1012611a-...'),
            AIMessage(content='The result of multiplying 2 and 3 is 6.', id='run-b46f3fed-...')
        ]
    },
    next=(),  # ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹ï¼ˆç©ºè¡¨ç¤ºå·²å®Œæˆï¼‰
    config={
        'configurable': {
            'thread_id': '1',
            'checkpoint_ns': '',
            'checkpoint_id': '1ef6a440-ac9e-6024-8003-6fd8435c1d3b'
        }
    },
    metadata={'source': 'loop', 'step': 3, ...},
    created_at='2024-09-03T22:29:54.309727+00:00',
    parent_config={...},  # çˆ¶ checkpoint
    tasks=()
)
```

**StateSnapshot å­—æ®µè§£æï¼š**

| å­—æ®µ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `values` | å½“å‰çŠ¶æ€çš„å®Œæ•´æ•°æ® | æŸ¥çœ‹çŠ¶æ€å†…å®¹ |
| `next` | ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹ | åˆ¤æ–­æ‰§è¡Œè¿›åº¦ |
| `config` | é…ç½®ä¿¡æ¯ï¼ˆåŒ…å« checkpoint_idï¼‰ | ç”¨äºå›æ”¾æˆ–åˆ†å‰ |
| `metadata` | å…ƒæ•°æ®ï¼ˆæ­¥æ•°ã€æ¥æºç­‰ï¼‰ | è°ƒè¯•å’Œè¿½è¸ª |
| `created_at` | åˆ›å»ºæ—¶é—´ | æ—¶é—´çº¿åˆ†æ |
| `parent_config` | çˆ¶ checkpoint çš„é…ç½® | è¿½æº¯å†å² |
| `tasks` | å¾…æ‰§è¡Œçš„ä»»åŠ¡ | æŸ¥çœ‹ä¸­æ–­çŠ¶æ€ |

---

### è·å–å®Œæ•´å†å²

```python
all_states = [s for s in graph.get_state_history(thread)]
len(all_states)  # è¾“å‡ºï¼š5
```

**å†å²ç»“æ„ï¼š**

```python
all_states[0]  # å½“å‰çŠ¶æ€ï¼ˆæœ€æ–°ï¼‰
all_states[1]  # å€’æ•°ç¬¬ 2 ä¸ªçŠ¶æ€
all_states[2]  # å€’æ•°ç¬¬ 3 ä¸ªçŠ¶æ€
...
all_states[-1] # åˆå§‹çŠ¶æ€ï¼ˆæœ€æ—©ï¼‰
```

**å¯è§†åŒ–å†å²ï¼š**

```
Step 0 (all_states[-1]): ç”¨æˆ·è¾“å…¥
    â†“
Step 1 (all_states[-2]): Assistant ç”Ÿæˆå·¥å…·è°ƒç”¨
    â†“
Step 2 (all_states[-3]): Tools æ‰§è¡Œè®¡ç®—
    â†“
Step 3 (all_states[-4]): Assistant ç”Ÿæˆæœ€ç»ˆå›å¤
    â†“
Step 4 (all_states[0]): å½“å‰çŠ¶æ€ï¼ˆå®Œæˆï¼‰
```

---

### æŸ¥çœ‹ç‰¹å®šå†å²çŠ¶æ€

```python
# æŸ¥çœ‹ç¬¬ä¸€æ¬¡æ¥æ”¶ç”¨æˆ·è¾“å…¥åçš„çŠ¶æ€
to_replay = all_states[-2]

# æŸ¥çœ‹çŠ¶æ€å†…å®¹
to_replay.values
# è¾“å‡ºï¼š{'messages': [HumanMessage(content='Multiply 2 and 3', ...)]}

# æŸ¥çœ‹ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹
to_replay.next
# è¾“å‡ºï¼š('assistant',)

# æŸ¥çœ‹ checkpoint ID
to_replay.config
# è¾“å‡ºï¼š{'configurable': {'thread_id': '1', 'checkpoint_id': '1ef6a440-...'}}
```

---

## ğŸ”„ å›æ”¾ï¼ˆReplayingï¼‰

å›æ”¾å…è®¸ä½ ä»å†å²ä¸­çš„æŸä¸ª checkpoint é‡æ–°æ‰§è¡Œå›¾ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

**å›æ”¾ vs ç»§ç»­æ‰§è¡Œï¼š**

| æ“ä½œ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **ç»§ç»­æ‰§è¡Œ** | ä»å½“å‰çŠ¶æ€ç»§ç»­æœªå®Œæˆçš„ä»»åŠ¡ | ä½¿ç”¨å½“å‰ checkpoint |
| **å›æ”¾** | ä»å†å²çŠ¶æ€é‡æ–°æ‰§è¡Œå·²å®Œæˆçš„ä»»åŠ¡ | ä½¿ç”¨å†å² checkpoint |

### å›æ”¾ç¤ºä¾‹

```python
# è·å–è¦å›æ”¾çš„å†å²çŠ¶æ€
to_replay = all_states[-2]

# ä»è¯¥ checkpoint å¼€å§‹é‡æ–°æ‰§è¡Œ
for event in graph.stream(None, to_replay.config, stream_mode="values"):
    event['messages'][-1].pretty_print()
```

**å…³é”®ç‚¹ï¼š**
1. **ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ `None`**ï¼šä¸æä¾›æ–°è¾“å…¥ï¼Œä½¿ç”¨ checkpoint ä¸­ä¿å­˜çš„çŠ¶æ€
2. **ç¬¬äºŒä¸ªå‚æ•°æ˜¯ `to_replay.config`**ï¼šåŒ…å« `checkpoint_id`ï¼ŒæŒ‡å®šä»å“ªä¸ªå†å²çŠ¶æ€å¼€å§‹
3. å›¾ä¼šè‡ªåŠ¨è¯†åˆ«è¿™æ˜¯ä¸€ä¸ªå·²æ‰§è¡Œè¿‡çš„ checkpointï¼Œè¿›è¡Œå›æ”¾

**è¾“å‡ºï¼š**
```
================================ Human Message =================================
Multiply 2 and 3

================================== Ai Message ==================================
Tool Calls:
  multiply (call_SABfB57CnDkMu9HJeUE0mvJ9)
  Args:
    a: 2
    b: 3

================================= Tool Message =================================
Name: multiply
6

================================== Ai Message ==================================
The result of multiplying 2 and 3 is 6.
```

**æ³¨æ„ï¼š** ç”±äº LLM çš„éšæœºæ€§ï¼Œå›æ”¾çš„ç»“æœå¯èƒ½ä¸åŸå§‹æ‰§è¡Œç•¥æœ‰ä¸åŒï¼ˆä¾‹å¦‚å·¥å…·è°ƒç”¨ ID ä¸åŒï¼‰ã€‚

---

## ğŸŒ¿ åˆ†å‰ï¼ˆForkingï¼‰

åˆ†å‰æ˜¯ Time Travel æœ€å¼ºå¤§çš„åŠŸèƒ½ï¼šä»å†å²çŠ¶æ€åˆ›å»ºæ–°çš„æ‰§è¡Œåˆ†æ”¯ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

**åˆ†å‰ vs å›æ”¾ï¼š**

| æ“ä½œ | çŠ¶æ€ | å†å² | ç”¨é€” |
|------|------|------|------|
| **å›æ”¾** | ä¸ä¿®æ”¹çŠ¶æ€ | ä¸æ”¹å˜å†å² | é‡ç°æ‰§è¡Œè¿‡ç¨‹ |
| **åˆ†å‰** | ä¿®æ”¹çŠ¶æ€ | åˆ›å»ºæ–°åˆ†æ”¯ | æ¢ç´¢æ›¿ä»£è·¯å¾„ |

### åˆ†å‰åŸç†

```
åŸå§‹å†å²ï¼š
  â”Œâ”€ Step 0: ç”¨æˆ·è¾“å…¥ "2 * 3"
  â”œâ”€ Step 1: Assistant è°ƒç”¨å·¥å…·
  â”œâ”€ Step 2: Tools è¿”å› 6
  â””â”€ Step 3: Assistant å›å¤ "ç»“æœæ˜¯ 6"

åˆ†å‰æ“ä½œï¼ˆåœ¨ Step 0 ä¿®æ”¹è¾“å…¥ä¸º "5 * 3"ï¼‰ï¼š
  â”Œâ”€ Step 0: ç”¨æˆ·è¾“å…¥ "2 * 3"  (åŸå§‹)
  â”‚
  â””â”€ Step 0': ç”¨æˆ·è¾“å…¥ "5 * 3"  (åˆ†å‰) â† ä»è¿™é‡Œå¼€å§‹æ–°çš„æ‰§è¡Œ
      â”œâ”€ Step 1': Assistant è°ƒç”¨å·¥å…·
      â”œâ”€ Step 2': Tools è¿”å› 15
      â””â”€ Step 3': Assistant å›å¤ "ç»“æœæ˜¯ 15"
```

---

### åˆ†å‰å®ç°

#### æ­¥éª¤ 1ï¼šé€‰æ‹©è¦åˆ†å‰çš„çŠ¶æ€

```python
to_fork = all_states[-2]  # é€‰æ‹©ç”¨æˆ·è¾“å…¥åçš„çŠ¶æ€
to_fork.values["messages"]
# è¾“å‡ºï¼š[HumanMessage(content='Multiply 2 and 3', id='4ee8c440-...')]
```

#### æ­¥éª¤ 2ï¼šä¿®æ”¹çŠ¶æ€

```python
fork_config = graph.update_state(
    to_fork.config,  # æŒ‡å®šè¦ä¿®æ”¹çš„ checkpoint
    {"messages": [HumanMessage(
        content='Multiply 5 and 3',  # ä¿®æ”¹åçš„å†…å®¹
        id=to_fork.values["messages"][0].id  # â­ ä¿æŒç›¸åŒçš„ IDï¼
    )]},
)
```

**å…³é”®ç‚¹ï¼šMessage ID çš„ä½œç”¨**

```python
id=to_fork.values["messages"][0].id
```

**ä¸ºä»€ä¹ˆè¦ä¿æŒç›¸åŒçš„ IDï¼Ÿ**

LangGraph çš„ `add_messages` reducer æœ‰ç‰¹æ®Šé€»è¾‘ï¼š
- **å¦‚æœ ID ç›¸åŒ**ï¼šè¦†ç›–åŸæœ‰æ¶ˆæ¯ï¼ˆæ›´æ–°ï¼‰
- **å¦‚æœ ID ä¸åŒ**ï¼šè¿½åŠ æ–°æ¶ˆæ¯ï¼ˆæ’å…¥ï¼‰

```python
# ç¤ºä¾‹ï¼š
# åŸå§‹æ¶ˆæ¯ï¼š[HumanMessage(content='Multiply 2 and 3', id='abc')]

# è¦†ç›–ï¼ˆä½¿ç”¨ç›¸åŒ IDï¼‰ï¼š
update({"messages": [HumanMessage(content='Multiply 5 and 3', id='abc')]})
# ç»“æœï¼š[HumanMessage(content='Multiply 5 and 3', id='abc')]

# è¿½åŠ ï¼ˆä½¿ç”¨ä¸åŒ IDï¼‰ï¼š
update({"messages": [HumanMessage(content='Multiply 5 and 3', id='xyz')]})
# ç»“æœï¼š[
#   HumanMessage(content='Multiply 2 and 3', id='abc'),
#   HumanMessage(content='Multiply 5 and 3', id='xyz')
# ]
```

---

#### æ­¥éª¤ 3ï¼šä»åˆ†å‰çš„çŠ¶æ€ç»§ç»­æ‰§è¡Œ

```python
for event in graph.stream(None, fork_config, stream_mode="values"):
    event['messages'][-1].pretty_print()
```

**è¾“å‡ºï¼š**
```
================================ Human Message =================================
Multiply 5 and 3

================================== Ai Message ==================================
Tool Calls:
  multiply (call_KP2CVNMMUKMJAQuFmamHB21r)
  Args:
    a: 5
    b: 3

================================= Tool Message =================================
Name: multiply
15

================================== Ai Message ==================================
The result of multiplying 5 and 3 is 15.
```

---

#### æ­¥éª¤ 4ï¼šéªŒè¯åˆ†å‰ç»“æœ

```python
# æŸ¥çœ‹å½“å‰çŠ¶æ€
graph.get_state({'configurable': {'thread_id': '1'}})

# æŸ¥çœ‹å†å²
all_states = [state for state in graph.get_state_history(thread)]
all_states[0].values["messages"]
# è¾“å‡ºï¼š[HumanMessage(content='Multiply 5 and 3', ...), ...]
```

**æ³¨æ„ï¼š** åˆ†å‰ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ checkpoint åˆ†æ”¯ï¼Œä½†ä¸ä¼šåˆ é™¤åŸå§‹å†å²ã€‚

---

## ğŸŒ ä½¿ç”¨ LangGraph API è¿›è¡Œ Time Travel

LangGraph æä¾›äº†è¿œç¨‹ APIï¼Œå¯ä»¥é€šè¿‡ç½‘ç»œè°ƒç”¨ Time Travel åŠŸèƒ½ã€‚

### å¯åŠ¨ LangGraph å¼€å‘æœåŠ¡å™¨

åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œï¼š

```bash
cd module-3/studio
langgraph dev
```

**è¾“å‡ºï¼š**
```
- ğŸš€ API: http://127.0.0.1:2024
- ğŸ¨ Studio UI: https://smith.langchain.com/studio/?baseUrl=http://127.0.0.1:2024
- ğŸ“š API Docs: http://127.0.0.1:2024/docs
```

---

### è¿æ¥åˆ° API

```python
from langgraph_sdk import get_client

client = get_client(url="http://127.0.0.1:2024")
```

---

### é€šè¿‡ API è¿è¡Œ Agent

```python
from langchain_core.messages import HumanMessage

initial_input = {"messages": HumanMessage(content="Multiply 2 and 3")}

# åˆ›å»ºçº¿ç¨‹
thread = await client.threads.create()

# æµå¼è¿è¡Œ
async for chunk in client.runs.stream(
    thread["thread_id"],
    assistant_id="agent",  # åœ¨ langgraph.json ä¸­å®šä¹‰
    input=initial_input,
    stream_mode="updates",
):
    if chunk.data:
        assistant_node = chunk.data.get('assistant', {}).get('messages', [])
        tool_node = chunk.data.get('tools', {}).get('messages', [])
        if assistant_node:
            print("--------------------Assistant Node--------------------")
            print(assistant_node[-1])
        elif tool_node:
            print("--------------------Tools Node--------------------")
            print(tool_node[-1])
```

**stream_mode è¯´æ˜ï¼š**

| æ¨¡å¼ | è¾“å‡ºå†…å®¹ | ç”¨é€” |
|------|---------|------|
| `"values"` | æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåçš„å®Œæ•´çŠ¶æ€ | æŸ¥çœ‹çŠ¶æ€å˜åŒ– |
| `"updates"` | æ¯ä¸ªèŠ‚ç‚¹å¯¹çŠ¶æ€çš„æ›´æ–° | æŸ¥çœ‹å¢é‡å˜åŒ– |

---

### é€šè¿‡ API å›æ”¾

```python
# è·å–å†å²
states = await client.threads.get_history(thread['thread_id'])
to_replay = states[-2]

# å›æ”¾
async for chunk in client.runs.stream(
    thread["thread_id"],
    assistant_id="agent",
    input=None,  # ä¸æä¾›æ–°è¾“å…¥
    stream_mode="values",
    checkpoint_id=to_replay['checkpoint_id']  # æŒ‡å®šè¦å›æ”¾çš„ checkpoint
):
    print(f"Receiving new event of type: {chunk.event}...")
    print(chunk.data)
```

---

### é€šè¿‡ API åˆ†å‰

```python
# è·å–è¦åˆ†å‰çš„çŠ¶æ€
states = await client.threads.get_history(thread['thread_id'])
to_fork = states[-2]

# å‡†å¤‡æ–°è¾“å…¥
forked_input = {
    "messages": HumanMessage(
        content="Multiply 3 and 3",
        id=to_fork['values']['messages'][0]['id']  # ä¿æŒç›¸åŒ ID
    )
}

# æ›´æ–°çŠ¶æ€ï¼ˆåˆ›å»ºåˆ†å‰ï¼‰
forked_config = await client.threads.update_state(
    thread["thread_id"],
    forked_input,
    checkpoint_id=to_fork['checkpoint_id']
)

# ä»åˆ†å‰çŠ¶æ€ç»§ç»­æ‰§è¡Œ
async for chunk in client.runs.stream(
    thread["thread_id"],
    assistant_id="agent",
    input=None,
    stream_mode="updates",
    checkpoint_id=forked_config['checkpoint_id']
):
    # å¤„ç†è¾“å‡º
    ...
```

---

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### LangGraph ç‰¹æœ‰æ¦‚å¿µ

#### 1. Checkpointerï¼ˆæ£€æŸ¥ç‚¹ç®¡ç†å™¨ï¼‰

**ä½œç”¨ï¼š** è‡ªåŠ¨ä¿å­˜å›¾çš„æ‰§è¡Œå†å²

```python
from langgraph.checkpoint.memory import MemorySaver

graph = builder.compile(checkpointer=MemorySaver())
```

**ç±»å‹ï¼š**
- `MemorySaver`ï¼šå†…å­˜å­˜å‚¨ï¼ˆå¼€å‘æµ‹è¯•ï¼‰
- `SqliteSaver`ï¼šSQLite æ•°æ®åº“ï¼ˆæŒä¹…åŒ–ï¼‰
- è‡ªå®šä¹‰ checkpointerï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**ä¿å­˜æ—¶æœºï¼š**
- æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåè‡ªåŠ¨ä¿å­˜
- å›¾å®Œæˆåä¿å­˜æœ€ç»ˆçŠ¶æ€
- ä¸­æ–­æ—¶ä¿å­˜ä¸­æ–­çŠ¶æ€

---

#### 2. StateSnapshot

çŠ¶æ€å¿«ç…§ï¼ŒåŒ…å«æŸä¸ªæ—¶åˆ»çš„å®Œæ•´çŠ¶æ€ä¿¡æ¯ï¼š

```python
class StateSnapshot:
    values: dict            # çŠ¶æ€æ•°æ®
    next: tuple             # ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    config: dict            # é…ç½®ï¼ˆåŒ…å« checkpoint_idï¼‰
    metadata: dict          # å…ƒæ•°æ®
    created_at: datetime    # åˆ›å»ºæ—¶é—´
    parent_config: dict     # çˆ¶ checkpoint
    tasks: tuple            # å¾…æ‰§è¡Œä»»åŠ¡
```

---

#### 3. Threadï¼ˆçº¿ç¨‹ï¼‰

ç”¨äºæ ‡è¯†å’Œéš”ç¦»ä¸åŒçš„ä¼šè¯ï¼š

```python
thread = {"configurable": {"thread_id": "user_123"}}
```

**ç‰¹æ€§ï¼š**
- æ¯ä¸ª thread æœ‰ç‹¬ç«‹çš„çŠ¶æ€å’Œå†å²
- ç›¸åŒ thread_id å…±äº«å†å²
- å¯ç”¨äºå¤šç”¨æˆ·ã€å¤šä¼šè¯åœºæ™¯

---

#### 4. get_state_history()

è·å–å®Œæ•´å†å²çš„æ–¹æ³•ï¼š

```python
all_states = list(graph.get_state_history(thread))

# all_states[0]  # æœ€æ–°çŠ¶æ€
# all_states[-1] # æœ€æ—©çŠ¶æ€
```

**è¿”å›ï¼š** æŒ‰æ—¶é—´å€’åºæ’åˆ—çš„ StateSnapshot åˆ—è¡¨

---

#### 5. update_state()

ä¿®æ”¹å†å²çŠ¶æ€ï¼Œåˆ›å»ºåˆ†å‰ï¼š

```python
fork_config = graph.update_state(
    checkpoint_config,  # è¦ä¿®æ”¹çš„ checkpoint
    state_updates       # çŠ¶æ€æ›´æ–°
)
```

**è¿”å›ï¼š** æ–°åˆ†å‰çš„ checkpoint é…ç½®

---

### Python ç‰¹æœ‰çŸ¥è¯†ç‚¹

#### 1. MessagesState

LangGraph å†…ç½®çš„æ¶ˆæ¯çŠ¶æ€ç±»ï¼š

```python
from langgraph.graph import MessagesState

# ç­‰ä»·äºï¼š
class MessagesState(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]
```

**add_messages reducerï¼š**
- è‡ªåŠ¨åˆå¹¶æ¶ˆæ¯åˆ—è¡¨
- ç›¸åŒ ID çš„æ¶ˆæ¯ä¼šè¢«è¦†ç›–
- ä¸åŒ ID çš„æ¶ˆæ¯ä¼šè¢«è¿½åŠ 

---

#### 2. Message ID æœºåˆ¶

æ‰€æœ‰ LangChain æ¶ˆæ¯éƒ½æœ‰ `id` å­—æ®µï¼š

```python
msg = HumanMessage(content="Hello", id="abc123")
```

**ç”¨é€”ï¼š**
- å”¯ä¸€æ ‡è¯†æ¶ˆæ¯
- ç”¨äºæ¶ˆæ¯å»é‡
- ç”¨äºæ¶ˆæ¯æ›´æ–°ï¼ˆåˆ†å‰æ—¶è¦†ç›–æ¶ˆæ¯ï¼‰

**è‡ªåŠ¨ç”Ÿæˆï¼š** å¦‚æœä¸æä¾› IDï¼ŒLangChain ä¼šè‡ªåŠ¨ç”Ÿæˆ UUID

---

#### 3. å¼‚æ­¥ç¼–ç¨‹ï¼ˆasync/awaitï¼‰

LangGraph API ä½¿ç”¨å¼‚æ­¥æ¥å£ï¼š

```python
# å¼‚æ­¥å‡½æ•°å®šä¹‰
async def my_function():
    result = await async_operation()
    return result

# åœ¨ Jupyter ä¸­ç›´æ¥ä½¿ç”¨ await
thread = await client.threads.create()

# åœ¨æ™®é€š Python è„šæœ¬ä¸­éœ€è¦ï¼š
import asyncio
asyncio.run(my_function())
```

**å¼‚æ­¥è¿­ä»£ï¼š**
```python
async for chunk in client.runs.stream(...):
    process(chunk)
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½•æ—¶ä½¿ç”¨ Time Travelï¼Ÿ

âœ… **é€‚ç”¨åœºæ™¯ï¼š**
- è°ƒè¯•å¤æ‚çš„ Agent è¡Œä¸º
- å¤ç°ç”¨æˆ·æŠ¥å‘Šçš„é—®é¢˜
- æ¢ç´¢ä¸åŒè¾“å…¥çš„å½±å“
- A/B æµ‹è¯•ä¸åŒçš„ Agent é…ç½®
- æ¢å¤ä¸­æ–­çš„æ‰§è¡Œ

âŒ **ä¸é€‚ç”¨åœºæ™¯ï¼š**
- ç”Ÿäº§ç¯å¢ƒçš„å®æ—¶æ‰§è¡Œï¼ˆæ€§èƒ½å¼€é”€ï¼‰
- ç®€å•çš„æ— çŠ¶æ€æ“ä½œ
- ä¸éœ€è¦å†å²è¿½æº¯çš„åœºæ™¯

---

### 2. Checkpointer é€‰æ‹©

**å¼€å‘ç¯å¢ƒï¼š**
```python
from langgraph.checkpoint.memory import MemorySaver
checkpointer = MemorySaver()  # ç®€å•å¿«é€Ÿï¼Œé‡å¯åä¸¢å¤±
```

**æµ‹è¯•ç¯å¢ƒï¼š**
```python
from langgraph.checkpoint.sqlite import SqliteSaver
checkpointer = SqliteSaver.from_conn_string("checkpoints.db")  # æŒä¹…åŒ–åˆ°æ–‡ä»¶
```

**ç”Ÿäº§ç¯å¢ƒï¼š**
```python
# ä½¿ç”¨åˆ†å¸ƒå¼æ•°æ®åº“
# ä¾‹å¦‚ï¼šPostgreSQLã€MongoDB ç­‰
```

---

### 3. Thread ID å‘½åç­–ç•¥

**æŒ‰ç”¨æˆ·ï¼š**
```python
thread = {"configurable": {"thread_id": f"user_{user_id}"}}
```

**æŒ‰ä¼šè¯ï¼š**
```python
thread = {"configurable": {"thread_id": f"session_{session_id}"}}
```

**æŒ‰ä»»åŠ¡ï¼š**
```python
thread = {"configurable": {"thread_id": f"task_{task_id}_{timestamp}"}}
```

**æœ€ä½³å®è·µï¼š**
- ä½¿ç”¨æœ‰æ„ä¹‰çš„ ID ä¾¿äºè°ƒè¯•
- é¿å… ID å†²çª
- è€ƒè™‘æ·»åŠ æ—¶é—´æˆ³æˆ– UUID

---

### 4. åˆ†å‰æ—¶çš„æ³¨æ„äº‹é¡¹

**ä¿æŒ Message IDï¼š**
```python
# âœ… æ­£ç¡®ï¼šä¿æŒåŸå§‹ ID ä»¥è¦†ç›–æ¶ˆæ¯
HumanMessage(content="New input", id=original_message.id)

# âŒ é”™è¯¯ï¼šä¸æä¾› ID ä¼šè¿½åŠ æ¶ˆæ¯
HumanMessage(content="New input")
```

**éªŒè¯åˆ†å‰ç»“æœï¼š**
```python
# åˆ†å‰åæ£€æŸ¥çŠ¶æ€
fork_state = graph.get_state(fork_config)
print(fork_state.values)  # ç¡®è®¤çŠ¶æ€å·²æ›´æ–°
```

**æ¸…ç†æ—§åˆ†æ”¯ï¼š**
- åˆ†å‰ä¼šåˆ›å»ºæ–°çš„å†å²åˆ†æ”¯
- å®šæœŸæ¸…ç†ä¸éœ€è¦çš„ checkpoint ä»¥èŠ‚çœå­˜å‚¨

---

### 5. å†å²æŸ¥è¯¢ä¼˜åŒ–

**é™åˆ¶å†å²æ•°é‡ï¼š**
```python
# åªè·å–æœ€è¿‘çš„ N ä¸ªçŠ¶æ€
from itertools import islice
recent_states = list(islice(graph.get_state_history(thread), 10))
```

**æŒ‰æ¡ä»¶ç­›é€‰ï¼š**
```python
# åªè·å–ç‰¹å®šèŠ‚ç‚¹çš„çŠ¶æ€
states_at_assistant = [
    s for s in graph.get_state_history(thread)
    if 'assistant' in s.metadata.get('writes', {})
]
```

---

## ğŸš€ è¿›é˜¶æŠ€å·§

### 1. å¤šåˆ†æ”¯æ¢ç´¢

ä»åŒä¸€ä¸ª checkpoint åˆ›å»ºå¤šä¸ªåˆ†å‰ï¼š

```python
base_checkpoint = all_states[-2]

# åˆ†å‰ 1ï¼šè¾“å…¥ "5 * 3"
fork1 = graph.update_state(
    base_checkpoint.config,
    {"messages": [HumanMessage(content="Multiply 5 and 3", id=msg_id)]}
)

# åˆ†å‰ 2ï¼šè¾“å…¥ "10 * 3"
fork2 = graph.update_state(
    base_checkpoint.config,
    {"messages": [HumanMessage(content="Multiply 10 and 3", id=msg_id)]}
)

# åˆ†åˆ«æ‰§è¡Œ
for event in graph.stream(None, fork1):
    # å¤„ç†åˆ†æ”¯ 1
    pass

for event in graph.stream(None, fork2):
    # å¤„ç†åˆ†æ”¯ 2
    pass
```

---

### 2. æ—¶é—´çº¿å¯è§†åŒ–

```python
def visualize_timeline(states):
    for i, state in enumerate(reversed(states)):
        step = len(states) - i - 1
        timestamp = state.created_at.strftime("%H:%M:%S")
        next_node = state.next[0] if state.next else "END"
        print(f"Step {step} [{timestamp}] â†’ {next_node}")
        print(f"  Messages: {len(state.values.get('messages', []))}")
        print()

visualize_timeline(all_states)
```

---

### 3. è‡ªåŠ¨ä¿å­˜å…³é”® Checkpoint

```python
def save_important_checkpoints(thread):
    checkpoints = []
    for state in graph.get_state_history(thread):
        # ä¿å­˜æ‰€æœ‰ç”¨æˆ·è¾“å…¥çš„çŠ¶æ€
        if any(isinstance(m, HumanMessage) for m in state.values['messages']):
            checkpoints.append({
                'checkpoint_id': state.config['configurable']['checkpoint_id'],
                'timestamp': state.created_at,
                'messages': state.values['messages']
            })
    return checkpoints
```

---

### 4. æ¡ä»¶å›æ”¾

æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦å›æ”¾ï¼š

```python
def replay_if_error(state):
    # å¦‚æœå‘ç°é”™è¯¯ï¼Œå›æ”¾åˆ°ä¸Šä¸€ä¸ªç¨³å®šçŠ¶æ€
    if "error" in state.metadata.get('writes', {}):
        history = list(graph.get_state_history(thread))
        for prev_state in history:
            if prev_state.next == ('assistant',):  # æ‰¾åˆ°ä¸Šä¸€ä¸ª assistant èŠ‚ç‚¹
                print(f"Error detected, replaying from checkpoint {prev_state.config['configurable']['checkpoint_id']}")
                for event in graph.stream(None, prev_state.config):
                    # å›æ”¾
                    pass
                break
```

---

## ğŸ“Š Time Travel vs å…¶ä»–è°ƒè¯•æ–¹æ³•

| æ–¹æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **Time Travel** | å¯å›æº¯ã€å¯åˆ†å‰ã€å®Œæ•´å†å² | éœ€è¦ checkpointerã€å­˜å‚¨å¼€é”€ | å¤æ‚ Agent è°ƒè¯• |
| **æ—¥å¿—è®°å½•** | ç®€å•ã€è½»é‡ | ä¸å¯å›æ”¾ã€æ— çŠ¶æ€å¿«ç…§ | ç®€å•è°ƒè¯•ã€æ€§èƒ½åˆ†æ |
| **Breakpoint** | å®æ—¶æš‚åœã€å¯ä¿®æ”¹ | éœ€è¦æå‰è®¾ç½®ã€æ— å†å²å›æº¯ | å¼€å‘é˜¶æ®µè°ƒè¯• |
| **å•å…ƒæµ‹è¯•** | è‡ªåŠ¨åŒ–ã€å¯é‡å¤ | æ— æ³•å¤ç°å®é™…æ‰§è¡Œ | åŠŸèƒ½éªŒè¯ |

---

## ğŸ¯ å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šå®¢æœ Agent é”™è¯¯ä¿®å¤

**åœºæ™¯ï¼š** å®¢æœ Agent åœ¨ç¬¬ 3 è½®å¯¹è¯æ—¶ç»™å‡ºäº†é”™è¯¯ç­”æ¡ˆ

**è§£å†³æ–¹æ¡ˆï¼š**
1. ä½¿ç”¨ `thread_id` è·å–è¯¥ç”¨æˆ·çš„å†å²
2. æ‰¾åˆ°ç¬¬ 3 è½®å¯¹è¯çš„ checkpoint
3. å›æ”¾ä»¥é‡ç°é—®é¢˜
4. ä¿®æ”¹ Agent é€»è¾‘
5. åˆ†å‰é‡æ–°æ‰§è¡ŒéªŒè¯ä¿®å¤

```python
# è·å–ç”¨æˆ·å†å²
thread = {"configurable": {"thread_id": f"user_{user_id}"}}
history = list(graph.get_state_history(thread))

# æ‰¾åˆ°ç¬¬ 3 è½®å¯¹è¯
round_3 = [s for s in history if len(s.values['messages']) == 6][0]  # 3 è½® = 6 æ¡æ¶ˆæ¯

# å›æ”¾é‡ç°é—®é¢˜
for event in graph.stream(None, round_3.config):
    # è§‚å¯Ÿé”™è¯¯
    pass

# ä¿®å¤ Agent åï¼Œåˆ†å‰é‡æ–°æ‰§è¡Œ
fork = graph.update_state(round_3.config, {...})
for event in graph.stream(None, fork):
    # éªŒè¯ä¿®å¤
    pass
```

---

### æ¡ˆä¾‹ 2ï¼šA/B æµ‹è¯•ä¸åŒæç¤ºè¯

**åœºæ™¯ï¼š** æµ‹è¯•ä¸¤ä¸ªä¸åŒçš„ç³»ç»Ÿæç¤ºè¯å“ªä¸ªæ•ˆæœæ›´å¥½

```python
base_state = history[-1]  # ç”¨æˆ·è¾“å…¥åçš„çŠ¶æ€

# æµ‹è¯•æç¤ºè¯ A
fork_a = graph.update_state(
    base_state.config,
    {"system_prompt": "You are a helpful assistant..."}
)
result_a = list(graph.stream(None, fork_a))

# æµ‹è¯•æç¤ºè¯ B
fork_b = graph.update_state(
    base_state.config,
    {"system_prompt": "You are a concise assistant..."}
)
result_b = list(graph.stream(None, fork_b))

# æ¯”è¾ƒç»“æœ
compare_results(result_a, result_b)
```

---

### æ¡ˆä¾‹ 3ï¼šç”¨æˆ·åé¦ˆä¿®æ­£

**åœºæ™¯ï¼š** ç”¨æˆ·å¯¹ Agent çš„å›å¤ä¸æ»¡æ„ï¼Œæƒ³ä¿®æ”¹è¾“å…¥é‡æ–°æ‰§è¡Œ

```python
# ç”¨æˆ·æœ€åˆçš„è¾“å…¥
original_input = "Multiply 2 and 3"

# Agent ç»™å‡ºäº†å›å¤ï¼Œç”¨æˆ·ä¸æ»¡æ„
# ç”¨æˆ·ä¿®æ”¹è¾“å…¥ä¸º "Multiply 2 and 3, then add 5"

# è·å–åŸå§‹è¾“å…¥çš„ checkpoint
history = list(graph.get_state_history(thread))
original_checkpoint = history[-2]

# åˆ†å‰å¹¶ä¿®æ”¹è¾“å…¥
fork = graph.update_state(
    original_checkpoint.config,
    {"messages": [HumanMessage(
        content="Multiply 2 and 3, then add 5",
        id=original_checkpoint.values['messages'][0].id
    )]}
)

# é‡æ–°æ‰§è¡Œ
for event in graph.stream(None, fork):
    print(event)
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: æ²¡æœ‰ checkpointer å¯ä»¥ä½¿ç”¨ Time Travel å—ï¼Ÿ

**ä¸å¯ä»¥ã€‚** Time Travel å®Œå…¨ä¾èµ– checkpointer ä¿å­˜çš„å†å²çŠ¶æ€ã€‚

```python
# âŒ æ²¡æœ‰ checkpointer - æ— æ³•ä½¿ç”¨ Time Travel
graph = builder.compile()

# âœ… æœ‰ checkpointer - å¯ä»¥ä½¿ç”¨ Time Travel
graph = builder.compile(checkpointer=MemorySaver())
```

---

### Q2: å›æ”¾ä¼šäº§ç”Ÿå‰¯ä½œç”¨å—ï¼Ÿ

**å¯èƒ½ä¼šã€‚** å¦‚æœèŠ‚ç‚¹ä¸­æœ‰å‰¯ä½œç”¨æ“ä½œï¼ˆå¦‚å†™å…¥æ•°æ®åº“ã€è°ƒç”¨å¤–éƒ¨ APIï¼‰ï¼Œå›æ”¾æ—¶ä¼šå†æ¬¡æ‰§è¡Œè¿™äº›æ“ä½œã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
- æ·»åŠ "å›æ”¾æ¨¡å¼"æ ‡å¿—ï¼Œè·³è¿‡å‰¯ä½œç”¨æ“ä½œ
- ä½¿ç”¨å¹‚ç­‰æ“ä½œ

```python
def my_node(state):
    if state.get("replay_mode"):
        return cached_result  # è·³è¿‡å®é™…æ“ä½œ
    else:
        return perform_real_operation()  # æ­£å¸¸æ‰§è¡Œ
```

---

### Q3: åˆ†å‰ä¼šå½±å“åŸå§‹å†å²å—ï¼Ÿ

**ä¸ä¼šã€‚** åˆ†å‰åˆ›å»ºä¸€ä¸ªæ–°çš„ checkpoint åˆ†æ”¯ï¼ŒåŸå§‹å†å²ä¿æŒä¸å˜ã€‚

```python
åŸå§‹å†å²ï¼šA â†’ B â†’ C â†’ D
            â†“ (åˆ†å‰)
         A â†’ B' â†’ C' â†’ D'

ä¸¤æ¡åˆ†æ”¯ç‹¬ç«‹å­˜åœ¨ï¼Œäº’ä¸å½±å“
```

---

### Q4: å¦‚ä½•æ¸…ç†å†å² checkpointï¼Ÿ

ç›®å‰ LangGraph ä¸æä¾›è‡ªåŠ¨æ¸…ç†åŠŸèƒ½ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†ï¼š

```python
# å¯¹äº SqliteSaver
from langgraph.checkpoint.sqlite import SqliteSaver

checkpointer = SqliteSaver.from_conn_string("checkpoints.db")

# æ‰‹åŠ¨åˆ é™¤æ•°æ®åº“æ–‡ä»¶
import os
os.remove("checkpoints.db")
```

**æœ€ä½³å®è·µï¼š**
- ä¸ºä¸åŒä»»åŠ¡ä½¿ç”¨ä¸åŒçš„ thread_id
- å®šæœŸæ¸…ç†æ—§çš„ thread
- åœ¨æµ‹è¯•æ—¶ä½¿ç”¨ MemorySaverï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰

---

### Q5: å¯ä»¥è·¨å›¾å…±äº« checkpoint å—ï¼Ÿ

**ä¸å¯ä»¥ã€‚** Checkpoint ä¸ç‰¹å®šçš„å›¾ç»“æ„ç»‘å®šã€‚å¦‚æœä¿®æ”¹äº†å›¾ç»“æ„ï¼ˆå¦‚æ·»åŠ èŠ‚ç‚¹ã€ä¿®æ”¹è¾¹ï¼‰ï¼Œæ—§çš„ checkpoint å¯èƒ½æ— æ³•æ­£ç¡®å›æ”¾ã€‚

**å»ºè®®ï¼š**
- ä½¿ç”¨ç‰ˆæœ¬åŒ–çš„å›¾ï¼ˆgraph_v1, graph_v2ï¼‰
- ä¸ºæ¯ä¸ªç‰ˆæœ¬ä½¿ç”¨ç‹¬ç«‹çš„ checkpointer
- è¿ç§»é‡è¦çš„å†å²æ•°æ®æ—¶è¦è°¨æ…

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [LangGraph Time Travel å®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/how-tos/human_in_the_loop/time-travel/)
- [Checkpointer æ¦‚å¿µ](https://langchain-ai.github.io/langgraph/concepts/persistence/)
- [Human-in-the-Loop å®Œæ•´æŒ‡å—](https://langchain-ai.github.io/langgraph/how-tos/#human-in-the-loop)
- [LangGraph API æ–‡æ¡£](https://langchain-ai.github.io/langgraph/cloud/)

---

## ğŸŠ æ€»ç»“

Time Travel æ˜¯ LangGraph æä¾›çš„å¼ºå¤§è°ƒè¯•å’ŒçŠ¶æ€ç®¡ç†å·¥å…·ã€‚é€šè¿‡ checkpointer è‡ªåŠ¨ä¿å­˜çš„å†å²çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1. **æµè§ˆå†å²**ï¼šæŸ¥çœ‹å›¾æ‰§è¡Œçš„æ¯ä¸€ä¸ªæ­¥éª¤
2. **å›æ”¾**ï¼šé‡æ–°æ‰§è¡Œå†å²çŠ¶æ€ï¼Œé‡ç°é—®é¢˜
3. **åˆ†å‰**ï¼šä¿®æ”¹å†å²çŠ¶æ€ï¼Œæ¢ç´¢ä¸åŒçš„æ‰§è¡Œè·¯å¾„

è¿™ä¸‰å¤§åŠŸèƒ½è®©æˆ‘ä»¬èƒ½å¤Ÿåƒä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸€æ ·ç®¡ç† Agent çš„æ‰§è¡Œå†å²ï¼Œæå¤§åœ°æå‡äº†å¼€å‘å’Œè°ƒè¯•æ•ˆç‡ã€‚

**æ ¸å¿ƒè¦ç‚¹ï¼š**
- Time Travel ä¾èµ– checkpointer
- Thread ID ç”¨äºæ ‡è¯†å’Œéš”ç¦»ä¼šè¯
- Message ID ç”¨äºæ¶ˆæ¯è¦†ç›–ï¼ˆåˆ†å‰æ—¶å¿…éœ€ï¼‰
- åˆ†å‰ä¸å½±å“åŸå§‹å†å²
- é€‚åˆå¤æ‚ Agent çš„è°ƒè¯•å’Œæµ‹è¯•

æŒæ¡ Time Travelï¼Œä½ å°±æŒæ¡äº† LangGraph å¼€å‘çš„"æ—¶å…‰æœº"ï¼
