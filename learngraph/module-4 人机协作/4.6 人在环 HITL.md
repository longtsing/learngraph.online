# LangGraph äººåœ¨ç¯ (HITL) è¯¦ç»†è§£è¯»

## æ¦‚è¿°

**Human-in-the-Loop (HITL)**ï¼Œä¸­æ–‡è¯‘ä¸º"äººåœ¨ç¯"æˆ–"äººæœºååŒ"ï¼Œæ˜¯ AI å·¥ä½œæµä¸­ä¸€ç§è®©äººç±»å‚ä¸åˆ° AI å†³ç­–è¿‡ç¨‹ä¸­çš„æœºåˆ¶ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è®© AI åœ¨å…³é”®æ­¥éª¤æš‚åœï¼Œç­‰å¾…äººç±»å®¡æ ¸ã€ç¡®è®¤æˆ–æä¾›è¾“å…¥åï¼Œå†ç»§ç»­æ‰§è¡Œã€‚

æƒ³è±¡ä¸€ä¸‹ï¼šAI å°±åƒä¸€ä¸ªå‹¤åŠ³çš„åŠ©æ‰‹ï¼ŒHITL æœºåˆ¶è®©ä½ å¯ä»¥åœ¨ä»»ä½•æ—¶å€™å–Š"åœ"ï¼Œæ£€æŸ¥å®ƒåœ¨åšä»€ä¹ˆï¼Œç»™å®ƒåé¦ˆï¼Œç„¶åè®©å®ƒç»§ç»­å¹²æ´»ã€‚

---

## æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | é€šä¿—è§£é‡Š | Python è¯­æ³• | é‡è¦ç¨‹åº¦ |
|---------|---------|------------|---------|
| **interrupt()** | LangGraph 1.0 æ–°å¢çš„"æš‚åœé”®"ï¼Œåœ¨ä»£ç é‡Œè°ƒç”¨å®ƒå°±èƒ½æš‚åœå›¾çš„æ‰§è¡Œ | `from langgraph.types import interrupt` | æ ¸å¿ƒ |
| **Command** | æ¢å¤æ‰§è¡Œçš„"é¥æ§å™¨"ï¼Œç”¨æ¥å‘Šè¯‰å›¾ç»§ç»­æ‰§è¡Œå¹¶ä¼ å…¥äººç±»çš„è¾“å…¥ | `from langgraph.types import Command` | æ ¸å¿ƒ |
| **resume** | Command çš„å‚æ•°ï¼Œå­˜æ”¾äººç±»æä¾›çš„è¾“å…¥å€¼ | `Command(resume="your_input")` | æ ¸å¿ƒ |
| **Checkpointer** | çŠ¶æ€å­˜æ¡£å™¨ï¼Œè‡ªåŠ¨ä¿å­˜å›¾æ‰§è¡Œçš„è¿›åº¦ï¼Œå°±åƒæ¸¸æˆå­˜æ¡£ä¸€æ · | `InMemorySaver()` æˆ– `PostgresSaver()` | æ ¸å¿ƒ |
| **thread_id** | ä¼šè¯æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„å¯¹è¯/ç”¨æˆ·ï¼Œç±»ä¼¼äºèŠå¤©çª—å£ID | `{"configurable": {"thread_id": "123"}}` | æ ¸å¿ƒ |
| **interrupt_before** | æ—§ç‰ˆé™æ€æ–­ç‚¹ï¼Œåœ¨æŒ‡å®šèŠ‚ç‚¹æ‰§è¡Œå‰æš‚åœï¼ˆä¸æ¨èç”¨äº HITLï¼‰ | `graph.compile(interrupt_before=["node"])` | äº†è§£ |
| **interrupt_after** | æ—§ç‰ˆé™æ€æ–­ç‚¹ï¼Œåœ¨æŒ‡å®šèŠ‚ç‚¹æ‰§è¡Œåæš‚åœï¼ˆä¸æ¨èç”¨äº HITLï¼‰ | `graph.compile(interrupt_after=["node"])` | äº†è§£ |

---

## æ ¸å¿ƒæ¦‚å¿µ

### ä¸ºä»€ä¹ˆéœ€è¦ HITLï¼Ÿ

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå®Œå…¨è‡ªä¸»çš„ AI Agent å­˜åœ¨é£é™©ï¼š

1. **å®‰å…¨æ€§**ï¼šAI å¯èƒ½æ‰§è¡Œå±é™©æ“ä½œï¼ˆå¦‚åˆ é™¤æ•°æ®ã€è½¬è´¦ï¼‰
2. **å‡†ç¡®æ€§**ï¼šAI å¯èƒ½åšå‡ºé”™è¯¯åˆ¤æ–­éœ€è¦äººå·¥çº æ­£
3. **åˆè§„æ€§**ï¼šæŸäº›æ“ä½œå¿…é¡»æœ‰äººå·¥å®¡æ‰¹è®°å½•
4. **ç”¨æˆ·ä½“éªŒ**ï¼šéœ€è¦åœ¨å…³é”®æ­¥éª¤è·å–ç”¨æˆ·ç¡®è®¤æˆ–é¢å¤–ä¿¡æ¯

### LangGraph 1.0 çš„ interrupt() vs æ—§ç‰ˆæ–­ç‚¹

| ç‰¹æ€§ | interrupt() (æ¨è) | interrupt_before/after (æ—§ç‰ˆ) |
|------|-------------------|------------------------------|
| çµæ´»æ€§ | å¯åœ¨ä»£ç ä»»æ„ä½ç½®è°ƒç”¨ | åªèƒ½åœ¨èŠ‚ç‚¹è¾¹ç•Œè®¾ç½® |
| ä¼ å€¼ | ç›´æ¥è¿”å›äººç±»è¾“å…¥å€¼ | éœ€è¦æ‰‹åŠ¨æ›´æ–°çŠ¶æ€ |
| æ¡ä»¶æ§åˆ¶ | å¯ä»¥æ”¾åœ¨ if è¯­å¥ä¸­ | æ— æ³•æ¡ä»¶è§¦å‘ |
| ç”Ÿäº§å°±ç»ª | è®¾è®¡ç”¨äºç”Ÿäº§ç¯å¢ƒ | ä¸»è¦ç”¨äºè°ƒè¯• |

### HITL çš„ä¸‰å¤§åº”ç”¨åœºæ™¯

```
+-----------------------------------------------------------+
|                    Human-in-the-Loop                       |
+---------------+-------------------+-----------------------+
|   å®¡æ‰¹ Approve |   ç¼–è¾‘ Edit       |   è¾“å…¥ Input          |
+---------------+-------------------+-----------------------+
| - å·¥å…·è°ƒç”¨å‰ç¡®è®¤| - ä¿®æ”¹ AI ç”Ÿæˆå†…å®¹ | - è·å–ç”¨æˆ·æ¾„æ¸…ä¿¡æ¯     |
| - æ•æ„Ÿæ“ä½œå®¡æ‰¹  | - çº æ­£é”™è¯¯åˆ¤æ–­    | - å¤šè½®å¯¹è¯æ”¶é›†ä¿¡æ¯     |
| - é«˜é£é™©åŠ¨ä½œæ‹¦æˆª| - è°ƒæ•´å‚æ•°è®¾ç½®    | - åŠ¨æ€è¡¥å……ä¸Šä¸‹æ–‡       |
+---------------+-------------------+-----------------------+
```

---

## ä»£ç å®ç°è¯¦è§£

### ç¤ºä¾‹ä¸€ï¼šæœ€ç®€å•çš„ HITLï¼ˆå…¥é—¨çº§ï¼‰

è¿™æ˜¯æœ€åŸºç¡€çš„ HITL ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•æš‚åœå¹¶ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼š

```python
"""
ç¤ºä¾‹1ï¼šæœ€ç®€å•çš„ HITL
ç›®æ ‡ï¼šåœ¨å·¥ä½œæµä¸­æš‚åœï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤åç»§ç»­
"""
from typing_extensions import TypedDict
from langgraph.graph import StateGraph, START, END
from langgraph.types import interrupt
from langgraph.checkpoint.memory import InMemorySaver

# ç¬¬ä¸€æ­¥ï¼šå®šä¹‰çŠ¶æ€ï¼ˆå›¾éœ€è¦è®°ä½ä»€ä¹ˆï¼‰
class State(TypedDict):
    message: str
    confirmed: bool

# ç¬¬äºŒæ­¥ï¼šå®šä¹‰èŠ‚ç‚¹å‡½æ•°
def ask_confirmation(state: State):
    """è¿™ä¸ªèŠ‚ç‚¹ä¼šæš‚åœï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤"""
    print(f"æ”¶åˆ°æ¶ˆæ¯: {state['message']}")

    # å…³é”®ï¼šè°ƒç”¨ interrupt() æš‚åœæ‰§è¡Œ
    # æ‹¬å·é‡Œçš„å­—ç¬¦ä¸²æ˜¯æç¤ºä¿¡æ¯ï¼Œä¼šè¿”å›ç»™è°ƒç”¨æ–¹
    user_response = interrupt("è¯·ç¡®è®¤æ˜¯å¦ç»§ç»­ï¼Ÿ(yes/no)")

    # ç”¨æˆ·æ¢å¤æ‰§è¡Œåï¼Œuser_response å°±æ˜¯ç”¨æˆ·è¾“å…¥çš„å€¼
    is_confirmed = user_response.lower() == "yes"
    return {"confirmed": is_confirmed}

def process_result(state: State):
    """æ ¹æ®ç”¨æˆ·ç¡®è®¤ç»“æœå¤„ç†"""
    if state["confirmed"]:
        print("ç”¨æˆ·å·²ç¡®è®¤ï¼Œç»§ç»­æ‰§è¡Œ...")
        return {"message": "æ“ä½œå·²å®Œæˆï¼"}
    else:
        print("ç”¨æˆ·å–æ¶ˆï¼Œåœæ­¢æ‰§è¡Œ...")
        return {"message": "æ“ä½œå·²å–æ¶ˆ"}

# ç¬¬ä¸‰æ­¥ï¼šæ„å»ºå›¾
builder = StateGraph(State)
builder.add_node("ask", ask_confirmation)
builder.add_node("process", process_result)
builder.add_edge(START, "ask")
builder.add_edge("ask", "process")
builder.add_edge("process", END)

# å…³é”®ï¼šå¿…é¡»æœ‰ checkpointer æ‰èƒ½ä½¿ç”¨ interrupt
memory = InMemorySaver()
graph = builder.compile(checkpointer=memory)

# ç¬¬å››æ­¥ï¼šæ‰§è¡Œå›¾
config = {"configurable": {"thread_id": "user-123"}}

# é¦–æ¬¡è¿è¡Œ - ä¼šåœ¨ interrupt() å¤„æš‚åœ
print("=== å¼€å§‹æ‰§è¡Œ ===")
for event in graph.stream({"message": "Hello World"}, config):
    print(event)

print("\n=== å›¾å·²æš‚åœï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥ ===\n")

# æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥ "yes"ï¼Œä½¿ç”¨ Command æ¢å¤æ‰§è¡Œ
from langgraph.types import Command

print("=== ç”¨æˆ·è¾“å…¥ yesï¼Œæ¢å¤æ‰§è¡Œ ===")
for event in graph.stream(Command(resume="yes"), config):
    print(event)
```

**è¿è¡Œç»“æœï¼š**
```
=== å¼€å§‹æ‰§è¡Œ ===
æ”¶åˆ°æ¶ˆæ¯: Hello World
{'__interrupt__': (Interrupt(value='è¯·ç¡®è®¤æ˜¯å¦ç»§ç»­ï¼Ÿ(yes/no)'),)}

=== å›¾å·²æš‚åœï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥ ===

=== ç”¨æˆ·è¾“å…¥ yesï¼Œæ¢å¤æ‰§è¡Œ ===
ç”¨æˆ·å·²ç¡®è®¤ï¼Œç»§ç»­æ‰§è¡Œ...
{'process': {'message': 'æ“ä½œå·²å®Œæˆï¼'}}
```

---

### ç¤ºä¾‹äºŒï¼šå®¡æ‰¹/æ‹’ç»æ¨¡å¼ï¼ˆä¸­çº§ï¼‰

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºå¦‚ä½•æ ¹æ®ç”¨æˆ·çš„å®¡æ‰¹ç»“æœï¼Œè·¯ç”±åˆ°ä¸åŒçš„å¤„ç†åˆ†æ”¯ï¼š

```python
"""
ç¤ºä¾‹2ï¼šå®¡æ‰¹/æ‹’ç»æ¨¡å¼
ç›®æ ‡ï¼šç”¨æˆ·å¯ä»¥æ‰¹å‡†æˆ–æ‹’ç»æ“ä½œï¼Œå›¾æ ¹æ®ç»“æœèµ°ä¸åŒåˆ†æ”¯
"""
from typing_extensions import TypedDict
from langgraph.graph import StateGraph, START, END
from langgraph.types import interrupt, Command
from langgraph.checkpoint.memory import InMemorySaver

class WorkflowState(TypedDict):
    task: str
    user_decision: str
    status: str

def get_approval(state: WorkflowState):
    """æš‚åœå¹¶ç­‰å¾…ç”¨æˆ·å®¡æ‰¹"""
    print(f"å¾…å®¡æ‰¹ä»»åŠ¡: {state['task']}")

    # æš‚åœç­‰å¾…ç”¨æˆ·è¾“å…¥
    decision = interrupt({
        "prompt": "è¯·å®¡æ‰¹æ­¤ä»»åŠ¡",
        "task": state["task"],
        "options": ["approve", "reject"]
    })

    print(f"ç”¨æˆ·å†³å®š: {decision}")
    return {"user_decision": decision}

def router(state: WorkflowState) -> Command:
    """æ ¹æ®ç”¨æˆ·å†³å®šè·¯ç”±åˆ°ä¸åŒèŠ‚ç‚¹"""
    decision = state.get("user_decision", "").strip().lower()

    if decision == "approve":
        return Command(goto="complete_task")
    else:
        return Command(goto="cancel_task")

def complete_task(state: WorkflowState):
    """æ‰¹å‡†åæ‰§è¡Œä»»åŠ¡"""
    print("ä»»åŠ¡å·²æ‰¹å‡†å¹¶å®Œæˆï¼")
    return {"status": "completed"}

def cancel_task(state: WorkflowState):
    """æ‹’ç»åå–æ¶ˆä»»åŠ¡"""
    print("ä»»åŠ¡å·²è¢«æ‹’ç»å¹¶å–æ¶ˆ")
    return {"status": "cancelled"}

# æ„å»ºå›¾
builder = StateGraph(WorkflowState)
builder.add_node("get_approval", get_approval)
builder.add_node("router", router)
builder.add_node("complete_task", complete_task)
builder.add_node("cancel_task", cancel_task)

builder.add_edge(START, "get_approval")
builder.add_edge("get_approval", "router")
builder.add_edge("complete_task", END)
builder.add_edge("cancel_task", END)

memory = InMemorySaver()
graph = builder.compile(checkpointer=memory)

# æµ‹è¯•åœºæ™¯1ï¼šæ‰¹å‡†
print("\n" + "="*50)
print("åœºæ™¯1ï¼šç”¨æˆ·æ‰¹å‡†ä»»åŠ¡")
print("="*50)

config1 = {"configurable": {"thread_id": "test-1"}}
initial_input = {"task": "éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒæ–°åŠŸèƒ½"}

# è¿è¡Œåˆ°ä¸­æ–­ç‚¹
for event in graph.stream(initial_input, config1, stream_mode="values"):
    print(f"çŠ¶æ€: {event}")

# ç”¨æˆ·æ‰¹å‡†
print("\n--- ç”¨æˆ·è¾“å…¥: approve ---\n")
for event in graph.stream(Command(resume="approve"), config1, stream_mode="values"):
    print(f"çŠ¶æ€: {event}")

# æµ‹è¯•åœºæ™¯2ï¼šæ‹’ç»
print("\n" + "="*50)
print("åœºæ™¯2ï¼šç”¨æˆ·æ‹’ç»ä»»åŠ¡")
print("="*50)

config2 = {"configurable": {"thread_id": "test-2"}}

for event in graph.stream(initial_input, config2, stream_mode="values"):
    print(f"çŠ¶æ€: {event}")

print("\n--- ç”¨æˆ·è¾“å…¥: reject ---\n")
for event in graph.stream(Command(resume="reject"), config2, stream_mode="values"):
    print(f"çŠ¶æ€: {event}")
```

---

### ç¤ºä¾‹ä¸‰ï¼šè¾“å…¥éªŒè¯å¾ªç¯ï¼ˆä¸­é«˜çº§ï¼‰

æœ‰æ—¶å€™ç”¨æˆ·çš„è¾“å…¥éœ€è¦éªŒè¯ï¼Œæ— æ•ˆè¾“å…¥éœ€è¦é‡æ–°è¯·æ±‚ã€‚è¿™ä¸ªç¤ºä¾‹å±•ç¤ºå¦‚ä½•ä½¿ç”¨å¾ªç¯å®ç°è¾“å…¥éªŒè¯ï¼š

```python
"""
ç¤ºä¾‹3ï¼šè¾“å…¥éªŒè¯å¾ªç¯
ç›®æ ‡ï¼šæŒç»­è¯·æ±‚ç”¨æˆ·è¾“å…¥ï¼Œç›´åˆ°è¾“å…¥æœ‰æ•ˆä¸ºæ­¢
"""
from typing_extensions import TypedDict
from langgraph.graph import StateGraph, START, END
from langgraph.types import interrupt, Command
from langgraph.checkpoint.memory import InMemorySaver

class FormState(TypedDict):
    name: str
    age: int
    email: str

def collect_age(state: FormState):
    """æ”¶é›†å¹¶éªŒè¯å¹´é¾„è¾“å…¥"""
    prompt = "è¯·è¾“å…¥æ‚¨çš„å¹´é¾„ï¼ˆæ­£æ•´æ•°ï¼‰ï¼š"

    while True:
        # æ¯æ¬¡å¾ªç¯éƒ½ä¼šæš‚åœç­‰å¾…è¾“å…¥
        answer = interrupt(prompt)

        # éªŒè¯è¾“å…¥
        try:
            age = int(answer)
            if age > 0 and age < 150:
                print(f"å¹´é¾„éªŒè¯é€šè¿‡: {age}")
                return {"age": age}
            else:
                prompt = f"'{answer}' ä¸æ˜¯æœ‰æ•ˆå¹´é¾„ï¼Œè¯·è¾“å…¥1-150ä¹‹é—´çš„æ•°å­—ï¼š"
        except ValueError:
            prompt = f"'{answer}' ä¸æ˜¯æ•°å­—ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„å¹´é¾„ï¼š"

def collect_email(state: FormState):
    """æ”¶é›†å¹¶éªŒè¯é‚®ç®±è¾“å…¥"""
    prompt = "è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ï¼š"

    while True:
        answer = interrupt(prompt)

        # ç®€å•çš„é‚®ç®±éªŒè¯
        if "@" in answer and "." in answer:
            print(f"é‚®ç®±éªŒè¯é€šè¿‡: {answer}")
            return {"email": answer}
        else:
            prompt = f"'{answer}' ä¸æ˜¯æœ‰æ•ˆé‚®ç®±ï¼Œè¯·é‡æ–°è¾“å…¥ï¼ˆéœ€åŒ…å«@å’Œ.ï¼‰ï¼š"

def show_summary(state: FormState):
    """æ˜¾ç¤ºæ”¶é›†ç»“æœ"""
    print("\n" + "="*40)
    print("ä¿¡æ¯æ”¶é›†å®Œæˆï¼")
    print(f"   å§“å: {state['name']}")
    print(f"   å¹´é¾„: {state['age']}")
    print(f"   é‚®ç®±: {state['email']}")
    print("="*40)
    return state

# æ„å»ºå›¾
builder = StateGraph(FormState)
builder.add_node("collect_age", collect_age)
builder.add_node("collect_email", collect_email)
builder.add_node("show_summary", show_summary)

builder.add_edge(START, "collect_age")
builder.add_edge("collect_age", "collect_email")
builder.add_edge("collect_email", "show_summary")
builder.add_edge("show_summary", END)

memory = InMemorySaver()
graph = builder.compile(checkpointer=memory)

# æ‰§è¡Œç¤ºä¾‹
config = {"configurable": {"thread_id": "form-123"}}
initial = {"name": "å¼ ä¸‰", "age": 0, "email": ""}

print("=== å¼€å§‹æ”¶é›†ä¿¡æ¯ ===\n")

# ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œä¼šåœ¨ç¬¬ä¸€ä¸ª interrupt å¤„æš‚åœ
for event in graph.stream(initial, config, stream_mode="values"):
    if "__interrupt__" in str(event):
        print(f"ç³»ç»Ÿæç¤º: {event}")

# æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥æ— æ•ˆå¹´é¾„
print("\nç”¨æˆ·è¾“å…¥: 'abc' (æ— æ•ˆ)")
for event in graph.stream(Command(resume="abc"), config, stream_mode="values"):
    if "__interrupt__" in str(event):
        print(f"ç³»ç»Ÿæç¤º: {event}")

# å†æ¬¡è¾“å…¥æ— æ•ˆå¹´é¾„
print("\nç”¨æˆ·è¾“å…¥: '-5' (æ— æ•ˆ)")
for event in graph.stream(Command(resume="-5"), config, stream_mode="values"):
    if "__interrupt__" in str(event):
        print(f"ç³»ç»Ÿæç¤º: {event}")

# è¾“å…¥æœ‰æ•ˆå¹´é¾„ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥
print("\nç”¨æˆ·è¾“å…¥: '25' (æœ‰æ•ˆ)")
for event in graph.stream(Command(resume="25"), config, stream_mode="values"):
    if "__interrupt__" in str(event):
        print(f"ç³»ç»Ÿæç¤º: {event}")

# è¾“å…¥æ— æ•ˆé‚®ç®±
print("\nç”¨æˆ·è¾“å…¥: 'invalid' (æ— æ•ˆé‚®ç®±)")
for event in graph.stream(Command(resume="invalid"), config, stream_mode="values"):
    if "__interrupt__" in str(event):
        print(f"ç³»ç»Ÿæç¤º: {event}")

# è¾“å…¥æœ‰æ•ˆé‚®ç®±
print("\nç”¨æˆ·è¾“å…¥: 'zhangsan@example.com' (æœ‰æ•ˆ)")
for event in graph.stream(Command(resume="zhangsan@example.com"), config, stream_mode="values"):
    print(f"æœ€ç»ˆçŠ¶æ€: {event}")
```

---

### ç¤ºä¾‹å››ï¼šå·¥å…·è°ƒç”¨å®¡æ‰¹ï¼ˆé«˜çº§ï¼‰

è¿™æ˜¯æœ€å¸¸è§çš„ç”Ÿäº§åœºæ™¯ï¼šAI Agent å†³å®šè°ƒç”¨æŸä¸ªå·¥å…·å‰ï¼Œéœ€è¦äººå·¥å®¡æ‰¹ï¼š

```python
"""
ç¤ºä¾‹4ï¼šå·¥å…·è°ƒç”¨å®¡æ‰¹
ç›®æ ‡ï¼šAI Agent åœ¨è°ƒç”¨å·¥å…·å‰éœ€è¦äººå·¥å®¡æ‰¹
"""
from typing import Annotated
from typing_extensions import TypedDict
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from langgraph.types import interrupt, Command
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.prebuilt import ToolNode, tools_condition
from langchain_core.tools import tool
from langchain_openai import ChatOpenAI

# å®šä¹‰å·¥å…·
@tool
def send_email(to: str, subject: str, body: str) -> str:
    """å‘é€é‚®ä»¶ç»™æŒ‡å®šæ”¶ä»¶äºº"""
    # å®é™…åº”ç”¨ä¸­è¿™é‡Œä¼šè°ƒç”¨é‚®ä»¶æœåŠ¡
    return f"é‚®ä»¶å·²å‘é€ç»™ {to}ï¼Œä¸»é¢˜: {subject}"

@tool
def delete_file(filename: str) -> str:
    """åˆ é™¤æŒ‡å®šæ–‡ä»¶ï¼ˆå±é™©æ“ä½œï¼‰"""
    return f"æ–‡ä»¶ {filename} å·²åˆ é™¤"

@tool
def get_weather(city: str) -> str:
    """è·å–åŸå¸‚å¤©æ°”ï¼ˆå®‰å…¨æ“ä½œï¼‰"""
    return f"{city}ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ¸©åº¦25åº¦C"

# å®šä¹‰å“ªäº›å·¥å…·éœ€è¦å®¡æ‰¹
TOOLS_REQUIRING_APPROVAL = {"send_email", "delete_file"}

# çŠ¶æ€å®šä¹‰
class AgentState(TypedDict):
    messages: Annotated[list, add_messages]

# åˆ›å»ºå¸¦å®¡æ‰¹åŠŸèƒ½çš„å·¥å…·èŠ‚ç‚¹
def tool_node_with_approval(state: AgentState):
    """æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼Œæ•æ„Ÿå·¥å…·éœ€è¦å®¡æ‰¹"""
    last_message = state["messages"][-1]

    results = []
    for tool_call in last_message.tool_calls:
        tool_name = tool_call["name"]
        tool_args = tool_call["args"]

        # æ£€æŸ¥æ˜¯å¦éœ€è¦å®¡æ‰¹
        if tool_name in TOOLS_REQUIRING_APPROVAL:
            print(f"\næ•æ„Ÿæ“ä½œéœ€è¦å®¡æ‰¹: {tool_name}")
            print(f"   å‚æ•°: {tool_args}")

            # æš‚åœç­‰å¾…å®¡æ‰¹
            approval = interrupt({
                "type": "tool_approval",
                "tool": tool_name,
                "args": tool_args,
                "message": f"æ˜¯å¦å…è®¸æ‰§è¡Œ {tool_name}ï¼Ÿ(approve/reject)"
            })

            if approval.lower() != "approve":
                results.append({
                    "tool_call_id": tool_call["id"],
                    "content": f"æ“ä½œè¢«ç”¨æˆ·æ‹’ç»: {tool_name}"
                })
                continue

            print(f"ç”¨æˆ·å·²æ‰¹å‡† {tool_name}")

        # æ‰§è¡Œå·¥å…·
        tool_map = {
            "send_email": send_email,
            "delete_file": delete_file,
            "get_weather": get_weather
        }

        result = tool_map[tool_name].invoke(tool_args)
        results.append({
            "tool_call_id": tool_call["id"],
            "content": result
        })

    from langchain_core.messages import ToolMessage
    return {"messages": [ToolMessage(**r) for r in results]}

# åˆ›å»º Agent
tools = [send_email, delete_file, get_weather]
llm = ChatOpenAI(model="gpt-4").bind_tools(tools)

def agent(state: AgentState):
    """Agent èŠ‚ç‚¹ï¼šè°ƒç”¨ LLM å†³å®šä¸‹ä¸€æ­¥"""
    response = llm.invoke(state["messages"])
    return {"messages": [response]}

# æ„å»ºå›¾
builder = StateGraph(AgentState)
builder.add_node("agent", agent)
builder.add_node("tools", tool_node_with_approval)

builder.add_edge(START, "agent")
builder.add_conditional_edges("agent", tools_condition)
builder.add_edge("tools", "agent")

memory = InMemorySaver()
graph = builder.compile(checkpointer=memory)

# æµ‹è¯•
config = {"configurable": {"thread_id": "agent-test"}}

print("=== æµ‹è¯•1ï¼šæŸ¥è¯¢å¤©æ°”ï¼ˆä¸éœ€è¦å®¡æ‰¹ï¼‰===")
for event in graph.stream(
    {"messages": [("user", "åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ")]},
    config,
    stream_mode="values"
):
    if event["messages"]:
        print(event["messages"][-1])

print("\n=== æµ‹è¯•2ï¼šå‘é€é‚®ä»¶ï¼ˆéœ€è¦å®¡æ‰¹ï¼‰===")
config2 = {"configurable": {"thread_id": "agent-test-2"}}

for event in graph.stream(
    {"messages": [("user", "å¸®æˆ‘å‘ä¸€å°é‚®ä»¶ç»™ boss@company.comï¼Œä¸»é¢˜æ˜¯è¯·å‡ç”³è¯·")]},
    config2,
    stream_mode="values"
):
    if "__interrupt__" in str(event):
        print(f"\nç­‰å¾…å®¡æ‰¹...")
        break
    if event["messages"]:
        print(event["messages"][-1])

# ç”¨æˆ·å®¡æ‰¹
print("\nç”¨æˆ·è¾“å…¥: approve")
for event in graph.stream(Command(resume="approve"), config2, stream_mode="values"):
    if event["messages"]:
        print(event["messages"][-1])
```

---

### ç¤ºä¾‹äº”ï¼šå¤šæ­¥éª¤å·¥ä½œæµ + çŠ¶æ€ç¼–è¾‘ï¼ˆé«˜çº§ï¼‰

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºå¦‚ä½•åœ¨æš‚åœæ—¶è®©ç”¨æˆ·ç¼–è¾‘å›¾çš„çŠ¶æ€ï¼š

```python
"""
ç¤ºä¾‹5ï¼šå¤šæ­¥éª¤å·¥ä½œæµ + çŠ¶æ€ç¼–è¾‘
ç›®æ ‡ï¼šç”¨æˆ·å¯ä»¥åœ¨ä¸­æ–­æ—¶æŸ¥çœ‹å¹¶ä¿®æ”¹ Agent çš„å·¥ä½œçŠ¶æ€
"""
from typing import Annotated
from typing_extensions import TypedDict
from langgraph.graph import StateGraph, START, END
from langgraph.types import interrupt, Command
from langgraph.checkpoint.memory import InMemorySaver

class DocumentState(TypedDict):
    title: str
    content: str
    summary: str
    approved: bool

def generate_summary(state: DocumentState):
    """AI ç”Ÿæˆæ‘˜è¦"""
    # æ¨¡æ‹Ÿ AI ç”Ÿæˆæ‘˜è¦
    summary = f"è¿™æ˜¯å…³äº'{state['title']}'çš„æ‘˜è¦ï¼š{state['content'][:50]}..."
    print(f"AI ç”Ÿæˆæ‘˜è¦: {summary}")
    return {"summary": summary}

def review_summary(state: DocumentState):
    """äººå·¥å®¡æ ¸æ‘˜è¦ï¼Œå¯ä»¥ç¼–è¾‘"""
    print("\n" + "="*50)
    print("è¯·å®¡æ ¸ AI ç”Ÿæˆçš„æ‘˜è¦ï¼š")
    print(f"   æ ‡é¢˜: {state['title']}")
    print(f"   æ‘˜è¦: {state['summary']}")
    print("="*50)

    # æš‚åœç­‰å¾…ç”¨æˆ·åé¦ˆ
    feedback = interrupt({
        "type": "review",
        "current_summary": state["summary"],
        "options": [
            "approve - æ‰¹å‡†å½“å‰æ‘˜è¦",
            "edit:æ–°æ‘˜è¦å†…å®¹ - ä¿®æ”¹æ‘˜è¦",
            "reject - æ‹’ç»"
        ]
    })

    feedback = feedback.strip()

    if feedback.lower() == "approve":
        print("æ‘˜è¦å·²æ‰¹å‡†")
        return {"approved": True}
    elif feedback.lower().startswith("edit:"):
        new_summary = feedback[5:].strip()
        print(f"æ‘˜è¦å·²ä¿®æ”¹ä¸º: {new_summary}")
        return {"summary": new_summary, "approved": True}
    else:
        print("æ‘˜è¦è¢«æ‹’ç»")
        return {"approved": False}

def finalize(state: DocumentState):
    """æœ€ç»ˆå¤„ç†"""
    if state["approved"]:
        print(f"\næ–‡æ¡£å¤„ç†å®Œæˆï¼æœ€ç»ˆæ‘˜è¦: {state['summary']}")
    else:
        print("\næ–‡æ¡£å¤„ç†æœªå®Œæˆï¼Œæ‘˜è¦è¢«æ‹’ç»")
    return state

# æ„å»ºå›¾
builder = StateGraph(DocumentState)
builder.add_node("generate", generate_summary)
builder.add_node("review", review_summary)
builder.add_node("finalize", finalize)

builder.add_edge(START, "generate")
builder.add_edge("generate", "review")
builder.add_edge("review", "finalize")
builder.add_edge("finalize", END)

memory = InMemorySaver()
graph = builder.compile(checkpointer=memory)

# æµ‹è¯•åœºæ™¯ï¼šç”¨æˆ·ç¼–è¾‘æ‘˜è¦
config = {"configurable": {"thread_id": "doc-1"}}

print("=== å¼€å§‹æ–‡æ¡£å¤„ç† ===\n")
for event in graph.stream({
    "title": "LangGraph å…¥é—¨æŒ‡å—",
    "content": "LangGraph æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæœ‰çŠ¶æ€ã€å¤šè§’è‰²åº”ç”¨çš„æ¡†æ¶...",
    "summary": "",
    "approved": False
}, config, stream_mode="values"):
    pass

# ç”¨æˆ·é€‰æ‹©ç¼–è¾‘
print("\nç”¨æˆ·è¾“å…¥: edit:LangGraph æ˜¯æ„å»º AI Agent çš„å¼ºå¤§æ¡†æ¶")
for event in graph.stream(
    Command(resume="edit:LangGraph æ˜¯æ„å»º AI Agent çš„å¼ºå¤§æ¡†æ¶"),
    config,
    stream_mode="values"
):
    pass
```

---

## å®Œæ•´æ¡ˆä¾‹ä»£ç ï¼ˆå¯ç›´æ¥è¿è¡Œï¼‰

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€å¯ä»¥ç›´æ¥åœ¨ Jupyter Notebook ä¸­è¿è¡Œçš„ä»£ç ç¤ºä¾‹ï¼Œæ¼”ç¤º LangGraph 1.0 HITL çš„æ ¸å¿ƒåŠŸèƒ½ï¼š

```python
# ============================================================
# LangGraph 1.0 Human-in-the-Loop (HITL) å®Œæ•´ç¤ºä¾‹
# æ¼”ç¤ºï¼šinterrupt()ã€Commandã€InMemorySaver ååŒå·¥ä½œ
# ============================================================

# --------------------------
# 1. å¯¼å…¥å¿…è¦çš„åº“
# --------------------------
from typing_extensions import TypedDict
from langgraph.graph import StateGraph, START, END
from langgraph.types import interrupt, Command
from langgraph.checkpoint.memory import InMemorySaver
from IPython.display import Image, display

# --------------------------
# 2. å®šä¹‰çŠ¶æ€
# --------------------------
class TaskState(TypedDict):
    task_name: str
    task_params: dict
    user_decision: str
    result: str

# --------------------------
# 3. å®šä¹‰èŠ‚ç‚¹
# --------------------------
def prepare_task(state: TaskState):
    """å‡†å¤‡ä»»åŠ¡ï¼Œå±•ç¤ºå°†è¦æ‰§è¡Œçš„æ“ä½œ"""
    print(f"\nğŸ“‹ å‡†å¤‡æ‰§è¡Œä»»åŠ¡: {state['task_name']}")
    print(f"   å‚æ•°: {state['task_params']}")
    return state

def get_user_approval(state: TaskState):
    """æš‚åœç­‰å¾…ç”¨æˆ·å®¡æ‰¹"""
    print("\nâ¸ï¸ éœ€è¦ç”¨æˆ·å®¡æ‰¹...")

    # å…³é”®ï¼šä½¿ç”¨ interrupt() æš‚åœæ‰§è¡Œ
    decision = interrupt({
        "type": "approval_request",
        "task": state["task_name"],
        "params": state["task_params"],
        "prompt": "è¯·é€‰æ‹©: approve (æ‰¹å‡†) / reject (æ‹’ç») / modify:æ–°å‚æ•° (ä¿®æ”¹)"
    })

    print(f"âœ… æ”¶åˆ°ç”¨æˆ·åé¦ˆ: {decision}")
    return {"user_decision": decision}

def process_decision(state: TaskState) -> Command:
    """æ ¹æ®ç”¨æˆ·å†³å®šè·¯ç”±åˆ°ä¸åŒåˆ†æ”¯"""
    decision = state["user_decision"].strip().lower()

    if decision == "approve":
        return Command(goto="execute_task")
    elif decision.startswith("modify:"):
        # æå–ä¿®æ”¹åçš„å‚æ•°
        new_param = decision[7:].strip()
        return Command(goto="execute_task", update={"task_params": {"value": new_param}})
    else:
        return Command(goto="cancel_task")

def execute_task(state: TaskState):
    """æ‰§è¡Œä»»åŠ¡"""
    print(f"\nğŸš€ æ‰§è¡Œä»»åŠ¡: {state['task_name']}")
    print(f"   ä½¿ç”¨å‚æ•°: {state['task_params']}")
    result = f"ä»»åŠ¡ '{state['task_name']}' æ‰§è¡ŒæˆåŠŸï¼Œå‚æ•°: {state['task_params']}"
    print(f"   ç»“æœ: {result}")
    return {"result": result}

def cancel_task(state: TaskState):
    """å–æ¶ˆä»»åŠ¡"""
    print(f"\nâŒ ä»»åŠ¡å·²å–æ¶ˆ: {state['task_name']}")
    return {"result": "ä»»åŠ¡å·²å–æ¶ˆ"}

# --------------------------
# 4. æ„å»ºå›¾
# --------------------------
builder = StateGraph(TaskState)

builder.add_node("prepare", prepare_task)
builder.add_node("approval", get_user_approval)
builder.add_node("router", process_decision)
builder.add_node("execute_task", execute_task)
builder.add_node("cancel_task", cancel_task)

builder.add_edge(START, "prepare")
builder.add_edge("prepare", "approval")
builder.add_edge("approval", "router")
builder.add_edge("execute_task", END)
builder.add_edge("cancel_task", END)

# å…³é”®ï¼šå¿…é¡»æœ‰ Checkpointer æ‰èƒ½ä½¿ç”¨ interrupt
memory = InMemorySaver()
graph = builder.compile(checkpointer=memory)

# --------------------------
# 5. å¯è§†åŒ–å›¾ç»“æ„
# --------------------------
print("ğŸ“Š å›¾ç»“æ„å¯è§†åŒ–ï¼š")
display(Image(graph.get_graph().draw_mermaid_png()))

# --------------------------
# 6. åœºæ™¯ 1ï¼šç”¨æˆ·æ‰¹å‡†
# --------------------------
print("\n" + "=" * 60)
print("ğŸ“— åœºæ™¯ 1ï¼šç”¨æˆ·æ‰¹å‡†ä»»åŠ¡")
print("=" * 60)

config1 = {"configurable": {"thread_id": "hitl-demo-1"}}
initial_input = {
    "task_name": "å‘é€é‚®ä»¶",
    "task_params": {"to": "user@example.com", "subject": "æµ‹è¯•"},
    "user_decision": "",
    "result": ""
}

# æ‰§è¡Œåˆ° interrupt å¤„æš‚åœ
print("\nâ–¶ï¸ å¼€å§‹æ‰§è¡Œï¼ˆä¼šåœ¨å®¡æ‰¹å¤„æš‚åœï¼‰...")
for event in graph.stream(initial_input, config1, stream_mode="values"):
    pass

# æ£€æŸ¥æš‚åœçŠ¶æ€
state1 = graph.get_state(config1)
print(f"\nğŸ“ å½“å‰æš‚åœäº: {state1.next}")
if state1.tasks and state1.tasks[0].interrupts:
    interrupt_info = state1.tasks[0].interrupts[0]
    print(f"ğŸ“Œ ä¸­æ–­ä¿¡æ¯: {interrupt_info.value}")

# ç”¨æˆ·æ‰¹å‡†ï¼Œä½¿ç”¨ Command(resume=) æ¢å¤æ‰§è¡Œ
print("\nğŸ‘¤ ç”¨æˆ·è¾“å…¥: approve")
for event in graph.stream(Command(resume="approve"), config1, stream_mode="values"):
    pass

print(f"\nğŸ“Š æœ€ç»ˆç»“æœ: {graph.get_state(config1).values['result']}")

# --------------------------
# 7. åœºæ™¯ 2ï¼šç”¨æˆ·æ‹’ç»
# --------------------------
print("\n" + "=" * 60)
print("ğŸ“• åœºæ™¯ 2ï¼šç”¨æˆ·æ‹’ç»ä»»åŠ¡")
print("=" * 60)

config2 = {"configurable": {"thread_id": "hitl-demo-2"}}

for event in graph.stream(initial_input, config2, stream_mode="values"):
    pass

print("\nğŸ‘¤ ç”¨æˆ·è¾“å…¥: reject")
for event in graph.stream(Command(resume="reject"), config2, stream_mode="values"):
    pass

print(f"\nğŸ“Š æœ€ç»ˆç»“æœ: {graph.get_state(config2).values['result']}")

# --------------------------
# 8. åœºæ™¯ 3ï¼šç”¨æˆ·ä¿®æ”¹å‚æ•°
# --------------------------
print("\n" + "=" * 60)
print("ğŸ“˜ åœºæ™¯ 3ï¼šç”¨æˆ·ä¿®æ”¹å‚æ•°åæ‰§è¡Œ")
print("=" * 60)

config3 = {"configurable": {"thread_id": "hitl-demo-3"}}

for event in graph.stream(initial_input, config3, stream_mode="values"):
    pass

print("\nğŸ‘¤ ç”¨æˆ·è¾“å…¥: modify:æ–°çš„æ”¶ä»¶äºº")
for event in graph.stream(Command(resume="modify:æ–°çš„æ”¶ä»¶äºº"), config3, stream_mode="values"):
    pass

final_state = graph.get_state(config3).values
print(f"\nğŸ“Š æœ€ç»ˆç»“æœ: {final_state['result']}")
print(f"ğŸ“Š ä¿®æ”¹åå‚æ•°: {final_state['task_params']}")

# --------------------------
# 9. æ¼”ç¤ºï¼šè¾“å…¥éªŒè¯å¾ªç¯
# --------------------------
print("\n" + "=" * 60)
print("ğŸ”„ æ¼”ç¤ºï¼šè¾“å…¥éªŒè¯å¾ªç¯ï¼ˆå¤šæ¬¡ interruptï¼‰")
print("=" * 60)

class ValidationState(TypedDict):
    name: str
    age: int

def collect_age(state: ValidationState):
    """æ”¶é›†å¹´é¾„ï¼ŒéªŒè¯ç›´åˆ°æœ‰æ•ˆ"""
    prompt = "è¯·è¾“å…¥æ‚¨çš„å¹´é¾„ï¼ˆ1-150çš„æ•´æ•°ï¼‰ï¼š"

    while True:
        answer = interrupt(prompt)

        try:
            age = int(answer)
            if 1 <= age <= 150:
                print(f"âœ… å¹´é¾„éªŒè¯é€šè¿‡: {age}")
                return {"age": age}
            else:
                prompt = f"'{answer}' ä¸åœ¨æœ‰æ•ˆèŒƒå›´(1-150)ï¼Œè¯·é‡æ–°è¾“å…¥ï¼š"
        except ValueError:
            prompt = f"'{answer}' ä¸æ˜¯æ•°å­—ï¼Œè¯·è¾“å…¥æœ‰æ•ˆå¹´é¾„ï¼š"

def show_result(state: ValidationState):
    """æ˜¾ç¤ºç»“æœ"""
    print(f"\nğŸ“Š æ”¶é›†å®Œæˆï¼{state['name']} çš„å¹´é¾„æ˜¯ {state['age']} å²")
    return state

# æ„å»ºéªŒè¯å›¾
val_builder = StateGraph(ValidationState)
val_builder.add_node("collect_age", collect_age)
val_builder.add_node("show_result", show_result)
val_builder.add_edge(START, "collect_age")
val_builder.add_edge("collect_age", "show_result")
val_builder.add_edge("show_result", END)

val_memory = InMemorySaver()
val_graph = val_builder.compile(checkpointer=val_memory)

config4 = {"configurable": {"thread_id": "validation-demo"}}

# é¦–æ¬¡æ‰§è¡Œ
print("\nâ–¶ï¸ å¼€å§‹æ”¶é›†å¹´é¾„...")
for event in val_graph.stream({"name": "å¼ ä¸‰", "age": 0}, config4, stream_mode="values"):
    pass

# è¾“å…¥æ— æ•ˆå€¼
print("\nğŸ‘¤ ç”¨æˆ·è¾“å…¥: 'abc' (æ— æ•ˆ)")
for event in val_graph.stream(Command(resume="abc"), config4, stream_mode="values"):
    pass

# å†æ¬¡è¾“å…¥æ— æ•ˆå€¼
print("\nğŸ‘¤ ç”¨æˆ·è¾“å…¥: '-5' (æ— æ•ˆ)")
for event in val_graph.stream(Command(resume="-5"), config4, stream_mode="values"):
    pass

# è¾“å…¥æœ‰æ•ˆå€¼
print("\nğŸ‘¤ ç”¨æˆ·è¾“å…¥: '25' (æœ‰æ•ˆ)")
for event in val_graph.stream(Command(resume="25"), config4, stream_mode="values"):
    pass

print("\nâœ¨ HITL æ¼”ç¤ºå®Œæˆï¼")
```

**è¿è¡Œç»“æœç¤ºä¾‹ï¼š**

```
ğŸ“Š å›¾ç»“æ„å¯è§†åŒ–ï¼š
[æ˜¾ç¤ºå›¾ï¼šSTART â†’ prepare â†’ approval â†’ router â†’ execute_task/cancel_task â†’ END]

============================================================
ğŸ“— åœºæ™¯ 1ï¼šç”¨æˆ·æ‰¹å‡†ä»»åŠ¡
============================================================

â–¶ï¸ å¼€å§‹æ‰§è¡Œï¼ˆä¼šåœ¨å®¡æ‰¹å¤„æš‚åœï¼‰...

ğŸ“‹ å‡†å¤‡æ‰§è¡Œä»»åŠ¡: å‘é€é‚®ä»¶
   å‚æ•°: {'to': 'user@example.com', 'subject': 'æµ‹è¯•'}

â¸ï¸ éœ€è¦ç”¨æˆ·å®¡æ‰¹...

ğŸ“ å½“å‰æš‚åœäº: ('approval',)
ğŸ“Œ ä¸­æ–­ä¿¡æ¯: {'type': 'approval_request', 'task': 'å‘é€é‚®ä»¶', ...}

ğŸ‘¤ ç”¨æˆ·è¾“å…¥: approve
âœ… æ”¶åˆ°ç”¨æˆ·åé¦ˆ: approve

ğŸš€ æ‰§è¡Œä»»åŠ¡: å‘é€é‚®ä»¶
   ä½¿ç”¨å‚æ•°: {'to': 'user@example.com', 'subject': 'æµ‹è¯•'}
   ç»“æœ: ä»»åŠ¡ 'å‘é€é‚®ä»¶' æ‰§è¡ŒæˆåŠŸ...

ğŸ“Š æœ€ç»ˆç»“æœ: ä»»åŠ¡ 'å‘é€é‚®ä»¶' æ‰§è¡ŒæˆåŠŸ...

============================================================
ğŸ“• åœºæ™¯ 2ï¼šç”¨æˆ·æ‹’ç»ä»»åŠ¡
============================================================
...
ğŸ“Š æœ€ç»ˆç»“æœ: ä»»åŠ¡å·²å–æ¶ˆ

============================================================
ğŸ”„ æ¼”ç¤ºï¼šè¾“å…¥éªŒè¯å¾ªç¯ï¼ˆå¤šæ¬¡ interruptï¼‰
============================================================

ğŸ‘¤ ç”¨æˆ·è¾“å…¥: 'abc' (æ— æ•ˆ)
[ç³»ç»Ÿç­‰å¾…æ–°è¾“å…¥...]

ğŸ‘¤ ç”¨æˆ·è¾“å…¥: '25' (æœ‰æ•ˆ)
âœ… å¹´é¾„éªŒè¯é€šè¿‡: 25

ğŸ“Š æ”¶é›†å®Œæˆï¼å¼ ä¸‰ çš„å¹´é¾„æ˜¯ 25 å²
```

**ä»£ç è¦ç‚¹è¯´æ˜ï¼š**

| è¦ç‚¹ | è¯´æ˜ |
|------|------|
| `interrupt(payload)` | æš‚åœæ‰§è¡Œï¼Œpayload è¿”å›ç»™è°ƒç”¨æ–¹ï¼ˆå¿…é¡»å¯ JSON åºåˆ—åŒ–ï¼‰ |
| `Command(resume=value)` | æ¢å¤æ‰§è¡Œï¼Œå°† value ä½œä¸º interrupt çš„è¿”å›å€¼ |
| `Command(goto="node")` | è·¯ç”±åˆ°æŒ‡å®šèŠ‚ç‚¹ |
| `Command(goto="node", update={...})` | è·¯ç”±å¹¶åŒæ—¶æ›´æ–°çŠ¶æ€ |
| `InMemorySaver()` | å†…å­˜ Checkpointerï¼ˆå¼€å‘ç”¨ï¼‰ |
| `thread_id` | åŒºåˆ†ä¸åŒä¼šè¯/ç”¨æˆ· |

**HITL ä¸‰å¤§æ¨¡å¼ï¼š**

| æ¨¡å¼ | è¯´æ˜ | å®ç° |
|------|------|------|
| å®¡æ‰¹ (Approve) | ç”¨æˆ·ç¡®è®¤åæ‰æ‰§è¡Œ | `interrupt()` â†’ ç”¨æˆ·è¾“å…¥ â†’ `Command(resume=)` |
| ç¼–è¾‘ (Edit) | ç”¨æˆ·ä¿®æ”¹ AI ç»“æœ | `interrupt()` â†’ ç”¨æˆ·ä¿®æ”¹ â†’ `Command(update={...})` |
| è¾“å…¥ (Input) | æ”¶é›†ç”¨æˆ·ä¿¡æ¯ | `while True: interrupt()` å¾ªç¯éªŒè¯ |

---

## ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

### 1. ä½¿ç”¨æŒä¹…åŒ– Checkpointer

å¼€å‘æ—¶ä½¿ç”¨ `InMemorySaver`ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼š

```python
# å¼€å‘ç¯å¢ƒ
from langgraph.checkpoint.memory import InMemorySaver
memory = InMemorySaver()

# ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨è PostgreSQLï¼‰
from langgraph.checkpoint.postgres.aio import AsyncPostgresSaver

async with AsyncPostgresSaver.from_conn_string(
    "postgresql://user:pass@localhost/db"
) as checkpointer:
    graph = builder.compile(checkpointer=checkpointer)
```

### 2. é¿å…å¸¸è§é”™è¯¯

```python
# é”™è¯¯ï¼šä¸è¦ç”¨ try-except åŒ…è£¹ interrupt
def bad_node(state):
    try:
        result = interrupt("prompt")  # interrupt ä½¿ç”¨å¼‚å¸¸æœºåˆ¶ï¼
    except:
        pass  # è¿™ä¼šåæ‰ interrupt å¼‚å¸¸

# æ­£ç¡®ï¼šç›´æ¥è°ƒç”¨
def good_node(state):
    result = interrupt("prompt")
    return {"data": result}

# é”™è¯¯ï¼šinterrupt å‰çš„å‰¯ä½œç”¨ä¸æ˜¯å¹‚ç­‰çš„
def bad_side_effect(state):
    send_notification("å¼€å§‹å¤„ç†")  # æ¢å¤æ—¶ä¼šé‡å¤å‘é€ï¼
    result = interrupt("confirm?")
    return {"result": result}

# æ­£ç¡®ï¼šç¡®ä¿å‰¯ä½œç”¨å¹‚ç­‰æˆ–æ”¾åœ¨ interrupt ä¹‹å
def good_side_effect(state):
    result = interrupt("confirm?")
    send_notification("å¤„ç†å®Œæˆ")  # åœ¨ interrupt ä¹‹å
    return {"result": result}
```

### 3. interrupt çš„ payload å¿…é¡»å¯ JSON åºåˆ—åŒ–

```python
# é”™è¯¯ï¼šä¼ é€’å‡½æ•°æˆ–å¤æ‚å¯¹è±¡
result = interrupt(lambda x: x)  # å‡½æ•°ä¸èƒ½ JSON åºåˆ—åŒ–

# æ­£ç¡®ï¼šä½¿ç”¨å­—å…¸ã€åˆ—è¡¨ã€å­—ç¬¦ä¸²ç­‰åŸºæœ¬ç±»å‹
result = interrupt({
    "type": "approval",
    "message": "è¯·ç¡®è®¤",
    "options": ["yes", "no"]
})
```

---

## å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
- [LangGraph Interrupts å®˜æ–¹æ–‡æ¡£](https://docs.langchain.com/oss/python/langgraph/interrupts)
- [How to wait for user input using interrupt](https://langchain-ai.github.io/langgraph/how-tos/human_in_the_loop/wait-user-input/)
- [LangChain åšå®¢ï¼šMaking it easier to build human-in-the-loop agents with interrupt](https://blog.langchain.com/making-it-easier-to-build-human-in-the-loop-agents-with-interrupt/)

### æ•™ç¨‹ä¸æŒ‡å—
- [Human-in-the-Loop (HITL) with LangGraph: A Practical Guide | Towards AI](https://towardsai.net/p/l/human-in-the-loop-hitl-with-langgraph-a-practical-guide-to-interactive-agentic-workflows)
- [Human-in-the-Loop with LangGraph: A Beginner's Guide | Medium](https://sangeethasaravanan.medium.com/human-in-the-loop-with-langgraph-a-beginners-guide-8a32b7f45d6e)
- [LangGraph Human-in-the-loop (HITL) Deployment with FastAPI | Medium](https://shaveen12.medium.com/langgraph-human-in-the-loop-hitl-deployment-with-fastapi-be4a9efcd8c0)
- [Interrupts and Commands in LangGraph | DEV Community](https://dev.to/jamesbmour/interrupts-and-commands-in-langgraph-building-human-in-the-loop-workflows-4ngl)
- [IBM Tutorial: Human in the loop](https://www.ibm.com/think/tutorials/human-in-the-loop-ai-agent-langraph-watsonx-ai)

### ä¸­æ–‡èµ„æº
- [Human-in-the-Loop (HITL) æ·±å…¥ç†è§£ | ä¸¥å¯Œå¤çŸ¥è¯†åº“](https://www.yanfukun.com/read/langgraph/HITL)
- [LangGraph ä¸­æ–‡æ–‡æ¡£ | GitHub](https://github.com/jurnea/LangGraph-Chinese)
- [LangGraph ä¸­æ–‡å®˜ç½‘](https://langgraph.org.cn/)

### è®¾è®¡æ¨¡å¼
- [LangGraph HITL Design Patterns: Approve and Reject | Medium](https://medium.com/fundamentals-of-artificial-intellegence/human-in-the-loop-design-patterns-approve-and-reject-with-langgraph-0e49b6fb8eba)
- [Human-in-the-Loop Agent Using Interrupt and Command | Medium](https://medium.com/fundamentals-of-artificial-intellegence/human-in-the-loop-agent-with-langgraph-436e361780ff)

---

## å°ç»“

| æ¦‚å¿µ | ä¸€å¥è¯æ€»ç»“ |
|-----|-----------|
| **HITL** | è®©äººç±»å‚ä¸ AI å†³ç­–çš„æœºåˆ¶ |
| **interrupt()** | LangGraph 1.0 çš„"æš‚åœé”®"ï¼Œéšæ—¶æš‚åœç­‰å¾…è¾“å…¥ |
| **Command(resume=)** | æ¢å¤æ‰§è¡Œå¹¶ä¼ å…¥äººç±»è¾“å…¥çš„"é¥æ§å™¨" |
| **Checkpointer** | ä¿å­˜æ‰§è¡Œè¿›åº¦çš„"å­˜æ¡£å™¨"ï¼Œå¿…é¡»é…ç½® |
| **thread_id** | åŒºåˆ†ä¸åŒä¼šè¯çš„å”¯ä¸€æ ‡è¯† |

**æ ¸å¿ƒå¿ƒæ™ºæ¨¡å‹**ï¼šæŠŠ `interrupt()` æƒ³è±¡æˆæ¸¸æˆä¸­çš„æš‚åœé”®ï¼Œ`Command(resume=)` æ˜¯ç»§ç»­é”®ï¼Œ`Checkpointer` æ˜¯è‡ªåŠ¨å­˜æ¡£åŠŸèƒ½ã€‚æœ‰äº†è¿™ä¸‰ä¸ªï¼Œä½ çš„ AI Agent å°±å¯ä»¥åœ¨ä»»ä½•æ—¶å€™æš‚åœã€ç­‰å¾…äººç±»æŒ‡ç¤ºã€ç„¶åç»§ç»­æ‰§è¡Œäº†ï¼
