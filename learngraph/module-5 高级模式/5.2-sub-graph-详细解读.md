# LangGraph å­å›¾ï¼ˆSub-graphï¼‰è¯¦ç»†è§£è¯»

## ğŸ“‹ æ¡ˆä¾‹æ¦‚è§ˆ

è¿™ä¸ªæ¡ˆä¾‹å±•ç¤ºäº† LangGraph ä¸­**å­å›¾ï¼ˆSub-graphï¼‰**çš„æ ¸å¿ƒæ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ã€‚è™½ç„¶ä»£ç ç›¸å¯¹ç®€å•ï¼Œä½†å®ƒæ­ç¤ºäº†ä¸€ä¸ªéå¸¸é‡è¦çš„æ¶æ„æ¨¡å¼ï¼š**å¦‚ä½•åœ¨å¤æ‚ç³»ç»Ÿä¸­ç®¡ç†ä¸åŒçš„çŠ¶æ€ç©ºé—´**ã€‚

### ä¸šåŠ¡åœºæ™¯

æƒ³è±¡ä½ åœ¨è¿è¥ä¸€ä¸ªé—®ç­”ç³»ç»Ÿï¼Œéœ€è¦å®šæœŸåˆ†æç”¨æˆ·æ—¥å¿—ï¼š

1. **æ—¥å¿—æ¸…æ´—**ï¼šåŸå§‹æ—¥å¿—éœ€è¦é¢„å¤„ç†
2. **å¤±è´¥åˆ†æ**ï¼šæ‰¾å‡ºå›ç­”è´¨é‡å·®çš„è®°å½•ï¼Œç”Ÿæˆæ”¹è¿›æŠ¥å‘Š
3. **é—®é¢˜æ€»ç»“**ï¼šåˆ†æç”¨æˆ·æœ€å…³å¿ƒçš„ä¸»é¢˜ï¼Œå‘é€åˆ° Slack é€šçŸ¥å›¢é˜Ÿ

### æ ¸å¿ƒæŒ‘æˆ˜

è¿™ä¸¤ä¸ªåˆ†æä»»åŠ¡ï¼ˆå¤±è´¥åˆ†æ & é—®é¢˜æ€»ç»“ï¼‰éœ€è¦ï¼š
- **å¹¶è¡Œæ‰§è¡Œ**ä»¥æé«˜æ•ˆç‡
- **ç‹¬ç«‹çš„çŠ¶æ€ç©ºé—´**ï¼ˆå„è‡ªæœ‰ä¸åŒçš„ä¸­é—´å˜é‡ï¼‰
- **å…±äº«è¾“å…¥æ•°æ®**ï¼ˆéƒ½éœ€è¦è®¿é—®æ¸…æ´—åçš„æ—¥å¿—ï¼‰
- **æ±‡æ€»è¾“å‡ºç»“æœ**åˆ°ä¸»å›¾

**å­å›¾æ­£æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„æœ€ä½³æ–¹æ¡ˆï¼**

![Sub-graph Architecture](https://cdn.prod.website-files.com/65b8cd72835ceeacd4449a53/66dbb1abf89f2d847ee6f1ff_sub-graph1.png)

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **Sub-graphï¼ˆå­å›¾ï¼‰** | ç‹¬ç«‹çš„ StateGraph å®ä¾‹ï¼Œå¯ç¼–è¯‘åä½œä¸ºèŠ‚ç‚¹åµŒå…¥ä¸»å›¾ | æ¨¡å—åŒ–è®¾è®¡æ¨¡å¼ï¼Œå°è£…ç‰¹å®šä¸šåŠ¡é€»è¾‘ï¼Œæœ‰ç‹¬ç«‹çš„çŠ¶æ€ç©ºé—´ | â­â­â­â­â­ |
| **state_schema** | å­å›¾å†…éƒ¨ä½¿ç”¨çš„å®Œæ•´çŠ¶æ€å®šä¹‰ï¼ŒåŒ…å«æ‰€æœ‰ä¸­é—´å˜é‡ | ä¼ é€’ç»™ `StateGraph()` çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå®šä¹‰å­å›¾çš„å·¥ä½œç©ºé—´ | â­â­â­â­â­ |
| **output_schema** | å­å›¾è¿”å›ç»™ä¸»å›¾çš„è¾“å‡ºçŠ¶æ€ï¼Œé€šå¸¸æ˜¯ state_schema çš„å­é›† | `StateGraph(state_schema, output_schema=...)`ï¼Œæ§åˆ¶è¾“å‡ºå­—æ®µ | â­â­â­â­â­ |
| **çŠ¶æ€éš”ç¦»** | å­å›¾çš„ä¸­é—´å˜é‡ä¸ä¼šæ±¡æŸ“ä¸»å›¾çŠ¶æ€çš„æœºåˆ¶ | é€šè¿‡ output_schema å®ç°ï¼Œåªè¿”å›å¿…è¦å­—æ®µç»™ä¸»å›¾ | â­â­â­â­â­ |
| **åŒåå­—æ®µé€šä¿¡** | ä¸»å›¾å’Œå­å›¾é€šè¿‡åŒåå­—æ®µä¼ é€’æ•°æ®çš„æœºåˆ¶ | ä¸»å›¾çŠ¶æ€ä¸­çš„å­—æ®µä¼šè‡ªåŠ¨ä¼ é€’ç»™å­å›¾çš„åŒåå­—æ®µ | â­â­â­â­ |
| **Reducerï¼ˆåˆå¹¶å™¨ï¼‰** | å¤„ç†å¹¶è¡Œå­å›¾è¿”å›åŒåå­—æ®µçš„åˆå¹¶é€»è¾‘å‡½æ•° | ä½¿ç”¨ `Annotated[ç±»å‹, reducer]` æŒ‡å®šï¼Œå¦‚ `operator.add` | â­â­â­â­ |
| **TypedDict** | å®šä¹‰çŠ¶æ€ç»“æ„çš„ Python ç±»å‹å·¥å…· | `from typing_extensions import TypedDict`ï¼Œæä¾›ç±»å‹å®‰å…¨ | â­â­â­â­ |
| **Optional[ç±»å‹]** | è¡¨ç¤ºå­—æ®µå¯ä»¥æ˜¯æŒ‡å®šç±»å‹æˆ– None çš„ç±»å‹æ³¨è§£ | `from typing import Optional`ï¼Œç­‰ä»·äº `ç±»å‹ | None` (Python 3.10+) | â­â­â­ |
| **åˆ—è¡¨æ¨å¯¼å¼** | ç®€æ´åˆ›å»ºåˆ—è¡¨çš„ Python è¯­æ³• | `[è¡¨è¾¾å¼ for é¡¹ in å¯è¿­ä»£å¯¹è±¡ if æ¡ä»¶]` | â­â­â­ |
| **f-string** | Python 3.6+ çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²è¯­æ³• | `f"æ–‡æœ¬ {å˜é‡} æ›´å¤šæ–‡æœ¬"`ï¼Œæ”¯æŒè¡¨è¾¾å¼å’Œæ ¼å¼æ§åˆ¶ | â­â­â­ |

---

## ğŸ—ºï¸ æ•´ä½“æ¶æ„å›¾

```
ç”¨æˆ·è¾“å…¥åŸå§‹æ—¥å¿—ï¼ˆraw_logsï¼‰
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚clean_logsâ”‚  æ¸…æ´—æ—¥å¿—
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ cleaned_logsï¼ˆå…±äº«æ•°æ®ï¼‰
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â†“         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚å¤±è´¥åˆ†æâ”‚  â”‚é—®é¢˜æ€»ç»“â”‚  ï¼ˆä¸¤ä¸ªç‹¬ç«‹å­å›¾å¹¶è¡Œè¿è¡Œï¼‰
â”‚å­å›¾   â”‚  â”‚å­å›¾   â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
    â†“         â†“
fa_summary  report
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â†“
     æœ€ç»ˆç»“æœæ±‡æ€»
```

---

## ğŸ“š ä»£ç åˆ†æ®µè¯¦è§£

### ç¬¬ä¸€éƒ¨åˆ†ï¼šå®šä¹‰æ•°æ®ç»“æ„

#### Log æ•°æ®æ¨¡å‹

```python
from typing_extensions import TypedDict
from typing import List, Optional

class Log(TypedDict):
    id: str              # æ—¥å¿— ID
    question: str        # ç”¨æˆ·é—®é¢˜
    docs: Optional[List] # æ£€ç´¢åˆ°çš„æ–‡æ¡£ï¼ˆå¯é€‰ï¼‰
    answer: str          # ç³»ç»Ÿå›ç­”
    grade: Optional[int] # è´¨é‡è¯„åˆ†ï¼ˆå¯é€‰ï¼‰
    grader: Optional[str]# è¯„åˆ†å™¨åç§°ï¼ˆå¯é€‰ï¼‰
    feedback: Optional[str] # åé¦ˆä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **TypedDict**ï¼šè¿™æ˜¯ Python 3.8+ å¼•å…¥çš„ç±»å‹ï¼Œç”¨äºå®šä¹‰å­—å…¸çš„ç»“æ„
   ```python
   # æ™®é€šå­—å…¸ - ä¸çŸ¥é“æœ‰å“ªäº›é”®
   log1 = {"id": "1", "question": "xxx"}

   # TypedDict - æ˜ç¡®å®šä¹‰äº†é”®å’Œç±»å‹
   log2: Log = {"id": "1", "question": "xxx", ...}
   ```

2. **Optional[ç±»å‹]**ï¼šè¡¨ç¤ºè¿™ä¸ªå­—æ®µå¯ä»¥æ˜¯æŒ‡å®šç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯ `None`
   ```python
   grade: Optional[int]  # ç­‰ä»·äº grade: int | None
   ```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**
- å¹¶éæ‰€æœ‰æ—¥å¿—éƒ½æœ‰è¯„åˆ†ï¼ˆgradeï¼‰ï¼Œåªæœ‰è¢«è¯„ä¼°è¿‡çš„æ‰æœ‰
- è¿™ç§çµæ´»çš„æ•°æ®ç»“æ„é€‚é…å®é™…ä¸šåŠ¡åœºæ™¯

---

### ç¬¬äºŒéƒ¨åˆ†ï¼šå¤±è´¥åˆ†æå­å›¾

#### çŠ¶æ€å®šä¹‰

```python
# å­å›¾å†…éƒ¨çŠ¶æ€ï¼ˆå®Œæ•´çŠ¶æ€ï¼‰
class FailureAnalysisState(TypedDict):
    cleaned_logs: List[Log]   # è¾“å…¥ï¼šæ¸…æ´—åçš„æ—¥å¿—
    failures: List[Log]       # ä¸­é—´å˜é‡ï¼šå¤±è´¥çš„æ—¥å¿—
    fa_summary: str           # è¾“å‡ºï¼šå¤±è´¥åˆ†ææ‘˜è¦
    processed_logs: List[str] # è¾“å‡ºï¼šå¤„ç†è¿‡çš„æ—¥å¿— ID

# å­å›¾è¾“å‡ºçŠ¶æ€ï¼ˆåªåŒ…å«éœ€è¦è¿”å›ç»™ä¸»å›¾çš„å­—æ®µï¼‰
class FailureAnalysisOutputState(TypedDict):
    fa_summary: str           # åªè¾“å‡ºæ‘˜è¦
    processed_logs: List[str] # åªè¾“å‡ºå¤„ç†è®°å½•
```

**å…³é”®æ¦‚å¿µ**ï¼šä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªçŠ¶æ€ï¼Ÿ

1. **å†…éƒ¨çŠ¶æ€ï¼ˆFailureAnalysisStateï¼‰**ï¼š
   - åŒ…å«æ‰€æœ‰ä¸­é—´å˜é‡ï¼ˆå¦‚ `failures`ï¼‰
   - ç”¨äºå­å›¾å†…éƒ¨èŠ‚ç‚¹ä¹‹é—´ä¼ é€’æ•°æ®

2. **è¾“å‡ºçŠ¶æ€ï¼ˆFailureAnalysisOutputStateï¼‰**ï¼š
   - åªåŒ…å«éœ€è¦è¿”å›ç»™ä¸»å›¾çš„å­—æ®µ
   - é¿å…ä¸å¿…è¦çš„æ•°æ®ä¼ é€’
   - å‡å°‘çŠ¶æ€å†²çªçš„å¯èƒ½æ€§

**ç±»æ¯”**ï¼š
- å†…éƒ¨çŠ¶æ€ = å¨æˆ¿é‡Œçš„æ‰€æœ‰å·¥å…·å’ŒåŸæ–™
- è¾“å‡ºçŠ¶æ€ = ç«¯ç»™å®¢äººçš„æˆå“èœè‚´

---

#### èŠ‚ç‚¹å‡½æ•°

**1. get_failures - è¿‡æ»¤å¤±è´¥æ—¥å¿—**

```python
def get_failures(state):
    """ è·å–åŒ…å«å¤±è´¥è®°å½•çš„æ—¥å¿— """
    cleaned_logs = state["cleaned_logs"]

    # ç­›é€‰å‡ºæœ‰ grade å­—æ®µçš„æ—¥å¿—ï¼ˆè¡¨ç¤ºè¢«è¯„åˆ†è¿‡ï¼‰
    failures = [log for log in cleaned_logs if "grade" in log]

    return {"failures": failures}
```

**Python çŸ¥è¯†ç‚¹ - åˆ—è¡¨æ¨å¯¼å¼**ï¼š
```python
# ä¼ ç»Ÿå†™æ³•
failures = []
for log in cleaned_logs:
    if "grade" in log:
        failures.append(log)

# åˆ—è¡¨æ¨å¯¼å¼ï¼ˆæ›´ç®€æ´ï¼‰
failures = [log for log in cleaned_logs if "grade" in log]
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
- åªæœ‰è¢«è¯„ä¼°è¿‡çš„æ—¥å¿—æ‰æœ‰ `grade` å­—æ®µ
- è¿™äº›æ—¥å¿—é€šå¸¸æ˜¯å› ä¸ºè´¨é‡é—®é¢˜éœ€è¦äººå·¥å®¡æ ¸çš„

---

**2. generate_summary - ç”Ÿæˆæ‘˜è¦**

```python
def generate_summary(state):
    """ ç”Ÿæˆå¤±è´¥åˆ†ææ‘˜è¦ """
    failures = state["failures"]

    # å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨ LLM åˆ†æå¤±è´¥åŸå› 
    # fa_summary = summarize_with_llm(failures)
    fa_summary = "Poor quality retrieval of Chroma documentation."

    # è®°å½•å¤„ç†è¿‡çš„æ—¥å¿— ID
    processed_logs = [
        f"failure-analysis-on-log-{failure['id']}"
        for failure in failures
    ]

    return {
        "fa_summary": fa_summary,
        "processed_logs": processed_logs
    }
```

**æŠ€æœ¯ç»†èŠ‚**ï¼š

1. **f-string æ ¼å¼åŒ–å­—ç¬¦ä¸²**ï¼ˆPython 3.6+ï¼‰ï¼š
   ```python
   failure_id = "123"

   # ä¼ ç»Ÿæ–¹å¼
   msg = "failure-analysis-on-log-" + failure_id

   # f-stringï¼ˆæ›´ç›´è§‚ï¼‰
   msg = f"failure-analysis-on-log-{failure_id}"
   ```

2. **processed_logs çš„ä½œç”¨**ï¼š
   - è¿½è¸ªå“ªäº›æ—¥å¿—è¢«å¤„ç†è¿‡
   - ç”¨äºå®¡è®¡å’Œè°ƒè¯•
   - ä¸»å›¾ä¼šæ”¶é›†æ‰€æœ‰å­å›¾çš„å¤„ç†è®°å½•

---

#### æ„å»ºå­å›¾

```python
from langgraph.graph import StateGraph, START, END

fa_builder = StateGraph(
    state_schema=FailureAnalysisState,        # å†…éƒ¨çŠ¶æ€
    output_schema=FailureAnalysisOutputState  # è¾“å‡ºçŠ¶æ€
)

# æ·»åŠ èŠ‚ç‚¹
fa_builder.add_node("get_failures", get_failures)
fa_builder.add_node("generate_summary", generate_summary)

# æ·»åŠ è¾¹ï¼ˆå®šä¹‰æ‰§è¡Œé¡ºåºï¼‰
fa_builder.add_edge(START, "get_failures")
fa_builder.add_edge("get_failures", "generate_summary")
fa_builder.add_edge("generate_summary", END)
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
START â†’ get_failures â†’ generate_summary â†’ END
```

**LangGraph æ¦‚å¿µ**ï¼š
- `START`ï¼šç‰¹æ®ŠèŠ‚ç‚¹ï¼Œè¡¨ç¤ºå›¾çš„å…¥å£
- `END`ï¼šç‰¹æ®ŠèŠ‚ç‚¹ï¼Œè¡¨ç¤ºå›¾çš„å‡ºå£
- `add_edge(A, B)`ï¼šä»èŠ‚ç‚¹ A åˆ°èŠ‚ç‚¹ B çš„æœ‰å‘è¾¹

---

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šé—®é¢˜æ€»ç»“å­å›¾

#### çŠ¶æ€å®šä¹‰

```python
# å†…éƒ¨çŠ¶æ€
class QuestionSummarizationState(TypedDict):
    cleaned_logs: List[Log]   # è¾“å…¥
    qs_summary: str           # ä¸­é—´å˜é‡ï¼šé—®é¢˜æ‘˜è¦
    report: str               # è¾“å‡ºï¼šæœ€ç»ˆæŠ¥å‘Š
    processed_logs: List[str] # è¾“å‡ºï¼šå¤„ç†è®°å½•

# è¾“å‡ºçŠ¶æ€
class QuestionSummarizationOutputState(TypedDict):
    report: str               # åªè¾“å‡ºæŠ¥å‘Š
    processed_logs: List[str] # åªè¾“å‡ºå¤„ç†è®°å½•
```

**æ³¨æ„**ï¼š`qs_summary` æ˜¯ä¸­é—´å˜é‡ï¼Œä¸éœ€è¦è¿”å›ç»™ä¸»å›¾

---

#### èŠ‚ç‚¹å‡½æ•°

**1. generate_summary - ç”Ÿæˆé—®é¢˜æ‘˜è¦**

```python
def generate_summary(state):
    cleaned_logs = state["cleaned_logs"]

    # å®é™…ä¼šè°ƒç”¨ LLM åˆ†æç”¨æˆ·é—®é¢˜çš„ä¸»é¢˜
    summary = "Questions focused on usage of ChatOllama and Chroma vector store."

    # è®°å½•å¤„ç†çš„æ—¥å¿—
    processed_logs = [
        f"summary-on-log-{log['id']}"
        for log in cleaned_logs
    ]

    return {
        "qs_summary": summary,
        "processed_logs": processed_logs
    }
```

---

**2. send_to_slack - å‘é€æŠ¥å‘Š**

```python
def send_to_slack(state):
    qs_summary = state["qs_summary"]

    # å®é™…ä¼šåŸºäºæ‘˜è¦ç”Ÿæˆå®Œæ•´æŠ¥å‘Šå¹¶å‘é€åˆ° Slack
    # report = generate_report(qs_summary)
    # send_to_slack_api(report)
    report = "foo bar baz"

    return {"report": report}
```

**ä¸šåŠ¡æµç¨‹**ï¼š
```
æ¸…æ´—æ—¥å¿— â†’ ç”Ÿæˆæ‘˜è¦ â†’ æ ¼å¼åŒ–æŠ¥å‘Š â†’ å‘é€åˆ° Slack
```

---

#### æ„å»ºå­å›¾

```python
qs_builder = StateGraph(
    QuestionSummarizationState,
    output_schema=QuestionSummarizationOutputState
)

qs_builder.add_node("generate_summary", generate_summary)
qs_builder.add_node("send_to_slack", send_to_slack)

qs_builder.add_edge(START, "generate_summary")
qs_builder.add_edge("generate_summary", "send_to_slack")
qs_builder.add_edge("send_to_slack", END)
```

---

### ç¬¬å››éƒ¨åˆ†ï¼šä¸»å›¾ - æ•´åˆå­å›¾

#### ä¸»å›¾çŠ¶æ€

```python
from operator import add
from typing import Annotated

class EntryGraphState(TypedDict):
    raw_logs: List[Log]                      # è¾“å…¥ï¼šåŸå§‹æ—¥å¿—
    cleaned_logs: List[Log]                  # æ¸…æ´—åçš„æ—¥å¿—
    fa_summary: str                          # æ¥è‡ªå¤±è´¥åˆ†æå­å›¾
    report: str                              # æ¥è‡ªé—®é¢˜æ€»ç»“å­å›¾
    processed_logs: Annotated[List[int], add] # æ¥è‡ªä¸¤ä¸ªå­å›¾ï¼Œéœ€è¦åˆå¹¶
```

**æ ¸å¿ƒæŠ€æœ¯ç‚¹ - Annotated å’Œ Reducer**ï¼š

```python
processed_logs: Annotated[List[int], add]
```

è¿™è¡Œä»£ç åŒ…å«äº†ä¸‰ä¸ªé‡è¦æ¦‚å¿µï¼š

1. **Annotated**ï¼šPython 3.9+ çš„ç±»å‹æ³¨è§£å¢å¼ºå·¥å…·
   ```python
   from typing import Annotated

   # åŸºæœ¬ç±»å‹æ³¨è§£
   name: str

   # å¸¦é¢å¤–å…ƒæ•°æ®çš„æ³¨è§£
   age: Annotated[int, "must be positive"]
   ```

2. **Reducerï¼ˆåˆå¹¶å™¨ï¼‰**ï¼š`add` æ¥è‡ª `operator` æ¨¡å—
   ```python
   from operator import add

   # add çš„ä½œç”¨æ˜¯åˆå¹¶åˆ—è¡¨
   result = add([1, 2], [3, 4])  # ç»“æœï¼š[1, 2, 3, 4]
   ```

3. **ä¸ºä»€ä¹ˆéœ€è¦ Reducerï¼Ÿ**

   å› ä¸ºä¸¤ä¸ªå­å›¾**å¹¶è¡Œè¿è¡Œ**ï¼Œéƒ½ä¼šè¿”å› `processed_logs`ï¼š

   ```python
   # å¤±è´¥åˆ†æå­å›¾è¿”å›
   {"processed_logs": ["failure-analysis-on-log-2"]}

   # é—®é¢˜æ€»ç»“å­å›¾è¿”å›
   {"processed_logs": ["summary-on-log-1", "summary-on-log-2"]}

   # LangGraph éœ€è¦çŸ¥é“å¦‚ä½•åˆå¹¶è¿™ä¸¤ä¸ªç»“æœ
   # ä½¿ç”¨ add åï¼š
   {"processed_logs": [
       "failure-analysis-on-log-2",
       "summary-on-log-1",
       "summary-on-log-2"
   ]}
   ```

**å¸¸è§çš„ Reducer**ï¼š
```python
from operator import add

# åˆ—è¡¨åˆå¹¶
Annotated[List[str], add]  # [1, 2] + [3] = [1, 2, 3]

# è‡ªå®šä¹‰ Reducer
def merge_dicts(a, b):
    return {**a, **b}

Annotated[dict, merge_dicts]
```

---

#### ä¸ºä»€ä¹ˆ cleaned_logs ä¸éœ€è¦ Reducerï¼Ÿ

**é—®é¢˜**ï¼š`cleaned_logs` ä¹Ÿä¼šè¢«ä¸¤ä¸ªå­å›¾è®¿é—®ï¼Œä¸ºä»€ä¹ˆä¸éœ€è¦ `Annotated`ï¼Ÿ

**ç­”æ¡ˆ**ï¼šå› ä¸ºæˆ‘ä»¬å®šä¹‰äº† `output_schema`ï¼

```python
# å¤±è´¥åˆ†æå­å›¾çš„è¾“å‡ºçŠ¶æ€ï¼ˆä¸åŒ…å« cleaned_logsï¼‰
class FailureAnalysisOutputState(TypedDict):
    fa_summary: str
    processed_logs: List[str]
    # æ³¨æ„ï¼šæ²¡æœ‰ cleaned_logs

# é—®é¢˜æ€»ç»“å­å›¾çš„è¾“å‡ºçŠ¶æ€ï¼ˆä¹Ÿä¸åŒ…å« cleaned_logsï¼‰
class QuestionSummarizationOutputState(TypedDict):
    report: str
    processed_logs: List[str]
    # æ³¨æ„ï¼šä¹Ÿæ²¡æœ‰ cleaned_logs
```

**æœºåˆ¶è§£é‡Š**ï¼š

1. **æ²¡æœ‰ output_schema æ—¶**ï¼š
   ```python
   StateGraph(MyState)  # æ‰€æœ‰çŠ¶æ€å­—æ®µéƒ½ä¼šè¾“å‡º
   ```
   - å­å›¾ä¼šè¿”å›æ‰€æœ‰çŠ¶æ€å­—æ®µ
   - `cleaned_logs` ä¼šè¢«ä¸¤ä¸ªå­å›¾éƒ½è¿”å›
   - éœ€è¦ Reducer æ¥åˆå¹¶

2. **æœ‰ output_schema æ—¶**ï¼š
   ```python
   StateGraph(MyState, output_schema=MyOutputState)
   ```
   - å­å›¾åªè¿”å› `MyOutputState` ä¸­å®šä¹‰çš„å­—æ®µ
   - `cleaned_logs` ä¸åœ¨è¾“å‡ºçŠ¶æ€ä¸­ï¼Œä¸ä¼šè¿”å›
   - ä¸éœ€è¦ Reducer

**ç±»æ¯”**ï¼š
- æ²¡æœ‰ output_schema = å‡½æ•°è¿”å›æ‰€æœ‰å±€éƒ¨å˜é‡
- æœ‰ output_schema = å‡½æ•°åªè¿”å›ä½ æŒ‡å®šçš„å€¼

---

#### ä¸»å›¾èŠ‚ç‚¹å’Œæ„å»º

**clean_logs èŠ‚ç‚¹**ï¼š

```python
def clean_logs(state):
    """ æ¸…æ´—æ—¥å¿— """
    raw_logs = state["raw_logs"]

    # å®é™…åº”ç”¨ä¸­ä¼šè¿›è¡Œæ•°æ®æ¸…æ´—ï¼š
    # - å»é‡
    # - æ ¼å¼æ ‡å‡†åŒ–
    # - è¿‡æ»¤æ— æ•ˆæ•°æ®
    cleaned_logs = raw_logs  # ç®€åŒ–ç¤ºä¾‹

    return {"cleaned_logs": cleaned_logs}
```

---

**æ„å»ºä¸»å›¾**ï¼š

```python
entry_builder = StateGraph(EntryGraphState)

# æ·»åŠ å¸¸è§„èŠ‚ç‚¹
entry_builder.add_node("clean_logs", clean_logs)

# å…³é”®ï¼šå°†ç¼–è¯‘åçš„å­å›¾ä½œä¸ºèŠ‚ç‚¹æ·»åŠ 
entry_builder.add_node(
    "question_summarization",
    qs_builder.compile()  # ç¼–è¯‘å­å›¾
)

entry_builder.add_node(
    "failure_analysis",
    fa_builder.compile()  # ç¼–è¯‘å­å›¾
)

# å®šä¹‰æ‰§è¡Œæµç¨‹
entry_builder.add_edge(START, "clean_logs")
entry_builder.add_edge("clean_logs", "failure_analysis")
entry_builder.add_edge("clean_logs", "question_summarization")
entry_builder.add_edge("failure_analysis", END)
entry_builder.add_edge("question_summarization", END)

# ç¼–è¯‘ä¸»å›¾
graph = entry_builder.compile()
```

**ç”Ÿæˆçš„æµç¨‹å›¾ï¼š**

![Flow Diagram](images/sub-graph-output-7-0.png)


**å…³é”®ç‚¹**ï¼š

1. **å­å›¾ä¹Ÿæ˜¯èŠ‚ç‚¹**ï¼š
   ```python
   entry_builder.add_node("å­å›¾åç§°", å­å›¾å®ä¾‹.compile())
   ```

2. **å¹¶è¡Œæ‰§è¡Œ**ï¼š
   ```python
   entry_builder.add_edge("clean_logs", "failure_analysis")
   entry_builder.add_edge("clean_logs", "question_summarization")
   ```
   ä» `clean_logs` å‡ºå‘æœ‰ä¸¤æ¡è¾¹ï¼Œä¸¤ä¸ªå­å›¾ä¼šå¹¶è¡Œè¿è¡Œ

3. **xray å‚æ•°**ï¼š
   ```python
   graph.get_graph(xray=1).draw_mermaid_png()
   ```
   `xray=1` ä¼šå±•å¼€å­å›¾çš„å†…éƒ¨ç»“æ„ï¼Œæ–¹ä¾¿è°ƒè¯•

---

### ç¬¬äº”éƒ¨åˆ†ï¼šè¿è¡Œç¤ºä¾‹

#### å‡†å¤‡æµ‹è¯•æ•°æ®

```python
# æ­£å¸¸çš„é—®ç­”æ—¥å¿—
question_answer = Log(
    id="1",
    question="How can I import ChatOllama?",
    answer="To import ChatOllama, use: 'from langchain_community.chat_models import ChatOllama.'",
    # æ²¡æœ‰ grade å­—æ®µï¼Œè¡¨ç¤ºè´¨é‡æ­£å¸¸
)

# æœ‰è´¨é‡é—®é¢˜çš„æ—¥å¿—
question_answer_feedback = Log(
    id="2",
    question="How can I use Chroma vector store?",
    answer="To use Chroma, define: rag_chain = create_retrieval_chain(retriever, question_answer_chain).",
    grade=0,  # è¯„åˆ†ä¸º 0ï¼Œè¡¨ç¤ºè´¨é‡å·®
    grader="Document Relevance Recall",
    feedback="The retrieved documents discuss vector stores in general, but not Chroma specifically",
)

raw_logs = [question_answer, question_answer_feedback]
```

---

#### æ‰§è¡Œå›¾

```python
result = graph.invoke({"raw_logs": raw_logs})
```

**è¾“å‡ºç»“æœ**ï¼š
```python
{
    'raw_logs': [...],  # åŸå§‹è¾“å…¥

    'cleaned_logs': [...],  # clean_logs èŠ‚ç‚¹çš„è¾“å‡º

    'fa_summary': 'Poor quality retrieval of Chroma documentation.',
    # â†‘ æ¥è‡ªå¤±è´¥åˆ†æå­å›¾

    'report': 'foo bar baz',
    # â†‘ æ¥è‡ªé—®é¢˜æ€»ç»“å­å›¾

    'processed_logs': [
        'failure-analysis-on-log-2',   # å¤±è´¥åˆ†æå¤„ç†äº† log-2
        'summary-on-log-1',            # é—®é¢˜æ€»ç»“å¤„ç†äº† log-1
        'summary-on-log-2'             # é—®é¢˜æ€»ç»“å¤„ç†äº† log-2
    ]
    # â†‘ ä¸¤ä¸ªå­å›¾çš„ processed_logs é€šè¿‡ add åˆå¹¶
}
```

---

## ğŸ”‘ æ ¸å¿ƒæŠ€æœ¯è§£æ

### 1. å­å›¾çš„æœ¬è´¨

**å­å›¾æ˜¯ä»€ä¹ˆï¼Ÿ**
- å­å›¾æœ¬èº«å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„ StateGraph
- å¯ä»¥ç‹¬ç«‹è¿è¡Œå’Œæµ‹è¯•
- é€šè¿‡ `compile()` ç¼–è¯‘åï¼Œå¯ä»¥ä½œä¸ºèŠ‚ç‚¹åµŒå…¥å…¶ä»–å›¾

**ç±»æ¯”**ï¼š
- ä¸»å›¾ = ä¸€ä¸ªå…¬å¸
- å­å›¾ = å…¬å¸å†…çš„éƒ¨é—¨
- æ¯ä¸ªéƒ¨é—¨æœ‰è‡ªå·±çš„å·¥ä½œæµç¨‹ï¼ˆå†…éƒ¨çŠ¶æ€ï¼‰
- éƒ¨é—¨åªå‘å…¬å¸æ±‡æŠ¥å…³é”®ç»“æœï¼ˆè¾“å‡ºçŠ¶æ€ï¼‰

---

### 2. çŠ¶æ€é€šä¿¡æœºåˆ¶

**ä¸»å›¾ â†’ å­å›¾ï¼ˆè¾“å…¥ï¼‰**ï¼š

```python
class EntryGraphState(TypedDict):
    cleaned_logs: List[Log]  # ä¸»å›¾æœ‰è¿™ä¸ªå­—æ®µ

class FailureAnalysisState(TypedDict):
    cleaned_logs: List[Log]  # å­å›¾ä¹Ÿæœ‰è¿™ä¸ªå­—æ®µ
```

å½“ä¸»å›¾è°ƒç”¨å­å›¾æ—¶ï¼ŒLangGraph ä¼šè‡ªåŠ¨ä¼ é€’**åŒåå­—æ®µ**ï¼š

```python
# ä¸»å›¾çŠ¶æ€
{"cleaned_logs": [...]}

# è‡ªåŠ¨ä¼ é€’ç»™å­å›¾
# å­å›¾å¯ä»¥è®¿é—® state["cleaned_logs"]
```

---

**å­å›¾ â†’ ä¸»å›¾ï¼ˆè¾“å‡ºï¼‰**ï¼š

```python
class FailureAnalysisOutputState(TypedDict):
    fa_summary: str  # å­å›¾è¾“å‡ºè¿™ä¸ªå­—æ®µ

class EntryGraphState(TypedDict):
    fa_summary: str  # ä¸»å›¾æœ‰åŒåå­—æ®µæ¥æ”¶
```

å­å›¾è¿”å›çš„å­—æ®µä¼š**æ›´æ–°**ä¸»å›¾çŠ¶æ€ä¸­çš„åŒåå­—æ®µã€‚

---

**å…³é”®åŸåˆ™**ï¼š

âœ… **åŒåå­—æ®µ = é€šä¿¡é€šé“**
- ä¸»å›¾å’Œå­å›¾é€šè¿‡åŒåå­—æ®µä¼ é€’æ•°æ®
- ä¸åŒåçš„å­—æ®µäº’ä¸å¹²æ‰°

âœ… **è¾“å…¥ = çŠ¶æ€äº¤é›†**
- å­å›¾åªèƒ½è®¿é—®ä¸ä¸»å›¾**åŒå**çš„è¾“å…¥å­—æ®µ

âœ… **è¾“å‡º = output_schema**
- å­å›¾åªè¿”å› output_schema ä¸­å®šä¹‰çš„å­—æ®µ
- å‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ é€’

---

### 3. å¹¶è¡Œå­å›¾çš„ç»“æœåˆå¹¶

**åœºæ™¯**ï¼šä¸¤ä¸ªå­å›¾å¹¶è¡Œè¿è¡Œï¼Œéƒ½è¿”å›åŒåå­—æ®µ

```python
# å­å›¾ A è¿”å›
{"processed_logs": ["a", "b"]}

# å­å›¾ B è¿”å›
{"processed_logs": ["c", "d"]}

# å¦‚ä½•åˆå¹¶ï¼Ÿ
```

**è§£å†³æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ Reducer**

```python
from operator import add

class State(TypedDict):
    processed_logs: Annotated[List[str], add]  # æŒ‡å®šåˆå¹¶æ–¹å¼
```

ç»“æœï¼š`{"processed_logs": ["a", "b", "c", "d"]}`

---

**è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ä¸åŒçš„å­—æ®µå**

```python
class EntryState(TypedDict):
    fa_processed_logs: List[str]  # å¤±è´¥åˆ†æçš„è®°å½•
    qs_processed_logs: List[str]  # é—®é¢˜æ€»ç»“çš„è®°å½•

class FAOutputState(TypedDict):
    fa_processed_logs: List[str]  # ä¸åŒå

class QSOutputState(TypedDict):
    qs_processed_logs: List[str]  # ä¸åŒå
```

è¿™æ ·ä¸¤ä¸ªå­å›¾è¿”å›ä¸åŒçš„å­—æ®µï¼Œä¸éœ€è¦åˆå¹¶ã€‚

---

### 4. ä½•æ—¶ä½¿ç”¨å­å›¾ï¼Ÿ

**é€‚åˆä½¿ç”¨å­å›¾çš„åœºæ™¯**ï¼š

âœ… **ç‹¬ç«‹çš„ä¸šåŠ¡é€»è¾‘**
- æ¯ä¸ªå­å›¾è´Ÿè´£ä¸€ä¸ªå®Œæ•´çš„å­ä»»åŠ¡
- æœ‰æ¸…æ™°çš„è¾“å…¥å’Œè¾“å‡ºè¾¹ç•Œ

âœ… **éœ€è¦çŠ¶æ€éš”ç¦»**
- å­å›¾çš„ä¸­é—´å˜é‡ä¸åº”è¯¥æ±¡æŸ“ä¸»å›¾çŠ¶æ€
- ä¾‹å¦‚ï¼š`failures` åªåœ¨å¤±è´¥åˆ†æå­å›¾å†…ä½¿ç”¨

âœ… **å¯å¤ç”¨çš„æµç¨‹**
- åŒä¸€ä¸ªå­å›¾å¯ä»¥åœ¨ä¸åŒçš„ä¸»å›¾ä¸­å¤ç”¨
- ä¾‹å¦‚ï¼šæ—¥å¿—æ¸…æ´—å­å›¾å¯ç”¨äºå¤šä¸ªåœºæ™¯

âœ… **å¹¶è¡Œæ‰§è¡Œ**
- å¤šä¸ªç‹¬ç«‹ä»»åŠ¡éœ€è¦åŒæ—¶è¿è¡Œ
- é€šè¿‡ Reducer åˆå¹¶ç»“æœ

---

**ä¸é€‚åˆä½¿ç”¨å­å›¾çš„åœºæ™¯**ï¼š

âŒ **ç®€å•çš„çº¿æ€§æµç¨‹**
- å¦‚æœåªæ˜¯å‡ ä¸ªé¡ºåºæ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œä¸éœ€è¦å­å›¾

âŒ **çŠ¶æ€é«˜åº¦è€¦åˆ**
- å¦‚æœèŠ‚ç‚¹ä¹‹é—´éœ€è¦é¢‘ç¹å…±äº«ä¸­é—´çŠ¶æ€

âŒ **è¿‡åº¦è®¾è®¡**
- ä¸è¦ä¸ºäº†ç”¨å­å›¾è€Œç”¨å­å›¾

---

## ğŸ’¡ Python çŸ¥è¯†ç‚¹æ€»ç»“

### 1. TypedDict

```python
from typing_extensions import TypedDict

# å®šä¹‰å­—å…¸ç»“æ„
class Person(TypedDict):
    name: str
    age: int

# ä½¿ç”¨
person: Person = {"name": "Alice", "age": 30}
```

**ä¼˜åŠ¿**ï¼š
- æä¾›ç±»å‹æ£€æŸ¥
- IDE è‡ªåŠ¨è¡¥å…¨
- æ¸…æ™°çš„æ•°æ®ç»“æ„æ–‡æ¡£

---

### 2. Optional ç±»å‹

```python
from typing import Optional

# è¡¨ç¤ºå¯é€‰å­—æ®µ
grade: Optional[int]  # å¯ä»¥æ˜¯ int æˆ– None

# ç­‰ä»·äº
grade: int | None  # Python 3.10+
```

---

### 3. Annotated å…ƒæ•°æ®

```python
from typing import Annotated

# åŸºæœ¬ç”¨æ³•
Age = Annotated[int, "must be positive"]

# LangGraph ç”¨æ³•
from operator import add
Logs = Annotated[List[str], add]  # æŒ‡å®šåˆå¹¶æ–¹å¼
```

---

### 4. åˆ—è¡¨æ¨å¯¼å¼

```python
# åŸºæœ¬å½¢å¼
result = [expression for item in iterable if condition]

# ç¤ºä¾‹
numbers = [1, 2, 3, 4, 5]
even = [n for n in numbers if n % 2 == 0]  # [2, 4]
squared = [n**2 for n in numbers]  # [1, 4, 9, 16, 25]
```

---

### 5. f-string æ ¼å¼åŒ–

```python
name = "Alice"
age = 30

# åŸºæœ¬ç”¨æ³•
msg = f"Name: {name}, Age: {age}"

# è¡¨è¾¾å¼
msg = f"Next year: {age + 1}"

# æ ¼å¼æ§åˆ¶
pi = 3.14159
msg = f"Pi: {pi:.2f}"  # "Pi: 3.14"
```

---

### 6. operator æ¨¡å—

```python
from operator import add

# åˆ—è¡¨åˆå¹¶
add([1, 2], [3, 4])  # [1, 2, 3, 4]

# æ•°å­—ç›¸åŠ 
add(10, 20)  # 30

# å…¶ä»–å¸¸ç”¨æ“ä½œç¬¦
from operator import mul, sub
mul(3, 4)  # 12
sub(10, 3)  # 7
```

---

## ğŸ¯ å®æˆ˜å»ºè®®

### å¯¹äºåˆå­¦è€…

1. **å…ˆç†è§£çŠ¶æ€é€šä¿¡**
   - ç”»å‡ºä¸»å›¾å’Œå­å›¾çš„çŠ¶æ€ç»“æ„
   - æ ‡æ³¨å“ªäº›å­—æ®µæ˜¯å…±äº«çš„

2. **ä»ç®€å•å¼€å§‹**
   - å…ˆæ„å»ºä¸€ä¸ªå­å›¾
   - æµ‹è¯•é€šè¿‡åå†æ·»åŠ ç¬¬äºŒä¸ª
   - æœ€åå¤„ç†å¹¶è¡Œå’Œåˆå¹¶

3. **ä½¿ç”¨å¯è§†åŒ–**
   ```python
   # æŸ¥çœ‹å­å›¾ç»“æ„
   fa_graph.get_graph().draw_mermaid_png()

   # æŸ¥çœ‹ä¸»å›¾ç»“æ„ï¼ˆå±•å¼€å­å›¾ï¼‰
   main_graph.get_graph(xray=1).draw_mermaid_png()
   ```

4. **è°ƒè¯•æŠ€å·§**
   - å…ˆå•ç‹¬æµ‹è¯•æ¯ä¸ªå­å›¾
   - ç¡®ä¿å­å›¾èƒ½ç‹¬ç«‹è¿è¡Œ
   - å†é›†æˆåˆ°ä¸»å›¾ä¸­

---

### å¯¹äºè¿›é˜¶ä½¿ç”¨

1. **ä¼˜åŒ–çŠ¶æ€è®¾è®¡**
   - åªåœ¨ output_schema ä¸­åŒ…å«å¿…è¦å­—æ®µ
   - ä½¿ç”¨æœ‰æ„ä¹‰çš„å­—æ®µåé¿å…å†²çª
   - åˆç†ä½¿ç”¨ Reducer

2. **é”™è¯¯å¤„ç†**
   ```python
   def safe_node(state):
       try:
           return process(state)
       except Exception as e:
           return {"error": str(e)}
   ```

3. **æ€§èƒ½ä¼˜åŒ–**
   - åˆ©ç”¨å¹¶è¡Œæ‰§è¡Œæé«˜æ•ˆç‡
   - é¿å…ä¼ é€’å¤§é‡ä¸å¿…è¦çš„æ•°æ®
   - ä½¿ç”¨ xray å‚æ•°åˆ†ææ‰§è¡Œè·¯å¾„

4. **å¯æµ‹è¯•æ€§**
   ```python
   # å•ç‹¬æµ‹è¯•å­å›¾
   fa_graph = fa_builder.compile()
   result = fa_graph.invoke({"cleaned_logs": test_logs})

   # æµ‹è¯•ä¸»å›¾
   main_graph = entry_builder.compile()
   result = main_graph.invoke({"raw_logs": test_logs})
   ```

**ç”Ÿæˆçš„æµç¨‹å›¾ï¼š**

![Flow Diagram](images/sub-graph-output-9-0.png)


---

## ğŸ“Œ æ€»ç»“

### æ ¸å¿ƒæ¦‚å¿µ

1. **å­å›¾æ˜¯ç‹¬ç«‹çš„å›¾**
   - æœ‰è‡ªå·±çš„çŠ¶æ€ç©ºé—´
   - å¯ä»¥ç‹¬ç«‹è¿è¡Œå’Œæµ‹è¯•
   - é€šè¿‡ compile() åå¯åµŒå…¥å…¶ä»–å›¾

2. **çŠ¶æ€é€šä¿¡é€šè¿‡åŒåå­—æ®µ**
   - ä¸»å›¾ â†’ å­å›¾ï¼šè‡ªåŠ¨ä¼ é€’åŒåè¾“å…¥å­—æ®µ
   - å­å›¾ â†’ ä¸»å›¾ï¼šè¿”å› output_schema ä¸­çš„å­—æ®µ

3. **å¹¶è¡Œå­å›¾éœ€è¦å¤„ç†ç»“æœåˆå¹¶**
   - ä½¿ç”¨ Annotated + Reducer
   - æˆ–ä½¿ç”¨ä¸åŒçš„å­—æ®µå

### è®¾è®¡åŸåˆ™

âœ… **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªå­å›¾è´Ÿè´£ä¸€ä¸ªç‹¬ç«‹ä»»åŠ¡
âœ… **çŠ¶æ€éš”ç¦»**ï¼šä¸­é—´å˜é‡ä¸æš´éœ²ç»™ä¸»å›¾
âœ… **æ¸…æ™°æ¥å£**ï¼šæ˜ç¡®å®šä¹‰è¾“å…¥å’Œè¾“å‡ºçŠ¶æ€
âœ… **å¯å¤ç”¨æ€§**ï¼šå­å›¾å¯åœ¨å¤šä¸ªåœºæ™¯ä¸­ä½¿ç”¨

### é€‚ç”¨åœºæ™¯

- å¤šä»£ç†ç³»ç»Ÿï¼ˆæ¯ä¸ªä»£ç†æ˜¯ä¸€ä¸ªå­å›¾ï¼‰
- å¤æ‚ä¸šåŠ¡æµç¨‹çš„æ¨¡å—åŒ–
- éœ€è¦å¹¶è¡Œæ‰§è¡Œçš„ç‹¬ç«‹ä»»åŠ¡
- éœ€è¦çŠ¶æ€éš”ç¦»çš„åœºæ™¯

---

## ğŸš€ æ‰©å±•ç»ƒä¹ 

1. **æ·»åŠ ç¬¬ä¸‰ä¸ªå­å›¾**
   - åˆ›å»ºä¸€ä¸ª"æ€§èƒ½ç›‘æ§"å­å›¾
   - åˆ†ææ—¥å¿—çš„å“åº”æ—¶é—´
   - å¹¶è¡Œè¿è¡Œä¸‰ä¸ªå­å›¾

2. **å®ç°é”™è¯¯å¤„ç†**
   - åœ¨å­å›¾ä¸­æ·»åŠ é”™è¯¯æ•è·
   - å°†é”™è¯¯ä¿¡æ¯è¿”å›ç»™ä¸»å›¾
   - ä¸»å›¾æ ¹æ®é”™è¯¯å†³å®šæ˜¯å¦ç»§ç»­

3. **åµŒå¥—å­å›¾**
   - åœ¨å­å›¾å†…éƒ¨å†åµŒå¥—å­å›¾
   - ç†è§£å¤šå±‚çŠ¶æ€ä¼ é€’æœºåˆ¶

4. **åŠ¨æ€å­å›¾é€‰æ‹©**
   - æ ¹æ®è¾“å…¥æ•°æ®å†³å®šè°ƒç”¨å“ªäº›å­å›¾
   - å®ç°æ¡ä»¶å¹¶è¡Œ

---

**æœ€åçš„è¯**ï¼šå­å›¾æ˜¯ LangGraph å®ç°æ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§çš„å…³é”®æœºåˆ¶ã€‚è™½ç„¶è¿™ä¸ªæ¡ˆä¾‹å¾ˆç®€å•ï¼Œä½†å®ƒå±•ç¤ºçš„"çŠ¶æ€éš”ç¦»"å’Œ"å¹¶è¡Œåˆå¹¶"æ€æƒ³åœ¨æ„å»ºå¤æ‚çš„å¤šä»£ç†ç³»ç»Ÿæ—¶è‡³å…³é‡è¦ã€‚æŒæ¡å­å›¾ï¼Œä½ å°±æŒæ¡äº†æ„å»ºå¤§å‹ AI ç³»ç»Ÿçš„åŸºç¡€ï¼

---

## ğŸ§  æ ¸å¿ƒæ¦‚å¿µæ·±åº¦è§£è¯»

### "ç‹¬ç«‹çš„çŠ¶æ€ç©ºé—´"é€šä¿—è§£é‡Š

**åœºæ™¯ç±»æ¯”ï¼šå…¬å¸åŠå…¬å®¤**

æƒ³è±¡ä¸€ä¸ªå…¬å¸æœ‰ä¸‰ä¸ªåŠå…¬å®¤ï¼š

1. **å‰å°åŠå…¬å®¤**ï¼ˆä¸»å›¾ï¼‰
   - è´Ÿè´£æ¥å¾…å®¢æˆ·ã€åˆ†é…ä»»åŠ¡
   - æœ‰ä¸€ä¸ªå…¬å…±ç™½æ¿è®°å½•ï¼šå®¢æˆ·ä¿¡æ¯ã€ä»»åŠ¡è¿›åº¦ã€æœ€ç»ˆç»“æœ

2. **æŠ€æœ¯éƒ¨åŠå…¬å®¤**ï¼ˆå­å›¾ Aï¼‰
   - æœ‰è‡ªå·±çš„å°ç™½æ¿ï¼šè®°å½•ä»£ç  bugã€ä¿®å¤æ–¹æ¡ˆã€æŠ€æœ¯æ–‡æ¡£
   - è¿™äº›ä¸­é—´è¿‡ç¨‹å‰å°**çœ‹ä¸åˆ°ä¹Ÿä¸å…³å¿ƒ**
   - å®Œæˆååªå‘Šè¯‰å‰å°ï¼š"ä¿®å¥½äº†ï¼Œè¿™æ˜¯ä¿®å¤æŠ¥å‘Š"

3. **å¸‚åœºéƒ¨åŠå…¬å®¤**ï¼ˆå­å›¾ Bï¼‰
   - æœ‰è‡ªå·±çš„å°ç™½æ¿ï¼šè®°å½•è°ƒç ”æ•°æ®ã€åˆ†æè‰ç¨¿ã€ç«å“èµ„æ–™
   - è¿™äº›ä¸­é—´è¿‡ç¨‹å‰å°**çœ‹ä¸åˆ°ä¹Ÿä¸å…³å¿ƒ**
   - å®Œæˆååªå‘Šè¯‰å‰å°ï¼š"æå®šäº†ï¼Œè¿™æ˜¯å¸‚åœºæŠ¥å‘Š"

**ç‹¬ç«‹çš„çŠ¶æ€ç©ºé—´ = æ¯ä¸ªåŠå…¬å®¤æœ‰è‡ªå·±çš„å°ç™½æ¿**

```python
# ä¸»å›¾çŠ¶æ€ï¼ˆå‰å°çš„å…¬å…±ç™½æ¿ï¼‰
class MainState:
    å®¢æˆ·éœ€æ±‚: str           # å‰å°è®°å½•
    æŠ€æœ¯ä¿®å¤æŠ¥å‘Š: str       # æŠ€æœ¯éƒ¨æäº¤çš„
    å¸‚åœºåˆ†ææŠ¥å‘Š: str       # å¸‚åœºéƒ¨æäº¤çš„

# æŠ€æœ¯éƒ¨å­å›¾çŠ¶æ€ï¼ˆæŠ€æœ¯éƒ¨çš„å°ç™½æ¿ï¼‰
class TechSubGraphState:
    å®¢æˆ·éœ€æ±‚: str           # ä»å‰å°å¤åˆ¶è¿‡æ¥çš„
    bugåˆ—è¡¨: List[str]     # åªåœ¨æŠ€æœ¯éƒ¨ç”¨ï¼Œå‰å°ä¸çŸ¥é“
    ä¿®å¤ä»£ç : str          # åªåœ¨æŠ€æœ¯éƒ¨ç”¨ï¼Œå‰å°ä¸çŸ¥é“
    æŠ€æœ¯ä¿®å¤æŠ¥å‘Š: str       # è¦æäº¤ç»™å‰å°çš„

# å¸‚åœºéƒ¨å­å›¾çŠ¶æ€ï¼ˆå¸‚åœºéƒ¨çš„å°ç™½æ¿ï¼‰
class MarketSubGraphState:
    å®¢æˆ·éœ€æ±‚: str           # ä»å‰å°å¤åˆ¶è¿‡æ¥çš„
    è°ƒç ”æ•°æ®: List[dict]   # åªåœ¨å¸‚åœºéƒ¨ç”¨ï¼Œå‰å°ä¸çŸ¥é“
    ç«å“åˆ†æ: str          # åªåœ¨å¸‚åœºéƒ¨ç”¨ï¼Œå‰å°ä¸çŸ¥é“
    å¸‚åœºåˆ†ææŠ¥å‘Š: str       # è¦æäº¤ç»™å‰å°çš„
```

**ä¸ºä»€ä¹ˆéœ€è¦ç‹¬ç«‹ç©ºé—´ï¼Ÿ**

âŒ **æ²¡æœ‰ç‹¬ç«‹ç©ºé—´çš„é—®é¢˜**ï¼š
```python
# å¦‚æœéƒ½ç”¨åŒä¸€ä¸ªç™½æ¿ï¼ˆå…±äº«çŠ¶æ€ï¼‰
å…¨å…¬å¸å…±äº«çŠ¶æ€ = {
    "å®¢æˆ·éœ€æ±‚": "...",
    "bugåˆ—è¡¨": [...],        # æŠ€æœ¯éƒ¨çš„
    "ä¿®å¤ä»£ç ": "...",       # æŠ€æœ¯éƒ¨çš„
    "è°ƒç ”æ•°æ®": [...],       # å¸‚åœºéƒ¨çš„
    "ç«å“åˆ†æ": "...",       # å¸‚åœºéƒ¨çš„
    # å…¨æ··åœ¨ä¸€èµ·ï¼Œä¹±å¥—äº†ï¼
}
```

é—®é¢˜ï¼š
- å‰å°ä¸å…³å¿ƒæŠ€æœ¯ç»†èŠ‚ï¼Œå´è¦çœ‹åˆ° `bugåˆ—è¡¨`ã€`ä¿®å¤ä»£ç `
- æŠ€æœ¯éƒ¨ä¸å…³å¿ƒå¸‚åœºæ•°æ®ï¼Œå´è¦çœ‹åˆ° `è°ƒç ”æ•°æ®`ã€`ç«å“åˆ†æ`
- å­—æ®µåå¯èƒ½å†²çªï¼ˆä¸¤ä¸ªéƒ¨é—¨éƒ½æƒ³ç”¨ `ä¸´æ—¶ç¬”è®°` è¿™ä¸ªåå­—ï¼‰
- çŠ¶æ€è‡ƒè‚¿ï¼Œç®¡ç†å›°éš¾

âœ… **æœ‰ç‹¬ç«‹ç©ºé—´çš„å¥½å¤„**ï¼š
```python
# æŠ€æœ¯éƒ¨åªå…³å¿ƒè‡ªå·±çš„äº‹
tech_state = {
    "å®¢æˆ·éœ€æ±‚": "...",      # è¾“å…¥
    "bugåˆ—è¡¨": [...],       # å†…éƒ¨å·¥ä½œ
    "ä¿®å¤ä»£ç ": "...",      # å†…éƒ¨å·¥ä½œ
    "æŠ€æœ¯ä¿®å¤æŠ¥å‘Š": "..."   # è¾“å‡º
}

# å¸‚åœºéƒ¨åªå…³å¿ƒè‡ªå·±çš„äº‹
market_state = {
    "å®¢æˆ·éœ€æ±‚": "...",      # è¾“å…¥
    "è°ƒç ”æ•°æ®": [...],      # å†…éƒ¨å·¥ä½œ
    "ç«å“åˆ†æ": "...",      # å†…éƒ¨å·¥ä½œ
    "å¸‚åœºåˆ†ææŠ¥å‘Š": "..."   # è¾“å‡º
}

# å‰å°åªçœ‹æœ€ç»ˆç»“æœ
main_state = {
    "å®¢æˆ·éœ€æ±‚": "...",
    "æŠ€æœ¯ä¿®å¤æŠ¥å‘Š": "...",  # æ¥è‡ªæŠ€æœ¯éƒ¨
    "å¸‚åœºåˆ†ææŠ¥å‘Š": "..."   # æ¥è‡ªå¸‚åœºéƒ¨
}
```

å¥½å¤„ï¼š
- âœ… **èŒè´£æ¸…æ™°**ï¼šæ¯ä¸ªéƒ¨é—¨ç®¡å¥½è‡ªå·±çš„äº‹
- âœ… **é¿å…æ±¡æŸ“**ï¼šä¸­é—´å˜é‡ä¸ä¼šæ³„éœ²åˆ°å…¶ä»–åœ°æ–¹
- âœ… **å¯å¹¶è¡Œ**ï¼šæŠ€æœ¯éƒ¨å’Œå¸‚åœºéƒ¨å¯ä»¥åŒæ—¶å·¥ä½œï¼Œäº’ä¸å¹²æ‰°
- âœ… **æ˜“ç»´æŠ¤**ï¼šä¿®æ”¹æŠ€æœ¯éƒ¨æµç¨‹ä¸å½±å“å¸‚åœºéƒ¨

---

### LangGraph çš„ State æ ¸å¿ƒæ¦‚å¿µï¼ˆå¤§ç™½è¯ç‰ˆï¼‰

**State æ˜¯ä»€ä¹ˆï¼Ÿ**

State å°±æ˜¯ä¸€ä¸ª**æ•°æ®æµæ°´æœ¬**ï¼Œè®°å½•äº†ä»å¼€å§‹åˆ°ç°åœ¨æ‰€æœ‰èŠ‚ç‚¹äº§ç”Ÿçš„æ•°æ®ã€‚

**æ ¸å¿ƒæ¯”å–»ï¼šState = ä¿¡æ¯å¹¿åœº**

æƒ³è±¡ä¸€ä¸ªåŸå¸‚çš„ä¸­å¿ƒå¹¿åœºï¼Œæ‰€æœ‰äººï¼ˆèŠ‚ç‚¹ï¼‰éƒ½ä¼šæ¥è¿™é‡Œï¼š
- ğŸ“¢ **å‘å¸ƒæ¶ˆæ¯**ï¼šæŠŠè‡ªå·±å¤„ç†çš„ç»“æœè´´åˆ°å¹¿åœºçš„å…¬å‘Šæ¿ä¸Š
- ğŸ‘€ **æŸ¥çœ‹æ¶ˆæ¯**ï¼šçœ‹çœ‹åˆ«äººè´´äº†ä»€ä¹ˆä¿¡æ¯ï¼Œä½œä¸ºè‡ªå·±å·¥ä½œçš„è¾“å…¥
- ğŸ”„ **ä¿¡æ¯æ±‡æ€»**ï¼šæ‰€æœ‰äººçš„å·¥ä½œæˆæœéƒ½æ±‡é›†åœ¨è¿™ä¸ªå¹¿åœº

```
         ä¿¡æ¯å¹¿åœºï¼ˆStateï¼‰
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ç”¨æˆ·è¾“å…¥: "..."        â”‚  â† åˆå§‹ä¿¡æ¯
    â”‚  èŠ‚ç‚¹Açš„ç»“æœ: "..."     â”‚  â† èŠ‚ç‚¹A è´´ä¸Šå»çš„
    â”‚  èŠ‚ç‚¹Bçš„ç»“æœ: "..."     â”‚  â† èŠ‚ç‚¹B è´´ä¸Šå»çš„
    â”‚  èŠ‚ç‚¹Cçš„ç»“æœ: "..."     â”‚  â† èŠ‚ç‚¹C è´´ä¸Šå»çš„
    â”‚  æœ€ç»ˆç­”æ¡ˆ: "..."        â”‚  â† æœ€åä¸€ä¸ªèŠ‚ç‚¹æ€»ç»“çš„
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘    â†‘    â†‘    â†‘
           â”‚    â”‚    â”‚    â”‚
        èŠ‚ç‚¹A èŠ‚ç‚¹B èŠ‚ç‚¹C èŠ‚ç‚¹D
      ï¼ˆæ¥è´´ï¼‰ï¼ˆæ¥çœ‹ï¼‰ï¼ˆæ¥è´´ï¼‰ï¼ˆæ¥çœ‹ï¼‰
```

**å…³é”®ç‰¹ç‚¹**ï¼š

1. **ä¸­å¿ƒåŒ–æ±‡èš**
   - æ‰€æœ‰èŠ‚ç‚¹äº§ç”Ÿçš„ä¿¡æ¯éƒ½æ±‡æ€»åˆ° State è¿™ä¸ªå¹¿åœº
   - ä¸æ˜¯ç‚¹å¯¹ç‚¹ä¼ é€’ï¼Œè€Œæ˜¯"æˆ‘è´´å…¬å‘Š â†’ ä½ æ¥çœ‹å…¬å‘Š"

2. **ä¿¡æ¯æŒä¹…åŒ–**
   - è´´åœ¨å¹¿åœºä¸Šçš„ä¿¡æ¯ä¸ä¼šæ¶ˆå¤±ï¼ˆé™¤éè¢«è¦†ç›–ï¼‰
   - åé¢çš„èŠ‚ç‚¹èƒ½çœ‹åˆ°å‰é¢æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯

3. **å¼‚æ­¥åä½œ**
   - èŠ‚ç‚¹A ä¸éœ€è¦ç­‰èŠ‚ç‚¹B çœ‹å®Œæ‰ç»§ç»­
   - å„è‡ªæŠŠä¿¡æ¯è´´ä¸Šå»å°±è¡Œï¼Œæœ‰ä¾èµ–å…³ç³»çš„èŠ‚ç‚¹è‡ªç„¶ä¼šæ¥çœ‹

4. **å…¨å±€å¯è§**
   - ä»»ä½•èŠ‚ç‚¹éƒ½èƒ½çœ‹åˆ°å¹¿åœºä¸Šçš„æ‰€æœ‰ä¿¡æ¯
   - ä½†å®é™…ä¸Šï¼ŒèŠ‚ç‚¹åªå…³å¿ƒè‡ªå·±éœ€è¦çš„é‚£éƒ¨åˆ†

---

**ä¿¡æ¯å¹¿åœºçš„è¿ä½œæœºåˆ¶**

#### åœºæ™¯ï¼šå¤šäººåä½œå†™æŠ¥å‘Š

```python
# å¹¿åœºä¸Šçš„å…¬å‘Šæ¿ï¼ˆStateï¼‰
class æŠ¥å‘ŠState(TypedDict):
    è€æ¿éœ€æ±‚: str          # è€æ¿å‘å¸ƒçš„
    å¸‚åœºæ•°æ®: dict         # å¸‚åœºéƒ¨è´´çš„
    æŠ€æœ¯æ–¹æ¡ˆ: str          # æŠ€æœ¯éƒ¨è´´çš„
    è´¢åŠ¡é¢„ç®—: float        # è´¢åŠ¡éƒ¨è´´çš„
    æœ€ç»ˆæŠ¥å‘Š: str          # æ±‡æ€»äººå‘˜ç”Ÿæˆçš„
```

**æ‰§è¡Œæµç¨‹**ï¼š

```
1. è€æ¿æ¥å¹¿åœºï¼Œè´´äº†ä¸ªéœ€æ±‚ï¼š
   State = {"è€æ¿éœ€æ±‚": "åšä¸ªæ–°äº§å“åˆ†æ"}

2. å¸‚åœºéƒ¨æ¥å¹¿åœºçœ‹éœ€æ±‚ï¼Œåšå®Œè°ƒç ”åè´´ç»“æœï¼š
   State = {
       "è€æ¿éœ€æ±‚": "åšä¸ªæ–°äº§å“åˆ†æ",
       "å¸‚åœºæ•°æ®": {"ç”¨æˆ·é‡": 1000, "ç«å“": ["A", "B"]}  â† æ–°å¢
   }

3. æŠ€æœ¯éƒ¨æ¥å¹¿åœºçœ‹éœ€æ±‚å’Œå¸‚åœºæ•°æ®ï¼Œè´´æŠ€æœ¯æ–¹æ¡ˆï¼š
   State = {
       "è€æ¿éœ€æ±‚": "åšä¸ªæ–°äº§å“åˆ†æ",
       "å¸‚åœºæ•°æ®": {...},
       "æŠ€æœ¯æ–¹æ¡ˆ": "ä½¿ç”¨ Python + React"  â† æ–°å¢
   }

4. è´¢åŠ¡éƒ¨æ¥å¹¿åœºçœ‹æŠ€æœ¯æ–¹æ¡ˆï¼Œè´´é¢„ç®—ï¼š
   State = {
       "è€æ¿éœ€æ±‚": "åšä¸ªæ–°äº§å“åˆ†æ",
       "å¸‚åœºæ•°æ®": {...},
       "æŠ€æœ¯æ–¹æ¡ˆ": "ä½¿ç”¨ Python + React",
       "è´¢åŠ¡é¢„ç®—": 100000.0  â† æ–°å¢
   }

5. æ±‡æ€»äººå‘˜æ¥å¹¿åœºçœ‹æ‰€æœ‰ä¿¡æ¯ï¼Œç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šï¼š
   State = {
       "è€æ¿éœ€æ±‚": "åšä¸ªæ–°äº§å“åˆ†æ",
       "å¸‚åœºæ•°æ®": {...},
       "æŠ€æœ¯æ–¹æ¡ˆ": "ä½¿ç”¨ Python + React",
       "è´¢åŠ¡é¢„ç®—": 100000.0,
       "æœ€ç»ˆæŠ¥å‘Š": "ç»¼åˆå¸‚åœºã€æŠ€æœ¯ã€è´¢åŠ¡çš„å®Œæ•´æ–¹æ¡ˆ"  â† æ–°å¢
   }
```

**æ³¨æ„**ï¼š
- æ¯ä¸ªéƒ¨é—¨ï¼ˆèŠ‚ç‚¹ï¼‰éƒ½æ˜¯**ç‹¬ç«‹å·¥ä½œ**çš„
- ä»–ä»¬é€šè¿‡**å¹¿åœºï¼ˆStateï¼‰**åä½œï¼Œä¸éœ€è¦ç›´æ¥æ²Ÿé€š
- å¹¿åœºä¸Šçš„ä¿¡æ¯**è¶Šæ¥è¶Šä¸°å¯Œ**ï¼Œæœ€ç»ˆæ±‡èšæˆå®Œæ•´ç»“æœ

---

**ä¿¡æ¯å¹¿åœº vs ä¼ ç»Ÿå‡½æ•°è°ƒç”¨**

âŒ **ä¼ ç»Ÿæ–¹å¼ï¼ˆç‚¹å¯¹ç‚¹ä¼ é€’ï¼‰**ï¼š
```python
# åƒæ¥åŠ›èµ›ï¼Œä¿¡æ¯ä¸€ä¸ªäººä¼ ä¸€ä¸ªäºº
éœ€æ±‚ = è€æ¿.å‘å¸ƒéœ€æ±‚()
å¸‚åœºæ•°æ® = å¸‚åœºéƒ¨.è°ƒç ”(éœ€æ±‚)           # åªèƒ½çœ‹åˆ°éœ€æ±‚
æŠ€æœ¯æ–¹æ¡ˆ = æŠ€æœ¯éƒ¨.è®¾è®¡(éœ€æ±‚, å¸‚åœºæ•°æ®)  # åªèƒ½çœ‹åˆ°éœ€æ±‚å’Œå¸‚åœºæ•°æ®
é¢„ç®— = è´¢åŠ¡éƒ¨.è®¡ç®—(æŠ€æœ¯æ–¹æ¡ˆ)           # åªèƒ½çœ‹åˆ°æŠ€æœ¯æ–¹æ¡ˆ
æŠ¥å‘Š = æ±‡æ€».ç”Ÿæˆ(éœ€æ±‚, å¸‚åœºæ•°æ®, æŠ€æœ¯æ–¹æ¡ˆ, é¢„ç®—)  # è¦æ‰‹åŠ¨ä¼ æ‰€æœ‰å‚æ•°ï¼
```

é—®é¢˜ï¼š
- åé¢çš„å‡½æ•°è¦çŸ¥é“å‰é¢æ‰€æœ‰å‡½æ•°çš„å‚æ•°
- æ”¹ä¸€ä¸ªåœ°æ–¹ï¼Œæ‰€æœ‰å‡½æ•°è°ƒç”¨éƒ½è¦æ”¹
- ä¿¡æ¯åªèƒ½å•å‘æµåŠ¨ï¼Œä¸èƒ½å›å¤´çœ‹

âœ… **State æ–¹å¼ï¼ˆä¿¡æ¯å¹¿åœºï¼‰**ï¼š
```python
# æ¯ä¸ªèŠ‚ç‚¹åªè´Ÿè´£ï¼š1. çœ‹å¹¿åœº  2. è´´å…¬å‘Š
def å¸‚åœºéƒ¨(state):
    éœ€æ±‚ = state["è€æ¿éœ€æ±‚"]  # ä»å¹¿åœºçœ‹
    å¸‚åœºæ•°æ® = åšè°ƒç ”(éœ€æ±‚)
    return {"å¸‚åœºæ•°æ®": å¸‚åœºæ•°æ®}  # è´´åˆ°å¹¿åœº

def æŠ€æœ¯éƒ¨(state):
    éœ€æ±‚ = state["è€æ¿éœ€æ±‚"]      # ä»å¹¿åœºçœ‹
    å¸‚åœº = state["å¸‚åœºæ•°æ®"]      # ä»å¹¿åœºçœ‹
    æ–¹æ¡ˆ = è®¾è®¡æ–¹æ¡ˆ(éœ€æ±‚, å¸‚åœº)
    return {"æŠ€æœ¯æ–¹æ¡ˆ": æ–¹æ¡ˆ}  # è´´åˆ°å¹¿åœº

def è´¢åŠ¡éƒ¨(state):
    æ–¹æ¡ˆ = state["æŠ€æœ¯æ–¹æ¡ˆ"]  # ä»å¹¿åœºçœ‹
    é¢„ç®— = è®¡ç®—é¢„ç®—(æ–¹æ¡ˆ)
    return {"è´¢åŠ¡é¢„ç®—": é¢„ç®—}  # è´´åˆ°å¹¿åœº

def æ±‡æ€»(state):
    # ä»å¹¿åœºä¸€æ¬¡æ€§çœ‹åˆ°æ‰€æœ‰ä¿¡æ¯ï¼
    æ‰€æœ‰ä¿¡æ¯ = state
    æŠ¥å‘Š = ç”ŸæˆæŠ¥å‘Š(æ‰€æœ‰ä¿¡æ¯)
    return {"æœ€ç»ˆæŠ¥å‘Š": æŠ¥å‘Š}  # è´´åˆ°å¹¿åœº
```

ä¼˜åŠ¿ï¼š
- âœ… æ¯ä¸ªèŠ‚ç‚¹**åªå…³å¿ƒå¹¿åœºï¼ˆstateï¼‰**ï¼Œä¸éœ€è¦çŸ¥é“å…¶ä»–èŠ‚ç‚¹
- âœ… æ·»åŠ æ–°èŠ‚ç‚¹ä¸å½±å“å·²æœ‰èŠ‚ç‚¹
- âœ… ä¿¡æ¯å…¨å±€å¯è§ï¼Œä»»ä½•èŠ‚ç‚¹éƒ½èƒ½å›å¤´çœ‹ä¹‹å‰çš„æ•°æ®
- âœ… è§£è€¦åˆï¼Œæ˜“æ‰©å±•

---

**ä¿¡æ¯å¹¿åœºçš„"åˆ†åŒºç®¡ç†"ï¼ˆå­å›¾çš„çŠ¶æ€éš”ç¦»ï¼‰**

å½“å¹¿åœºå¤ªå¤§ã€ä¿¡æ¯å¤ªæ‚æ—¶ï¼Œå¯ä»¥è®¾ç«‹**åˆ†åŒºå¹¿åœº**ï¼ˆå­å›¾ï¼‰ã€‚

```
         æ€»å¹¿åœºï¼ˆä¸»å›¾ Stateï¼‰
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç”¨æˆ·éœ€æ±‚: "..."         â”‚
    â”‚ å¸‚åœºæŠ¥å‘Š: "..."  â†â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ æ¥è‡ªå¸‚åœºåˆ†åŒº
    â”‚ æŠ€æœ¯æŠ¥å‘Š: "..."  â†â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ æ¥è‡ªæŠ€æœ¯åˆ†åŒº
    â”‚ æœ€ç»ˆæ–¹æ¡ˆ: "..."         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“          â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚å¸‚åœºåˆ†åŒºå¹¿åœºâ”‚  â”‚æŠ€æœ¯åˆ†åŒºå¹¿åœºâ”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚è°ƒç ”æ•°æ®: ..â”‚  â”‚ä»£ç è®¾è®¡: ..â”‚  â† è¿™äº›ç»†èŠ‚
     â”‚ç«å“åˆ†æ: ..â”‚  â”‚æ¶æ„å›¾: ...â”‚  â† æ€»å¹¿åœºçœ‹ä¸åˆ°
     â”‚ç”¨æˆ·è®¿è°ˆ: ..â”‚  â”‚æŠ€æœ¯é€‰å‹: ..â”‚  â† åªåœ¨åˆ†åŒºå†…
     â”‚å¸‚åœºæŠ¥å‘Š: ..â”‚  â”‚æŠ€æœ¯æŠ¥å‘Š: ..â”‚  â† æœ€ç»ˆç»“æœè´´åˆ°æ€»å¹¿åœº
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¯”å–»**ï¼š
- **æ€»å¹¿åœº**ï¼ˆä¸»å›¾ Stateï¼‰ï¼šå¸‚æ”¿åºœå¤§å¹¿åœºï¼Œåªçœ‹å„éƒ¨é—¨çš„æœ€ç»ˆæ±‡æŠ¥
- **åˆ†åŒºå¹¿åœº**ï¼ˆå­å›¾ Stateï¼‰ï¼šå„éƒ¨é—¨å†…éƒ¨çš„å°å¹¿åœºï¼Œå¤„ç†ç»†èŠ‚å·¥ä½œ

**å¥½å¤„**ï¼š
1. **ä¿¡æ¯åˆ†å±‚**ï¼šæ€»å¹¿åœºä¸ä¼šè¢«ç»†èŠ‚æ·¹æ²¡
2. **å¹¶è¡Œå·¥ä½œ**ï¼šå„åˆ†åŒºå¯ä»¥åŒæ—¶å·¥ä½œï¼Œäº’ä¸å¹²æ‰°
3. **éšç§ä¿æŠ¤**ï¼šåˆ†åŒºå†…éƒ¨çš„å·¥ä½œç»†èŠ‚ä¸ä¼šæš´éœ²åˆ°æ€»å¹¿åœº

---

**ç”Ÿæ´»ç±»æ¯”ï¼šåšèœçš„èœè°±æœ¬**

æƒ³è±¡ä½ åœ¨åšä¸€é“å¤æ‚çš„èœï¼š

```python
# èœè°±çŠ¶æ€ï¼ˆStateï¼‰
class åšèœState:
    é£Ÿæ: List[str]        # åˆå§‹è¾“å…¥
    åˆ‡å¥½çš„èœ: List[str]    # ç¬¬ä¸€æ­¥äº§ç”Ÿ
    è°ƒå¥½çš„é…±æ–™: str        # ç¬¬äºŒæ­¥äº§ç”Ÿ
    ç‚’å¥½çš„åŠæˆå“: str      # ç¬¬ä¸‰æ­¥äº§ç”Ÿ
    æœ€ç»ˆæˆå“: str          # æœ€åä¸€æ­¥äº§ç”Ÿ
```

æ‰§è¡Œæµç¨‹ï¼š
```
å¼€å§‹ â†’ æ´—èœåˆ‡èœ â†’ è°ƒé…±æ–™ â†’ ç‚’èœ â†’ è£…ç›˜ â†’ ç»“æŸ
      â†“        â†“       â†“      â†“
    æ›´æ–°State æ›´æ–°State æ›´æ–°State æ›´æ–°State
```

æ¯ä¸ªèŠ‚ç‚¹ï¼ˆæ­¥éª¤ï¼‰åšä¸¤ä»¶äº‹ï¼š
1. **è¯»å–** State ä¸­çš„æ•°æ®ï¼ˆçœ‹èœè°±æœ¬ï¼ŒçŸ¥é“ä¸Šä¸€æ­¥åšäº†ä»€ä¹ˆï¼‰
2. **æ›´æ–°** State ä¸­çš„æ•°æ®ï¼ˆåœ¨èœè°±æœ¬ä¸Šè®°å½•è¿™ä¸€æ­¥çš„ç»“æœï¼‰

---

**State çš„ä¸‰å¤§ç‰¹æ€§**

#### 1. ç´¯ç§¯æ€§ï¼ˆAccumulativeï¼‰

State åƒæ»šé›ªçƒä¸€æ ·ï¼Œè¶Šæ»šè¶Šå¤§ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¾€ä¸ŠåŠ ä¸œè¥¿ã€‚

```python
# åˆå§‹çŠ¶æ€
state = {"é£Ÿæ": ["é¸¡è›‹", "ç•ªèŒ„"]}

# èŠ‚ç‚¹1ï¼šæ´—èœåˆ‡èœ
def åˆ‡èœ(state):
    return {"åˆ‡å¥½çš„èœ": ["ç•ªèŒ„å—", "é¸¡è›‹æ¶²"]}
# ç°åœ¨ state = {
#     "é£Ÿæ": ["é¸¡è›‹", "ç•ªèŒ„"],
#     "åˆ‡å¥½çš„èœ": ["ç•ªèŒ„å—", "é¸¡è›‹æ¶²"]  â† æ–°å¢
# }

# èŠ‚ç‚¹2ï¼šè°ƒé…±æ–™
def è°ƒé…±æ–™(state):
    return {"è°ƒå¥½çš„é…±æ–™": "ç›+ç³–+é…±æ²¹"}
# ç°åœ¨ state = {
#     "é£Ÿæ": ["é¸¡è›‹", "ç•ªèŒ„"],
#     "åˆ‡å¥½çš„èœ": ["ç•ªèŒ„å—", "é¸¡è›‹æ¶²"],
#     "è°ƒå¥½çš„é…±æ–™": "ç›+ç³–+é…±æ²¹"  â† åˆæ–°å¢
# }

# èŠ‚ç‚¹3ï¼šç‚’èœ
def ç‚’èœ(state):
    èœ = state["åˆ‡å¥½çš„èœ"]      # è¯»å–ä¹‹å‰çš„æ•°æ®
    é…±æ–™ = state["è°ƒå¥½çš„é…±æ–™"]  # è¯»å–ä¹‹å‰çš„æ•°æ®
    return {"æœ€ç»ˆæˆå“": f"ç‚’{èœ} with {é…±æ–™}"}
# ç°åœ¨ state = {
#     "é£Ÿæ": ["é¸¡è›‹", "ç•ªèŒ„"],
#     "åˆ‡å¥½çš„èœ": ["ç•ªèŒ„å—", "é¸¡è›‹æ¶²"],
#     "è°ƒå¥½çš„é…±æ–™": "ç›+ç³–+é…±æ²¹",
#     "æœ€ç»ˆæˆå“": "ç‚’ç•ªèŒ„é¸¡è›‹ with è°ƒæ–™"  â† ç»§ç»­æ–°å¢
# }
```

**å…³é”®ç‚¹**ï¼šæ¯ä¸ªèŠ‚ç‚¹ä¸ä¼šåˆ é™¤ä¹‹å‰çš„æ•°æ®ï¼Œåªä¼šæ·»åŠ æ–°æ•°æ®ã€‚

---

#### 2. å¯è¦†ç›–æ€§ï¼ˆOverwritableï¼‰

å¦‚æœèŠ‚ç‚¹è¿”å›äº†**åŒåå­—æ®µ**ï¼Œä¼šè¦†ç›–æ—§å€¼ã€‚

```python
# åˆå§‹çŠ¶æ€
state = {"æ¸©åº¦": "å¸¸æ¸©"}

# èŠ‚ç‚¹1ï¼šåŠ çƒ­
def åŠ çƒ­(state):
    return {"æ¸©åº¦": "100åº¦"}
# state = {"æ¸©åº¦": "100åº¦"}  â† è¦†ç›–äº†"å¸¸æ¸©"

# èŠ‚ç‚¹2ï¼šå†·å´
def å†·å´(state):
    return {"æ¸©åº¦": "50åº¦"}
# state = {"æ¸©åº¦": "50åº¦"}  â† åˆè¦†ç›–äº†"100åº¦"
```

**é»˜è®¤è¡Œä¸º**ï¼šåé¢çš„èŠ‚ç‚¹ä¼šè¦†ç›–å‰é¢èŠ‚ç‚¹çš„åŒåå­—æ®µã€‚

**è‡ªå®šä¹‰è¡Œä¸º**ï¼šä½¿ç”¨ Reducer æ”¹å˜åˆå¹¶æ–¹å¼

```python
from operator import add
from typing import Annotated

class State(TypedDict):
    # é»˜è®¤è¡Œä¸ºï¼šè¦†ç›–
    æ¸©åº¦: str

    # è‡ªå®šä¹‰è¡Œä¸ºï¼šç´¯åŠ 
    æ—¥å¿—: Annotated[List[str], add]

# ä½¿ç”¨
state = {"æ—¥å¿—": ["æ­¥éª¤1"]}

# èŠ‚ç‚¹1
def èŠ‚ç‚¹1(state):
    return {"æ—¥å¿—": ["æ­¥éª¤2"]}
# state = {"æ—¥å¿—": ["æ­¥éª¤1", "æ­¥éª¤2"]}  â† åˆå¹¶ï¼Œä¸æ˜¯è¦†ç›–ï¼

# èŠ‚ç‚¹2
def èŠ‚ç‚¹2(state):
    return {"æ—¥å¿—": ["æ­¥éª¤3"]}
# state = {"æ—¥å¿—": ["æ­¥éª¤1", "æ­¥éª¤2", "æ­¥éª¤3"]}  â† ç»§ç»­åˆå¹¶
```

---

#### 3. èŠ‚ç‚¹é—´é€šä¿¡çš„å”¯ä¸€æ–¹å¼

åœ¨ LangGraph ä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´**ä¸èƒ½ç›´æ¥å¯¹è¯**ï¼Œåªèƒ½é€šè¿‡ State äº¤æµã€‚

âŒ **é”™è¯¯æ–¹å¼**ï¼ˆèŠ‚ç‚¹æƒ³ç›´æ¥è°ƒç”¨ï¼‰ï¼š
```python
def èŠ‚ç‚¹A(state):
    result = èŠ‚ç‚¹B(state)  # é”™è¯¯ï¼ä¸èƒ½è¿™æ ·
    return {"data": result}
```

âœ… **æ­£ç¡®æ–¹å¼**ï¼ˆé€šè¿‡ State é€šä¿¡ï¼‰ï¼š
```python
# èŠ‚ç‚¹A å†™å…¥ State
def èŠ‚ç‚¹A(state):
    return {"ä¸­é—´ç»“æœ": "Açš„æ•°æ®"}

# èŠ‚ç‚¹B ä» State è¯»å–
def èŠ‚ç‚¹B(state):
    a_data = state["ä¸­é—´ç»“æœ"]  # è¯»å–Aå†™å…¥çš„æ•°æ®
    return {"æœ€ç»ˆç»“æœ": f"å¤„ç†äº†{a_data}"}

# åœ¨å›¾ä¸­è¿æ¥
graph.add_edge("èŠ‚ç‚¹A", "èŠ‚ç‚¹B")
```

**ç±»æ¯”**ï¼š
- State = ä¼ çº¸æ¡
- èŠ‚ç‚¹A åœ¨çº¸æ¡ä¸Šå†™ "ä¸­é—´ç»“æœ = XXX"
- èŠ‚ç‚¹B çœ‹çº¸æ¡ï¼ŒçŸ¥é“äº† A çš„ç»“æœ

---

**State çš„è®¾è®¡åŸåˆ™**

#### åŸåˆ™ 1ï¼šåªåŒ…å«å¿…è¦çš„å­—æ®µ

âŒ **ä¸å¥½çš„è®¾è®¡**ï¼ˆå¤ªå¤šæ— ç”¨å­—æ®µï¼‰ï¼š
```python
class State(TypedDict):
    ç”¨æˆ·è¾“å…¥: str
    ä¸´æ—¶å˜é‡1: str     # åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ç”¨
    ä¸´æ—¶å˜é‡2: int     # åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ç”¨
    ä¸´æ—¶å˜é‡3: list    # åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ç”¨
    è°ƒè¯•ä¿¡æ¯: str      # å¼€å‘æ—¶ç”¨ï¼Œç”Ÿäº§ä¸éœ€è¦
    æœ€ç»ˆç»“æœ: str
```

âœ… **å¥½çš„è®¾è®¡**ï¼ˆåªä¿ç•™å¿…è¦çš„ï¼‰ï¼š
```python
class State(TypedDict):
    ç”¨æˆ·è¾“å…¥: str      # è¾“å…¥
    æœ€ç»ˆç»“æœ: str      # è¾“å‡º
    # ä¸´æ—¶å˜é‡åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰ï¼Œä¸æ”¾ State
```

**æŠ€å·§**ï¼šå¦‚æœæŸä¸ªæ•°æ®åªåœ¨ä¸€ä¸ªèŠ‚ç‚¹å†…éƒ¨ä½¿ç”¨ï¼Œå°±ç”¨å±€éƒ¨å˜é‡ï¼Œä¸è¦æ”¾ Stateã€‚

---

#### åŸåˆ™ 2ï¼šç”¨å­å›¾éš”ç¦»å¤æ‚çŠ¶æ€

å½“çŠ¶æ€å˜å¾—å¤æ‚æ—¶ï¼Œç”¨å­å›¾æ‹†åˆ†ã€‚

âŒ **ä¸å¥½çš„è®¾è®¡**ï¼ˆçŠ¶æ€è‡ƒè‚¿ï¼‰ï¼š
```python
class å·¨å‹State(TypedDict):
    # ä¸»æµç¨‹å­—æ®µ
    ç”¨æˆ·è¾“å…¥: str
    æœ€ç»ˆç»“æœ: str

    # å­ä»»åŠ¡Açš„å­—æ®µ
    A_ä¸­é—´æ•°æ®1: str
    A_ä¸­é—´æ•°æ®2: List
    A_ç»“æœ: str

    # å­ä»»åŠ¡Bçš„å­—æ®µ
    B_ä¸­é—´æ•°æ®1: dict
    B_ä¸­é—´æ•°æ®2: str
    B_ç»“æœ: str

    # å…¨æ··åœ¨ä¸€èµ·ï¼
```

âœ… **å¥½çš„è®¾è®¡**ï¼ˆç”¨å­å›¾åˆ†ç¦»ï¼‰ï¼š
```python
# ä¸»å›¾çŠ¶æ€ï¼ˆåªå…³å¿ƒæœ€ç»ˆç»“æœï¼‰
class ä¸»State(TypedDict):
    ç”¨æˆ·è¾“å…¥: str
    A_ç»“æœ: str        # æ¥è‡ªå­å›¾A
    B_ç»“æœ: str        # æ¥è‡ªå­å›¾B
    æœ€ç»ˆç»“æœ: str

# å­å›¾AçŠ¶æ€ï¼ˆæœ‰è‡ªå·±çš„ä¸­é—´å˜é‡ï¼‰
class å­å›¾AState(TypedDict):
    ç”¨æˆ·è¾“å…¥: str      # è¾“å…¥
    ä¸­é—´æ•°æ®1: str     # å†…éƒ¨ä½¿ç”¨
    ä¸­é—´æ•°æ®2: List    # å†…éƒ¨ä½¿ç”¨
    A_ç»“æœ: str        # è¾“å‡º

# å­å›¾BçŠ¶æ€ï¼ˆæœ‰è‡ªå·±çš„ä¸­é—´å˜é‡ï¼‰
class å­å›¾BState(TypedDict):
    ç”¨æˆ·è¾“å…¥: str      # è¾“å…¥
    ä¸­é—´æ•°æ®1: dict    # å†…éƒ¨ä½¿ç”¨
    ä¸­é—´æ•°æ®2: str     # å†…éƒ¨ä½¿ç”¨
    B_ç»“æœ: str        # è¾“å‡º
```

---

#### åŸåˆ™ 3ï¼šæ˜ç¡®è¾“å…¥å’Œè¾“å‡º

ä½¿ç”¨ `output_schema` æ˜ç¡®å­å›¾çš„è¾“å‡ºã€‚

```python
# å­å›¾å†…éƒ¨çŠ¶æ€ï¼ˆå®Œæ•´çš„å·¥ä½œç©ºé—´ï¼‰
class å†…éƒ¨State(TypedDict):
    è¾“å…¥æ•°æ®: str
    ä¸´æ—¶æ•°æ®1: str
    ä¸´æ—¶æ•°æ®2: int
    æœ€ç»ˆç»“æœ: str

# å­å›¾è¾“å‡ºçŠ¶æ€ï¼ˆåªè¾“å‡ºå¿…è¦çš„ï¼‰
class è¾“å‡ºState(TypedDict):
    æœ€ç»ˆç»“æœ: str      # åªè¾“å‡ºè¿™ä¸€ä¸ª

# æ„å»ºå­å›¾
sub_graph = StateGraph(
    state_schema=å†…éƒ¨State,      # å†…éƒ¨ç”¨å®Œæ•´çŠ¶æ€
    output_schema=è¾“å‡ºState       # è¾“å‡ºæ—¶åªè¿”å›æœ€ç»ˆç»“æœ
)
```

**å¥½å¤„**ï¼š
- ä¸»å›¾ä¸ä¼šè¢«å­å›¾çš„ä¸´æ—¶æ•°æ®æ±¡æŸ“
- æ¸…æ™°çš„æ¥å£çº¦å®š
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

---

**State å®æˆ˜ç¤ºä¾‹ï¼šå¤šæ­¥éª¤æ¨ç†**

```python
from typing import TypedDict, List
from langgraph.graph import StateGraph, START, END

# å®šä¹‰çŠ¶æ€
class ReasoningState(TypedDict):
    é—®é¢˜: str                  # è¾“å…¥
    æ€è€ƒæ­¥éª¤: List[str]        # ç´¯ç§¯çš„æ¨ç†è¿‡ç¨‹
    æœ€ç»ˆç­”æ¡ˆ: str              # è¾“å‡º

# èŠ‚ç‚¹1ï¼šåˆ†æé—®é¢˜
def åˆ†æé—®é¢˜(state):
    é—®é¢˜ = state["é—®é¢˜"]
    åˆ†æ = f"åˆ†æï¼š{é—®é¢˜}æ¶‰åŠæ•°å­¦è®¡ç®—"
    return {"æ€è€ƒæ­¥éª¤": [åˆ†æ]}  # ç¬¬ä¸€ä¸ªæ€è€ƒæ­¥éª¤

# èŠ‚ç‚¹2ï¼šåˆ¶å®šæ–¹æ¡ˆ
def åˆ¶å®šæ–¹æ¡ˆ(state):
    æ–¹æ¡ˆ = "æ–¹æ¡ˆï¼šå…ˆè®¡ç®—å­é—®é¢˜ï¼Œå†æ±‡æ€»"
    return {"æ€è€ƒæ­¥éª¤": [æ–¹æ¡ˆ]}  # ä¼šå’Œä¹‹å‰çš„åˆå¹¶ï¼ˆå¦‚æœç”¨ Reducerï¼‰

# èŠ‚ç‚¹3ï¼šæ‰§è¡Œè®¡ç®—
def æ‰§è¡Œè®¡ç®—(state):
    æ­¥éª¤ = state["æ€è€ƒæ­¥éª¤"]  # è¯»å–ä¹‹å‰çš„æ¨ç†
    è®¡ç®— = "æ‰§è¡Œï¼š2 + 2 = 4"
    return {
        "æ€è€ƒæ­¥éª¤": [è®¡ç®—],
        "æœ€ç»ˆç­”æ¡ˆ": "4"
    }

# æ„å»ºå›¾
graph = StateGraph(ReasoningState)
graph.add_node("åˆ†æ", åˆ†æé—®é¢˜)
graph.add_node("æ–¹æ¡ˆ", åˆ¶å®šæ–¹æ¡ˆ)
graph.add_node("è®¡ç®—", æ‰§è¡Œè®¡ç®—)
graph.add_edge(START, "åˆ†æ")
graph.add_edge("åˆ†æ", "æ–¹æ¡ˆ")
graph.add_edge("æ–¹æ¡ˆ", "è®¡ç®—")
graph.add_edge("è®¡ç®—", END)

# è¿è¡Œ
result = graph.compile().invoke({"é—®é¢˜": "2 + 2 = ?"})

# ç»“æœ
{
    "é—®é¢˜": "2 + 2 = ?",
    "æ€è€ƒæ­¥éª¤": [
        "åˆ†æï¼š2 + 2 = ?æ¶‰åŠæ•°å­¦è®¡ç®—",
        "æ–¹æ¡ˆï¼šå…ˆè®¡ç®—å­é—®é¢˜ï¼Œå†æ±‡æ€»",
        "æ‰§è¡Œï¼š2 + 2 = 4"
    ],
    "æœ€ç»ˆç­”æ¡ˆ": "4"
}
```

**ç”Ÿæˆçš„æµç¨‹å›¾ï¼š**

![Flow Diagram](images/sub-graph-output-13-0.png)


---

**State è°ƒè¯•æŠ€å·§**

1. **æ‰“å°çŠ¶æ€å˜åŒ–**
```python
def è°ƒè¯•èŠ‚ç‚¹(state):
    print(f"å½“å‰çŠ¶æ€ï¼š{state}")
    # ä½ çš„é€»è¾‘
    result = {"æ–°å­—æ®µ": "å€¼"}
    print(f"è¿”å›æ•°æ®ï¼š{result}")
    return result
```

2. **ä½¿ç”¨ LangSmith è¿½è¸ª**
```python
# åœ¨ LangSmith ä¸­å¯ä»¥çœ‹åˆ°æ¯ä¸ªèŠ‚ç‚¹åçš„ State å¿«ç…§
# å¸®åŠ©ç†è§£æ•°æ®æµåŠ¨
```

3. **å•å…ƒæµ‹è¯•èŠ‚ç‚¹**
```python
# å•ç‹¬æµ‹è¯•èŠ‚ç‚¹å‡½æ•°
def test_èŠ‚ç‚¹():
    mock_state = {"è¾“å…¥": "æµ‹è¯•æ•°æ®"}
    result = èŠ‚ç‚¹å‡½æ•°(mock_state)
    assert result == {"æœŸæœ›è¾“å‡º": "..."}
```

---

**æ€»ç»“ï¼šState çš„æœ¬è´¨**

1. **State æ˜¯æ•°æ®çš„æµæ°´è´¦**
   - è®°å½•ä»å¼€å§‹åˆ°ç°åœ¨çš„æ‰€æœ‰æ•°æ®
   - æ¯ä¸ªèŠ‚ç‚¹éƒ½å¾€ä¸Šæ·»åŠ æ–°æ•°æ®

2. **State æ˜¯èŠ‚ç‚¹é—´çš„ä¼ çº¸æ¡**
   - èŠ‚ç‚¹é€šè¿‡ State é€šä¿¡
   - å‰ä¸€ä¸ªèŠ‚ç‚¹å†™ï¼Œåä¸€ä¸ªèŠ‚ç‚¹è¯»

3. **State éœ€è¦ç²¾å¿ƒè®¾è®¡**
   - åªåŒ…å«å¿…è¦å­—æ®µ
   - å¤æ‚çŠ¶æ€ç”¨å­å›¾éš”ç¦»
   - ç”¨ output_schema æ§åˆ¶è¾“å‡º

4. **State æ”¯æŒçµæ´»çš„åˆå¹¶ç­–ç•¥**
   - é»˜è®¤è¦†ç›–
   - ç”¨ Reducer è‡ªå®šä¹‰ï¼ˆå¦‚åˆ—è¡¨åˆå¹¶ï¼‰

**è®°ä½è¿™ä¸ªå…¬å¼**ï¼š
```
LangGraph = èŠ‚ç‚¹ï¼ˆå¤„ç†é€»è¾‘ï¼‰ + è¾¹ï¼ˆæ‰§è¡Œé¡ºåºï¼‰ + Stateï¼ˆæ•°æ®æµåŠ¨ï¼‰
```

State æ˜¯ä¸‰è€…ä¸­æœ€æ ¸å¿ƒçš„ï¼Œç†è§£äº† Stateï¼Œå°±ç†è§£äº† LangGraph çš„è¿ä½œåŸç†ï¼

---

## å®Œæ•´æ¡ˆä¾‹ä»£ç ï¼ˆå¯ç›´æ¥è¿è¡Œï¼‰

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„å­å›¾ç¤ºä¾‹ï¼Œå±•ç¤ºäº†æ—¥å¿—åˆ†æç³»ç»Ÿçš„æ¨¡å—åŒ–è®¾è®¡ï¼š

```python
"""
LangGraph å­å›¾ï¼ˆSub-graphï¼‰å®Œæ•´ç¤ºä¾‹
æ¼”ç¤ºçŠ¶æ€éš”ç¦»ã€output_schema å’Œå¹¶è¡Œå­å›¾

åœºæ™¯ï¼šæ—¥å¿—åˆ†æç³»ç»Ÿ
- å­å›¾1ï¼šå¤±è´¥åˆ†æ - åˆ†æé”™è¯¯æ—¥å¿—ï¼Œç”Ÿæˆé”™è¯¯æ‘˜è¦
- å­å›¾2ï¼šæ€§èƒ½åˆ†æ - åˆ†ææ…¢è¯·æ±‚ï¼Œç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
- ä¸»å›¾ï¼šæ•´åˆä¸¤ä¸ªå­å›¾çš„ç»“æœ
"""

from typing_extensions import TypedDict
from typing import List, Optional, Annotated
from operator import add
from langgraph.graph import StateGraph, START, END

# ========== 1. æ•°æ®æ¨¡å‹å®šä¹‰ ==========

class Log(TypedDict):
    """æ—¥å¿—æ•°æ®æ¨¡å‹"""
    id: str              # æ—¥å¿— ID
    question: str        # ç”¨æˆ·é—®é¢˜
    answer: str          # ç³»ç»Ÿå›ç­”
    status: str          # çŠ¶æ€: success / error
    latency: int         # å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    error_type: Optional[str]  # é”™è¯¯ç±»å‹ï¼ˆå¯é€‰ï¼‰

# ========== 2. å­å›¾1ï¼šå¤±è´¥åˆ†æ ==========

# å­å›¾å†…éƒ¨çŠ¶æ€ï¼ˆå®Œæ•´çŠ¶æ€ï¼‰
class FailureAnalysisState(TypedDict):
    cleaned_logs: List[Log]   # è¾“å…¥ï¼šæ¸…æ´—åçš„æ—¥å¿—
    failures: List[Log]       # ä¸­é—´å˜é‡ï¼šå¤±è´¥çš„æ—¥å¿—
    fa_summary: str           # è¾“å‡ºï¼šå¤±è´¥åˆ†ææ‘˜è¦
    processed_logs: List[str] # è¾“å‡ºï¼šå¤„ç†è¿‡çš„æ—¥å¿— ID

# å­å›¾è¾“å‡ºçŠ¶æ€ï¼ˆåªè¿”å›éœ€è¦çš„å­—æ®µï¼‰
class FailureAnalysisOutputState(TypedDict):
    fa_summary: str           # åªè¾“å‡ºæ‘˜è¦
    processed_logs: List[str] # åªè¾“å‡ºå¤„ç†è®°å½•

def get_failures(state: FailureAnalysisState):
    """è·å–å¤±è´¥çš„æ—¥å¿—"""
    cleaned_logs = state["cleaned_logs"]

    # ç­›é€‰å‡ºçŠ¶æ€ä¸º error çš„æ—¥å¿—
    failures = [log for log in cleaned_logs if log.get("status") == "error"]

    print(f"ğŸ” å¤±è´¥åˆ†æï¼šæ‰¾åˆ° {len(failures)} æ¡é”™è¯¯æ—¥å¿—")
    return {"failures": failures}

def generate_failure_summary(state: FailureAnalysisState):
    """ç”Ÿæˆå¤±è´¥åˆ†ææ‘˜è¦"""
    failures = state["failures"]

    if not failures:
        summary = "æ²¡æœ‰å‘ç°é”™è¯¯æ—¥å¿—"
    else:
        # ç»Ÿè®¡é”™è¯¯ç±»å‹
        error_types = {}
        for log in failures:
            error_type = log.get("error_type", "unknown")
            error_types[error_type] = error_types.get(error_type, 0) + 1

        # ç”Ÿæˆæ‘˜è¦
        summary = f"å‘ç° {len(failures)} ä¸ªé”™è¯¯ã€‚"
        summary += f" é”™è¯¯ç±»å‹åˆ†å¸ƒ: {error_types}"

    # è®°å½•å¤„ç†è¿‡çš„æ—¥å¿— ID
    processed_logs = [
        f"failure-analysis-on-log-{failure['id']}"
        for failure in failures
    ]

    print(f"ğŸ“ å¤±è´¥åˆ†ææ‘˜è¦ç”Ÿæˆå®Œæˆ")
    return {
        "fa_summary": summary,
        "processed_logs": processed_logs
    }

# æ„å»ºå¤±è´¥åˆ†æå­å›¾
fa_builder = StateGraph(
    state_schema=FailureAnalysisState,
    output_schema=FailureAnalysisOutputState  # â­ åªè¿”å›æŒ‡å®šå­—æ®µ
)

fa_builder.add_node("get_failures", get_failures)
fa_builder.add_node("generate_summary", generate_failure_summary)

fa_builder.add_edge(START, "get_failures")
fa_builder.add_edge("get_failures", "generate_summary")
fa_builder.add_edge("generate_summary", END)

# ========== 3. å­å›¾2ï¼šæ€§èƒ½åˆ†æ ==========

# å­å›¾å†…éƒ¨çŠ¶æ€ï¼ˆå®Œæ•´çŠ¶æ€ï¼‰
class PerformanceAnalysisState(TypedDict):
    cleaned_logs: List[Log]   # è¾“å…¥
    slow_logs: List[Log]      # ä¸­é—´å˜é‡ï¼šæ…¢è¯·æ±‚
    latency_stats: dict       # ä¸­é—´å˜é‡ï¼šå»¶è¿Ÿç»Ÿè®¡
    perf_report: str          # è¾“å‡ºï¼šæ€§èƒ½æŠ¥å‘Š
    processed_logs: List[str] # è¾“å‡ºï¼šå¤„ç†è®°å½•

# å­å›¾è¾“å‡ºçŠ¶æ€
class PerformanceAnalysisOutputState(TypedDict):
    perf_report: str          # åªè¾“å‡ºæŠ¥å‘Š
    processed_logs: List[str] # åªè¾“å‡ºå¤„ç†è®°å½•

def get_slow_logs(state: PerformanceAnalysisState):
    """è·å–æ…¢è¯·æ±‚æ—¥å¿—ï¼ˆå»¶è¿Ÿ > 1000msï¼‰"""
    cleaned_logs = state["cleaned_logs"]

    slow_logs = [log for log in cleaned_logs if log.get("latency", 0) > 1000]

    print(f"ğŸ¢ æ€§èƒ½åˆ†æï¼šæ‰¾åˆ° {len(slow_logs)} æ¡æ…¢è¯·æ±‚")
    return {"slow_logs": slow_logs}

def calculate_stats(state: PerformanceAnalysisState):
    """è®¡ç®—å»¶è¿Ÿç»Ÿè®¡"""
    slow_logs = state["slow_logs"]

    if slow_logs:
        latencies = [log["latency"] for log in slow_logs]
        stats = {
            "count": len(latencies),
            "avg": sum(latencies) / len(latencies),
            "max": max(latencies),
            "min": min(latencies)
        }
    else:
        stats = {"count": 0, "avg": 0, "max": 0, "min": 0}

    return {"latency_stats": stats}

def generate_performance_report(state: PerformanceAnalysisState):
    """ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š"""
    stats = state["latency_stats"]
    slow_logs = state["slow_logs"]

    report = f"æ€§èƒ½æŠ¥å‘Šï¼š\n"
    report += f"- æ…¢è¯·æ±‚æ•°é‡: {stats['count']}\n"
    report += f"- å¹³å‡å»¶è¿Ÿ: {stats['avg']:.0f}ms\n"
    report += f"- æœ€å¤§å»¶è¿Ÿ: {stats['max']}ms\n"
    report += f"- æœ€å°å»¶è¿Ÿ: {stats['min']}ms"

    # è®°å½•å¤„ç†çš„æ—¥å¿—
    processed_logs = [
        f"performance-analysis-on-log-{log['id']}"
        for log in slow_logs
    ]

    print(f"ğŸ“Š æ€§èƒ½æŠ¥å‘Šç”Ÿæˆå®Œæˆ")
    return {
        "perf_report": report,
        "processed_logs": processed_logs
    }

# æ„å»ºæ€§èƒ½åˆ†æå­å›¾
pa_builder = StateGraph(
    PerformanceAnalysisState,
    output_schema=PerformanceAnalysisOutputState
)

pa_builder.add_node("get_slow_logs", get_slow_logs)
pa_builder.add_node("calculate_stats", calculate_stats)
pa_builder.add_node("generate_report", generate_performance_report)

pa_builder.add_edge(START, "get_slow_logs")
pa_builder.add_edge("get_slow_logs", "calculate_stats")
pa_builder.add_edge("calculate_stats", "generate_report")
pa_builder.add_edge("generate_report", END)

# ========== 4. ä¸»å›¾ï¼šæ•´åˆå­å›¾ ==========

class MainGraphState(TypedDict):
    raw_logs: List[Log]                       # è¾“å…¥ï¼šåŸå§‹æ—¥å¿—
    cleaned_logs: List[Log]                   # æ¸…æ´—åçš„æ—¥å¿—
    fa_summary: str                           # æ¥è‡ªå¤±è´¥åˆ†æå­å›¾
    perf_report: str                          # æ¥è‡ªæ€§èƒ½åˆ†æå­å›¾
    processed_logs: Annotated[List[str], add] # æ¥è‡ªä¸¤ä¸ªå­å›¾ï¼Œéœ€è¦åˆå¹¶
    final_output: str                         # æœ€ç»ˆè¾“å‡º

def clean_logs(state: MainGraphState):
    """æ¸…æ´—æ—¥å¿—"""
    raw_logs = state["raw_logs"]

    # ç®€å•æ¸…æ´—ï¼šè¿‡æ»¤æ— æ•ˆæ—¥å¿—
    cleaned_logs = [log for log in raw_logs if log.get("id")]

    print(f"ğŸ§¹ æ—¥å¿—æ¸…æ´—å®Œæˆï¼š{len(raw_logs)} â†’ {len(cleaned_logs)} æ¡")
    return {"cleaned_logs": cleaned_logs}

def finalize_report(state: MainGraphState):
    """ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š"""
    fa_summary = state.get("fa_summary", "æ— ")
    perf_report = state.get("perf_report", "æ— ")
    processed_logs = state.get("processed_logs", [])

    final_output = f"""
{'=' * 50}
ğŸ“‹ æ—¥å¿—åˆ†ææœ€ç»ˆæŠ¥å‘Š
{'=' * 50}

ã€å¤±è´¥åˆ†æã€‘
{fa_summary}

ã€æ€§èƒ½åˆ†æã€‘
{perf_report}

ã€å¤„ç†è®°å½•ã€‘
å…±å¤„ç† {len(processed_logs)} æ¡æ—¥å¿—:
{chr(10).join(['  - ' + log for log in processed_logs])}
{'=' * 50}
"""

    print("âœ… æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆå®Œæˆ")
    return {"final_output": final_output}

# æ„å»ºä¸»å›¾
def build_main_graph():
    """æ„å»ºä¸»å›¾"""
    main_builder = StateGraph(MainGraphState)

    # æ·»åŠ å¸¸è§„èŠ‚ç‚¹
    main_builder.add_node("clean_logs", clean_logs)

    # â­ å°†ç¼–è¯‘åçš„å­å›¾ä½œä¸ºèŠ‚ç‚¹æ·»åŠ 
    main_builder.add_node("failure_analysis", fa_builder.compile())
    main_builder.add_node("performance_analysis", pa_builder.compile())

    # æ·»åŠ æœ€ç»ˆå¤„ç†èŠ‚ç‚¹
    main_builder.add_node("finalize", finalize_report)

    # å®šä¹‰æ‰§è¡Œæµç¨‹
    main_builder.add_edge(START, "clean_logs")

    # å¹¶è¡Œæ‰§è¡Œä¸¤ä¸ªå­å›¾
    main_builder.add_edge("clean_logs", "failure_analysis")
    main_builder.add_edge("clean_logs", "performance_analysis")

    # æ±‡èšåˆ°æœ€ç»ˆèŠ‚ç‚¹
    main_builder.add_edge("failure_analysis", "finalize")
    main_builder.add_edge("performance_analysis", "finalize")
    main_builder.add_edge("finalize", END)

    return main_builder.compile()

# ========== 5. ä¸»ç¨‹åº ==========

if __name__ == "__main__":
    # æ„å»ºå›¾
    graph = build_main_graph()

    # å¯è§†åŒ–å›¾ç»“æ„
    print("=" * 50)
    print("ğŸ“Š å›¾ç»“æ„å¯è§†åŒ–")
    print("=" * 50)

    try:
        from IPython.display import Image, display
        # å±•å¼€å­å›¾å†…éƒ¨ç»“æ„
        display(Image(graph.get_graph(xray=1).draw_mermaid_png()))
    except Exception:
        print(graph.get_graph().draw_mermaid())

    # å‡†å¤‡æµ‹è¯•æ•°æ®
    test_logs: List[Log] = [
        {
            "id": "1",
            "question": "How to use LangGraph?",
            "answer": "LangGraph is a framework for building AI applications.",
            "status": "success",
            "latency": 500,
            "error_type": None
        },
        {
            "id": "2",
            "question": "How to use Chroma?",
            "answer": "Error: Connection timeout",
            "status": "error",
            "latency": 5000,
            "error_type": "timeout"
        },
        {
            "id": "3",
            "question": "What is RAG?",
            "answer": "RAG stands for Retrieval Augmented Generation.",
            "status": "success",
            "latency": 300,
            "error_type": None
        },
        {
            "id": "4",
            "question": "How to build agents?",
            "answer": "Error: Rate limit exceeded",
            "status": "error",
            "latency": 2000,
            "error_type": "rate_limit"
        },
        {
            "id": "5",
            "question": "Explain state management",
            "answer": "State management in LangGraph uses TypedDict...",
            "status": "success",
            "latency": 1500,
            "error_type": None
        }
    ]

    # æ‰§è¡Œå›¾
    print("\n" + "=" * 50)
    print("ğŸš€ æ‰§è¡Œæ—¥å¿—åˆ†æ")
    print("=" * 50 + "\n")

    result = graph.invoke({"raw_logs": test_logs})

    # è¾“å‡ºæœ€ç»ˆæŠ¥å‘Š
    print(result["final_output"])

    # éªŒè¯çŠ¶æ€éš”ç¦»
    print("\nğŸ“ çŠ¶æ€éš”ç¦»éªŒè¯:")
    print(f"  - ä¸»å›¾çŠ¶æ€ä¸­çš„å­—æ®µ: {list(result.keys())}")
    print(f"  - å­å›¾ä¸­é—´å˜é‡ 'failures' åœ¨ä¸»å›¾ä¸­: {'failures' in result}")
    print(f"  - å­å›¾ä¸­é—´å˜é‡ 'slow_logs' åœ¨ä¸»å›¾ä¸­: {'slow_logs' in result}")
```

### è¿è¡Œç»“æœç¤ºä¾‹

```
==================================================
ğŸ“Š å›¾ç»“æ„å¯è§†åŒ–
==================================================
(å›¾ç»“æ„å±•ç¤º)

==================================================
ğŸš€ æ‰§è¡Œæ—¥å¿—åˆ†æ
==================================================

ğŸ§¹ æ—¥å¿—æ¸…æ´—å®Œæˆï¼š5 â†’ 5 æ¡
ğŸ” å¤±è´¥åˆ†æï¼šæ‰¾åˆ° 2 æ¡é”™è¯¯æ—¥å¿—
ğŸ“ å¤±è´¥åˆ†ææ‘˜è¦ç”Ÿæˆå®Œæˆ
ğŸ¢ æ€§èƒ½åˆ†æï¼šæ‰¾åˆ° 2 æ¡æ…¢è¯·æ±‚
ğŸ“Š æ€§èƒ½æŠ¥å‘Šç”Ÿæˆå®Œæˆ
âœ… æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆå®Œæˆ

==================================================
ğŸ“‹ æ—¥å¿—åˆ†ææœ€ç»ˆæŠ¥å‘Š
==================================================

ã€å¤±è´¥åˆ†æã€‘
å‘ç° 2 ä¸ªé”™è¯¯ã€‚ é”™è¯¯ç±»å‹åˆ†å¸ƒ: {'timeout': 1, 'rate_limit': 1}

ã€æ€§èƒ½åˆ†æã€‘
æ€§èƒ½æŠ¥å‘Šï¼š
- æ…¢è¯·æ±‚æ•°é‡: 2
- å¹³å‡å»¶è¿Ÿ: 3500ms
- æœ€å¤§å»¶è¿Ÿ: 5000ms
- æœ€å°å»¶è¿Ÿ: 2000ms

ã€å¤„ç†è®°å½•ã€‘
å…±å¤„ç† 4 æ¡æ—¥å¿—:
  - failure-analysis-on-log-2
  - failure-analysis-on-log-4
  - performance-analysis-on-log-2
  - performance-analysis-on-log-5
==================================================

ğŸ“ çŠ¶æ€éš”ç¦»éªŒè¯:
  - ä¸»å›¾çŠ¶æ€ä¸­çš„å­—æ®µ: ['raw_logs', 'cleaned_logs', 'fa_summary', 'perf_report', 'processed_logs', 'final_output']
  - å­å›¾ä¸­é—´å˜é‡ 'failures' åœ¨ä¸»å›¾ä¸­: False
  - å­å›¾ä¸­é—´å˜é‡ 'slow_logs' åœ¨ä¸»å›¾ä¸­: False
```

### æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾

| æ¦‚å¿µ | è¯´æ˜ | ä»£ç ç¤ºä¾‹ |
|------|------|----------|
| **state_schema** | å­å›¾å†…éƒ¨å®Œæ•´çŠ¶æ€ | `StateGraph(FullState)` |
| **output_schema** | å­å›¾è¿”å›ç»™ä¸»å›¾çš„å­—æ®µ | `StateGraph(FullState, output_schema=OutputState)` |
| **çŠ¶æ€éš”ç¦»** | ä¸­é—´å˜é‡ä¸æ³„éœ²åˆ°ä¸»å›¾ | `failures` ä¸åœ¨ä¸»å›¾çŠ¶æ€ä¸­ |
| **åŒåå­—æ®µé€šä¿¡** | ä¸»å›¾å’Œå­å›¾é€šè¿‡åŒåå­—æ®µä¼ é€’æ•°æ® | `cleaned_logs` è‡ªåŠ¨ä¼ é€’ |
| **å­å›¾ä½œä¸ºèŠ‚ç‚¹** | ç¼–è¯‘åçš„å­å›¾å¯åµŒå…¥ä¸»å›¾ | `add_node("name", sub_graph.compile())` |
| **å¹¶è¡Œå­å›¾** | ä½¿ç”¨ Reducer åˆå¹¶ç»“æœ | `Annotated[List[str], add]` |
