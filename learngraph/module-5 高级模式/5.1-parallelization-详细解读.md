# LangGraph å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œè¯¦ç»†è§£è¯»

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£è¯» LangGraph ä¸­çš„**å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ**ï¼ˆParallelizationï¼‰æœºåˆ¶ã€‚è¿™æ˜¯æ„å»ºé«˜æ•ˆå¤šæ™ºèƒ½ä½“ç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€ï¼Œèƒ½è®©å¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå¤§å¹…æå‡æ€§èƒ½ã€‚

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **Parallelizationï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰** | è®©å¤šä¸ªèŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´æ­¥ï¼ˆstepï¼‰å†…åŒæ—¶è¿è¡Œçš„æ‰§è¡Œæ¨¡å¼ | åˆ©ç”¨å¤šæ ¸æˆ–å¼‚æ­¥æœºåˆ¶åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œæå‡å¤„ç†æ•ˆç‡ | â­â­â­â­â­ |
| **Fan-outï¼ˆæ‰‡å‡ºï¼‰** | ä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºåˆ†å‘åˆ°å¤šä¸ªå¹¶è¡ŒèŠ‚ç‚¹çš„æ¨¡å¼ | å°†å•ä¸ªæ•°æ®æºåˆ†å‘åˆ°å¤šä¸ªå¤„ç†å•å…ƒçš„è®¾è®¡æ¨¡å¼ | â­â­â­â­â­ |
| **Fan-inï¼ˆæ‰‡å…¥ï¼‰** | å¤šä¸ªå¹¶è¡ŒèŠ‚ç‚¹çš„è¾“å‡ºæ±‡èšåˆ°ä¸€ä¸ªèŠ‚ç‚¹çš„æ¨¡å¼ | å°†å¤šä¸ªå¤„ç†ç»“æœåˆå¹¶åˆ°å•ä¸€å¤„ç†å•å…ƒçš„è®¾è®¡æ¨¡å¼ | â­â­â­â­â­ |
| **Reducer** | å®šä¹‰å¦‚ä½•åˆå¹¶å¤šä¸ªå¹¶è¡Œæ›´æ–°çš„å‡½æ•°ï¼Œé€šè¿‡ `Annotated` æŒ‡å®š | æ¥æ”¶ä¸¤ä¸ªå‚æ•°å¹¶è¿”å›åˆå¹¶ç»“æœçš„çº¯å‡½æ•° | â­â­â­â­â­ |
| **Annotated** | Python ç±»å‹æ³¨è§£å·¥å…·ï¼Œç”¨äºä¸ºç±»å‹æ·»åŠ å…ƒæ•°æ®ï¼ˆå¦‚ reducerï¼‰ | `from typing import Annotated`ï¼Œæ ¼å¼ï¼š`Annotated[ç±»å‹, å…ƒæ•°æ®]` | â­â­â­â­ |
| **operator.add** | Python å†…ç½®çš„åŠ æ³•è¿ç®—ç¬¦å‡½æ•°ï¼Œå¸¸ç”¨ä½œåˆ—è¡¨æ‹¼æ¥çš„ reducer | `operator.add([1, 2], [3, 4])` è¿”å› `[1, 2, 3, 4]` | â­â­â­â­ |
| **Stepï¼ˆæ‰§è¡Œæ­¥éª¤ï¼‰** | LangGraph æ‰§è¡Œæµç¨‹çš„åŸºæœ¬å•ä½ï¼Œå¹¶è¡ŒèŠ‚ç‚¹åœ¨åŒä¸€ step ä¸­æ‰§è¡Œ | å›¾æ‰§è¡Œçš„ä¸€ä¸ªé€»è¾‘æ—¶åˆ»ï¼ŒåŒä¸€ step çš„èŠ‚ç‚¹å¯å¹¶å‘è¿è¡Œ | â­â­â­â­ |
| **TypedDict** | å®šä¹‰å­—å…¸ç»“æ„å’Œç±»å‹çš„ Python å·¥å…·ç±» | `from typing_extensions import TypedDict`ï¼Œæä¾›ç±»å‹æ£€æŸ¥å’Œ IDE è¡¥å…¨ | â­â­â­ |
| **InvalidUpdateError** | å½“å¹¶è¡ŒèŠ‚ç‚¹è¯•å›¾æ›´æ–°åŒä¸€ state é”®ä½†æœªæŒ‡å®š reducer æ—¶æŠ›å‡ºçš„é”™è¯¯ | LangGraph ç‰¹å®šå¼‚å¸¸ï¼Œæç¤ºéœ€è¦ä½¿ç”¨ `Annotated` å’Œ reducer | â­â­â­â­ |
| **Callable Classï¼ˆå¯è°ƒç”¨ç±»ï¼‰** | å®ç° `__call__` æ–¹æ³•çš„ç±»ï¼Œå®ä¾‹å¯ä»¥åƒå‡½æ•°ä¸€æ ·è°ƒç”¨ | é€šè¿‡ `def __call__(self, *args)` ä½¿å¯¹è±¡å¯è¢«è°ƒç”¨ | â­â­â­ |

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯å¹¶è¡Œæ‰§è¡Œï¼Ÿ

åœ¨ LangGraph ä¸­ï¼Œå¹¶è¡Œæ‰§è¡ŒæŒ‡çš„æ˜¯è®©å¤šä¸ªèŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´æ­¥ï¼ˆstepï¼‰å†…åŒæ—¶è¿è¡Œï¼Œè€Œä¸æ˜¯æŒ‰é¡ºåºä¸€ä¸ªæ¥ä¸€ä¸ªæ‰§è¡Œã€‚è¿™ç§æ¨¡å¼å¸¸è¢«ç§°ä¸º **Fan-outï¼ˆæ‰‡å‡ºï¼‰å’Œ Fan-inï¼ˆæ‰‡å…¥ï¼‰**ï¼š

- **Fan-outï¼ˆæ‰‡å‡ºï¼‰**ï¼šä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºåˆ†å‘åˆ°å¤šä¸ªå¹¶è¡ŒèŠ‚ç‚¹
- **Fan-inï¼ˆæ‰‡å…¥ï¼‰**ï¼šå¤šä¸ªå¹¶è¡ŒèŠ‚ç‚¹çš„è¾“å‡ºæ±‡èšåˆ°ä¸€ä¸ªèŠ‚ç‚¹

---

## ğŸ”§ åŸºç¡€ç¤ºä¾‹ï¼šçº¿æ€§æ‰§è¡Œ vs å¹¶è¡Œæ‰§è¡Œ

### 1. çº¿æ€§æ‰§è¡Œå›¾ï¼ˆSequentialï¼‰

é¦–å…ˆçœ‹ä¸€ä¸ªç®€å•çš„çº¿æ€§æ‰§è¡Œç¤ºä¾‹ï¼š

```python
from typing import Any
from typing_extensions import TypedDict
from langgraph.graph import StateGraph, START, END

class State(TypedDict):
    state: str

class ReturnNodeValue:
    def __init__(self, node_secret: str):
        self._value = node_secret

    def __call__(self, state: State) -> Any:
        print(f"Adding {self._value} to {state['state']}")
        return {"state": [self._value]}

# æ„å»ºå›¾
builder = StateGraph(State)
builder.add_node("a", ReturnNodeValue("I'm A"))
builder.add_node("b", ReturnNodeValue("I'm B"))
builder.add_node("c", ReturnNodeValue("I'm C"))
builder.add_node("d", ReturnNodeValue("I'm D"))

# çº¿æ€§æµç¨‹ï¼šSTART â†’ a â†’ b â†’ c â†’ d â†’ END
builder.add_edge(START, "a")
builder.add_edge("a", "b")
builder.add_edge("b", "c")
builder.add_edge("c", "d")
builder.add_edge("d", END)

graph = builder.compile()

# ğŸ¨ å¯è§†åŒ–å›¾ç»“æ„
from IPython.display import Image, display
display(Image(graph.get_graph().draw_mermaid_png()))
```

**æ‰§è¡Œç»“æœï¼š**
```
Adding I'm A to []
Adding I'm B to ["I'm A"]
Adding I'm C to ["I'm B"]
Adding I'm D to ["I'm C"]

{'state': ["I'm D"]}
```

**åˆ†æï¼š** æ¯ä¸ªèŠ‚ç‚¹æŒ‰é¡ºåºæ‰§è¡Œï¼Œåä¸€ä¸ªèŠ‚ç‚¹ä¼š**è¦†ç›–**å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ã€‚

---

### 2. å¹¶è¡Œæ‰§è¡Œå›¾ï¼ˆParallelï¼‰- é‡åˆ°é—®é¢˜ï¼

ç°åœ¨è®©æˆ‘ä»¬å°è¯•è®© `b` å’Œ `c` å¹¶è¡Œæ‰§è¡Œï¼š

```python
builder = StateGraph(State)
builder.add_node("a", ReturnNodeValue("I'm A"))
builder.add_node("b", ReturnNodeValue("I'm B"))
builder.add_node("c", ReturnNodeValue("I'm C"))
builder.add_node("d", ReturnNodeValue("I'm D"))

# å¹¶è¡Œæµç¨‹ï¼ša æ‰‡å‡ºåˆ° b å’Œ cï¼Œç„¶åæ‰‡å…¥åˆ° d
builder.add_edge(START, "a")
builder.add_edge("a", "b")  # a â†’ b
builder.add_edge("a", "c")  # a â†’ cï¼ˆå¹¶è¡Œï¼‰
builder.add_edge("b", "d")  # b â†’ d
builder.add_edge("c", "d")  # c â†’ d
builder.add_edge("d", END)

graph = builder.compile()

# ğŸ¨ å¯è§†åŒ–å›¾ç»“æ„
from IPython.display import Image, display
display(Image(graph.get_graph().draw_mermaid_png()))
```

**æ‰§è¡Œæ—¶ä¼šæŠ¥é”™ï¼**

```
Adding I'm A to []
Adding I'm B to ["I'm A"]
Adding I'm C to ["I'm A"]
An error occurred: At key 'state': Can receive only one value per step.
Use an Annotated key to handle multiple values.
```

**ä¸ºä»€ä¹ˆä¼šæŠ¥é”™ï¼Ÿ**

å› ä¸ºåœ¨åŒä¸€ä¸ªæ—¶é—´æ­¥ï¼ˆstepï¼‰å†…ï¼Œ`b` å’Œ `c` éƒ½è¯•å›¾æ›´æ–° `state` è¿™ä¸ªé”®ã€‚LangGraph ä¸çŸ¥é“å¦‚ä½•åˆå¹¶è¿™ä¸¤ä¸ªæ›´æ–°ï¼Œæ‰€ä»¥æŠ›å‡º `InvalidUpdateError` é”™è¯¯ã€‚

---

## ğŸ”‘ è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Reducer

### ä»€ä¹ˆæ˜¯ Reducerï¼Ÿ

**Reducer** æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå®šä¹‰å¦‚ä½•åˆå¹¶å¤šä¸ªå¹¶è¡Œæ›´æ–°ã€‚åœ¨ Python ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `Annotated` ç±»å‹æç¤ºæ¥æŒ‡å®š reducerã€‚

### Python çŸ¥è¯†ç‚¹ï¼š`Annotated` ç±»å‹æç¤º

`Annotated` æ˜¯ Python 3.9+ å¼•å…¥çš„ç±»å‹æç¤ºå·¥å…·ï¼Œå…è®¸æˆ‘ä»¬ä¸ºç±»å‹æ·»åŠ å…ƒæ•°æ®ï¼š

```python
from typing import Annotated
import operator

# è¯­æ³•ï¼šAnnotated[ç±»å‹, å…ƒæ•°æ®]
state: Annotated[list, operator.add]
#      ^^^^^^^^  ^^^^  ^^^^^^^^^^^^^
#      å…³é”®å­—    ç±»å‹   reducer å‡½æ•°
```

### ä½¿ç”¨ `operator.add` ä½œä¸º Reducer

`operator.add` æ˜¯ Python å†…ç½®çš„åŠ æ³•è¿ç®—ç¬¦å‡½æ•°ã€‚å¯¹äºåˆ—è¡¨ï¼Œå®ƒæ‰§è¡Œ**åˆ—è¡¨æ‹¼æ¥**ï¼š

```python
import operator

# operator.add å¯¹åˆ—è¡¨çš„ä½œç”¨
result = operator.add([1, 2], [3, 4])  # ç»“æœ: [1, 2, 3, 4]
```

**ä¿®å¤åçš„ä»£ç ï¼š**

```python
import operator
from typing import Annotated

class State(TypedDict):
    # ä½¿ç”¨ operator.add ä½œä¸º reducerï¼Œè®© state æ”¯æŒè¿½åŠ 
    state: Annotated[list, operator.add]

# æ„å»ºå›¾ï¼ˆç»“æ„åŒä¸Šï¼‰
builder = StateGraph(State)
builder.add_node("a", ReturnNodeValue("I'm A"))
builder.add_node("b", ReturnNodeValue("I'm B"))
builder.add_node("c", ReturnNodeValue("I'm C"))
builder.add_node("d", ReturnNodeValue("I'm D"))

builder.add_edge(START, "a")
builder.add_edge("a", "b")
builder.add_edge("a", "c")
builder.add_edge("b", "d")
builder.add_edge("c", "d")
builder.add_edge("d", END)

graph = builder.compile()

# ğŸ¨ å¯è§†åŒ–å›¾ç»“æ„
from IPython.display import Image, display
display(Image(graph.get_graph().draw_mermaid_png()))
```

**æ‰§è¡Œç»“æœï¼š**
```
Adding I'm A to []
Adding I'm B to ["I'm A"]
Adding I'm C to ["I'm A"]
Adding I'm D to ["I'm A", "I'm B", "I'm C"]

{'state': ["I'm A", "I'm B", "I'm C", "I'm D"]}
```

**âœ… æˆåŠŸï¼** ç°åœ¨ `b` å’Œ `c` çš„æ›´æ–°éƒ½è¢«ä¿ç•™äº†ï¼Œå®ƒä»¬çš„ç»“æœè¢«æ‹¼æ¥åˆ° `state` åˆ—è¡¨ä¸­ã€‚

---

## â³ ç­‰å¾…å¹¶è¡ŒèŠ‚ç‚¹å®Œæˆ

### ä¸åŒé•¿åº¦çš„å¹¶è¡Œè·¯å¾„

å½“å¹¶è¡Œè·¯å¾„çš„é•¿åº¦ä¸åŒæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```python
builder = StateGraph(State)
builder.add_node("a", ReturnNodeValue("I'm A"))
builder.add_node("b", ReturnNodeValue("I'm B"))
builder.add_node("b2", ReturnNodeValue("I'm B2"))  # b è·¯å¾„çš„é¢å¤–èŠ‚ç‚¹
builder.add_node("c", ReturnNodeValue("I'm C"))
builder.add_node("d", ReturnNodeValue("I'm D"))

builder.add_edge(START, "a")
builder.add_edge("a", "b")
builder.add_edge("a", "c")
builder.add_edge("b", "b2")  # b â†’ b2ï¼ˆæ›´é•¿çš„è·¯å¾„ï¼‰
builder.add_edge(["b2", "c"], "d")  # ç­‰å¾… b2 å’Œ c éƒ½å®Œæˆ
builder.add_edge("d", END)

graph = builder.compile()

# ğŸ¨ å¯è§†åŒ–å›¾ç»“æ„
from IPython.display import Image, display
display(Image(graph.get_graph().draw_mermaid_png()))
```

**æ‰§è¡Œç»“æœï¼š**
```
Adding I'm A to []
Adding I'm B to ["I'm A"]
Adding I'm C to ["I'm A"]
Adding I'm B2 to ["I'm A", "I'm B", "I'm C"]
Adding I'm D to ["I'm A", "I'm B", "I'm C", "I'm B2"]
```

**å…³é”®ç‚¹ï¼š**
- `b`ã€`b2` å’Œ `c` éƒ½å±äº**åŒä¸€ä¸ªæ‰§è¡Œæ­¥éª¤ï¼ˆstepï¼‰**
- è™½ç„¶ `c` å…ˆå®Œæˆï¼Œä½†å›¾ä¼š**ç­‰å¾…** `b2` ä¹Ÿå®Œæˆåï¼Œæ‰è¿›å…¥ `d` èŠ‚ç‚¹
- è¿™æ˜¯ LangGraph çš„è‡ªåŠ¨åŒæ­¥æœºåˆ¶

---

## ğŸ¨ æ§åˆ¶çŠ¶æ€æ›´æ–°çš„é¡ºåº

### é—®é¢˜ï¼šé»˜è®¤é¡ºåºä¸å¯æ§

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè™½ç„¶éƒ½æ˜¯åŒä¸€æ­¥ï¼Œä½†çŠ¶æ€æ›´æ–°çš„é¡ºåºæ˜¯ï¼š`["I'm A", "I'm B", "I'm C", "I'm B2"]`

æ³¨æ„ `"I'm C"` å‡ºç°åœ¨ `"I'm B2"` ä¹‹å‰ï¼Œå³ä½¿ `b2` æ˜¯ `b` çš„åç»­èŠ‚ç‚¹ã€‚

**åŸå› ï¼š** LangGraph æ ¹æ®å›¾çš„æ‹“æ‰‘ç»“æ„å†³å®šæ›´æ–°é¡ºåºï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥æ§åˆ¶ã€‚

### è§£å†³æ–¹æ¡ˆï¼šè‡ªå®šä¹‰ Reducer

æˆ‘ä»¬å¯ä»¥ç¼–å†™è‡ªå®šä¹‰ reducer æ¥æ’åºçŠ¶æ€æ›´æ–°ï¼š

```python
def sorting_reducer(left, right):
    """åˆå¹¶å¹¶æ’åºåˆ—è¡¨ä¸­çš„å€¼"""
    # ç¡®ä¿ left æ˜¯åˆ—è¡¨
    if not isinstance(left, list):
        left = [left]

    # ç¡®ä¿ right æ˜¯åˆ—è¡¨
    if not isinstance(right, list):
        right = [right]

    # åˆå¹¶å¹¶æ’åº
    return sorted(left + right, reverse=False)

class State(TypedDict):
    # ä½¿ç”¨è‡ªå®šä¹‰çš„ sorting_reducer
    state: Annotated[list, sorting_reducer]
```

**æ‰§è¡Œç»“æœï¼š**
```
Adding I'm A to []
Adding I'm B to ["I'm A"]
Adding I'm C to ["I'm A"]
Adding I'm B2 to ["I'm A", "I'm B", "I'm C"]
Adding I'm D to ["I'm A", "I'm B", "I'm B2", "I'm C"]

{'state': ["I'm A", "I'm B", "I'm B2", "I'm C", "I'm D"]}
```

**æ³¨æ„ï¼š** ç°åœ¨é¡ºåºå˜æˆäº† `["I'm A", "I'm B", "I'm B2", "I'm C", "I'm D"]`ï¼ŒæŒ‰å­—æ¯é¡ºåºæ’åˆ—ï¼

### ğŸ” Reducer å‡½æ•°è¯¦è§£

è‡ªå®šä¹‰ reducer çš„å·¥ä½œåŸç†ï¼š

```python
def sorting_reducer(left, right):
    # left: å½“å‰çŠ¶æ€çš„å€¼
    # right: æ–°èŠ‚ç‚¹è¿”å›çš„å€¼

    # 1. æ ‡å‡†åŒ–ä¸ºåˆ—è¡¨
    if not isinstance(left, list):
        left = [left]
    if not isinstance(right, list):
        right = [right]

    # 2. åˆå¹¶å¹¶å¤„ç†ï¼ˆè¿™é‡Œæ˜¯æ’åºï¼‰
    return sorted(left + right, reverse=False)
```

**å…¶ä»– reducer ç¤ºä¾‹ï¼š**

```python
# åªä¿ç•™æœ€æ–°çš„ N ä¸ªå€¼
def keep_last_n(n=5):
    def reducer(left, right):
        combined = (left if isinstance(left, list) else [left]) + \
                   (right if isinstance(right, list) else [right])
        return combined[-n:]
    return reducer

# å»é‡
def unique_reducer(left, right):
    combined = (left if isinstance(left, list) else [left]) + \
               (right if isinstance(right, list) else [right])
    return list(dict.fromkeys(combined))  # ä¿æŒé¡ºåºçš„å»é‡
```

---

## ğŸ¤– å®æˆ˜æ¡ˆä¾‹ï¼šå¹¶è¡Œæ£€ç´¢ç”Ÿæˆç­”æ¡ˆ

### åœºæ™¯

æˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªé—®ç­”ç³»ç»Ÿï¼ŒåŒæ—¶ä»ä¸¤ä¸ªæ¥æºè·å–ä¿¡æ¯ï¼š
1. **Wikipedia** - è·å–ç™¾ç§‘çŸ¥è¯†
2. **Web Search (Tavily)** - è·å–æœ€æ–°ç½‘ç»œä¿¡æ¯

ç„¶åè®© LLM åŸºäºè¿™äº›ä¿¡æ¯ç”Ÿæˆç­”æ¡ˆã€‚

### State å®šä¹‰

```python
import operator
from typing import Annotated
from typing_extensions import TypedDict

class State(TypedDict):
    question: str                              # ç”¨æˆ·é—®é¢˜
    answer: str                                # ç”Ÿæˆçš„ç­”æ¡ˆ
    context: Annotated[list, operator.add]     # æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡ï¼ˆæ”¯æŒå¹¶è¡Œè¿½åŠ ï¼‰
```

**å…³é”®ç‚¹ï¼š**
- `context` ä½¿ç”¨ `operator.add` ä½œä¸º reducerï¼Œå…è®¸ä¸¤ä¸ªæ£€ç´¢èŠ‚ç‚¹å¹¶è¡Œå†™å…¥

### èŠ‚ç‚¹å®ç°

#### 1. Web æœç´¢èŠ‚ç‚¹

```python
from langchain_community.tools import TavilySearchResults

def search_web(state):
    """ä»ç½‘ç»œæœç´¢è·å–æ–‡æ¡£"""

    # ä½¿ç”¨ Tavily æœç´¢
    tavily_search = TavilySearchResults(max_results=3)
    search_docs = tavily_search.invoke(state['question'])

    # æ ¼å¼åŒ–æœç´¢ç»“æœ
    formatted_search_docs = "\n\n---\n\n".join(
        [
            f'<Document href="{doc["url"]}">\n{doc["content"]}\n</Document>'
            for doc in search_docs
        ]
    )

    return {"context": [formatted_search_docs]}
```

**çŸ¥è¯†ç‚¹ï¼š**
- è¿”å› `{"context": [formatted_search_docs]}`ï¼Œæ³¨æ„ `context` çš„å€¼æ˜¯ä¸€ä¸ª**åˆ—è¡¨**
- è¿™æ · `operator.add` å¯ä»¥å°†å…¶æ‹¼æ¥åˆ°ç°æœ‰çš„ context ä¸­

#### 2. Wikipedia æœç´¢èŠ‚ç‚¹

```python
from langchain_community.document_loaders import WikipediaLoader

def search_wikipedia(state):
    """ä» Wikipedia è·å–æ–‡æ¡£"""

    # æœç´¢ Wikipedia
    search_docs = WikipediaLoader(
        query=state['question'],
        load_max_docs=2
    ).load()

    # æ ¼å¼åŒ–æœç´¢ç»“æœ
    formatted_search_docs = "\n\n---\n\n".join(
        [
            f'<Document source="{doc.metadata["source"]}" page="{doc.metadata.get("page", "")}">\n{doc.page_content}\n</Document>'
            for doc in search_docs
        ]
    )

    return {"context": [formatted_search_docs]}
```

#### 3. ç”Ÿæˆç­”æ¡ˆèŠ‚ç‚¹

```python
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, SystemMessage

llm = ChatOpenAI(model="gpt-5-nano", temperature=0)

def generate_answer(state):
    """åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆç­”æ¡ˆ"""

    # è·å–çŠ¶æ€
    context = state["context"]
    question = state["question"]

    # æ„å»ºæç¤ºè¯
    answer_template = """Answer the question {question} using this context: {context}"""
    answer_instructions = answer_template.format(
        question=question,
        context=context
    )

    # è°ƒç”¨ LLM ç”Ÿæˆç­”æ¡ˆ
    answer = llm.invoke([
        SystemMessage(content=answer_instructions),
        HumanMessage(content="Answer the question.")
    ])

    return {"answer": answer}
```

### æ„å»ºå¹¶è¡Œå›¾

```python
from langgraph.graph import StateGraph, START, END

builder = StateGraph(State)

# æ·»åŠ èŠ‚ç‚¹
builder.add_node("search_web", search_web)
builder.add_node("search_wikipedia", search_wikipedia)
builder.add_node("generate_answer", generate_answer)

# å¹¶è¡Œæµç¨‹
builder.add_edge(START, "search_wikipedia")  # START â†’ search_wikipedia
builder.add_edge(START, "search_web")        # START â†’ search_webï¼ˆå¹¶è¡Œï¼‰
builder.add_edge("search_wikipedia", "generate_answer")  # æ±‡èš
builder.add_edge("search_web", "generate_answer")        # æ±‡èš
builder.add_edge("generate_answer", END)

graph = builder.compile()

# ğŸ¨ å¯è§†åŒ–å›¾ç»“æ„
from IPython.display import Image, display
display(Image(graph.get_graph().draw_mermaid_png()))
```

**æµç¨‹å›¾ï¼š**
```
          START
         /     \
        /       \
  search_web  search_wikipedia
        \       /
         \     /
    generate_answer
           |
          END
```

### æ‰§è¡ŒæŸ¥è¯¢

```python
result = graph.invoke({
    "question": "How were Nvidia's Q2 2024 earnings"
})

print(result['answer'].content)
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
Nvidia's Q2 2024 earnings were strong, showcasing record revenue and a robust
performance in its data center division. The company reported revenue of $30.0
billion, which was up 15% from the previous quarter and up 122% from a year ago.
GAAP earnings per diluted share were $0.67, up 12% from the previous quarter and
up 168% from a year ago, while non-GAAP earnings per diluted share were $0.68...
```

---

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### LangGraph ç‰¹æœ‰æ¦‚å¿µ

1. **å¹¶è¡Œæ‰§è¡Œæ¨¡å¼**
   - Fan-outï¼šä¸€ä¸ªèŠ‚ç‚¹æ‰‡å‡ºåˆ°å¤šä¸ªèŠ‚ç‚¹
   - Fan-inï¼šå¤šä¸ªèŠ‚ç‚¹æ±‡èšåˆ°ä¸€ä¸ªèŠ‚ç‚¹

2. **Reducer æœºåˆ¶**
   - å¿…é¡»ä½¿ç”¨ reducer å¤„ç†å¹¶è¡Œæ›´æ–°åŒä¸€ state é”®çš„æƒ…å†µ
   - `operator.add` ç”¨äºåˆ—è¡¨æ‹¼æ¥
   - å¯ä»¥è‡ªå®šä¹‰ reducer æ§åˆ¶åˆå¹¶é€»è¾‘

3. **æ‰§è¡Œæ­¥éª¤ï¼ˆStepï¼‰**
   - å¹¶è¡ŒèŠ‚ç‚¹åœ¨åŒä¸€ä¸ª step ä¸­æ‰§è¡Œ
   - å›¾ä¼šç­‰å¾…æ‰€æœ‰å¹¶è¡Œè·¯å¾„å®Œæˆåå†è¿›å…¥ä¸‹ä¸€æ­¥

4. **çŠ¶æ€æ›´æ–°é¡ºåº**
   - é»˜è®¤é¡ºåºç”± LangGraph æ ¹æ®å›¾æ‹“æ‰‘å†³å®š
   - å¯é€šè¿‡è‡ªå®šä¹‰ reducer æ§åˆ¶é¡ºåº

### Python ç‰¹æœ‰çŸ¥è¯†ç‚¹

1. **`TypedDict`**
   ```python
   from typing_extensions import TypedDict

   class State(TypedDict):
       field1: str
       field2: int
   ```
   ç”¨äºå®šä¹‰å­—å…¸çš„ç±»å‹ç»“æ„

2. **`Annotated` ç±»å‹æç¤º**
   ```python
   from typing import Annotated

   # è¯­æ³•ï¼šAnnotated[ç±»å‹, å…ƒæ•°æ®...]
   field: Annotated[list, operator.add]
   ```
   ä¸ºç±»å‹æ·»åŠ é¢å¤–çš„å…ƒæ•°æ®

3. **`operator.add`**
   ```python
   import operator

   # å¯¹åˆ—è¡¨æ‰§è¡Œæ‹¼æ¥
   operator.add([1, 2], [3, 4])  # [1, 2, 3, 4]
   ```

4. **å¯è°ƒç”¨ç±»ï¼ˆCallable Classï¼‰**
   ```python
   class ReturnNodeValue:
       def __init__(self, value):
           self._value = value

       def __call__(self, state):  # å®ç° __call__ æ–¹æ³•
           return {"state": [self._value]}
   ```
   å®ç° `__call__` æ–¹æ³•ä½¿å¯¹è±¡å¯ä»¥åƒå‡½æ•°ä¸€æ ·è°ƒç”¨

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæ‰§è¡Œï¼Ÿ

âœ… **é€‚ç”¨åœºæ™¯ï¼š**
- å¤šä¸ªç‹¬ç«‹çš„æ•°æ®æºæ£€ç´¢ï¼ˆå¦‚åŒæ—¶æŸ¥è¯¢æ•°æ®åº“ã€APIã€æœç´¢å¼•æ“ï¼‰
- å¤šä¸ªç‹¬ç«‹çš„å¤„ç†ä»»åŠ¡ï¼ˆå¦‚åŒæ—¶è¿›è¡Œæ–‡æœ¬åˆ†ç±»ã€å®ä½“æå–ã€æƒ…æ„Ÿåˆ†æï¼‰
- éœ€è¦å¤šä¸ª Agent åŒæ—¶å·¥ä½œçš„åœºæ™¯

âŒ **ä¸é€‚ç”¨åœºæ™¯ï¼š**
- ä»»åŠ¡ä¹‹é—´æœ‰ä¾èµ–å…³ç³»
- éœ€è¦ä¸¥æ ¼çš„æ‰§è¡Œé¡ºåº
- èµ„æºå—é™ï¼ˆå¦‚ API è°ƒç”¨é™åˆ¶ï¼‰

### 2. Reducer é€‰æ‹©æŒ‡å—

| åœºæ™¯ | Reducer | è¯´æ˜ |
|------|---------|------|
| æ”¶é›†æ‰€æœ‰ç»“æœ | `operator.add` | æ‹¼æ¥æ‰€æœ‰æ›´æ–° |
| éœ€è¦æ’åº | è‡ªå®šä¹‰ `sorting_reducer` | åˆå¹¶åæ’åº |
| å»é‡ | è‡ªå®šä¹‰ `unique_reducer` | åªä¿ç•™å”¯ä¸€å€¼ |
| åªä¿ç•™æœ€æ–° | è‡ªå®šä¹‰ `lambda left, right: right` | è¦†ç›–æ¨¡å¼ |
| ä¿ç•™æœ€è¿‘ N ä¸ª | è‡ªå®šä¹‰ `keep_last_n` | æ»‘åŠ¨çª—å£ |

### 3. çŠ¶æ€è®¾è®¡å»ºè®®

```python
class State(TypedDict):
    # è¾“å…¥å­—æ®µï¼ˆä¸ä¼šè¢«å¹¶è¡Œæ›´æ–°ï¼‰
    question: str

    # å¹¶è¡Œæ”¶é›†çš„æ•°æ®ï¼ˆä½¿ç”¨ reducerï¼‰
    search_results: Annotated[list, operator.add]

    # æœ€ç»ˆè¾“å‡ºï¼ˆå•ä¸€èŠ‚ç‚¹æ›´æ–°ï¼‰
    answer: str
```

---

## ğŸš€ è¿›é˜¶æŠ€å·§

### ç¨³å®šæ’åºï¼ˆStable Sortingï¼‰

å¯¹äºéœ€è¦ç²¾ç¡®æ§åˆ¶é¡ºåºçš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨"ä¸´æ—¶å­—æ®µ + æ±‡èšèŠ‚ç‚¹"æ¨¡å¼ï¼š

```python
class State(TypedDict):
    question: str
    temp_results: dict  # ä¸´æ—¶å­˜å‚¨å¹¶è¡Œç»“æœ
    final_results: list  # æ’åºåçš„æœ€ç»ˆç»“æœ

def collect_results(state):
    """æ±‡èšèŠ‚ç‚¹ï¼šåˆå¹¶å¹¶æ’åºä¸´æ—¶ç»“æœ"""
    results = state['temp_results']
    # æŒ‰è‡ªå®šä¹‰é¡ºåºæ’åº
    ordered = [results['source1'], results['source2'], results['source3']]
    return {"final_results": ordered, "temp_results": {}}  # æ¸…ç©ºä¸´æ—¶å­—æ®µ
```

è¯¦è§ [å®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/how-tos/branching/#stable-sorting)

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [LangGraph å¹¶è¡Œæ‰§è¡Œå®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/how-tos/branching/#how-to-create-branches-for-parallel-node-execution)
- [LangGraph State å’Œ Reducer è¯¦è§£](https://langchain-ai.github.io/langgraph/concepts/low_level/#state)
- Python `typing` æ¨¡å—æ–‡æ¡£

---

**æ€»ç»“**ï¼šå¹¶è¡Œæ‰§è¡Œæ˜¯ LangGraph çš„å¼ºå¤§åŠŸèƒ½ï¼Œé€šè¿‡åˆç†ä½¿ç”¨ reducer å’Œå›¾ç»“æ„è®¾è®¡ï¼Œå¯ä»¥æ„å»ºé«˜æ•ˆçš„å¤šä»»åŠ¡ã€å¤šæ™ºèƒ½ä½“ç³»ç»Ÿã€‚æŒæ¡è¿™ä¸ªæ¦‚å¿µæ˜¯è¿›å…¥é«˜çº§ LangGraph å¼€å‘çš„å…³é”®ä¸€æ­¥ï¼
