# 10.9 æ¡ä»¶é€»è¾‘ä¸Graphç¼–æ’ - æµç¨‹æ§åˆ¶çš„è‰ºæœ¯

## ğŸ¯ æœ¬èŠ‚ç›®æ ‡

åœ¨å‰é¢çš„ç« èŠ‚ä¸­,æˆ‘ä»¬åˆ†åˆ«å­¦ä¹ äº†åˆ†æå¸ˆã€å·¥å…·ã€è¾©è®ºã€äº¤æ˜“å‘˜ç­‰å„ä¸ªç»„ä»¶ã€‚ä½†è¿™äº›ç»„ä»¶å¦‚ä½•æœ‰æœºåœ°ç»„ç»‡åœ¨ä¸€èµ·?å¦‚ä½•æ§åˆ¶æ•°æ®æµå‘?å¦‚ä½•å†³å®šä½•æ—¶ç»§ç»­å¾ªç¯ã€ä½•æ—¶ç»ˆæ­¢?

è¿™ä¸€åˆ‡çš„ç­”æ¡ˆéƒ½åœ¨äº**æ¡ä»¶é€»è¾‘(Conditional Logic)**å’Œ**Graphç¼–æ’(Graph Setup)**ã€‚æœ¬èŠ‚å°†æ·±å…¥å‰–æTradingAgentçš„æµç¨‹æ§åˆ¶æœºåˆ¶,ç†è§£è¿™ä¸ªåŒ…å«15ä¸ªèŠ‚ç‚¹ã€6ä¸ªå¾ªç¯çš„å¤æ‚ç³»ç»Ÿå¦‚ä½•ç²¾å‡†è¿è¡Œã€‚

## ğŸ“ æ•´ä½“æ¶æ„å›é¡¾

åœ¨å¼€å§‹ä¹‹å‰,è®©æˆ‘ä»¬å…ˆå›é¡¾TradingAgentçš„å®Œæ•´æµç¨‹:

```
START
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬1é˜¶æ®µ: åˆ†æå¸ˆå›¢é˜Ÿ(å¹¶è¡Œæ”¶é›†æ•°æ®)    â”‚
â”‚  Market â†’ tools_market â†’ Market ... â”‚
â”‚  Social â†’ tools_social â†’ Social ... â”‚
â”‚  News â†’ tools_news â†’ News ...       â”‚
â”‚  Fundamentals â†’ tools_fundamentals...â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬2é˜¶æ®µ: æŠ•èµ„è¾©è®º(ä¸²è¡Œå¾ªç¯)         â”‚
â”‚  Bull â†” Bear â†’ Manager              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬3é˜¶æ®µ: äº¤æ˜“å‘˜å†³ç­–                â”‚
â”‚  Trader                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬4é˜¶æ®µ: é£é™©ç®¡ç†(ä¸‰æ–¹å¾ªç¯)         â”‚
â”‚  Risky â†” Safe â†” Neutral â†’ Judge     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
END
```

æ¯ä¸ªé˜¶æ®µéƒ½æœ‰è‡ªå·±çš„å¾ªç¯æ§åˆ¶é€»è¾‘,æˆ‘ä»¬å°†é€ä¸€å‰–æã€‚

## ğŸ›ï¸ ConditionalLogicç±» - æµç¨‹æ§åˆ¶ä¸­æ¢

è®©æˆ‘ä»¬å…ˆçœ‹å®Œæ•´çš„`ConditionalLogic`ç±»å®šä¹‰:

```python
# tradingagents/graph/conditional_logic.py

class ConditionalLogic:
    """å¤„ç†Graphæµç¨‹æ§åˆ¶çš„æ¡ä»¶é€»è¾‘"""

    def __init__(self, max_debate_rounds=1, max_risk_discuss_rounds=1):
        """
        åˆå§‹åŒ–é…ç½®å‚æ•°

        Args:
            max_debate_rounds: æŠ•èµ„è¾©è®ºçš„æœ€å¤§è½®æ•°(é»˜è®¤1è½®)
            max_risk_discuss_rounds: é£é™©è®¨è®ºçš„æœ€å¤§è½®æ•°(é»˜è®¤1è½®)
        """
        self.max_debate_rounds = max_debate_rounds
        self.max_risk_discuss_rounds = max_risk_discuss_rounds
```

è¿™ä¸ªç±»åŒ…å«**6ä¸ªæ¡ä»¶åˆ¤æ–­æ–¹æ³•**,å¯¹åº”TradingAgentä¸­çš„6ä¸ªå¾ªç¯ã€‚

## ğŸ”„ å¾ªç¯1-4: åˆ†æå¸ˆçš„ReActå¾ªç¯æ§åˆ¶

### é€šç”¨æ¨¡å¼

4ä¸ªåˆ†æå¸ˆ(Market, Social, News, Fundamentals)éƒ½ä½¿ç”¨ç›¸åŒçš„å¾ªç¯æ§åˆ¶é€»è¾‘:

```python
def should_continue_market(self, state: AgentState) -> str:
    """åˆ¤æ–­Market Analystæ˜¯å¦ç»§ç»­è°ƒç”¨å·¥å…·"""
    messages = state["messages"]
    last_message = messages[-1]

    # åˆ¤æ–­æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦åŒ…å«å·¥å…·è°ƒç”¨
    if last_message.tool_calls:
        return "tools_market"  # ç»§ç»­å¾ªç¯,è°ƒç”¨å·¥å…·
    return "Msg Clear Market"  # é€€å‡ºå¾ªç¯,æ¸…ç†æ¶ˆæ¯
```

### æ‰§è¡Œæµç¨‹è¯¦è§£

è®©æˆ‘ä»¬è·Ÿè¸ªä¸€ä¸ªå®Œæ•´çš„ReActå¾ªç¯:

```
ç¬¬1è½®:
  Market Analyst â†’ ç”Ÿæˆå·¥å…·è°ƒç”¨è¯·æ±‚
  â†“
  messages[-1].tool_calls = [
      ToolCall(name="get_stock_data", args={"symbol": "AAPL"})
  ]
  â†“
  should_continue_market(state) â†’ "tools_market"
  â†“
  tools_market â†’ æ‰§è¡Œå·¥å…·,è¿”å›ç»“æœ
  â†“
  å›åˆ° Market Analyst

ç¬¬2è½®:
  Market Analyst â†’ åˆ†æå·¥å…·ç»“æœ,ç”Ÿæˆæ–°çš„å·¥å…·è°ƒç”¨
  â†“
  messages[-1].tool_calls = [
      ToolCall(name="get_indicators", args={"symbol": "AAPL", "indicator": "RSI"})
  ]
  â†“
  should_continue_market(state) â†’ "tools_market"
  â†“
  tools_market â†’ æ‰§è¡Œå·¥å…·
  â†“
  å›åˆ° Market Analyst

ç¬¬3è½®:
  Market Analyst â†’ åˆ†æå®Œæ¯•,è¾“å‡ºæœ€ç»ˆæŠ¥å‘Š
  â†“
  messages[-1].tool_calls = []  # æ— å·¥å…·è°ƒç”¨
  â†“
  should_continue_market(state) â†’ "Msg Clear Market"
  â†“
  é€€å‡ºå¾ªç¯,æ¸…ç†ä¸­é—´æ¶ˆæ¯
```

### ä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥tool_calls?

è¿™æ˜¯LangGraphçš„ReActæ¨¡å¼çš„æ ¸å¿ƒæœºåˆ¶:

```python
# Agentçš„æ€è€ƒè¿‡ç¨‹
"æˆ‘éœ€è¦RSIæ•°æ®æ‰èƒ½åˆ†æ" â†’ æ¨ç†(Reasoning)
  â†“
ç”Ÿæˆ ToolCall(name="get_indicators", ...) â†’ è¡ŒåŠ¨(Acting)
  â†“
tool_callså­˜åœ¨ â†’ should_continueè¿”å›"tools_market"
  â†“
å·¥å…·æ‰§è¡Œ,è·å¾—RSI=72.3 â†’ è§‚å¯Ÿ(Observing)
  â†“
"RSIè¶…ä¹°,éœ€è¦æ›´å¤šæ•°æ®" â†’ ç»§ç»­æ¨ç†...
```

**ç»ˆæ­¢æ¡ä»¶**: å½“Agentè®¤ä¸ºæ”¶é›†åˆ°è¶³å¤Ÿä¿¡æ¯æ—¶,ç›´æ¥è¾“å‡ºæ–‡æœ¬æŠ¥å‘Š,ä¸å†ç”Ÿæˆtool_callsã€‚

### å…¶ä»–3ä¸ªåˆ†æå¸ˆçš„æ–¹æ³•

```python
def should_continue_social(self, state: AgentState) -> str:
    """Social Media Analystçš„å¾ªç¯æ§åˆ¶"""
    messages = state["messages"]
    last_message = messages[-1]
    if last_message.tool_calls:
        return "tools_social"
    return "Msg Clear Social"

def should_continue_news(self, state: AgentState) -> str:
    """News Analystçš„å¾ªç¯æ§åˆ¶"""
    messages = state["messages"]
    last_message = messages[-1]
    if last_message.tool_calls:
        return "tools_news"
    return "Msg Clear News"

def should_continue_fundamentals(self, state: AgentState) -> str:
    """Fundamentals Analystçš„å¾ªç¯æ§åˆ¶"""
    messages = state["messages"]
    last_message = messages[-1]
    if last_message.tool_calls:
        return "tools_fundamentals"
    return "Msg Clear Fundamentals"
```

**è®¾è®¡äº®ç‚¹**: è™½ç„¶ä»£ç é‡å¤,ä½†ä¿æŒäº†æ¸…æ™°æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚æ¯ä¸ªæ–¹æ³•ç‹¬ç«‹,ä¾¿äºè°ƒè¯•å’Œæ—¥å¿—è¿½è¸ªã€‚

## ğŸ‚ğŸ» å¾ªç¯5: æŠ•èµ„è¾©è®ºå¾ªç¯æ§åˆ¶

### æ ¸å¿ƒé€»è¾‘

```python
def should_continue_debate(self, state: AgentState) -> str:
    """åˆ¤æ–­æŠ•èµ„è¾©è®ºæ˜¯å¦ç»§ç»­"""

    # ç»ˆæ­¢æ¡ä»¶: è¾¾åˆ°è½®æ•°ä¸Šé™
    if state["investment_debate_state"]["count"] >= 2 * self.max_debate_rounds:
        return "Research Manager"  # ç»ˆæ­¢è¾©è®º,è¿›å…¥è£å†³

    # ç»§ç»­æ¡ä»¶: è½®æµå‘è¨€
    if state["investment_debate_state"]["current_response"].startswith("Bull"):
        return "Bear Researcher"  # Bullåˆšå‘è¨€,è½®åˆ°Bear
    return "Bull Researcher"  # Bearåˆšå‘è¨€,è½®åˆ°Bull
```

### å…³é”®é—®é¢˜è§£æ

#### Q1: ä¸ºä»€ä¹ˆæ˜¯`2 * max_debate_rounds`?

**ç­”æ¡ˆ**: å› ä¸º1è½®è¾©è®º = Bullå‘è¨€ + Bearå›åº” = 2æ¬¡å‘è¨€

```python
max_debate_rounds = 1  # è¾©è®º1è½®

ç¬¬1è½®:
  Bullå‘è¨€ â†’ count=1
  Bearå›åº” â†’ count=2

count=2 >= 2*1=2 â†’ ç»ˆæ­¢
```

å¦‚æœ`max_debate_rounds=2`:

```python
ç¬¬1è½®:
  Bullå‘è¨€ â†’ count=1
  Bearå›åº” â†’ count=2

ç¬¬2è½®:
  Bullå‘è¨€ â†’ count=3
  Bearå›åº” â†’ count=4

count=4 >= 2*2=4 â†’ ç»ˆæ­¢
```

#### Q2: å¦‚ä½•åˆ¤æ–­è½®æ¢é¡ºåº?

**ç­”æ¡ˆ**: é€šè¿‡`current_response`å­—æ®µçš„å‰ç¼€:

```python
# Bullåˆšå‘è¨€
state["investment_debate_state"]["current_response"] = "Bull: æˆ‘è®¤ä¸ºåº”è¯¥ä¹°å…¥..."
  â†“
current_response.startswith("Bull") == True
  â†“
è¿”å› "Bear Researcher"  # è½®åˆ°Bear

# Bearåˆšå‘è¨€
state["investment_debate_state"]["current_response"] = "Bear: æˆ‘è®¤ä¸ºé£é™©å¤ªå¤§..."
  â†“
current_response.startswith("Bull") == False
  â†“
è¿”å› "Bull Researcher"  # è½®åˆ°Bull
```

### æµç¨‹å›¾

```mermaid
graph TD
    A[Bull Researcher] -->|count+1| B{count >= 2*max_rounds?}
    B -->|æ˜¯| C[Research Manager]
    B -->|å¦| D[Bear Researcher]
    D -->|count+1| E{count >= 2*max_rounds?}
    E -->|æ˜¯| C
    E -->|å¦| A
```

### å®é™…æ‰§è¡Œç¤ºä¾‹

```python
# é…ç½®
max_debate_rounds = 1

# æ‰§è¡Œæµç¨‹
Bull Researcher æ‰§è¡Œ
  â†’ investment_debate_state["count"] = 1
  â†’ investment_debate_state["current_response"] = "Bull: ..."
  â†’ should_continue_debate(state)
  â†’ count=1 < 2*1=2 â†’ ç»§ç»­
  â†’ current_response.startswith("Bull") â†’ è¿”å›"Bear Researcher"

Bear Researcher æ‰§è¡Œ
  â†’ investment_debate_state["count"] = 2
  â†’ investment_debate_state["current_response"] = "Bear: ..."
  â†’ should_continue_debate(state)
  â†’ count=2 >= 2*1=2 â†’ ç»ˆæ­¢
  â†’ è¿”å›"Research Manager"

Research Manager æ‰§è¡Œ
  â†’ ç»¼åˆè£å†³
  â†’ å¡«å……investment_plan
```

## âš–ï¸ å¾ªç¯6: é£é™©ç®¡ç†å¾ªç¯æ§åˆ¶

### ä¸‰æ–¹è½®æ¢é€»è¾‘

```python
def should_continue_risk_analysis(self, state: AgentState) -> str:
    """åˆ¤æ–­é£é™©åˆ†ææ˜¯å¦ç»§ç»­"""

    # ç»ˆæ­¢æ¡ä»¶: è¾¾åˆ°è½®æ•°ä¸Šé™
    if state["risk_debate_state"]["count"] >= 3 * self.max_risk_discuss_rounds:
        return "Risk Judge"  # ç»ˆæ­¢è®¨è®º,è¿›å…¥è£å†³

    # ç»§ç»­æ¡ä»¶: ä¸‰æ–¹è½®æµ
    latest_speaker = state["risk_debate_state"]["latest_speaker"]

    if latest_speaker.startswith("Risky"):
        return "Safe Analyst"
    if latest_speaker.startswith("Safe"):
        return "Neutral Analyst"
    return "Risky Analyst"  # Neutralåˆšå‘è¨€,å›åˆ°Risky
```

### å…³é”®é—®é¢˜è§£æ

#### Q1: ä¸ºä»€ä¹ˆæ˜¯`3 * max_risk_discuss_rounds`?

**ç­”æ¡ˆ**: å› ä¸º1è½®è®¨è®º = Risky + Safe + Neutral = 3æ¬¡å‘è¨€

```python
max_risk_discuss_rounds = 1  # è®¨è®º1è½®

ç¬¬1è½®:
  Riskyå‘è¨€ â†’ count=1
  Safeå‘è¨€ â†’ count=2
  Neutralå‘è¨€ â†’ count=3

count=3 >= 3*1=3 â†’ ç»ˆæ­¢
```

#### Q2: è½®æ¢é¡ºåºæ˜¯ä»€ä¹ˆ?

**ç­”æ¡ˆ**: Risky â†’ Safe â†’ Neutral â†’ Risky â†’ ...

```python
# Riskyåˆšå‘è¨€
latest_speaker = "Risky: ..."
  â†’ latest_speaker.startswith("Risky") == True
  â†’ è¿”å› "Safe Analyst"

# Safeåˆšå‘è¨€
latest_speaker = "Safe: ..."
  â†’ latest_speaker.startswith("Safe") == True
  â†’ è¿”å› "Neutral Analyst"

# Neutralåˆšå‘è¨€
latest_speaker = "Neutral: ..."
  â†’ ä¸æ»¡è¶³å‰ä¸¤ä¸ªæ¡ä»¶
  â†’ è¿”å› "Risky Analyst"  # å›åˆ°Risky
```

### æµç¨‹å›¾

```mermaid
graph TD
    A[Risky Analyst] -->|count+1| B{count >= 3*max_rounds?}
    B -->|æ˜¯| F[Risk Judge]
    B -->|å¦| C[Safe Analyst]
    C -->|count+1| D{count >= 3*max_rounds?}
    D -->|æ˜¯| F
    D -->|å¦| E[Neutral Analyst]
    E -->|count+1| G{count >= 3*max_rounds?}
    G -->|æ˜¯| F
    G -->|å¦| A
```

### å®é™…æ‰§è¡Œç¤ºä¾‹

```python
# é…ç½®
max_risk_discuss_rounds = 1

# æ‰§è¡Œæµç¨‹
Risky Analyst æ‰§è¡Œ
  â†’ risk_debate_state["count"] = 1
  â†’ risk_debate_state["latest_speaker"] = "Risky: ..."
  â†’ should_continue_risk_analysis(state)
  â†’ count=1 < 3*1=3 â†’ ç»§ç»­
  â†’ latest_speaker.startswith("Risky") â†’ è¿”å›"Safe Analyst"

Safe Analyst æ‰§è¡Œ
  â†’ risk_debate_state["count"] = 2
  â†’ risk_debate_state["latest_speaker"] = "Safe: ..."
  â†’ should_continue_risk_analysis(state)
  â†’ count=2 < 3 â†’ ç»§ç»­
  â†’ latest_speaker.startswith("Safe") â†’ è¿”å›"Neutral Analyst"

Neutral Analyst æ‰§è¡Œ
  â†’ risk_debate_state["count"] = 3
  â†’ risk_debate_state["latest_speaker"] = "Neutral: ..."
  â†’ should_continue_risk_analysis(state)
  â†’ count=3 >= 3 â†’ ç»ˆæ­¢
  â†’ è¿”å›"Risk Judge"

Risk Judge æ‰§è¡Œ
  â†’ ç»¼åˆè£å†³
  â†’ å¡«å……final_trade_decision
```

## ğŸ—ï¸ GraphSetupç±» - Graphç¼–æ’å¤§å¸ˆ

ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•æ§åˆ¶å¾ªç¯,æ¥ä¸‹æ¥çœ‹å¦‚ä½•å°†15ä¸ªèŠ‚ç‚¹ç»„è£…æˆå®Œæ•´çš„Graphã€‚

### ç±»å®šä¹‰

```python
# tradingagents/graph/setup.py

class GraphSetup:
    """å¤„ç†Agent Graphçš„è®¾ç½®å’Œé…ç½®"""

    def __init__(
        self,
        quick_thinking_llm: ChatOpenAI,     # å¿«é€Ÿæ€è€ƒæ¨¡å‹(ç”¨äºåˆ†æå¸ˆ)
        deep_thinking_llm: ChatOpenAI,      # æ·±åº¦æ€è€ƒæ¨¡å‹(ç”¨äºManager)
        tool_nodes: Dict[str, ToolNode],    # å·¥å…·èŠ‚ç‚¹å­—å…¸
        bull_memory,                        # Bullçš„è®°å¿†ç³»ç»Ÿ
        bear_memory,                        # Bearçš„è®°å¿†ç³»ç»Ÿ
        trader_memory,                      # Traderçš„è®°å¿†ç³»ç»Ÿ
        invest_judge_memory,                # Research Managerçš„è®°å¿†
        risk_manager_memory,                # Risk Judgeçš„è®°å¿†
        conditional_logic: ConditionalLogic # æ¡ä»¶é€»è¾‘å®ä¾‹
    ):
        self.quick_thinking_llm = quick_thinking_llm
        self.deep_thinking_llm = deep_thinking_llm
        self.tool_nodes = tool_nodes
        self.bull_memory = bull_memory
        self.bear_memory = bear_memory
        self.trader_memory = trader_memory
        self.invest_judge_memory = invest_judge_memory
        self.risk_manager_memory = risk_manager_memory
        self.conditional_logic = conditional_logic
```

### setup_graphæ–¹æ³• - Graphæ„å»ºæµç¨‹

è¿™æ˜¯TradingAgentçš„æ ¸å¿ƒæ–¹æ³•,è´Ÿè´£æ„å»ºæ•´ä¸ª15èŠ‚ç‚¹çš„Graph:

```python
def setup_graph(self, selected_analysts=["market", "social", "news", "fundamentals"]):
    """
    è®¾ç½®å¹¶ç¼–è¯‘Agentå·¥ä½œæµGraph

    Args:
        selected_analysts: è¦åŒ…å«çš„åˆ†æå¸ˆåˆ—è¡¨,æ”¯æŒ:
            - "market": å¸‚åœºåˆ†æå¸ˆ
            - "social": ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ
            - "news": æ–°é—»åˆ†æå¸ˆ
            - "fundamentals": åŸºæœ¬é¢åˆ†æå¸ˆ
    """
```

#### ç¬¬1æ­¥: åˆ›å»ºåˆ†æå¸ˆèŠ‚ç‚¹

```python
# åˆ›å»ºåˆ†æå¸ˆèŠ‚ç‚¹å­—å…¸
analyst_nodes = {}
delete_nodes = {}
tool_nodes = {}

if "market" in selected_analysts:
    analyst_nodes["market"] = create_market_analyst(self.quick_thinking_llm)
    delete_nodes["market"] = create_msg_delete()
    tool_nodes["market"] = self.tool_nodes["market"]

if "social" in selected_analysts:
    analyst_nodes["social"] = create_social_media_analyst(self.quick_thinking_llm)
    delete_nodes["social"] = create_msg_delete()
    tool_nodes["social"] = self.tool_nodes["social"]

# ... Newså’ŒFundamentalsç±»ä¼¼
```

**è®¾è®¡äº®ç‚¹**:
- æ”¯æŒåŠ¨æ€é€‰æ‹©åˆ†æå¸ˆ(å¯åªç”¨éƒ¨åˆ†åˆ†æå¸ˆ)
- æ¯ä¸ªåˆ†æå¸ˆé…å¥—ä¸€ä¸ªdeleteèŠ‚ç‚¹å’ŒtoolèŠ‚ç‚¹
- ä½¿ç”¨quick_thinking_llm(æˆæœ¬è¾ƒä½)

#### ç¬¬2æ­¥: åˆ›å»ºç ”ç©¶å‘˜å’Œç®¡ç†èŠ‚ç‚¹

```python
# åˆ›å»ºç ”ç©¶å‘˜å’Œç®¡ç†èŠ‚ç‚¹
bull_researcher_node = create_bull_researcher(
    self.quick_thinking_llm, self.bull_memory
)
bear_researcher_node = create_bear_researcher(
    self.quick_thinking_llm, self.bear_memory
)
research_manager_node = create_research_manager(
    self.deep_thinking_llm,  # æ³¨æ„:ä½¿ç”¨deep_thinking_llm
    self.invest_judge_memory
)
trader_node = create_trader(
    self.quick_thinking_llm,
    self.trader_memory
)
```

**è®¾è®¡äº®ç‚¹**:
- Research Managerä½¿ç”¨`deep_thinking_llm`(æ›´å¼ºçš„æ¨¡å‹)
- æ¯ä¸ªAgentéƒ½æœ‰è‡ªå·±çš„è®°å¿†ç³»ç»Ÿ

#### ç¬¬3æ­¥: åˆ›å»ºé£é™©åˆ†æèŠ‚ç‚¹

```python
# åˆ›å»ºé£é™©åˆ†æèŠ‚ç‚¹
risky_analyst = create_risky_debator(self.quick_thinking_llm)
neutral_analyst = create_neutral_debator(self.quick_thinking_llm)
safe_analyst = create_safe_debator(self.quick_thinking_llm)
risk_manager_node = create_risk_manager(
    self.deep_thinking_llm,  # åŒæ ·ä½¿ç”¨deep_thinking_llm
    self.risk_manager_memory
)
```

#### ç¬¬4æ­¥: åˆ›å»ºStateGraphå¹¶æ·»åŠ èŠ‚ç‚¹

```python
# åˆ›å»ºå·¥ä½œæµ
workflow = StateGraph(AgentState)

# æ·»åŠ åˆ†æå¸ˆèŠ‚ç‚¹åˆ°Graph
for analyst_type, node in analyst_nodes.items():
    workflow.add_node(f"{analyst_type.capitalize()} Analyst", node)
    workflow.add_node(
        f"Msg Clear {analyst_type.capitalize()}",
        delete_nodes[analyst_type]
    )
    workflow.add_node(f"tools_{analyst_type}", tool_nodes[analyst_type])

# æ·»åŠ å…¶ä»–èŠ‚ç‚¹
workflow.add_node("Bull Researcher", bull_researcher_node)
workflow.add_node("Bear Researcher", bear_researcher_node)
workflow.add_node("Research Manager", research_manager_node)
workflow.add_node("Trader", trader_node)
workflow.add_node("Risky Analyst", risky_analyst)
workflow.add_node("Neutral Analyst", neutral_analyst)
workflow.add_node("Safe Analyst", safe_analyst)
workflow.add_node("Risk Judge", risk_manager_node)
```

**èŠ‚ç‚¹å‘½åè§„èŒƒ**:
- åˆ†æå¸ˆ: `"Market Analyst"`, `"Social Analyst"`, ...
- å·¥å…·èŠ‚ç‚¹: `"tools_market"`, `"tools_social"`, ...
- æ¸…ç†èŠ‚ç‚¹: `"Msg Clear Market"`, `"Msg Clear Social"`, ...

#### ç¬¬5æ­¥: å®šä¹‰è¾¹ - STARTè¿æ¥

```python
# ä»STARTå¼€å§‹,è¿æ¥åˆ°ç¬¬ä¸€ä¸ªåˆ†æå¸ˆ
first_analyst = selected_analysts[0]  # é€šå¸¸æ˜¯"market"
workflow.add_edge(START, f"{first_analyst.capitalize()} Analyst")
```

#### ç¬¬6æ­¥: å®šä¹‰è¾¹ - åˆ†æå¸ˆé“¾

```python
# æŒ‰é¡ºåºè¿æ¥åˆ†æå¸ˆ
for i, analyst_type in enumerate(selected_analysts):
    current_analyst = f"{analyst_type.capitalize()} Analyst"
    current_tools = f"tools_{analyst_type}"
    current_clear = f"Msg Clear {analyst_type.capitalize()}"

    # æ·»åŠ å½“å‰åˆ†æå¸ˆçš„æ¡ä»¶è¾¹(ReActå¾ªç¯)
    workflow.add_conditional_edges(
        current_analyst,
        getattr(self.conditional_logic, f"should_continue_{analyst_type}"),
        [current_tools, current_clear]
    )

    # å·¥å…·èŠ‚ç‚¹å›åˆ°åˆ†æå¸ˆ(å½¢æˆå¾ªç¯)
    workflow.add_edge(current_tools, current_analyst)

    # è¿æ¥åˆ°ä¸‹ä¸€ä¸ªåˆ†æå¸ˆæˆ–Bull Researcher
    if i < len(selected_analysts) - 1:
        next_analyst = f"{selected_analysts[i+1].capitalize()} Analyst"
        workflow.add_edge(current_clear, next_analyst)
    else:
        # æœ€åä¸€ä¸ªåˆ†æå¸ˆè¿æ¥åˆ°Bull Researcher
        workflow.add_edge(current_clear, "Bull Researcher")
```

**å…³é”®ç‚¹è§£æ**:

1. **æ¡ä»¶è¾¹çš„å®šä¹‰**:
```python
workflow.add_conditional_edges(
    "Market Analyst",  # æºèŠ‚ç‚¹
    self.conditional_logic.should_continue_market,  # æ¡ä»¶å‡½æ•°
    ["tools_market", "Msg Clear Market"]  # å¯èƒ½çš„ç›®æ ‡èŠ‚ç‚¹
)
```

2. **getattrçš„å¦™ç”¨**:
```python
# åŠ¨æ€è·å–æ–¹æ³•
getattr(self.conditional_logic, f"should_continue_{analyst_type}")
# ç­‰ä»·äº
self.conditional_logic.should_continue_market  # å½“analyst_type="market"
```

3. **å¾ªç¯è¾¹**:
```python
workflow.add_edge("tools_market", "Market Analyst")
# å·¥å…·æ‰§è¡Œå,æ€»æ˜¯å›åˆ°åˆ†æå¸ˆ
```

#### ç¬¬7æ­¥: å®šä¹‰è¾¹ - æŠ•èµ„è¾©è®º

```python
# Bullå’ŒBearçš„åŒå‘è¾©è®ºå¾ªç¯
workflow.add_conditional_edges(
    "Bull Researcher",
    self.conditional_logic.should_continue_debate,
    {
        "Bear Researcher": "Bear Researcher",
        "Research Manager": "Research Manager"
    }
)

workflow.add_conditional_edges(
    "Bear Researcher",
    self.conditional_logic.should_continue_debate,
    {
        "Bull Researcher": "Bull Researcher",
        "Research Manager": "Research Manager"
    }
)

# Research Manageråˆ°Trader
workflow.add_edge("Research Manager", "Trader")
```

**æ³¨æ„**: æ¡ä»¶è¾¹çš„ç›®æ ‡å¯ä»¥ç”¨å­—å…¸å½¢å¼:

```python
{
    "ç›®æ ‡èŠ‚ç‚¹1": "ç›®æ ‡èŠ‚ç‚¹1",  # é”®æ˜¯æ¡ä»¶å‡½æ•°çš„è¿”å›å€¼,å€¼æ˜¯å®é™…èŠ‚ç‚¹å
    "ç›®æ ‡èŠ‚ç‚¹2": "ç›®æ ‡èŠ‚ç‚¹2"
}
```

#### ç¬¬8æ­¥: å®šä¹‰è¾¹ - é£é™©ç®¡ç†

```python
# Traderåˆ°Risky Analyst
workflow.add_edge("Trader", "Risky Analyst")

# ä¸‰æ–¹å¾ªç¯è¾©è®º
workflow.add_conditional_edges(
    "Risky Analyst",
    self.conditional_logic.should_continue_risk_analysis,
    {
        "Safe Analyst": "Safe Analyst",
        "Risk Judge": "Risk Judge"
    }
)

workflow.add_conditional_edges(
    "Safe Analyst",
    self.conditional_logic.should_continue_risk_analysis,
    {
        "Neutral Analyst": "Neutral Analyst",
        "Risk Judge": "Risk Judge"
    }
)

workflow.add_conditional_edges(
    "Neutral Analyst",
    self.conditional_logic.should_continue_risk_analysis,
    {
        "Risky Analyst": "Risky Analyst",
        "Risk Judge": "Risk Judge"
    }
)

# Risk Judgeåˆ°END
workflow.add_edge("Risk Judge", END)
```

#### ç¬¬9æ­¥: ç¼–è¯‘Graph

```python
# ç¼–è¯‘å¹¶è¿”å›
return workflow.compile()
```

**compile()åšäº†ä»€ä¹ˆ?**
- éªŒè¯Graphçš„æœ‰æ•ˆæ€§(æ²¡æœ‰å­¤ç«‹èŠ‚ç‚¹ã€æ­»å¾ªç¯ç­‰)
- ä¼˜åŒ–æ‰§è¡Œè·¯å¾„
- è¿”å›å¯æ‰§è¡Œçš„CompiledGraphå¯¹è±¡

## ğŸ¨ Graphç¼–æ’çš„è®¾è®¡ç²¾é«“

### 1. æ¨¡å—åŒ–è®¾è®¡

```python
# âœ… å¥½çš„è®¾è®¡ - åˆ†æå¸ˆå¯æ’æ‹”
selected_analysts = ["market", "news"]  # åªç”¨2ä¸ªåˆ†æå¸ˆ
graph = setup_graph(selected_analysts)

# ä¹Ÿå¯ä»¥å…¨éƒ¨ä½¿ç”¨
selected_analysts = ["market", "social", "news", "fundamentals"]
graph = setup_graph(selected_analysts)
```

### 2. æ¡ä»¶é€»è¾‘ä¸Graphåˆ†ç¦»

```python
# âœ… å¥½çš„è®¾è®¡ - å•ä¸€èŒè´£
conditional_logic = ConditionalLogic(max_debate_rounds=2)  # æ§åˆ¶é€»è¾‘
graph_setup = GraphSetup(..., conditional_logic)           # Graphæ„å»º

# âŒ ä¸å¥½çš„è®¾è®¡ - è€¦åˆåœ¨ä¸€èµ·
class GraphSetup:
    def should_continue_market(self, state):  # æ··åœ¨ä¸€èµ·
        ...
```

### 3. ä¸¤ç§LLMçš„åˆç†ä½¿ç”¨

```python
# å¿«é€Ÿæ€è€ƒæ¨¡å‹ - ç”¨äºæ•°æ®æ”¶é›†å’Œåˆæ­¥åˆ†æ
quick_thinking_llm = ChatOpenAI(model="gpt-4o-mini")
analyst_nodes["market"] = create_market_analyst(quick_thinking_llm)

# æ·±åº¦æ€è€ƒæ¨¡å‹ - ç”¨äºå…³é”®å†³ç­–
deep_thinking_llm = ChatOpenAI(model="gpt-4o")
research_manager_node = create_research_manager(deep_thinking_llm)
```

**æˆæœ¬ä¼˜åŒ–**: åˆ†æå¸ˆç”¨ä¾¿å®œçš„æ¨¡å‹,Managerç”¨è´µçš„æ¨¡å‹,åœ¨æˆæœ¬å’Œè´¨é‡é—´å¹³è¡¡ã€‚

### 4. è®°å¿†ç³»ç»Ÿçš„é›†æˆ

```python
# æ¯ä¸ªå…³é”®Agentéƒ½æœ‰ç‹¬ç«‹çš„è®°å¿†
bull_memory = FinancialSituationMemory()
bear_memory = FinancialSituationMemory()

bull_researcher_node = create_bull_researcher(llm, bull_memory)
bear_researcher_node = create_bear_researcher(llm, bear_memory)
```

**å¥½å¤„**: Bullå’ŒBearå¯ä»¥ä»å†å²ç»éªŒä¸­å­¦ä¹ ,é€æ­¥æ”¹è¿›ç­–ç•¥ã€‚

## ğŸ“Š å®Œæ•´çš„Graphå¯è§†åŒ–

è®©æˆ‘ä»¬ç”¨ä»£ç è¡¨ç¤ºå®Œæ•´çš„è¾¹è¿æ¥:

```python
# ä¼ªä»£ç è¡¨ç¤ºå®Œæ•´æµç¨‹
Graphç»“æ„:
  START
    â†“ (é¡ºåºè¾¹)
  Market Analyst
    â†“ (æ¡ä»¶è¾¹: has tool_calls?)
    â”œâ”€ Yes â†’ tools_market â†’ Market Analyst (å¾ªç¯)
    â””â”€ No â†’ Msg Clear Market
              â†“ (é¡ºåºè¾¹)
  Social Analyst
    â†“ (æ¡ä»¶è¾¹: has tool_calls?)
    â”œâ”€ Yes â†’ tools_social â†’ Social Analyst (å¾ªç¯)
    â””â”€ No â†’ Msg Clear Social
              â†“
  News Analyst
    â†“ (æ¡ä»¶è¾¹: has tool_calls?)
    â”œâ”€ Yes â†’ tools_news â†’ News Analyst (å¾ªç¯)
    â””â”€ No â†’ Msg Clear News
              â†“
  Fundamentals Analyst
    â†“ (æ¡ä»¶è¾¹: has tool_calls?)
    â”œâ”€ Yes â†’ tools_fundamentals â†’ Fundamentals Analyst (å¾ªç¯)
    â””â”€ No â†’ Msg Clear Fundamentals
              â†“ (é¡ºåºè¾¹)
  Bull Researcher
    â†“ (æ¡ä»¶è¾¹: count >= 2*max_rounds?)
    â”œâ”€ Yes â†’ Research Manager
    â””â”€ No â†’ Bear Researcher
              â†“ (æ¡ä»¶è¾¹)
              â”œâ”€ Yes â†’ Research Manager
              â””â”€ No â†’ Bull Researcher (å¾ªç¯)
  Research Manager
    â†“ (é¡ºåºè¾¹)
  Trader
    â†“ (é¡ºåºè¾¹)
  Risky Analyst
    â†“ (æ¡ä»¶è¾¹: count >= 3*max_rounds?)
    â”œâ”€ Yes â†’ Risk Judge
    â””â”€ No â†’ Safe Analyst
              â†“ (æ¡ä»¶è¾¹)
              â”œâ”€ Yes â†’ Risk Judge
              â””â”€ No â†’ Neutral Analyst
                        â†“ (æ¡ä»¶è¾¹)
                        â”œâ”€ Yes â†’ Risk Judge
                        â””â”€ No â†’ Risky Analyst (å¾ªç¯)
  Risk Judge
    â†“ (é¡ºåºè¾¹)
  END
```

## ğŸ” å¾ªç¯ç»ˆæ­¢æœºåˆ¶æ€»ç»“

| å¾ªç¯ | ç»ˆæ­¢æ¡ä»¶ | æ£€æŸ¥ä½ç½® | å…³é”®å­—æ®µ |
|-----|---------|---------|---------|
| Market Analyst | `not last_message.tool_calls` | `should_continue_market` | `messages[-1].tool_calls` |
| Social Analyst | `not last_message.tool_calls` | `should_continue_social` | `messages[-1].tool_calls` |
| News Analyst | `not last_message.tool_calls` | `should_continue_news` | `messages[-1].tool_calls` |
| Fundamentals Analyst | `not last_message.tool_calls` | `should_continue_fundamentals` | `messages[-1].tool_calls` |
| æŠ•èµ„è¾©è®º | `count >= 2 * max_debate_rounds` | `should_continue_debate` | `investment_debate_state["count"]` |
| é£é™©è®¨è®º | `count >= 3 * max_risk_discuss_rounds` | `should_continue_risk_analysis` | `risk_debate_state["count"]` |

## ğŸ’¡ å®æˆ˜æŠ€å·§

### 1. è°ƒæ•´è¾©è®ºè½®æ•°

```python
# ç®€å•å†³ç­– - 1è½®è¾©è®º
conditional_logic = ConditionalLogic(
    max_debate_rounds=1,
    max_risk_discuss_rounds=1
)

# å¤æ‚å†³ç­– - å¤šè½®è¾©è®º
conditional_logic = ConditionalLogic(
    max_debate_rounds=3,  # Bullå’ŒBearå„è¯´3æ¬¡
    max_risk_discuss_rounds=2  # é£é™©ç®¡ç†è®¨è®º2è½®
)
```

### 2. åŠ¨æ€é€‰æ‹©åˆ†æå¸ˆ

```python
# å¿«é€Ÿåˆ†æ - åªç”¨å¸‚åœºå’Œæ–°é—»
selected_analysts = ["market", "news"]

# å…¨é¢åˆ†æ - ä½¿ç”¨æ‰€æœ‰åˆ†æå¸ˆ
selected_analysts = ["market", "social", "news", "fundamentals"]
```

### 3. æ·»åŠ æ—¥å¿—è·Ÿè¸ª

```python
def should_continue_market(self, state: AgentState) -> str:
    messages = state["messages"]
    last_message = messages[-1]

    if last_message.tool_calls:
        print(f"[DEBUG] Market Analystç»§ç»­è°ƒç”¨å·¥å…·: {last_message.tool_calls}")
        return "tools_market"

    print(f"[DEBUG] Market Analystå®Œæˆ,æ¸…ç†æ¶ˆæ¯")
    return "Msg Clear Market"
```

## ğŸ“ æœ¬èŠ‚å°ç»“

é€šè¿‡æœ¬èŠ‚,ä½ åº”è¯¥å·²ç»æŒæ¡:

âœ… **ConditionalLogicç±»**: 6ä¸ªå¾ªç¯æ§åˆ¶æ–¹æ³•çš„å®ç°åŸç†

âœ… **ReActå¾ªç¯**: é€šè¿‡`tool_calls`åˆ¤æ–­æ˜¯å¦ç»§ç»­

âœ… **è¾©è®ºå¾ªç¯**: é€šè¿‡`count`å’Œå‘è¨€è€…å‰ç¼€æ§åˆ¶è½®æ¢

âœ… **GraphSetupç±»**: å®Œæ•´çš„Graphæ„å»ºæµç¨‹

âœ… **è¾¹çš„ç±»å‹**: é¡ºåºè¾¹ã€æ¡ä»¶è¾¹ã€å¾ªç¯è¾¹

âœ… **è®¾è®¡ç²¾é«“**: æ¨¡å—åŒ–ã€èŒè´£åˆ†ç¦»ã€æˆæœ¬ä¼˜åŒ–

âœ… **æ ¸å¿ƒé—®ç­”**:
- 6ä¸ªå¾ªç¯å¦‚ä½•ç»ˆæ­¢? â†’ åˆ†åˆ«é€šè¿‡tool_callså’Œcountåˆ¤æ–­
- Graphå¦‚ä½•ç»„è£…? â†’ setup_graphæ–¹æ³•çš„9æ­¥æµç¨‹
- ä¸ºä»€ä¹ˆåˆ†ä¸¤ç§LLM? â†’ æˆæœ¬ä¸è´¨é‡çš„å¹³è¡¡

ç°åœ¨ä½ å·²ç»ç†è§£äº†TradingAgentçš„"éª¨æ¶"(Graphç»“æ„)å’Œ"ç¥ç»ç³»ç»Ÿ"(æ¡ä»¶é€»è¾‘)ã€‚æ¥ä¸‹æ¥,æˆ‘ä»¬å°†çœ‹åˆ°æ•´ä¸ªç³»ç»Ÿçš„ç«¯åˆ°ç«¯æ‰§è¡Œæµç¨‹ã€‚

---

**ä¸Šä¸€èŠ‚**: [10.8 é£é™©ç®¡ç†å›¢é˜Ÿ-ä¸‰æ–¹åˆ¶è¡¡æœºåˆ¶](./10.8%20é£é™©ç®¡ç†å›¢é˜Ÿ-ä¸‰æ–¹åˆ¶è¡¡æœºåˆ¶.md)

**ä¸‹ä¸€èŠ‚**: [10.10 ç«¯åˆ°ç«¯æ‰§è¡Œæµç¨‹-å®Œæ•´äº¤æ˜“å†³ç­–é“¾è·¯](./10.10%20ç«¯åˆ°ç«¯æ‰§è¡Œæµç¨‹-å®Œæ•´äº¤æ˜“å†³ç­–é“¾è·¯.md)

**è¿”å›ç›®å½•**: [10.0 æœ¬ç« ä»‹ç»](./10.0%20æœ¬ç« ä»‹ç».md)
