# 10.10 ç«¯åˆ°ç«¯æ‰§è¡Œæµç¨‹ - å®Œæ•´äº¤æ˜“å†³ç­–é“¾è·¯

## ğŸ¯ æœ¬èŠ‚ç›®æ ‡

å‰é¢æˆ‘ä»¬é€ä¸€å­¦ä¹ äº†TradingAgentçš„å„ä¸ªç»„ä»¶:Stateã€åˆ†æå¸ˆã€å·¥å…·ã€è¾©è®ºã€æ¡ä»¶é€»è¾‘ã€Graphç¼–æ’ã€‚ç°åœ¨,æ˜¯æ—¶å€™å°†æ‰€æœ‰ç¢ç‰‡æ‹¼æˆå®Œæ•´çš„æ‹¼å›¾äº†ã€‚

æœ¬èŠ‚å°†å¸¦ä½ ä»å¤´åˆ°å°¾è·Ÿè¸ªä¸€æ¬¡**çœŸå®çš„äº¤æ˜“å†³ç­–æµç¨‹**,ç†è§£15ä¸ªèŠ‚ç‚¹å¦‚ä½•ååŒå·¥ä½œ,Stateå¦‚ä½•åœ¨èŠ‚ç‚¹é—´æµè½¬,æœ€ç»ˆå¦‚ä½•äº§ç”Ÿä¸€ä¸ªå¯æ‰§è¡Œçš„äº¤æ˜“å†³ç­–ã€‚

## ğŸš€ ä»ä»£ç å¯åŠ¨è¯´èµ·

### å…¥å£: TradingAgentsGraphç±»

æ•´ä¸ªç³»ç»Ÿçš„å…¥å£æ˜¯`TradingAgentsGraph`ç±»:

```python
# tradingagents/graph/trading_graph.py

from tradingagents.graph.setup import GraphSetup
from tradingagents.graph.conditional_logic import ConditionalLogic

class TradingAgentsGraph:
    """TradingAgentçš„ä¸»å…¥å£ç±»"""

    def __init__(
        self,
        api_key: str,
        quick_thinking_model: str = "gpt-4o-mini",
        deep_thinking_model: str = "gpt-4o",
        max_debate_rounds: int = 1,
        max_risk_discuss_rounds: int = 1
    ):
        # 1. åˆå§‹åŒ–LLM
        self.quick_thinking_llm = ChatOpenAI(
            model=quick_thinking_model,
            api_key=api_key,
            temperature=0.7
        )
        self.deep_thinking_llm = ChatOpenAI(
            model=deep_thinking_model,
            api_key=api_key,
            temperature=0.5  # Manageréœ€è¦æ›´ç¨³å®šçš„è¾“å‡º
        )

        # 2. åˆ›å»ºå·¥å…·èŠ‚ç‚¹
        self.tool_nodes = self._create_tool_nodes()

        # 3. åˆå§‹åŒ–è®°å¿†ç³»ç»Ÿ
        self.bull_memory = FinancialSituationMemory()
        self.bear_memory = FinancialSituationMemory()
        self.trader_memory = FinancialSituationMemory()
        self.invest_judge_memory = FinancialSituationMemory()
        self.risk_manager_memory = FinancialSituationMemory()

        # 4. åˆ›å»ºæ¡ä»¶é€»è¾‘
        self.conditional_logic = ConditionalLogic(
            max_debate_rounds=max_debate_rounds,
            max_risk_discuss_rounds=max_risk_discuss_rounds
        )

        # 5. åˆ›å»ºGraph
        graph_setup = GraphSetup(
            quick_thinking_llm=self.quick_thinking_llm,
            deep_thinking_llm=self.deep_thinking_llm,
            tool_nodes=self.tool_nodes,
            bull_memory=self.bull_memory,
            bear_memory=self.bear_memory,
            trader_memory=self.trader_memory,
            invest_judge_memory=self.invest_judge_memory,
            risk_manager_memory=self.risk_manager_memory,
            conditional_logic=self.conditional_logic
        )

        self.graph = graph_setup.setup_graph()
```

### æ‰§è¡Œæ–¹æ³•: propagate()

```python
def propagate(
    self,
    company_of_interest: str,
    trade_date: str
) -> Dict:
    """
    æ‰§è¡Œå®Œæ•´çš„äº¤æ˜“å†³ç­–æµç¨‹

    Args:
        company_of_interest: ç›®æ ‡è‚¡ç¥¨ä»£ç ,å¦‚"AAPL"
        trade_date: äº¤æ˜“æ—¥æœŸ,æ ¼å¼"YYYY-MM-DD"

    Returns:
        åŒ…å«æœ€ç»ˆå†³ç­–çš„Stateå­—å…¸
    """
    # 1. åˆå§‹åŒ–State
    initial_state = {
        "company_of_interest": company_of_interest,
        "trade_date": trade_date,
        "messages": [],
        "market_report": "",
        "sentiment_report": "",
        "news_report": "",
        "fundamentals_report": "",
        "investment_debate_state": {
            "bull_history": "",
            "bear_history": "",
            "history": "",
            "current_response": "",
            "judge_decision": "",
            "count": 0
        },
        "risk_debate_state": {
            "risky_history": "",
            "safe_history": "",
            "neutral_history": "",
            "history": "",
            "latest_speaker": "",
            "current_response": "",
            "judge_decision": "",
            "count": 0
        },
        "investment_plan": "",
        "trader_investment_plan": "",
        "final_trade_decision": ""
    }

    # 2. æ‰§è¡ŒGraph
    final_state = self.graph.invoke(initial_state)

    # 3. è¿”å›æœ€ç»ˆState
    return final_state
```

## ğŸ“Š å®Œæ•´æ‰§è¡Œæµç¨‹è·Ÿè¸ª

ç°åœ¨,è®©æˆ‘ä»¬è·Ÿè¸ªä¸€æ¬¡çœŸå®çš„æ‰§è¡Œ:

```python
# ç”¨æˆ·ä»£ç 
trading_agent = TradingAgentsGraph(api_key="sk-xxx")
result = trading_agent.propagate(
    company_of_interest="AAPL",
    trade_date="2024-11-19"
)
```

### é˜¶æ®µ0: åˆå§‹åŒ– (t=0s)

```python
State = {
    "company_of_interest": "AAPL",
    "trade_date": "2024-11-19",
    "messages": [],
    # æ‰€æœ‰æŠ¥å‘Šå­—æ®µä¸ºç©º
    # æ‰€æœ‰è¾©è®ºçŠ¶æ€ä¸ºåˆå§‹å€¼
}

å½“å‰èŠ‚ç‚¹: START
ä¸‹ä¸€æ­¥: Market Analyst
```

---

### é˜¶æ®µ1: Market Analystå·¥ä½œ (t=0-15s)

#### ç¬¬1è½®: Market Analyst â†’ tools_market

```python
# Market AnalystèŠ‚ç‚¹æ‰§è¡Œ
[t=1s] Market Analystæ¥æ”¶State
[t=2s] è¯»å–: company="AAPL", date="2024-11-19"
[t=3s] LLMæ¨ç†: "æˆ‘éœ€è¦è·å–AAPLçš„ä»·æ ¼æ•°æ®"
[t=4s] ç”Ÿæˆtool_call:
       ToolCall(name="get_stock_data", args={"symbol": "AAPL"})
[t=5s] è¿”å›: {"messages": [AIMessage(content="", tool_calls=[...])]}

# Stateæ›´æ–°
State["messages"] = [
    AIMessage(content="", tool_calls=[ToolCall(...)])
]

# æ¡ä»¶åˆ¤æ–­
[t=6s] should_continue_market(State)
       â†’ last_message.tool_callså­˜åœ¨
       â†’ è¿”å› "tools_market"

# tools_marketèŠ‚ç‚¹æ‰§è¡Œ
[t=7s] tools_marketæ¥æ”¶State
[t=8s] æ‰§è¡Œ get_stock_data("AAPL")
[t=9s] APIè¿”å›: {"2024-11-19": {"open": 187.5, "close": 189.5, ...}}
[t=10s] è¿”å›: {"messages": [ToolMessage(content=json_result)]}

# Stateæ›´æ–°
State["messages"] = [
    AIMessage(..., tool_calls=[...]),
    ToolMessage(content='{"2024-11-19": {...}}')
]

# å¾ªç¯å›åˆ°Market Analyst
ä¸‹ä¸€æ­¥: Market Analyst
```

#### ç¬¬2è½®: Market Analyst â†’ tools_market

```python
[t=11s] Market Analystå†æ¬¡æ‰§è¡Œ
[t=12s] è¯»å–messages,çœ‹åˆ°ä»·æ ¼æ•°æ®
[t=13s] LLMæ¨ç†: "ä»·æ ¼ä¸Šæ¶¨2.3%,éœ€è¦æŸ¥çœ‹RSIåˆ¤æ–­è¶…ä¹°"
[t=14s] ç”Ÿæˆtool_call:
        ToolCall(name="get_indicators", args={"symbol": "AAPL", "indicator": "RSI"})
[t=15s] è¿”å›: {"messages": [AIMessage(..., tool_calls=[...])]}

# Stateæ›´æ–°
State["messages"].append(AIMessage(...))

# æ¡ä»¶åˆ¤æ–­ â†’ "tools_market"
# tools_marketæ‰§è¡Œ â†’ è¿”å›RSI=72.3
# State["messages"].append(ToolMessage(...))

# å¾ªç¯å›åˆ°Market Analyst
```

#### ç¬¬3è½®: Market Analystå®Œæˆ

```python
[t=20s] Market Analystç¬¬3æ¬¡æ‰§è¡Œ
[t=21s] è¯»å–messages,å·²æœ‰ä»·æ ¼+RSI+MACDæ•°æ®
[t=22s] LLMæ¨ç†: "æ•°æ®è¶³å¤Ÿ,å¯ä»¥ç”ŸæˆæŠ¥å‘Š"
[t=23s] ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š(æ— tool_calls):
        AIMessage(content="""
        ## å¸‚åœºæŠ€æœ¯åˆ†ææŠ¥å‘Š

        **è‚¡ç¥¨**: AAPL
        **æ—¥æœŸ**: 2024-11-19

        ### ä»·æ ¼èµ°åŠ¿
        - æ”¶ç›˜ä»·: $189.50 (+2.3%)
        - æ”¯æ’‘ä½: $185
        - é˜»åŠ›ä½: $195

        ### æŠ€æœ¯æŒ‡æ ‡
        - **RSI**: 72.3 (è¶…ä¹°åŒºåŸŸ,è­¦æƒ•å›è°ƒ)
        - **MACD**: é‡‘å‰,å‘ä¸Šè¶‹åŠ¿ç¡®è®¤

        ### ç»“è®º
        æŠ€æœ¯é¢å¼ºåŠ¿,ä½†éœ€æ³¨æ„RSIè¶…ä¹°é£é™©ã€‚
        çŸ­æœŸç›®æ ‡$195,æ”¯æ’‘åœ¨$185ã€‚
        """)

[t=24s] è¿”å›: {"messages": [...], "market_report": "..."}

# Stateæ›´æ–°
State["messages"].append(AIMessage(content="..."))
State["market_report"] = "## å¸‚åœºæŠ€æœ¯åˆ†ææŠ¥å‘Š..."

# æ¡ä»¶åˆ¤æ–­
[t=25s] should_continue_market(State)
        â†’ last_message.tool_callsä¸ºç©º
        â†’ è¿”å› "Msg Clear Market"
```

#### Msg Clear MarketèŠ‚ç‚¹

```python
[t=26s] Msg Clear Marketæ‰§è¡Œ
[t=27s] æ¸…ç†messagesä¸­çš„å·¥å…·è°ƒç”¨æ¶ˆæ¯
        ä¿ç•™æœ€ç»ˆçš„market_reportæ¶ˆæ¯
[t=28s] è¿”å›: {"messages": [clean_messages]}

# Stateæ›´æ–°
State["messages"] = [
    AIMessage(content="## å¸‚åœºæŠ€æœ¯åˆ†ææŠ¥å‘Š...")  # åªä¿ç•™æœ€ç»ˆæŠ¥å‘Š
]

ä¸‹ä¸€æ­¥: Social Analyst
```

---

### é˜¶æ®µ2: Social, News, Fundamentals Analystså·¥ä½œ (t=30-90s)

```python
# Social Analyst (t=30-45s)
[ç±»ä¼¼Market Analystçš„æµç¨‹]
  â†’ è°ƒç”¨get_newsè·å–ç¤¾äº¤åª’ä½“æƒ…ç»ª
  â†’ ç”Ÿæˆsentiment_report
  â†’ Msg Clear Social

State["sentiment_report"] = "## ç¤¾äº¤åª’ä½“æƒ…ç»ªåˆ†æ..."
State["messages"] = [...æœ€ç»ˆæŠ¥å‘Š...]

# News Analyst (t=45-60s)
  â†’ è°ƒç”¨get_global_news, get_insider_sentiment
  â†’ ç”Ÿæˆnews_report
  â†’ Msg Clear News

State["news_report"] = "## æ–°é—»åˆ†ææŠ¥å‘Š..."

# Fundamentals Analyst (t=60-90s)
  â†’ è°ƒç”¨get_fundamentals, get_income_statement
  â†’ ç”Ÿæˆfundamentals_report
  â†’ Msg Clear Fundamentals

State["fundamentals_report"] = "## åŸºæœ¬é¢åˆ†ææŠ¥å‘Š..."

# ç°åœ¨StateåŒ…å«4ä»½å®Œæ•´æŠ¥å‘Š!
ä¸‹ä¸€æ­¥: Bull Researcher
```

---

### é˜¶æ®µ3: æŠ•èµ„è¾©è®º (t=90-120s)

#### Bull Researcher (t=90-100s)

```python
[t=90s] Bull Researcheræ¥æ”¶State
[t=91s] è¯»å–4ä»½æŠ¥å‘Š:
        - market_report (æŠ€æœ¯é¢å¼ºåŠ¿,RSIè¶…ä¹°)
        - sentiment_report (æƒ…ç»ªç§¯æ,è®¨è®ºé‡æ¿€å¢)
        - news_report (æ–°äº§å“å‘å¸ƒ,ä¸­å›½å¸‚åœºä¸‹æ»‘)
        - fundamentals_report (ç›ˆåˆ©å¼ºåŠ²,ä¼°å€¼åé«˜)
[t=92s] è¯»å–è¾©è®ºå†å²: bear_history="" (Bearå°šæœªå‘è¨€)
[t=93s] LLMæ¨ç†: "ç»¼åˆçœ‹å¤š,é‡ç‚¹å¼ºè°ƒæŠ€æœ¯çªç ´å’Œæ–°äº§å“å‘¨æœŸ"
[t=95s] ç”ŸæˆBullè§‚ç‚¹:
        """
        ## Bullçš„è§‚ç‚¹

        ### æ ¸å¿ƒä¹°å…¥ç†ç”±
        1. æŠ€æœ¯é¢å¼ºåŠ¿çªç ´,MACDé‡‘å‰ç¡®è®¤ä¸Šæ¶¨è¶‹åŠ¿
        2. æ–°äº§å“å‘¨æœŸå¼€å¯,Vision Pro 2.0å³å°†å‘å¸ƒ
        3. å¸‚åœºæƒ…ç»ªæåº¦ç§¯æ,æ­£é¢æƒ…ç»ªæ¯”3.2:1
        4. ç›ˆåˆ©è´¨é‡ä¼˜å¼‚,å‡€åˆ©æ¶¦ç‡24.5%

        ### æŠ•èµ„å»ºè®®
        - æ“ä½œ: BUY
        - ä»“ä½: 40%
        - ç›®æ ‡ä»·: $195 (+2.9%)
        """

[t=100s] è¿”å›: {"investment_debate_state": {...æ›´æ–°...}}

# Stateæ›´æ–°
State["investment_debate_state"] = {
    "bull_history": "Bull: [å®Œæ•´è§‚ç‚¹]",
    "bear_history": "",
    "history": "Bull: [å®Œæ•´è§‚ç‚¹]",
    "current_response": "Bull: [å®Œæ•´è§‚ç‚¹]",
    "judge_decision": "",
    "count": 1
}

# æ¡ä»¶åˆ¤æ–­
[t=101s] should_continue_debate(State)
         â†’ count=1 < 2*1=2 (æœªè¾¾ä¸Šé™)
         â†’ current_response.startswith("Bull") == True
         â†’ è¿”å› "Bear Researcher"
```

#### Bear Researcher (t=102-112s)

```python
[t=102s] Bear Researcheræ¥æ”¶State
[t=103s] è¯»å–4ä»½æŠ¥å‘Š(åŒBull)
[t=104s] è¯»å–bull_history: "Bull: [å®Œæ•´è§‚ç‚¹]"
[t=105s] LLMæ¨ç†: "è´¨ç–‘Bullçš„ä¹è§‚,å¼ºè°ƒé£é™©"
[t=107s] ç”ŸæˆBearè§‚ç‚¹:
         """
         ## Bearçš„è§‚ç‚¹

         ### æ ¸å¿ƒé£é™©ç‚¹
         1. RSI=72.3ä¸¥é‡è¶…ä¹°,å›è°ƒæ¦‚ç‡65%
         2. P/E=37.8è¿‡é«˜,ä¼°å€¼æ³¡æ²«é£é™©
         3. ä¸­å›½å¸‚åœºé”€å”®ä¸‹æ»‘12%,å¢é•¿æ‹…å¿§
         4. å¸‚åœºæƒ…ç»ªè¿‡çƒ­,å¯èƒ½æ˜¯é¡¶éƒ¨ä¿¡å·

         ### å¯¹Bullçš„è´¨ç–‘
         - Bullè¯´"è¶…ä¹°å¯æŒç»­",ä½†å†å²æ•°æ®ä¸æ”¯æŒ
         - 40%ä»“ä½è¿‡äºæ¿€è¿›,é£é™©å¤§äºæœºä¼š

         ### æŠ•èµ„å»ºè®®
         - æ“ä½œ: HOLDè§‚æœ›
         - ä»“ä½: 10-15%æˆ–ç©ºä»“
         """

[t=112s] è¿”å›: {"investment_debate_state": {...æ›´æ–°...}}

# Stateæ›´æ–°
State["investment_debate_state"] = {
    "bull_history": "Bull: ...",
    "bear_history": "Bear: [å®Œæ•´è§‚ç‚¹]",
    "history": "Bull: ...\n\nBear: ...",
    "current_response": "Bear: [å®Œæ•´è§‚ç‚¹]",
    "count": 2
}

# æ¡ä»¶åˆ¤æ–­
[t=113s] should_continue_debate(State)
         â†’ count=2 >= 2*1=2 (è¾¾åˆ°ä¸Šé™!)
         â†’ è¿”å› "Research Manager"
```

#### Research Manager (t=114-120s)

```python
[t=114s] Research Manageræ¥æ”¶State
[t=115s] è¯»å–å®Œæ•´è¾©è®ºå†å²: history="Bull: ...\n\nBear: ..."
[t=116s] LLMæ¨ç†(ä½¿ç”¨deep_thinking_llm):
         "Bullçš„æŠ€æœ¯é¢å’Œäº§å“å‘¨æœŸè®ºæ®è¾ƒå¼º,
          ä½†Bearçš„è¶…ä¹°å’Œä¼°å€¼æ‹…å¿§æœ‰é“ç†,
          åº”é‡‡å–æŠ˜ä¸­ç­–ç•¥:é™ä½ä»“ä½,è®¾ç½®æ­¢æŸ"
[t=118s] ç”Ÿæˆè£å†³:
         """
         ## Research Managerçš„è£å†³

         ### æœ€ç»ˆå†³ç­–
         - æ“ä½œ: BUY(è°¨æ…çœ‹å¤š)
         - ä»“ä½: 25%
         - ç›®æ ‡ä»·: $193
         - æ­¢æŸ: $185

         ### å†³ç­–ä¾æ®
         æŠ€æœ¯é¢å’Œäº§å“å‘¨æœŸæ”¯æŒä¸Šæ¶¨,ä½†RSIè¶…ä¹°å’Œä¼°å€¼åé«˜
         éœ€è¦æ§åˆ¶é£é™©ã€‚25%ä»“ä½æ˜¯å¯¹ä¸ç¡®å®šæ€§çš„å°Šé‡ã€‚
         """

[t=120s] è¿”å›:
         {
             "investment_debate_state": {
                 "judge_decision": "[è£å†³å†…å®¹]"
             },
             "investment_plan": "[è£å†³å†…å®¹]"
         }

# Stateæ›´æ–°
State["investment_debate_state"]["judge_decision"] = "..."
State["investment_plan"] = "BUY, 25%, Target: $193, Stop: $185"

ä¸‹ä¸€æ­¥: Trader
```

---

### é˜¶æ®µ4: Traderå†³ç­– (t=120-130s)

```python
[t=120s] Traderæ¥æ”¶State
[t=121s] è¯»å–investment_plan: "BUY, 25%, Target: $193, Stop: $185"
[t=122s] æŸ¥è¯¢è®°å¿†ç³»ç»Ÿ: trader_memory.get_recent_trades("AAPL")
         è¿”å›: "ä¸Šæ¬¡ä¹°å…¥AAPLè·åˆ©+3%,ç­–ç•¥æœ‰æ•ˆ"
[t=123s] LLMæ¨ç†: "å°†Managerçš„å»ºè®®è½¬åŒ–ä¸ºå…·ä½“æ‰§è¡Œè®¡åˆ’"
[t=125s] ç”Ÿæˆäº¤æ˜“è®¡åˆ’:
         """
         ## äº¤æ˜“æ‰§è¡Œè®¡åˆ’

         **è‚¡ç¥¨**: AAPL
         **æ—¥æœŸ**: 2024-11-19

         ### æ“ä½œæŒ‡ä»¤
         - **åŠ¨ä½œ**: BUY
         - **æ€»ä»“ä½**: 25%
         - **åˆ†æ‰¹å»ºä»“**:
           - ç¬¬1æ‰¹: $189-190,å»º15%ä»“ä½
           - ç¬¬2æ‰¹: å›è°ƒè‡³$187-188,å†å»º10%ä»“ä½

         ### é£é™©æ§åˆ¶
         - **ç›®æ ‡è·åˆ©**: $193 (+1.8%),å‡åŠä»“ä½
         - **æ­¢æŸä½**: $185 (-2.4%),å…¨éƒ¨ç¦»åœº
         - **æœ€å¤§æŸå¤±**: -0.6% (25% * -2.4%)

         ### æ‰§è¡Œæ—¶é—´
         - å¼€ç›˜å30åˆ†é’Ÿå†…æ‰§è¡Œç¬¬1æ‰¹
         - ç¬¬2æ‰¹ç­‰å¾…å›è°ƒæˆ–æ”¾å¼ƒ
         """

[t=130s] è¿”å›: {"trader_investment_plan": "[æ‰§è¡Œè®¡åˆ’]"}

# Stateæ›´æ–°
State["trader_investment_plan"] = "## äº¤æ˜“æ‰§è¡Œè®¡åˆ’..."

# æ›´æ–°è®°å¿†
trader_memory.add_trade("AAPL", "BUY", 0.25, plan="...")

ä¸‹ä¸€æ­¥: Risky Analyst
```

---

### é˜¶æ®µ5: é£é™©ç®¡ç†è¾©è®º (t=130-160s)

#### Risky Analyst (t=130-135s)

```python
[t=130s] Risky Analystæ¥æ”¶State
[t=131s] è¯»å–trader_investment_plan
[t=132s] LLMæ¨ç†: "ä»æ¿€è¿›è§’åº¦,è®¤ä¸º25%ä»“ä½è¿‡äºä¿å®ˆ"
[t=133s] ç”ŸæˆRiskyè§‚ç‚¹:
         """
         ## Risky Analystçš„è§‚ç‚¹

         Traderçš„25%ä»“ä½è¿‡äºä¿å®ˆ!

         ### ç†ç”±
         - æŠ€æœ¯é¢é‡‘å‰,åŠ¨èƒ½å¼ºåŠ²,åº”è¯¥æ”¾å¤§ä»“ä½
         - æ–°äº§å“å‘¨æœŸé”™è¿‡æœºä¼šæˆæœ¬é«˜
         - å»ºè®®: æé«˜åˆ°**50%ä»“ä½**
         """

[t=135s] è¿”å›: {"risk_debate_state": {...æ›´æ–°...}}

# Stateæ›´æ–°
State["risk_debate_state"] = {
    "risky_history": "Risky: ...",
    "latest_speaker": "Risky: ...",
    "count": 1
}

# æ¡ä»¶åˆ¤æ–­ â†’ "Safe Analyst"
```

#### Safe Analyst (t=136-141s)

```python
[t=136s] Safe Analystæ¥æ”¶State
[t=137s] è¯»å–risky_history
[t=138s] LLMæ¨ç†: "ä»ä¿å®ˆè§’åº¦,è®¤ä¸º25%ä»ç„¶æœ‰é£é™©"
[t=139s] ç”ŸæˆSafeè§‚ç‚¹:
         """
         ## Safe Analystçš„è§‚ç‚¹

         Riskyå¤ªæ¿€è¿›äº†!25%éƒ½å«Œå¤š!

         ### ç†ç”±
         - RSIè¶…ä¹°,å›è°ƒé£é™©è¢«ä½ä¼°
         - ä¼°å€¼æ³¡æ²«,å®‰å…¨è¾¹é™…ä¸è¶³
         - å»ºè®®: é™ä½åˆ°**10%ä»“ä½**,è§‚æœ›ä¸ºä¸»
         """

[t=141s] è¿”å›: {"risk_debate_state": {...æ›´æ–°...}}

# Stateæ›´æ–°
State["risk_debate_state"]["count"] = 2
State["risk_debate_state"]["latest_speaker"] = "Safe: ..."

# æ¡ä»¶åˆ¤æ–­ â†’ "Neutral Analyst"
```

#### Neutral Analyst (t=142-147s)

```python
[t=142s] Neutral Analystæ¥æ”¶State
[t=143s] è¯»å–risky_historyå’Œsafe_history
[t=144s] LLMæ¨ç†: "å¹³è¡¡åŒæ–¹è§‚ç‚¹"
[t=145s] ç”ŸæˆNeutralè§‚ç‚¹:
         """
         ## Neutral Analystçš„è§‚ç‚¹

         ### ç»¼åˆåˆ†æ
         - Riskyçš„50%è¿‡äºæ¿€è¿›,å¿½è§†é£é™©
         - Safeçš„10%è¿‡äºä¿å®ˆ,é”™å¤±æœºä¼š
         - Traderçš„25%è¾ƒä¸ºåˆç†,å»ºè®®**ç»´æŒ25%**

         ### ä¼˜åŒ–å»ºè®®
         - ä¸¥æ ¼æ‰§è¡Œæ­¢æŸ$185
         - åˆ†æ‰¹å»ºä»“é™ä½æˆæœ¬
         - ç›®æ ‡$193åå‡åŠé”åˆ©
         """

[t=147s] è¿”å›: {"risk_debate_state": {...æ›´æ–°...}}

# Stateæ›´æ–°
State["risk_debate_state"]["count"] = 3

# æ¡ä»¶åˆ¤æ–­
[t=148s] should_continue_risk_analysis(State)
         â†’ count=3 >= 3*1=3 (è¾¾åˆ°ä¸Šé™!)
         â†’ è¿”å› "Risk Judge"
```

#### Risk Judge (t=148-160s)

```python
[t=148s] Risk Judgeæ¥æ”¶State
[t=149s] è¯»å–ä¸‰æ–¹è§‚ç‚¹: risky, safe, neutral
[t=150s] è¯»å–trader_investment_plan
[t=152s] LLMæ¨ç†(ä½¿ç”¨deep_thinking_llm):
         "Neutralçš„è§‚ç‚¹æœ€ä¸ºå¹³è¡¡,25%ä»“ä½åˆç†,
          ä½†éœ€è¦å¼ºè°ƒé£æ§çºªå¾‹"
[t=155s] ç”Ÿæˆæœ€ç»ˆè£å†³:
         """
         ## æœ€ç»ˆäº¤æ˜“å†³ç­–

         **è‚¡ç¥¨**: AAPL
         **æ—¥æœŸ**: 2024-11-19
         **å†³ç­–æ—¶é—´**: 2024-11-19 09:30:00

         ### äº¤æ˜“æŒ‡ä»¤
         - **æ“ä½œ**: BUY
         - **ä»“ä½**: 25%
         - **ç›®æ ‡ä»·**: $193 (+1.8%)
         - **æ­¢æŸä»·**: $185 (-2.4%)

         ### æ‰§è¡Œç­–ç•¥
         é‡‡çº³Neutral Analystå»ºè®®:
         1. ç¬¬1æ‰¹15%ä»“ä½,ä»·æ ¼$189-190
         2. ç¬¬2æ‰¹10%ä»“ä½,å›è°ƒ$187-188æˆ–æ”¾å¼ƒ
         3. ä¸¥æ ¼æ­¢æŸ,ä¸å¯è¿èƒŒ

         ### é£é™©è¯„ä¼°
         - æ½œåœ¨æ”¶ç›Š: +1.8% * 25% = +0.45%
         - æœ€å¤§æŸå¤±: -2.4% * 25% = -0.6%
         - é£é™©æ”¶ç›Šæ¯”: 1:0.75 (å¯æ¥å—)

         ### å†³ç­–ä¾æ®
         - æŠ€æœ¯é¢: âœ… å¼ºåŠ¿(ä½†è¶…ä¹°éœ€è­¦æƒ•)
         - åŸºæœ¬é¢: âš ï¸ ç›ˆåˆ©å¼ºåŠ²ä½†ä¼°å€¼åé«˜
         - æƒ…ç»ªé¢: âœ… ç§¯æ(æ³¨æ„è¿‡çƒ­)
         - é£é™©é¢: âš ï¸ ä¸­ç­‰é£é™©,éœ€ä¸¥æ ¼æ­¢æŸ

         **æœ€ç»ˆå†³å®š**: æ‰§è¡ŒBUY,25%ä»“ä½,ä¸¥å®ˆçºªå¾‹
         """

[t=160s] è¿”å›: {"final_trade_decision": "[æœ€ç»ˆå†³ç­–]"}

# Stateæ›´æ–°
State["final_trade_decision"] = "## æœ€ç»ˆäº¤æ˜“å†³ç­–..."
State["risk_debate_state"]["judge_decision"] = "..."

# æ›´æ–°è®°å¿†
risk_manager_memory.add_decision("AAPL", decision="...")

ä¸‹ä¸€æ­¥: END
```

---

### é˜¶æ®µ6: ç»“æŸ (t=160s)

```python
[t=160s] Graphæ‰§è¡Œå®Œæˆ
[t=161s] è¿”å›æœ€ç»ˆStateç»™ç”¨æˆ·

final_state = {
    "company_of_interest": "AAPL",
    "trade_date": "2024-11-19",
    "messages": [...ç²¾ç®€åçš„æ¶ˆæ¯é“¾...],
    "market_report": "## å¸‚åœºæŠ€æœ¯åˆ†ææŠ¥å‘Š...",
    "sentiment_report": "## ç¤¾äº¤åª’ä½“æƒ…ç»ªåˆ†æ...",
    "news_report": "## æ–°é—»åˆ†ææŠ¥å‘Š...",
    "fundamentals_report": "## åŸºæœ¬é¢åˆ†ææŠ¥å‘Š...",
    "investment_debate_state": {
        "bull_history": "Bull: ...",
        "bear_history": "Bear: ...",
        "history": "Bull: ...\n\nBear: ...",
        "judge_decision": "Research Manager: ..."
    },
    "risk_debate_state": {
        "risky_history": "Risky: ...",
        "safe_history": "Safe: ...",
        "neutral_history": "Neutral: ...",
        "judge_decision": "Risk Judge: ..."
    },
    "investment_plan": "BUY, 25%, Target: $193, Stop: $185",
    "trader_investment_plan": "## äº¤æ˜“æ‰§è¡Œè®¡åˆ’...",
    "final_trade_decision": "## æœ€ç»ˆäº¤æ˜“å†³ç­–..."
}
```

## ğŸ“Š æ•°æ®æµå¯è§†åŒ–

è®©æˆ‘ä»¬ç”¨å›¾è¡¨æ€»ç»“Stateçš„å¡«å……è¿‡ç¨‹:

| æ—¶é—´ | å½“å‰èŠ‚ç‚¹ | Stateå˜åŒ– | å…³é”®å­—æ®µ |
|-----|---------|----------|---------|
| t=0s | START | åˆå§‹åŒ– | æ‰€æœ‰å­—æ®µä¸ºç©º |
| t=0-30s | Market Analyst | âœ… | `market_report` |
| t=30-45s | Social Analyst | âœ… | `sentiment_report` |
| t=45-60s | News Analyst | âœ… | `news_report` |
| t=60-90s | Fundamentals Analyst | âœ… | `fundamentals_report` |
| t=90-100s | Bull Researcher | âœ… | `investment_debate_state.bull_history` |
| t=102-112s | Bear Researcher | âœ… | `investment_debate_state.bear_history` |
| t=114-120s | Research Manager | âœ… | `investment_plan`, `judge_decision` |
| t=120-130s | Trader | âœ… | `trader_investment_plan` |
| t=130-135s | Risky Analyst | âœ… | `risk_debate_state.risky_history` |
| t=136-141s | Safe Analyst | âœ… | `risk_debate_state.safe_history` |
| t=142-147s | Neutral Analyst | âœ… | `risk_debate_state.neutral_history` |
| t=148-160s | Risk Judge | âœ… | `final_trade_decision` |
| t=160s | END | å®Œæˆ | æ‰€æœ‰å­—æ®µå·²å¡«å…… |

## ğŸ” å…³é”®æ‰§è¡Œç‰¹æ€§

### 1. æ¸è¿›å¼ä¿¡æ¯ç§¯ç´¯

```python
# t=0s
State["market_report"] = ""
State["sentiment_report"] = ""
State["news_report"] = ""
State["fundamentals_report"] = ""

# t=90s (åˆ†æå¸ˆé˜¶æ®µå®Œæˆ)
State["market_report"] = "âœ… å®Œæ•´æŠ¥å‘Š"
State["sentiment_report"] = "âœ… å®Œæ•´æŠ¥å‘Š"
State["news_report"] = "âœ… å®Œæ•´æŠ¥å‘Š"
State["fundamentals_report"] = "âœ… å®Œæ•´æŠ¥å‘Š"

# ä¿¡æ¯åƒæ»šé›ªçƒä¸€æ ·è¶Šæ»šè¶Šå¤§
```

### 2. å¾ªç¯çš„åŠ¨æ€ç»ˆæ­¢

```python
# Market Analystçš„å¾ªç¯
è½®æ¬¡1: tool_calls=[get_stock_data] â†’ ç»§ç»­
è½®æ¬¡2: tool_calls=[get_indicators] â†’ ç»§ç»­
è½®æ¬¡3: tool_calls=[] â†’ ç»ˆæ­¢

# è¾©è®ºçš„å¾ªç¯
Bullå‘è¨€(count=1) â†’ ç»§ç»­
Bearå›åº”(count=2) â†’ ç»ˆæ­¢(å› ä¸ºcount >= 2*1)
```

### 3. æ¶ˆæ¯æ¸…ç†æœºåˆ¶

```python
# Market Analystæ‰§è¡Œå‰
messages = []

# Market Analystæ‰§è¡Œä¸­
messages = [
    AIMessage("éœ€è¦ä»·æ ¼æ•°æ®", tool_calls=[...]),
    ToolMessage("ä»·æ ¼æ•°æ®: {...}"),
    AIMessage("éœ€è¦RSI", tool_calls=[...]),
    ToolMessage("RSIæ•°æ®: {...}"),
    AIMessage("æœ€ç»ˆæŠ¥å‘Š: ...")
]  # 5æ¡æ¶ˆæ¯

# Msg Clear Marketæ‰§è¡Œå
messages = [
    AIMessage("æœ€ç»ˆæŠ¥å‘Š: ...")
]  # åªä¿ç•™1æ¡!
```

**å¥½å¤„**: èŠ‚çœtokens,é¿å…contextè¿‡é•¿ã€‚

### 4. è®°å¿†ç³»ç»Ÿçš„ä½¿ç”¨

```python
# TraderæŸ¥è¯¢å†å²
[t=122s] trader_memory.get_recent_trades("AAPL")
         è¿”å›: "ä¸Šæ¬¡ä¹°å…¥AAPLè·åˆ©+3%,ç­–ç•¥æœ‰æ•ˆ"

# Traderæ›´æ–°è®°å¿†
[t=130s] trader_memory.add_trade("AAPL", "BUY", 0.25, ...)

# ä¸‹æ¬¡æ‰§è¡Œæ—¶å¯ä»¥å‚è€ƒ
[ä¸‹æ¬¡] trader_memory.get_recent_trades("AAPL")
       è¿”å›: "æœ¬æ¬¡ä¹°å…¥25%,ç›®æ ‡$193..." (åŒ…å«æœ¬æ¬¡å†³ç­–)
```

## ğŸ’¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### 1. å¹¶è¡Œæ‰§è¡Œåˆ†æå¸ˆ(ç†è®ºä¸Š)

è™½ç„¶å½“å‰å®ç°æ˜¯ä¸²è¡Œ,ä½†å¯ä»¥ä¼˜åŒ–ä¸ºå¹¶è¡Œ:

```python
# âŒ å½“å‰: ä¸²è¡Œæ‰§è¡Œ(æ€»æ—¶é—´90s)
Market Analyst (30s) â†’ Social (15s) â†’ News (15s) â†’ Fundamentals (30s)

# âœ… ä¼˜åŒ–: å¹¶è¡Œæ‰§è¡Œ(æ€»æ—¶é—´30s)
Market Analyst (30s) â”
Social Analyst (15s) â”œâ†’ åŒæ—¶æ‰§è¡Œ â†’ æœ€æ…¢çš„30såå…¨éƒ¨å®Œæˆ
News Analyst (15s)   â”‚
Fundamentals (30s)   â”˜
```

LangGraphæ”¯æŒå¹¶è¡Œæ‰§è¡Œ,åªéœ€ä¿®æ”¹Graphç»“æ„:

```python
# å¹¶è¡Œå¯åŠ¨4ä¸ªåˆ†æå¸ˆ
workflow.add_edge(START, "Market Analyst")
workflow.add_edge(START, "Social Analyst")
workflow.add_edge(START, "News Analyst")
workflow.add_edge(START, "Fundamentals Analyst")

# å…¨éƒ¨å®Œæˆåæ±‡èš
workflow.add_edge("Msg Clear Market", "Aggregator")
workflow.add_edge("Msg Clear Social", "Aggregator")
workflow.add_edge("Msg Clear News", "Aggregator")
workflow.add_edge("Msg Clear Fundamentals", "Aggregator")

# Aggregatorç¡®è®¤æ‰€æœ‰æŠ¥å‘Šå°±ç»ªå â†’ Bull Researcher
```

### 2. ç¼“å­˜å·¥å…·è°ƒç”¨ç»“æœ

```python
# é¿å…é‡å¤çš„APIè°ƒç”¨
cache = {}

def get_stock_data_cached(symbol):
    key = f"{symbol}_{date.today()}"
    if key in cache:
        return cache[key]

    result = get_stock_data(symbol)
    cache[key] = result
    return result
```

### 3. è°ƒæ•´è¾©è®ºè½®æ•°

```python
# ç®€å•å†³ç­– - 1è½®è¾©è®º(å¿«é€Ÿ,æˆæœ¬ä½)
conditional_logic = ConditionalLogic(
    max_debate_rounds=1,
    max_risk_discuss_rounds=1
)
# æ€»æ—¶é—´: ~2åˆ†é’Ÿ

# å¤æ‚å†³ç­– - 3è½®è¾©è®º(æ·±å…¥,æˆæœ¬é«˜)
conditional_logic = ConditionalLogic(
    max_debate_rounds=3,
    max_risk_discuss_rounds=2
)
# æ€»æ—¶é—´: ~5åˆ†é’Ÿ
```

## ğŸ¤” å¸¸è§é—®é¢˜è§£ç­”

### Q: å¦‚æœæŸä¸ªAgentå¤±è´¥äº†æ€ä¹ˆåŠ?

**ç­”æ¡ˆ**: LangGraphæœ‰å†…ç½®çš„é”™è¯¯å¤„ç†:

```python
try:
    final_state = self.graph.invoke(initial_state)
except Exception as e:
    print(f"Graphæ‰§è¡Œå¤±è´¥: {e}")
    # å¯ä»¥æŸ¥çœ‹å¤±è´¥æ—¶çš„State
    # å¯ä»¥é‡è¯•æˆ–é™çº§å¤„ç†
```

### Q: èƒ½å¦è·³è¿‡æŸäº›èŠ‚ç‚¹?

**ç­”æ¡ˆ**: å¯ä»¥é€šè¿‡`selected_analysts`å‚æ•°:

```python
# åªç”¨å¸‚åœºå’ŒåŸºæœ¬é¢åˆ†æ
graph_setup.setup_graph(selected_analysts=["market", "fundamentals"])
# Bull/Bearä¼šåŸºäº2ä»½æŠ¥å‘Šè¿›è¡Œè¾©è®º
```

### Q: å¦‚ä½•è°ƒè¯•ä¸­é—´çŠ¶æ€?

**ç­”æ¡ˆ**: ä½¿ç”¨LangGraphçš„streamingæ¨¡å¼:

```python
for state in self.graph.stream(initial_state):
    print(f"å½“å‰èŠ‚ç‚¹: {state}")
    print(f"Stateæ›´æ–°: {state}")
```

### Q: messagesä¼šä¸ä¼šå¤ªé•¿å¯¼è‡´è¶…é™?

**ç­”æ¡ˆ**: è¿™æ­£æ˜¯Msg ClearèŠ‚ç‚¹çš„ä½œç”¨!æ¯ä¸ªåˆ†æå¸ˆå®Œæˆåç«‹å³æ¸…ç†,åªä¿ç•™æœ€ç»ˆæŠ¥å‘Šã€‚

## ğŸ“ æœ¬èŠ‚å°ç»“

é€šè¿‡æœ¬èŠ‚,ä½ åº”è¯¥å·²ç»æŒæ¡:

âœ… **å®Œæ•´æ‰§è¡Œæµç¨‹**: ä»STARTåˆ°ENDçš„160ç§’æ—…ç¨‹

âœ… **Stateå¡«å……è¿‡ç¨‹**: 15ä¸ªèŠ‚ç‚¹å¦‚ä½•é€æ­¥å¡«å……State

âœ… **å¾ªç¯çš„å®é™…è¿ä½œ**: ReActå¾ªç¯å’Œè¾©è®ºå¾ªç¯çš„åŠ¨æ€ç»ˆæ­¢

âœ… **æ—¶é—´çº¿åˆ†æ**: æ¯ä¸ªé˜¶æ®µçš„æ‰§è¡Œæ—¶é•¿å’Œå…³é”®äº‹ä»¶

âœ… **æ€§èƒ½ä¼˜åŒ–**: å¹¶è¡Œæ‰§è¡Œã€ç¼“å­˜ã€è½®æ•°è°ƒæ•´

âœ… **æ ¸å¿ƒé—®ç­”**:
- ç«¯åˆ°ç«¯å¦‚ä½•æ‰§è¡Œ? â†’ 6ä¸ªé˜¶æ®µ,15ä¸ªèŠ‚ç‚¹,160ç§’
- Stateå¦‚ä½•ç§¯ç´¯? â†’ æ¸è¿›å¼å¡«å……,æ¯ä¸ªé˜¶æ®µè´Ÿè´£ç‰¹å®šå­—æ®µ
- å¦‚ä½•ä¼˜åŒ–æ€§èƒ½? â†’ å¹¶è¡Œåˆ†æå¸ˆ,ç¼“å­˜å·¥å…·è°ƒç”¨,è°ƒæ•´è¾©è®ºè½®æ•°

ç°åœ¨ä½ å·²ç»å®Œå…¨ç†è§£äº†TradingAgentçš„è¿ä½œæœºåˆ¶ã€‚ä»åˆå§‹åŒ–åˆ°æœ€ç»ˆå†³ç­–,ä»æ•°æ®æ”¶é›†åˆ°é£é™©ç®¡ç†,è¿™ä¸ªç³»ç»Ÿå±•ç¤ºäº†LangGraphåœ¨å¤æ‚å¤šæ™ºèƒ½ä½“åä½œä¸­çš„å¼ºå¤§èƒ½åŠ›ã€‚

---

**ä¸Šä¸€èŠ‚**: [10.9 æ¡ä»¶é€»è¾‘ä¸Graphç¼–æ’-æµç¨‹æ§åˆ¶çš„è‰ºæœ¯](./10.9%20æ¡ä»¶é€»è¾‘ä¸Graphç¼–æ’-æµç¨‹æ§åˆ¶çš„è‰ºæœ¯.md)

**ä¸‹ä¸€èŠ‚**: [10.11 å®æˆ˜è¿è¡Œä¸ç»“æœåˆ†æ](./10.11%20å®æˆ˜è¿è¡Œä¸ç»“æœåˆ†æ.md)

**è¿”å›ç›®å½•**: [10.0 æœ¬ç« ä»‹ç»](./10.0%20æœ¬ç« ä»‹ç».md)
