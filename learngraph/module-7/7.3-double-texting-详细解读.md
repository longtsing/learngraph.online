# 6.3 Double Texting - è¯¦ç»†è§£è¯»

## ä¸€ã€æ¦‚è¿°

### 1.1 æœ¬èŠ‚ç®€ä»‹

åœ¨çœŸå®çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç”¨æˆ·ç»å¸¸ä¼š**å¿«é€Ÿè¿ç»­å‘é€å¤šæ¡æ¶ˆæ¯**ï¼Œè€Œä¸æ˜¯è€å¿ƒç­‰å¾… AI å›å¤å®Œæˆã€‚è¿™ç§è¡Œä¸ºè¢«ç§°ä¸º **Double Texting**ï¼ˆåŒå‡»å‘é€/è¿å‘æ¶ˆæ¯ï¼‰ã€‚

**å…¸å‹åœºæ™¯**ï¼š
```
ç”¨æˆ·ï¼š"å¸®æˆ‘æ·»åŠ ä¸€ä¸ªå¾…åŠäº‹é¡¹..."
      â†“ (AI æ­£åœ¨å¤„ç†)
ç”¨æˆ·ï¼š"å“¦ï¼Œç­‰ç­‰ï¼Œè¿˜è¦æ·»åŠ å¦ä¸€ä¸ª..."
      â†“ (ç¬¬ä¸€ä¸ªè¿˜æ²¡å®Œæˆ!)
ç”¨æˆ·ï¼š"ç®—äº†ï¼Œæ”¹æˆ..."
```

å¦‚æœç³»ç»Ÿä¸èƒ½ä¼˜é›…åœ°å¤„ç†è¿™ç§æƒ…å†µï¼Œä¼šå¯¼è‡´ï¼š
- è¯·æ±‚å†²çª
- æ•°æ®ä¸ä¸€è‡´
- ç”¨æˆ·ä½“éªŒå·®
- ç³»ç»Ÿå´©æºƒ

### 1.2 ä¸ºä»€ä¹ˆ Double Texting æ˜¯ä¸ªé—®é¢˜ï¼Ÿ

**é—®é¢˜çš„æœ¬è´¨**ï¼š**å¹¶å‘è®¿é—®åŒä¸€ä¸ªçº¿ç¨‹**

```
Thread (çº¿ç¨‹)
    â†“
Run 1 æ­£åœ¨æ‰§è¡Œ
    â†“ (ä¿®æ”¹çŠ¶æ€)
Run 2 ä¹Ÿæƒ³å¼€å§‹
    â†“ (ä¹Ÿè¦ä¿®æ”¹çŠ¶æ€)
å†²çªï¼
```

**å¯èƒ½çš„åæœ**ï¼š
1. **æ•°æ®ç«äº‰**ï¼ˆRace Conditionï¼‰
2. **çŠ¶æ€ä¸ä¸€è‡´**
3. **éƒ¨åˆ†æ›´æ–°ä¸¢å¤±**
4. **æ‰§è¡Œé¡ºåºæ··ä¹±**

### 1.3 å››ç§å¤„ç†ç­–ç•¥

LangGraph Platform æä¾›äº†å››ç§ç­–ç•¥æ¥å¤„ç† double textingï¼š

```
å¤„ç†ç­–ç•¥
â”œâ”€â”€ 1. Rejectï¼ˆæ‹’ç»ï¼‰
â”‚   â””â”€â”€ æ‹’ç»æ–°è¯·æ±‚ï¼Œè¿”å›é”™è¯¯
â”‚
â”œâ”€â”€ 2. Enqueueï¼ˆæ’é˜Ÿï¼‰
â”‚   â””â”€â”€ å°†æ–°è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œé¡ºåºæ‰§è¡Œ
â”‚
â”œâ”€â”€ 3. Interruptï¼ˆä¸­æ–­ï¼‰
â”‚   â””â”€â”€ ä¸­æ–­å½“å‰è¿è¡Œï¼Œä¿å­˜è¿›åº¦ï¼Œæ‰§è¡Œæ–°è¯·æ±‚
â”‚
â””â”€â”€ 4. Rollbackï¼ˆå›æ»šï¼‰
    â””â”€â”€ åˆ é™¤ç¬¬ä¸€ä¸ªè¿è¡Œï¼Œåªæ‰§è¡Œç¬¬äºŒä¸ª
```

### 1.4 ç­–ç•¥å¯¹æ¯”é€Ÿè§ˆ

| ç­–ç•¥ | ç¬¬ä¸€ä¸ªè¯·æ±‚ | ç¬¬äºŒä¸ªè¯·æ±‚ | ç”¨æˆ·çœ‹åˆ° | é€‚ç”¨åœºæ™¯ |
|------|----------|----------|---------|---------|
| **Reject** | âœ… å®Œæˆ | âŒ è¢«æ‹’ç» | åªæœ‰ç¬¬ä¸€ä¸ªç»“æœ | ä¸¥æ ¼é¡ºåºæ§åˆ¶ |
| **Enqueue** | âœ… å®Œæˆ | âœ… å®Œæˆ | ä¸¤ä¸ªç»“æœéƒ½æœ‰ | æ‰€æœ‰è¯·æ±‚éƒ½é‡è¦ |
| **Interrupt** | âš ï¸ ä¸­æ–­ä½†ä¿å­˜ | âœ… å®Œæˆ | ç¬¬äºŒä¸ªç»“æœ + ç¬¬ä¸€ä¸ªå†å² | ç”¨æˆ·çº æ­£/è¡¥å…… |
| **Rollback** | âŒ åˆ é™¤ | âœ… å®Œæˆ | åªæœ‰ç¬¬äºŒä¸ªç»“æœ | ç”¨æˆ·å®Œå…¨æ”¹å˜ä¸»æ„ |

### 1.5 å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œä½ å°†æŒæ¡ï¼š

1. **ç†è§£ Double Texting é—®é¢˜**
   - ä»€ä¹ˆæ˜¯ double texting
   - ä¸ºä»€ä¹ˆéœ€è¦å¤„ç†
   - å®é™…åº”ç”¨åœºæ™¯

2. **å››ç§ç­–ç•¥çš„ä½¿ç”¨**
   - Rejectï¼šå¦‚ä½•æ‹’ç»å¹¶å‘è¯·æ±‚
   - Enqueueï¼šå¦‚ä½•æ’é˜Ÿå¤„ç†
   - Interruptï¼šå¦‚ä½•ä¸­æ–­å’Œç»§ç»­
   - Rollbackï¼šå¦‚ä½•å›æ»šé‡æ¥

3. **ç­–ç•¥é€‰æ‹©**
   - ä¸åŒåœºæ™¯é€‰æ‹©ä¸åŒç­–ç•¥
   - æƒè¡¡åˆ©å¼Š
   - æœ€ä½³å®è·µ

---

## äºŒã€ç¯å¢ƒå‡†å¤‡

### 2.1 å®‰è£… SDK

```python
%%capture --no-stderr
%pip install -U langgraph_sdk
```

### 2.2 è¿æ¥åˆ°éƒ¨ç½²

```python
from langgraph_sdk import get_client

url_for_cli_deployment = "http://localhost:8123"
client = get_client(url=url_for_cli_deployment)
```

**å‰ææ¡ä»¶**ï¼š
- éƒ¨ç½²å·²å¯åŠ¨ï¼ˆ`docker compose up`ï¼‰
- `task_maistro` å›¾å·²éƒ¨ç½²
- API å¯è®¿é—®

---

## ä¸‰ã€ç­–ç•¥ 1ï¼šRejectï¼ˆæ‹’ç»ï¼‰

### 3.1 æ¦‚å¿µ

**Reject ç­–ç•¥**ï¼šæ‹’ç»ä»»ä½•æ–°çš„å¹¶å‘è¯·æ±‚ï¼Œç›´åˆ°å½“å‰è¿è¡Œå®Œæˆã€‚

```
ç”¨æˆ·è¯·æ±‚ 1
    â†“
Run 1 å¼€å§‹æ‰§è¡Œ
    â†“ (æ‰§è¡Œä¸­...)
ç”¨æˆ·è¯·æ±‚ 2
    â†“
âŒ æ‹’ç»ï¼è¿”å› 409 Conflict
    â†“
Run 1 ç»§ç»­æ‰§è¡Œ
    â†“
Run 1 å®Œæˆ
    â†“
ç°åœ¨å¯ä»¥æ¥å—æ–°è¯·æ±‚
```

### 3.2 å®ç°ä»£ç 

```python
import httpx
from langchain_core.messages import HumanMessage

# åˆ›å»ºçº¿ç¨‹
thread = await client.threads.create()

# å‡†å¤‡ä¸¤ä¸ªè¯·æ±‚
user_input_1 = "Add a ToDo to follow-up with DI Repairs."
user_input_2 = "Add a ToDo to mount dresser to the wall."
config = {"configurable": {"user_id": "Test-Double-Texting"}}
graph_name = "task_maistro"

# åˆ›å»ºç¬¬ä¸€ä¸ªè¿è¡Œ
run = await client.runs.create(
    thread["thread_id"],
    graph_name,
    input={"messages": [HumanMessage(content=user_input_1)]},
    config=config,
)

# å°è¯•åˆ›å»ºç¬¬äºŒä¸ªè¿è¡Œï¼ˆä¼šè¢«æ‹’ç»ï¼‰
try:
    await client.runs.create(
        thread["thread_id"],
        graph_name,
        input={"messages": [HumanMessage(content=user_input_2)]},
        config=config,
        multitask_strategy="reject",  # å…³é”®å‚æ•°ï¼
    )
except httpx.HTTPStatusError as e:
    print("Failed to start concurrent run", e)
```

**è¾“å‡º**ï¼š
```
Failed to start concurrent run Client error '409 Conflict' for url 'http://localhost:8123/threads/2b58630e-00fd-4c35-afad-a6b59e9b9104/runs'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/409
```

### 3.3 ä»£ç è¯¦è§£

**å…³é”®å‚æ•°**ï¼š
```python
multitask_strategy="reject"
```

è¿™ä¸ªå‚æ•°å‘Šè¯‰æœåŠ¡å™¨ï¼š
- å¦‚æœçº¿ç¨‹ä¸Šå·²æœ‰è¿è¡Œåœ¨æ‰§è¡Œ
- æ‹’ç»è¿™ä¸ªæ–°è¯·æ±‚
- è¿”å› HTTP 409 Conflict

**HTTP çŠ¶æ€ç  409**ï¼š
- **å«ä¹‰**ï¼šConflictï¼ˆå†²çªï¼‰
- **åœºæ™¯**ï¼šèµ„æºçŠ¶æ€å†²çª
- **å¤„ç†**ï¼šå®¢æˆ·ç«¯åº”è¯¥ç­‰å¾…å¹¶é‡è¯•

### 3.4 éªŒè¯ç¬¬ä¸€ä¸ªè¿è¡Œå®Œæˆ

```python
from langchain_core.messages import convert_to_messages

# ç­‰å¾…ç¬¬ä¸€ä¸ªè¿è¡Œå®Œæˆ
await client.runs.join(thread["thread_id"], run["run_id"])

# è·å–çº¿ç¨‹çŠ¶æ€
state = await client.threads.get_state(thread["thread_id"])
for m in convert_to_messages(state["values"]["messages"]):
    m.pretty_print()
```

**è¾“å‡º**ï¼š
```
================================ Human Message =================================
Add a ToDo to follow-up with DI Repairs.

================================== Ai Message ==================================
Tool Calls:
  UpdateMemory (call_6xqHubCPNufS0bg4tbUxC0FU)
 Call ID: call_6xqHubCPNufS0bg4tbUxC0FU
  Args:
    update_type: todo

================================= Tool Message =================================
New ToDo created:
Content: {'task': 'Follow-up with DI Repairs', 'time_to_complete': 30, 'deadline': None, ...}

================================== Ai Message ==================================
I've added a task to follow-up with DI Repairs to your ToDo list.
```

**è§‚å¯Ÿ**ï¼š
- âœ… ç¬¬ä¸€ä¸ªè¯·æ±‚æˆåŠŸå®Œæˆ
- âŒ ç¬¬äºŒä¸ªè¯·æ±‚è¢«æ‹’ç»ï¼Œæ²¡æœ‰åœ¨å†å²ä¸­
- çº¿ç¨‹åªåŒ…å«ç¬¬ä¸€ä¸ªè¯·æ±‚çš„å†…å®¹

### 3.5 Reject ç­–ç•¥çš„ç‰¹ç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•æ˜äº†
- âœ… é¿å…å†²çª
- âœ… ä¿æŒæ‰§è¡Œé¡ºåº
- âœ… èµ„æºä½¿ç”¨å¯æ§

**ç¼ºç‚¹**ï¼š
- âŒ ç”¨æˆ·çš„ç¬¬äºŒä¸ªè¯·æ±‚ä¸¢å¤±
- âŒ éœ€è¦å®¢æˆ·ç«¯å¤„ç† 409 é”™è¯¯
- âŒ ç”¨æˆ·ä½“éªŒå¯èƒ½ä¸å¥½ï¼ˆè¯·æ±‚è¢«æ‹’ç»ï¼‰

### 3.6 ä½¿ç”¨åœºæ™¯

**é€‚åˆ Reject çš„åœºæ™¯**ï¼š

1. **ä¸¥æ ¼é¡ºåºè¦æ±‚**
   ```
   é“¶è¡Œè½¬è´¦ï¼šå¿…é¡»é€ä¸ªå¤„ç†ï¼Œä¸èƒ½å¹¶å‘
   ```

2. **èµ„æºå—é™**
   ```
   æ˜‚è´µçš„ API è°ƒç”¨ï¼šé¿å…æµªè´¹èµ„æº
   ```

3. **æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·ç­‰å¾…**
   ```
   UI æ˜¾ç¤º"æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™..."
   ç¦ç”¨å‘é€æŒ‰é’®
   ```

**å®¢æˆ·ç«¯å¤„ç†ç¤ºä¾‹**ï¼š
```python
async def create_run_with_retry(client, thread_id, assistant_id, input, config, max_retries=3):
    """åˆ›å»ºè¿è¡Œï¼Œå¦‚æœé‡åˆ° 409 åˆ™é‡è¯•"""
    for attempt in range(max_retries):
        try:
            return await client.runs.create(
                thread_id,
                assistant_id,
                input=input,
                config=config,
                multitask_strategy="reject"
            )
        except httpx.HTTPStatusError as e:
            if e.response.status_code == 409 and attempt < max_retries - 1:
                print(f"Conflict, retrying... (attempt {attempt + 1})")
                await asyncio.sleep(1)  # ç­‰å¾… 1 ç§’
            else:
                raise
```

---

## å››ã€ç­–ç•¥ 2ï¼šEnqueueï¼ˆæ’é˜Ÿï¼‰

### 4.1 æ¦‚å¿µ

**Enqueue ç­–ç•¥**ï¼šå°†æ–°è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œç­‰å½“å‰è¿è¡Œå®ŒæˆåæŒ‰é¡ºåºæ‰§è¡Œã€‚

```
ç”¨æˆ·è¯·æ±‚ 1
    â†“
Run 1 å¼€å§‹æ‰§è¡Œ
    â†“
ç”¨æˆ·è¯·æ±‚ 2
    â†“
âœ… æ¥å—å¹¶åŠ å…¥é˜Ÿåˆ—
    â†“
Run 1 å®Œæˆ
    â†“
Run 2 è‡ªåŠ¨å¼€å§‹
    â†“
Run 2 å®Œæˆ
    â†“
ä¸¤ä¸ªè¯·æ±‚éƒ½å¤„ç†å®Œæˆ
```

### 4.2 å®ç°ä»£ç 

```python
# åˆ›å»ºæ–°çº¿ç¨‹
thread = await client.threads.create()

# å‡†å¤‡ä¸¤ä¸ªè¯·æ±‚
user_input_1 = "Send Erik his t-shirt gift this weekend."
user_input_2 = "Get cash and pay nanny for 2 weeks. Do this by Friday."
config = {"configurable": {"user_id": "Test-Double-Texting"}}
graph_name = "task_maistro"

# åˆ›å»ºç¬¬ä¸€ä¸ªè¿è¡Œ
first_run = await client.runs.create(
    thread["thread_id"],
    graph_name,
    input={"messages": [HumanMessage(content=user_input_1)]},
    config=config,
)

# åˆ›å»ºç¬¬äºŒä¸ªè¿è¡Œï¼ˆä¼šè¢«æ’é˜Ÿï¼‰
second_run = await client.runs.create(
    thread["thread_id"],
    graph_name,
    input={"messages": [HumanMessage(content=user_input_2)]},
    config=config,
    multitask_strategy="enqueue",  # æ’é˜Ÿç­–ç•¥
)

# ç­‰å¾…ç¬¬äºŒä¸ªè¿è¡Œå®Œæˆï¼ˆä¼šè‡ªåŠ¨ç­‰ç¬¬ä¸€ä¸ªå®Œæˆï¼‰
await client.runs.join(thread["thread_id"], second_run["run_id"])

# è·å–çº¿ç¨‹çŠ¶æ€
state = await client.threads.get_state(thread["thread_id"])
for m in convert_to_messages(state["values"]["messages"]):
    m.pretty_print()
```

**è¾“å‡º**ï¼š
```
================================ Human Message =================================
Send Erik his t-shirt gift this weekend.

================================== Ai Message ==================================
Tool Calls:
  UpdateMemory (call_svTeXPmWGTLY8aQ8EifjwHAa)
 Call ID: call_svTeXPmWGTLY8aQ8EifjwHAa
  Args:
    update_type: todo

================================= Tool Message =================================
New ToDo created:
Content: {'task': 'Send Erik his t-shirt gift', 'deadline': '2024-11-19T23:59:00', ...}

================================== Ai Message ==================================
I've updated your ToDo list to send Erik his t-shirt gift this weekend.

================================ Human Message =================================
Get cash and pay nanny for 2 weeks. Do this by Friday.

================================== Ai Message ==================================
Tool Calls:
  UpdateMemory (call_Cq0Tfn6yqccHH8n0DOucz5OQ)
 Call ID: call_Cq0Tfn6yqccHH8n0DOucz5OQ
  Args:
    update_type: todo

================================= Tool Message =================================
New ToDo created:
Content: {'task': 'Get cash and pay nanny for 2 weeks', 'deadline': '2024-11-17T23:59:00', ...}

Document af1fe011-f3c5-4c1c-b98b-181869bc2944 updated:
Plan: Update the deadline for sending Erik his t-shirt gift to this weekend, which is by 2024-11-17.

================================== Ai Message ==================================
I've updated your ToDo list to ensure you get cash and pay the nanny for 2 weeks by Friday.
```

### 4.3 ä»£ç è¯¦è§£

**å…³é”®å‚æ•°**ï¼š
```python
multitask_strategy="enqueue"
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
1. first_run åˆ›å»ºå¹¶å¼€å§‹æ‰§è¡Œ
   â†“
2. second_run åˆ›å»ºï¼Œè‡ªåŠ¨åŠ å…¥é˜Ÿåˆ—
   â†“ (ç­‰å¾…...)
3. first_run å®Œæˆ
   â†“
4. second_run è‡ªåŠ¨ä»é˜Ÿåˆ—ä¸­å–å‡ºå¹¶æ‰§è¡Œ
   â†“
5. second_run å®Œæˆ
```

**å…³é”®ç‚¹**ï¼š
- `client.runs.join(thread_id, second_run_id)` ä¼šç­‰å¾…ç›´åˆ° second_run å®Œæˆ
- è¿™éšå¼åœ°ä¹Ÿç­‰å¾…äº† first_run å®Œæˆ
- ä¸¤ä¸ªè¯·æ±‚çš„æ¶ˆæ¯éƒ½å‡ºç°åœ¨çº¿ç¨‹å†å²ä¸­

### 4.4 è§‚å¯Ÿç»“æœ

**çº¿ç¨‹åŒ…å«ä¸¤ä¸ªå®Œæ•´çš„å¯¹è¯è½®æ¬¡**ï¼š
1. ç¬¬ä¸€è½®ï¼šæ·»åŠ  Erik ç¤¼ç‰©å¾…åŠ
2. ç¬¬äºŒè½®ï¼šæ·»åŠ ä»˜ä¿å§†é’±å¾…åŠ

**æ³¨æ„**ï¼šç¬¬äºŒä¸ªè¯·æ±‚è¿˜æ›´æ–°äº†ç¬¬ä¸€ä¸ªå¾…åŠçš„æˆªæ­¢æ—¥æœŸï¼
```
Document af1fe011-f3c5-4c1c-b98b-181869bc2944 updated:
Plan: Update the deadline for sending Erik his t-shirt gift to this weekend, which is by 2024-11-17.
```

è¿™è¯´æ˜ï¼š
- ç¬¬äºŒä¸ªè¿è¡Œå¯ä»¥è®¿é—®ç¬¬ä¸€ä¸ªè¿è¡Œçš„ç»“æœ
- Store ä¸­çš„æ•°æ®åœ¨ä¸¤ä¸ªè¿è¡Œä¹‹é—´å…±äº«
- AI èƒ½å¤Ÿå…³è”ä¸¤ä¸ªè¯·æ±‚çš„ä¸Šä¸‹æ–‡

### 4.5 Enqueue ç­–ç•¥çš„ç‰¹ç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«å¤„ç†
- âœ… ä¿æŒæ‰§è¡Œé¡ºåº
- âœ… é¿å…æ•°æ®å†²çª
- âœ… ç”¨æˆ·æ— æ„ŸçŸ¥ï¼ˆä¸éœ€è¦å¤„ç†é”™è¯¯ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ ç¬¬äºŒä¸ªè¯·æ±‚éœ€è¦ç­‰å¾…
- âš ï¸ å¦‚æœç¬¬ä¸€ä¸ªè¯·æ±‚å¾ˆæ…¢ï¼Œç¬¬äºŒä¸ªä¼šå»¶è¿Ÿ
- âš ï¸ é˜Ÿåˆ—å¯èƒ½ä¼šå˜é•¿

### 4.6 ä½¿ç”¨åœºæ™¯

**é€‚åˆ Enqueue çš„åœºæ™¯**ï¼š

1. **æ‰¹é‡æ“ä½œ**
   ```python
   ç”¨æˆ·å¿«é€Ÿè¾“å…¥ï¼š
   "æ·»åŠ å¾…åŠï¼šä¹°ç‰›å¥¶"
   "æ·»åŠ å¾…åŠï¼šæ‰“ç”µè¯ç»™å¦ˆå¦ˆ"
   "æ·»åŠ å¾…åŠï¼šé¢„çº¦ç‰™åŒ»"

   â†’ å…¨éƒ¨æ’é˜Ÿï¼Œä¾æ¬¡å¤„ç†
   ```

2. **ç›¸å…³è¯·æ±‚**
   ```python
   ç”¨æˆ·ï¼š
   "æ€»ç»“æˆ‘çš„å¾…åŠ"
   "å…ˆåšå“ªä¸ªï¼Ÿ"

   â†’ ç¬¬äºŒä¸ªè¯·æ±‚ä¾èµ–ç¬¬ä¸€ä¸ªçš„ç»“æœ
   ```

3. **ä¸èƒ½ä¸¢å¤±ä»»ä½•è¯·æ±‚**
   ```python
   å®¢æˆ·æœåŠ¡ï¼šæ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯éƒ½å¿…é¡»å›å¤
   è¡¨å•æäº¤ï¼šæ‰€æœ‰æ•°æ®éƒ½å¿…é¡»ä¿å­˜
   ```

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š
```python
# èŠå¤©æœºå™¨äººç¤ºä¾‹
async def handle_user_messages(client, thread_id, messages):
    """å¤„ç†ç”¨æˆ·çš„å¤šæ¡æ¶ˆæ¯ï¼Œä½¿ç”¨ enqueue ç¡®ä¿éƒ½è¢«å¤„ç†"""
    runs = []
    for message in messages:
        run = await client.runs.create(
            thread_id,
            "chatbot",
            input={"messages": [HumanMessage(content=message)]},
            config=config,
            multitask_strategy="enqueue"
        )
        runs.append(run)

    # ç­‰å¾…æ‰€æœ‰è¿è¡Œå®Œæˆ
    for run in runs:
        await client.runs.join(thread_id, run["run_id"])

    return runs
```

---

## äº”ã€ç­–ç•¥ 3ï¼šInterruptï¼ˆä¸­æ–­ï¼‰

### 5.1 æ¦‚å¿µ

**Interrupt ç­–ç•¥**ï¼šä¸­æ–­å½“å‰è¿è¡Œï¼Œä½†ä¿å­˜å·²å®Œæˆçš„å·¥ä½œï¼Œç„¶åæ‰§è¡Œæ–°è¯·æ±‚ã€‚

```
ç”¨æˆ·è¯·æ±‚ 1
    â†“
Run 1 å¼€å§‹æ‰§è¡Œ
    â†“ (æ‰§è¡Œäº†ä¸€éƒ¨åˆ†...)
    â†“ (å·²å®Œæˆçš„å·¥ä½œè¢«ä¿å­˜)
ç”¨æˆ·è¯·æ±‚ 2
    â†“
â— ä¸­æ–­ Run 1
    â†“
ä¿å­˜ Run 1 çš„è¿›åº¦
    â†“
Run 2 å¼€å§‹æ‰§è¡Œ
    â†“
Run 2 å®Œæˆ
    â†“
Run 1 çš„éƒ¨åˆ†å·¥ä½œå’Œ Run 2 çš„å®Œæ•´å·¥ä½œéƒ½åœ¨å†å²ä¸­
```

### 5.2 å®ç°ä»£ç 

```python
import asyncio

# åˆ›å»ºæ–°çº¿ç¨‹
thread = await client.threads.create()

# å‡†å¤‡ä¸¤ä¸ªè¯·æ±‚
user_input_1 = "Give me a summary of my ToDos due tomrrow."
user_input_2 = "Never mind, create a ToDo to Order Ham for Thanksgiving by next Friday."
config = {"configurable": {"user_id": "Test-Double-Texting"}}
graph_name = "task_maistro"

# åˆ›å»ºç¬¬ä¸€ä¸ªè¿è¡Œ
interrupted_run = await client.runs.create(
    thread["thread_id"],
    graph_name,
    input={"messages": [HumanMessage(content=user_input_1)]},
    config=config,
)

# ç­‰å¾…ä¸€ç§’ï¼Œè®©ç¬¬ä¸€ä¸ªè¿è¡Œæ‰§è¡Œä¸€éƒ¨åˆ†
await asyncio.sleep(1)

# åˆ›å»ºç¬¬äºŒä¸ªè¿è¡Œï¼ˆä¼šä¸­æ–­ç¬¬ä¸€ä¸ªï¼‰
second_run = await client.runs.create(
    thread["thread_id"],
    graph_name,
    input={"messages": [HumanMessage(content=user_input_2)]},
    config=config,
    multitask_strategy="interrupt",  # ä¸­æ–­ç­–ç•¥
)

# ç­‰å¾…ç¬¬äºŒä¸ªè¿è¡Œå®Œæˆ
await client.runs.join(thread["thread_id"], second_run["run_id"])

# è·å–çº¿ç¨‹çŠ¶æ€
state = await client.threads.get_state(thread["thread_id"])
for m in convert_to_messages(state["values"]["messages"]):
    m.pretty_print()
```

**è¾“å‡º**ï¼š
```
================================ Human Message =================================
Give me a summary of my ToDos due tomrrow.

================================ Human Message =================================
Never mind, create a ToDo to Order Ham for Thanksgiving by next Friday.

================================== Ai Message ==================================
Tool Calls:
  UpdateMemory (call_Rk80tTSJzik2oY44tyUWk8FM)
 Call ID: call_Rk80tTSJzik2oY44tyUWk8FM
  Args:
    update_type: todo

================================= Tool Message =================================
New ToDo created:
Content: {'task': 'Order Ham for Thanksgiving', 'deadline': '2024-11-22T23:59:59', ...}

================================== Ai Message ==================================
I've added the task "Order Ham for Thanksgiving" to your ToDo list.
```

### 5.3 ä»£ç è¯¦è§£

**å…³é”®ç‚¹ 1**ï¼š`await asyncio.sleep(1)`
```python
await asyncio.sleep(1)
```
- ç­‰å¾… 1 ç§’
- ç»™ç¬¬ä¸€ä¸ªè¿è¡Œä¸€äº›æ‰§è¡Œæ—¶é—´
- ç¡®ä¿ç¬¬ä¸€ä¸ªè¿è¡Œå·²ç»å¼€å§‹ï¼ˆå¯èƒ½éƒ¨åˆ†å®Œæˆï¼‰

å¦‚æœä¸ç­‰å¾…ï¼Œç¬¬ä¸€ä¸ªè¿è¡Œå¯èƒ½è¿˜æ²¡å¼€å§‹å°±è¢«ä¸­æ–­äº†ã€‚

**å…³é”®ç‚¹ 2**ï¼š`multitask_strategy="interrupt"`
```python
multitask_strategy="interrupt"
```
- ä¸­æ–­å½“å‰æ­£åœ¨æ‰§è¡Œçš„è¿è¡Œ
- ä¿å­˜å·²å®Œæˆçš„å·¥ä½œ
- å¼€å§‹æ‰§è¡Œæ–°è¿è¡Œ

### 5.4 éªŒè¯ä¸­æ–­çŠ¶æ€

```python
# ç¡®è®¤ç¬¬ä¸€ä¸ªè¿è¡Œè¢«ä¸­æ–­
status = (await client.runs.get(thread["thread_id"], interrupted_run["run_id"]))["status"]
print(status)
```

**è¾“å‡º**ï¼š
```
interrupted
```

**è¿è¡ŒçŠ¶æ€è¯´æ˜**ï¼š
- `interrupted`ï¼šè¿è¡Œè¢«ä¸­æ–­
- ä¸ `success`ã€`error`ã€`pending` ä¸åŒ
- è¡¨ç¤ºè¿è¡Œæ²¡æœ‰å®Œæˆï¼Œä½†å·¥ä½œè¢«ä¿å­˜

### 5.5 è§‚å¯Ÿç»“æœ

**çº¿ç¨‹åŒ…å«**ï¼š
1. âœ… ç¬¬ä¸€ä¸ªè¯·æ±‚çš„**è¾“å…¥**ï¼ˆHuman Messageï¼‰
2. âŒ ç¬¬ä¸€ä¸ªè¯·æ±‚çš„**è¾“å‡º**ï¼ˆè¢«ä¸­æ–­ï¼Œæ²¡æœ‰å®Œæˆï¼‰
3. âœ… ç¬¬äºŒä¸ªè¯·æ±‚çš„**å®Œæ•´å¯¹è¯**

**è§£é‡Š**ï¼š
```
ç¬¬ä¸€ä¸ªè¿è¡Œï¼š
- è¾“å…¥æ¶ˆæ¯è¢«ä¿å­˜ï¼ˆå·²ç»åŠ å…¥ stateï¼‰
- AI å“åº”æœªç”Ÿæˆï¼ˆè¢«ä¸­æ–­ï¼‰

ç¬¬äºŒä¸ªè¿è¡Œï¼š
- ä»å½“å‰ state ç»§ç»­
- çœ‹åˆ°äº†ç¬¬ä¸€ä¸ªè¯·æ±‚çš„è¾“å…¥
- ç”Ÿæˆå®Œæ•´å“åº”
```

### 5.6 Interrupt vs Enqueue

**å…³é”®åŒºåˆ«**ï¼š

| å¯¹æ¯”ç‚¹ | Enqueue | Interrupt |
|--------|---------|-----------|
| **ç¬¬ä¸€ä¸ªè¿è¡Œ** | âœ… å®Œæ•´æ‰§è¡Œ | âš ï¸ è¢«ä¸­æ–­ |
| **ç¬¬ä¸€ä¸ªç»“æœ** | âœ… æœ‰å®Œæ•´å“åº” | âŒ æ²¡æœ‰å“åº” |
| **ç¬¬äºŒä¸ªè¿è¡Œ** | âœ… åœ¨ç¬¬ä¸€ä¸ªä¹‹å | âœ… ç«‹å³æ‰§è¡Œ |
| **å†å²è®°å½•** | ä¸¤ä¸ªå®Œæ•´å¯¹è¯ | ä¸€ä¸ªå®Œæ•´ + ä¸€ä¸ªéƒ¨åˆ† |
| **æ‰§è¡Œæ—¶é—´** | ç¬¬ä¸€ä¸ª + ç¬¬äºŒä¸ª | çº¦ç­‰äºç¬¬äºŒä¸ª |

### 5.7 Interrupt ç­–ç•¥çš„ç‰¹ç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… å¿«é€Ÿå“åº”æ–°è¯·æ±‚
- âœ… ä¿å­˜ç¬¬ä¸€ä¸ªè¯·æ±‚çš„è¾“å…¥ï¼ˆä¸Šä¸‹æ–‡ä¿ç•™ï¼‰
- âœ… é¿å…æµªè´¹æ—¶é—´åœ¨è¿‡æ—¶çš„è¯·æ±‚ä¸Š
- âœ… ç”¨æˆ·èƒ½ç«‹å³çœ‹åˆ°æ–°çš„å“åº”

**ç¼ºç‚¹**ï¼š
- âš ï¸ ç¬¬ä¸€ä¸ªè¯·æ±‚æ²¡æœ‰å®Œæ•´ç»“æœ
- âš ï¸ ç¬¬ä¸€ä¸ªè¯·æ±‚çš„éƒ¨åˆ†å·¥ä½œå¯èƒ½æµªè´¹
- âš ï¸ å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´ï¼ˆå¦‚æœæœ‰å‰¯ä½œç”¨ï¼‰

### 5.8 ä½¿ç”¨åœºæ™¯

**é€‚åˆ Interrupt çš„åœºæ™¯**ï¼š

1. **ç”¨æˆ·çº æ­£é”™è¯¯**
   ```
   ç”¨æˆ·ï¼š"é¢„è®¢é£å¾€çº½çº¦çš„æœºç¥¨"
      â†“ (AI æ­£åœ¨æœç´¢...)
   ç”¨æˆ·ï¼š"ç­‰ç­‰ï¼Œæˆ‘æ˜¯è¯´æ´›æ‰çŸ¶ï¼"
      â†“ (ä¸­æ–­ï¼Œç«‹å³æ”¹ä¸ºæ´›æ‰çŸ¶)
   ```

2. **ç”¨æˆ·è¡¥å……ä¿¡æ¯**
   ```
   ç”¨æˆ·ï¼š"æ€»ç»“æˆ‘çš„å¾…åŠ"
      â†“ (AI æ­£åœ¨æ•´ç†...)
   ç”¨æˆ·ï¼š"åªçœ‹æ˜å¤©åˆ°æœŸçš„"
      â†“ (ä¸­æ–­ï¼Œé‡æ–°ç­›é€‰)
   ```

3. **ç”¨æˆ·æ”¹å˜ä¸»æ„**
   ```
   ç”¨æˆ·ï¼š"ç»™æˆ‘æ¨èä¸€äº›é¤å…"
      â†“ (AI æ­£åœ¨æœç´¢...)
   ç”¨æˆ·ï¼š"ç®—äº†ï¼Œæˆ‘æƒ³çŸ¥é“ç”µå½±é™¢"
      â†“ (ä¸­æ–­ï¼Œæ”¹ä¸ºæœç´¢ç”µå½±é™¢)
   ```

4. **ä¼˜å…ˆçº§å˜åŒ–**
   ```
   ç”¨æˆ·ï¼š"åˆ†æè¿™ä¸ªå¤§æ–‡ä»¶"
      â†“ (å¤„ç†ä¸­...)
   ç”¨æˆ·ï¼š"å¿«é€ŸæŸ¥ä¸€ä¸‹ä»Šå¤©çš„å¤©æ°”"
      â†“ (ä¸­æ–­å¤§ä»»åŠ¡ï¼Œå…ˆå›ç­”å¤©æ°”)
   ```

**ä¸é€‚åˆ Interrupt çš„åœºæ™¯**ï¼š
- âŒ æœ‰å‰¯ä½œç”¨çš„æ“ä½œï¼ˆå¦‚å·²å‘é€é‚®ä»¶ã€å·²æ‰£æ¬¾ï¼‰
- âŒ ä¸å¯é€†çš„æ“ä½œ
- âŒ éœ€è¦æ‰€æœ‰è¯·æ±‚éƒ½å®Œæ•´æ‰§è¡Œçš„åœºæ™¯

---

## å…­ã€ç­–ç•¥ 4ï¼šRollbackï¼ˆå›æ»šï¼‰

### 6.1 æ¦‚å¿µ

**Rollback ç­–ç•¥**ï¼šå®Œå…¨åˆ é™¤ç¬¬ä¸€ä¸ªè¿è¡Œï¼Œå°±åƒå®ƒä»æœªå‘ç”Ÿè¿‡ï¼Œåªæ‰§è¡Œç¬¬äºŒä¸ªè¯·æ±‚ã€‚

```
ç”¨æˆ·è¯·æ±‚ 1
    â†“
Run 1 å¼€å§‹æ‰§è¡Œ
    â†“
ç”¨æˆ·è¯·æ±‚ 2
    â†“
âŒ åˆ é™¤ Run 1ï¼ˆåŒ…æ‹¬è¾“å…¥ï¼‰
    â†“
Run 2 å¼€å§‹æ‰§è¡Œ
    â†“
Run 2 å®Œæˆ
    â†“
çº¿ç¨‹ä¸­åªæœ‰ Run 2ï¼ŒRun 1 å®Œå…¨æ¶ˆå¤±
```

### 6.2 å®ç°ä»£ç 

```python
# åˆ›å»ºæ–°çº¿ç¨‹
thread = await client.threads.create()

# å‡†å¤‡ä¸¤ä¸ªè¯·æ±‚
user_input_1 = "Add a ToDo to call to make appointment at Yoga."
user_input_2 = "Actually, add a ToDo to drop by Yoga in person on Sunday."
config = {"configurable": {"user_id": "Test-Double-Texting"}}
graph_name = "task_maistro"

# åˆ›å»ºç¬¬ä¸€ä¸ªè¿è¡Œ
rolled_back_run = await client.runs.create(
    thread["thread_id"],
    graph_name,
    input={"messages": [HumanMessage(content=user_input_1)]},
    config=config,
)

# åˆ›å»ºç¬¬äºŒä¸ªè¿è¡Œï¼ˆä¼šå›æ»šç¬¬ä¸€ä¸ªï¼‰
second_run = await client.runs.create(
    thread["thread_id"],
    graph_name,
    input={"messages": [HumanMessage(content=user_input_2)]},
    config=config,
    multitask_strategy="rollback",  # å›æ»šç­–ç•¥
)

# ç­‰å¾…ç¬¬äºŒä¸ªè¿è¡Œå®Œæˆ
await client.runs.join(thread["thread_id"], second_run["run_id"])

# è·å–çº¿ç¨‹çŠ¶æ€
state = await client.threads.get_state(thread["thread_id"])
for m in convert_to_messages(state["values"]["messages"]):
    m.pretty_print()
```

**è¾“å‡º**ï¼š
```
================================ Human Message =================================
Actually, add a ToDo to drop by Yoga in person on Sunday.

================================== Ai Message ==================================
It looks like the task "Drop by Yoga in person" is already on your ToDo list
with a deadline of November 19, 2024. Would you like me to update the deadline
to the upcoming Sunday instead?
```

### 6.3 ä»£ç è¯¦è§£

**å…³é”®å‚æ•°**ï¼š
```python
multitask_strategy="rollback"
```

**ç»“æœè§‚å¯Ÿ**ï¼š
- âŒ ç¬¬ä¸€ä¸ªè¯·æ±‚**å®Œå…¨æ¶ˆå¤±**
- âŒ è¿è¾“å…¥æ¶ˆæ¯éƒ½æ²¡æœ‰
- âœ… åªæœ‰ç¬¬äºŒä¸ªè¯·æ±‚çš„å®Œæ•´å¯¹è¯

### 6.4 éªŒè¯å›æ»š

```python
# ç¡®è®¤ç¬¬ä¸€ä¸ªè¿è¡Œè¢«åˆ é™¤
try:
    await client.runs.get(thread["thread_id"], rolled_back_run["run_id"])
except httpx.HTTPStatusError as _:
    print("Original run was correctly deleted")
```

**è¾“å‡º**ï¼š
```
Original run was correctly deleted
```

å°è¯•è·å–ç¬¬ä¸€ä¸ªè¿è¡Œçš„ä¿¡æ¯ä¼šæŠ›å‡º HTTP 404 é”™è¯¯ï¼Œå› ä¸ºå®ƒå·²ç»è¢«å®Œå…¨åˆ é™¤äº†ã€‚

### 6.5 Rollback vs Interrupt

**å…³é”®åŒºåˆ«**ï¼š

| å¯¹æ¯”ç‚¹ | Interrupt | Rollback |
|--------|-----------|----------|
| **ç¬¬ä¸€ä¸ªè¾“å…¥** | âœ… ä¿ç•™ | âŒ åˆ é™¤ |
| **ç¬¬ä¸€ä¸ªçŠ¶æ€** | ä¿å­˜ | åˆ é™¤ |
| **çº¿ç¨‹å†å²** | åŒ…å«ç¬¬ä¸€ä¸ªè¾“å…¥ | åªæœ‰ç¬¬äºŒä¸ªè¯·æ±‚ |
| **Run è®°å½•** | status = interrupted | å®Œå…¨ä¸å­˜åœ¨ |
| **å¯æ¢å¤æ€§** | å¯ä»¥æŸ¥çœ‹è¢«ä¸­æ–­çš„è¿è¡Œ | æ— æ³•æŸ¥çœ‹ç¬¬ä¸€ä¸ªè¿è¡Œ |

**ç›´è§‚å¯¹æ¯”**ï¼š

```
Interrupt:
Thread History
â”œâ”€â”€ Human: "æ€»ç»“å¾…åŠ"  (ç¬¬ä¸€ä¸ªè¯·æ±‚çš„è¾“å…¥)
â””â”€â”€ Human: "åˆ›å»ºæ–°å¾…åŠ" (ç¬¬äºŒä¸ªè¯·æ±‚)
    â””â”€â”€ AI: "å·²åˆ›å»º"

Rollback:
Thread History
â””â”€â”€ Human: "åˆ›å»ºæ–°å¾…åŠ" (åªæœ‰ç¬¬äºŒä¸ªè¯·æ±‚)
    â””â”€â”€ AI: "å·²åˆ›å»º"
```

### 6.6 Rollback ç­–ç•¥çš„ç‰¹ç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… å†å²æœ€å¹²å‡€
- âœ… å°±åƒç¬¬ä¸€ä¸ªè¯·æ±‚ä»æœªå‘ç”Ÿ
- âœ… é¿å…æ··æ·†ï¼ˆæ²¡æœ‰æœªå®Œæˆçš„è¯·æ±‚ï¼‰
- âœ… èŠ‚çœå­˜å‚¨ç©ºé—´

**ç¼ºç‚¹**ï¼š
- âŒ ç¬¬ä¸€ä¸ªè¯·æ±‚çš„ä¸Šä¸‹æ–‡å®Œå…¨ä¸¢å¤±
- âŒ æ— æ³•è¿½è¸ªç”¨æˆ·æ”¹å˜ä¸»æ„çš„å†å²
- âŒ ä¸å¯é€†ï¼ˆæ— æ³•æ¢å¤ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼‰
- âŒ å¯èƒ½ä¸¢å¤±æœ‰ä»·å€¼çš„ä¿¡æ¯

### 6.7 ä½¿ç”¨åœºæ™¯

**é€‚åˆ Rollback çš„åœºæ™¯**ï¼š

1. **ç”¨æˆ·å®Œå…¨æ”¹å˜ä¸»æ„**
   ```
   ç”¨æˆ·ï¼š"é¢„è®¢å»å·´é»çš„é…’åº—"
      â†“
   ç”¨æˆ·ï¼š"ä¸å¯¹ï¼Œæ”¹æˆä¸œäº¬"
      â†“ (å®Œå…¨ä¸åŒçš„è¯·æ±‚ï¼Œæ—§çš„æ²¡ç”¨äº†)
   ```

2. **è¾“å…¥é”™è¯¯**
   ```
   ç”¨æˆ·ï¼š"æ·»åŠ å¾…åŠï¼šä¹°ç‰›å¥¶...123ABC"
      â†“ (è¯¯è§¦å‘é€ï¼Œè¾“å…¥æœªå®Œæˆ)
   ç”¨æˆ·ï¼š"æ·»åŠ å¾…åŠï¼šä¹°ç‰›å¥¶å’Œé¢åŒ…"
      â†“ (å®Œæ•´æ­£ç¡®çš„è¾“å…¥)
   ```

3. **æµ‹è¯•/å®éªŒ**
   ```
   ç”¨æˆ·ï¼š"è¯•è¯•è¿™ä¸ªåŠŸèƒ½"
      â†“ (åªæ˜¯æµ‹è¯•)
   ç”¨æˆ·ï¼š"æ­£å¼å¼€å§‹å·¥ä½œ"
      â†“ (çœŸæ­£çš„ä»»åŠ¡)
   ```

4. **ç”¨æˆ·æƒ³è¦"é‡æ–°å¼€å§‹"**
   ```
   èŠå¤©æœºå™¨äººï¼š
   ç”¨æˆ·ï¼š"ä½ å¥½"
   ç”¨æˆ·ï¼š"ä¸å¯¹ï¼Œç›´æ¥è¯´æ­£äº‹"
      â†“ (ç”¨æˆ·ä¸æƒ³è¦å¯’æš„)
   ```

**ä¸é€‚åˆ Rollback çš„åœºæ™¯**ï¼š
- âŒ ç¬¬ä¸€ä¸ªè¯·æ±‚çš„ä¸Šä¸‹æ–‡å¯¹ç¬¬äºŒä¸ªè¯·æ±‚æœ‰ç”¨
- âŒ éœ€è¦å®¡è®¡è¿½è¸ªï¼ˆaudit trailï¼‰
- âŒ ç¬¬ä¸€ä¸ªè¯·æ±‚å¯èƒ½æœ‰å‰¯ä½œç”¨

---

## ä¸ƒã€ç­–ç•¥å¯¹æ¯”å’Œé€‰æ‹©

### 7.1 è¯¦ç»†å¯¹æ¯”è¡¨

| ç‰¹æ€§ | Reject | Enqueue | Interrupt | Rollback |
|------|--------|---------|-----------|----------|
| **ç¬¬ä¸€ä¸ªè¿è¡Œ** | âœ… å®Œæˆ | âœ… å®Œæˆ | âš ï¸ ä¸­æ–­ | âŒ åˆ é™¤ |
| **ç¬¬äºŒä¸ªè¿è¡Œ** | âŒ æ‹’ç» | âœ… æ’é˜Ÿåå®Œæˆ | âœ… ç«‹å³å®Œæˆ | âœ… ç«‹å³å®Œæˆ |
| **ç¬¬ä¸€ä¸ªè¾“å…¥** | âœ… ä¿ç•™ | âœ… ä¿ç•™ | âœ… ä¿ç•™ | âŒ åˆ é™¤ |
| **ç¬¬ä¸€ä¸ªè¾“å‡º** | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âŒ æ—  | âŒ æ—  |
| **å“åº”æ—¶é—´** | å¿«ï¼ˆåªä¸€ä¸ªï¼‰ | æ…¢ï¼ˆä¸¤ä¸ªé¡ºåºï¼‰ | ä¸­ï¼ˆç¬¬äºŒä¸ªç«‹å³ï¼‰ | ä¸­ï¼ˆç¬¬äºŒä¸ªç«‹å³ï¼‰ |
| **ç”¨æˆ·ä½“éªŒ** | éœ€å¤„ç†é”™è¯¯ | æ— æ„ŸçŸ¥ç­‰å¾… | å¿«é€Ÿå“åº” | æœ€å¹²å‡€ |
| **æ•°æ®å®Œæ•´æ€§** | âœ… æœ€é«˜ | âœ… é«˜ | âš ï¸ ä¸­ | âš ï¸ ä½ |
| **å‰¯ä½œç”¨å¤„ç†** | âœ… å®‰å…¨ | âœ… å®‰å…¨ | âš ï¸ éœ€æ³¨æ„ | âŒ ä¸å®‰å…¨ |
| **å¯è¿½æº¯æ€§** | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… ä¸­ï¼ˆæœ‰interruptedçŠ¶æ€ï¼‰ | âŒ æ—  |

### 7.2 å†³ç­–æ ‘

```
ç”¨æˆ·å‘é€ç¬¬äºŒæ¡æ¶ˆæ¯
    â†“
ç¬¬ä¸€æ¡æ¶ˆæ¯è¿˜åœ¨å¤„ç†ä¸­ï¼Ÿ
    â†“
   YES
    â†“
é—®ï¼šç¬¬ä¸€æ¡æ¶ˆæ¯é‡è¦å—ï¼Ÿ
    â†“
   YES â†’ é—®ï¼šèƒ½ç­‰å—ï¼Ÿ
          â†“              â†“
         YES            NO
          â†“              â†“
       Enqueue      Interrupt
          (æ’é˜Ÿ)      (ä¸­æ–­)

   NO â†’ é—®ï¼šéœ€è¦ç¬¬ä¸€æ¡çš„ä¸Šä¸‹æ–‡å—ï¼Ÿ
         â†“              â†“
        YES            NO
         â†“              â†“
      Interrupt    Rollback
       (ä¸­æ–­)        (å›æ»š)

é—®ï¼šç³»ç»Ÿèµ„æºç´§å¼ å—ï¼Ÿ
    â†“
   YES
    â†“
  Reject
  (æ‹’ç»)
```

### 7.3 åœºæ™¯é€‰æ‹©æŒ‡å—

#### åœºæ™¯ 1ï¼šèŠå¤©æœºå™¨äºº

**æƒ…å†µ**ï¼šç”¨æˆ·åœ¨èŠå¤©
```
ç”¨æˆ·ï¼š"ä½ å¥½"
ç”¨æˆ·ï¼š"å¸®æˆ‘æŸ¥å¤©æ°”"
```

**æ¨è**ï¼š**Enqueue**
- åŸå› ï¼šä¸¤æ¡æ¶ˆæ¯éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œéƒ½åº”è¯¥å›å¤
- ç”¨æˆ·æœŸæœ›ï¼šæ”¶åˆ°ä¸¤æ¡å›å¤

#### åœºæ™¯ 2ï¼šæœç´¢/æŸ¥è¯¢

**æƒ…å†µ**ï¼šç”¨æˆ·åœ¨æœç´¢
```
ç”¨æˆ·ï¼š"æœç´¢å·´é»é…’åº—"
ç”¨æˆ·ï¼š"ä¸å¯¹ï¼Œæœç´¢ä¸œäº¬é…’åº—"
```

**æ¨è**ï¼š**Rollback**
- åŸå› ï¼šç”¨æˆ·æ”¹å˜äº†æœç´¢ç›®æ ‡
- ç¬¬ä¸€ä¸ªæœç´¢ç»“æœæ— ç”¨

#### åœºæ™¯ 3ï¼šè¡¨å•å¡«å†™

**æƒ…å†µ**ï¼šç”¨æˆ·åœ¨å¡«å†™è¡¨å•
```
ç”¨æˆ·ï¼š"æˆ‘çš„åå­—æ˜¯..."
ç”¨æˆ·ï¼š"ç­‰ç­‰ï¼Œæˆ‘å†æƒ³æƒ³"
```

**æ¨è**ï¼š**Interrupt**
- åŸå› ï¼šä¿ç•™éƒ¨åˆ†å¡«å†™çš„å†…å®¹
- ç”¨æˆ·å¯èƒ½ç»§ç»­å¡«å†™

#### åœºæ™¯ 4ï¼šäº¤æ˜“æ“ä½œ

**æƒ…å†µ**ï¼šç”¨æˆ·åœ¨è½¬è´¦
```
ç”¨æˆ·ï¼š"è½¬è´¦1000å…ƒåˆ°è´¦æˆ·A"
ç”¨æˆ·ï¼š"ä¸å¯¹ï¼Œè½¬åˆ°è´¦æˆ·B"
```

**æ¨è**ï¼š**Reject**
- åŸå› ï¼šé‡‘èäº¤æ˜“ä¸èƒ½æœ‰ä»»ä½•ä¸ç¡®å®šæ€§
- å¿…é¡»ç­‰ç¬¬ä¸€ä¸ªå®Œå…¨å¤„ç†å®Œ
- æˆ–è€…UIå±‚é¢ç¦æ­¢å¿«é€Ÿè¿å‘

#### åœºæ™¯ 5ï¼šæ–‡ä»¶å¤„ç†

**æƒ…å†µ**ï¼šç”¨æˆ·ä¸Šä¼ æ–‡ä»¶å¤„ç†
```
ç”¨æˆ·ï¼š"åˆ†æè¿™ä¸ªå¤§æ–‡ä»¶"
ç”¨æˆ·ï¼š"ç­‰ç­‰ï¼Œå…ˆçœ‹è¿™ä¸ªå°æ–‡ä»¶"
```

**æ¨è**ï¼š**Interrupt**
- åŸå› ï¼šå¤§æ–‡ä»¶å¤„ç†è€—æ—¶ï¼Œå°æ–‡ä»¶ä¼˜å…ˆçº§æ›´é«˜
- èŠ‚çœèµ„æº

### 7.4 Python å®ç°è¾…åŠ©å‡½æ•°

```python
async def create_run_with_strategy(
    client,
    thread_id,
    assistant_id,
    input,
    config,
    scenario="chat"
):
    """æ ¹æ®åœºæ™¯è‡ªåŠ¨é€‰æ‹©ç­–ç•¥"""
    strategy_map = {
        "chat": "enqueue",      # èŠå¤©ï¼šå…¨éƒ¨å¤„ç†
        "search": "rollback",   # æœç´¢ï¼šæœ€æ–°ä¼˜å…ˆ
        "form": "interrupt",    # è¡¨å•ï¼šä¿ç•™è¿›åº¦
        "transaction": "reject", # äº¤æ˜“ï¼šä¸¥æ ¼é¡ºåº
        "file": "interrupt"     # æ–‡ä»¶ï¼šå¯ä¸­æ–­
    }

    strategy = strategy_map.get(scenario, "enqueue")

    try:
        return await client.runs.create(
            thread_id,
            assistant_id,
            input=input,
            config=config,
            multitask_strategy=strategy
        )
    except httpx.HTTPStatusError as e:
        if e.response.status_code == 409:
            # Reject ç­–ç•¥è¿”å› 409ï¼Œç­‰å¾…åé‡è¯•
            await asyncio.sleep(1)
            return await create_run_with_strategy(
                client, thread_id, assistant_id, input, config, scenario
            )
        else:
            raise
```

---

## å…«ã€é«˜çº§ä¸»é¢˜

### 8.1 åŠ¨æ€ç­–ç•¥é€‰æ‹©

æ ¹æ®è¿è¡Œæ—¶æ¡ä»¶åŠ¨æ€é€‰æ‹©ç­–ç•¥ï¼š

```python
async def adaptive_create_run(client, thread_id, assistant_id, input, config):
    """è‡ªé€‚åº”ç­–ç•¥é€‰æ‹©"""

    # æ£€æŸ¥å½“å‰è¿è¡ŒçŠ¶æ€
    runs = await client.runs.list(thread_id)
    active_runs = [r for r in runs if r["status"] in ["pending", "running"]]

    if not active_runs:
        # æ²¡æœ‰æ´»è·ƒè¿è¡Œï¼Œç›´æ¥åˆ›å»º
        strategy = None
    elif len(active_runs) == 1:
        # ä¸€ä¸ªæ´»è·ƒè¿è¡Œ
        run = active_runs[0]

        # æ£€æŸ¥è¿è¡Œæ—¶é•¿
        created_at = datetime.fromisoformat(run["created_at"])
        elapsed = datetime.now(timezone.utc) - created_at

        if elapsed.seconds < 5:
            # åˆšå¼€å§‹ä¸ä¹…ï¼Œå¯ä»¥å›æ»š
            strategy = "rollback"
        elif elapsed.seconds < 30:
            # æ‰§è¡Œä¸­ï¼Œä¸­æ–­
            strategy = "interrupt"
        else:
            # æ‰§è¡Œå¾ˆä¹…äº†ï¼Œç­‰å¾…æˆ–æ‹’ç»
            strategy = "enqueue"
    else:
        # å¤šä¸ªæ´»è·ƒè¿è¡Œï¼Œæ‹’ç»
        strategy = "reject"

    return await client.runs.create(
        thread_id,
        assistant_id,
        input=input,
        config=config,
        multitask_strategy=strategy
    )
```

### 8.2 ç”¨æˆ·åé¦ˆæœºåˆ¶

è®©ç”¨æˆ·é€‰æ‹©å¦‚ä½•å¤„ç†ï¼š

```python
async def create_run_with_user_choice(client, thread_id, assistant_id, input, config):
    """è®©ç”¨æˆ·é€‰æ‹©ç­–ç•¥"""

    # æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒè¿è¡Œ
    runs = await client.runs.list(thread_id)
    active_runs = [r for r in runs if r["status"] in ["pending", "running"]]

    if active_runs:
        # è¯¢é—®ç”¨æˆ·
        print("æ£€æµ‹åˆ°æ­£åœ¨å¤„ç†çš„è¯·æ±‚ï¼Œä½ æƒ³è¦ï¼š")
        print("1. ç­‰å¾…å½“å‰è¯·æ±‚å®Œæˆåå¤„ç† (Enqueue)")
        print("2. å–æ¶ˆå½“å‰è¯·æ±‚ï¼Œç«‹å³å¤„ç†æ–°è¯·æ±‚ (Interrupt)")
        print("3. å–æ¶ˆå½“å‰è¯·æ±‚å¹¶åˆ é™¤ (Rollback)")
        print("4. å–æ¶ˆæ–°è¯·æ±‚ (Reject)")

        choice = input("è¯·é€‰æ‹© (1-4): ")

        strategy_map = {
            "1": "enqueue",
            "2": "interrupt",
            "3": "rollback",
            "4": "reject"
        }
        strategy = strategy_map.get(choice, "enqueue")
    else:
        strategy = None

    if strategy == "reject":
        print("æ–°è¯·æ±‚å·²å–æ¶ˆ")
        return None

    return await client.runs.create(
        thread_id,
        assistant_id,
        input=input,
        config=config,
        multitask_strategy=strategy
    )
```

### 8.3 ç›‘æ§å’Œæ—¥å¿—

```python
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

async def create_run_with_logging(
    client, thread_id, assistant_id, input, config, strategy
):
    """å¸¦è¯¦ç»†æ—¥å¿—çš„è¿è¡Œåˆ›å»º"""

    logger.info(f"Creating run with strategy: {strategy}")
    logger.info(f"Thread: {thread_id}")
    logger.info(f"Input: {input}")

    try:
        run = await client.runs.create(
            thread_id,
            assistant_id,
            input=input,
            config=config,
            multitask_strategy=strategy
        )

        logger.info(f"Run created: {run['run_id']}")
        logger.info(f"Status: {run['status']}")

        return run

    except httpx.HTTPStatusError as e:
        if e.response.status_code == 409:
            logger.warning(f"Conflict (409): Run rejected by {strategy} strategy")
        else:
            logger.error(f"HTTP error: {e}")
        raise

    except Exception as e:
        logger.error(f"Unexpected error: {e}")
        raise
```

---

## ä¹ã€æœ€ä½³å®è·µ

### 9.1 é€‰æ‹©ç­–ç•¥çš„åŸåˆ™

**1. é»˜è®¤ä½¿ç”¨ Enqueue**
```python
# å¯¹äºå¤§å¤šæ•°åœºæ™¯ï¼Œenqueue æ˜¯æœ€å®‰å…¨çš„é€‰æ‹©
strategy = "enqueue"
```

**2. æ˜ç¡®ç”¨æˆ·æ„å›¾æ—¶ä½¿ç”¨ Rollback**
```python
# ç”¨æˆ·æ˜ç¡®è¯´"ä¸å¯¹"ã€"ç®—äº†"ã€"æ”¹æˆ"
if "ä¸å¯¹" in user_input or "ç®—äº†" in user_input:
    strategy = "rollback"
```

**3. èµ„æºå—é™æ—¶ä½¿ç”¨ Reject**
```python
# API è°ƒç”¨æ¬¡æ•°æœ‰é™ã€è´¹ç”¨æ˜‚è´µ
if expensive_operation:
    strategy = "reject"
```

**4. ç”¨æˆ·ä½“éªŒä¼˜å…ˆæ—¶ä½¿ç”¨ Interrupt**
```python
# å“åº”é€Ÿåº¦é‡è¦ï¼Œæ—§è¯·æ±‚å¯ä»¥ä¸­æ–­
if user_priority == "speed":
    strategy = "interrupt"
```

### 9.2 é”™è¯¯å¤„ç†æ¨¡æ¿

```python
async def robust_create_run(
    client, thread_id, assistant_id, input, config, strategy="enqueue", max_retries=3
):
    """å¥å£®çš„è¿è¡Œåˆ›å»º"""

    for attempt in range(max_retries):
        try:
            return await client.runs.create(
                thread_id,
                assistant_id,
                input=input,
                config=config,
                multitask_strategy=strategy
            )

        except httpx.HTTPStatusError as e:
            if e.response.status_code == 409:
                # Conflict - æ ¹æ®ç­–ç•¥å¤„ç†
                if strategy == "reject":
                    if attempt < max_retries - 1:
                        logger.info(f"Retry attempt {attempt + 1}/{max_retries}")
                        await asyncio.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿
                        continue
                    else:
                        logger.error("Max retries reached")
                        raise
                else:
                    # å…¶ä»–ç­–ç•¥ä¸åº”è¯¥è¿”å› 409
                    logger.error(f"Unexpected 409 with strategy {strategy}")
                    raise
            else:
                logger.error(f"HTTP {e.response.status_code}: {e}")
                raise

        except Exception as e:
            logger.error(f"Unexpected error: {e}")
            raise
```

### 9.3 æµ‹è¯•ä¸åŒç­–ç•¥

```python
async def test_all_strategies(client, assistant_id, config):
    """æµ‹è¯•æ‰€æœ‰ç­–ç•¥"""

    strategies = ["reject", "enqueue", "interrupt", "rollback"]

    for strategy in strategies:
        print(f"\n=== Testing {strategy} ===")

        # åˆ›å»ºçº¿ç¨‹
        thread = await client.threads.create()

        # ç¬¬ä¸€ä¸ªè¯·æ±‚
        run1 = await client.runs.create(
            thread["thread_id"],
            assistant_id,
            input={"messages": [HumanMessage(content="First request")]},
            config=config
        )

        # ç­‰å¾…ä¸€ç‚¹æ—¶é—´
        await asyncio.sleep(0.5)

        # ç¬¬äºŒä¸ªè¯·æ±‚
        try:
            run2 = await client.runs.create(
                thread["thread_id"],
                assistant_id,
                input={"messages": [HumanMessage(content="Second request")]},
                config=config,
                multitask_strategy=strategy
            )
            print(f"Run 2 created: {run2['run_id']}")
        except httpx.HTTPStatusError as e:
            print(f"Run 2 rejected: {e.response.status_code}")

        # ç­‰å¾…å®Œæˆ
        await asyncio.sleep(2)

        # æ£€æŸ¥ç»“æœ
        state = await client.threads.get_state(thread["thread_id"])
        messages = state["values"]["messages"]
        print(f"Total messages: {len(messages)}")

        # æ£€æŸ¥ç¬¬ä¸€ä¸ªè¿è¡ŒçŠ¶æ€
        run1_status = (await client.runs.get(thread["thread_id"], run1["run_id"]))["status"]
        print(f"Run 1 status: {run1_status}")
```

---

## åã€å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 10.1 é—®é¢˜ï¼šEnqueue é˜Ÿåˆ—è¿‡é•¿

**ç°è±¡**ï¼šç”¨æˆ·å‘é€å¾ˆå¤šæ¶ˆæ¯ï¼Œé˜Ÿåˆ—ç§¯å‹

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æ£€æŸ¥é˜Ÿåˆ—é•¿åº¦
async def get_queue_length(client, thread_id):
    runs = await client.runs.list(thread_id)
    pending_runs = [r for r in runs if r["status"] in ["pending"]]
    return len(pending_runs)

# åŠ¨æ€è°ƒæ•´ç­–ç•¥
async def smart_create_run(client, thread_id, assistant_id, input, config):
    queue_length = await get_queue_length(client, thread_id)

    if queue_length > 5:
        # é˜Ÿåˆ—è¿‡é•¿ï¼Œæ”¹ç”¨ rollback
        strategy = "rollback"
    else:
        strategy = "enqueue"

    return await client.runs.create(
        thread_id, assistant_id, input=input, config=config,
        multitask_strategy=strategy
    )
```

### 10.2 é—®é¢˜ï¼šInterrupt å¯¼è‡´å‰¯ä½œç”¨ä¸¢å¤±

**ç°è±¡**ï¼šè¿è¡Œè¢«ä¸­æ–­ï¼Œä½†å·²ç»å‘é€äº†é‚®ä»¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ Enqueue æ›¿ä»£ Interrupt
# å¯¹äºæœ‰å‰¯ä½œç”¨çš„æ“ä½œï¼Œä¸è¦ä½¿ç”¨ interrupt

# æ–¹æ¡ˆ 2ï¼šå¹‚ç­‰æ€§è®¾è®¡
# ç¡®ä¿æ“ä½œå¯ä»¥å®‰å…¨é‡è¯•
```

### 10.3 é—®é¢˜ï¼šRollback ä¸¢å¤±é‡è¦ä¸Šä¸‹æ–‡

**ç°è±¡**ï¼šç”¨æˆ·çš„ç¬¬ä¸€æ¡æ¶ˆæ¯åŒ…å«é‡è¦ä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æ–¹æ¡ˆ 1ï¼šåœ¨ UI å±‚é¢ç¡®è®¤
# "ç¡®å®šè¦å–æ¶ˆä¹‹å‰çš„è¯·æ±‚å—ï¼Ÿ"

# æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Interrupt æ›¿ä»£ Rollback
# ä¿ç•™ç¬¬ä¸€ä¸ªè¯·æ±‚çš„è¾“å…¥

# æ–¹æ¡ˆ 3ï¼šåˆå¹¶ä¸¤ä¸ªè¯·æ±‚
async def merge_requests(client, thread_id, assistant_id, request1, request2, config):
    """åˆå¹¶ä¸¤ä¸ªè¯·æ±‚"""
    merged_input = {
        "messages": [
            HumanMessage(content=f"Context: {request1}\n\nCurrent request: {request2}")
        ]
    }
    return await client.runs.create(
        thread_id,
        assistant_id,
        input=merged_input,
        config=config,
        multitask_strategy="rollback"
    )
```

---

## åä¸€ã€æ€»ç»“

### 11.1 æ ¸å¿ƒè¦ç‚¹

1. **Double Texting æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¸¸è§é—®é¢˜**
   - ç”¨æˆ·ä¸ä¼šç­‰å¾…
   - å¿…é¡»ä¼˜é›…å¤„ç†å¹¶å‘è¯·æ±‚

2. **å››ç§ç­–ç•¥å„æœ‰é€‚ç”¨åœºæ™¯**
   - Rejectï¼šä¸¥æ ¼é¡ºåºæ§åˆ¶
   - Enqueueï¼šæ‰€æœ‰è¯·æ±‚éƒ½é‡è¦
   - Interruptï¼šå¿«é€Ÿå“åº”ä¼˜å…ˆ
   - Rollbackï¼šæœ€æ–°è¯·æ±‚ä¼˜å…ˆ

3. **é€‰æ‹©ç­–ç•¥çš„å…³é”®å› ç´ **
   - ç”¨æˆ·æ„å›¾
   - è¯·æ±‚é‡è¦æ€§
   - å“åº”é€Ÿåº¦è¦æ±‚
   - å‰¯ä½œç”¨è€ƒè™‘

4. **æ²¡æœ‰ä¸‡èƒ½ç­–ç•¥**
   - æ ¹æ®åœºæ™¯é€‰æ‹©
   - å¯ä»¥åŠ¨æ€è°ƒæ•´
   - éœ€è¦æƒè¡¡åˆ©å¼Š

### 11.2 å¿«é€Ÿå‚è€ƒ

```python
# Reject - æ‹’ç»æ–°è¯·æ±‚
await client.runs.create(..., multitask_strategy="reject")
# è¿”å› 409 Conflict

# Enqueue - æ’é˜Ÿå¤„ç†
await client.runs.create(..., multitask_strategy="enqueue")
# ä¸¤ä¸ªè¯·æ±‚éƒ½å®Œæˆ

# Interrupt - ä¸­æ–­å½“å‰
await client.runs.create(..., multitask_strategy="interrupt")
# ä¿å­˜ç¬¬ä¸€ä¸ªè¾“å…¥ï¼Œæ‰§è¡Œç¬¬äºŒä¸ª

# Rollback - å›æ»šåˆ é™¤
await client.runs.create(..., multitask_strategy="rollback")
# åˆ é™¤ç¬¬ä¸€ä¸ªï¼Œåªæ‰§è¡Œç¬¬äºŒä¸ª
```

### 11.3 å†³ç­–é€ŸæŸ¥è¡¨

| ä½ çš„éœ€æ±‚ | æ¨èç­–ç•¥ |
|---------|---------|
| æ‰€æœ‰è¯·æ±‚éƒ½å¿…é¡»å¤„ç† | Enqueue |
| æ–°è¯·æ±‚ä¼˜å…ˆçº§æ›´é«˜ | Interrupt æˆ– Rollback |
| ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸èƒ½ä¸­æ–­ | Reject æˆ– Enqueue |
| éœ€è¦å¿«é€Ÿå“åº” | Interrupt æˆ– Rollback |
| æœ‰å‰¯ä½œç”¨æ“ä½œ | Reject æˆ– Enqueue |
| ç”¨æˆ·æ˜ç¡®å–æ¶ˆç¬¬ä¸€ä¸ª | Rollback |
| ä¿ç•™æ‰€æœ‰å†å² | Enqueue æˆ– Interrupt |
| å†å²æœ€å¹²å‡€ | Rollback |

### 11.4 ä¸‹èŠ‚é¢„å‘Š

åœ¨ **6.4-assistant** ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š
- ä»€ä¹ˆæ˜¯ Assistantsï¼ˆåŠ©æ‰‹ï¼‰
- å¦‚ä½•åˆ›å»ºå’Œç®¡ç† assistants
- é…ç½®ä¸åŒçš„ assistants
- Assistants çš„ç‰ˆæœ¬æ§åˆ¶
- å®é™…åº”ç”¨åœºæ™¯

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
**æœ€åæ›´æ–°**ï¼š2024-11-05
**ä½œè€…**ï¼šAI Assistant
**åŸºäº**ï¼šLangChain Academy Module-6 Lesson 6.3

æ­å–œä½ æŒæ¡äº† Double Texting çš„æ‰€æœ‰å¤„ç†ç­–ç•¥ï¼ç°åœ¨ä½ å¯ä»¥æ„å»ºèƒ½ä¼˜é›…å¤„ç†å¹¶å‘è¯·æ±‚çš„ç”Ÿäº§çº§åº”ç”¨äº†ã€‚ğŸ‰
