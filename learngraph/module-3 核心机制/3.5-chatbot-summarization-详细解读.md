# LangGraph Chatbot with Message Summarization è¯¦ç»†è§£è¯»

>  ç½‘ç«™ä½¿ç”¨è¯´æ˜
> - æœ¬ç½‘ç«™å¯ä»¥å…ç™»é™†è¿è¡Œ Python ä»£ç 
> - Python ä»£ç å¯ä»¥ç¼–è¾‘å¹¶ä¸´æ—¶ä¿å­˜ï¼Œä½†ä¸ä¼šæ°¸ä¹…ä¿å­˜ï¼Œç½‘é¡µåˆ·æ–°åä¼šè‡ªåŠ¨è¿˜åŸ
> - å¯¹ç½‘ç«™çš„ä½¿ç”¨æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥åˆ° [é—®é¢˜åé¦ˆ](http://localhost:5173/feedback.html) ï¼ˆæŒ‰é’®åœ¨æ¯ä¸ªé¡µé¢çš„å³ä¸‹è§’ï¼‰å…ç™»å½•è¿›è¡Œè¯„è®º
> - è¿è¡Œ `LangGraph/LangChain`ä»£ç ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥è‡ªå·±çš„ [API Key](http://localhost:5173/python-run.html)
> - é‡è¦å£°æ˜ï¼šæœ¬ç½‘ç«™ä¸ä¼šä¿å­˜ç”¨æˆ·çš„ API Key æ•°æ®ï¼Œè¯·æ”¾å¿ƒè¾“å…¥

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£è¯» LangGraph ä¸­çš„ **å¯¹è¯æ‘˜è¦ï¼ˆMessage Summarizationï¼‰** æŠ€æœ¯ã€‚è¿™æ˜¯ä¸€ç§æ™ºèƒ½çš„å†…å­˜ç®¡ç†æ–¹æ¡ˆï¼Œé€šè¿‡ LLM ç”Ÿæˆå¯¹è¯æ‘˜è¦æ¥å‹ç¼©å†å²æ¶ˆæ¯ï¼Œä»è€Œå®ç°é•¿æœŸå¯¹è¯è€Œä¸ä¼šäº§ç”Ÿé«˜æ˜‚çš„ token æˆæœ¬å’Œå»¶è¿Ÿé—®é¢˜ã€‚

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **å¯¹è¯æ‘˜è¦ (Summarization)** | ä½¿ç”¨ LLM å°†é•¿å¯¹è¯å†å²å‹ç¼©ä¸ºç®€çŸ­æ‘˜è¦æ–‡æœ¬çš„æŠ€æœ¯ | å®šæœŸè°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦ï¼Œä¿ç•™å…³é”®ä¿¡æ¯ï¼Œåˆ é™¤æ—§æ¶ˆæ¯ | â­â­â­â­â­ |
| **MessagesState** | LangGraph å†…ç½®çŠ¶æ€åŸºç±»ï¼ŒåŒ…å« messages å­—æ®µå’Œ add_messages reducer | TypedDict ç±»ï¼Œå¯ç»§æ‰¿å¹¶æ·»åŠ  summary ç­‰è‡ªå®šä¹‰å­—æ®µ | â­â­â­â­â­ |
| **RemoveMessage** | ç”¨äºä»çŠ¶æ€ä¸­æ°¸ä¹…åˆ é™¤æŒ‡å®šæ¶ˆæ¯çš„ç‰¹æ®Šæ¶ˆæ¯ç±»å‹ | æ ¼å¼ `RemoveMessage(id=message.id)`ï¼Œé…åˆ add_messages åˆ é™¤æ—§æ¶ˆæ¯ | â­â­â­â­â­ |
| **Checkpointer** | LangGraph è´Ÿè´£ä¿å­˜å’ŒåŠ è½½å›¾çŠ¶æ€çš„ç»„ä»¶ï¼Œå®ç°æŒä¹…åŒ– | æ¥å£ç±»ï¼ŒMemorySaver æ˜¯å†…å­˜å®ç°ï¼ŒSqliteSaver æ˜¯æ•°æ®åº“å®ç° | â­â­â­â­â­ |
| **MemorySaver** | å°†çŠ¶æ€ä¿å­˜åœ¨è¿›ç¨‹å†…å­˜ä¸­çš„ Checkpointer å®ç°ï¼Œé‡å¯åä¸¢å¤± | `from langgraph.checkpoint.memory import MemorySaver` | â­â­â­â­ |
| **Thread** | LangGraph ä¸­ç”¨äºéš”ç¦»ä¸åŒå¯¹è¯ä¼šè¯çš„æ¦‚å¿µï¼Œç±»ä¼¼ Slack é¢‘é“ | é€šè¿‡ `config = {"configurable": {"thread_id": "1"}}` æŒ‡å®š | â­â­â­â­â­ |
| **StateSnapshot** | å›¾åœ¨æŸä¸ªæ—¶é—´ç‚¹çš„å®Œæ•´çŠ¶æ€å¿«ç…§ï¼ŒåŒ…å« valuesã€configã€metadata | `graph.get_state(config)` è¿”å›çš„å¯¹è±¡ï¼Œå¯è®¿é—®çŠ¶æ€å’Œå…ƒæ•°æ® | â­â­â­â­ |
| **å¢é‡æ‘˜è¦** | åŸºäºå·²æœ‰æ‘˜è¦æ‰©å±•æ–°å†…å®¹ï¼Œè€Œä¸æ˜¯é‡æ–°æ‘˜è¦å…¨éƒ¨å¯¹è¯ | æç¤ºè¯åŒ…å«æ—§æ‘˜è¦ï¼š"Extend the summary by taking into account..." | â­â­â­â­ |
| **æ¡ä»¶è¾¹** | æ ¹æ®çŠ¶æ€å†³å®šä¸‹ä¸€æ­¥æ‰§è¡Œå“ªä¸ªèŠ‚ç‚¹çš„è¾¹ï¼Œç”¨äºæ§åˆ¶æ‘˜è¦è§¦å‘ | `add_conditional_edges("node", should_continue)` è¿”å›èŠ‚ç‚¹åæˆ– END | â­â­â­â­â­ |
| **æ¶ˆæ¯è£å‰ª** | åˆ é™¤æ—§æ¶ˆæ¯ä½†ä¿ç•™æœ€è¿‘ N æ¡ï¼Œé€šè¿‡åˆ—è¡¨åˆ‡ç‰‡å®ç° | `messages[:-2]` åˆ é™¤é™¤æœ€å2æ¡å¤–çš„æ‰€æœ‰æ¶ˆæ¯ | â­â­â­â­â­ |

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä¸ºä»€ä¹ˆéœ€è¦å¯¹è¯æ‘˜è¦ï¼Ÿ

åœ¨æ„å»ºèŠå¤©æœºå™¨äººæ—¶ï¼Œæˆ‘ä»¬é¢ä¸´ä¸€ä¸ªæ ¹æœ¬æ€§çš„çŸ›ç›¾ï¼š

1. **é•¿æœŸè®°å¿†éœ€æ±‚**ï¼šç”¨æˆ·æœŸæœ›æœºå™¨äººè®°ä½æ•´ä¸ªå¯¹è¯å†å²
2. **token é™åˆ¶**ï¼šLLM æœ‰ä¸Šä¸‹æ–‡çª—å£é™åˆ¶
3. **æˆæœ¬ä¸å»¶è¿Ÿ**ï¼šå‘é€å¤§é‡å†å²æ¶ˆæ¯ä¼šå¢åŠ æˆæœ¬å’Œå“åº”æ—¶é—´

### ä¸‰ç§æ¶ˆæ¯ç®¡ç†ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **å®Œæ•´ä¿ç•™** | ä¿¡æ¯å®Œæ•´ | token æˆæœ¬é«˜ã€å¯èƒ½è¶…é™ | çŸ­å¯¹è¯ |
| **è£å‰ª/è¿‡æ»¤** | ç®€å•é«˜æ•ˆ | ä¸¢å¤±å†å²ä¿¡æ¯ | ç®€å•å¯¹è¯ |
| **æ™ºèƒ½æ‘˜è¦** | ä¿ç•™å…³é”®ä¿¡æ¯ã€æ§åˆ¶æˆæœ¬ | å®ç°å¤æ‚åº¦é«˜ | é•¿æœŸå¯¹è¯ |

**æœ¬æ•™ç¨‹çš„è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨ LLM ç”Ÿæˆå¯¹è¯æ‘˜è¦ï¼Œä¿ç•™å‹ç¼©çš„å†å²ä¿¡æ¯ï¼Œæ”¯æŒé•¿æœŸå¯¹è¯ã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒæœºåˆ¶

```
ç”¨æˆ·æ¶ˆæ¯æµ
    â†“
æ£€æŸ¥æ¶ˆæ¯æ•°é‡
    â†“
â”œâ”€ â‰¤6 æ¡æ¶ˆæ¯ â†’ ç›´æ¥ä½¿ç”¨å†å²
â”‚      â†“
â”‚  [call_model] ç”Ÿæˆå›å¤
â”‚      â†“
â”‚    END
â”‚
â””â”€ >6 æ¡æ¶ˆæ¯ â†’ è§¦å‘æ‘˜è¦
       â†“
   [summarize_conversation] ç”Ÿæˆ/æ›´æ–°æ‘˜è¦
       â†“
   ä¿ç•™æœ€æ–° 2 æ¡æ¶ˆæ¯ + æ‘˜è¦
       â†“
     END
```

### å·¥ä½œæµç¨‹å›¾

```mermaid
graph TD
    START --> conversation[call_model]
    conversation --> check{æ¶ˆæ¯æ•° > 6?}
    check -->|No| END1[END]
    check -->|Yes| summarize[summarize_conversation]
    summarize --> END2[END]
```

---

## ğŸ”§ ä»£ç å®ç°è¯¦è§£

### 1. ç¯å¢ƒè®¾ç½®

```python
%%capture --no-stderr
%pip install --quiet -U langchain_core langgraph langchain_openai
```

**è¯´æ˜ï¼š**
- `%%capture --no-stderr`ï¼šJupyter é­”æ³•å‘½ä»¤ï¼Œéšè—å®‰è£…è¾“å‡ºï¼ˆä½†ä¿ç•™é”™è¯¯ï¼‰
- å®‰è£…æ ¸å¿ƒä¾èµ–ï¼šLangChainã€LangGraphã€OpenAI é›†æˆ

```python
import os, getpass

def _set_env(var: str):
    if not os.environ.get(var):
        os.environ[var] = getpass.getpass(f"{var}: ")

_set_env("OPENAI_API_KEY")
```

**Python çŸ¥è¯†ç‚¹ï¼šç¯å¢ƒå˜é‡ç®¡ç†**

- `os.environ.get(var)`ï¼šè·å–ç¯å¢ƒå˜é‡ï¼Œä¸å­˜åœ¨è¿”å› `None`
- `getpass.getpass()`ï¼šå®‰å…¨åœ°è¾“å…¥å¯†ç ï¼ˆä¸æ˜¾ç¤ºæ˜æ–‡ï¼‰
- è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µï¼šæ•æ„Ÿä¿¡æ¯ä¸ç¡¬ç¼–ç 

---

### 2. LangSmith è¿½è¸ªè®¾ç½®

```python
_set_env("LANGSMITH_API_KEY")
os.environ["LANGSMITH_TRACING"] = "true"
os.environ["LANGSMITH_PROJECT"] = "langchain-academy"
```

**LangSmith ä½œç”¨ï¼š**
- è¿½è¸ªæ¯æ¬¡ LLM è°ƒç”¨
- å¯è§†åŒ–æ‰§è¡Œæµç¨‹
- è°ƒè¯•å’Œæ€§èƒ½åˆ†æ

---

### 3. åˆå§‹åŒ–æ¨¡å‹

```python
from langchain_openai import ChatOpenAI
model = ChatOpenAI(model="gpt-5-nano", temperature=0)
```

**å‚æ•°è¯´æ˜ï¼š**
- `model="gpt-5-nano"`ï¼šä½¿ç”¨ GPT-4 Optimized æ¨¡å‹
- `temperature=0`ï¼šç¡®å®šæ€§è¾“å‡ºï¼ˆé€‚åˆéœ€è¦ä¸€è‡´æ€§çš„ä»»åŠ¡ï¼‰

---

### 4. å®šä¹‰çŠ¶æ€ï¼ˆStateï¼‰â­

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼

```python
from langgraph.graph import MessagesState

class State(MessagesState):
    summary: str
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šMessagesState**

`MessagesState` æ˜¯ LangGraph æä¾›çš„å†…ç½®çŠ¶æ€åŸºç±»ï¼š

```python
class MessagesState(TypedDict):
    messages: Annotated[list[AnyMessage], add_messages]
```

**å…³é”®ç‰¹æ€§ï¼š**

1. **è‡ªåŠ¨æ¶ˆæ¯ç®¡ç†**ï¼š`messages` å­—æ®µå·²é…ç½® `add_messages` reducer
2. **æ™ºèƒ½åˆå¹¶**ï¼šæ–°æ¶ˆæ¯è‡ªåŠ¨è¿½åŠ åˆ°å†å²
3. **ID ç®¡ç†**ï¼šæ¯æ¡æ¶ˆæ¯æœ‰å”¯ä¸€ IDï¼Œæ”¯æŒåˆ é™¤/æ›´æ–°

**æˆ‘ä»¬çš„æ‰©å±•ï¼š**

```python
class State(MessagesState):
    summary: str  # æ–°å¢æ‘˜è¦å­—æ®µ
```

ç°åœ¨çŠ¶æ€åŒ…å«ï¼š
- `messages`ï¼šæ¶ˆæ¯åˆ—è¡¨ï¼ˆç»§æ‰¿è‡ª MessagesStateï¼‰
- `summary`ï¼šå¯¹è¯æ‘˜è¦ï¼ˆæ–°å¢ï¼‰

**Python çŸ¥è¯†ç‚¹ï¼šç±»ç»§æ‰¿**

```python
class State(MessagesState):
    # ç»§æ‰¿ MessagesState çš„æ‰€æœ‰å­—æ®µå’Œæ–¹æ³•
    summary: str  # æ·»åŠ æ–°å­—æ®µ
```

è¿™æ˜¯ Python çš„å•ç»§æ‰¿æ¨¡å¼ï¼Œ`State` æ‹¥æœ‰ï¼š
- çˆ¶ç±»çš„ `messages` å­—æ®µ
- è‡ªå·±çš„ `summary` å­—æ®µ

---

### 5. å¯¹è¯èŠ‚ç‚¹ï¼šcall_model â­

```python
from langchain_core.messages import SystemMessage, HumanMessage, RemoveMessage

def call_model(state: State):
    # è·å–æ‘˜è¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    summary = state.get("summary", "")

    # å¦‚æœæœ‰æ‘˜è¦ï¼Œæ·»åŠ åˆ°ç³»ç»Ÿæ¶ˆæ¯
    if summary:
        # åˆ›å»ºåŒ…å«æ‘˜è¦çš„ç³»ç»Ÿæ¶ˆæ¯
        system_message = f"Summary of conversation earlier: {summary}"

        # å°†æ‘˜è¦è¿½åŠ åˆ°æ¶ˆæ¯å†å²å‰é¢
        messages = [SystemMessage(content=system_message)] + state["messages"]
    else:
        # æ²¡æœ‰æ‘˜è¦ï¼Œç›´æ¥ä½¿ç”¨æ¶ˆæ¯å†å²
        messages = state["messages"]

    # è°ƒç”¨ LLM
    response = model.invoke(messages)
    return {"messages": response}
```

**ä»£ç è§£æï¼š**

#### æ­¥éª¤ 1ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ‘˜è¦

```python
summary = state.get("summary", "")
```

- `state.get("summary", "")`ï¼šå®‰å…¨è·å–æ‘˜è¦ï¼Œä¸å­˜åœ¨è¿”å›ç©ºå­—ç¬¦ä¸²
- é¿å… `KeyError` å¼‚å¸¸

#### æ­¥éª¤ 2ï¼šæ„å»ºæ¶ˆæ¯åˆ—è¡¨

**æƒ…å†µ Aï¼šæœ‰æ‘˜è¦**
```python
messages = [SystemMessage(content=system_message)] + state["messages"]
```

æ¶ˆæ¯ç»“æ„ï¼š
```
[
    SystemMessage("Summary of conversation earlier: ç”¨æˆ·å« Lanceï¼Œå–œæ¬¢ 49ers..."),
    HumanMessage("æœ€æ–°ç”¨æˆ·æ¶ˆæ¯"),
    ...
]
```

**æƒ…å†µ Bï¼šæ— æ‘˜è¦**
```python
messages = state["messages"]
```

ç›´æ¥ä½¿ç”¨åŸå§‹å†å²ã€‚

#### æ­¥éª¤ 3ï¼šè°ƒç”¨æ¨¡å‹å¹¶è¿”å›

```python
response = model.invoke(messages)
return {"messages": response}
```

- `model.invoke(messages)`ï¼šå‘é€æ¶ˆæ¯åˆ° LLM
- `return {"messages": response}`ï¼šè¿”å›çš„å­—å…¸ä¼šæ›´æ–° `State.messages`

**LangGraph çŸ¥è¯†ç‚¹ï¼šçŠ¶æ€æ›´æ–°æœºåˆ¶**

èŠ‚ç‚¹è¿”å›çš„å­—å…¸ä¼šè‡ªåŠ¨åˆå¹¶åˆ°çŠ¶æ€ï¼š

```python
# å½“å‰ State.messages = [msg1, msg2]
return {"messages": response}
# æ›´æ–°å State.messages = [msg1, msg2, response]
```

è¿™æ˜¯å› ä¸º `add_messages` reducer ä¼šå°†æ–°æ¶ˆæ¯è¿½åŠ åˆ°åˆ—è¡¨ã€‚

---

### 6. æ‘˜è¦èŠ‚ç‚¹ï¼šsummarize_conversation â­â­â­

è¿™æ˜¯æœ¬æ•™ç¨‹çš„æ ¸å¿ƒï¼

```python
def summarize_conversation(state: State):
    # ç¬¬ä¸€æ­¥ï¼šè·å–ç°æœ‰æ‘˜è¦
    summary = state.get("summary", "")

    # ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ‘˜è¦æç¤º
    if summary:
        # å·²æœ‰æ‘˜è¦ â†’ å¢é‡æ›´æ–°
        summary_message = (
            f"This is summary of the conversation to date: {summary}\n\n"
            "Extend the summary by taking into account the new messages above:"
        )
    else:
        # æ— æ‘˜è¦ â†’ é¦–æ¬¡åˆ›å»º
        summary_message = "Create a summary of the conversation above:"

    # ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆæ‘˜è¦
    messages = state["messages"] + [HumanMessage(content=summary_message)]
    response = model.invoke(messages)

    # ç¬¬å››æ­¥ï¼šåˆ é™¤æ—§æ¶ˆæ¯ï¼Œåªä¿ç•™æœ€æ–° 2 æ¡
    delete_messages = [RemoveMessage(id=m.id) for m in state["messages"][:-2]]

    return {"summary": response.content, "messages": delete_messages}
```

#### è¯¦ç»†è§£æ

**æ­¥éª¤ 1ï¼šæ£€æŸ¥ç°æœ‰æ‘˜è¦**

```python
summary = state.get("summary", "")
```

åˆ¤æ–­æ˜¯é¦–æ¬¡æ‘˜è¦è¿˜æ˜¯æ›´æ–°æ‘˜è¦ã€‚

**æ­¥éª¤ 2ï¼šæ„å»ºæ‘˜è¦æç¤º**

ä¸¤ç§æç¤ºç­–ç•¥ï¼š

1. **é¦–æ¬¡æ‘˜è¦**ï¼ˆæ— ç°æœ‰æ‘˜è¦ï¼‰ï¼š
   ```
   "Create a summary of the conversation above:"
   ```

2. **å¢é‡æ‘˜è¦**ï¼ˆæœ‰ç°æœ‰æ‘˜è¦ï¼‰ï¼š
   ```
   "This is summary of the conversation to date: {æ—§æ‘˜è¦}

   Extend the summary by taking into account the new messages above:"
   ```

**ä¸ºä»€ä¹ˆä½¿ç”¨å¢é‡æ‘˜è¦ï¼Ÿ**
- ä¿ç•™å†å²ä¿¡æ¯çš„è¿ç»­æ€§
- é¿å…é‡å¤æ‘˜è¦æ•´ä¸ªå¯¹è¯
- åªéœ€å¤„ç†æ–°å¢æ¶ˆæ¯

**æ­¥éª¤ 3ï¼šè°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦**

```python
messages = state["messages"] + [HumanMessage(content=summary_message)]
response = model.invoke(messages)
```

æ¶ˆæ¯ç»“æ„ï¼š
```
[
    ...å†å²æ¶ˆæ¯...,
    HumanMessage("Create a summary of the conversation above:")
]
```

LLM ä¼šåŸºäºæ‰€æœ‰å†å²ç”Ÿæˆæ‘˜è¦ã€‚

**æ­¥éª¤ 4ï¼šåˆ é™¤æ—§æ¶ˆæ¯** â­

```python
delete_messages = [RemoveMessage(id=m.id) for m in state["messages"][:-2]]
```

**å…³é”®çŸ¥è¯†ç‚¹ï¼šRemoveMessage**

`RemoveMessage` æ˜¯ LangGraph æä¾›çš„ç‰¹æ®Šæ¶ˆæ¯ç±»å‹ï¼Œç”¨äºä»çŠ¶æ€ä¸­åˆ é™¤æ¶ˆæ¯ï¼š

```python
RemoveMessage(id=message_id)
```

**ä»£ç è§£æï¼š**

```python
state["messages"][:-2]  # é™¤äº†æœ€å 2 æ¡æ¶ˆæ¯å¤–çš„æ‰€æœ‰æ¶ˆæ¯
[RemoveMessage(id=m.id) for m in ...]  # ä¸ºæ¯æ¡æ¶ˆæ¯åˆ›å»ºåˆ é™¤æ ‡è®°
```

**æ‰§è¡Œæ•ˆæœï¼š**

å‡è®¾æœ‰ 8 æ¡æ¶ˆæ¯ï¼š
```
[msg1, msg2, msg3, msg4, msg5, msg6, msg7, msg8]
                                     ^^^^^ ^^^^^ ä¿ç•™æœ€æ–° 2 æ¡
^^^^^^ ^^^^^^ ^^^^^^ ^^^^^^ ^^^^^^            åˆ é™¤è¿™ 6 æ¡
```

åˆ é™¤åï¼š
```
[msg7, msg8]  # åªä¿ç•™æœ€æ–° 2 æ¡
```

**ä¸ºä»€ä¹ˆä¿ç•™ 2 æ¡ï¼Ÿ**
- æœ€æ–°çš„ç”¨æˆ·æ¶ˆæ¯
- æœ€æ–°çš„ AI å›å¤
- ç¡®ä¿å¯¹è¯è¿ç»­æ€§

**æ­¥éª¤ 5ï¼šè¿”å›æ›´æ–°**

```python
return {
    "summary": response.content,    # æ›´æ–°æ‘˜è¦
    "messages": delete_messages     # åˆ é™¤æ—§æ¶ˆæ¯
}
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šåŒæ—¶æ›´æ–°å¤šä¸ªå­—æ®µ**

ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥è¿”å›å¤šä¸ªå­—æ®µçš„æ›´æ–°ï¼š
- `summary`ï¼šå­˜å‚¨æ–°çš„æ‘˜è¦æ–‡æœ¬
- `messages`ï¼šåº”ç”¨åˆ é™¤æ“ä½œï¼ˆ`add_messages` reducer ä¼šå¤„ç† `RemoveMessage`ï¼‰

---

### 7. æ¡ä»¶è¾¹ï¼šshould_continue

```python
from langgraph.graph import END
from typing_extensions import Literal

def should_continue(state: State) -> Literal["summarize_conversation", END]:
    """è¿”å›ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹"""

    messages = state["messages"]

    # å¦‚æœæ¶ˆæ¯è¶…è¿‡ 6 æ¡ï¼Œè¿›è¡Œæ‘˜è¦
    if len(messages) > 6:
        return "summarize_conversation"

    # å¦åˆ™ç»“æŸ
    return END
```

**Python çŸ¥è¯†ç‚¹ï¼šLiteral ç±»å‹**

```python
from typing_extensions import Literal

def should_continue(state: State) -> Literal["summarize_conversation", END]:
    ...
```

`Literal` è¡¨ç¤ºè¿”å›å€¼åªèƒ½æ˜¯æŒ‡å®šçš„å­—é¢é‡ï¼š
- `"summarize_conversation"`ï¼šå­—ç¬¦ä¸²å­—é¢é‡
- `END`ï¼šLangGraph çš„ç‰¹æ®Šå¸¸é‡

**ä½œç”¨ï¼š**
- ç±»å‹å®‰å…¨ï¼šIDE ä¼šæ£€æŸ¥è¿”å›å€¼
- è‡ªåŠ¨è¡¥å…¨ï¼šIDE ä¼šæç¤ºå¯èƒ½çš„è¿”å›å€¼

**LangGraph çŸ¥è¯†ç‚¹ï¼šæ¡ä»¶è¾¹è¿”å›å€¼**

æ¡ä»¶è¾¹å‡½æ•°çš„è¿”å›å€¼å†³å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼š
- è¿”å›èŠ‚ç‚¹åç§° â†’ è·³è½¬åˆ°è¯¥èŠ‚ç‚¹
- è¿”å› `END` â†’ ç»“æŸå›¾æ‰§è¡Œ

---

### 8. æ·»åŠ å†…å­˜ï¼ˆMemoryï¼‰â­â­â­

**æ ¸å¿ƒé—®é¢˜ï¼š** é»˜è®¤æƒ…å†µä¸‹ï¼ŒLangGraph çš„çŠ¶æ€æ˜¯**ä¸´æ—¶çš„**ï¼Œæ¯æ¬¡æ‰§è¡Œéƒ½æ˜¯å…¨æ–°çš„ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨ **Checkpointer**ï¼ˆæ£€æŸ¥ç‚¹æœºåˆ¶ï¼‰æŒä¹…åŒ–çŠ¶æ€ã€‚

```python
from langgraph.checkpoint.memory import MemorySaver

memory = MemorySaver()
```

**MemorySaver ä½œç”¨ï¼š**
- å†…å­˜ä¸­çš„é”®å€¼å­˜å‚¨
- è‡ªåŠ¨ä¿å­˜æ¯ä¸€æ­¥çš„çŠ¶æ€
- æ”¯æŒå¤šçº¿ç¨‹ï¼ˆthreadï¼‰å¯¹è¯

**LangGraph çŸ¥è¯†ç‚¹ï¼šçŠ¶æ€æŒä¹…åŒ–**

```python
graph = workflow.compile(checkpointer=memory)
```

**æ‰§è¡Œæµç¨‹ï¼š**

1. **æ‰§è¡Œå‰**ï¼šä» checkpointer åŠ è½½ä¸Šæ¬¡çš„çŠ¶æ€
2. **æ¯ä¸ªèŠ‚ç‚¹å**ï¼šè‡ªåŠ¨ä¿å­˜å½“å‰çŠ¶æ€åˆ° checkpointer
3. **æ‰§è¡Œå**ï¼šçŠ¶æ€ä¿ç•™åœ¨ checkpointer ä¸­

**ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ**
- æ”¯æŒé•¿æœŸå¯¹è¯ï¼šç”¨æˆ·å¯ä»¥éšæ—¶ç»§ç»­ä¹‹å‰çš„å¯¹è¯
- ä¸­æ–­æ¢å¤ï¼šå³ä½¿ç¨‹åºé‡å¯ï¼Œå¯¹è¯å†å²ä¾ç„¶å­˜åœ¨
- å¤šç”¨æˆ·éš”ç¦»ï¼šä¸åŒ thread_id çš„å¯¹è¯äº’ä¸å¹²æ‰°

---

### 9. æ„å»ºå›¾

```python
from IPython.display import Image, display
from langgraph.checkpoint.memory import MemorySaver
from langgraph.graph import StateGraph, START

# å®šä¹‰å›¾
workflow = StateGraph(State)

# æ·»åŠ èŠ‚ç‚¹
workflow.add_node("conversation", call_model)
workflow.add_node(summarize_conversation)  # å‡½æ•°åè‡ªåŠ¨ä½œä¸ºèŠ‚ç‚¹å

# è®¾ç½®å…¥å£
workflow.add_edge(START, "conversation")

# æ·»åŠ æ¡ä»¶è¾¹
workflow.add_conditional_edges("conversation", should_continue)

# æ‘˜è¦åç»“æŸ
workflow.add_edge("summarize_conversation", END)

# ç¼–è¯‘ï¼ˆå¸¦å†…å­˜ï¼‰
memory = MemorySaver()
graph = workflow.compile(checkpointer=memory)

# å¯è§†åŒ–
display(Image(graph.get_graph().draw_mermaid_png()))
```

**å›¾ç»“æ„åˆ†æï¼š**

```
START
  â†“
conversation (call_model)
  â†“
should_continue (æ¡ä»¶åˆ¤æ–­)
  â”œâ”€ â‰¤6 æ¡ â†’ END
  â””â”€ >6 æ¡ â†’ summarize_conversation
              â†“
             END
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šèŠ‚ç‚¹å‘½å**

```python
workflow.add_node("conversation", call_model)  # æ˜¾å¼å‘½å
workflow.add_node(summarize_conversation)       # ä½¿ç”¨å‡½æ•°å
```

ä¸¤ç§æ–¹å¼ï¼š
1. æä¾›åç§°ï¼š`add_node(name, func)`
2. è‡ªåŠ¨å‘½åï¼š`add_node(func)` â†’ ä½¿ç”¨å‡½æ•°åä½œä¸ºèŠ‚ç‚¹å

---

### 10. çº¿ç¨‹ï¼ˆThreadsï¼‰â­â­â­

**æ ¸å¿ƒæ¦‚å¿µï¼š** Thread æ˜¯ä¸€ç»„ç›¸å…³æ£€æŸ¥ç‚¹çš„é›†åˆï¼Œç±»ä¼¼äº Slack çš„é¢‘é“ã€‚

```python
# åˆ›å»ºé…ç½®ï¼ŒæŒ‡å®šçº¿ç¨‹ ID
config = {"configurable": {"thread_id": "1"}}
```

**Thread çš„ä½œç”¨ï¼š**

1. **éš”ç¦»å¯¹è¯**ï¼šä¸åŒ thread_id çš„å¯¹è¯äº’ä¸å½±å“
2. **çŠ¶æ€åˆ†ç»„**ï¼šåŒä¸€ thread å†…çš„æ‰€æœ‰æ£€æŸ¥ç‚¹å…±äº«å†å²
3. **å¤šç”¨æˆ·æ”¯æŒ**ï¼šæ¯ä¸ªç”¨æˆ·ä½¿ç”¨ç‹¬ç«‹çš„ thread_id

**ç±»æ¯”ç†è§£ï¼š**

| æ¦‚å¿µ | LangGraph | Slack |
|------|-----------|-------|
| Thread | thread_id | é¢‘é“ |
| Checkpoint | çŠ¶æ€å¿«ç…§ | æ¶ˆæ¯å†å² |
| State | å½“å‰å¯¹è¯çŠ¶æ€ | å½“å‰é¢‘é“å†…å®¹ |

---

### 11. æ‰§è¡Œå¯¹è¯

```python
# åˆ›å»ºçº¿ç¨‹é…ç½®
config = {"configurable": {"thread_id": "1"}}

# ç¬¬ä¸€è½®å¯¹è¯
input_message = HumanMessage(content="hi! I'm Lance")
output = graph.invoke({"messages": [input_message]}, config)
for m in output['messages'][-1:]:
    m.pretty_print()
```

**è¾“å‡ºï¼š**
```
================================== Ai Message ==================================

Hello Lance! How can I assist you today?
```

**æ‰§è¡Œæµç¨‹ï¼š**

1. æ£€æŸ¥ thread "1" æ˜¯å¦æœ‰å†å² â†’ æ— 
2. åˆ›å»ºæ–°çŠ¶æ€ï¼š`{"messages": [HumanMessage("hi! I'm Lance")]}`
3. è¿›å…¥ `conversation` èŠ‚ç‚¹
4. æ— æ‘˜è¦ï¼Œç›´æ¥è°ƒç”¨ LLM
5. è¿”å› AI å›å¤
6. ä¿å­˜çŠ¶æ€åˆ° thread "1"

---

```python
# ç¬¬äºŒè½®å¯¹è¯
input_message = HumanMessage(content="what's my name?")
output = graph.invoke({"messages": [input_message]}, config)
for m in output['messages'][-1:]:
    m.pretty_print()
```

**è¾“å‡ºï¼š**
```
================================== Ai Message ==================================

You mentioned that your name is Lance. How can I help you today?
```

**æ‰§è¡Œæµç¨‹ï¼š**

1. ä» thread "1" åŠ è½½å†å²çŠ¶æ€ï¼š
   ```
   {"messages": [
       HumanMessage("hi! I'm Lance"),
       AIMessage("Hello Lance!...")
   ]}
   ```
2. è¿½åŠ æ–°æ¶ˆæ¯ï¼š`HumanMessage("what's my name?")`
3. è°ƒç”¨ LLMï¼ˆåŒ…å«å®Œæ•´å†å²ï¼‰
4. AI èƒ½å›å¿†èµ·åå­—æ˜¯ "Lance"
5. ä¿å­˜æ›´æ–°åçš„çŠ¶æ€

---

```python
# ç¬¬ä¸‰è½®å¯¹è¯
input_message = HumanMessage(content="i like the 49ers!")
output = graph.invoke({"messages": [input_message]}, config)
for m in output['messages'][-1:]:
    m.pretty_print()
```

**è¾“å‡ºï¼š**
```
================================== Ai Message ==================================

That's great! The San Francisco 49ers have a rich history and a passionate fan base.
Do you have a favorite player or a memorable game that you particularly enjoyed?
```

**å½“å‰çŠ¶æ€ï¼š**
```
messages: [
    HumanMessage("hi! I'm Lance"),
    AIMessage("Hello Lance!..."),
    HumanMessage("what's my name?"),
    AIMessage("You mentioned that your name is Lance..."),
    HumanMessage("i like the 49ers!"),
    AIMessage("That's great! The San Francisco 49ers...")
]
summary: ""  # è¿˜æœªè§¦å‘æ‘˜è¦
```

æ­¤æ—¶æœ‰ **6 æ¡æ¶ˆæ¯**ï¼Œå°šæœªè¾¾åˆ°è§¦å‘æ‘˜è¦çš„é˜ˆå€¼ï¼ˆ> 6ï¼‰ã€‚

---

### 12. æ£€æŸ¥æ‘˜è¦çŠ¶æ€

```python
graph.get_state(config).values.get("summary", "")
```

**è¾“å‡ºï¼š**
```
''
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šget_state API**

```python
state_snapshot = graph.get_state(config)
state_snapshot.values  # è·å–å½“å‰çŠ¶æ€çš„æ‰€æœ‰å€¼
```

è¿”å› `StateSnapshot` å¯¹è±¡ï¼š
- `values`ï¼šå½“å‰çŠ¶æ€å­—å…¸
- `next`ï¼šä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹
- `config`ï¼šé…ç½®ä¿¡æ¯
- `metadata`ï¼šå…ƒæ•°æ®

---

### 13. è§¦å‘æ‘˜è¦

```python
# ç¬¬å››è½®å¯¹è¯ï¼ˆè§¦å‘æ‘˜è¦ï¼‰
input_message = HumanMessage(content="i like Nick Bosa, isn't he the highest paid defensive player?")
output = graph.invoke({"messages": [input_message]}, config)
for m in output['messages'][-1:]:
    m.pretty_print()
```

**è¾“å‡ºï¼š**
```
================================== Ai Message ==================================

Yes, as of September 2023, Nick Bosa became the highest-paid defensive player in NFL history.
He signed a five-year contract extension with the San Francisco 49ers worth $170 million,
with $122.5 million guaranteed. Bosa is known for his exceptional skills as a defensive end
and has been a key player for the 49ers.
```

**æ‰§è¡Œæµç¨‹ï¼š**

1. åŠ è½½å†å²ï¼ˆ6 æ¡æ¶ˆæ¯ï¼‰
2. è¿½åŠ æ–°æ¶ˆæ¯ â†’ **7 æ¡æ¶ˆæ¯**
3. è¿›å…¥ `conversation` èŠ‚ç‚¹ï¼Œç”Ÿæˆå›å¤
4. ç°åœ¨æœ‰ **8 æ¡æ¶ˆæ¯** â†’ è§¦å‘æ¡ä»¶ `len(messages) > 6`
5. `should_continue` è¿”å› `"summarize_conversation"`
6. è¿›å…¥ `summarize_conversation` èŠ‚ç‚¹ï¼š
   - ç”Ÿæˆæ‘˜è¦
   - åˆ é™¤å‰ 6 æ¡æ¶ˆæ¯
   - ä¿ç•™æœ€æ–° 2 æ¡
7. çŠ¶æ€æ›´æ–°ï¼š
   ```
   messages: [æœ€æ–° 2 æ¡æ¶ˆæ¯]
   summary: "Lance introduced himself and mentioned..."
   ```

---

### 14. æŸ¥çœ‹ç”Ÿæˆçš„æ‘˜è¦

```python
graph.get_state(config).values.get("summary", "")
```

**è¾“å‡ºï¼š**
```
'Lance introduced himself and mentioned that he is a fan of the San Francisco 49ers,
specifically highlighting his admiration for Nick Bosa. The conversation noted that
as of September 2023, Nick Bosa became the highest-paid defensive player in NFL history
with a five-year, $170 million contract extension with the 49ers.'
```

**æ‘˜è¦å†…å®¹åˆ†æï¼š**

âœ… åŒ…å«çš„ä¿¡æ¯ï¼š
- ç”¨æˆ·åå­—ï¼šLance
- å–œå¥½ï¼š49ers é˜Ÿç²‰ä¸
- å–œæ¬¢çš„çƒå‘˜ï¼šNick Bosa
- äº‹å®ä¿¡æ¯ï¼šNick Bosa çš„åˆåŒç»†èŠ‚

âœ… å‹ç¼©æ•ˆæœï¼š
- åŸå§‹ï¼š8 æ¡æ¶ˆæ¯ï¼ˆæ•°ç™¾ tokensï¼‰
- æ‘˜è¦ï¼š1 æ®µæ–‡å­—ï¼ˆçº¦ 50 tokensï¼‰
- å‹ç¼©æ¯”ï¼šçº¦ 80-90%

---

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### LangGraph ç‰¹æœ‰æ¦‚å¿µ

#### 1. MessagesState

**å†…ç½®çŠ¶æ€åŸºç±»**ï¼Œæä¾›å¼€ç®±å³ç”¨çš„æ¶ˆæ¯ç®¡ç†ï¼š

```python
from langgraph.graph import MessagesState

class State(MessagesState):
    # è‡ªåŠ¨æ‹¥æœ‰ messages å­—æ®µ
    summary: str  # æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
```

**ç‰¹æ€§ï¼š**
- `messages` å­—æ®µé¢„é…ç½® `add_messages` reducer
- æ”¯æŒæ¶ˆæ¯è¿½åŠ ã€æ›´æ–°ã€åˆ é™¤
- è‡ªåŠ¨ç®¡ç†æ¶ˆæ¯ ID

#### 2. RemoveMessage

**åˆ é™¤æ¶ˆæ¯çš„æœºåˆ¶**ï¼š

```python
from langchain_core.messages import RemoveMessage

# åˆ é™¤ç‰¹å®šæ¶ˆæ¯
delete_messages = [RemoveMessage(id=m.id) for m in old_messages]
return {"messages": delete_messages}
```

**å·¥ä½œåŸç†ï¼š**
- `add_messages` reducer è¯†åˆ« `RemoveMessage`
- ä»çŠ¶æ€ä¸­ç§»é™¤å¯¹åº” ID çš„æ¶ˆæ¯
- æ”¯æŒæ‰¹é‡åˆ é™¤

#### 3. Checkpointerï¼ˆæ£€æŸ¥ç‚¹ï¼‰

**æŒä¹…åŒ–çŠ¶æ€çš„æœºåˆ¶**ï¼š

```python
from langgraph.checkpoint.memory import MemorySaver

memory = MemorySaver()
graph = workflow.compile(checkpointer=memory)
```

**ä½œç”¨ï¼š**
- æ¯æ­¥è‡ªåŠ¨ä¿å­˜çŠ¶æ€å¿«ç…§
- æ”¯æŒçŠ¶æ€æ¢å¤å’Œç»§ç»­
- å®ç°é•¿æœŸè®°å¿†

#### 4. Threadï¼ˆçº¿ç¨‹ï¼‰

**çŠ¶æ€åˆ†ç»„å’Œéš”ç¦»**ï¼š

```python
config = {"configurable": {"thread_id": "1"}}
graph.invoke(input, config)
```

**ç‰¹æ€§ï¼š**
- æ¯ä¸ª thread ç‹¬ç«‹çš„çŠ¶æ€ç©ºé—´
- é€šè¿‡ thread_id éš”ç¦»ä¸åŒå¯¹è¯
- ç±»ä¼¼æ•°æ®åº“çš„ä¼šè¯æ¦‚å¿µ

#### 5. æ¡ä»¶è¾¹çš„çµæ´»è¿”å›

```python
from typing_extensions import Literal

def should_continue(state: State) -> Literal["next_node", END]:
    if condition:
        return "next_node"
    return END
```

**è¿”å›å€¼ç±»å‹ï¼š**
- èŠ‚ç‚¹åç§°ï¼ˆå­—ç¬¦ä¸²ï¼‰
- `END`ï¼ˆç‰¹æ®Šå¸¸é‡ï¼‰
- åˆ—è¡¨æˆ–å…¶ä»–å¤æ‚é€»è¾‘

---

### Python ç‰¹æœ‰çŸ¥è¯†ç‚¹

#### 1. TypedDict ç»§æ‰¿

```python
from langgraph.graph import MessagesState

class State(MessagesState):
    summary: str
```

**æ³¨æ„ï¼š** `TypedDict` æ”¯æŒç»§æ‰¿ï¼Œå­ç±»æ‹¥æœ‰çˆ¶ç±»çš„æ‰€æœ‰å­—æ®µã€‚

#### 2. å­—å…¸çš„ get æ–¹æ³•

```python
summary = state.get("summary", "")
#                  ^^^^^^^^^  ^^^^
#                  é”®å        é»˜è®¤å€¼
```

**é¿å… KeyError**ï¼š
- é”®å­˜åœ¨ â†’ è¿”å›å€¼
- é”®ä¸å­˜åœ¨ â†’ è¿”å›é»˜è®¤å€¼

#### 3. åˆ—è¡¨åˆ‡ç‰‡

```python
state["messages"][:-2]  # é™¤äº†æœ€å 2 ä¸ªå…ƒç´ çš„æ‰€æœ‰å…ƒç´ 
#                 ^^^^
#                 è´Ÿç´¢å¼•åˆ‡ç‰‡
```

| åˆ‡ç‰‡ | å«ä¹‰ |
|------|------|
| `[:-2]` | ä»å¼€å§‹åˆ°å€’æ•°ç¬¬ 3 ä¸ª |
| `[-2:]` | æœ€å 2 ä¸ª |
| `[2:-2]` | ç¬¬ 3 ä¸ªåˆ°å€’æ•°ç¬¬ 3 ä¸ª |

#### 4. åˆ—è¡¨æ¨å¯¼å¼

```python
delete_messages = [RemoveMessage(id=m.id) for m in state["messages"][:-2]]
```

**ç­‰ä»·äºï¼š**
```python
delete_messages = []
for m in state["messages"][:-2]:
    delete_messages.append(RemoveMessage(id=m.id))
```

#### 5. f-string å¤šè¡Œå­—ç¬¦ä¸²

```python
summary_message = (
    f"This is summary of the conversation to date: {summary}\n\n"
    "Extend the summary by taking into account the new messages above:"
)
```

**Python ç‰¹æ€§ï¼š**
- æ‹¬å·å†…çš„å¤šè¡Œå­—ç¬¦ä¸²ä¼šè‡ªåŠ¨æ‹¼æ¥
- å¯ä»¥æ··ç”¨ f-string å’Œæ™®é€šå­—ç¬¦ä¸²

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ‘˜è¦è§¦å‘ç­–ç•¥

#### æ–¹æ¡ˆ Aï¼šåŸºäºæ¶ˆæ¯æ•°é‡ï¼ˆæœ¬æ•™ç¨‹ï¼‰

```python
def should_continue(state: State):
    if len(state["messages"]) > 6:
        return "summarize_conversation"
    return END
```

âœ… **ä¼˜ç‚¹ï¼š** ç®€å•ã€å¯é¢„æµ‹
âŒ **ç¼ºç‚¹ï¼š** ä¸è€ƒè™‘æ¶ˆæ¯é•¿åº¦

#### æ–¹æ¡ˆ Bï¼šåŸºäº Token æ•°é‡

```python
def should_continue(state: State):
    total_tokens = sum(len(m.content.split()) for m in state["messages"])
    if total_tokens > 1000:
        return "summarize_conversation"
    return END
```

âœ… **ä¼˜ç‚¹ï¼š** æ›´ç²¾ç¡®çš„æˆæœ¬æ§åˆ¶
âŒ **ç¼ºç‚¹ï¼š** è®¡ç®—å¼€é”€

#### æ–¹æ¡ˆ Cï¼šåŸºäºæ—¶é—´

```python
def should_continue(state: State):
    # å‡è®¾ messages æœ‰ timestamp å­—æ®µ
    oldest = state["messages"][0].timestamp
    newest = state["messages"][-1].timestamp
    if (newest - oldest).days > 1:
        return "summarize_conversation"
    return END
```

âœ… **ä¼˜ç‚¹ï¼š** é€‚åˆé•¿æœŸå¯¹è¯
âŒ **ç¼ºç‚¹ï¼š** éœ€è¦é¢å¤–çš„æ—¶é—´æˆ³ç®¡ç†

---

### 2. æ‘˜è¦ä¿ç•™ç­–ç•¥

#### å½“å‰å®ç°ï¼šä¿ç•™æœ€æ–° 2 æ¡

```python
delete_messages = [RemoveMessage(id=m.id) for m in state["messages"][:-2]]
```

**é€‚ç”¨åœºæ™¯ï¼š** ä¸€èˆ¬å¯¹è¯

#### æ–¹æ¡ˆ Bï¼šä¿ç•™æœ€æ–° N æ¡

```python
KEEP_LAST_N = 4
delete_messages = [RemoveMessage(id=m.id) for m in state["messages"][:-KEEP_LAST_N]]
```

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦æ›´å¤šä¸Šä¸‹æ–‡çš„å¯¹è¯

#### æ–¹æ¡ˆ Cï¼šä¿ç•™é‡è¦æ¶ˆæ¯

```python
def is_important(message):
    # è‡ªå®šä¹‰é‡è¦æ€§åˆ¤æ–­é€»è¾‘
    return "é‡è¦" in message.content or message.type == "system"

delete_messages = [
    RemoveMessage(id=m.id)
    for m in state["messages"]
    if not is_important(m)
]
```

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦ä¿ç•™å…³é”®ä¿¡æ¯

---

### 3. æ‘˜è¦è´¨é‡ä¼˜åŒ–

#### æŠ€å·§ 1ï¼šç»“æ„åŒ–æ‘˜è¦æç¤º

```python
summary_prompt = """
Summarize the conversation with the following structure:
- User profile: Name, preferences, interests
- Key topics discussed: Main themes
- Important facts: Specific details mentioned
- Action items: Any pending tasks

Current summary: {summary}
New messages: {messages}
"""
```

#### æŠ€å·§ 2ï¼šå¢é‡æ‘˜è¦

```python
if summary:
    # å‘Šè¯‰ LLM åªæ›´æ–°æ–°ä¿¡æ¯
    prompt = f"Current summary: {summary}\n\nUpdate ONLY with new information from above messages."
else:
    prompt = "Create a comprehensive summary of the conversation."
```

#### æŠ€å·§ 3ï¼šæ‘˜è¦éªŒè¯

```python
def summarize_conversation(state: State):
    # ç”Ÿæˆæ‘˜è¦
    response = model.invoke(messages)
    summary = response.content

    # éªŒè¯æ‘˜è¦è´¨é‡ï¼ˆå¯é€‰ï¼‰
    if len(summary) < 50:
        # æ‘˜è¦å¤ªçŸ­ï¼Œé‡æ–°ç”Ÿæˆ
        prompt = "Create a MORE DETAILED summary..."
        response = model.invoke(prompt)
        summary = response.content

    # ...
```

---

### 4. å†…å­˜ç®¡ç†ç­–ç•¥

#### å¼€å‘ç¯å¢ƒï¼šMemorySaver

```python
from langgraph.checkpoint.memory import MemorySaver
memory = MemorySaver()  # å†…å­˜å­˜å‚¨ï¼Œé‡å¯ä¸¢å¤±
```

âœ… **ä¼˜ç‚¹ï¼š** ç®€å•ã€å¿«é€Ÿ
âŒ **ç¼ºç‚¹ï¼š** ä¸æŒä¹…åŒ–

#### ç”Ÿäº§ç¯å¢ƒï¼šSqliteSaver

```python
from langgraph.checkpoint.sqlite import SqliteSaver
memory = SqliteSaver.from_conn_string("checkpoints.db")
```

âœ… **ä¼˜ç‚¹ï¼š** æŒä¹…åŒ–åˆ°ç£ç›˜
âœ… **é€‚ç”¨ï¼š** å•æœºåº”ç”¨

#### åˆ†å¸ƒå¼ç¯å¢ƒï¼šRedisSaverï¼ˆè‡ªå®šä¹‰ï¼‰

```python
# éœ€è¦è‡ªå·±å®ç°æˆ–ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“
from langgraph.checkpoint.redis import RedisSaver
memory = RedisSaver(redis_url="redis://localhost:6379")
```

âœ… **ä¼˜ç‚¹ï¼š** æ”¯æŒåˆ†å¸ƒå¼ã€é«˜æ€§èƒ½
âœ… **é€‚ç”¨ï¼š** å¤šå®ä¾‹éƒ¨ç½²

---

### 5. Thread ç®¡ç†æœ€ä½³å®è·µ

#### ç­–ç•¥ 1ï¼šåŸºäºç”¨æˆ· ID

```python
def get_config(user_id: str):
    return {"configurable": {"thread_id": f"user_{user_id}"}}

# ä½¿ç”¨
config = get_config("alice")
graph.invoke(input, config)
```

#### ç­–ç•¥ 2ï¼šåŸºäºä¼šè¯ ID

```python
import uuid

def create_session():
    session_id = str(uuid.uuid4())
    return {"configurable": {"thread_id": session_id}}

# æ–°ä¼šè¯
config = create_session()
```

#### ç­–ç•¥ 3ï¼šå¤šç»´åº¦éš”ç¦»

```python
def get_config(user_id: str, conversation_id: str):
    thread_id = f"{user_id}_{conversation_id}"
    return {"configurable": {"thread_id": thread_id}}

# ä½¿ç”¨
config = get_config("alice", "project_discussion")
```

---

## ğŸš€ è¿›é˜¶æŠ€å·§

### 1. å¤šå±‚æ‘˜è¦

å¯¹äºè¶…é•¿å¯¹è¯ï¼Œå¯ä»¥å®ç°å¤šå±‚æ‘˜è¦ï¼š

```python
class State(MessagesState):
    recent_summary: str      # æœ€è¿‘å‡ è½®çš„æ‘˜è¦
    long_term_summary: str   # é•¿æœŸæ€»ç»“

def should_summarize(state: State):
    msg_count = len(state["messages"])
    if msg_count > 20:
        return "create_long_term_summary"
    elif msg_count > 6:
        return "create_recent_summary"
    return END
```

**ç»“æ„ï¼š**
```
æœ€æ–°æ¶ˆæ¯ (2-6 æ¡)
    â†“
recent_summary (å‹ç¼©æœ€è¿‘ 10-20 è½®)
    â†“
long_term_summary (å‹ç¼©æ•´ä¸ªå¯¹è¯å†å²)
```

---

### 2. ä¸»é¢˜é©±åŠ¨çš„æ‘˜è¦

```python
class State(MessagesState):
    summary_by_topic: dict[str, str]  # æŒ‰ä¸»é¢˜åˆ†ç±»çš„æ‘˜è¦

def summarize_conversation(state: State):
    # å…ˆæå–ä¸»é¢˜
    topics = extract_topics(state["messages"])

    # ä¸ºæ¯ä¸ªä¸»é¢˜ç”Ÿæˆæ‘˜è¦
    summaries = {}
    for topic in topics:
        topic_messages = filter_by_topic(state["messages"], topic)
        summary = create_summary(topic_messages)
        summaries[topic] = summary

    return {"summary_by_topic": summaries}
```

---

### 3. æ™ºèƒ½æ‘˜è¦è§¦å‘

æ ¹æ®å¯¹è¯å†…å®¹åŠ¨æ€å†³å®šæ˜¯å¦æ‘˜è¦ï¼š

```python
def should_continue(state: State):
    messages = state["messages"]

    # æ£€æŸ¥æ˜¯å¦æœ‰è¯é¢˜è½¬æ¢
    if detect_topic_change(messages):
        return "summarize_conversation"

    # æ£€æŸ¥æ˜¯å¦æœ‰é‡è¦ä¿¡æ¯
    if has_important_info(messages):
        return "summarize_conversation"

    # å¦åˆ™æ ¹æ®é•¿åº¦åˆ¤æ–­
    if len(messages) > 6:
        return "summarize_conversation"

    return END
```

---

### 4. æ‘˜è¦ä¸åŸæ–‡å¯¹ç…§

ä¿ç•™æ‘˜è¦çš„åŒæ—¶ï¼Œæä¾›åŸæ–‡è®¿é—®ï¼š

```python
class State(MessagesState):
    summary: str
    archived_messages: list  # è¢«æ‘˜è¦çš„åŸå§‹æ¶ˆæ¯

def summarize_conversation(state: State):
    summary_response = model.invoke(...)

    # å½’æ¡£è¢«åˆ é™¤çš„æ¶ˆæ¯
    archived = state["messages"][:-2]
    delete_messages = [RemoveMessage(id=m.id) for m in archived]

    return {
        "summary": summary_response.content,
        "archived_messages": archived,
        "messages": delete_messages
    }
```

**ç”¨é€”ï¼š**
- è°ƒè¯•å’Œå®¡è®¡
- ç”¨æˆ·å¯æŸ¥çœ‹åŸå§‹å¯¹è¯
- æ‘˜è¦è´¨é‡è¯„ä¼°

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. Token æˆæœ¬åˆ†æ

**æ— æ‘˜è¦ï¼ˆå®Œæ•´å†å²ï¼‰ï¼š**
```
è½®æ¬¡ 1: 10 tokens (è¾“å…¥) + 20 tokens (è¾“å‡º) = 30 tokens
è½®æ¬¡ 2: 30 tokens (è¾“å…¥) + 20 tokens (è¾“å‡º) = 50 tokens
è½®æ¬¡ 3: 50 tokens (è¾“å…¥) + 20 tokens (è¾“å‡º) = 70 tokens
...
è½®æ¬¡ 10: 210 tokens (è¾“å…¥) + 20 tokens (è¾“å‡º) = 230 tokens

æ€»è®¡: çº¦ 1300 tokens
```

**æœ‰æ‘˜è¦ï¼š**
```
è½®æ¬¡ 1-3: åŒä¸Š (150 tokens)
è½®æ¬¡ 4: è§¦å‘æ‘˜è¦
  - æ‘˜è¦ç”Ÿæˆ: 70 tokens (è¾“å…¥) + 50 tokens (æ‘˜è¦) = 120 tokens
è½®æ¬¡ 5: 50 tokens (æ‘˜è¦) + 20 tokens (æ–°æ¶ˆæ¯) + 20 tokens (è¾“å‡º) = 90 tokens
...
è½®æ¬¡ 10: ç±»ä¼¼è½®æ¬¡ 5

æ€»è®¡: çº¦ 800 tokens (èŠ‚çœ 38%)
```

### 2. å»¶è¿Ÿä¼˜åŒ–

#### æ–¹æ¡ˆ Aï¼šå¼‚æ­¥æ‘˜è¦

```python
# å½“å‰ï¼šåŒæ­¥æ‘˜è¦ï¼ˆé˜»å¡ç”¨æˆ·ï¼‰
conversation â†’ (6æ¡æ¶ˆæ¯å) â†’ summarize â†’ è¿”å›

# ä¼˜åŒ–ï¼šå¼‚æ­¥æ‘˜è¦ï¼ˆä¸é˜»å¡ï¼‰
conversation â†’ è¿”å›
             â†“ (åå°)
           summarize (ä¸‹æ¬¡å¯¹è¯å‰å®Œæˆ)
```

#### æ–¹æ¡ˆ Bï¼šæ‰¹é‡æ‘˜è¦

```python
# æ¯ N è½®å¯¹è¯æ‰è§¦å‘ä¸€æ¬¡æ‘˜è¦
def should_continue(state: State):
    if len(state["messages"]) > 6 and len(state["messages"]) % 10 == 0:
        return "summarize_conversation"
    return END
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä½¿ç”¨ `state.get("summary", "")` è€Œä¸æ˜¯ `state["summary"]`ï¼Ÿ

**ç­”ï¼š** é˜²æ­¢ `KeyError`ã€‚

- é¦–æ¬¡è¿è¡Œæ—¶ï¼ŒçŠ¶æ€ä¸­æ²¡æœ‰ `summary` å­—æ®µ
- `state["summary"]` ä¼šæŠ›å‡ºå¼‚å¸¸
- `state.get("summary", "")` è¿”å›é»˜è®¤å€¼ `""`

### Q2: RemoveMessage ä¼šçœŸçš„åˆ é™¤æ•°æ®å—ï¼Ÿ

**ç­”ï¼š** å–å†³äº Checkpointerã€‚

- `MemorySaver`ï¼šåªä»å½“å‰çŠ¶æ€åˆ é™¤ï¼Œå†å²å¿«ç…§ä»ä¿ç•™
- `SqliteSaver`ï¼šåŒæ ·ä¿ç•™å†å²å¿«ç…§
- å¯ä»¥é€šè¿‡ `get_state_history()` è®¿é—®å†å²çŠ¶æ€

### Q3: å¦‚æœæ‘˜è¦èŠ‚ç‚¹å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**ç­”ï¼š** å¯ä»¥æ·»åŠ é”™è¯¯å¤„ç†ï¼š

```python
def summarize_conversation(state: State):
    try:
        # æ‘˜è¦é€»è¾‘
        response = model.invoke(messages)
        # ...
        return {"summary": response.content, "messages": delete_messages}
    except Exception as e:
        # å¤±è´¥æ—¶ä¸åˆ é™¤æ¶ˆæ¯ï¼Œä¿ç•™åŸçŠ¶æ€
        print(f"Summarization failed: {e}")
        return {}  # è¿”å›ç©ºå­—å…¸ï¼ŒçŠ¶æ€ä¸å˜
```

### Q4: å¯ä»¥ä¸ºä¸åŒ thread ä½¿ç”¨ä¸åŒçš„æ‘˜è¦ç­–ç•¥å—ï¼Ÿ

**ç­”ï¼š** å¯ä»¥ï¼å°†ç­–ç•¥å­˜å‚¨åœ¨çŠ¶æ€ä¸­ï¼š

```python
class State(MessagesState):
    summary: str
    summary_threshold: int = 6  # å¯é…ç½®

def should_continue(state: State):
    threshold = state.get("summary_threshold", 6)
    if len(state["messages"]) > threshold:
        return "summarize_conversation"
    return END

# ä½¿ç”¨æ—¶
config = {
    "configurable": {"thread_id": "user_1"}
}
graph.invoke({
    "messages": [HumanMessage("...")],
    "summary_threshold": 10  # è¿™ä¸ªç”¨æˆ·ç”¨æ›´é«˜çš„é˜ˆå€¼
}, config)
```

### Q5: å¦‚ä½•åœ¨æ‘˜è¦ä¸­ä¿ç•™æ¶ˆæ¯çš„ç»“æ„ï¼ˆå¦‚è§’è‰²ã€æ—¶é—´æˆ³ï¼‰ï¼Ÿ

**ç­”ï¼š** ä½¿ç”¨ç»“æ„åŒ–æ‘˜è¦ï¼š

```python
from pydantic import BaseModel

class StructuredSummary(BaseModel):
    user_info: str
    topics: list[str]
    key_facts: list[str]
    timestamp: str

def summarize_conversation(state: State):
    response = model.with_structured_output(StructuredSummary).invoke(prompt)
    # response æ˜¯ StructuredSummary å¯¹è±¡
    summary_json = response.json()
    return {"summary": summary_json, "messages": delete_messages}
```

---

## ğŸ¯ å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šå®¢æœæœºå™¨äºº

**éœ€æ±‚ï¼š** æ”¯æŒé•¿æ—¶é—´å®¢æœå¯¹è¯ï¼Œè®°ä½ç”¨æˆ·é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚

```python
class CustomerServiceState(MessagesState):
    summary: str
    customer_info: dict  # å®¢æˆ·ä¿¡æ¯
    issues: list[str]    # é—®é¢˜åˆ—è¡¨

def summarize_conversation(state: State):
    # æå–å®¢æˆ·ä¿¡æ¯å’Œé—®é¢˜
    prompt = """
    Summarize this customer service conversation:
    - Customer name and contact
    - Issues reported
    - Solutions provided
    - Pending actions
    """
    # ...
```

### æ¡ˆä¾‹ 2ï¼šæ•™è‚²è¾…å¯¼æœºå™¨äºº

**éœ€æ±‚ï¼š** è®°å½•å­¦ç”Ÿçš„å­¦ä¹ è¿›åº¦å’Œç†è§£ç¨‹åº¦ã€‚

```python
class TutoringState(MessagesState):
    summary: str
    student_progress: dict  # å­¦ä¹ è¿›åº¦
    weak_areas: list[str]   # è–„å¼±ç¯èŠ‚

def summarize_conversation(state: State):
    prompt = """
    Summarize the tutoring session:
    - Topics covered
    - Student's understanding level
    - Areas needing improvement
    - Homework assigned
    """
    # ...
```

### æ¡ˆä¾‹ 3ï¼šé¡¹ç›®ç®¡ç†åŠ©æ‰‹

**éœ€æ±‚ï¼š** è·Ÿè¸ªé¡¹ç›®è®¨è®ºå’Œå†³ç­–ã€‚

```python
class ProjectState(MessagesState):
    summary: str
    decisions: list[str]     # å†³ç­–è®°å½•
    action_items: list[str]  # å¾…åŠäº‹é¡¹

def summarize_conversation(state: State):
    prompt = """
    Summarize the project discussion:
    - Decisions made
    - Action items and owners
    - Blockers identified
    - Next steps
    """
    # ...
```

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [LangGraph Checkpointer å®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/concepts/persistence/)
- [MessagesState API å‚è€ƒ](https://langchain-ai.github.io/langgraph/concepts/low_level/#messagesstate)
- [RemoveMessage è¯¦ç»†è¯´æ˜](https://langchain-ai.github.io/langgraph/how-tos/memory/delete-messages/)
- [Memory Management æœ€ä½³å®è·µ](https://langchain-ai.github.io/langgraph/how-tos/memory/)

---

## æ€»ç»“

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ï¼š

âœ… **æ ¸å¿ƒæŠ€æœ¯ï¼š**
- ä½¿ç”¨ LLM ç”Ÿæˆå¯¹è¯æ‘˜è¦
- `RemoveMessage` åˆ é™¤æ—§æ¶ˆæ¯
- `MessagesState` ç®€åŒ–çŠ¶æ€ç®¡ç†
- Checkpointer å®ç°æŒä¹…åŒ–
- Thread éš”ç¦»ä¸åŒå¯¹è¯

âœ… **å…³é”®ä¼˜åŠ¿ï¼š**
- æ”¯æŒé•¿æœŸå¯¹è¯è€Œä¸è¶…å‡º token é™åˆ¶
- æ™ºèƒ½å‹ç¼©å†å²ï¼Œä¿ç•™å…³é”®ä¿¡æ¯
- æˆæœ¬ä¼˜åŒ–ï¼ˆå‡å°‘ 30-50% çš„ token ä½¿ç”¨ï¼‰
- ç”¨æˆ·ä½“éªŒæå‡ï¼ˆè®°ä½å®Œæ•´å¯¹è¯å†å²ï¼‰

âœ… **æœ€ä½³å®è·µï¼š**
- æ ¹æ®åº”ç”¨åœºæ™¯é€‰æ‹©æ‘˜è¦è§¦å‘ç­–ç•¥
- ä½¿ç”¨ç»“æ„åŒ–æ‘˜è¦ä¿ç•™é‡è¦ä¿¡æ¯
- åˆç†é…ç½®ä¿ç•™æ¶ˆæ¯æ•°é‡
- é€‰æ‹©åˆé€‚çš„ Checkpointer å®ç°

è¿™æ˜¯æ„å»ºç”Ÿäº§çº§å¯¹è¯ç³»ç»Ÿçš„å…³é”®æŠ€æœ¯ï¼ğŸš€
