# Chatbot with External Memory è¯¦ç»†è§£è¯»

>  ç½‘ç«™ä½¿ç”¨è¯´æ˜
> - æœ¬ç½‘ç«™å¯ä»¥å…ç™»é™†è¿è¡Œ Python ä»£ç 
> - Python ä»£ç å¯ä»¥ç¼–è¾‘å¹¶ä¸´æ—¶ä¿å­˜ï¼Œä½†ä¸ä¼šæ°¸ä¹…ä¿å­˜ï¼Œç½‘é¡µåˆ·æ–°åä¼šè‡ªåŠ¨è¿˜åŸ
> - å¯¹ç½‘ç«™çš„ä½¿ç”¨æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥åˆ° [é—®é¢˜åé¦ˆ](http://localhost:5173/feedback.html) ï¼ˆæŒ‰é’®åœ¨æ¯ä¸ªé¡µé¢çš„å³ä¸‹è§’ï¼‰å…ç™»å½•è¿›è¡Œè¯„è®º
> - è¿è¡Œ `LangGraph/LangChain`ä»£ç ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥è‡ªå·±çš„ [API Key](http://localhost:5173/python-run.html)
> - é‡è¦å£°æ˜ï¼šæœ¬ç½‘ç«™ä¸ä¼šä¿å­˜ç”¨æˆ·çš„ API Key æ•°æ®ï¼Œè¯·æ”¾å¿ƒè¾“å…¥

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£è¯» LangGraph ä¸­**å¸¦å¤–éƒ¨æ•°æ®åº“æŒä¹…åŒ–å­˜å‚¨çš„èŠå¤©æœºå™¨äºº**å®ç°ã€‚è¿™æ˜¯ Module 2 çš„è¿›é˜¶å†…å®¹ï¼Œåœ¨å‰é¢å­¦ä¹ æ¶ˆæ¯æ‘˜è¦å’Œå†…å­˜ç®¡ç†çš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥å¼•å…¥**å¤–éƒ¨æ•°æ®åº“**å®ç°æ°¸ä¹…æ€§çš„å¯¹è¯è®°å¿†ã€‚

**æ ¸å¿ƒäº®ç‚¹ï¼š**
- ä½¿ç”¨ SQLite æ•°æ®åº“æŒä¹…åŒ–å¯¹è¯çŠ¶æ€
- å®ç°è·¨ä¼šè¯çš„å¯¹è¯è®°å¿†
- ç»“åˆæ¶ˆæ¯æ‘˜è¦ä¼˜åŒ–é•¿å¯¹è¯å¤„ç†
- æ”¯æŒå¤šçº¿ç¨‹ç‹¬ç«‹å¯¹è¯ç®¡ç†

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä¸ºä»€ä¹ˆéœ€è¦å¤–éƒ¨æ•°æ®åº“ï¼Ÿ

åœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ä½¿ç”¨ MemorySaver çš„å†…å­˜å­˜å‚¨ï¼š

```python
# å†…å­˜å­˜å‚¨ - ç¨‹åºé‡å¯åæ•°æ®ä¸¢å¤±
from langgraph.checkpoint.memory import MemorySaver
memory = MemorySaver()
```

**å†…å­˜å­˜å‚¨çš„å±€é™æ€§ï¼š**
- âŒ ç¨‹åºé‡å¯åæ‰€æœ‰å¯¹è¯å†å²ä¸¢å¤±
- âŒ æ— æ³•åœ¨ä¸åŒæœåŠ¡å™¨å®ä¾‹é—´å…±äº«çŠ¶æ€
- âŒ ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ
- âŒ æ— æ³•è¿›è¡Œæ•°æ®åˆ†æå’Œå®¡è®¡

**å¤–éƒ¨æ•°æ®åº“çš„ä¼˜åŠ¿ï¼š**
- âœ… æŒä¹…åŒ–å­˜å‚¨ï¼Œé‡å¯ä¸ä¸¢å¤±æ•°æ®
- âœ… æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
- âœ… å¯ä»¥è¿›è¡Œæ•°æ®åˆ†æ
- âœ… é€‚åˆç”Ÿäº§ç¯å¢ƒ
- âœ… æ”¯æŒå¤‡ä»½å’Œæ¢å¤

### Checkpointer æ˜¯ä»€ä¹ˆï¼Ÿ

**Checkpointer** æ˜¯ LangGraph ä¸­è´Ÿè´£ä¿å­˜å’ŒåŠ è½½çŠ¶æ€çš„ç»„ä»¶ã€‚

```
ç”¨æˆ·æ¶ˆæ¯ â†’ å›¾æ‰§è¡Œ â†’ çŠ¶æ€æ›´æ–° â†’ Checkpointer ä¿å­˜
                                      â†“
é‡æ–°æ‰§è¡Œ â† çŠ¶æ€åŠ è½½ â† Checkpointer è¯»å–
```

**LangGraph æ”¯æŒçš„ Checkpointerï¼š**

| Checkpointer | å­˜å‚¨ä½ç½® | æŒä¹…åŒ– | é€‚ç”¨åœºæ™¯ |
|--------------|---------|--------|---------|
| `MemorySaver` | è¿›ç¨‹å†…å­˜ | âŒ | å¼€å‘/æµ‹è¯• |
| `SqliteSaver` | SQLite æ•°æ®åº“ | âœ… | ä¸­å°è§„æ¨¡åº”ç”¨ |
| `PostgresSaver` | PostgreSQL | âœ… | ä¼ä¸šçº§åº”ç”¨ |

---

## ğŸ­ å®æˆ˜æ¡ˆä¾‹ï¼šå¸¦æ‘˜è¦å’ŒæŒä¹…åŒ–çš„èŠå¤©æœºå™¨äºº

æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå®Œæ•´çš„èŠå¤©æœºå™¨äººç³»ç»Ÿï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **è‡ªåŠ¨æ‘˜è¦**ï¼šå¯¹è¯è¶…è¿‡ 6 æ¡æ¶ˆæ¯æ—¶è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦
2. **æ¶ˆæ¯ä¿®å‰ª**ï¼šä¿ç•™æœ€è¿‘ 2 æ¡æ¶ˆæ¯ + æ‘˜è¦
3. **æŒä¹…åŒ–å­˜å‚¨**ï¼šä½¿ç”¨ SQLite ä¿å­˜æ‰€æœ‰çŠ¶æ€
4. **è·¨ä¼šè¯è®°å¿†**ï¼šé‡å¯ç¨‹åºåä»èƒ½æ¢å¤å¯¹è¯

### ç³»ç»Ÿæ¶æ„å›¾

```
ç”¨æˆ·è¾“å…¥
   â†“
[conversation] èŠ‚ç‚¹
   â†“
æ£€æŸ¥æ¶ˆæ¯æ•°é‡
   â†“
è¶…è¿‡ 6 æ¡ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ [summarize_conversation] â†’ ç”Ÿæˆæ‘˜è¦ + åˆ é™¤æ—§æ¶ˆæ¯
   â””â”€ å¦ â†’ END
   â†“
çŠ¶æ€ä¿å­˜åˆ° SQLite
```

---

## ğŸ”§ ç¯å¢ƒå‡†å¤‡

### 1. å®‰è£…ä¾èµ–

```python
%%capture --no-stderr
%pip install --quiet -U langgraph-checkpoint-sqlite langchain_core langgraph langchain_openai
```

**åŒ…è¯´æ˜ï¼š**
- `langgraph-checkpoint-sqlite`ï¼šSQLite checkpointer æ”¯æŒ
- `langchain_core`ï¼šæ ¸å¿ƒæ¶ˆæ¯ç±»å‹å’Œå·¥å…·
- `langgraph`ï¼šå›¾æ„å»ºæ¡†æ¶
- `langchain_openai`ï¼šOpenAI æ¨¡å‹é›†æˆ

### 2. é…ç½® API Key

```python
import os, getpass

def _set_env(var: str):
    if not os.environ.get(var):
        os.environ[var] = getpass.getpass(f"{var}: ")

_set_env("OPENAI_API_KEY")
```

**Python çŸ¥è¯†ç‚¹ï¼šgetpass æ¨¡å—**

`getpass` ç”¨äºå®‰å…¨åœ°è¾“å…¥æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ã€API Keyï¼‰ï¼š

```python
import getpass

# è¾“å…¥æ—¶ä¸ä¼šæ˜¾ç¤ºå­—ç¬¦
password = getpass.getpass("è¯·è¾“å…¥å¯†ç : ")

# ç­‰ä»·äºä½†æ›´å®‰å…¨ï¼š
# password = input("è¯·è¾“å…¥å¯†ç : ")  # âŒ ä¼šæ˜¾ç¤ºè¾“å…¥å†…å®¹
```

---

## ğŸ—„ï¸ SQLite Checkpointer è¯¦è§£

### 1. SQLite ç®€ä»‹

**SQLite** æ˜¯ä¸€ä¸ªè½»é‡çº§çš„åµŒå…¥å¼æ•°æ®åº“ï¼š
- ä¸éœ€è¦ç‹¬ç«‹çš„æ•°æ®åº“æœåŠ¡å™¨
- æ•´ä¸ªæ•°æ®åº“å­˜å‚¨åœ¨å•ä¸ªæ–‡ä»¶ä¸­
- æ€§èƒ½ä¼˜ç§€ï¼Œå¹¿æ³›åº”ç”¨ï¼ˆè¢« Andrej Karpathy ç§°ä¸º"è¶…çº§æµè¡Œ"ï¼‰
- Python å†…ç½®æ”¯æŒ

### 2. åˆ›å»ºå†…å­˜æ•°æ®åº“

```python
import sqlite3

# åˆ›å»ºå†…å­˜æ•°æ®åº“ï¼ˆç¨‹åºç»“æŸåæ¶ˆå¤±ï¼‰
conn = sqlite3.connect(":memory:", check_same_thread=False)
```

**å‚æ•°è¯´æ˜ï¼š**
- `:memory:`ï¼šç‰¹æ®Šå­—ç¬¦ä¸²ï¼Œåˆ›å»ºå†…å­˜æ•°æ®åº“
- `check_same_thread=False`ï¼šå…è®¸å¤šçº¿ç¨‹è®¿é—®ï¼ˆLangGraph éœ€è¦ï¼‰

### 3. åˆ›å»ºæŒä¹…åŒ–æ•°æ®åº“

```python
# ä¸‹è½½ç¤ºä¾‹æ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
!mkdir -p state_db && [ ! -f state_db/example.db ] && wget -P state_db https://github.com/langchain-ai/langchain-academy/raw/main/module-2/state_db/example.db

# è¿æ¥åˆ°æœ¬åœ°æ•°æ®åº“æ–‡ä»¶
db_path = "state_db/example.db"
conn = sqlite3.connect(db_path, check_same_thread=False)
```

**Bash å‘½ä»¤è¯¦è§£ï¼š**

```bash
mkdir -p state_db
# mkdir -p: åˆ›å»ºç›®å½•ï¼Œ-p è¡¨ç¤ºå¦‚æœçˆ¶ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå·²å­˜åœ¨ä¹Ÿä¸æŠ¥é”™

[ ! -f state_db/example.db ]
# [ ]: æ¡ä»¶æµ‹è¯•
# -f: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
# !: å–åï¼Œå³"æ–‡ä»¶ä¸å­˜åœ¨"

&&
# é€»è¾‘ä¸ï¼Œå‰é¢çš„å‘½ä»¤æˆåŠŸæ‰æ‰§è¡Œåé¢çš„

wget -P state_db https://...
# wget: ä¸‹è½½æ–‡ä»¶
# -P state_db: ä¿å­˜åˆ° state_db ç›®å½•
```

### 4. åˆ›å»º SqliteSaver

```python
from langgraph.checkpoint.sqlite import SqliteSaver

# åˆ›å»º checkpointer
memory = SqliteSaver(conn)
```

**SqliteSaver çš„ä½œç”¨ï¼š**
- è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„æ•°æ®åº“è¡¨
- ä¿å­˜å›¾çš„æ¯ä¸€æ­¥çŠ¶æ€ï¼ˆcheckpointï¼‰
- æ”¯æŒçŠ¶æ€æŸ¥è¯¢å’Œæ¢å¤
- ç®¡ç†å¤šä¸ªå¯¹è¯çº¿ç¨‹ï¼ˆthreadï¼‰

**æ•°æ®åº“ç»“æ„ï¼ˆç®€åŒ–ï¼‰ï¼š**

```sql
CREATE TABLE checkpoints (
    thread_id TEXT,      -- å¯¹è¯çº¿ç¨‹ ID
    checkpoint_id TEXT,  -- æ£€æŸ¥ç‚¹ ID
    state BLOB,          -- åºåˆ—åŒ–çš„çŠ¶æ€æ•°æ®
    timestamp DATETIME   -- æ—¶é—´æˆ³
);
```

---

## ğŸ§© å®šä¹‰èŠå¤©æœºå™¨äººçŠ¶æ€å’Œé€»è¾‘

### 1. å¯¼å…¥ä¾èµ–

```python
from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage, HumanMessage, RemoveMessage

from langgraph.graph import END
from langgraph.graph import MessagesState

model = ChatOpenAI(model="gpt-5-nano", temperature=0)
```

### 2. å®šä¹‰çŠ¶æ€ Schema

```python
class State(MessagesState):
    summary: str
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šState ç»§æ‰¿**

```python
# MessagesState æ˜¯ LangGraph æä¾›çš„åŸºç¡€çŠ¶æ€ç±»
# åŒ…å«ä¸€ä¸ª messages å­—æ®µï¼ˆå¸¦ add_messages reducerï¼‰

class MessagesState(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]

# æˆ‘ä»¬çš„ State ç»§æ‰¿å®ƒï¼Œå¹¶æ·»åŠ  summary å­—æ®µ
class State(MessagesState):
    summary: str  # å¯¹è¯æ‘˜è¦
```

**å­—æ®µè¯´æ˜ï¼š**
- `messages`ï¼šæ¶ˆæ¯åˆ—è¡¨ï¼ˆç»§æ‰¿è‡ª MessagesStateï¼‰
- `summary`ï¼šå¯¹è¯æ‘˜è¦ï¼ˆæ–°å¢å­—æ®µï¼‰

### 3. call_model èŠ‚ç‚¹

```python
def call_model(state: State):
    # è·å–æ‘˜è¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    summary = state.get("summary", "")

    # å¦‚æœæœ‰æ‘˜è¦ï¼Œå°†å…¶æ·»åŠ åˆ°ç³»ç»Ÿæ¶ˆæ¯ä¸­
    if summary:
        system_message = f"Summary of conversation earlier: {summary}"
        messages = [SystemMessage(content=system_message)] + state["messages"]
    else:
        messages = state["messages"]

    # è°ƒç”¨ LLM
    response = model.invoke(messages)
    return {"messages": response}
```

**é€»è¾‘è¯¦è§£ï¼š**

**æ­¥éª¤ 1ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ‘˜è¦**
```python
summary = state.get("summary", "")
# .get(key, default) - å¦‚æœ key ä¸å­˜åœ¨è¿”å› default
```

**æ­¥éª¤ 2ï¼šæ„å»ºæ¶ˆæ¯åˆ—è¡¨**

å¦‚æœæœ‰æ‘˜è¦ï¼š
```python
messages = [
    SystemMessage("Summary of conversation earlier: ..."),  # æ‘˜è¦ä½œä¸ºç³»ç»Ÿæ¶ˆæ¯
    HumanMessage("hi! I'm Lance"),                         # åŸå§‹æ¶ˆæ¯
    AIMessage("Hello Lance!"),
    # ... æ›´å¤šæ¶ˆæ¯
]
```

å¦‚æœæ²¡æœ‰æ‘˜è¦ï¼š
```python
messages = [
    HumanMessage("hi! I'm Lance"),
    AIMessage("Hello Lance!"),
    # ... æ‰€æœ‰åŸå§‹æ¶ˆæ¯
]
```

**æ­¥éª¤ 3ï¼šè°ƒç”¨ LLM å¹¶è¿”å›**
```python
response = model.invoke(messages)
return {"messages": response}
# LangGraph ä¼šè‡ªåŠ¨å°† response æ·»åŠ åˆ° state["messages"]
```

### 4. summarize_conversation èŠ‚ç‚¹

```python
def summarize_conversation(state: State):
    # è·å–ç°æœ‰æ‘˜è¦
    summary = state.get("summary", "")

    # åˆ›å»ºæ‘˜è¦æç¤ºè¯
    if summary:
        # å·²æœ‰æ‘˜è¦ï¼Œéœ€è¦æ‰©å±•
        summary_message = (
            f"This is summary of the conversation to date: {summary}\n\n"
            "Extend the summary by taking into account the new messages above:"
        )
    else:
        # é¦–æ¬¡åˆ›å»ºæ‘˜è¦
        summary_message = "Create a summary of the conversation above:"

    # æ·»åŠ æç¤ºè¯åˆ°æ¶ˆæ¯å†å²
    messages = state["messages"] + [HumanMessage(content=summary_message)]
    response = model.invoke(messages)

    # åˆ é™¤é™¤æœ€è¿‘ 2 æ¡ä»¥å¤–çš„æ‰€æœ‰æ¶ˆæ¯
    delete_messages = [RemoveMessage(id=m.id) for m in state["messages"][:-2]]

    return {"summary": response.content, "messages": delete_messages}
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šRemoveMessage**

`RemoveMessage` æ˜¯ LangGraph æä¾›çš„ç‰¹æ®Šæ¶ˆæ¯ç±»å‹ï¼Œç”¨äºä»çŠ¶æ€ä¸­åˆ é™¤æ¶ˆæ¯ï¼š

```python
# åˆ›å»ºåˆ é™¤æŒ‡ä»¤
RemoveMessage(id=message.id)

# æ‰¹é‡åˆ é™¤ç¤ºä¾‹
messages = state["messages"]  # å‡è®¾æœ‰ 10 æ¡æ¶ˆæ¯
delete_messages = [RemoveMessage(id=m.id) for m in messages[:-2]]
# åˆ é™¤å‰ 8 æ¡ï¼Œä¿ç•™æœ€å 2 æ¡
```

**æ‰§è¡Œæµç¨‹ç¤ºæ„ï¼š**

**å‡è®¾å½“å‰çŠ¶æ€ï¼š**
```python
messages = [
    msg1,  # id=1
    msg2,  # id=2
    msg3,  # id=3
    msg4,  # id=4
    msg5,  # id=5
    msg6,  # id=6
    msg7,  # id=7
]
```

**æ‰§è¡Œæ‘˜è¦åï¼š**
```python
# 1. ç”Ÿæˆæ‘˜è¦
summary = "Lance ä»‹ç»è‡ªå·±ï¼Œå–œæ¬¢ 49ers..."

# 2. åˆ›å»ºåˆ é™¤æŒ‡ä»¤ï¼ˆä¿ç•™æœ€å 2 æ¡ï¼‰
delete_messages = [
    RemoveMessage(id=1),
    RemoveMessage(id=2),
    RemoveMessage(id=3),
    RemoveMessage(id=4),
    RemoveMessage(id=5),
]

# 3. è¿”å›æ›´æ–°
return {
    "summary": summary,
    "messages": delete_messages
}

# 4. æœ€ç»ˆçŠ¶æ€
messages = [msg6, msg7]  # åªä¿ç•™æœ€å 2 æ¡
summary = "Lance ä»‹ç»è‡ªå·±ï¼Œå–œæ¬¢ 49ers..."
```

**Python çŸ¥è¯†ç‚¹ï¼šåˆ—è¡¨åˆ‡ç‰‡**

```python
messages = [1, 2, 3, 4, 5]

messages[-2:]   # [4, 5]  - æœ€å 2 ä¸ªå…ƒç´ 
messages[:-2]   # [1, 2, 3]  - é™¤æœ€å 2 ä¸ªå¤–çš„æ‰€æœ‰å…ƒç´ 
messages[:2]    # [1, 2]  - å‰ 2 ä¸ªå…ƒç´ 
messages[2:]    # [3, 4, 5]  - ä»ç¬¬ 3 ä¸ªå¼€å§‹çš„æ‰€æœ‰å…ƒç´ 
```

### 5. should_continue æ¡ä»¶å‡½æ•°

```python
def should_continue(state: State):
    """è¿”å›ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹"""

    messages = state["messages"]

    # å¦‚æœæ¶ˆæ¯è¶…è¿‡ 6 æ¡ï¼Œæ‰§è¡Œæ‘˜è¦
    if len(messages) > 6:
        return "summarize_conversation"

    # å¦åˆ™ç»“æŸ
    return END
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šæ¡ä»¶è¾¹è¿”å›å€¼**

æ¡ä»¶å‡½æ•°å¯ä»¥è¿”å›ï¼š
1. **èŠ‚ç‚¹åç§°å­—ç¬¦ä¸²**ï¼š`"summarize_conversation"`
2. **END å¸¸é‡**ï¼šç»“æŸå›¾æ‰§è¡Œ
3. **å¤šä¸ªå¯èƒ½çš„èŠ‚ç‚¹åï¼ˆé…åˆæ˜ å°„ä½¿ç”¨ï¼‰**

```python
# ç¤ºä¾‹ 1ï¼šç®€å•æ¡ä»¶
def should_continue(state):
    if condition:
        return "node_a"
    return END

# ç¤ºä¾‹ 2ï¼šå¤šè·¯åˆ†æ”¯
def route(state):
    if state["score"] > 0.8:
        return "high_quality"
    elif state["score"] > 0.5:
        return "medium_quality"
    return "low_quality"
```

---

## ğŸ—ï¸ æ„å»ºå›¾

### 1. å®šä¹‰å›¾ç»“æ„

```python
from IPython.display import Image, display
from langgraph.graph import StateGraph, START

# åˆ›å»ºå›¾
workflow = StateGraph(State)

# æ·»åŠ èŠ‚ç‚¹
workflow.add_node("conversation", call_model)
workflow.add_node(summarize_conversation)  # å‡½æ•°å = èŠ‚ç‚¹å

# å®šä¹‰è¾¹
workflow.add_edge(START, "conversation")
workflow.add_conditional_edges("conversation", should_continue)
workflow.add_edge("summarize_conversation", END)

# ç¼–è¯‘ï¼ˆå…³é”®ï¼ä½¿ç”¨ SQLite checkpointerï¼‰
graph = workflow.compile(checkpointer=memory)

# å¯è§†åŒ–
display(Image(graph.get_graph().draw_mermaid_png()))
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šadd_node çš„ä¸¤ç§æ–¹å¼**

```python
# æ–¹å¼ 1ï¼šæŒ‡å®šèŠ‚ç‚¹å
workflow.add_node("conversation", call_model)
#                  ^^^^^^^^^^^^^  ^^^^^^^^^^
#                  èŠ‚ç‚¹å           å‡½æ•°

# æ–¹å¼ 2ï¼šè‡ªåŠ¨ä½¿ç”¨å‡½æ•°åä½œä¸ºèŠ‚ç‚¹å
workflow.add_node(summarize_conversation)
# ç­‰ä»·äºï¼š
# workflow.add_node("summarize_conversation", summarize_conversation)
```

**å›¾ç»“æ„å¯è§†åŒ–ï¼š**

```mermaid
graph TD
    START --> conversation
    conversation -->|len > 6| summarize_conversation
    conversation -->|len â‰¤ 6| END
    summarize_conversation --> END
```

### 2. ç¼–è¯‘æ—¶æŒ‡å®š Checkpointer

```python
graph = workflow.compile(checkpointer=memory)
#                        ^^^^^^^^^^^^^^^^^^^
#                        å…³é”®ï¼å¯ç”¨çŠ¶æ€æŒä¹…åŒ–
```

**æ²¡æœ‰ checkpointer vs æœ‰ checkpointerï¼š**

| ç‰¹æ€§ | æ—  checkpointer | æœ‰ checkpointer |
|------|----------------|----------------|
| çŠ¶æ€ä¿å­˜ | âŒ ä¸ä¿å­˜ | âœ… è‡ªåŠ¨ä¿å­˜æ¯ä¸€æ­¥ |
| å¯¹è¯è®°å¿† | âŒ æ—  | âœ… æ”¯æŒå¤šè½®å¯¹è¯ |
| é‡å¯æ¢å¤ | âŒ ä¸å¯èƒ½ | âœ… å¯ä»¥æ¢å¤ |
| thread_id | âŒ æ— æ„ä¹‰ | âœ… å¿…éœ€ |

---

## ğŸš€ è¿è¡ŒèŠå¤©æœºå™¨äºº

### 1. åˆ›å»ºå¯¹è¯çº¿ç¨‹

```python
# é…ç½®ï¼šæŒ‡å®šçº¿ç¨‹ ID
config = {"configurable": {"thread_id": "1"}}
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šThreadï¼ˆçº¿ç¨‹ï¼‰**

**Thread** æ˜¯ LangGraph ä¸­çš„å¯¹è¯ä¼šè¯æ¦‚å¿µï¼š

```python
# ä¸åŒçš„ thread_id = ä¸åŒçš„å¯¹è¯ä¼šè¯
config_user1 = {"configurable": {"thread_id": "user_123"}}
config_user2 = {"configurable": {"thread_id": "user_456"}}

# å®ƒä»¬çš„çŠ¶æ€å®Œå…¨ç‹¬ç«‹
graph.invoke({"messages": [...]}, config_user1)  # ç”¨æˆ·1çš„å¯¹è¯
graph.invoke({"messages": [...]}, config_user2)  # ç”¨æˆ·2çš„å¯¹è¯
```

**å®é™…åº”ç”¨åœºæ™¯ï¼š**
- å¤šç”¨æˆ·èŠå¤©æœºå™¨äººï¼ˆæ¯ä¸ªç”¨æˆ·ä¸€ä¸ª thread_idï¼‰
- A/B æµ‹è¯•ï¼ˆä¸åŒé…ç½®ä½¿ç”¨ä¸åŒ thread_idï¼‰
- å¤šè½®å¯¹è¯ç®¡ç†

### 2. æ‰§è¡Œå¤šè½®å¯¹è¯

```python
# ç¬¬ 1 è½®
input_message = HumanMessage(content="hi! I'm Lance")
output = graph.invoke({"messages": [input_message]}, config)
for m in output['messages'][-1:]:
    m.pretty_print()

# ç¬¬ 2 è½®
input_message = HumanMessage(content="what's my name?")
output = graph.invoke({"messages": [input_message]}, config)
for m in output['messages'][-1:]:
    m.pretty_print()

# ç¬¬ 3 è½®
input_message = HumanMessage(content="i like the 49ers!")
output = graph.invoke({"messages": [input_message]}, config)
for m in output['messages'][-1:]:
    m.pretty_print()
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
================================== Ai Message ==================================

Hello again, Lance! It's great to hear from you. Since you like the 49ers, is there a particular player or moment in their history that stands out to you?

================================== Ai Message ==================================

Your name is Lance! How can I assist you today? Would you like to talk more about the San Francisco 49ers or something else?

================================== Ai Message ==================================

That's awesome, Lance! The San Francisco 49ers have a rich history and a passionate fan base. Is there a specific aspect of the team you'd like to discuss?
```

**Python çŸ¥è¯†ç‚¹ï¼šåˆ—è¡¨åˆ‡ç‰‡å–æœ€åä¸€ä¸ªå…ƒç´ **

```python
output['messages'][-1:]   # è¿”å›åˆ—è¡¨ [æœ€åä¸€æ¡æ¶ˆæ¯]
output['messages'][-1]    # è¿”å›å•ä¸ªæ¶ˆæ¯å¯¹è±¡

# ä¸ºä»€ä¹ˆç”¨ [-1:] è€Œä¸æ˜¯ [-1]ï¼Ÿ
# å› ä¸º pretty_print() å¯ä»¥å¤„ç†åˆ—è¡¨ï¼Œç»Ÿä¸€æ¥å£
```

**å¯¹è¯åˆ†æï¼š**

| è½®æ¬¡ | ç”¨æˆ·è¾“å…¥ | AI å›å¤ | è¯´æ˜ |
|------|---------|---------|------|
| 1 | "hi! I'm Lance" | "Hello again, Lance!" | AI è®°ä½äº†åå­— |
| 2 | "what's my name?" | "Your name is Lance!" | ä»å†å²ä¸­å›å¿† |
| 3 | "i like the 49ers!" | "That's awesome, Lance!" | ä¸Šä¸‹æ–‡è¿è´¯ |

---

## ğŸ’¾ æŸ¥çœ‹å’Œæ¢å¤çŠ¶æ€

### 1. æŸ¥çœ‹å½“å‰çŠ¶æ€

```python
config = {"configurable": {"thread_id": "1"}}
graph_state = graph.get_state(config)
graph_state
```

**è¾“å‡ºï¼ˆStateSnapshot å¯¹è±¡ï¼‰ï¼š**

```python
StateSnapshot(
    values={
        'messages': [
            HumanMessage(content="hi! I'm Lance", id='d5bb4b3f-...'),
            AIMessage(content="Hello again, Lance! ...", id='run-dde04d51-...'),
            HumanMessage(content="what's my name?", id='d7530770-...'),
            AIMessage(content='Your name is Lance! ...', id='run-763b6387-...'),
            HumanMessage(content='i like the 49ers!', id='235dcec4-...'),
            AIMessage(content="That's awesome, Lance! ...", id='run-729860b2-...')
        ],
        'summary': 'Lance introduced himself multiple times...'
    },
    next=(),
    config={
        'configurable': {
            'thread_id': '1',
            'checkpoint_ns': '',
            'checkpoint_id': '1ef6a36d-ca9c-6144-801b-6d0cf97adc73'
        }
    },
    metadata={
        'source': 'loop',
        'writes': {...},
        'step': 27,
        'parents': {}
    },
    created_at='2024-09-03T20:55:33.466540+00:00',
    parent_config={...},
    tasks=()
)
```

**StateSnapshot å­—æ®µè¯¦è§£ï¼š**

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|--------|
| `values` | å½“å‰çŠ¶æ€çš„æ‰€æœ‰æ•°æ® | `{"messages": [...], "summary": "..."}` |
| `next` | ä¸‹ä¸€æ­¥è¦æ‰§è¡Œçš„èŠ‚ç‚¹ | `()` è¡¨ç¤ºå·²ç»“æŸ |
| `config` | é…ç½®ä¿¡æ¯ï¼ˆå« checkpoint_idï¼‰ | `{"thread_id": "1", "checkpoint_id": "..."}` |
| `metadata` | å…ƒæ•°æ®ï¼ˆæ­¥æ•°ã€æ¥æºç­‰ï¼‰ | `{"step": 27, "source": "loop"}` |
| `created_at` | åˆ›å»ºæ—¶é—´ | `"2024-09-03T20:55:33..."` |

### 2. æŒä¹…åŒ–éªŒè¯

**å…³é”®ç‰¹æ€§ï¼šé‡å¯ç¬”è®°æœ¬åçŠ¶æ€ä»ç„¶å­˜åœ¨ï¼**

```python
# é‡å¯ Jupyter kernel åé‡æ–°è¿è¡Œ

# é‡æ–°è¿æ¥æ•°æ®åº“
db_path = "state_db/example.db"
conn = sqlite3.connect(db_path, check_same_thread=False)
memory = SqliteSaver(conn)

# é‡æ–°ç¼–è¯‘å›¾
graph = workflow.compile(checkpointer=memory)

# æŸ¥è¯¢çŠ¶æ€ - æ•°æ®ä»ç„¶å­˜åœ¨ï¼
config = {"configurable": {"thread_id": "1"}}
graph_state = graph.get_state(config)
graph_state  # è¿”å›ä¹‹å‰çš„å¯¹è¯å†å²
```

**ä¸ºä»€ä¹ˆå¯ä»¥æ¢å¤ï¼Ÿ**

```
ç¨‹åºè¿è¡Œæ—¶ï¼š
  çŠ¶æ€ â†’ SqliteSaver â†’ SQLite æ–‡ä»¶ (state_db/example.db)

ç¨‹åºé‡å¯ï¼š
  SQLite æ–‡ä»¶ä¾ç„¶å­˜åœ¨ â†’ SqliteSaver è¯»å– â†’ æ¢å¤çŠ¶æ€
```

**å¯¹æ¯”å†…å­˜å­˜å‚¨ï¼š**

```python
# MemorySaver - é‡å¯åä¸¢å¤±
memory = MemorySaver()
graph = workflow.compile(checkpointer=memory)
# é‡å¯å graph_state ä¸ºç©º

# SqliteSaver - é‡å¯åä¿ç•™
memory = SqliteSaver(conn)
graph = workflow.compile(checkpointer=memory)
# é‡å¯å graph_state ä»ç„¶å­˜åœ¨
```

---

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### LangGraph ç‰¹æœ‰æ¦‚å¿µ

#### 1. Checkpointer

**å®šä¹‰ï¼š** è´Ÿè´£ä¿å­˜å’ŒåŠ è½½å›¾çŠ¶æ€çš„ç»„ä»¶

**ç±»å‹å¯¹æ¯”ï¼š**

```python
# å†…å­˜å­˜å‚¨ï¼ˆå¼€å‘ç”¨ï¼‰
from langgraph.checkpoint.memory import MemorySaver
memory = MemorySaver()

# SQLite å­˜å‚¨ï¼ˆç”Ÿäº§å°è§„æ¨¡ï¼‰
from langgraph.checkpoint.sqlite import SqliteSaver
memory = SqliteSaver(conn)

# PostgreSQL å­˜å‚¨ï¼ˆä¼ä¸šçº§ï¼‰
from langgraph.checkpoint.postgres import PostgresSaver
memory = PostgresSaver(connection_string)
```

#### 2. Threadï¼ˆçº¿ç¨‹ï¼‰

**ä½œç”¨ï¼š** éš”ç¦»ä¸åŒå¯¹è¯ä¼šè¯çš„çŠ¶æ€

```python
# æ¯ä¸ªç”¨æˆ·ä¸€ä¸ªçº¿ç¨‹
config_alice = {"configurable": {"thread_id": "alice"}}
config_bob = {"configurable": {"thread_id": "bob"}}

# ç‹¬ç«‹çš„å¯¹è¯å†å²
graph.invoke({"messages": [HumanMessage("æˆ‘æ˜¯ Alice")]}, config_alice)
graph.invoke({"messages": [HumanMessage("æˆ‘æ˜¯ Bob")]}, config_bob)
```

#### 3. StateSnapshot

**ä½œç”¨ï¼š** è¡¨ç¤ºå›¾åœ¨æŸä¸ªæ—¶é—´ç‚¹çš„å®Œæ•´çŠ¶æ€

```python
snapshot = graph.get_state(config)

# è®¿é—®çŠ¶æ€æ•°æ®
snapshot.values["messages"]  # æ¶ˆæ¯åˆ—è¡¨
snapshot.values["summary"]   # æ‘˜è¦

# è®¿é—®å…ƒæ•°æ®
snapshot.config["configurable"]["checkpoint_id"]  # æ£€æŸ¥ç‚¹ ID
snapshot.metadata["step"]  # æ‰§è¡Œæ­¥æ•°
snapshot.created_at        # åˆ›å»ºæ—¶é—´
```

#### 4. RemoveMessage

**ä½œç”¨ï¼š** ä»çŠ¶æ€ä¸­åˆ é™¤æ¶ˆæ¯

```python
# åˆ é™¤å•æ¡æ¶ˆæ¯
RemoveMessage(id=message.id)

# æ‰¹é‡åˆ é™¤ï¼ˆä¿ç•™æœ€å N æ¡ï¼‰
delete_msgs = [RemoveMessage(id=m.id) for m in messages[:-N]]
return {"messages": delete_msgs}
```

### Python ç‰¹æœ‰çŸ¥è¯†ç‚¹

#### 1. getpass æ¨¡å—

**ä½œç”¨ï¼š** å®‰å…¨è¾“å…¥æ•æ„Ÿä¿¡æ¯

```python
import getpass

# è¾“å…¥ä¸ä¼šå›æ˜¾
password = getpass.getpass("å¯†ç : ")
api_key = getpass.getpass("API Key: ")
```

#### 2. sqlite3 æ¨¡å—

**åŸºæœ¬ç”¨æ³•ï¼š**

```python
import sqlite3

# å†…å­˜æ•°æ®åº“
conn = sqlite3.connect(":memory:")

# æ–‡ä»¶æ•°æ®åº“
conn = sqlite3.connect("my_database.db")

# å¤šçº¿ç¨‹æ”¯æŒ
conn = sqlite3.connect("db.db", check_same_thread=False)

# æ‰§è¡Œ SQL
cursor = conn.cursor()
cursor.execute("SELECT * FROM table")
results = cursor.fetchall()
```

#### 3. å­—å…¸ .get() æ–¹æ³•

**ä½œç”¨ï¼š** å®‰å…¨è·å–å­—å…¸å€¼ï¼Œé¿å… KeyError

```python
state = {"messages": [...]}

# ä¸å®‰å…¨çš„æ–¹å¼
summary = state["summary"]  # âŒ KeyError å¦‚æœä¸å­˜åœ¨

# å®‰å…¨çš„æ–¹å¼
summary = state.get("summary", "")  # âœ… ä¸å­˜åœ¨è¿”å›é»˜è®¤å€¼
```

#### 4. åˆ—è¡¨åˆ‡ç‰‡é«˜çº§ç”¨æ³•

```python
messages = [1, 2, 3, 4, 5]

# åŸºç¡€åˆ‡ç‰‡
messages[1:3]    # [2, 3]
messages[:3]     # [1, 2, 3]
messages[3:]     # [4, 5]

# è´Ÿç´¢å¼•
messages[-1]     # 5 (æœ€åä¸€ä¸ª)
messages[-2:]    # [4, 5] (æœ€åä¸¤ä¸ª)
messages[:-2]    # [1, 2, 3] (é™¤æœ€åä¸¤ä¸ª)

# æ­¥é•¿
messages[::2]    # [1, 3, 5] (æ¯éš”ä¸€ä¸ª)
messages[::-1]   # [5, 4, 3, 2, 1] (åè½¬)
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„ Checkpointer

| åœºæ™¯ | æ¨è Checkpointer | ç†ç”± |
|------|------------------|------|
| æœ¬åœ°å¼€å‘/æµ‹è¯• | `MemorySaver` | ç®€å•å¿«é€Ÿ |
| å°è§„æ¨¡åº”ç”¨ | `SqliteSaver` | è½»é‡çº§æŒä¹…åŒ– |
| ç”Ÿäº§ç¯å¢ƒï¼ˆå•æœºï¼‰ | `SqliteSaver` | å¯é ä¸”æ˜“éƒ¨ç½² |
| åˆ†å¸ƒå¼ç³»ç»Ÿ | `PostgresSaver` | æ”¯æŒå¹¶å‘å’Œæ‰©å±• |
| äº‘åŸç”Ÿåº”ç”¨ | `PostgresSaver` | ä¸äº‘æœåŠ¡é›†æˆå¥½ |

### 2. Thread ID è®¾è®¡æ¨¡å¼

#### æ¨¡å¼ 1ï¼šç”¨æˆ· ID ä½œä¸º Thread ID

```python
# æ¯ä¸ªç”¨æˆ·ä¸€ä¸ªå¯¹è¯çº¿ç¨‹
user_id = "user_12345"
config = {"configurable": {"thread_id": f"user_{user_id}"}}
```

#### æ¨¡å¼ 2ï¼šä¼šè¯ ID

```python
# ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªä¼šè¯
session_id = str(uuid.uuid4())
config = {"configurable": {"thread_id": session_id}}
```

#### æ¨¡å¼ 3ï¼šç»„åˆ ID

```python
# ç”¨æˆ· + æ—¥æœŸ
thread_id = f"user_{user_id}_date_{date.today()}"
config = {"configurable": {"thread_id": thread_id}}
```

### 3. æ¶ˆæ¯æ‘˜è¦ç­–ç•¥

#### ç­–ç•¥ 1ï¼šå›ºå®šé˜ˆå€¼

```python
# è¶…è¿‡ N æ¡æ¶ˆæ¯å°±æ‘˜è¦
if len(messages) > 6:
    return "summarize"
```

#### ç­–ç•¥ 2ï¼šToken è®¡æ•°

```python
# æ ¹æ® token æ•°é‡å†³å®š
from tiktoken import encoding_for_model

encoder = encoding_for_model("gpt-4")
total_tokens = sum(len(encoder.encode(m.content)) for m in messages)

if total_tokens > 2000:
    return "summarize"
```

#### ç­–ç•¥ 3ï¼šæ—¶é—´çª—å£

```python
# è¶…è¿‡ä¸€å®šæ—¶é—´çš„æ¶ˆæ¯æ‘˜è¦
from datetime import datetime, timedelta

cutoff_time = datetime.now() - timedelta(hours=1)
old_messages = [m for m in messages if m.timestamp < cutoff_time]

if old_messages:
    return "summarize"
```

### 4. æ•°æ®åº“ç»´æŠ¤

#### å®šæœŸæ¸…ç†

```python
# åˆ é™¤è¶…è¿‡ 30 å¤©çš„æ—§æ£€æŸ¥ç‚¹
import sqlite3
from datetime import datetime, timedelta

conn = sqlite3.connect("state_db/example.db")
cursor = conn.cursor()

cutoff_date = datetime.now() - timedelta(days=30)
cursor.execute(
    "DELETE FROM checkpoints WHERE created_at < ?",
    (cutoff_date,)
)
conn.commit()
```

#### å¤‡ä»½

```python
import shutil
from datetime import datetime

# åˆ›å»ºå¤‡ä»½
backup_name = f"backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.db"
shutil.copy("state_db/example.db", f"backups/{backup_name}")
```

---

## ğŸš€ è¿›é˜¶æŠ€å·§

### 1. å¤šæ¨¡å‹æ‘˜è¦

ä½¿ç”¨æ›´å¿«/ä¾¿å®œçš„æ¨¡å‹ç”Ÿæˆæ‘˜è¦ï¼š

```python
# å¯¹è¯ç”¨å¼ºæ¨¡å‹
conversation_model = ChatOpenAI(model="gpt-5-nano")

# æ‘˜è¦ç”¨å¿«é€Ÿæ¨¡å‹
summary_model = ChatOpenAI(model="gpt-3.5-turbo")

def summarize_conversation(state: State):
    summary_message = "Summarize this conversation:"
    messages = state["messages"] + [HumanMessage(content=summary_message)]

    # ä½¿ç”¨å¿«é€Ÿæ¨¡å‹
    response = summary_model.invoke(messages)

    delete_messages = [RemoveMessage(id=m.id) for m in state["messages"][:-2]]
    return {"summary": response.content, "messages": delete_messages}
```

### 2. æ¸è¿›å¼æ‘˜è¦

æ¯æ¬¡åªæ‘˜è¦ä¸€éƒ¨åˆ†æ¶ˆæ¯ï¼š

```python
def progressive_summarize(state: State):
    messages = state["messages"]

    # åªæ‘˜è¦ä¸­é—´çš„æ¶ˆæ¯ï¼Œä¿ç•™æœ€è¿‘çš„
    to_summarize = messages[:-10]  # ä¿ç•™æœ€å 10 æ¡
    keep_messages = messages[-10:]

    # ç”Ÿæˆéƒ¨åˆ†æ‘˜è¦
    summary_prompt = f"Summarize these messages: {to_summarize}"
    partial_summary = model.invoke(summary_prompt)

    # åˆ é™¤å·²æ‘˜è¦çš„æ¶ˆæ¯
    delete_msgs = [RemoveMessage(id=m.id) for m in to_summarize]

    return {
        "summary": partial_summary.content,
        "messages": delete_msgs
    }
```

### 3. æ¡ä»¶æ€§æ‘˜è¦

æ ¹æ®å¯¹è¯å†…å®¹å†³å®šæ˜¯å¦æ‘˜è¦ï¼š

```python
def intelligent_should_continue(state: State):
    messages = state["messages"]

    # æ£€æŸ¥æ˜¯å¦æœ‰å®è´¨æ€§å†…å®¹
    has_content = any(len(m.content) > 50 for m in messages[-5:])

    # åªæœ‰åœ¨æœ‰å®è´¨æ€§å¯¹è¯æ—¶æ‰æ‘˜è¦
    if len(messages) > 6 and has_content:
        return "summarize_conversation"

    return END
```

### 4. åˆ†å±‚å­˜å‚¨

å°†æ‘˜è¦å’ŒåŸå§‹æ¶ˆæ¯åˆ†åˆ«å­˜å‚¨ï¼š

```python
class State(MessagesState):
    summary: str
    full_history: Annotated[list, operator.add]  # å®Œæ•´å†å²ï¼ˆä¸æ˜¾ç¤ºç»™ LLMï¼‰

def call_model(state: State):
    # åªå‘é€æœ€è¿‘æ¶ˆæ¯ + æ‘˜è¦
    summary = state.get("summary", "")
    recent_messages = state["messages"][-5:]

    if summary:
        messages = [SystemMessage(summary)] + recent_messages
    else:
        messages = recent_messages

    response = model.invoke(messages)

    # ä¿å­˜åˆ°å®Œæ•´å†å²
    return {
        "messages": response,
        "full_history": [response]
    }
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: SqliteSaver ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨å—ï¼Ÿ

**æ˜¯çš„ï¼** `SqliteSaver` åœ¨åˆå§‹åŒ–æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºå¿…è¦çš„è¡¨ï¼š

```python
memory = SqliteSaver(conn)
# è‡ªåŠ¨æ‰§è¡Œï¼š
# CREATE TABLE IF NOT EXISTS checkpoints (...)
# CREATE TABLE IF NOT EXISTS checkpoint_writes (...)
```

### Q2: å¦‚ä½•åˆ é™¤æŸä¸ªçº¿ç¨‹çš„æ‰€æœ‰å†å²ï¼Ÿ

ç›®å‰æ²¡æœ‰ç›´æ¥çš„ APIï¼Œä½†å¯ä»¥æ“ä½œæ•°æ®åº“ï¼š

```python
import sqlite3

conn = sqlite3.connect("state_db/example.db")
cursor = conn.cursor()

# åˆ é™¤æŒ‡å®šçº¿ç¨‹
cursor.execute(
    "DELETE FROM checkpoints WHERE thread_id = ?",
    ("thread_id_to_delete",)
)
conn.commit()
```

### Q3: å¯ä»¥åœ¨ä¸åŒçš„å›¾ä¹‹é—´å…±äº«åŒä¸€ä¸ª checkpointer å—ï¼Ÿ

**å¯ä»¥ï¼Œä½†è¦å°å¿ƒï¼** ä¸åŒçš„å›¾å¯ä»¥å…±äº«æ•°æ®åº“ï¼Œä½†éœ€è¦ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹ IDï¼š

```python
memory = SqliteSaver(conn)

# å›¾ 1
graph1 = workflow1.compile(checkpointer=memory)
config1 = {"configurable": {"thread_id": "graph1_user1"}}

# å›¾ 2
graph2 = workflow2.compile(checkpointer=memory)
config2 = {"configurable": {"thread_id": "graph2_user1"}}

# å®ƒä»¬çš„çŠ¶æ€äº’ä¸å½±å“
```

### Q4: æ‘˜è¦ç”Ÿæˆå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

æ·»åŠ é”™è¯¯å¤„ç†ï¼š

```python
def summarize_conversation(state: State):
    try:
        summary_message = "Create a summary..."
        messages = state["messages"] + [HumanMessage(content=summary_message)]
        response = model.invoke(messages)

        delete_messages = [RemoveMessage(id=m.id) for m in state["messages"][:-2]]
        return {"summary": response.content, "messages": delete_messages}

    except Exception as e:
        # å‡ºé”™æ—¶ä¸åˆ é™¤æ¶ˆæ¯ï¼Œä¿ç•™ç°æœ‰æ‘˜è¦
        print(f"Summarization failed: {e}")
        return {}  # ä¸æ›´æ–°ä»»ä½•å­—æ®µ
```

### Q5: å¦‚ä½•æŸ¥çœ‹æ‰€æœ‰çš„çº¿ç¨‹ IDï¼Ÿ

æŸ¥è¯¢æ•°æ®åº“ï¼š

```python
cursor = conn.cursor()
cursor.execute("SELECT DISTINCT thread_id FROM checkpoints")
threads = cursor.fetchall()
print("All threads:", threads)
```

---

## ğŸ¯ å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šå®¢æœæœºå™¨äºº

```python
class CustomerServiceState(MessagesState):
    summary: str
    customer_id: str
    issue_type: str
    resolved: bool

def call_support_agent(state: CustomerServiceState):
    # åŒ…å«å®¢æˆ·ä¿¡æ¯çš„ç³»ç»Ÿæ¶ˆæ¯
    system_msg = f"""
    Customer ID: {state['customer_id']}
    Issue Type: {state['issue_type']}
    Previous Summary: {state.get('summary', 'None')}
    """

    messages = [SystemMessage(system_msg)] + state["messages"]
    response = support_model.invoke(messages)

    return {"messages": response}

# ä½¿ç”¨
config = {"configurable": {"thread_id": f"customer_{customer_id}"}}
```

### æ¡ˆä¾‹ 2ï¼šå¤šè¯­è¨€èŠå¤©æœºå™¨äºº

```python
class MultilingualState(MessagesState):
    summary: str
    language: str  # ç”¨æˆ·è¯­è¨€

def detect_language(state: MultilingualState):
    # æ£€æµ‹ç”¨æˆ·è¯­è¨€
    last_message = state["messages"][-1].content
    detected_lang = detect_language_api(last_message)
    return {"language": detected_lang}

def call_model(state: MultilingualState):
    lang = state.get("language", "en")
    summary = state.get("summary", "")

    # ä½¿ç”¨ç”¨æˆ·è¯­è¨€çš„ç³»ç»Ÿæç¤º
    system_msg = f"Respond in {lang}. Summary: {summary}"
    messages = [SystemMessage(system_msg)] + state["messages"]

    response = model.invoke(messages)
    return {"messages": response}
```

### æ¡ˆä¾‹ 3ï¼šæ•™å­¦è¾…å¯¼æœºå™¨äºº

```python
class TutoringState(MessagesState):
    summary: str
    student_level: int  # 1-10
    topics_covered: list[str]
    mastery_scores: dict[str, float]

def adaptive_tutor(state: TutoringState):
    # æ ¹æ®å­¦ç”Ÿæ°´å¹³è°ƒæ•´éš¾åº¦
    level = state.get("student_level", 5)
    summary = state.get("summary", "")

    system_msg = f"""
    Student Level: {level}/10
    Topics Covered: {state.get('topics_covered', [])}
    Session Summary: {summary}

    Adjust explanation difficulty to match student level.
    """

    messages = [SystemMessage(system_msg)] + state["messages"]
    response = tutor_model.invoke(messages)

    return {"messages": response}
```

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [LangGraph Persistence å®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/concepts/persistence/)
- [SqliteSaver API æ–‡æ¡£](https://langchain-ai.github.io/langgraph/reference/checkpoints/#langgraph.checkpoint.sqlite.SqliteSaver)
- [PostgresSaver ä½¿ç”¨æŒ‡å—](https://langchain-ai.github.io/langgraph/how-tos/persistence_postgres/)
- [SQLite å®˜æ–¹æ–‡æ¡£](https://www.sqlite.org/docs.html)
- [Python sqlite3 æ¨¡å—æ–‡æ¡£](https://docs.python.org/3/library/sqlite3.html)

---

## ğŸ¬ æ€»ç»“

æœ¬æ•™ç¨‹æ·±å…¥è®²è§£äº† LangGraph ä¸­çš„**å¤–éƒ¨æ•°æ®åº“æŒä¹…åŒ–å­˜å‚¨**ï¼š

**æ ¸å¿ƒè¦ç‚¹ï¼š**
1. âœ… **Checkpointer** è´Ÿè´£çŠ¶æ€æŒä¹…åŒ–
2. âœ… **SqliteSaver** æä¾›è½»é‡çº§æ•°æ®åº“å­˜å‚¨
3. âœ… **Thread ID** éš”ç¦»ä¸åŒå¯¹è¯ä¼šè¯
4. âœ… **StateSnapshot** å¯ä»¥æŸ¥è¯¢å’Œæ¢å¤çŠ¶æ€
5. âœ… **RemoveMessage** å®ç°æ¶ˆæ¯ä¿®å‰ª
6. âœ… ç»“åˆæ‘˜è¦ä¼˜åŒ–é•¿å¯¹è¯å¤„ç†

**æŠ€æœ¯æ ˆï¼š**
- LangGraph: å›¾æ„å»ºå’ŒçŠ¶æ€ç®¡ç†
- SQLite: è½»é‡çº§æŒä¹…åŒ–å­˜å‚¨
- OpenAI: LLM æ¨ç†
- Pydantic: æ•°æ®éªŒè¯

**é€‚ç”¨åœºæ™¯ï¼š**
- éœ€è¦é•¿æœŸè®°å¿†çš„èŠå¤©æœºå™¨äºº
- å¤šç”¨æˆ·å¯¹è¯ç³»ç»Ÿ
- å®¢æœ/æ•™å­¦ç­‰åœºæ™¯
- éœ€è¦æ•°æ®åˆ†æçš„åº”ç”¨

æŒæ¡å¤–éƒ¨æ•°æ®åº“å­˜å‚¨æ˜¯æ„å»º**ç”Ÿäº§çº§ LangGraph åº”ç”¨**çš„å…³é”®æŠ€èƒ½ï¼
