# LangGraph Multiple Schemas è¯¦ç»†è§£è¯»

>  ç½‘ç«™ä½¿ç”¨è¯´æ˜
> - æœ¬ç½‘ç«™å¯ä»¥å…ç™»é™†è¿è¡Œ Python ä»£ç 
> - Python ä»£ç å¯ä»¥ç¼–è¾‘å¹¶ä¸´æ—¶ä¿å­˜ï¼Œä½†ä¸ä¼šæ°¸ä¹…ä¿å­˜ï¼Œç½‘é¡µåˆ·æ–°åä¼šè‡ªåŠ¨è¿˜åŸ
> - å¯¹ç½‘ç«™çš„ä½¿ç”¨æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥åˆ° [é—®é¢˜åé¦ˆ](http://localhost:5173/feedback.html) ï¼ˆæŒ‰é’®åœ¨æ¯ä¸ªé¡µé¢çš„å³ä¸‹è§’ï¼‰å…ç™»å½•è¿›è¡Œè¯„è®º
> - è¿è¡Œ `LangGraph/LangChain`ä»£ç ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥è‡ªå·±çš„ [API Key](http://localhost:5173/python-run.html)
> - é‡è¦å£°æ˜ï¼šæœ¬ç½‘ç«™ä¸ä¼šä¿å­˜ç”¨æˆ·çš„ API Key æ•°æ®ï¼Œè¯·æ”¾å¿ƒè¾“å…¥

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£è¯» LangGraph ä¸­çš„ **Multiple Schemasï¼ˆå¤šçŠ¶æ€æ¨¡å¼ï¼‰** æ¦‚å¿µã€‚è¿™æ˜¯ä¸€ç§é«˜çº§çŠ¶æ€ç®¡ç†æŠ€æœ¯ï¼Œå…è®¸æˆ‘ä»¬åœ¨å›¾çš„ä¸åŒéƒ¨åˆ†ä½¿ç”¨ä¸åŒçš„çŠ¶æ€ç»“æ„ï¼Œä»è€Œå®ç°æ›´çµæ´»ã€æ›´å®‰å…¨ã€æ›´æ¸…æ™°çš„çŠ¶æ€ç®¡ç†ã€‚

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **Multiple Schemas** | LangGraph å…è®¸åœ¨åŒä¸€ä¸ªå›¾ä¸­ä½¿ç”¨å¤šä¸ªä¸åŒçš„çŠ¶æ€ç»“æ„å®šä¹‰ | é€šè¿‡ç±»å‹æ³¨è§£æŒ‡å®šèŠ‚ç‚¹è¾“å…¥è¾“å‡ºç±»å‹ï¼Œå®ç°çŠ¶æ€çš„åˆ†å±‚å’Œéš”ç¦» | â­â­â­â­â­ |
| **Private State** | èŠ‚ç‚¹é—´ä¼ é€’ä½†ä¸å¯¹å¤–æš´éœ²çš„ç§æœ‰çŠ¶æ€æ•°æ® | é€šè¿‡ä¸åŒçš„ TypedDict å®šä¹‰ï¼Œå†…éƒ¨ä½¿ç”¨ä½†ä¸å‡ºç°åœ¨æœ€ç»ˆè¾“å‡ºä¸­ | â­â­â­â­â­ |
| **Input Schema** | é™å®šç”¨æˆ·è¾“å…¥å­—æ®µçš„çŠ¶æ€æ¨¡å¼ï¼Œæé«˜å®‰å…¨æ€§ | StateGraph å‚æ•° `input_schema` æŒ‡å®šï¼Œåªæ¥å—å®šä¹‰çš„å­—æ®µ | â­â­â­â­ |
| **Output Schema** | é™å®šè¿”å›ç»™ç”¨æˆ·å­—æ®µçš„çŠ¶æ€æ¨¡å¼ï¼Œè¿‡æ»¤å†…éƒ¨æ•°æ® | StateGraph å‚æ•° `output_schema` æŒ‡å®šï¼Œåªè¾“å‡ºå®šä¹‰çš„å­—æ®µ | â­â­â­â­ |
| **OverallState** | å›¾å†…éƒ¨ä½¿ç”¨çš„å®Œæ•´çŠ¶æ€ï¼ŒåŒ…å«æ‰€æœ‰å­—æ®µï¼ˆå…¬å¼€+ç§æœ‰ï¼‰ | TypedDict å®šä¹‰ï¼Œæ˜¯ InputState å’Œ OutputState çš„è¶…é›† | â­â­â­â­â­ |
| **çŠ¶æ€è¿‡æ»¤** | LangGraph æ ¹æ®ç±»å‹æ³¨è§£è‡ªåŠ¨è¿‡æ»¤èŠ‚ç‚¹çš„è¾“å…¥è¾“å‡ºçŠ¶æ€ | èŠ‚ç‚¹åªæ¥æ”¶å’Œè¿”å›å…¶ç±»å‹æ³¨è§£å£°æ˜çš„å­—æ®µï¼Œå…¶ä»–å­—æ®µè¢«è¿‡æ»¤ | â­â­â­â­â­ |
| **ç±»å‹æ³¨è§£** | Python å‡½æ•°ç­¾åä¸­çš„ç±»å‹æç¤ºï¼ŒLangGraph ç”¨äºç¡®å®šçŠ¶æ€å¯è§èŒƒå›´ | æ ¼å¼ `def node(state: InputType) -> OutputType`ï¼ŒæŒ‡å®šè¾“å…¥è¾“å‡ºç±»å‹ | â­â­â­â­â­ |
| **çŠ¶æ€åˆ†å±‚** | å°†çŠ¶æ€åˆ’åˆ†ä¸ºè¾“å…¥å±‚ã€å†…éƒ¨å±‚ã€è¾“å‡ºå±‚çš„è®¾è®¡æ¨¡å¼ | InputState âŠ† OverallState âŠ‡ OutputState çš„åŒ…å«å…³ç³» | â­â­â­â­ |
| **NotRequired** | TypedDict ä¸­æ ‡è®°å¯é€‰å­—æ®µçš„ç±»å‹æ³¨è§£ | Python typing æ¨¡å—ç±»å‹ï¼Œå¦‚ `optional: NotRequired[int]` | â­â­â­ |
| **çŠ¶æ€ç»§æ‰¿** | TypedDict å¯ä»¥ç»§æ‰¿å…¶ä»– TypedDict æ¥å¤ç”¨å­—æ®µå®šä¹‰ | `class ExtendedState(BaseState)` ç»§æ‰¿çˆ¶ç±»æ‰€æœ‰å­—æ®µå¹¶æ·»åŠ æ–°å­—æ®µ | â­â­â­ |

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ Multiple Schemasï¼Ÿ

åœ¨ä¹‹å‰çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨**å•ä¸€çŠ¶æ€æ¨¡å¼**ï¼šæ•´ä¸ªå›¾çš„æ‰€æœ‰èŠ‚ç‚¹å…±äº«åŒä¸€ä¸ªçŠ¶æ€ç»“æ„ï¼ˆSchemaï¼‰ã€‚ä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™ç§æ–¹å¼æœ‰æ—¶ä¼šå¸¦æ¥é—®é¢˜ï¼š

**å•ä¸€çŠ¶æ€çš„é—®é¢˜ï¼š**
1. **çŠ¶æ€æ±¡æŸ“**ï¼šå†…éƒ¨èŠ‚ç‚¹å¯èƒ½äº§ç”Ÿä¸­é—´æ•°æ®ï¼Œä½†è¿™äº›æ•°æ®ä¸åº”è¯¥æš´éœ²ç»™ç”¨æˆ·
2. **è¾“å…¥è¾“å‡ºä¸çµæ´»**ï¼šç”¨æˆ·å¯èƒ½åªéœ€è¦æä¾›éƒ¨åˆ†è¾“å…¥ï¼Œæˆ–åªéœ€è¦éƒ¨åˆ†è¾“å‡º
3. **èŠ‚ç‚¹è€¦åˆ**ï¼šæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¾èµ–åŒä¸€ä¸ªåºå¤§çš„çŠ¶æ€ç»“æ„ï¼Œå¢åŠ å¤æ‚åº¦

**Multiple Schemas çš„è§£å†³æ–¹æ¡ˆï¼š**
1. **Private Stateï¼ˆç§æœ‰çŠ¶æ€ï¼‰**ï¼šèŠ‚ç‚¹é—´å¯ä»¥ä¼ é€’ç§æœ‰æ•°æ®ï¼Œä¸æš´éœ²ç»™å¤–éƒ¨
2. **Input Schemaï¼ˆè¾“å…¥æ¨¡å¼ï¼‰**ï¼šé™å®šç”¨æˆ·è¾“å…¥çš„å­—æ®µ
3. **Output Schemaï¼ˆè¾“å‡ºæ¨¡å¼ï¼‰**ï¼šé™å®šè¿”å›ç»™ç”¨æˆ·çš„å­—æ®µ
4. **Internal Stateï¼ˆå†…éƒ¨çŠ¶æ€ï¼‰**ï¼šå›¾å†…éƒ¨ä½¿ç”¨çš„å®Œæ•´çŠ¶æ€

---

## ğŸ­ å®æˆ˜æ¡ˆä¾‹ 1ï¼šç§æœ‰çŠ¶æ€ï¼ˆPrivate Stateï¼‰

### éœ€æ±‚åœºæ™¯

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¡ç®—æµç¨‹ï¼š
1. `node_1` æ¥æ”¶ç”¨æˆ·è¾“å…¥ `foo`ï¼Œè®¡ç®—å‡ºä¸­é—´ç»“æœ `baz`
2. `node_2` ä½¿ç”¨ `baz` è¿›è¡Œè¿›ä¸€æ­¥è®¡ç®—ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœ `foo`
3. **å…³é”®**ï¼š`baz` æ˜¯ä¸­é—´è®¡ç®—å€¼ï¼Œä¸åº”è¯¥æš´éœ²ç»™ç”¨æˆ·

### ç³»ç»Ÿæ¶æ„å›¾

```
ç”¨æˆ·è¾“å…¥: {foo: 1}
      â†“
   [node_1]
   è¾“å…¥: OverallState {foo: 1}
   è®¡ç®—: baz = foo + 1 = 2
   è¾“å‡º: PrivateState {baz: 2}
      â†“
   [node_2]
   è¾“å…¥: PrivateState {baz: 2}
   è®¡ç®—: foo = baz + 1 = 3
   è¾“å‡º: OverallState {foo: 3}
      â†“
ç”¨æˆ·è¾“å‡º: {foo: 3}  â† baz è¢«éšè—äº†ï¼
```

---

## ğŸ”§ ä»£ç å®ç°è¯¦è§£ï¼šç§æœ‰çŠ¶æ€

### 1. å®šä¹‰çŠ¶æ€

```python
from typing_extensions import TypedDict

# å…¨å±€çŠ¶æ€ï¼ˆå¯¹å¤–å¯è§ï¼‰
class OverallState(TypedDict):
    foo: int

# ç§æœ‰çŠ¶æ€ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
class PrivateState(TypedDict):
    baz: int
```

**è®¾è®¡æ€è·¯ï¼š**
- `OverallState`ï¼šå›¾çš„è¾“å…¥å’Œè¾“å‡ºçŠ¶æ€ï¼Œç”¨æˆ·å¯è§
- `PrivateState`ï¼šå†…éƒ¨èŠ‚ç‚¹ä¹‹é—´ä¼ é€’çš„ç§æœ‰æ•°æ®
- ä¸¤è€…å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°

---

### 2. å®šä¹‰èŠ‚ç‚¹

```python
def node_1(state: OverallState) -> PrivateState:
    print("---Node 1---")
    return {"baz": state['foo'] + 1}

def node_2(state: PrivateState) -> OverallState:
    print("---Node 2---")
    return {"foo": state['baz'] + 1}
```

**å…³é”®ç‚¹è§£æï¼š**

#### node_1 çš„ç±»å‹ç­¾å
```python
def node_1(state: OverallState) -> PrivateState:
    #         ^^^^^^^^^^^^^^^^    ^^^^^^^^^^^^^^
    #         è¾“å…¥ç±»å‹              è¾“å‡ºç±»å‹
```

- **è¾“å…¥**ï¼š`OverallState` - ä»ç”¨æˆ·è¾“å…¥æˆ–å›¾çŠ¶æ€è¯»å– `foo`
- **è¾“å‡º**ï¼š`PrivateState` - è¿”å›ç§æœ‰å­—æ®µ `baz`
- **é‡è¦**ï¼šè™½ç„¶è¿”å›ç±»å‹æ˜¯ `PrivateState`ï¼Œä½†è¿”å›çš„æ•°æ®ä¼šè¢«åˆå¹¶åˆ°å›¾çš„æ€»ä½“çŠ¶æ€ä¸­

#### node_2 çš„ç±»å‹ç­¾å
```python
def node_2(state: PrivateState) -> OverallState:
    #         ^^^^^^^^^^^^^^^    ^^^^^^^^^^^^^^
    #         ä»ç§æœ‰çŠ¶æ€è¯»å–       å†™å›å…¨å±€çŠ¶æ€
```

- **è¾“å…¥**ï¼š`PrivateState` - è¯»å– `node_1` äº§ç”Ÿçš„ç§æœ‰å­—æ®µ `baz`
- **è¾“å‡º**ï¼š`OverallState` - æ›´æ–°å…¬å¼€å­—æ®µ `foo`

**Python çŸ¥è¯†ç‚¹ï¼šç±»å‹æ³¨è§£ï¼ˆType Hintsï¼‰**

Python çš„ç±»å‹æ³¨è§£ç”¨äºï¼š
1. **é™æ€ç±»å‹æ£€æŸ¥**ï¼šå¸®åŠ© IDE å’Œå·¥å…·æ£€æµ‹ç±»å‹é”™è¯¯
2. **æ–‡æ¡£ä½œç”¨**ï¼šæ¸…æ™°è¡¨è¾¾å‡½æ•°çš„è¾“å…¥è¾“å‡º
3. **LangGraph ä½¿ç”¨**ï¼šå‘Šè¯‰ LangGraph èŠ‚ç‚¹ä½¿ç”¨å“ªä¸ªçŠ¶æ€ç»“æ„

```python
# ç±»å‹æ³¨è§£è¯­æ³•
def function(param: InputType) -> OutputType:
    return value

# LangGraph ä¸­çš„ç‰¹æ®Šç”¨é€”
# LangGraph ä¼šæ ¹æ®ç±»å‹æ³¨è§£è‡ªåŠ¨è¿›è¡ŒçŠ¶æ€è¿‡æ»¤å’Œæ˜ å°„
def node(state: PrivateState) -> OverallState:
    # LangGraph è‡ªåŠ¨ï¼š
    # 1. ä»æ€»çŠ¶æ€ä¸­æå– PrivateState å­—æ®µä¼ ç»™ node
    # 2. å°† node è¿”å›çš„ OverallState å­—æ®µåˆå¹¶å›æ€»çŠ¶æ€
    pass
```

---

### 3. æ„å»ºå›¾

```python
from langgraph.graph import StateGraph, START, END

# ä½¿ç”¨ OverallState ä½œä¸ºå›¾çš„ä¸»çŠ¶æ€
builder = StateGraph(OverallState)

# æ·»åŠ èŠ‚ç‚¹
builder.add_node("node_1", node_1)
builder.add_node("node_2", node_2)

# æ·»åŠ è¾¹
builder.add_edge(START, "node_1")
builder.add_edge("node_1", "node_2")
builder.add_edge("node_2", END)

# ç¼–è¯‘
graph = builder.compile()
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šçŠ¶æ€å›¾åˆå§‹åŒ–**

```python
StateGraph(OverallState)
#          ^^^^^^^^^^^^^
#          å›¾çš„ä¸»çŠ¶æ€ç±»å‹
```

- å°½ç®¡èŠ‚ç‚¹å¯èƒ½ä½¿ç”¨ä¸åŒçš„çŠ¶æ€ç±»å‹ï¼ˆå¦‚ `PrivateState`ï¼‰ï¼Œä½†å›¾æœ¬èº«æœ‰ä¸€ä¸ªä¸»çŠ¶æ€ç±»å‹
- è¿™ä¸ªä¸»çŠ¶æ€ç±»å‹å®šä¹‰äº†å›¾çš„è¾“å…¥å’Œè¾“å‡ºæ¥å£
- èŠ‚ç‚¹çš„è¾“å…¥è¾“å‡ºç±»å‹å¯ä»¥æ˜¯ä¸»çŠ¶æ€çš„å­é›†æˆ–è¶…é›†

---

### 4. æ‰§è¡Œä¸è§‚å¯Ÿ

```python
result = graph.invoke({"foo": 1})
print(result)
# è¾“å‡º: {'foo': 3}
```

**æ‰§è¡Œæµç¨‹è¯¦è§£ï¼š**

| æ­¥éª¤ | å½“å‰çŠ¶æ€ | èŠ‚ç‚¹ | è¾“å…¥ | è¾“å‡º | çŠ¶æ€æ›´æ–°å |
|------|---------|------|------|------|-----------|
| 1 | `{foo: 1}` | node_1 | `{foo: 1}` | `{baz: 2}` | `{foo: 1, baz: 2}` |
| 2 | `{foo: 1, baz: 2}` | node_2 | `{baz: 2}` | `{foo: 3}` | `{foo: 3, baz: 2}` |
| 3 | æœ€ç»ˆè¾“å‡ºè¿‡æ»¤ | - | - | - | `{foo: 3}` â† `baz` è¢«è¿‡æ»¤æ‰ |

**å…³é”®è§‚å¯Ÿï¼š**
1. `baz` åœ¨å›¾çš„å†…éƒ¨çŠ¶æ€ä¸­å­˜åœ¨ï¼ˆæ­¥éª¤ 1-2ï¼‰
2. ä½†æœ€ç»ˆè¾“å‡ºæ—¶ï¼Œåªè¿”å› `OverallState` ä¸­å®šä¹‰çš„å­—æ®µï¼ˆ`foo`ï¼‰
3. `baz` æˆåŠŸéšè—ï¼Œå®ç°äº†ç§æœ‰çŠ¶æ€çš„æ•ˆæœ

---

## ğŸ­ å®æˆ˜æ¡ˆä¾‹ 2ï¼šè¾“å…¥/è¾“å‡ºæ¨¡å¼ï¼ˆInput/Output Schemaï¼‰

### éœ€æ±‚åœºæ™¯

æ„å»ºä¸€ä¸ªé—®ç­”ç³»ç»Ÿï¼š
1. **ç”¨æˆ·è¾“å…¥**ï¼šåªéœ€è¦æä¾› `question`
2. **å†…éƒ¨å¤„ç†**ï¼šç”Ÿæˆ `answer` å’Œ `notes`ï¼ˆå†…éƒ¨æ€è€ƒè¿‡ç¨‹ï¼‰
3. **ç”¨æˆ·è¾“å‡º**ï¼šåªè¿”å› `answer`ï¼Œéšè— `notes`

### ç³»ç»Ÿæ¶æ„å›¾

```
ç”¨æˆ·è¾“å…¥: {question: "hi"}  â† ç¬¦åˆ InputState
      â†“
   [thinking_node]
   ç”Ÿæˆ: answer="bye", notes="... his name is Lance"
      â†“
   [answer_node]
   ç”Ÿæˆ: answer="bye Lance"
      â†“
ç”¨æˆ·è¾“å‡º: {answer: "bye Lance"}  â† ç¬¦åˆ OutputStateï¼Œnotes è¢«éšè—
```

---

## ğŸ”§ ä»£ç å®ç°è¯¦è§£ï¼šè¾“å…¥/è¾“å‡ºæ¨¡å¼

### 1. å®šä¹‰ä¸‰ç§çŠ¶æ€

```python
from typing_extensions import TypedDict

# è¾“å…¥çŠ¶æ€ï¼šç”¨æˆ·å¿…é¡»æä¾›çš„å­—æ®µ
class InputState(TypedDict):
    question: str

# è¾“å‡ºçŠ¶æ€ï¼šè¿”å›ç»™ç”¨æˆ·çš„å­—æ®µ
class OutputState(TypedDict):
    answer: str

# å†…éƒ¨çŠ¶æ€ï¼šå›¾å†…éƒ¨ä½¿ç”¨çš„å®Œæ•´çŠ¶æ€
class OverallState(TypedDict):
    question: str
    answer: str
    notes: str
```

**è®¾è®¡æ¨¡å¼ï¼šçŠ¶æ€åˆ†å±‚**

```
InputState (æœ€å°è¾“å…¥)
    â†“ åŒ…å«äº
OverallState (å®Œæ•´å†…éƒ¨çŠ¶æ€)
    â†“ è¿‡æ»¤ä¸º
OutputState (æœ€å°è¾“å‡º)
```

**Python çŸ¥è¯†ç‚¹ï¼šTypedDict ç»§æ‰¿å…³ç³»**

è™½ç„¶è¿™é‡Œæ²¡æœ‰ä½¿ç”¨ç»§æ‰¿ï¼Œä½† TypedDict æ”¯æŒç»§æ‰¿ï¼š

```python
# æ–¹å¼ 1ï¼šç‹¬ç«‹å®šä¹‰ï¼ˆå¦‚ä¸Šé¢ä»£ç ï¼‰
class InputState(TypedDict):
    question: str

# æ–¹å¼ 2ï¼šç»§æ‰¿æ‰©å±•
class OverallState(InputState):  # ç»§æ‰¿ InputState
    answer: str
    notes: str

# ä¸¤ç§æ–¹å¼æ•ˆæœç±»ä¼¼ï¼Œä½†ç»§æ‰¿æ–¹å¼ç¡®ä¿å­—æ®µä¸€è‡´æ€§
```

---

### 2. å®šä¹‰èŠ‚ç‚¹ï¼ˆç‰ˆæœ¬ 1ï¼šä¸ä½¿ç”¨è¾“å…¥/è¾“å‡ºæ¨¡å¼ï¼‰

å…ˆçœ‹æ²¡æœ‰ Input/Output Schema çš„ç‰ˆæœ¬ï¼š

```python
class OverallState(TypedDict):
    question: str
    answer: str
    notes: str

def thinking_node(state: OverallState):
    return {"answer": "bye", "notes": "... his name is Lance"}

def answer_node(state: OverallState):
    return {"answer": "bye Lance"}

# æ„å»ºå›¾
graph = StateGraph(OverallState)
graph.add_node("answer_node", answer_node)
graph.add_node("thinking_node", thinking_node)
graph.add_edge(START, "thinking_node")
graph.add_edge("thinking_node", "answer_node")
graph.add_edge(answer_node, END)
graph = graph.compile()

# æ‰§è¡Œ
result = graph.invoke({"question": "hi"})
print(result)
# è¾“å‡º: {'question': 'hi', 'answer': 'bye Lance', 'notes': '... his name is Lance'}
```

**é—®é¢˜ï¼š** æ‰€æœ‰å†…éƒ¨å­—æ®µï¼ˆåŒ…æ‹¬ `notes`ï¼‰éƒ½æš´éœ²ç»™ç”¨æˆ·äº†ï¼

---

### 3. å®šä¹‰èŠ‚ç‚¹ï¼ˆç‰ˆæœ¬ 2ï¼šä½¿ç”¨è¾“å…¥/è¾“å‡ºæ¨¡å¼ï¼‰âœ…

```python
class InputState(TypedDict):
    question: str

class OutputState(TypedDict):
    answer: str

class OverallState(TypedDict):
    question: str
    answer: str
    notes: str

# èŠ‚ç‚¹ 1ï¼šåªéœ€è¦ InputState
def thinking_node(state: InputState):
    return {"answer": "bye", "notes": "... his name is Lance"}

# èŠ‚ç‚¹ 2ï¼šä½¿ç”¨ OverallStateï¼Œä½†å£°æ˜è¾“å‡ºä¸º OutputState
def answer_node(state: OverallState) -> OutputState:
    return {"answer": "bye Lance"}

# æ„å»ºå›¾ï¼šæŒ‡å®šè¾“å…¥å’Œè¾“å‡ºæ¨¡å¼
graph = StateGraph(
    OverallState,
    input_schema=InputState,    # é™å®šè¾“å…¥
    output_schema=OutputState   # é™å®šè¾“å‡º
)
graph.add_node("answer_node", answer_node)
graph.add_node("thinking_node", thinking_node)
graph.add_edge(START, "thinking_node")
graph.add_edge("thinking_node", "answer_node")
graph.add_edge(answer_node, END)
graph = graph.compile()

# æ‰§è¡Œ
result = graph.invoke({"question": "hi"})
print(result)
# è¾“å‡º: {'answer': 'bye Lance'}  â† notes è¢«è¿‡æ»¤æ‰äº†ï¼
```

**å…³é”®æ”¹è¿›ï¼š**
1. `StateGraph` æ„é€ æ—¶æŒ‡å®š `input_schema` å’Œ `output_schema`
2. `thinking_node` çš„è¾“å…¥ç±»å‹æ³¨è§£ä¸º `InputState`
3. `answer_node` çš„è¾“å‡ºç±»å‹æ³¨è§£ä¸º `OutputState`

---

### 4. ç±»å‹æ³¨è§£çš„ä½œç”¨

#### thinking_node çš„ç±»å‹æ³¨è§£
```python
def thinking_node(state: InputState):
    #                 ^^^^^^^^^^
    #                 åªèƒ½è®¿é—® question å­—æ®µ
    return {"answer": "bye", "notes": "... his name is Lance"}
```

**ä½œç”¨ï¼š**
- **è¾“å…¥è¿‡æ»¤**ï¼šLangGraph åªä¼ é€’ `InputState` ä¸­å®šä¹‰çš„å­—æ®µï¼ˆ`question`ï¼‰
- **å®‰å…¨æ€§**ï¼šèŠ‚ç‚¹æ— æ³•æ„å¤–è®¿é—®å…¶ä»–å­—æ®µ
- **æ¸…æ™°æ€§**ï¼šæ˜ç¡®è¡¨è¾¾èŠ‚ç‚¹çš„è¾“å…¥ä¾èµ–

#### answer_node çš„ç±»å‹æ³¨è§£
```python
def answer_node(state: OverallState) -> OutputState:
    #             ^^^^^^^^^^^^^      ^^^^^^^^^^^
    #             å¯ä»¥è®¿é—®æ‰€æœ‰å­—æ®µ    è¾“å‡ºä¼šè¢«è¿‡æ»¤
    return {"answer": "bye Lance"}
```

**ä½œç”¨ï¼š**
- **è¾“å…¥**ï¼šå¯ä»¥è®¿é—®å®Œæ•´çš„ `OverallState`ï¼ˆåŒ…æ‹¬ `notes`ï¼‰
- **è¾“å‡º**ï¼šè¿”å›å€¼ä¼šè¢«è¿‡æ»¤ï¼Œåªä¿ç•™ `OutputState` å®šä¹‰çš„å­—æ®µ

**æ³¨æ„**ï¼šå³ä½¿ `answer_node` è¿”å›äº† `notes`ï¼Œä¹Ÿä¼šè¢«è¿‡æ»¤æ‰ï¼š

```python
def answer_node(state: OverallState) -> OutputState:
    return {
        "answer": "bye Lance",
        "notes": "some internal note"  # è¿™ä¸ªä¼šè¢«è¿‡æ»¤æ‰
    }
```

---

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### LangGraph ç‰¹æœ‰æ¦‚å¿µ

#### 1. ç§æœ‰çŠ¶æ€ï¼ˆPrivate Stateï¼‰

**å®šä¹‰ï¼š** èŠ‚ç‚¹é—´ä¼ é€’ä½†ä¸å¯¹å¤–æš´éœ²çš„çŠ¶æ€

**å®ç°æ–¹å¼ï¼š**
```python
# å®šä¹‰ç§æœ‰çŠ¶æ€
class PrivateState(TypedDict):
    internal_data: str

# èŠ‚ç‚¹è¾“å‡ºç§æœ‰çŠ¶æ€
def node1(state: PublicState) -> PrivateState:
    return {"internal_data": "secret"}

# èŠ‚ç‚¹æ¶ˆè´¹ç§æœ‰çŠ¶æ€
def node2(state: PrivateState) -> PublicState:
    # ä½¿ç”¨ state["internal_data"]
    return {"result": "processed"}
```

**å…³é”®ç‚¹ï¼š**
- ç§æœ‰å­—æ®µä¸ä¼šå‡ºç°åœ¨å›¾çš„æœ€ç»ˆè¾“å‡ºä¸­
- åªåœ¨å›¾çš„å†…éƒ¨çŠ¶æ€ä¸­å­˜åœ¨
- é€šè¿‡ç±»å‹æ³¨è§£æ§åˆ¶å¯è§æ€§

#### 2. è¾“å…¥/è¾“å‡ºæ¨¡å¼ï¼ˆInput/Output Schemaï¼‰

**å®šä¹‰ï¼š** é™å®šå›¾çš„è¾“å…¥å’Œè¾“å‡ºæ¥å£

**å®ç°æ–¹å¼ï¼š**
```python
graph = StateGraph(
    InternalState,           # å›¾å†…éƒ¨çš„å®Œæ•´çŠ¶æ€
    input_schema=InputState,  # ç”¨æˆ·è¾“å…¥çš„çŠ¶æ€ç»“æ„
    output_schema=OutputState # è¿”å›ç»™ç”¨æˆ·çš„çŠ¶æ€ç»“æ„
)
```

**ä¸‰ç§çŠ¶æ€çš„å…³ç³»ï¼š**

| çŠ¶æ€ç±»å‹ | ç”¨é€” | å­—æ®µæ•°é‡ | ä½œç”¨åŸŸ |
|---------|------|---------|--------|
| InputState | ç”¨æˆ·è¾“å…¥ | æœ€å°‘ï¼ˆå¿…éœ€å­—æ®µï¼‰ | å›¾å…¥å£ |
| InternalState | å†…éƒ¨å¤„ç† | æœ€å¤šï¼ˆæ‰€æœ‰å­—æ®µï¼‰ | å›¾å†…éƒ¨ |
| OutputState | ç”¨æˆ·è¾“å‡º | é€‚ä¸­ï¼ˆæœ‰ç”¨å­—æ®µï¼‰ | å›¾å‡ºå£ |

**å…¸å‹æ¨¡å¼ï¼š**
```
InputState âŠ† InternalState âŠ‡ OutputState
```

#### 3. çŠ¶æ€è¿‡æ»¤æœºåˆ¶

LangGraph è‡ªåŠ¨è¿›è¡ŒçŠ¶æ€è¿‡æ»¤ï¼š

**è¾“å…¥è¿‡æ»¤ï¼š**
```python
# ç”¨æˆ·è°ƒç”¨
graph.invoke({"question": "hi", "extra": "ignored"})
#                                ^^^^^^^^^^^^^^^^
#                                ä¸åœ¨ InputState ä¸­ï¼Œè¢«å¿½ç•¥

# å¦‚æœ InputState åªå®šä¹‰äº† questionï¼Œ
# åˆ™åªæœ‰ question ä¼šè¢«ä¼ å…¥å›¾
```

**è¾“å‡ºè¿‡æ»¤ï¼š**
```python
# å›¾çš„å†…éƒ¨çŠ¶æ€
internal_state = {
    "question": "hi",
    "answer": "bye",
    "notes": "internal"
}

# è¿”å›ç»™ç”¨æˆ·ï¼ˆåªä¿ç•™ OutputState å®šä¹‰çš„å­—æ®µï¼‰
output = {"answer": "bye"}  # question å’Œ notes è¢«è¿‡æ»¤
```

#### 4. èŠ‚ç‚¹ç±»å‹æ³¨è§£çš„å®Œæ•´è¯­æ³•

```python
def node(state: InputType) -> OutputType:
    #        ^^^^^^^^^^^^^    ^^^^^^^^^^
    #        ä»å›¾çŠ¶æ€è¯»å–       å†™å›å›¾çŠ¶æ€
    #        (è¿‡æ»¤è¾“å…¥)        (è¿‡æ»¤è¾“å‡º)
    pass
```

**ç±»å‹æ³¨è§£ç»„åˆï¼š**

| è¾“å…¥ç±»å‹ | è¾“å‡ºç±»å‹ | å«ä¹‰ |
|---------|---------|------|
| `InputState` | `OutputState` | è¯»å–æœ€å°è¾“å…¥ï¼Œå†™å…¥ç‰¹å®šè¾“å‡º |
| `OverallState` | `PrivateState` | è¯»å–æ‰€æœ‰å­—æ®µï¼Œå†™å…¥ç§æœ‰å­—æ®µ |
| `PrivateState` | `OverallState` | è¯»å–ç§æœ‰å­—æ®µï¼Œå†™å…¥å…¬å¼€å­—æ®µ |
| `OverallState` | `OverallState` | è¯»å†™å®Œæ•´çŠ¶æ€ï¼ˆé»˜è®¤ï¼‰ |

---

### Python ç‰¹æœ‰çŸ¥è¯†ç‚¹

#### 1. TypedDict è¯¦è§£

**åŸºç¡€ç”¨æ³•ï¼š**
```python
from typing_extensions import TypedDict

class Person(TypedDict):
    name: str
    age: int

# ä½¿ç”¨
person: Person = {"name": "Alice", "age": 30}
```

**ç‰¹æ€§ï¼š**
- **ç±»å‹æ£€æŸ¥**ï¼šIDE ä¼šæç¤ºç±»å‹é”™è¯¯
- **å­—å…¸æœ¬è´¨**ï¼šä»ç„¶æ˜¯æ™®é€šå­—å…¸ï¼Œåªæ˜¯æ·»åŠ äº†ç±»å‹ä¿¡æ¯
- **è¿è¡Œæ—¶**ï¼šä¸ä¼šè¿›è¡Œä¸¥æ ¼éªŒè¯ï¼ˆä¸ Pydantic ä¸åŒï¼‰

**å¯é€‰å­—æ®µï¼š**
```python
from typing import NotRequired

class OptionalState(TypedDict):
    required: str
    optional: NotRequired[int]  # å¯é€‰å­—æ®µ

# åˆæ³•
state1: OptionalState = {"required": "value"}
state2: OptionalState = {"required": "value", "optional": 42}
```

#### 2. ç±»å‹æ³¨è§£ï¼ˆType Hintsï¼‰

**å‡½æ•°æ³¨è§£ï¼š**
```python
def greet(name: str) -> str:
    #         ^^^      ^^^
    #         å‚æ•°ç±»å‹  è¿”å›ç±»å‹
    return f"Hello, {name}"
```

**å˜é‡æ³¨è§£ï¼š**
```python
count: int = 0
names: list[str] = ["Alice", "Bob"]
data: dict[str, int] = {"a": 1, "b": 2}
```

**æ³›å‹æ³¨è§£ï¼š**
```python
from typing import List, Dict, Optional, Union

# æ—§å¼ï¼ˆPython 3.8ï¼‰
names: List[str] = ["Alice"]
mapping: Dict[str, int] = {"a": 1}
optional_value: Optional[int] = None  # int æˆ– None
union_value: Union[int, str] = 42     # int æˆ– str

# æ–°å¼ï¼ˆPython 3.9+ï¼‰
names: list[str] = ["Alice"]
mapping: dict[str, int] = {"a": 1}
optional_value: int | None = None
union_value: int | str = 42
```

#### 3. Annotated ç±»å‹

åœ¨ LangGraph ä¸­å¸¸è§çš„ `Annotated` ç”¨æ³•ï¼š

```python
from typing import Annotated
import operator

class State(TypedDict):
    # åŸºç¡€ç±»å‹
    name: str

    # å¸¦ reducer çš„ç±»å‹
    messages: Annotated[list, operator.add]
    #         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    #         ç±»å‹: list, åˆå¹¶ç­–ç•¥: operator.add
```

**Annotated çš„ç»“æ„ï¼š**
```python
Annotated[Type, metadata1, metadata2, ...]
#         ^^^^  ^^^^^^^^^^^^^^^^^^^^^^^^^
#         å®é™…ç±»å‹    å…ƒæ•°æ®ï¼ˆé™„åŠ ä¿¡æ¯ï¼‰
```

**LangGraph ä¸­çš„ç”¨é€”ï¼š**
- ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå®é™…çš„æ•°æ®ç±»å‹
- ç¬¬äºŒä¸ªå‚æ•°ï¼šReducer å‡½æ•°ï¼ˆå¦‚ä½•åˆå¹¶å¤šä¸ªæ›´æ–°ï¼‰

```python
# ä¾‹å­ï¼šåˆ—è¡¨è¿½åŠ 
messages: Annotated[list, operator.add]
# node1 è¿”å› {"messages": ["a"]}
# node2 è¿”å› {"messages": ["b"]}
# æœ€ç»ˆçŠ¶æ€: {"messages": ["a", "b"]}  â† operator.add è‡ªåŠ¨åˆå¹¶
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½•æ—¶ä½¿ç”¨ç§æœ‰çŠ¶æ€ï¼Ÿ

âœ… **é€‚ç”¨åœºæ™¯ï¼š**
- å†…éƒ¨è®¡ç®—çš„ä¸­é—´ç»“æœï¼ˆå¦‚ä¸´æ—¶å˜é‡ã€ç¼“å­˜ï¼‰
- è°ƒè¯•ä¿¡æ¯ï¼ˆå¦‚æ‰§è¡Œæ—¥å¿—ã€æ€§èƒ½æŒ‡æ ‡ï¼‰
- æ•æ„Ÿä¿¡æ¯ï¼ˆä¸å¸Œæœ›æš´éœ²ç»™æœ€ç»ˆç”¨æˆ·ï¼‰
- èŠ‚ç‚¹é—´çš„åè°ƒæ•°æ®ï¼ˆå¦‚è®¡æ•°å™¨ã€æ ‡å¿—ä½ï¼‰

âŒ **ä¸é€‚ç”¨åœºæ™¯ï¼š**
- ç”¨æˆ·éœ€è¦çš„æ ¸å¿ƒæ•°æ®
- éœ€è¦æŒä¹…åŒ–çš„ä¿¡æ¯
- éœ€è¦åœ¨å¤šä¸ªå…¬å¼€èŠ‚ç‚¹é—´å…±äº«çš„æ•°æ®

**ç¤ºä¾‹ï¼š**
```python
# âœ… å¥½çš„ç§æœ‰çŠ¶æ€ä½¿ç”¨
class PrivateState(TypedDict):
    processing_time: float      # æ€§èƒ½ç»Ÿè®¡
    api_call_count: int         # è°ƒè¯•ä¿¡æ¯
    intermediate_result: str    # ä¸­é—´è®¡ç®—

# âŒ ä¸åº”è¯¥ç§æœ‰çš„æ•°æ®
class PrivateState(TypedDict):
    user_id: str               # ç”¨æˆ·éœ€è¦çŸ¥é“çš„
    final_result: str          # æ ¸å¿ƒè¾“å‡ºæ•°æ®
```

### 2. ä½•æ—¶ä½¿ç”¨è¾“å…¥/è¾“å‡ºæ¨¡å¼ï¼Ÿ

âœ… **é€‚ç”¨åœºæ™¯ï¼š**
- API æœåŠ¡ï¼ˆéœ€è¦æ¸…æ™°çš„è¾“å…¥è¾“å‡ºæ¥å£ï¼‰
- å¤šç§Ÿæˆ·ç³»ç»Ÿï¼ˆä¸åŒç”¨æˆ·çœ‹åˆ°ä¸åŒå­—æ®µï¼‰
- å®‰å…¨æ•æ„Ÿåº”ç”¨ï¼ˆéšè—å†…éƒ¨å®ç°ç»†èŠ‚ï¼‰
- å¤§å‹é¡¹ç›®ï¼ˆå¼ºåˆ¶æ¥å£è§„èŒƒï¼‰

âŒ **ä¸é€‚ç”¨åœºæ™¯ï¼š**
- ç®€å•çš„å†…éƒ¨å·¥å…·
- åŸå‹å¼€å‘é˜¶æ®µ
- æ‰€æœ‰å­—æ®µéƒ½éœ€è¦è¾“å…¥è¾“å‡ºçš„æƒ…å†µ

**ç¤ºä¾‹ï¼š**
```python
# âœ… å¥½çš„è¾“å…¥/è¾“å‡ºè®¾è®¡
class InputState(TypedDict):
    user_query: str             # ç”¨æˆ·åªéœ€è¾“å…¥æŸ¥è¯¢

class OutputState(TypedDict):
    answer: str                 # ç”¨æˆ·åªéœ€è¦ç­”æ¡ˆ
    confidence: float           # å’Œç½®ä¿¡åº¦

class InternalState(TypedDict):
    user_query: str
    answer: str
    confidence: float
    api_calls: int              # å†…éƒ¨ç»Ÿè®¡
    cached: bool                # å†…éƒ¨æ ‡å¿—
    raw_response: dict          # åŸå§‹æ•°æ®
```

### 3. çŠ¶æ€è®¾è®¡åŸåˆ™

#### åŸåˆ™ 1ï¼šæœ€å°åŒ–åŸåˆ™

æ¯ä¸ªçŠ¶æ€åªåŒ…å«å¿…éœ€çš„å­—æ®µï¼š

```python
# âœ… å¥½çš„è®¾è®¡
class InputState(TypedDict):
    question: str               # åªè¦å¿…éœ€å­—æ®µ

# âŒ è¿‡åº¦è®¾è®¡
class InputState(TypedDict):
    question: str
    answer: str                 # è¾“å…¥ä¸éœ€è¦ answer
    notes: str                  # è¾“å…¥ä¸éœ€è¦ notes
    metadata: dict              # è¾“å…¥ä¸éœ€è¦ metadata
```

#### åŸåˆ™ 2ï¼šå•ä¸€èŒè´£

æ¯ä¸ªçŠ¶æ€æœåŠ¡äºç‰¹å®šç›®çš„ï¼š

```python
# âœ… å¥½çš„åˆ†ç¦»
class InputState(TypedDict):     # èŒè´£ï¼šæ¥æ”¶ç”¨æˆ·è¾“å…¥
    question: str

class ProcessingState(TypedDict): # èŒè´£ï¼šå†…éƒ¨å¤„ç†
    question: str
    intermediate: str

class OutputState(TypedDict):    # èŒè´£ï¼šè¿”å›ç»“æœ
    answer: str

# âŒ æ··æ·†èŒè´£
class MixedState(TypedDict):     # æ··åˆäº†æ‰€æœ‰èŒè´£
    question: str  # è¾“å…¥
    intermediate: str  # å¤„ç†
    answer: str  # è¾“å‡º
```

#### åŸåˆ™ 3ï¼šæ¸…æ™°çš„ç±»å‹æ³¨è§£

å§‹ç»ˆæ˜ç¡®æŒ‡å®šèŠ‚ç‚¹çš„è¾“å…¥è¾“å‡ºç±»å‹ï¼š

```python
# âœ… æ¸…æ™°çš„ç±»å‹æ³¨è§£
def process(state: InputState) -> OutputState:
    # ä¸€çœ¼å°±çŸ¥é“è¾“å…¥è¾“å‡º
    pass

# âŒ ä¸æ¸…æ™°çš„æ³¨è§£
def process(state):  # æ— æ³•çŸ¥é“ä½¿ç”¨å“ªä¸ªçŠ¶æ€
    pass
```

---

## ğŸš€ è¿›é˜¶æŠ€å·§

### 1. éƒ¨åˆ†çŠ¶æ€æ›´æ–°

èŠ‚ç‚¹å¯ä»¥åªæ›´æ–°çŠ¶æ€çš„éƒ¨åˆ†å­—æ®µï¼š

```python
class State(TypedDict):
    a: str
    b: str
    c: str

def node(state: State) -> State:
    # åªæ›´æ–° aï¼Œä¸å½±å“ b å’Œ c
    return {"a": "new_value"}

# æ‰§è¡Œå‰: {a: "old", b: "b", c: "c"}
# æ‰§è¡Œå: {a: "new_value", b: "b", c: "c"}
```

### 2. çŠ¶æ€éªŒè¯

ä½¿ç”¨ Pydantic è¿›è¡Œè¿è¡Œæ—¶éªŒè¯ï¼š

```python
from pydantic import BaseModel, validator

class ValidatedInput(BaseModel):
    question: str

    @validator('question')
    def question_not_empty(cls, v):
        if not v.strip():
            raise ValueError('Question cannot be empty')
        return v

# åœ¨èŠ‚ç‚¹ä¸­ä½¿ç”¨
def node(state):
    # éªŒè¯è¾“å…¥
    validated = ValidatedInput(**state)
    # ä½¿ç”¨ validated.question
```

### 3. åŠ¨æ€çŠ¶æ€é€‰æ‹©

æ ¹æ®æ¡ä»¶é€‰æ‹©ä¸åŒçš„çŠ¶æ€ç»“æ„ï¼š

```python
def conditional_node(state: OverallState):
    if state.get("use_detailed"):
        # è¿”å›è¯¦ç»†çŠ¶æ€
        return DetailedState(...)
    else:
        # è¿”å›ç®€å•çŠ¶æ€
        return SimpleState(...)
```

### 4. çŠ¶æ€ç»§æ‰¿

å¤ç”¨çŠ¶æ€å®šä¹‰ï¼š

```python
class BaseState(TypedDict):
    timestamp: float
    user_id: str

class ProcessingState(BaseState):  # ç»§æ‰¿ BaseState
    data: str
    status: str

# ProcessingState è‡ªåŠ¨åŒ…å« timestamp å’Œ user_id
```

---

## ğŸ“Š çŠ¶æ€æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | å•ä¸€çŠ¶æ€ | ç§æœ‰çŠ¶æ€ | è¾“å…¥/è¾“å‡ºæ¨¡å¼ |
|------|---------|---------|--------------|
| **å¤æ‚åº¦** | ä½ | ä¸­ | é«˜ |
| **çµæ´»æ€§** | ä½ | ä¸­ | é«˜ |
| **å°è£…æ€§** | å·® | å¥½ | æœ€å¥½ |
| **é€‚ç”¨åœºæ™¯** | ç®€å•å›¾ | å†…éƒ¨è®¡ç®— | APIã€æœåŠ¡ |
| **å­¦ä¹ æ›²çº¿** | å¹³ç¼“ | é€‚ä¸­ | é™¡å³­ |

**é€‰æ‹©å»ºè®®ï¼š**

```python
# ç®€å•åŸå‹ â†’ å•ä¸€çŠ¶æ€
graph = StateGraph(SimpleState)

# éœ€è¦éšè—ä¸­é—´æ•°æ® â†’ ç§æœ‰çŠ¶æ€
def node1(state: PublicState) -> PrivateState: ...
def node2(state: PrivateState) -> PublicState: ...

# å¯¹å¤–æœåŠ¡ â†’ è¾“å…¥/è¾“å‡ºæ¨¡å¼
graph = StateGraph(
    InternalState,
    input_schema=InputState,
    output_schema=OutputState
)
```

---

## ğŸ¯ å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šæ™ºèƒ½å®¢æœç³»ç»Ÿ

```python
# è¾“å…¥ï¼šç”¨æˆ·åªéœ€æä¾›é—®é¢˜
class InputState(TypedDict):
    user_question: str

# è¾“å‡ºï¼šè¿”å›ç­”æ¡ˆå’Œç½®ä¿¡åº¦
class OutputState(TypedDict):
    answer: str
    confidence: float

# å†…éƒ¨ï¼šåŒ…å«æ‰€æœ‰å¤„ç†ä¿¡æ¯
class InternalState(TypedDict):
    user_question: str
    answer: str
    confidence: float
    retrieved_docs: list        # æ£€ç´¢çš„æ–‡æ¡£ï¼ˆç§æœ‰ï¼‰
    api_response: dict          # API åŸå§‹å“åº”ï¼ˆç§æœ‰ï¼‰
    processing_time: float      # å¤„ç†æ—¶é—´ï¼ˆç§æœ‰ï¼‰

def retrieve_docs(state: InputState) -> InternalState:
    # æ£€ç´¢ç›¸å…³æ–‡æ¡£
    docs = vector_db.search(state["user_question"])
    return {"retrieved_docs": docs}

def generate_answer(state: InternalState) -> OutputState:
    # ç”Ÿæˆç­”æ¡ˆ
    response = llm.invoke({
        "question": state["user_question"],
        "context": state["retrieved_docs"]
    })
    return {
        "answer": response.answer,
        "confidence": response.confidence
    }

graph = StateGraph(
    InternalState,
    input_schema=InputState,
    output_schema=OutputState
)
```

### æ¡ˆä¾‹ 2ï¼šæ•°æ®å¤„ç†ç®¡é“

```python
# ç§æœ‰çŠ¶æ€ï¼šä¸­é—´å¤„ç†æ­¥éª¤
class PrivateState(TypedDict):
    cleaned_data: str
    validation_result: bool

# å…¬å¼€çŠ¶æ€ï¼šè¾“å…¥å’Œè¾“å‡º
class PublicState(TypedDict):
    raw_data: str
    processed_data: str

def clean_data(state: PublicState) -> PrivateState:
    cleaned = state["raw_data"].strip().lower()
    is_valid = len(cleaned) > 0
    return {
        "cleaned_data": cleaned,
        "validation_result": is_valid
    }

def process_data(state: PrivateState) -> PublicState:
    if state["validation_result"]:
        processed = state["cleaned_data"].upper()
        return {"processed_data": processed}
    else:
        return {"processed_data": "ERROR"}

# cleaned_data å’Œ validation_result ä¸ä¼šå‡ºç°åœ¨æœ€ç»ˆè¾“å‡º
```

### æ¡ˆä¾‹ 3ï¼šå¤šé˜¶æ®µè®¤è¯ç³»ç»Ÿ

```python
class LoginInput(TypedDict):
    username: str
    password: str

class SessionState(TypedDict):  # ç§æœ‰
    user_id: int
    permissions: list[str]
    session_token: str

class LoginOutput(TypedDict):
    success: bool
    session_id: str  # ä¸æš´éœ²å®Œæ•´ token

class InternalState(TypedDict):
    username: str
    password: str
    user_id: int
    permissions: list[str]
    session_token: str
    success: bool
    session_id: str

def authenticate(state: LoginInput) -> SessionState:
    # éªŒè¯ç”¨æˆ·å¹¶åˆ›å»ºä¼šè¯
    user = db.authenticate(state["username"], state["password"])
    return {
        "user_id": user.id,
        "permissions": user.permissions,
        "session_token": generate_token(user.id)
    }

def create_response(state: InternalState) -> LoginOutput:
    # åˆ›å»ºå®‰å…¨çš„å“åº”ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
    return {
        "success": True,
        "session_id": hash(state["session_token"])[:16]
    }

# session_token å’Œ user_id ä¸ä¼šæš´éœ²ç»™å®¢æˆ·ç«¯
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ç§æœ‰çŠ¶æ€çš„æ•°æ®ä¼šè¢«å®Œå…¨åˆ é™¤å—ï¼Ÿ

**ç­”ï¼š** ä¸ä¼šã€‚ç§æœ‰çŠ¶æ€çš„æ•°æ®åœ¨å›¾çš„å†…éƒ¨çŠ¶æ€ä¸­ä»ç„¶å­˜åœ¨ï¼Œåªæ˜¯åœ¨æœ€ç»ˆè¾“å‡ºæ—¶è¢«è¿‡æ»¤æ‰ã€‚

```python
# å†…éƒ¨çŠ¶æ€ï¼ˆæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼‰
internal = {
    "foo": 3,
    "baz": 2  # â† ä»ç„¶å­˜åœ¨
}

# è¾“å‡ºçŠ¶æ€ï¼ˆè¿”å›ç»™ç”¨æˆ·ï¼‰
output = {
    "foo": 3  # â† baz è¢«è¿‡æ»¤
}
```

**è®¿é—®å†…éƒ¨çŠ¶æ€ï¼š**
```python
# ä½¿ç”¨ stream æŸ¥çœ‹å®Œæ•´çŠ¶æ€
for state in graph.stream({"foo": 1}):
    print(state)  # å¯ä»¥çœ‹åˆ° baz

# ä½¿ç”¨ invoke åªèƒ½çœ‹åˆ°è¿‡æ»¤åçš„çŠ¶æ€
result = graph.invoke({"foo": 1})
print(result)  # çœ‹ä¸åˆ° baz
```

### Q2: èŠ‚ç‚¹çš„è¿”å›å€¼ä¼šè¦†ç›–è¿˜æ˜¯åˆå¹¶çŠ¶æ€ï¼Ÿ

**ç­”ï¼š** é»˜è®¤æ˜¯**åˆå¹¶**ï¼ˆmergeï¼‰ï¼Œä¸æ˜¯è¦†ç›–ï¼ˆreplaceï¼‰ã€‚

```python
# åˆå§‹çŠ¶æ€
state = {"a": 1, "b": 2, "c": 3}

# èŠ‚ç‚¹è¿”å›
def node(state):
    return {"a": 99}  # åªæ›´æ–° a

# æ‰§è¡Œåçš„çŠ¶æ€
state = {"a": 99, "b": 2, "c": 3}  # b å’Œ c ä¿æŒä¸å˜
```

**é™¤éä½¿ç”¨ Reducerï¼š**
```python
# ä½¿ç”¨è‡ªå®šä¹‰ reducer
class State(TypedDict):
    data: Annotated[list, my_custom_reducer]

# å¯ä»¥å®ç°è¦†ç›–ã€è¿½åŠ ã€åˆå¹¶ç­‰ä»»ä½•é€»è¾‘
```

### Q3: å¯ä»¥åœ¨ä¸åŒèŠ‚ç‚¹é—´åˆ‡æ¢çŠ¶æ€ç±»å‹å—ï¼Ÿ

**ç­”ï¼š** å¯ä»¥ï¼è¿™æ­£æ˜¯ Multiple Schemas çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

```python
def node1(state: StateA) -> StateB:
    # è¾“å…¥ StateAï¼Œè¾“å‡º StateB
    pass

def node2(state: StateB) -> StateC:
    # è¾“å…¥ StateBï¼Œè¾“å‡º StateC
    pass

def node3(state: StateC) -> StateA:
    # è¾“å…¥ StateCï¼Œè¾“å‡º StateAï¼ˆå›åˆ°èµ·ç‚¹ï¼‰
    pass
```

**é™åˆ¶ï¼š** æ‰€æœ‰çŠ¶æ€ç±»å‹çš„å­—æ®µå¿…é¡»èƒ½å¤Ÿåˆå¹¶åˆ°å›¾çš„ä¸»çŠ¶æ€ç±»å‹ä¸­ã€‚

### Q4: InputState å¯ä»¥åŒ…å« OverallState æ²¡æœ‰çš„å­—æ®µå—ï¼Ÿ

**ç­”ï¼š** ä¸å»ºè®®è¿™æ ·åšï¼Œå› ä¸ºè¿™äº›å­—æ®µæ— æ³•è¢«å­˜å‚¨åˆ°å›¾çŠ¶æ€ä¸­ã€‚

```python
# âŒ ä¸æ¨è
class InputState(TypedDict):
    question: str
    extra_field: str  # OverallState æ²¡æœ‰è¿™ä¸ªå­—æ®µ

class OverallState(TypedDict):
    question: str
    answer: str
    # ç¼ºå°‘ extra_field

# å½“ç”¨æˆ·è¾“å…¥ {"question": "hi", "extra_field": "value"}
# extra_field ä¼šè¢«å¿½ç•¥æˆ–å¯¼è‡´é”™è¯¯
```

**æ­£ç¡®åšæ³•ï¼š** InputState åº”è¯¥æ˜¯ OverallState çš„å­é›†ã€‚

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [LangGraph Private State å®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/how-tos/pass_private_state/)
- [LangGraph Input/Output Schema å®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/how-tos/input_output_schema/)
- [Python TypedDict æ–‡æ¡£](https://docs.python.org/3/library/typing.html#typing.TypedDict)
- [Python Type Hints PEP 484](https://peps.python.org/pep-0484/)

---

## ğŸ æ€»ç»“

**Multiple Schemasï¼ˆå¤šçŠ¶æ€æ¨¡å¼ï¼‰** æ˜¯ LangGraph ä¸­çš„é«˜çº§ç‰¹æ€§ï¼Œæä¾›äº†ä¸‰ç§å¼ºå¤§çš„èƒ½åŠ›ï¼š

1. **ç§æœ‰çŠ¶æ€ï¼ˆPrivate Stateï¼‰**
   - èŠ‚ç‚¹é—´ä¼ é€’ç§æœ‰æ•°æ®
   - éšè—å†…éƒ¨å®ç°ç»†èŠ‚
   - ä¿æŒè¾“å‡ºç®€æ´

2. **è¾“å…¥æ¨¡å¼ï¼ˆInput Schemaï¼‰**
   - é™å®šç”¨æˆ·è¾“å…¥
   - æé«˜å®‰å…¨æ€§
   - å¼ºåˆ¶æ¥å£è§„èŒƒ

3. **è¾“å‡ºæ¨¡å¼ï¼ˆOutput Schemaï¼‰**
   - è¿‡æ»¤è¾“å‡ºå­—æ®µ
   - ä¿æŠ¤æ•æ„Ÿä¿¡æ¯
   - æä¾›æ¸…æ™°çš„ API

**æ ¸å¿ƒä»·å€¼ï¼š**
- **æ›´å¥½çš„å°è£…**ï¼šéšè—å†…éƒ¨ç»†èŠ‚
- **æ›´æ¸…æ™°çš„æ¥å£**ï¼šæ˜ç¡®çš„è¾“å…¥è¾“å‡º
- **æ›´é«˜çš„å®‰å…¨æ€§**ï¼šé˜²æ­¢æ•°æ®æ³„éœ²
- **æ›´å¼ºçš„å¯ç»´æŠ¤æ€§**ï¼šä»£ç ç»“æ„æ¸…æ™°

æŒæ¡ Multiple Schemasï¼Œä½ å°±èƒ½æ„å»ºå‡ºæ›´åŠ ä¸“ä¸šã€å®‰å…¨ã€æ˜“ç”¨çš„ LangGraph åº”ç”¨ï¼
