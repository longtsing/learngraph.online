# LangGraph Router è¯¦ç»†è§£è¯»

>  ç½‘ç«™ä½¿ç”¨è¯´æ˜
> - æœ¬ç½‘ç«™å¯ä»¥å…ç™»é™†è¿è¡Œ Python ä»£ç 
> - Python ä»£ç å¯ä»¥ç¼–è¾‘å¹¶ä¸´æ—¶ä¿å­˜ï¼Œä½†ä¸ä¼šæ°¸ä¹…ä¿å­˜ï¼Œç½‘é¡µåˆ·æ–°åä¼šè‡ªåŠ¨è¿˜åŸ
> - å¯¹ç½‘ç«™çš„ä½¿ç”¨æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥åˆ° [é—®é¢˜åé¦ˆ](http://localhost:5173/feedback.html) ï¼ˆæŒ‰é’®åœ¨æ¯ä¸ªé¡µé¢çš„å³ä¸‹è§’ï¼‰å…ç™»å½•è¿›è¡Œè¯„è®º
> - è¿è¡Œ `LangGraph/LangChain`ä»£ç ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥è‡ªå·±çš„ [API Key](http://localhost:5173/python-run.html)
> - é‡è¦å£°æ˜ï¼šæœ¬ç½‘ç«™ä¸ä¼šä¿å­˜ç”¨æˆ·çš„ API Key æ•°æ®ï¼Œè¯·æ”¾å¿ƒè¾“å…¥


## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£è¯» LangGraph ä¸­çš„ **Routerï¼ˆè·¯ç”±å™¨ï¼‰** æ¨¡å¼ã€‚è¿™æ˜¯ Agent ç³»ç»Ÿçš„åŸºç¡€æ¦‚å¿µï¼Œé€šè¿‡ LLM æ™ºèƒ½å†³å®šæ‰§è¡Œè·¯å¾„ï¼šç›´æ¥å“åº”ç”¨æˆ·æˆ–è°ƒç”¨å·¥å…·ã€‚Router æ˜¯ç†è§£ LangGraph æ¡ä»¶è¾¹å’ŒåŠ¨æ€æ§åˆ¶æµçš„å…³é”®å…¥é—¨æ¡ˆä¾‹ã€‚

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **Router** | LLM ä½œä¸ºå†³ç­–ä¸­å¿ƒçš„è®¾è®¡æ¨¡å¼ï¼ŒåŠ¨æ€é€‰æ‹©æ‰§è¡Œè·¯å¾„ | å›¾ç»“æ„ä¸­ä½¿ç”¨æ¡ä»¶è¾¹å®ç°æ™ºèƒ½è·¯ç”±ï¼Œæ ¹æ® LLM è¾“å‡ºå†³å®šä¸‹ä¸€æ­¥ | â­â­â­â­â­ |
| **tools_condition** | LangGraph é¢„å®šä¹‰çš„æ¡ä»¶å‡½æ•°ï¼Œæ£€æµ‹æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…· | æ£€æŸ¥ AIMessage æ˜¯å¦åŒ…å« tool_calls å±æ€§ï¼Œè¿”å› "tools" æˆ– END | â­â­â­â­â­ |
| **ToolNode** | LangGraph é¢„æ„å»ºèŠ‚ç‚¹ï¼Œè‡ªåŠ¨æ‰§è¡Œå·¥å…·è°ƒç”¨ | è§£æ tool_callsï¼Œè°ƒç”¨å¯¹åº”å‡½æ•°ï¼Œè¿”å› ToolMessage | â­â­â­â­â­ |
| **bind_tools()** | å°†å·¥å…·ç»‘å®šåˆ° LLMï¼Œè®©æ¨¡å‹çŸ¥é“å¯ç”¨å·¥å…· | ChatModel æ–¹æ³•ï¼Œä¸æ‰§è¡Œå·¥å…·åªè¿”å›è°ƒç”¨æ„å›¾ | â­â­â­â­â­ |
| **tool_calls** | AI æ¶ˆæ¯ä¸­çš„å·¥å…·è°ƒç”¨è¯·æ±‚åˆ—è¡¨ | AIMessage å±æ€§ï¼ŒåŒ…å« nameã€argsã€id ç­‰ä¿¡æ¯ | â­â­â­â­â­ |
| **Conditional Edge** | æ ¹æ®çŠ¶æ€åŠ¨æ€è·¯ç”±åˆ°ä¸åŒèŠ‚ç‚¹çš„è¾¹ | add_conditional_edges æ–¹æ³•æ·»åŠ ï¼Œéœ€æä¾›æ¡ä»¶å‡½æ•° | â­â­â­â­â­ |
| **@tool è£…é¥°å™¨** | LangChain å·¥å…·è£…é¥°å™¨ï¼Œæ ‡è®°å‡½æ•°ä¸ºå·¥å…· | ç®€åŒ–å·¥å…·å®šä¹‰ï¼Œè‡ªåŠ¨å¤„ç†å‡½æ•°ç­¾åå’Œæ–‡æ¡£å­—ç¬¦ä¸² | â­â­â­â­ |
| **parallel_tool_calls** | æ§åˆ¶æ˜¯å¦å…è®¸å¹¶è¡Œè°ƒç”¨å¤šä¸ªå·¥å…·çš„å‚æ•° | bind_tools å‚æ•°ï¼ŒFalse æ—¶å¼ºåˆ¶é¡ºåºæ‰§è¡Œå·¥å…·è°ƒç”¨ | â­â­â­â­ |
| **Docstring** | å‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²ï¼ŒLLM ç†è§£å·¥å…·ç”¨é€”çš„å”¯ä¸€é€”å¾„ | Python å­—ç¬¦ä¸²ï¼Œæè¿°å‡½æ•°åŠŸèƒ½å’Œå‚æ•°ï¼Œå½±å“ LLM å·¥å…·é€‰æ‹©å‡†ç¡®æ€§ | â­â­â­â­â­ |
| **END** | LangGraph çš„ç‰¹æ®Šç»ˆæ­¢èŠ‚ç‚¹ | æ¡ä»¶å‡½æ•°å¯è¿”å› END æ¥ç»“æŸå›¾æ‰§è¡Œ | â­â­â­â­â­ |

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ Routerï¼Ÿ

Router æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œè®© LLM å……å½“"äº¤é€šæŒ‡æŒ¥å®˜"ï¼š

1. **æ¥æ”¶è¾“å…¥** - ç”¨æˆ·å‘é€æŸ¥è¯¢
2. **æ™ºèƒ½åˆ¤æ–­** - LLM åˆ†ææ˜¯å¦éœ€è¦å·¥å…·
3. **åŠ¨æ€è·¯ç”±** - è‡ªåŠ¨é€‰æ‹©æ‰§è¡Œè·¯å¾„ï¼š
   - **è·¯å¾„ A**ï¼šç›´æ¥å›ç­”ï¼ˆæ— éœ€å·¥å…·ï¼‰
   - **è·¯å¾„ B**ï¼šè°ƒç”¨å·¥å…·è·å–ä¿¡æ¯å†å›ç­”

### ä¸ºä»€ä¹ˆ Router é‡è¦ï¼Ÿ

è¿™æ˜¯ **Agent** çš„æœ¬è´¨ï¼š
- Agent â‰  ç®€å•çš„å‡½æ•°è°ƒç”¨
- Agent = LLM è‡ªä¸»å†³ç­– + åŠ¨æ€æ‰§è¡Œè·¯å¾„
- Router æ˜¯æœ€ç®€å•ä½†æœ€æ ¸å¿ƒçš„ Agent æ¨¡å¼

### ç»å…¸åº”ç”¨åœºæ™¯

- **æ™ºèƒ½å®¢æœ**ï¼šç®€å•é—®é¢˜ç›´æ¥å›ç­”ï¼Œå¤æ‚é—®é¢˜æŸ¥è¯¢æ•°æ®åº“
- **æ•°å­¦åŠ©æ‰‹**ï¼šæ–‡å­—é—®é¢˜ç›´æ¥ç­”ï¼Œè®¡ç®—é—®é¢˜è°ƒç”¨è®¡ç®—å™¨
- **ä¿¡æ¯æŸ¥è¯¢**ï¼šåŸºç¡€çŸ¥è¯†ç›´æ¥ç­”ï¼Œå®æ—¶ä¿¡æ¯è°ƒç”¨æœç´¢ API
- **å¤šåŠŸèƒ½ Bot**ï¼šæ ¹æ®æ„å›¾è‡ªåŠ¨é€‰æ‹©åŠŸèƒ½æ¨¡å—

---

## ğŸ­ å®æˆ˜æ¡ˆä¾‹ï¼šæ™ºèƒ½æ•°å­¦åŠ©æ‰‹

æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªä¼š"æ€è€ƒ"çš„æ•°å­¦åŠ©æ‰‹ï¼Œæ¼”ç¤º Router çš„å®Œæ•´æµç¨‹ï¼š

**éœ€æ±‚ï¼š**
1. ç”¨æˆ·é—®"ä½ å¥½" â†’ LLM ç›´æ¥å›ç­”ï¼Œæ— éœ€å·¥å…·
2. ç”¨æˆ·é—®"2 ä¹˜ä»¥ 3 æ˜¯å¤šå°‘ï¼Ÿ" â†’ LLM è°ƒç”¨ `multiply` å·¥å…·è®¡ç®—

### ç³»ç»Ÿæ¶æ„å›¾

```
ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
     â†“
[tool_calling_llm]  â† LLM åˆ†æå¹¶å†³ç­–
     â†“
  (æ¡ä»¶åˆ¤æ–­)
     â†“
    / \
   /   \
  â†“     â†“
ç›´æ¥å›ç­”  [tools] è°ƒç”¨å·¥å…·
  â†“     â†“
  END   END
```

**å…³é”®è®¾è®¡ï¼š**
- **ä¸€ä¸ªèŠ‚ç‚¹**ï¼š`tool_calling_llm`ï¼ˆç»‘å®šäº†å·¥å…·çš„ LLMï¼‰
- **ä¸€ä¸ªæ¡ä»¶è¾¹**ï¼š`tools_condition`ï¼ˆè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦å·¥å…·ï¼‰
- **ä¸€ä¸ªå·¥å…·èŠ‚ç‚¹**ï¼š`tools`ï¼ˆæ‰§è¡Œå®é™…è®¡ç®—ï¼‰

---

## ğŸ”§ ä»£ç å®ç°è¯¦è§£

### 1. ç¯å¢ƒå‡†å¤‡

```python
# å®‰è£…ä¾èµ–
%pip install --quiet -U langchain_openai langchain_core langgraph langgraph-prebuilt

# è®¾ç½® API Key
import os, getpass

def _set_env(var: str):
    if not os.environ.get(var):
        os.environ[var] = getpass.getpass(f"{var}: ")

_set_env("OPENAI_API_KEY")
```

**è¯´æ˜ï¼š**
- `langgraph-prebuilt`ï¼šåŒ…å« `ToolNode` å’Œ `tools_condition` ç­‰é¢„æ„å»ºç»„ä»¶
- `getpass`ï¼šå®‰å…¨åœ°è¾“å…¥æ•æ„Ÿä¿¡æ¯ï¼ˆAPI Key ä¸ä¼šæ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼‰

---

### 2. å®šä¹‰å·¥å…·å’Œ LLM

```python
from langchain_openai import ChatOpenAI

def multiply(a: int, b: int) -> int:
    """Multiply a and b.

    Args:
        a: first int
        b: second int
    """
    return a * b

llm = ChatOpenAI(model="gpt-5-nano")
llm_with_tools = llm.bind_tools([multiply])
```

#### Python çŸ¥è¯†ç‚¹ï¼šå‡½æ•°ä½œä¸ºå·¥å…·

åœ¨ LangChain ä¸­ï¼Œæ™®é€š Python å‡½æ•°å¯ä»¥ç›´æ¥è½¬æ¢ä¸º LLM å·¥å…·ï¼š

**å…³é”®è¦ç´ ï¼š**
1. **å‡½æ•°å**ï¼šLLM ç”¨æ¥è¯†åˆ«å·¥å…·ï¼ˆå¦‚ `multiply`ï¼‰
2. **Docstring**ï¼šLLM ç”¨æ¥ç†è§£å·¥å…·çš„ç”¨é€”ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
3. **ç±»å‹æç¤º**ï¼šLLM ç”¨æ¥ç†è§£å‚æ•°ç±»å‹ï¼ˆ`a: int, b: int`ï¼‰
4. **è¿”å›ç±»å‹**ï¼šLLM ç”¨æ¥ç†è§£è¾“å‡ºç±»å‹ï¼ˆ`-> int`ï¼‰

**ç¤ºä¾‹ï¼š**
```python
def multiply(a: int, b: int) -> int:
    """Multiply a and b."""  # â† LLM çœ‹åˆ°è¿™ä¸ªæè¿°
    return a * b

# LLM å†…éƒ¨ç†è§£ä¸ºï¼š
# {
#   "name": "multiply",
#   "description": "Multiply a and b.",
#   "parameters": {
#     "a": {"type": "integer"},
#     "b": {"type": "integer"}
#   }
# }
```

#### LangChain çŸ¥è¯†ç‚¹ï¼šbind_tools

```python
llm_with_tools = llm.bind_tools([multiply])
```

**ä½œç”¨ï¼š**
- å°†å·¥å…·"ç»‘å®š"åˆ° LLMï¼Œè®© LLM çŸ¥é“å¯ä»¥è°ƒç”¨è¿™äº›å·¥å…·
- LLM ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œå·¥å…·ï¼Œåªä¼šè¿”å›"æˆ‘æƒ³è°ƒç”¨è¿™ä¸ªå·¥å…·"çš„æŒ‡ä»¤
- å®é™…æ‰§è¡Œç”± `ToolNode` å®Œæˆ

**å·¥ä½œæµç¨‹ï¼š**
```
ç”¨æˆ·: "2 ä¹˜ä»¥ 3 æ˜¯å¤šå°‘ï¼Ÿ"
     â†“
llm_with_tools.invoke(...)
     â†“
LLM è¿”å›ï¼šAIMessage(tool_calls=[{
    "name": "multiply",
    "args": {"a": 2, "b": 3},
    "id": "call_123"
}])
     â†“
ToolNode æ‰§è¡Œ multiply(2, 3)
     â†“
è¿”å›ï¼šToolMessage(content="6", tool_call_id="call_123")
```

---

### 3. å®šä¹‰çŠ¶æ€

```python
from langgraph.graph import MessagesState

# MessagesState æ˜¯é¢„å®šä¹‰çš„çŠ¶æ€ç±»
# ç­‰ä»·äºï¼š
# class MessagesState(TypedDict):
#     messages: Annotated[list[BaseMessage], add_messages]
```

#### LangGraph çŸ¥è¯†ç‚¹ï¼šMessagesState

`MessagesState` æ˜¯ LangGraph æä¾›çš„æ ‡å‡†æ¶ˆæ¯çŠ¶æ€ï¼š

**ç‰¹æ€§ï¼š**
- `messages` å­—æ®µï¼šå­˜å‚¨å¯¹è¯å†å²
- è‡ªåŠ¨ä½¿ç”¨ `add_messages` reducerï¼šæ™ºèƒ½åˆå¹¶æ–°æ¶ˆæ¯

**add_messages çš„æ™ºèƒ½ä¹‹å¤„ï¼š**
```python
# åœºæ™¯ 1ï¼šè¿½åŠ æ–°æ¶ˆæ¯
state = {"messages": [HumanMessage("ä½ å¥½")]}
update = {"messages": [AIMessage("ä½ å¥½ï¼")]}
# ç»“æœï¼š[HumanMessage("ä½ å¥½"), AIMessage("ä½ å¥½ï¼")]

# åœºæ™¯ 2ï¼šæ›´æ–°ç°æœ‰æ¶ˆæ¯ï¼ˆé€šè¿‡ IDï¼‰
state = {"messages": [AIMessage("æ€è€ƒä¸­...", id="msg1")]}
update = {"messages": [AIMessage("2 * 3 = 6", id="msg1")]}
# ç»“æœï¼š[AIMessage("2 * 3 = 6", id="msg1")]  # æ›¿æ¢è€Œä¸æ˜¯è¿½åŠ 
```

---

### 4. æ„å»ºæ ¸å¿ƒèŠ‚ç‚¹

```python
def tool_calling_llm(state: MessagesState):
    return {"messages": [llm_with_tools.invoke(state["messages"])]}
```

**åŠŸèƒ½è¯¦è§£ï¼š**

1. **è¾“å…¥**ï¼š`state["messages"]` - å½“å‰å¯¹è¯å†å²
2. **å¤„ç†**ï¼š`llm_with_tools.invoke(...)` - LLM åˆ†æå¹¶å†³ç­–
3. **è¾“å‡º**ï¼š`{"messages": [...]}`  - è¿”å› LLM çš„å“åº”

**å¯èƒ½çš„è¾“å‡ºç±»å‹ï¼š**

**æƒ…å†µ Aï¼šç›´æ¥å›ç­”ï¼ˆæ— å·¥å…·è°ƒç”¨ï¼‰**
```python
AIMessage(content="ä½ å¥½ï¼æˆ‘èƒ½å¸®ä½ ä»€ä¹ˆï¼Ÿ")
```

**æƒ…å†µ Bï¼šè°ƒç”¨å·¥å…·**
```python
AIMessage(
    content="",  # å†…å®¹ä¸ºç©º
    tool_calls=[{
        "name": "multiply",
        "args": {"a": 2, "b": 3},
        "id": "call_abc123"
    }]
)
```

---

### 5. ä½¿ç”¨é¢„æ„å»ºç»„ä»¶ï¼šToolNode å’Œ tools_condition

```python
from langgraph.prebuilt import ToolNode, tools_condition

# åˆ›å»ºå·¥å…·èŠ‚ç‚¹
tool_node = ToolNode([multiply])

# tools_condition æ˜¯é¢„æ„å»ºçš„æ¡ä»¶å‡½æ•°
```

#### LangGraph çŸ¥è¯†ç‚¹ï¼šToolNode

**ToolNode çš„ä½œç”¨ï¼š**
- è‡ªåŠ¨æ‰§è¡Œ LLM è¯·æ±‚çš„å·¥å…·è°ƒç”¨
- æ¥æ”¶å¸¦æœ‰ `tool_calls` çš„ `AIMessage`
- è¿”å› `ToolMessage` åŒ…å«æ‰§è¡Œç»“æœ

**å†…éƒ¨å®ç°é€»è¾‘ï¼š**
```python
# ToolNode å†…éƒ¨ç±»ä¼¼è¿™æ ·ï¼š
def tool_node(state: MessagesState):
    results = []
    last_message = state["messages"][-1]

    for tool_call in last_message.tool_calls:
        # æ‰¾åˆ°å¯¹åº”çš„å·¥å…·å‡½æ•°
        tool = find_tool(tool_call["name"])  # å¦‚ multiply

        # æ‰§è¡Œå·¥å…·
        result = tool(**tool_call["args"])  # multiply(a=2, b=3)

        # åˆ›å»º ToolMessage
        results.append(ToolMessage(
            content=str(result),  # "6"
            tool_call_id=tool_call["id"]
        ))

    return {"messages": results}
```

#### LangGraph çŸ¥è¯†ç‚¹ï¼štools_condition

**tools_condition çš„ä½œç”¨ï¼š**
- è‡ªåŠ¨æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦åŒ…å« `tool_calls`
- å¦‚æœæœ‰å·¥å…·è°ƒç”¨ â†’ è·¯ç”±åˆ°å·¥å…·èŠ‚ç‚¹
- å¦‚æœæ— å·¥å…·è°ƒç”¨ â†’ è·¯ç”±åˆ° END

**å†…éƒ¨å®ç°é€»è¾‘ï¼š**
```python
# tools_condition å†…éƒ¨ç±»ä¼¼è¿™æ ·ï¼š
def tools_condition(state: MessagesState):
    last_message = state["messages"][-1]

    # æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
    if hasattr(last_message, "tool_calls") and last_message.tool_calls:
        return "tools"  # è·¯ç”±åˆ°å·¥å…·èŠ‚ç‚¹
    else:
        return END  # ç›´æ¥ç»“æŸ
```

---

### 6. æ„å»ºå›¾

```python
from langgraph.graph import StateGraph, START, END

# åˆ›å»ºå›¾
builder = StateGraph(MessagesState)

# æ·»åŠ èŠ‚ç‚¹
builder.add_node("tool_calling_llm", tool_calling_llm)
builder.add_node("tools", ToolNode([multiply]))

# æ·»åŠ è¾¹
builder.add_edge(START, "tool_calling_llm")

# æ·»åŠ æ¡ä»¶è¾¹
builder.add_conditional_edges(
    "tool_calling_llm",
    tools_condition,
)

builder.add_edge("tools", END)

# ç¼–è¯‘
graph = builder.compile()
```

#### LangGraph çŸ¥è¯†ç‚¹ï¼šæ¡ä»¶è¾¹è¯¦è§£

```python
builder.add_conditional_edges(
    "tool_calling_llm",  # æºèŠ‚ç‚¹
    tools_condition,      # æ¡ä»¶å‡½æ•°
)
```

**å·¥ä½œåŸç†ï¼š**

1. `tool_calling_llm` èŠ‚ç‚¹æ‰§è¡Œå®Œæ¯•
2. è°ƒç”¨ `tools_condition(state)` åˆ¤æ–­è·¯ç”±
3. `tools_condition` è¿”å›å€¼å†³å®šä¸‹ä¸€æ­¥ï¼š
   - è¿”å› `"tools"` â†’ è¿›å…¥ `tools` èŠ‚ç‚¹
   - è¿”å› `END` â†’ ç»“æŸæ‰§è¡Œ

**å®Œæ•´æ‰§è¡Œæµç¨‹ï¼š**

**åœºæ™¯ Aï¼šç®€å•é—®å€™**
```
ç”¨æˆ·: "ä½ å¥½"
  â†“
[tool_calling_llm] â†’ AIMessage(content="ä½ å¥½ï¼")
  â†“
tools_condition æ£€æµ‹ï¼šæ—  tool_calls
  â†“
è·¯ç”±åˆ° END
```

**åœºæ™¯ Bï¼šæ•°å­¦è®¡ç®—**
```
ç”¨æˆ·: "2 ä¹˜ä»¥ 3 æ˜¯å¤šå°‘ï¼Ÿ"
  â†“
[tool_calling_llm] â†’ AIMessage(tool_calls=[multiply(2,3)])
  â†“
tools_condition æ£€æµ‹ï¼šæœ‰ tool_calls
  â†“
è·¯ç”±åˆ° [tools]
  â†“
[tools] æ‰§è¡Œ multiply(2,3) â†’ ToolMessage(content="6")
  â†“
END
```

**å›¾ç»“æ„å¯è§†åŒ–ï¼š**
```
     START
       â†“
[tool_calling_llm]
       â†“
   (æ¡ä»¶åˆ¤æ–­)
      / \
     /   \
    â†“     â†“
  END   [tools]
         â†“
        END
```

---

### 7. æ‰§è¡Œå›¾

#### æµ‹è¯•åœºæ™¯ 1ï¼šå·¥å…·è°ƒç”¨

```python
from langchain_core.messages import HumanMessage

messages = [HumanMessage(content="Hello, what is 2 multiplied by 2?")]
result = graph.invoke({"messages": messages})

for m in result['messages']:
    m.pretty_print()
```

**è¾“å‡ºï¼š**
```
================================ Human Message =================================
Hello, what is 2 multiplied by 2?

================================== Ai Message ==================================
Tool Calls:
  multiply (call_abc123)
  Call ID: call_abc123
  Args:
    a: 2
    b: 2

================================= Tool Message =================================
Name: multiply
4
```

**æ‰§è¡Œæµç¨‹åˆ†æï¼š**
1. **HumanMessage** è¿›å…¥ç³»ç»Ÿ
2. **AIMessage** è¿”å›å·¥å…·è°ƒç”¨è¯·æ±‚
3. **ToolMessage** è¿”å›è®¡ç®—ç»“æœ `4`

#### æµ‹è¯•åœºæ™¯ 2ï¼šç›´æ¥å›ç­”

```python
messages = [HumanMessage(content="Hello world.")]
result = graph.invoke({"messages": messages})

for m in result['messages']:
    m.pretty_print()
```

**è¾“å‡ºï¼š**
```
================================ Human Message =================================
Hello world.

================================== Ai Message ==================================
Hello! How can I assist you today?
```

**æ‰§è¡Œæµç¨‹åˆ†æï¼š**
1. **HumanMessage** è¿›å…¥ç³»ç»Ÿ
2. **AIMessage** ç›´æ¥å›ç­”ï¼Œæ— å·¥å…·è°ƒç”¨
3. ç›´æ¥åˆ°è¾¾ END

---

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### LangGraph ç‰¹æœ‰æ¦‚å¿µ

#### 1. Router æ¨¡å¼

**å®šä¹‰ï¼š** LLM ä½œä¸ºå†³ç­–ä¸­å¿ƒï¼ŒåŠ¨æ€é€‰æ‹©æ‰§è¡Œè·¯å¾„

**å®ç°æ–¹å¼ï¼š**
- **èŠ‚ç‚¹**ï¼š`tool_calling_llm`ï¼ˆç»‘å®šå·¥å…·çš„ LLMï¼‰
- **æ¡ä»¶è¾¹**ï¼š`tools_condition`ï¼ˆè‡ªåŠ¨è·¯ç”±ï¼‰
- **å·¥å…·èŠ‚ç‚¹**ï¼š`ToolNode`ï¼ˆæ‰§è¡Œå·¥å…·ï¼‰

**å¯¹æ¯”ä¼ ç»Ÿæµç¨‹ï¼š**

| ç‰¹æ€§ | ä¼ ç»Ÿæµç¨‹ | Router æ¨¡å¼ |
|------|---------|------------|
| è·¯å¾„å†³ç­– | ç¡¬ç¼–ç è§„åˆ™ | LLM æ™ºèƒ½åˆ¤æ–­ |
| çµæ´»æ€§ | ä½ | é«˜ |
| å¯æ‰©å±•æ€§ | å·®ï¼ˆéœ€ä¿®æ”¹ä»£ç ï¼‰ | å¼ºï¼ˆå¢åŠ å·¥å…·å³å¯ï¼‰ |
| é€‚åº”æ€§ | å›ºå®šåœºæ™¯ | åŠ¨æ€é€‚åº” |

#### 2. æ¡ä»¶è¾¹ï¼ˆConditional Edgeï¼‰

```python
builder.add_conditional_edges(
    source_node,      # æºèŠ‚ç‚¹
    condition_func,   # æ¡ä»¶å‡½æ•°ï¼šstate â†’ ç›®æ ‡èŠ‚ç‚¹åç§°
)
```

**æ¡ä»¶å‡½æ•°çš„è¿”å›å€¼ï¼š**
- å­—ç¬¦ä¸²ï¼ˆå¦‚ `"tools"`ï¼‰ï¼šè·¯ç”±åˆ°æŒ‡å®šèŠ‚ç‚¹
- `END`ï¼šç»“æŸæ‰§è¡Œ
- åˆ—è¡¨ï¼ˆé«˜çº§ç”¨æ³•ï¼‰ï¼šå¤šä¸ªå¯èƒ½çš„ç›®æ ‡

**ç¤ºä¾‹ï¼šè‡ªå®šä¹‰æ¡ä»¶å‡½æ•°**
```python
def my_condition(state: MessagesState):
    last_msg = state["messages"][-1]

    if last_msg.content == "ç»“æŸ":
        return END
    elif "è®¡ç®—" in last_msg.content:
        return "calculator"
    else:
        return "chat"

builder.add_conditional_edges("start", my_condition)
```

#### 3. ToolNode

**ä½œç”¨ï¼š** è‡ªåŠ¨æ‰§è¡Œå·¥å…·å¹¶è¿”å›ç»“æœ

**å…³é”®ç‰¹æ€§ï¼š**
- æ¥æ”¶ `AIMessage` ä¸­çš„ `tool_calls`
- è‡ªåŠ¨åŒ¹é…å’Œæ‰§è¡Œå¯¹åº”å·¥å…·
- è¿”å› `ToolMessage` åŒ…å«ç»“æœ
- æ”¯æŒå¤šä¸ªå·¥å…·å¹¶å‘æ‰§è¡Œ

**æ‰‹åŠ¨å®ç° ToolNode çš„ç­‰ä»·ä»£ç ï¼š**
```python
def manual_tool_node(state: MessagesState):
    last_message = state["messages"][-1]
    tool_calls = last_message.tool_calls

    tool_messages = []
    for call in tool_calls:
        if call["name"] == "multiply":
            result = multiply(**call["args"])
            tool_messages.append(ToolMessage(
                content=str(result),
                tool_call_id=call["id"]
            ))

    return {"messages": tool_messages}
```

#### 4. tools_condition

**ä½œç”¨ï¼š** æ ‡å‡†åŒ–çš„å·¥å…·è°ƒç”¨æ£€æµ‹å‡½æ•°

**ç­‰ä»·å®ç°ï¼š**
```python
def tools_condition(state: MessagesState):
    last_msg = state["messages"][-1]
    if hasattr(last_msg, "tool_calls") and last_msg.tool_calls:
        return "tools"
    return END
```

**ä¸ºä»€ä¹ˆä½¿ç”¨é¢„æ„å»ºå‡½æ•°ï¼Ÿ**
- ç»è¿‡å……åˆ†æµ‹è¯•
- å¤„ç†è¾¹ç¼˜æƒ…å†µï¼ˆå¦‚ç©ºæ¶ˆæ¯ã€æ ¼å¼é”™è¯¯ç­‰ï¼‰
- ä¿æŒä»£ç ç®€æ´

---

### Python ç‰¹æœ‰çŸ¥è¯†ç‚¹

#### 1. ç±»å‹æç¤ºåœ¨å·¥å…·ä¸­çš„ä½œç”¨

```python
def multiply(a: int, b: int) -> int:
    """Multiply a and b."""
    return a * b
```

**ç±»å‹æç¤ºçš„é‡è¦æ€§ï¼š**
- LLM æ ¹æ®ç±»å‹æç¤ºç”Ÿæˆæ­£ç¡®çš„å‚æ•°
- è¿è¡Œæ—¶éªŒè¯ï¼ˆé…åˆ Pydanticï¼‰
- IDE ä»£ç è¡¥å…¨å’Œæ£€æŸ¥

**å¯¹æ¯”ï¼š**
```python
# âŒ ä¸å¥½çš„å®è·µ
def multiply(a, b):  # æ²¡æœ‰ç±»å‹æç¤º
    return a * b

# âœ… å¥½çš„å®è·µ
def multiply(a: int, b: int) -> int:
    """Multiply a and b."""
    return a * b
```

#### 2. Docstring çš„å…³é”®ä½œç”¨

**Docstring æ˜¯ LLM ç†è§£å·¥å…·çš„å”¯ä¸€é€”å¾„ï¼**

```python
def multiply(a: int, b: int) -> int:
    """Multiply a and b.

    Args:
        a: first int
        b: second int
    """
    return a * b
```

**LLM ä¼šè¯»å–ï¼š**
- **ç¬¬ä¸€è¡Œ**ï¼šå·¥å…·çš„ç®€çŸ­æè¿°ï¼ˆ"Multiply a and b."ï¼‰
- **Args éƒ¨åˆ†**ï¼šå‚æ•°çš„è¯¦ç»†è¯´æ˜

**ç¤ºä¾‹ï¼šå¥½çš„ vs ä¸å¥½çš„ Docstring**
```python
# âŒ ä¸å¥½
def process_data(x, y):
    """Process data."""  # å¤ªæ¨¡ç³Š
    return x + y

# âœ… å¥½
def calculate_total_price(unit_price: float, quantity: int) -> float:
    """Calculate the total price by multiplying unit price and quantity.

    Args:
        unit_price: Price per unit in USD
        quantity: Number of units to purchase

    Returns:
        Total price in USD
    """
    return unit_price * quantity
```

#### 3. getpass æ¨¡å—

```python
import getpass
os.environ["OPENAI_API_KEY"] = getpass.getpass("OPENAI_API_KEY: ")
```

**ä½œç”¨ï¼š**
- å®‰å…¨åœ°è¾“å…¥æ•æ„Ÿä¿¡æ¯
- è¾“å…¥æ—¶ä¸ä¼šæ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼ˆç±»ä¼¼è¾“å…¥å¯†ç ï¼‰
- é˜²æ­¢ API Key è¢«æ„å¤–æ³„éœ²

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. è®¾è®¡è‰¯å¥½çš„å·¥å…·

#### åŸåˆ™ 1ï¼šå•ä¸€èŒè´£

```python
# âœ… å¥½çš„è®¾è®¡ - æ¯ä¸ªå·¥å…·åªåšä¸€ä»¶äº‹
def multiply(a: int, b: int) -> int:
    """Multiply two numbers."""
    return a * b

def add(a: int, b: int) -> int:
    """Add two numbers."""
    return a + b

# âŒ ä¸å¥½çš„è®¾è®¡ - ä¸€ä¸ªå·¥å…·åšå¤šä»¶äº‹
def calculate(operation: str, a: int, b: int) -> int:
    """Perform various calculations."""
    if operation == "multiply":
        return a * b
    elif operation == "add":
        return a + b
```

**ä¸ºä»€ä¹ˆï¼Ÿ** LLM æ›´å®¹æ˜“ç†è§£å’Œé€‰æ‹©ä¸“æ³¨çš„å·¥å…·ã€‚

#### åŸåˆ™ 2ï¼šæ¸…æ™°çš„å‘½åå’Œæ–‡æ¡£

```python
# âœ… å¥½
def get_current_weather(location: str, unit: str = "celsius") -> dict:
    """Get the current weather for a specific location.

    Args:
        location: City name or zip code
        unit: Temperature unit ('celsius' or 'fahrenheit')

    Returns:
        Dictionary with temperature, humidity, and conditions
    """
    pass

# âŒ ä¸å¥½
def get_data(loc: str, u: str = "c") -> dict:
    """Get data."""
    pass
```

#### åŸåˆ™ 3ï¼šè¿”å›ç»“æ„åŒ–æ•°æ®

```python
# âœ… å¥½ - è¿”å›ç»“æ„åŒ–æ•°æ®
def multiply(a: int, b: int) -> int:
    return a * b  # è¿”å›æ•°å­—

# æˆ–è€…
def get_user_info(user_id: str) -> dict:
    return {
        "name": "Alice",
        "age": 30,
        "email": "alice@example.com"
    }

# âŒ ä¸å¥½ - è¿”å›éç»“æ„åŒ–å­—ç¬¦ä¸²
def get_user_info(user_id: str) -> str:
    return "Name: Alice, Age: 30, Email: alice@example.com"
```

### 2. æ¡ä»¶è¾¹çš„è®¾è®¡æŠ€å·§

#### æŠ€å·§ 1ï¼šæ¸…æ™°çš„æ¡ä»¶é€»è¾‘

```python
# âœ… å¥½ - é€»è¾‘æ¸…æ™°
def route_decision(state: MessagesState):
    last_msg = state["messages"][-1]

    # æ˜ç¡®çš„æ¡ä»¶æ£€æŸ¥
    if hasattr(last_msg, "tool_calls") and last_msg.tool_calls:
        return "tools"
    return END

# âŒ ä¸å¥½ - é€»è¾‘å¤æ‚
def route_decision(state: MessagesState):
    return "tools" if state["messages"][-1].tool_calls if hasattr(state["messages"][-1], "tool_calls") else False else END
```

#### æŠ€å·§ 2ï¼šå¤„ç†è¾¹ç¼˜æƒ…å†µ

```python
def safe_route_decision(state: MessagesState):
    # æ£€æŸ¥æ¶ˆæ¯åˆ—è¡¨æ˜¯å¦ä¸ºç©º
    if not state["messages"]:
        return END

    last_msg = state["messages"][-1]

    # æ£€æŸ¥æ˜¯å¦ä¸º AI æ¶ˆæ¯
    if not isinstance(last_msg, AIMessage):
        return END

    # æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
    if hasattr(last_msg, "tool_calls") and last_msg.tool_calls:
        return "tools"

    return END
```

### 3. çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ

#### å®è·µ 1ï¼šä¿æŒæ¶ˆæ¯å†å²å®Œæ•´

```python
# âœ… å¥½ - ä¿ç•™å®Œæ•´å¯¹è¯å†å²
def tool_calling_llm(state: MessagesState):
    # ä¼ é€’æ‰€æœ‰å†å²æ¶ˆæ¯
    return {"messages": [llm_with_tools.invoke(state["messages"])]}

# âŒ ä¸å¥½ - åªä½¿ç”¨æœ€åä¸€æ¡æ¶ˆæ¯
def tool_calling_llm(state: MessagesState):
    # ä¸¢å¤±äº†ä¸Šä¸‹æ–‡
    return {"messages": [llm_with_tools.invoke([state["messages"][-1]])]}
```

**ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ** LLM éœ€è¦å®Œæ•´ä¸Šä¸‹æ–‡æ‰èƒ½åšå‡ºæ­£ç¡®å†³ç­–ã€‚

#### å®è·µ 2ï¼šæ­£ç¡®è¿”å›æ¶ˆæ¯åˆ—è¡¨

```python
# âœ… æ­£ç¡® - è¿”å›åˆ—è¡¨
def my_node(state: MessagesState):
    response = llm.invoke(...)
    return {"messages": [response]}  # æ³¨æ„æ˜¯åˆ—è¡¨

# âŒ é”™è¯¯ - è¿”å›å•ä¸ªæ¶ˆæ¯
def my_node(state: MessagesState):
    response = llm.invoke(...)
    return {"messages": response}  # ä¼šå‡ºé”™
```

---

## ğŸš€ è¿›é˜¶æŠ€å·§

### 1. å¤šå·¥å…· Router

æ‰©å±•åˆ°å¤šä¸ªå·¥å…·ï¼š

```python
def add(a: int, b: int) -> int:
    """Add two numbers."""
    return a + b

def multiply(a: int, b: int) -> int:
    """Multiply two numbers."""
    return a * b

def divide(a: float, b: float) -> float:
    """Divide a by b."""
    if b == 0:
        raise ValueError("Cannot divide by zero")
    return a / b

# ç»‘å®šå¤šä¸ªå·¥å…·
llm_with_tools = llm.bind_tools([add, multiply, divide])

# ToolNode è‡ªåŠ¨å¤„ç†æ‰€æœ‰å·¥å…·
tool_node = ToolNode([add, multiply, divide])
```

**LLM è‡ªåŠ¨é€‰æ‹©æ­£ç¡®å·¥å…·ï¼š**
- "2 åŠ  3" â†’ è°ƒç”¨ `add`
- "4 ä¹˜ä»¥ 5" â†’ è°ƒç”¨ `multiply`
- "10 é™¤ä»¥ 2" â†’ è°ƒç”¨ `divide`

### 2. å·¥å…·é“¾å¼è°ƒç”¨

LLM å¯ä»¥è¿ç»­è°ƒç”¨å¤šä¸ªå·¥å…·ï¼š

```python
# ç”¨æˆ·ï¼š"å…ˆè®¡ç®— 2*3ï¼Œç„¶åæŠŠç»“æœåŠ  5"

# ç¬¬ä¸€è½®
# LLM â†’ multiply(2, 3)
# Tool â†’ 6

# ç¬¬äºŒè½®ï¼ˆLLM çœ‹åˆ°ç»“æœ 6ï¼‰
# LLM â†’ add(6, 5)
# Tool â†’ 11

# ç¬¬ä¸‰è½®ï¼ˆLLM çœ‹åˆ°ç»“æœ 11ï¼‰
# LLM â†’ "ç»“æœæ˜¯ 11"
```

**å®ç°æ–¹å¼ï¼š** æ·»åŠ å¾ªç¯è¾¹

```python
# ä¿®æ”¹å›¾ç»“æ„
builder.add_edge("tools", "tool_calling_llm")  # å·¥å…·æ‰§è¡Œåå›åˆ° LLM

# ç°åœ¨æµç¨‹å˜æˆï¼š
# START â†’ tool_calling_llm â†’ tools â†’ tool_calling_llm â†’ tools â†’ ... â†’ END
```

### 3. å¸¦é”™è¯¯å¤„ç†çš„ Router

```python
class SafeToolNode:
    def __init__(self, tools):
        self.tool_node = ToolNode(tools)

    def __call__(self, state: MessagesState):
        try:
            return self.tool_node(state)
        except Exception as e:
            # è¿”å›é”™è¯¯æ¶ˆæ¯
            return {"messages": [ToolMessage(
                content=f"Error executing tool: {str(e)}",
                tool_call_id=state["messages"][-1].tool_calls[0]["id"]
            )]}

# ä½¿ç”¨
builder.add_node("tools", SafeToolNode([multiply]))
```

### 4. è‡ªå®šä¹‰å·¥å…·æ‰§è¡Œé€»è¾‘

```python
def custom_tool_node(state: MessagesState):
    last_message = state["messages"][-1]
    tool_calls = last_message.tool_calls

    results = []
    for call in tool_calls:
        # è®°å½•å·¥å…·è°ƒç”¨
        print(f"Calling tool: {call['name']} with args: {call['args']}")

        # æ‰§è¡Œå·¥å…·
        if call["name"] == "multiply":
            result = multiply(**call["args"])

        # æ·»åŠ é¢å¤–ä¿¡æ¯
        results.append(ToolMessage(
            content=f"Result: {result} (computed at {datetime.now()})",
            tool_call_id=call["id"]
        ))

    return {"messages": results}
```

---

## ğŸ“Š Router æ¨¡å¼å¯¹æ¯”

### Router vs ç®€å• LLM è°ƒç”¨

| ç‰¹æ€§ | ç®€å• LLM è°ƒç”¨ | Router æ¨¡å¼ |
|------|--------------|------------|
| å·¥å…·æ”¯æŒ | æ—  | æœ‰ |
| åŠ¨æ€å†³ç­– | æ—  | æœ‰ |
| å¯æ‰©å±•æ€§ | ä½ | é«˜ |
| å¤æ‚åº¦ | ä½ | ä¸­ |
| é€‚ç”¨åœºæ™¯ | çº¯å¯¹è¯ | éœ€è¦å·¥å…·çš„åœºæ™¯ |

### Router vs ReAct Agent

| ç‰¹æ€§ | Router | ReAct Agent |
|------|--------|-------------|
| å¾ªç¯æ‰§è¡Œ | æ— ï¼ˆå•æ¬¡ï¼‰ | æœ‰ï¼ˆå¤šè½®æ¨ç†ï¼‰ |
| å¤æ‚åº¦ | ç®€å• | å¤æ‚ |
| é€‚ç”¨ä»»åŠ¡ | å•æ­¥å·¥å…·è°ƒç”¨ | å¤šæ­¥æ¨ç†ä»»åŠ¡ |
| çŠ¶æ€ç®¡ç† | ç®€å• | å¤æ‚ |

**Router æ˜¯ ReAct çš„åŸºç¡€ï¼š**
- ReAct = Router + å¾ªç¯ + æ¨ç†çŠ¶æ€

---

## ğŸ¯ å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šæ™ºèƒ½å®¢æœ

```python
def search_knowledge_base(query: str) -> str:
    """Search internal knowledge base for answers."""
    # å®ç°çŸ¥è¯†åº“æœç´¢
    pass

def create_ticket(issue: str, priority: str) -> str:
    """Create a support ticket."""
    # å®ç°å·¥å•åˆ›å»º
    pass

llm_with_tools = llm.bind_tools([search_knowledge_base, create_ticket])

# ç”¨æˆ·é—®é¢˜ï¼š
# "å¦‚ä½•é‡ç½®å¯†ç ï¼Ÿ" â†’ search_knowledge_base
# "æˆ‘çš„è´¦å·è¢«é”å®šäº†ï¼Œè¯·å¸®æˆ‘å¤„ç†" â†’ create_ticket
# "ä½ å¥½" â†’ ç›´æ¥å›ç­”
```

### æ¡ˆä¾‹ 2ï¼šæ•°æ®åˆ†æåŠ©æ‰‹

```python
def query_database(sql: str) -> list:
    """Execute SQL query on the database."""
    pass

def generate_chart(data: list, chart_type: str) -> str:
    """Generate a chart from data."""
    pass

def calculate_statistics(data: list) -> dict:
    """Calculate basic statistics."""
    pass

llm_with_tools = llm.bind_tools([query_database, generate_chart, calculate_statistics])

# ç”¨æˆ·è¯·æ±‚ï¼š
# "æŸ¥è¯¢ä¸Šä¸ªæœˆçš„é”€å”®æ•°æ®" â†’ query_database
# "ç”¨è¿™äº›æ•°æ®ç”ŸæˆæŸ±çŠ¶å›¾" â†’ generate_chart
# "è®¡ç®—å¹³å‡å€¼å’Œæ ‡å‡†å·®" â†’ calculate_statistics
```

### æ¡ˆä¾‹ 3ï¼šå¤šè¯­è¨€ç¿»è¯‘å·¥å…·

```python
def translate_text(text: str, target_language: str) -> str:
    """Translate text to target language."""
    pass

def detect_language(text: str) -> str:
    """Detect the language of the text."""
    pass

llm_with_tools = llm.bind_tools([translate_text, detect_language])

# ç”¨æˆ·è¾“å…¥ï¼š
# "Translate 'hello' to Chinese" â†’ translate_text
# "What language is 'Bonjour'?" â†’ detect_language
# "How do I say goodbye in Spanish?" â†’ ç›´æ¥å›ç­”ï¼ˆLLM çŸ¥è¯†ï¼‰
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ bind_tools è€Œä¸æ˜¯ç›´æ¥è°ƒç”¨å‡½æ•°ï¼Ÿ

**ç­”ï¼š** `bind_tools` è®© LLM çŸ¥é“å¯ç”¨çš„å·¥å…·ï¼Œä½†ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š

```python
# é”™è¯¯ç†è§£ âŒ
llm_with_tools.invoke(...)  # LLM ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œ multiply

# æ­£ç¡®ç†è§£ âœ…
llm_with_tools.invoke(...)  # LLM è¿”å›"æˆ‘æƒ³è°ƒç”¨ multiply"
# ç„¶åç”± ToolNode å®é™…æ‰§è¡Œ
```

**è¿™æ ·è®¾è®¡çš„å¥½å¤„ï¼š**
- LLM è´Ÿè´£å†³ç­–ï¼ˆè°ƒç”¨å“ªä¸ªå·¥å…·ã€ä¼ ä»€ä¹ˆå‚æ•°ï¼‰
- ç³»ç»Ÿè´Ÿè´£æ‰§è¡Œï¼ˆå®‰å…¨ã€å¯æ§ï¼‰
- æ¸…æ™°çš„è´£ä»»åˆ†ç¦»

### Q2: tools_condition å¦‚ä½•çŸ¥é“è·¯ç”±åˆ°å“ªé‡Œï¼Ÿ

**ç­”ï¼š** å®ƒæ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯ï¼š

```python
def tools_condition(state):
    last_msg = state["messages"][-1]

    # å¦‚æœæœ‰ tool_calls å±æ€§ä¸”ä¸ä¸ºç©º
    if hasattr(last_msg, "tool_calls") and last_msg.tool_calls:
        return "tools"  # å­—ç¬¦ä¸² "tools" åŒ¹é…èŠ‚ç‚¹åç§°

    return END
```

**å…³é”®ç‚¹ï¼š**
- è¿”å›å€¼ `"tools"` å¿…é¡»åŒ¹é…æŸä¸ªå·²æ·»åŠ çš„èŠ‚ç‚¹åç§°
- å¦‚æœè¿”å›ä¸å­˜åœ¨çš„èŠ‚ç‚¹åï¼Œä¼šæŠ¥é”™

### Q3: å¦‚æœ LLM è°ƒç”¨äº†ä¸å­˜åœ¨çš„å·¥å…·ä¼šæ€æ ·ï¼Ÿ

**ç­”ï¼š** ToolNode ä¼šæŠ›å‡ºé”™è¯¯ï¼š

```python
# å¦‚æœåªç»‘å®šäº† multiply
llm_with_tools = llm.bind_tools([multiply])

# ä½† LLM å°è¯•è°ƒç”¨ divide
AIMessage(tool_calls=[{"name": "divide", ...}])

# ToolNode ä¼šæŠ¥é”™ï¼šTool 'divide' not found
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®ä¿ç»‘å®šçš„å·¥å…·å’Œ ToolNode ä¸­çš„å·¥å…·ä¸€è‡´
2. ä½¿ç”¨é”™è¯¯å¤„ç†åŒ…è£… ToolNode

### Q4: MessagesState ä¸­çš„æ¶ˆæ¯ä¼šä¸€ç›´å¢é•¿å—ï¼Ÿ

**ç­”ï¼š** æ˜¯çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹æ¶ˆæ¯ä¼šæŒç»­ç´¯ç§¯ï¼š

```python
# ç¬¬ 1 è½®
messages = [HumanMessage("ä½ å¥½")]

# ç¬¬ 2 è½®
messages = [
    HumanMessage("ä½ å¥½"),
    AIMessage("ä½ å¥½ï¼"),
    HumanMessage("2*3=?"),
]

# ç¬¬ 3 è½®
messages = [
    HumanMessage("ä½ å¥½"),
    AIMessage("ä½ å¥½ï¼"),
    HumanMessage("2*3=?"),
    AIMessage(tool_calls=[...]),
    ToolMessage("6"),
]
```

**ç®¡ç†æ¶ˆæ¯å†å²ï¼š**
```python
# æ–¹æ³• 1ï¼šé™åˆ¶æ¶ˆæ¯æ•°é‡
def trim_messages(state: MessagesState):
    # åªä¿ç•™æœ€è¿‘ 10 æ¡æ¶ˆæ¯
    return {"messages": state["messages"][-10:]}

# æ–¹æ³• 2ï¼šä½¿ç”¨ LangChain çš„ trim_messages
from langchain_core.messages import trim_messages

trimmed = trim_messages(
    messages,
    max_tokens=1000,
    strategy="last",
    token_counter=llm
)
```

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [LangGraph å®˜æ–¹æ–‡æ¡£ - Router](https://langchain-ai.github.io/langgraph/)
- [LangChain Tools æ¦‚å¿µ](https://python.langchain.com/docs/modules/agents/tools/)
- [æ¡ä»¶è¾¹è¯¦ç»†è¯´æ˜](https://langchain-ai.github.io/langgraph/concepts/low_level/#conditional-edges)
- [MessagesState å’Œæ¶ˆæ¯ç®¡ç†](https://langchain-ai.github.io/langgraph/concepts/low_level/#messagesstate)

---

## ğŸ“ å­¦ä¹ è·¯å¾„

æŒæ¡ Router åï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºæ·±å…¥å­¦ä¹ ï¼š

1. **å½“å‰é˜¶æ®µï¼šRouter** âœ…
   - ç†è§£æ¡ä»¶è¾¹
   - æŒæ¡å·¥å…·è°ƒç”¨
   - ç†Ÿæ‚‰ MessagesState

2. **ä¸‹ä¸€æ­¥ï¼šAgent with Memory**
   - æ·»åŠ è®°å¿†åŠŸèƒ½
   - å¤šè½®å¯¹è¯
   - çŠ¶æ€æŒä¹…åŒ–

3. **è¿›é˜¶ï¼šReAct Agent**
   - å¾ªç¯æ¨ç†
   - å¤šæ­¥è§„åˆ’
   - å¤æ‚ä»»åŠ¡åˆ†è§£

4. **é«˜çº§ï¼šMulti-Agent System**
   - å¤šä¸ª Agent åä½œ
   - ä»»åŠ¡åˆ†é…
   - å¹¶è¡Œæ‰§è¡Œ

---

**æ€»ç»“**ï¼šRouter æ˜¯ LangGraph Agent ç³»ç»Ÿçš„åŸºçŸ³ã€‚é€šè¿‡ LLM æ™ºèƒ½å†³ç­– + æ¡ä»¶è¾¹åŠ¨æ€è·¯ç”±ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºèƒ½å¤Ÿè‡ªä¸»é€‰æ‹©å·¥å…·çš„æ™ºèƒ½ç³»ç»Ÿã€‚è¿™æ˜¯ä»ç®€å•èŠå¤©æœºå™¨äººåˆ°å¼ºå¤§ AI Agent çš„å…³é”®ä¸€æ­¥ï¼
