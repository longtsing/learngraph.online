# LangGraph Chain è¯¦ç»†è§£è¯»
>  ç½‘ç«™ä½¿ç”¨è¯´æ˜
> - æœ¬ç½‘ç«™å¯ä»¥å…ç™»é™†è¿è¡Œ Python ä»£ç 
> - Python ä»£ç å¯ä»¥ç¼–è¾‘å¹¶ä¸´æ—¶ä¿å­˜ï¼Œä½†ä¸ä¼šæ°¸ä¹…ä¿å­˜ï¼Œç½‘é¡µåˆ·æ–°åä¼šè‡ªåŠ¨è¿˜åŸ
> - å¯¹ç½‘ç«™çš„ä½¿ç”¨æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥åˆ° [é—®é¢˜åé¦ˆ](http://localhost:5173/feedback.html) ï¼ˆæŒ‰é’®åœ¨æ¯ä¸ªé¡µé¢çš„å³ä¸‹è§’ï¼‰å…ç™»å½•è¿›è¡Œè¯„è®º
> - è¿è¡Œ `LangGraph/LangChain`ä»£ç ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥è‡ªå·±çš„ [API Key](http://localhost:5173/python-run.html)
> - é‡è¦å£°æ˜ï¼šæœ¬ç½‘ç«™ä¸ä¼šä¿å­˜ç”¨æˆ·çš„ API Key æ•°æ®ï¼Œè¯·æ”¾å¿ƒè¾“å…¥


## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£è¯» LangGraph çš„ **Chainï¼ˆé“¾å¼è°ƒç”¨ï¼‰** åŸºç¡€æ¦‚å¿µã€‚è¿™æ˜¯ LangGraph å¼€å‘çš„ç¬¬ä¸€è¯¾ï¼Œæ¶µç›–äº†æ„å»ºæ™ºèƒ½å¯¹è¯ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼šæ¶ˆæ¯ç³»ç»Ÿã€èŠå¤©æ¨¡å‹ã€å·¥å…·ç»‘å®šå’Œå·¥å…·æ‰§è¡Œã€‚é€šè¿‡æœ¬æ•™ç¨‹ï¼Œä½ å°†æŒæ¡å¦‚ä½•ä½¿ç”¨ LangChain çš„åŸºç¡€æ¦‚å¿µæ„å»ºä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å®Œæ•´çš„ AI é“¾ã€‚

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **MessagesState** | LangGraph é¢„å®šä¹‰çš„æ¶ˆæ¯çŠ¶æ€ç±»ï¼Œä¸“é—¨ç”¨äºç®¡ç†å¯¹è¯å†å² | TypedDict å­ç±»ï¼ŒåŒ…å« messages å­—æ®µå¹¶è‡ªåŠ¨ä½¿ç”¨ add_messages reducer | â­â­â­â­â­ |
| **add_messages** | æ™ºèƒ½æ¶ˆæ¯åˆå¹¶å‡½æ•°ï¼Œæ”¯æŒè¿½åŠ å’ŒåŸºäº ID çš„æ›´æ–° | Reducer å‡½æ•°ï¼Œè‡ªåŠ¨è¿½åŠ æ–°æ¶ˆæ¯åˆ°åˆ—è¡¨ï¼Œç›¸åŒ ID çš„æ¶ˆæ¯ä¼šè¢«æ›¿æ¢ | â­â­â­â­â­ |
| **Reducer** | æ§åˆ¶çŠ¶æ€å­—æ®µæ›´æ–°æ–¹å¼çš„å‡½æ•°ï¼Œé¿å…é»˜è®¤è¦†ç›–è¡Œä¸º | æ¥æ”¶æ—§å€¼å’Œæ–°å€¼ä¸¤ä¸ªå‚æ•°ï¼Œè¿”å›åˆå¹¶åçš„å€¼ | â­â­â­â­â­ |
| **Annotated** | Python ç±»å‹æ³¨è§£å¢å¼ºå·¥å…·ï¼Œä¸ºç±»å‹æ·»åŠ å…ƒæ•°æ® | typing æ¨¡å—çš„ç±»å‹ï¼Œç”¨äºåœ¨ç±»å‹æ³¨è§£ä¸­é™„åŠ é¢å¤–ä¿¡æ¯å¦‚ Reducer | â­â­â­â­ |
| **HumanMessage** | è¡¨ç¤ºç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯ç±»å‹ | LangChain æ¶ˆæ¯ç±»ï¼ŒåŒ…å« contentã€name ç­‰å±æ€§ | â­â­â­â­â­ |
| **AIMessage** | è¡¨ç¤º AI æ¨¡å‹å“åº”çš„æ¶ˆæ¯ç±»å‹ | LangChain æ¶ˆæ¯ç±»ï¼Œå¯åŒ…å« contentã€tool_calls ç­‰å±æ€§ | â­â­â­â­â­ |
| **ToolMessage** | è¡¨ç¤ºå·¥å…·æ‰§è¡Œç»“æœçš„æ¶ˆæ¯ç±»å‹ | LangChain æ¶ˆæ¯ç±»ï¼ŒåŒ…å« content å’Œ tool_call_id å±æ€§ | â­â­â­â­â­ |
| **bind_tools()** | å°† Python å‡½æ•°ç»‘å®šä¸º LLM å¯è°ƒç”¨çš„å·¥å…· | ChatModel æ–¹æ³•ï¼Œè‡ªåŠ¨ä»å‡½æ•°ç­¾åç”Ÿæˆå·¥å…· schema | â­â­â­â­â­ |
| **tool_calls** | AIMessage ä¸­å­˜å‚¨çš„å·¥å…·è°ƒç”¨è¯·æ±‚ä¿¡æ¯ | åˆ—è¡¨å±æ€§ï¼ŒåŒ…å«å·¥å…·åç§°ã€å‚æ•°å’Œè°ƒç”¨ ID | â­â­â­â­â­ |
| **Docstring** | å‡½æ•°çš„æ–‡æ¡£å­—ç¬¦ä¸²ï¼ŒLLM ç”¨äºç†è§£å·¥å…·ç”¨é€” | Python ä¸‰å¼•å·å­—ç¬¦ä¸²ï¼ŒLangChain è§£æä¸ºå·¥å…·æè¿° | â­â­â­â­ |
| **Type Hints** | å‡½æ•°çš„ç±»å‹æ³¨è§£ï¼Œå®šä¹‰å‚æ•°å’Œè¿”å›å€¼ç±»å‹ | Python ç±»å‹ç³»ç»Ÿï¼Œå¸®åŠ© LangChain ç”Ÿæˆå·¥å…·å‚æ•° schema | â­â­â­â­ |

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ Chainï¼Ÿ

åœ¨ LangChain/LangGraph ä¸­ï¼Œ**Chain** æ˜¯ä¸€ç³»åˆ—æŒ‰é¡ºåºæ‰§è¡Œçš„æ“ä½œç»„åˆã€‚ä¸€ä¸ªç®€å•çš„ Chain é€šå¸¸åŒ…å«ï¼š

1. **è¾“å…¥å¤„ç†**ï¼šæ¥æ”¶ç”¨æˆ·æ¶ˆæ¯
2. **æ¨¡å‹è°ƒç”¨**ï¼šä½¿ç”¨ LLM ç”Ÿæˆå“åº”
3. **å·¥å…·æ‰§è¡Œ**ï¼ˆå¯é€‰ï¼‰ï¼šè°ƒç”¨å¤–éƒ¨å·¥å…·/å‡½æ•°
4. **è¾“å‡ºè¿”å›**ï¼šè¿”å›æœ€ç»ˆç»“æœ

### æœ¬æ•™ç¨‹çš„å››å¤§æ ¸å¿ƒæ¦‚å¿µ

![Chain Core Concepts](https://cdn.prod.website-files.com/65b8cd72835ceeacd4449a53/66dbab08dd607b08df5e1101_chain1.png)

1. **æ¶ˆæ¯ï¼ˆMessagesï¼‰**ï¼šä½¿ç”¨èŠå¤©æ¶ˆæ¯ä½œä¸ºå›¾çŠ¶æ€
2. **èŠå¤©æ¨¡å‹ï¼ˆChat Modelsï¼‰**ï¼šåœ¨å›¾èŠ‚ç‚¹ä¸­ä½¿ç”¨ LLM
3. **å·¥å…·ç»‘å®šï¼ˆTool Bindingï¼‰**ï¼šä¸ºèŠå¤©æ¨¡å‹ç»‘å®šå·¥å…·
4. **å·¥å…·æ‰§è¡Œï¼ˆTool Callingï¼‰**ï¼šåœ¨å›¾èŠ‚ç‚¹ä¸­æ‰§è¡Œå·¥å…·è°ƒç”¨

### ç³»ç»Ÿæ¶æ„å›¾

```
ç”¨æˆ·è¾“å…¥ "Multiply 2 and 3"
        â†“
   [tool_calling_llm]
        â†“
   æ£€æµ‹åˆ°éœ€è¦è°ƒç”¨å·¥å…·
        â†“
   è¿”å›å·¥å…·è°ƒç”¨ä¿¡æ¯
   (å·¥å…·å: multiply, å‚æ•°: {a:2, b:3})
```

---

## ğŸ”§ ä»£ç å®ç°è¯¦è§£

### 1. æ¶ˆæ¯ç³»ç»Ÿï¼ˆMessagesï¼‰

#### ä»€ä¹ˆæ˜¯æ¶ˆæ¯ï¼Ÿ

èŠå¤©æ¨¡å‹ä½¿ç”¨ **æ¶ˆæ¯ï¼ˆMessagesï¼‰** æ¥è¡¨ç¤ºå¯¹è¯ä¸­çš„ä¸åŒè§’è‰²ã€‚LangChain æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹ï¼š

| æ¶ˆæ¯ç±»å‹ | è§’è‰² | ç”¨é€” |
|---------|------|------|
| `HumanMessage` | ç”¨æˆ· | è¡¨ç¤ºç”¨æˆ·è¾“å…¥ |
| `AIMessage` | AI æ¨¡å‹ | è¡¨ç¤ºæ¨¡å‹å“åº” |
| `SystemMessage` | ç³»ç»Ÿ | æŒ‡å¯¼æ¨¡å‹è¡Œä¸º |
| `ToolMessage` | å·¥å…· | å·¥å…·è°ƒç”¨çš„ç»“æœ |

#### æ¶ˆæ¯çš„ç»„æˆéƒ¨åˆ†

æ¯ä¸ªæ¶ˆæ¯å¯ä»¥åŒ…å«ï¼š

- **`content`**ï¼ˆå¿…éœ€ï¼‰ï¼šæ¶ˆæ¯å†…å®¹
- **`name`**ï¼ˆå¯é€‰ï¼‰ï¼šæ¶ˆæ¯å‘é€è€…çš„åå­—
- **`response_metadata`**ï¼ˆå¯é€‰ï¼‰ï¼šå…ƒæ•°æ®å­—å…¸ï¼ˆå¦‚æ¨¡å‹å“åº”ä¿¡æ¯ï¼‰

#### ä»£ç ç¤ºä¾‹

```python
from langchain_core.messages import AIMessage, HumanMessage

# åˆ›å»ºæ¶ˆæ¯åˆ—è¡¨
messages = [
    AIMessage(content="So you said you were researching ocean mammals?", name="Model"),
    HumanMessage(content="Yes, that's right.", name="Lance"),
    AIMessage(content="Great, what would you like to learn about.", name="Model"),
    HumanMessage(content="I want to learn about the best place to see Orcas in the US.", name="Lance")
]

# æ‰“å°æ¶ˆæ¯
for m in messages:
    m.pretty_print()
```

**è¾“å‡ºï¼š**
```
================================== Ai Message ==================================
Name: Model
So you said you were researching ocean mammals?

================================ Human Message =================================
Name: Lance
Yes, that's right.

...
```

**Python çŸ¥è¯†ç‚¹ï¼šfor å¾ªç¯ä¸æ–¹æ³•è°ƒç”¨**

```python
for m in messages:
    m.pretty_print()
```

- `for m in messages`ï¼šéå† `messages` åˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ 
- `m.pretty_print()`ï¼šè°ƒç”¨æ¯ä¸ªæ¶ˆæ¯å¯¹è±¡çš„ `pretty_print()` æ–¹æ³•
- è¿™æ˜¯ Python é¢å‘å¯¹è±¡ç¼–ç¨‹çš„å…¸å‹ç”¨æ³•

---

### 2. èŠå¤©æ¨¡å‹ï¼ˆChat Modelsï¼‰

#### ä»€ä¹ˆæ˜¯èŠå¤©æ¨¡å‹ï¼Ÿ

**èŠå¤©æ¨¡å‹** æ˜¯æ”¯æŒå¯¹è¯å¼äº¤äº’çš„ LLMï¼Œå¯ä»¥ï¼š
- æ¥æ”¶æ¶ˆæ¯åˆ—è¡¨ä½œä¸ºè¾“å…¥
- ç†è§£å¯¹è¯ä¸Šä¸‹æ–‡
- ç”Ÿæˆç¬¦åˆè§’è‰²çš„å›å¤

LangChain æ”¯æŒå¤šç§èŠå¤©æ¨¡å‹æä¾›å•†ï¼šOpenAIã€Anthropicã€Googleã€Ollama ç­‰ã€‚

#### è®¾ç½® API Key

```python
import os, getpass

def _set_env(var: str):
    if not os.environ.get(var):
        os.environ[var] = getpass.getpass(f"{var}: ")

_set_env("OPENAI_API_KEY")
```

**Python çŸ¥è¯†ç‚¹ï¼šç¯å¢ƒå˜é‡ä¸å®‰å…¨æ€§**

- `os.environ.get(var)`ï¼šè·å–ç¯å¢ƒå˜é‡
- `getpass.getpass()`ï¼šå®‰å…¨åœ°è¾“å…¥å¯†ç ï¼ˆè¾“å…¥ä¸ä¼šæ˜¾ç¤ºï¼‰
- è¿™æ˜¯ä¿æŠ¤ API Key çš„æœ€ä½³å®è·µ

#### ä½¿ç”¨èŠå¤©æ¨¡å‹

```python
from langchain_openai import ChatOpenAI

# åˆå§‹åŒ–æ¨¡å‹
llm = ChatOpenAI(model="gpt-5-nano")

# è°ƒç”¨æ¨¡å‹
result = llm.invoke(messages)
```

**è¾“å‡ºç±»å‹ï¼š**
```python
type(result)
# langchain_core.messages.ai.AIMessage
```

`result` æ˜¯ä¸€ä¸ª `AIMessage` å¯¹è±¡ï¼ŒåŒ…å«ï¼š

```python
result.content  # AI ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹
result.response_metadata  # å“åº”å…ƒæ•°æ®
```

#### å“åº”å…ƒæ•°æ®è¯¦è§£

```python
result.response_metadata
```

è¾“å‡ºç¤ºä¾‹ï¼š
```python
{
    'token_usage': {
        'completion_tokens': 228,  # è¾“å‡ºçš„ token æ•°
        'prompt_tokens': 67,       # è¾“å…¥çš„ token æ•°
        'total_tokens': 295        # æ€» token æ•°
    },
    'model_name': 'gpt-5-nano-2024-08-06',
    'finish_reason': 'stop',       # åœæ­¢åŸå› ï¼ˆæ­£å¸¸ç»“æŸï¼‰
    'logprobs': None
}
```

**é‡è¦æ€§ï¼š**
- å¯ä»¥è·Ÿè¸ª API ä½¿ç”¨æˆæœ¬
- äº†è§£æ¨¡å‹ç”Ÿæˆçš„è¯¦ç»†ä¿¡æ¯
- è°ƒè¯•å’Œä¼˜åŒ–æ€§èƒ½

---

### 3. å·¥å…·ï¼ˆToolsï¼‰

#### ä»€ä¹ˆæ˜¯å·¥å…·ï¼Ÿ

**å·¥å…·ï¼ˆToolsï¼‰** å…è®¸ LLM ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’ã€‚å½“ä½ éœ€è¦ï¼š
- è°ƒç”¨ API
- æ‰§è¡Œè®¡ç®—
- æŸ¥è¯¢æ•°æ®åº“
- è®¿é—®å¤–éƒ¨æœåŠ¡

ä½ å¯ä»¥å°†è¿™äº›åŠŸèƒ½å®šä¹‰ä¸º"å·¥å…·"ï¼Œè®©æ¨¡å‹çŸ¥é“ä½•æ—¶ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬ã€‚

#### å·¥å…·çš„å·¥ä½œåŸç†

![Tool Calling Flow](https://cdn.prod.website-files.com/65b8cd72835ceeacd4449a53/66dbab08dc1c17a7a57f9960_chain2.png)

**æµç¨‹è¯´æ˜ï¼š**
```
ç”¨æˆ·è¾“å…¥ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰
        â†“
   LLM åˆ†æè¾“å…¥
        â†“
   å†³å®šæ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·
        â†“
   è¿”å›ç¬¦åˆå·¥å…· schema çš„è°ƒç”¨ä¿¡æ¯
   (åŒ…å«å·¥å…·åç§°å’Œå‚æ•°)
```

#### å®šä¹‰å·¥å…·

åœ¨ LangChain ä¸­ï¼Œ**ä»»ä½• Python å‡½æ•°éƒ½å¯ä»¥ä½œä¸ºå·¥å…·**ï¼

```python
def multiply(a: int, b: int) -> int:
    """Multiply a and b.

    Args:
        a: first int
        b: second int
    """
    return a * b
```

**å…³é”®è¦ç‚¹ï¼š**
1. **ç±»å‹æ³¨è§£**ï¼š`a: int, b: int -> int` è®©æ¨¡å‹çŸ¥é“å‚æ•°ç±»å‹
2. **æ–‡æ¡£å­—ç¬¦ä¸²**ï¼šæè¿°å‡½æ•°çš„åŠŸèƒ½ï¼Œå¸®åŠ©æ¨¡å‹ç†è§£ä½•æ—¶ä½¿ç”¨

**Python çŸ¥è¯†ç‚¹ï¼šç±»å‹æ³¨è§£ï¼ˆType Hintsï¼‰**

```python
def multiply(a: int, b: int) -> int:
    #          ^^^^^^  ^^^^^^    ^^^
    #          å‚æ•°a   å‚æ•°b     è¿”å›å€¼
    #          æ˜¯int   æ˜¯int     æ˜¯int
    return a * b
```

ç±»å‹æ³¨è§£çš„ä½œç”¨ï¼š
- æä¾› IDE ä»£ç æç¤º
- å¸®åŠ© LangChain ç”Ÿæˆå·¥å…· schema
- æé«˜ä»£ç å¯è¯»æ€§
- **ä¸å¼ºåˆ¶æ‰§è¡Œ**ï¼ˆPython ä»ç„¶æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼‰

#### ç»‘å®šå·¥å…·åˆ°æ¨¡å‹

```python
llm_with_tools = llm.bind_tools([multiply])
```

**å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**
- `bind_tools()` å‘Šè¯‰æ¨¡å‹ï¼š"ä½ å¯ä»¥è°ƒç”¨è¿™äº›å·¥å…·"
- LangChain è‡ªåŠ¨ä»å‡½æ•°ç­¾åç”Ÿæˆå·¥å…· schema
- æ¨¡å‹ç°åœ¨çŸ¥é“ `multiply` å·¥å…·çš„å­˜åœ¨ã€å‚æ•°å’Œç”¨é€”

#### å·¥å…·è°ƒç”¨ç¤ºä¾‹

```python
tool_call = llm_with_tools.invoke([
    HumanMessage(content="What is 2 multiplied by 3", name="Lance")
])

tool_call.tool_calls
```

**è¾“å‡ºï¼š**
```python
[{
    'name': 'multiply',              # å·¥å…·åç§°
    'args': {'a': 2, 'b': 3},       # å·¥å…·å‚æ•°
    'id': 'call_lBBBNo5oYpHGRqwxNaNRbsiT',  # è°ƒç”¨ ID
    'type': 'tool_call'             # ç±»å‹
}]
```

**é‡è¦ç†è§£ï¼š**
- LLM **å¹¶æ²¡æœ‰çœŸæ­£æ‰§è¡Œ** `multiply(2, 3)`
- å®ƒåªæ˜¯ **è¿”å›äº†è°ƒç”¨ä¿¡æ¯**
- å®é™…æ‰§è¡Œéœ€è¦åœ¨åç»­æ­¥éª¤ä¸­å¤„ç†

---

### 4. ä½¿ç”¨æ¶ˆæ¯ä½œä¸ºçŠ¶æ€ï¼ˆMessages as Stateï¼‰

#### ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯ä½œä¸ºçŠ¶æ€ï¼Ÿ

åœ¨å¯¹è¯ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
- ä¿å­˜å¯¹è¯å†å²
- è¿½è¸ªå¤šè½®äº¤äº’
- ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯

ä½¿ç”¨ **æ¶ˆæ¯åˆ—è¡¨** ä½œä¸ºå›¾çŠ¶æ€æ˜¯æœ€è‡ªç„¶çš„æ–¹å¼ã€‚

#### å®šä¹‰çŠ¶æ€

**æ–¹æ³• 1ï¼šæ‰‹åŠ¨å®šä¹‰**

```python
from typing_extensions import TypedDict
from langchain_core.messages import AnyMessage

class MessagesState(TypedDict):
    messages: list[AnyMessage]
```

**Python çŸ¥è¯†ç‚¹ï¼šTypedDict**

`TypedDict` æ˜¯ Python çš„ç±»å‹æ³¨è§£å·¥å…·ï¼Œç”¨äºå®šä¹‰å­—å…¸çš„ç»“æ„ï¼š

```python
class MessagesState(TypedDict):
    messages: list[AnyMessage]
    #         ^^^^^^^^^^^^^^^^
    #         å€¼çš„ç±»å‹ï¼šAnyMessage å¯¹è±¡çš„åˆ—è¡¨

# ä½¿ç”¨
state = {"messages": [HumanMessage(content="Hi")]}
```

**ä¼˜åŠ¿ï¼š**
- æä¾› IDE ç±»å‹æ£€æŸ¥å’Œè‡ªåŠ¨è¡¥å…¨
- æ¸…æ™°åœ°å®šä¹‰æ•°æ®ç»“æ„
- ä¸å½±å“è¿è¡Œæ—¶æ€§èƒ½ï¼ˆä»…ç”¨äºé™æ€åˆ†æï¼‰

---

### 5. Reducersï¼ˆå½’çº¦å™¨ï¼‰â­

#### é—®é¢˜ï¼šçŠ¶æ€è¦†ç›–

é»˜è®¤æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹è¿”å›çš„æ–°å€¼ä¼š **è¦†ç›–** æ—§å€¼ï¼š

```python
# åˆå§‹çŠ¶æ€
state = {"messages": [message1, message2]}

# èŠ‚ç‚¹è¿”å›
node_output = {"messages": [message3]}

# ç»“æœï¼šmessage1 å’Œ message2 è¢«ä¸¢å¼ƒï¼
new_state = {"messages": [message3]}
```

**è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼** æˆ‘ä»¬å¸Œæœ› **è¿½åŠ ** æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯è¦†ç›–ã€‚

#### è§£å†³æ–¹æ¡ˆï¼šadd_messages Reducer

**Reducer** æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ŒæŒ‡å®šå¦‚ä½•æ›´æ–°çŠ¶æ€ã€‚

```python
from typing import Annotated
from langgraph.graph.message import add_messages

class MessagesState(TypedDict):
    messages: Annotated[list[AnyMessage], add_messages]
    #         ^^^^^^^^^                   ^^^^^^^^^^^^^
    #         åŸºç¡€ç±»å‹                    Reducer å‡½æ•°
```

**Python çŸ¥è¯†ç‚¹ï¼šAnnotated**

`Annotated` æ˜¯ Python 3.9+ å¼•å…¥çš„ç±»å‹æ³¨è§£å¢å¼ºå·¥å…·ï¼š

```python
from typing import Annotated

Annotated[ç±»å‹, å…ƒæ•°æ®1, å…ƒæ•°æ®2, ...]
#         ^^^^  ^^^^^^^^^^^^^^^^^^^^^^^^
#         åŸºç¡€  é¢å¤–ä¿¡æ¯ï¼ˆä¸å½±å“ç±»å‹æ£€æŸ¥ï¼‰
```

åœ¨ LangGraph ä¸­ï¼š
```python
messages: Annotated[list[AnyMessage], add_messages]
#                   ^^^^^^^^^^^^^^^^^  ^^^^^^^^^^^^^
#                   ç±»å‹ï¼šæ¶ˆæ¯åˆ—è¡¨      å…ƒæ•°æ®ï¼šreducer å‡½æ•°
```

LangGraph ä¼šè¯»å–è¿™ä¸ªå…ƒæ•°æ®ï¼ŒçŸ¥é“åº”è¯¥ä½¿ç”¨ `add_messages` æ¥æ›´æ–°çŠ¶æ€ã€‚

#### add_messages çš„å·¥ä½œåŸç†

```python
from langgraph.graph.message import add_messages

# åˆå§‹æ¶ˆæ¯
initial = [
    AIMessage(content="Hello! How can I assist you?", name="Model"),
    HumanMessage(content="I'm looking for information on marine biology.", name="Lance")
]

# æ–°æ¶ˆæ¯
new_message = AIMessage(content="Sure, I can help with that.", name="Model")

# ä½¿ç”¨ add_messages
result = add_messages(initial, new_message)
# ç»“æœï¼š[message1, message2, message3]  â† è¿½åŠ ï¼Œä¸è¦†ç›–ï¼
```

**add_messages çš„ç‰¹æ€§ï¼š**
1. è‡ªåŠ¨è¿½åŠ æ–°æ¶ˆæ¯åˆ°åˆ—è¡¨æœ«å°¾
2. æ”¯æŒå•ä¸ªæ¶ˆæ¯æˆ–æ¶ˆæ¯åˆ—è¡¨
3. å¤„ç†æ¶ˆæ¯å»é‡ï¼ˆåŸºäº IDï¼‰
4. æ˜¯ LangGraph å†…ç½®çš„ reducer

---

### 6. ä½¿ç”¨ MessagesStateï¼ˆæ¨èæ–¹å¼ï¼‰

ç”±äº"æ¶ˆæ¯åˆ—è¡¨"æ˜¯å¦‚æ­¤å¸¸è§çš„çŠ¶æ€ç»“æ„ï¼ŒLangGraph æä¾›äº†é¢„æ„å»ºçš„ `MessagesState`ï¼š

```python
from langgraph.graph import MessagesState

class MessagesState(MessagesState):
    # å¦‚æœéœ€è¦é¢å¤–å­—æ®µï¼Œåœ¨è¿™é‡Œæ·»åŠ 
    pass
```

**é¢„æ„å»ºçš„ MessagesState åŒ…å«ï¼š**
- `messages` å­—æ®µï¼š`list[AnyMessage]`
- è‡ªåŠ¨ä½¿ç”¨ `add_messages` reducer
- æ— éœ€æ‰‹åŠ¨å®šä¹‰

**å¦‚æœéœ€è¦é¢å¤–å­—æ®µï¼š**
```python
class ExtendedState(MessagesState):
    user_id: str
    session_id: str
    # messages å­—æ®µå·²ç»è‡ªåŠ¨åŒ…å«
```

---

### 7. æ„å»ºå›¾

ç°åœ¨æˆ‘ä»¬æœ‰äº†æ‰€æœ‰ç»„ä»¶ï¼Œå¯ä»¥æ„å»ºå›¾äº†ï¼

```python
from langgraph.graph import StateGraph, START, END

# å®šä¹‰èŠ‚ç‚¹
def tool_calling_llm(state: MessagesState):
    return {"messages": [llm_with_tools.invoke(state["messages"])]}

# æ„å»ºå›¾
builder = StateGraph(MessagesState)
builder.add_node("tool_calling_llm", tool_calling_llm)
builder.add_edge(START, "tool_calling_llm")
builder.add_edge("tool_calling_llm", END)
graph = builder.compile()
```

#### ä»£ç è¯¦è§£

**1. å®šä¹‰èŠ‚ç‚¹å‡½æ•°**

```python
def tool_calling_llm(state: MessagesState):
    #                  ^^^^^^^^^^^^^^^^^^^^^^
    #                  è¾“å…¥ï¼šå½“å‰å›¾çŠ¶æ€

    result = llm_with_tools.invoke(state["messages"])
    #        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    #        è°ƒç”¨ LLMï¼Œä¼ å…¥å¯¹è¯å†å²

    return {"messages": [result]}
    #      ^^^^^^^^^^^^^^^^^^^^^^^
    #      è¿”å›æ–°æ¶ˆæ¯ï¼ˆä¼šè¢« add_messages è¿½åŠ ï¼‰
```

**2. åˆ›å»ºå›¾**

```python
builder = StateGraph(MessagesState)
#                    ^^^^^^^^^^^^^^
#                    æŒ‡å®šçŠ¶æ€ç±»å‹
```

**3. æ·»åŠ èŠ‚ç‚¹**

```python
builder.add_node("tool_calling_llm", tool_calling_llm)
#                ^^^^^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^^^^
#                èŠ‚ç‚¹åç§°            èŠ‚ç‚¹å‡½æ•°
```

**4. æ·»åŠ è¾¹**

```python
builder.add_edge(START, "tool_calling_llm")
#                ^^^^^  ^^^^^^^^^^^^^^^^^^
#                èµ·ç‚¹    ç›®æ ‡èŠ‚ç‚¹

builder.add_edge("tool_calling_llm", END)
#                ^^^^^^^^^^^^^^^^^^  ^^^
#                æºèŠ‚ç‚¹              ç»ˆç‚¹
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šSTART å’Œ END**

- `START`ï¼šç‰¹æ®ŠèŠ‚ç‚¹ï¼Œè¡¨ç¤ºå›¾çš„å…¥å£
- `END`ï¼šç‰¹æ®ŠèŠ‚ç‚¹ï¼Œè¡¨ç¤ºå›¾çš„å‡ºå£
- ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯å¸¸é‡æ ‡è¯†ç¬¦

**5. ç¼–è¯‘å›¾**

```python
graph = builder.compile()
```

ç¼–è¯‘åçš„å›¾å¯ä»¥æ‰§è¡Œï¼ˆinvokeã€stream ç­‰ï¼‰ã€‚

#### å›¾çš„å¯è§†åŒ–

```python
from IPython.display import Image, display
display(Image(graph.get_graph().draw_mermaid_png()))
```

è¾“å‡ºï¼š
```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ __start__ â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tool_calling_llm â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ __end__  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 8. æ‰§è¡Œå›¾

#### åœºæ™¯ 1ï¼šæ™®é€šå¯¹è¯

```python
messages = graph.invoke({"messages": HumanMessage(content="Hello!")})

for m in messages['messages']:
    m.pretty_print()
```

**è¾“å‡ºï¼š**
```
================================ Human Message =================================
Hello!

================================== Ai Message ==================================
Hi there! How can I assist you today?
```

**åˆ†æï¼š**
- è¾“å…¥ä¸éœ€è¦å·¥å…·ï¼ŒLLM ç›´æ¥å›å¤
- æ²¡æœ‰å·¥å…·è°ƒç”¨ä¿¡æ¯

#### åœºæ™¯ 2ï¼šå·¥å…·è°ƒç”¨

```python
messages = graph.invoke({"messages": HumanMessage(content="Multiply 2 and 3")})

for m in messages['messages']:
    m.pretty_print()
```

**è¾“å‡ºï¼š**
```
================================ Human Message =================================
Multiply 2 and 3

================================== Ai Message ==================================
Tool Calls:
  multiply (call_Er4gChFoSGzU7lsuaGzfSGTQ)
 Call ID: call_Er4gChFoSGzU7lsuaGzfSGTQ
  Args:
    a: 2
    b: 3
```

**åˆ†æï¼š**
- LLM è¯†åˆ«å‡ºéœ€è¦ä½¿ç”¨ `multiply` å·¥å…·
- è¿”å›å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼Œä½† **å°šæœªæ‰§è¡Œ**
- å‚æ•° `a=2, b=3` ä»è‡ªç„¶è¯­è¨€ä¸­æå–

---

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### LangGraph/LangChain ç‰¹æœ‰æ¦‚å¿µ

#### 1. æ¶ˆæ¯ç³»ç»Ÿ

| æ¶ˆæ¯ç±»å‹ | ç”¨é€” | ç¤ºä¾‹ |
|---------|------|------|
| `HumanMessage` | ç”¨æˆ·è¾“å…¥ | `HumanMessage(content="Hi")` |
| `AIMessage` | æ¨¡å‹è¾“å‡º | `AIMessage(content="Hello!")` |
| `SystemMessage` | ç³»ç»ŸæŒ‡ä»¤ | `SystemMessage(content="You are helpful")` |
| `ToolMessage` | å·¥å…·ç»“æœ | `ToolMessage(content="6", tool_call_id="...")` |

#### 2. å·¥å…·ç»‘å®š

```python
# å®šä¹‰å·¥å…·ï¼ˆæ™®é€š Python å‡½æ•°ï¼‰
def multiply(a: int, b: int) -> int:
    """Multiply two numbers"""
    return a * b

# ç»‘å®šåˆ°æ¨¡å‹
llm_with_tools = llm.bind_tools([multiply])
```

**å…³é”®ç‚¹ï¼š**
- å‡½æ•°ç­¾å â†’ è‡ªåŠ¨ç”Ÿæˆå·¥å…· schema
- æ–‡æ¡£å­—ç¬¦ä¸² â†’ å¸®åŠ©æ¨¡å‹ç†è§£ç”¨é€”
- ç±»å‹æ³¨è§£ â†’ å®šä¹‰å‚æ•°å’Œè¿”å›å€¼ç±»å‹

#### 3. Reducers

**ä½œç”¨ï¼š** æ§åˆ¶çŠ¶æ€æ›´æ–°æ–¹å¼

```python
# é»˜è®¤è¡Œä¸ºï¼šè¦†ç›–
messages: list[AnyMessage]

# ä½¿ç”¨ reducerï¼šè¿½åŠ 
messages: Annotated[list[AnyMessage], add_messages]
```

**å¸¸ç”¨ reducersï¼š**
- `add_messages`ï¼šè¿½åŠ æ¶ˆæ¯ï¼ˆå»é‡ï¼‰
- `operator.add`ï¼šåˆ—è¡¨æ‹¼æ¥
- è‡ªå®šä¹‰å‡½æ•°ï¼šå®Œå…¨æ§åˆ¶æ›´æ–°é€»è¾‘

#### 4. å›¾çš„æ„å»ºæ¨¡å¼

```python
# 1. åˆ›å»ºå›¾
builder = StateGraph(StateClass)

# 2. æ·»åŠ èŠ‚ç‚¹
builder.add_node("node_name", node_function)

# 3. æ·»åŠ è¾¹
builder.add_edge(START, "node_name")
builder.add_edge("node_name", END)

# 4. ç¼–è¯‘
graph = builder.compile()

# 5. æ‰§è¡Œ
result = graph.invoke(initial_state)
```

### Python ç‰¹æœ‰çŸ¥è¯†ç‚¹

#### 1. TypedDict

**ä½œç”¨ï¼š** å®šä¹‰å­—å…¸çš„ç»“æ„å’Œç±»å‹

```python
from typing_extensions import TypedDict

class MyState(TypedDict):
    name: str
    age: int

# ä½¿ç”¨
state: MyState = {"name": "Alice", "age": 30}
```

**ç‰¹ç‚¹ï¼š**
- ä»…ç”¨äºç±»å‹æ£€æŸ¥ï¼ˆé™æ€åˆ†æï¼‰
- è¿è¡Œæ—¶ä»æ˜¯æ™®é€šå­—å…¸
- æä¾› IDE è‡ªåŠ¨è¡¥å…¨

#### 2. Type Hintsï¼ˆç±»å‹æ³¨è§£ï¼‰

```python
def greet(name: str) -> str:
    #         ^^^^^    ^^^^^
    #         å‚æ•°ç±»å‹  è¿”å›å€¼ç±»å‹
    return f"Hello, {name}"
```

**ç”¨é€”ï¼š**
- æ–‡æ¡£åŒ–ä»£ç 
- IDE æ”¯æŒ
- é™æ€ç±»å‹æ£€æŸ¥ï¼ˆmypyï¼‰
- LangChain å·¥å…· schema ç”Ÿæˆ

#### 3. Annotated

**ä½œç”¨ï¼š** ä¸ºç±»å‹æ·»åŠ å…ƒæ•°æ®

```python
from typing import Annotated

# åŸºç¡€ç±»å‹ + å…ƒæ•°æ®
Age = Annotated[int, "Must be positive"]

# åœ¨ LangGraph ä¸­
messages: Annotated[list, add_messages]
#                   ^^^^  ^^^^^^^^^^^^^
#                   ç±»å‹  å…ƒæ•°æ®ï¼ˆreducerï¼‰
```

**LangGraph ä½¿ç”¨åœºæ™¯ï¼š**
```python
class State(TypedDict):
    # ä¼šè¢«è¦†ç›–
    count: int

    # ä¼šè¢«ç´¯åŠ 
    scores: Annotated[list[int], operator.add]

    # ä¼šè¢«è¿½åŠ ï¼ˆå»é‡ï¼‰
    messages: Annotated[list[AnyMessage], add_messages]
```

#### 4. ç¯å¢ƒå˜é‡

```python
import os

# è®¾ç½®
os.environ["KEY"] = "value"

# è·å–
value = os.environ.get("KEY")

# å®‰å…¨è¾“å…¥
import getpass
api_key = getpass.getpass("API Key: ")
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ¶ˆæ¯ç®¡ç†

#### âœ… å¥½çš„åšæ³•

```python
# æ˜ç¡®æŒ‡å®šæ¶ˆæ¯è§’è‰²å’Œåç§°
messages = [
    SystemMessage(content="You are a helpful assistant"),
    HumanMessage(content="What's the weather?", name="User"),
    AIMessage(content="I'll check that for you", name="Assistant")
]
```

#### âŒ é¿å…çš„åšæ³•

```python
# ä¸è¦æ··ç”¨å­—ç¬¦ä¸²å’Œæ¶ˆæ¯å¯¹è±¡
messages = ["Hello", HumanMessage(content="Hi")]  # é”™è¯¯ï¼
```

### 2. å·¥å…·å®šä¹‰

#### âœ… å¥½çš„åšæ³•

```python
def calculate_discount(price: float, discount_percent: float) -> float:
    """Calculate the discounted price.

    Args:
        price: Original price in dollars
        discount_percent: Discount percentage (0-100)

    Returns:
        Final price after discount
    """
    return price * (1 - discount_percent / 100)
```

**ç‰¹ç‚¹ï¼š**
- å®Œæ•´çš„ç±»å‹æ³¨è§£
- è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
- æ¸…æ™°çš„å‚æ•°è¯´æ˜

#### âŒ é¿å…çš„åšæ³•

```python
def calc(p, d):  # æ— ç±»å‹æ³¨è§£ï¼Œæ— æ–‡æ¡£
    return p * (1 - d / 100)
```

### 3. çŠ¶æ€è®¾è®¡

#### âœ… å¥½çš„åšæ³•

```python
class ChatState(MessagesState):
    user_id: str
    session_started_at: str
    # messages è‡ªåŠ¨ç»§æ‰¿ï¼Œå¸¦ add_messages reducer
```

#### âŒ é¿å…çš„åšæ³•

```python
# ä¸è¦æ‰‹åŠ¨ç®¡ç†æ¶ˆæ¯åˆ—è¡¨
class ChatState(TypedDict):
    all_messages: list  # æ— ç±»å‹ï¼Œæ—  reducer
```

### 4. èŠ‚ç‚¹å‡½æ•°

#### âœ… å¥½çš„åšæ³•

```python
def process_message(state: MessagesState) -> dict:
    """Process user message and generate response."""
    try:
        response = llm.invoke(state["messages"])
        return {"messages": [response]}
    except Exception as e:
        logger.error(f"LLM error: {e}")
        return {"messages": [AIMessage(content="Sorry, an error occurred")]}
```

**ç‰¹ç‚¹ï¼š**
- æ˜ç¡®çš„ç±»å‹æ³¨è§£
- é”™è¯¯å¤„ç†
- è¿”å›æ­£ç¡®çš„çŠ¶æ€æ ¼å¼

#### âŒ é¿å…çš„åšæ³•

```python
def process(s):  # æ— ç±»å‹ï¼Œæ— é”™è¯¯å¤„ç†
    return llm.invoke(s["messages"])  # è¿”å›æ ¼å¼é”™è¯¯
```

---

## ğŸš€ è¿›é˜¶æŠ€å·§

### 1. è‡ªå®šä¹‰ Reducer

é™¤äº† `add_messages`ï¼Œä½ å¯ä»¥å®šä¹‰è‡ªå®šä¹‰ reducerï¼š

```python
def keep_last_n_messages(existing: list, new: list, n: int = 10) -> list:
    """åªä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯"""
    combined = existing + new
    return combined[-n:]

class State(TypedDict):
    messages: Annotated[list, lambda x, y: keep_last_n_messages(x, y, 5)]
```

### 2. æ¡ä»¶å·¥å…·è°ƒç”¨

```python
def smart_node(state: MessagesState):
    response = llm_with_tools.invoke(state["messages"])

    if response.tool_calls:
        # æœ‰å·¥å…·è°ƒç”¨ â†’ æ‰§è¡Œå·¥å…·
        tool_name = response.tool_calls[0]["name"]
        tool_args = response.tool_calls[0]["args"]

        if tool_name == "multiply":
            result = multiply(**tool_args)
            return {"messages": [
                response,
                ToolMessage(content=str(result), tool_call_id=response.tool_calls[0]["id"])
            ]}

    # æ— å·¥å…·è°ƒç”¨ â†’ ç›´æ¥è¿”å›
    return {"messages": [response]}
```

### 3. å¤šæ¨¡å‹æ”¯æŒ

```python
class ModelState(MessagesState):
    current_model: str

def adaptive_node(state: ModelState):
    # æ ¹æ®çŠ¶æ€é€‰æ‹©ä¸åŒæ¨¡å‹
    if state["current_model"] == "fast":
        llm = ChatOpenAI(model="gpt-3.5-turbo")
    else:
        llm = ChatOpenAI(model="gpt-5-nano")

    response = llm.invoke(state["messages"])
    return {"messages": [response]}
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦ `add_messages` reducerï¼Ÿ

**ç­”ï¼š** å› ä¸ºå¯¹è¯éœ€è¦ä¿ç•™å†å²è®°å½•ã€‚

```python
# æ²¡æœ‰ reducerï¼ˆé”™è¯¯ï¼‰
state = {"messages": [msg1, msg2]}
node_output = {"messages": [msg3]}
# ç»“æœï¼šmsg1, msg2 ä¸¢å¤±ï¼

# æœ‰ add_messagesï¼ˆæ­£ç¡®ï¼‰
state = {"messages": [msg1, msg2]}
node_output = {"messages": [msg3]}
# ç»“æœï¼š[msg1, msg2, msg3]  â† ä¿ç•™å†å²
```

### Q2: `invoke()` å’Œ `stream()` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

```python
# invokeï¼šç­‰å¾…å…¨éƒ¨å®Œæˆï¼Œè¿”å›æœ€ç»ˆç»“æœ
result = graph.invoke({"messages": [HumanMessage(content="Hi")]})

# streamï¼šæµå¼è¿”å›ä¸­é—´ç»“æœ
for chunk in graph.stream({"messages": [HumanMessage(content="Hi")]}):
    print(chunk)
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- `invoke`ï¼šéœ€è¦å®Œæ•´ç»“æœæ—¶
- `stream`ï¼šéœ€è¦å®æ—¶åé¦ˆæ—¶ï¼ˆå¦‚èŠå¤©ç•Œé¢ï¼‰

### Q3: å·¥å…·è°ƒç”¨åå¦‚ä½•æ‰§è¡Œå·¥å…·ï¼Ÿ

æœ¬æ•™ç¨‹ä¸­ï¼ŒLLM åªè¿”å›å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼Œä¸æ‰§è¡Œã€‚å®Œæ•´çš„å·¥å…·æ‰§è¡Œæµç¨‹éœ€è¦ï¼š

1. æ£€æµ‹ `response.tool_calls`
2. è°ƒç”¨å®é™…å‡½æ•°
3. å°†ç»“æœä½œä¸º `ToolMessage` è¿”å›
4. å†æ¬¡è°ƒç”¨ LLM ç”Ÿæˆæœ€ç»ˆå›ç­”

è¿™å°†åœ¨åç»­æ•™ç¨‹ä¸­è¯¦ç»†ä»‹ç»ã€‚

### Q4: TypedDict å’Œ Pydantic BaseModel å¦‚ä½•é€‰æ‹©ï¼Ÿ

| åœºæ™¯ | ä½¿ç”¨ |
|------|------|
| å®šä¹‰å›¾çŠ¶æ€ | `TypedDict` |
| LLM ç»“æ„åŒ–è¾“å‡º | `BaseModel` |
| API è¯·æ±‚/å“åº” | `BaseModel` |
| éœ€è¦æ•°æ®éªŒè¯ | `BaseModel` |
| ä»…éœ€ç±»å‹æç¤º | `TypedDict` |

```python
# å›¾çŠ¶æ€
class State(TypedDict):
    messages: list

# å·¥å…·è¾“å‡º
class ToolOutput(BaseModel):
    result: int
    status: str
```

---

## ğŸ“Š æ¦‚å¿µå¯¹æ¯”

### Chain vs Graph

| ç‰¹æ€§ | Chain | Graph |
|------|-------|-------|
| ç»“æ„ | çº¿æ€§ï¼ˆAâ†’Bâ†’Cï¼‰ | ä»»æ„ï¼ˆå¯å¾ªç¯ã€åˆ†æ”¯ï¼‰ |
| å¤æ‚åº¦ | ç®€å• | å¤æ‚ |
| é€‚ç”¨åœºæ™¯ | ç®€å•æµç¨‹ | å¤æ‚å·¥ä½œæµ |
| æœ¬æ•™ç¨‹ | âœ… | âœ…ï¼ˆç®€å•å›¾ï¼‰ |

æœ¬æ•™ç¨‹ä½¿ç”¨äº†ç®€å•çš„çº¿æ€§å›¾ï¼ˆchainï¼‰ï¼Œä½†ä½¿ç”¨äº† StateGraph æ„å»ºï¼Œä¸ºåç»­å¤æ‚å›¾æ‰“åŸºç¡€ã€‚

### Messages vs State

```python
# ä»…æ¶ˆæ¯
def node1(messages: list[AnyMessage]) -> list[AnyMessage]:
    return llm.invoke(messages)

# ä½¿ç”¨çŠ¶æ€ï¼ˆæ¨èï¼‰
def node2(state: MessagesState) -> dict:
    return {"messages": [llm.invoke(state["messages"])]}
```

**ä½¿ç”¨çŠ¶æ€çš„ä¼˜åŠ¿ï¼š**
- å¯ä»¥æ·»åŠ é¢å¤–ä¿¡æ¯ï¼ˆuser_idã€metadata ç­‰ï¼‰
- ç»Ÿä¸€çš„æ›´æ–°æœºåˆ¶ï¼ˆreducersï¼‰
- æ›´å¥½çš„æ‰©å±•æ€§

---

## ğŸ¯ å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šç®€å•å®¢æœæœºå™¨äºº

```python
from langgraph.graph import StateGraph, MessagesState, START, END

# å·¥å…·ï¼šæŸ¥è¯¢è®¢å•
def check_order(order_id: str) -> str:
    """Check order status"""
    return f"Order {order_id} is being processed"

# èŠ‚ç‚¹
def customer_service(state: MessagesState):
    llm_with_tools = ChatOpenAI(model="gpt-5-nano").bind_tools([check_order])
    response = llm_with_tools.invoke(state["messages"])
    return {"messages": [response]}

# æ„å»ºå›¾
builder = StateGraph(MessagesState)
builder.add_node("service", customer_service)
builder.add_edge(START, "service")
builder.add_edge("service", END)
app = builder.compile()

# ä½¿ç”¨
result = app.invoke({"messages": [HumanMessage(content="Check order #12345")]})
```

### æ¡ˆä¾‹ 2ï¼šå¤šè¯­è¨€ç¿»è¯‘åŠ©æ‰‹

```python
def translate(text: str, target_language: str) -> str:
    """Translate text to target language"""
    # å®é™…è°ƒç”¨ç¿»è¯‘ API
    return f"[{target_language}] {text}"

def translator_bot(state: MessagesState):
    llm_with_tools = ChatOpenAI(model="gpt-5-nano").bind_tools([translate])
    response = llm_with_tools.invoke(state["messages"])
    return {"messages": [response]}

# ä½¿ç”¨
result = app.invoke({
    "messages": [HumanMessage(content="Translate 'Hello' to Spanish")]
})
```

---

## ğŸ“– ä¸‹ä¸€æ­¥å­¦ä¹ 

æœ¬æ•™ç¨‹ä»‹ç»äº† Chain çš„åŸºç¡€æ¦‚å¿µï¼Œä¸‹ä¸€æ­¥ä½ å°†å­¦ä¹ ï¼š

1. **Tool Executionï¼ˆå·¥å…·æ‰§è¡Œï¼‰**ï¼šå®é™…æ‰§è¡Œå·¥å…·è°ƒç”¨å¹¶è¿”å›ç»“æœ
2. **Conditional Edgesï¼ˆæ¡ä»¶è¾¹ï¼‰**ï¼šæ ¹æ®çŠ¶æ€åŠ¨æ€è·¯ç”±
3. **Cyclesï¼ˆå¾ªç¯ï¼‰**ï¼šæ„å»ºå¯ä»¥å¤šè½®äº¤äº’çš„å›¾
4. **Memoryï¼ˆè®°å¿†ï¼‰**ï¼šæŒä¹…åŒ–å¯¹è¯å†å²

---

## ğŸ”— æ‰©å±•é˜…è¯»

- [LangChain Messages æ–‡æ¡£](https://python.langchain.com/docs/concepts/#messages)
- [LangChain Chat Models æ–‡æ¡£](https://python.langchain.com/docs/concepts/#chat-models)
- [LangChain Tools æ–‡æ¡£](https://python.langchain.com/docs/concepts/#tools)
- [LangGraph Reducers æ–‡æ¡£](https://langchain-ai.github.io/langgraph/concepts/low_level/#reducers)
- [Python Type Hints æŒ‡å—](https://docs.python.org/3/library/typing.html)

---

**æ€»ç»“**ï¼šæœ¬æ•™ç¨‹ä»‹ç»äº†æ„å»º LangGraph Chain çš„å››å¤§æ ¸å¿ƒæ¦‚å¿µï¼šæ¶ˆæ¯ç³»ç»Ÿã€èŠå¤©æ¨¡å‹ã€å·¥å…·ç»‘å®šå’ŒçŠ¶æ€ç®¡ç†ã€‚è¿™äº›æ˜¯æ„å»ºå¤æ‚ AI ç³»ç»Ÿçš„åŸºç¡€ï¼ŒæŒæ¡è¿™äº›æ¦‚å¿µåï¼Œä½ å°±å¯ä»¥å¼€å§‹æ„å»ºæ›´å¼ºå¤§çš„ LangGraph åº”ç”¨äº†ï¼
