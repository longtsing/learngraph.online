# Deep Agents æ·±åº¦æ™ºèƒ½ä½“

> æ·±åº¦æ™ºèƒ½ä½“ï¼ˆDeep Agentsï¼‰æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºç”Ÿäº§çº§æ™ºèƒ½ä½“çš„åº“ï¼ŒåŸºäº LangGraph æ„å»ºã€‚

## æ¦‚è¿°

`deepagents` æ˜¯ä¸€ä¸ªé«˜çº§æ™ºèƒ½ä½“æ¡†æ¶ï¼ŒåŸºäº LangGraph æ„å»ºã€‚å®ƒæ±²å–äº† Claude Code å’Œ Deep Research ç­‰äº§å“çš„ç»éªŒï¼Œæä¾›äº†æ„å»ºå¯é ç”Ÿäº§çº§æ™ºèƒ½ä½“çš„æœ€ä½³å®è·µã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© Deep Agents

Deep Agents æä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

- **ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ**ï¼šå†…ç½®å¾…åŠäº‹é¡¹è¿½è¸ª
- **æ–‡ä»¶ç³»ç»Ÿæ“ä½œ**ï¼šå®Œæ•´çš„æ–‡ä»¶è¯»å†™èƒ½åŠ›
- **å­æ™ºèƒ½ä½“æ¶æ„**ï¼šæ”¯æŒåµŒå¥—å’Œå§”æ‰˜
- **é•¿æœŸè®°å¿†**ï¼šè·¨ä¼šè¯çš„æŒä¹…åŒ–å­˜å‚¨

è¿™äº›åŠŸèƒ½ç»„åˆæ¯”å•ç‹¬ä½¿ç”¨ LangChain çš„ `create_agent` æˆ– LangGraph æ›´åŠ å¼ºå¤§ã€‚

### æ¶æ„æ€»è§ˆ

![Deep Agent æ¶æ„æ€»è§ˆ](./images/deep-agent-architecture.png)

```mermaid
graph TD
    A[Deep Agent] --> B[ä»»åŠ¡ç®¡ç†]
    A --> C[æ–‡ä»¶ç³»ç»Ÿ]
    A --> D[å­æ™ºèƒ½ä½“]
    A --> E[è®°å¿†]

    B --> B1[write_todos å·¥å…·]
    B --> B2[çŠ¶æ€è¿½è¸ª]
    B --> B3[è¿›åº¦æŠ¥å‘Š]

    C --> C1[ls - åˆ—ç›®å½•]
    C --> C2[read_file - è¯»æ–‡ä»¶]
    C --> C3[write_file - å†™æ–‡ä»¶]
    C --> C4[edit_file - ç¼–è¾‘]

    D --> D1[task å·¥å…·]
    D --> D2[ä¸Šä¸‹æ–‡éš”ç¦»]
    D --> D3[å¹¶è¡Œæ‰§è¡Œ]

    E --> E1[LangGraph Store]
    E --> E2[è·¯å¾„è·¯ç”±]
```

| ç»„ä»¶ | è¯´æ˜ | ç›¸å…³å·¥å…· |
|------|------|----------|
| **ä»»åŠ¡ç®¡ç†** | æ™ºèƒ½ä½“ä½¿ç”¨ `write_todos` å·¥å…·æ¥è§„åˆ’ä»»åŠ¡ã€è¿½è¸ªè¿›åº¦ã€æ›´æ–°çŠ¶æ€ | `write_todos` |
| **æ–‡ä»¶ç³»ç»Ÿ** | ä¸€å¥—å®Œæ•´çš„å·¥å…·è®©æ™ºèƒ½ä½“èƒ½å¤Ÿæµè§ˆæ–‡ä»¶ã€è¯»å–å†…å®¹ã€åˆ›å»ºå’Œç¼–è¾‘æ–‡ä»¶ | `ls`, `read_file`, `write_file`, `edit_file` |
| **å­æ™ºèƒ½ä½“** | é€šè¿‡ `task` å·¥å…·å…è®¸æ™ºèƒ½ä½“åˆ›å»ºå­æ™ºèƒ½ä½“ï¼Œæ¯ä¸ªå­æ™ºèƒ½ä½“æœ‰ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡å’Œå·¥å…· | `task` |
| **è®°å¿†** | ä½¿ç”¨ LangGraph Store å®ç°è·¨ä¼šè¯çš„æŒä¹…åŒ–å­˜å‚¨ | `StoreBackend` |

---

## å¿«é€Ÿå¼€å§‹

### å®‰è£…

**ä½¿ç”¨ pip:**
```bash
pip install deepagents tavily-python
```

**ä½¿ç”¨ uv:**
```bash
uv add deepagents tavily-python
```

**ä½¿ç”¨ poetry:**
```bash
poetry add deepagents tavily-python
```

### è®¾ç½® API Key

```bash
export ANTHROPIC_API_KEY="your-api-key"
export TAVILY_API_KEY="your-tavily-api-key"
```

### åˆ›å»ºç¬¬ä¸€ä¸ª Deep Agent

ä¸‹é¢æ˜¯ä¸€ä¸ªå¸¦ç½‘ç»œæœç´¢åŠŸèƒ½çš„ç ”ç©¶æ™ºèƒ½ä½“ï¼š

```python
import os
from typing import Literal
from tavily import TavilyClient
from deepagents import create_deep_agent

# åˆå§‹åŒ–æœç´¢å®¢æˆ·ç«¯
tavily_client = TavilyClient(api_key=os.environ["TAVILY_API_KEY"])

# å®šä¹‰æœç´¢å·¥å…·
def internet_search(
    query: str,
    max_results: int = 5,
    topic: Literal["general", "news", "finance"] = "general",
    include_raw_content: bool = False,
):
    """Run a web search"""
    return tavily_client.search(
        query,
        max_results=max_results,
        include_raw_content=include_raw_content,
        topic=topic,
    )

# å®šä¹‰ç³»ç»Ÿæç¤º
research_instructions = """You are an expert researcher. Your job is to conduct thorough research and then write a polished report.

You have access to an internet search tool as your primary means of gathering information.

## `internet_search`

Use this to run an internet search for a given query. You can specify the max number of results to return, the topic, and whether raw content should be included.
"""

# åˆ›å»º Deep Agent
agent = create_deep_agent(
    tools=[internet_search],
    system_prompt=research_instructions
)

# è¿è¡Œæ™ºèƒ½ä½“
result = agent.invoke({"messages": [{"role": "user", "content": "What is langgraph?"}]})
print(result["messages"][-1].content)
```

### Deep Agent çš„æ‰§è¡Œæµç¨‹

1. **æ¥æ”¶è¾“å…¥** - è§£æç”¨æˆ·æ¶ˆæ¯å’Œå†å²è®°å½•
2. **è§„åˆ’** - ä½¿ç”¨å·¥å…·åˆ†è§£ä»»åŠ¡
3. **æ–‡ä»¶æ“ä½œ** - è¯»å†™å¿…è¦çš„æ–‡ä»¶
4. **å­æ™ºèƒ½ä½“è°ƒç”¨** - å°†å¤æ‚ä»»åŠ¡å§”æ‰˜ç»™å­æ™ºèƒ½ä½“
5. **è¾“å‡º** - ç”Ÿæˆæœ€ç»ˆå“åº”

---

## è‡ªå®šä¹‰é…ç½®

### é…ç½®æ¶æ„

![Deep Agent é…ç½®æ¶æ„](./images/deep-agent-config-architecture.png)

```mermaid
graph LR
    A[create_deep_agent] --> B[Core Config]
    A --> C[Features]

    B --> B1[Model]
    B --> B2[System Prompt]
    B --> B3[Tools]

    C --> C1[Backend]
    C --> C2[Subagents]
    C --> C3[Interrupts]

    B1 --> D[Customized Agent]
    B2 --> D
    B3 --> D
    C1 --> D
    C2 --> D
    C3 --> D
```

### æ¨¡å‹é…ç½®

é»˜è®¤æƒ…å†µä¸‹ï¼Œdeepagents ä½¿ç”¨ `"claude-sonnet-4-5-20250929"`ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ LangChain æ¨¡å‹å¯¹è±¡ï¼š

```python
from langchain.chat_models import init_chat_model
from deepagents import create_deep_agent

model = init_chat_model(
    model="gpt-4o",
)
agent = create_deep_agent(
    model=model,
)
```

### ç³»ç»Ÿæç¤º

Deep Agent ç±»ä¼¼ Claude Codeï¼Œä½ å¯ä»¥æä¾›ç³»ç»Ÿæç¤ºæ¥å®šä¹‰æ™ºèƒ½ä½“çš„è¡Œä¸ºå’Œä¸ªæ€§ï¼š

```python
from deepagents import create_deep_agent

research_instructions = """\
You are an expert researcher. Your job is to conduct \
thorough research, and then write a polished report. \
"""

agent = create_deep_agent(
    system_prompt=research_instructions,
)
```

### è‡ªå®šä¹‰å·¥å…·

æ™ºèƒ½ä½“å¯ä»¥è®¿é—®ä»»æ„å·¥å…·ã€‚é»˜è®¤æƒ…å†µä¸‹æä¾›å†…ç½®å·¥å…·ï¼š

```python
import os
from typing import Literal
from tavily import TavilyClient
from deepagents import create_deep_agent

tavily_client = TavilyClient(api_key=os.environ["TAVILY_API_KEY"])

def internet_search(
    query: str,
    max_results: int = 5,
    topic: Literal["general", "news", "finance"] = "general",
    include_raw_content: bool = False,
):
    """Run a web search"""
    return tavily_client.search(
        query,
        max_results=max_results,
        include_raw_content=include_raw_content,
        topic=topic,
    )

agent = create_deep_agent(
    tools=[internet_search]
)
```

### å†…ç½®å·¥å…·ä¸€è§ˆ

| å·¥å…· | è¯´æ˜ |
|------|------|
| `write_todos` | ç®¡ç†æ™ºèƒ½ä½“çš„ä»»åŠ¡å¾…åŠåˆ—è¡¨ |
| `ls` | åˆ—å‡ºç›®å½•å†…å®¹ |
| `read_file` | è¯»å–æ–‡ä»¶å†…å®¹ |
| `write_file` | åˆ›å»ºæ–°æ–‡ä»¶ |
| `edit_file` | ä¿®æ”¹ç°æœ‰æ–‡ä»¶ |
| `task` | å§”æ‰˜å­æ™ºèƒ½ä½“æ‰§è¡Œç‰¹å®šä»»åŠ¡ |

---

## Agent Harnessï¼ˆæ™ºèƒ½ä½“æ¡†æ¶ï¼‰

`deepagents` æ¡†æ¶æä¾›äº†æ™ºèƒ½ä½“æ‰§è¡Œçš„æ ¸å¿ƒæ¶æ„ï¼ŒåŒ…å«ä¸€ç³»åˆ—å¸¸ç”¨åŠŸèƒ½ï¼š

### æ–‡ä»¶ç³»ç»Ÿèƒ½åŠ›

æ ¸å¿ƒå·¥å…·å’ŒåŠŸèƒ½ï¼š

| å·¥å…· | è¯´æ˜ |
|------|------|
| `ls` | åˆ—å‡ºæŒ‡å®šè·¯å¾„çš„å†…å®¹ |
| `read_file` | è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒåˆ†é¡µ |
| `write_file` | åˆ›å»ºæ–°æ–‡ä»¶ |
| `edit_file` | åŸºäºå­—ç¬¦ä¸²æ›¿æ¢çš„ç¼–è¾‘ |
| `glob` | æŒ‰æ¨¡å¼åŒ¹é…æŸ¥æ‰¾æ–‡ä»¶ |
| `grep` | æœç´¢æ–‡ä»¶å†…å®¹ |

### æ–‡ä»¶å·¥å…·è¾“å‡ºé™åˆ¶

æ‰€æœ‰å·¥å…·è¾“å‡ºéƒ½æœ‰æœ€å¤§é•¿åº¦é™åˆ¶ï¼Œé˜²æ­¢è¿‡é•¿çš„è¾“å‡ºè€—å°½ä¸Šä¸‹æ–‡ã€‚
è¾“å‡ºé™åˆ¶çº¦ä¸ºï¼š**20,000 tokens**ã€‚è¶…è¿‡æ­¤é™åˆ¶çš„å†…å®¹ä¼šè¢«æˆªæ–­ã€‚

### ä¸Šä¸‹æ–‡çª—å£ç®¡ç†

å½“ä¸Šä¸‹æ–‡è¶…è¿‡ **170,000 tokens** æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘å‹ç¼©ã€‚æœ€è¿‘ 6 æ¡æ¶ˆæ¯ä¼šè¢«ä¿ç•™ï¼Œè¾ƒæ—©çš„æ¶ˆæ¯ä¼šè¢«å‹ç¼©ã€‚

### å·¥å…·ä½¿ç”¨é™åˆ¶

æœ‰å¤šç§é™åˆ¶æœºåˆ¶é˜²æ­¢å·¥å…·çš„è¿‡åº¦ä½¿ç”¨ï¼Œé¿å…æ— é™å¾ªç¯æˆ–å¤±æ§è¡Œä¸ºã€‚

### ä»»åŠ¡åˆ—è¡¨ç®¡ç†

`write_todos` å·¥å…·æ”¯æŒçš„ä»»åŠ¡çŠ¶æ€ï¼š
- `pending` - å¾…å¤„ç†
- `in_progress` - è¿›è¡Œä¸­
- `completed` - å·²å®Œæˆ

### å®‰å…¨è€ƒè™‘

Anthropic å®æ–½äº†å¤šå±‚å®‰å…¨æªæ–½æ¥æ§åˆ¶æ™ºèƒ½ä½“è¡Œä¸ºï¼Œé˜²æ­¢æ»¥ç”¨ã€‚

---

## åç«¯ç³»ç»Ÿï¼ˆBackendsï¼‰

Deep Agent çš„åç«¯ç³»ç»Ÿæä¾›çµæ´»çš„å­˜å‚¨æ–¹æ¡ˆï¼Œæ»¡è¶³ä¸åŒéœ€æ±‚ã€‚

![Backend Architecture](./images/deep-agent-backend-architecture.png)

### æ¶æ„å›¾

```mermaid
graph TD
    A[Filesystem Tools] --> B[Backend Layer]
    B --> C[StateBackend]
    B --> D[FilesystemBackend]
    B --> E[StoreBackend]
    B --> F[CompositeBackend]
    B --> G[Custom Backend]

    F --> F1[Routes]
    F1 --> C
    F1 --> E
```

### åç«¯ç±»å‹å¯¹æ¯”

| åç«¯ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| é»˜è®¤ | `create_deep_agent()` | ä¸´æ—¶ä¼šè¯ï¼Œä¸éœ€è¦æŒä¹…åŒ–æˆ–è·¨ä¼šè¯å­˜å‚¨ |
| çœŸå®æ–‡ä»¶ç³»ç»Ÿ | `FilesystemBackend(root_dir="/path")` | éœ€è¦çœŸå®æ–‡ä»¶æ“ä½œï¼Œå¦‚ä»£ç ä¿®æ”¹ |
| å­˜å‚¨åç«¯ | `StoreBackend(rt)` | éœ€è¦æŒä¹…åŒ–çš„è·¨ä¼šè¯æ•°æ® |
| ç»„åˆåç«¯ | Multiple routes | æ ¹æ®è·¯å¾„é€‰æ‹©ä¸åŒå­˜å‚¨ |

### StateBackendï¼ˆä¸´æ—¶ä¼šè¯ï¼‰

```python
agent = create_deep_agent()

# ç­‰ä»·äº
from deepagents.backends import StateBackend
agent = create_deep_agent(
    backend=(lambda rt: StateBackend(rt))
)
```

**ç‰¹ç‚¹ï¼š** çŠ¶æ€ä¿å­˜åœ¨ LangGraph æ™ºèƒ½ä½“çš„å†…å­˜ä¸­ï¼Œä¸æŒä¹…åŒ–ã€‚

**ç”¨é€”ï¼š** ä¸´æ—¶ä»»åŠ¡ï¼Œæ— éœ€ä¿å­˜å†å²ã€‚

### FilesystemBackendï¼ˆçœŸå®æ–‡ä»¶ï¼‰

```python
from deepagents.backends import FilesystemBackend

agent = create_deep_agent(
    backend=FilesystemBackend(root_dir=".", virtual_mode=True)
)
```

**ç‰¹ç‚¹ï¼š** ç›´æ¥æ“ä½œæŒ‡å®š `root_dir` ä¸‹çš„æ–‡ä»¶ã€‚`virtual_mode=True` æ—¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒï¼Œæ”¯æŒ ripgrep ç­‰å·¥å…·ã€‚

**ç”¨é€”ï¼š** çœŸå®é¡¹ç›®å¼€å‘ï¼Œä»£ç ä¿®æ”¹ç­‰ä»»åŠ¡ã€‚

### StoreBackendï¼ˆLangGraph Storeï¼‰

```python
from langgraph.store.memory import InMemoryStore
from deepagents.backends import StoreBackend

agent = create_deep_agent(
    backend=(lambda rt: StoreBackend(rt)),
    store=InMemoryStore()
)
```

**ç‰¹ç‚¹ï¼š** ä¿å­˜åˆ° LangGraph `BaseStore` ä¸­ï¼Œå¯æŒä¹…åŒ–å­˜å‚¨ã€‚

**ç”¨é€”ï¼š** é…ç½® LangGraph æŒä¹…åŒ–å­˜å‚¨ï¼ˆRedisã€Postgresç­‰ï¼‰ï¼Œæˆ–è€…åœ¨é…ç½® LangSmith æ—¶ä½¿ç”¨ã€‚

### CompositeBackendï¼ˆç»„åˆåç«¯ï¼‰

```python
from deepagents import create_deep_agent
from deepagents.backends import CompositeBackend, StateBackend, StoreBackend
from langgraph.store.memory import InMemoryStore

composite_backend = lambda rt: CompositeBackend(
    default=StateBackend(rt),
    routes={
        "/memories/": StoreBackend(rt),
    }
)

agent = create_deep_agent(
    backend=composite_backend,
    store=InMemoryStore()
)
```

**ç‰¹ç‚¹ï¼š** æ ¹æ®è·¯å¾„å°†è¯·æ±‚è·¯ç”±åˆ°ä¸åŒåç«¯ã€‚

**ç”¨é€”ï¼š** ä¸´æ—¶æ–‡ä»¶ç”¨ä¼šè¯å­˜å‚¨ï¼ŒæŒä¹…æ•°æ®ç”¨é•¿æœŸå­˜å‚¨ã€‚

### ç»„åˆé…ç½®ç¤ºä¾‹

```python
from deepagents import create_deep_agent
from deepagents.backends import CompositeBackend, StateBackend, FilesystemBackend

composite_backend = lambda rt: CompositeBackend(
    default=StateBackend(rt),
    routes={
        "/memories/": FilesystemBackend(root_dir="/deepagents/myagent", virtual_mode=True),
    },
)

agent = create_deep_agent(backend=composite_backend)
```

**è·¯ç”±é€»è¾‘:**
- `/workspace/plan.md` â†’ StateBackendï¼ˆä¸´æ—¶ï¼‰
- `/memories/agent.md` â†’ FilesystemBackendï¼ˆæŒä¹…ï¼‰
- ä¸åŒè·¯å¾„ä½¿ç”¨ä¸åŒå­˜å‚¨
- çµæ´»åº”å¯¹å„ç§åœºæ™¯

### è‡ªå®šä¹‰ S3 åç«¯ç¤ºä¾‹

```python
from deepagents.backends.protocol import BackendProtocol, WriteResult, EditResult
from deepagents.backends.utils import FileInfo, GrepMatch

class S3Backend(BackendProtocol):
    def __init__(self, bucket: str, prefix: str = ""):
        self.bucket = bucket
        self.prefix = prefix.rstrip("/")

    def _key(self, path: str) -> str:
        return f"{self.prefix}{path}"

    def ls_info(self, path: str) -> list[FileInfo]:
        # List objects; build FileInfo entries
        ...

    def read(self, file_path: str, offset: int = 0, limit: int = 2000) -> str:
        # Fetch object; return numbered content or error
        ...

    def grep_raw(self, pattern: str, path: str | None = None, glob: str | None = None) -> list[GrepMatch] | str:
        # Filter server-side or list and scan
        ...

    def glob_info(self, pattern: str, path: str = "/") -> list[FileInfo]:
        # Apply glob across keys
        ...

    def write(self, file_path: str, content: str) -> WriteResult:
        # Create-only semantics
        return WriteResult(path=file_path, files_update=None)

    def edit(self, file_path: str, old_string: str, new_string: str, replace_all: bool = False) -> EditResult:
        # Read â†’ replace â†’ write
        ...
```

### é«˜çº§ç¤ºä¾‹ - å†™ä¿æŠ¤

```python
from deepagents.backends.filesystem import FilesystemBackend
from deepagents.backends.protocol import WriteResult, EditResult

class GuardedBackend(FilesystemBackend):
    def __init__(self, *, deny_prefixes: list[str], **kwargs):
        super().__init__(**kwargs)
        self.deny_prefixes = [p if p.endswith("/") else p + "/" for p in deny_prefixes]

    def write(self, file_path: str, content: str) -> WriteResult:
        if any(file_path.startswith(p) for p in self.deny_prefixes):
            return WriteResult(error=f"Writes are not allowed under {file_path}")
        return super().write(file_path, content)

    def edit(self, file_path: str, old_string: str, new_string: str, replace_all: bool = False) -> EditResult:
        if any(file_path.startswith(p) for p in self.deny_prefixes):
            return EditResult(error=f"Edits are not allowed under {file_path}")
        return super().edit(file_path, old_string, new_string, replace_all)
```

### é«˜çº§ç¤ºä¾‹ - é€šç”¨ç­–ç•¥åŒ…è£…

```python
from deepagents.backends.protocol import BackendProtocol, WriteResult, EditResult
from deepagents.backends.utils import FileInfo, GrepMatch

class PolicyWrapper(BackendProtocol):
    def __init__(self, inner: BackendProtocol, deny_prefixes: list[str] | None = None):
        self.inner = inner
        self.deny_prefixes = [p if p.endswith("/") else p + "/" for p in (deny_prefixes or [])]

    def _deny(self, path: str) -> bool:
        return any(path.startswith(p) for p in self.deny_prefixes)

    def ls_info(self, path: str) -> list[FileInfo]:
        return self.inner.ls_info(path)

    def read(self, file_path: str, offset: int = 0, limit: int = 2000) -> str:
        return self.inner.read(file_path, offset=offset, limit=limit)

    def grep_raw(self, pattern: str, path: str | None = None, glob: str | None = None) -> list[GrepMatch] | str:
        return self.inner.grep_raw(pattern, path, glob)

    def glob_info(self, pattern: str, path: str = "/") -> list[FileInfo]:
        return self.inner.glob_info(pattern, path)

    def write(self, file_path: str, content: str) -> WriteResult:
        if self._deny(file_path):
            return WriteResult(error=f"Writes are not allowed under {file_path}")
        return self.inner.write(file_path, content)

    def edit(self, file_path: str, old_string: str, new_string: str, replace_all: bool = False) -> EditResult:
        if self._deny(file_path):
            return EditResult(error=f"Edits are not allowed under {file_path}")
        return self.inner.edit(file_path, old_string, new_string, replace_all)
```

### BackendProtocol æ¥å£è¯´æ˜

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `ls_info` | `(path: str) -> list[FileInfo]` | åˆ—å‡ºæŒ‡å®š `path` ä¸‹çš„æ–‡ä»¶å’Œç›®å½• |
| `read` | `(file_path: str, offset: int = 0, limit: int = 2000) -> str` | è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒåˆ†é¡µ |
| `grep_raw` | `(pattern: str, path: Optional[str] = None, glob: Optional[str] = None) -> list[GrepMatch] \| str` | æœç´¢æ–‡ä»¶å†…å®¹åŒ¹é… |
| `glob_info` | `(pattern: str, path: str = "/") -> list[FileInfo]` | æŒ‰æ¨¡å¼åŒ¹é…è¿”å› FileInfo |
| `write` | `(file_path: str, content: str) -> WriteResult` | åˆ›å»ºæ–°æ–‡ä»¶ |
| `edit` | `(file_path: str, old_string: str, new_string: str, replace_all: bool = False) -> EditResult` | æ›¿æ¢æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒ `replace_all=True` |

---

## å­æ™ºèƒ½ä½“ï¼ˆSubagentsï¼‰

å­æ™ºèƒ½ä½“å…è®¸ Deep Agent å°†å¤æ‚ä»»åŠ¡å§”æ‰˜ç»™ä¸“é—¨åŒ–çš„æ™ºèƒ½ä½“ã€‚æ¯ä¸ªå­æ™ºèƒ½ä½“å¯ä»¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å·¥å…·ã€æç¤ºå’Œæ¨¡å‹ï¼Œåœ¨éš”ç¦»çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œå®Œæˆåå°†ç»“æœè¿”å›ç»™ä¸»æ™ºèƒ½ä½“ã€‚

### å­æ™ºèƒ½ä½“æ¶æ„

![å­æ™ºèƒ½ä½“æ¶æ„](./images/deep-agent-subagent-architecture.png)

```mermaid
graph TD
    A[Main Agent] --> B[Delegation]
    B --> C[Research Subagent]
    B --> D[Code Subagent]
    B --> E[General Subagent]

    C --> C1[Isolated Work]
    D --> D1[Isolated Work]
    E --> E1[Isolated Work]

    C1 --> F[Final Result]
    D1 --> F
    E1 --> F

    F --> A
```

### ä½•æ—¶ä½¿ç”¨å­æ™ºèƒ½ä½“

**é€‚åˆä½¿ç”¨ï¼š**
- éœ€è¦å¤„ç†å¤šä¸ªç‹¬ç«‹çš„ä¸“ä¸šé¢†åŸŸ
- å¸Œæœ›éš”ç¦»ä¸åŒä»»åŠ¡çš„ä¸Šä¸‹æ–‡
- éœ€è¦ä½¿ç”¨ä¸åŒæ¨¡å‹å¤„ç†ä¸åŒä»»åŠ¡
- ä¸»æ™ºèƒ½ä½“ä»»åŠ¡è¿‡äºå¤æ‚

**ä¸é€‚åˆï¼š**
- ç®€å•çš„å•ä¸€ä»»åŠ¡
- éœ€è¦é¢‘ç¹çš„ä¸Šä¸‹æ–‡å…±äº«
- æ‰€æœ‰ä»»åŠ¡ä½¿ç”¨ç›¸åŒå·¥å…·

### é…ç½®é€‰é¡¹

#### SubAgentï¼ˆå­—å…¸ï¼‰

**å¿…éœ€å­—æ®µï¼š**
- `name`: å”¯ä¸€çš„ä¼šè¯çº§åç§°
- `description`: å¸®åŠ©ä¸»æ™ºèƒ½ä½“ç†è§£ä½•æ—¶åº”è¯¥ä½¿ç”¨
- `system_prompt`: ä¸“é—¨çš„è¡Œä¸ºå’Œé£æ ¼é…ç½®
- `tools`: å­æ™ºèƒ½ä½“ä¸“å±çš„å·¥å…·åˆ—è¡¨

**å¯é€‰å­—æ®µï¼š**
- `model`: ä¸ºå­æ™ºèƒ½ä½“æŒ‡å®šä¸åŒæ¨¡å‹ï¼ˆæ ¼å¼ `"provider:model-name"`ï¼‰
- `middleware`: é…ç½®ä¸­é—´ä»¶ï¼Œå¦‚å¾…åŠäº‹é¡¹ç®¡ç†
- `interrupt_on`: Human-in-the-loop é…ç½®ï¼ˆéœ€è¦ checkpointerï¼‰

#### CompiledSubAgentï¼ˆç¼–è¯‘åï¼‰

ç›´æ¥ä¼ å…¥å·²æœ‰çš„ LangGraph ç¼–è¯‘å›¾ï¼š
- `name`: å”¯ä¸€åç§°
- `description`: åŠŸèƒ½æè¿°
- `runnable`: å·²ç¼–è¯‘çš„ LangGraph å›¾ï¼ˆä½¿ç”¨ `.compile()`ï¼‰

### åˆ›å»ºå­æ™ºèƒ½ä½“ç¤ºä¾‹

```python
import os
from typing import Literal
from tavily import TavilyClient
from deepagents import create_deep_agent

tavily_client = TavilyClient(api_key=os.environ["TAVILY_API_KEY"])

def internet_search(
    query: str,
    max_results: int = 5,
    topic: Literal["general", "news", "finance"] = "general",
    include_raw_content: bool = False,
):
    """Run a web search"""
    return tavily_client.search(
        query,
        max_results=max_results,
        include_raw_content=include_raw_content,
        topic=topic,
    )

# å®šä¹‰ç ”ç©¶å­æ™ºèƒ½ä½“
research_subagent = {
    "name": "research-agent",
    "description": "Used to research more in depth questions",
    "system_prompt": "You are a great researcher",
    "tools": [internet_search],
    "model": "openai:gpt-4o",
}

subagents = [research_subagent]

# å°†å­æ™ºèƒ½ä½“æ·»åŠ åˆ° Deep Agent
agent = create_deep_agent(
    model="claude-sonnet-4-5-20250929",
    subagents=subagents
)
```

### CompiledSubAgent ç¤ºä¾‹

```python
from deepagents import create_deep_agent, CompiledSubAgent
from langchain.agents import create_agent

# åˆ›å»ºè‡ªå®šä¹‰å›¾
custom_graph = create_agent(
    model=your_model,
    tools=specialized_tools,
    prompt="You are a specialized agent for data analysis..."
)

# åŒ…è£…ä¸º CompiledSubAgent
custom_subagent = CompiledSubAgent(
    name="data-analyzer",
    description="Specialized agent for complex data analysis tasks",
    runnable=custom_graph
)

subagents = [custom_subagent]

agent = create_deep_agent(
    model="claude-sonnet-4-5-20250929",
    tools=[internet_search],
    system_prompt=research_instructions,
    subagents=subagents
)
```

### ä½¿ç”¨å­æ™ºèƒ½ä½“

ä¸»æ™ºèƒ½ä½“é€šè¿‡ Deep Agent å†…ç½®çš„ `task` å·¥å…·è°ƒç”¨å­æ™ºèƒ½ä½“ï¼š
- ä¸»æ™ºèƒ½ä½“æè¿°éœ€è¦å®Œæˆçš„ä»»åŠ¡
- é€‰æ‹©åˆé€‚çš„å­æ™ºèƒ½ä½“æ‰§è¡Œ
- æ¥æ”¶å¹¶æ•´åˆç»“æœ

å­æ™ºèƒ½ä½“ä¼šåœ¨ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚

### æœ€ä½³å®è·µ

**æ¸…æ™°çš„æè¿°**
```
âœ“ "Analyzes financial data and generates investment insights with confidence scores"
âœ— "Does finance stuff"
```

**ä¸“æ³¨çš„åŠŸèƒ½èŒƒå›´ï¼š** è®©å­æ™ºèƒ½ä½“ä¸“æ³¨äºç‰¹å®šé¢†åŸŸï¼Œè€Œä¸æ˜¯æˆä¸ºé€šç”¨åŠ©æ‰‹ã€‚

**åˆç†çš„å·¥å…·é…ç½®ï¼š** åªæä¾›å­æ™ºèƒ½ä½“çœŸæ­£éœ€è¦çš„å·¥å…·ï¼Œé¿å…è¿‡è½½ã€‚

**ç‹¬ç«‹çš„æ¨¡å‹é€‰æ‹©ï¼š** æ ¹æ®ä»»åŠ¡å¤æ‚åº¦ä¸ºå­æ™ºèƒ½ä½“é€‰æ‹©åˆé€‚çš„æ¨¡å‹ã€‚

**éš”ç¦»çš„ä¸Šä¸‹æ–‡ï¼š** ä¸ºå­æ™ºèƒ½ä½“è®¾ç½®æ¸…æ™°çš„ä¼šè¯è¾¹ç•Œã€‚

### å¸¸è§é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| å­æ™ºèƒ½ä½“æœªè¢«è°ƒç”¨ | æ£€æŸ¥å·¥å…·æè¿°æ˜¯å¦æ¸…æ™°ï¼Œä¸»æ™ºèƒ½ä½“æ˜¯å¦ç†è§£ä½•æ—¶ä½¿ç”¨ |
| ä¸Šä¸‹æ–‡æ³„éœ² | ç¡®è®¤å­æ™ºèƒ½ä½“é…ç½®äº†ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡å’Œå·¥å…· |
| æ€§èƒ½é—®é¢˜ | è€ƒè™‘ä¸ºç®€å•ä»»åŠ¡ä½¿ç”¨è½»é‡çº§æ¨¡å‹ |

---

## Human-in-the-Loopï¼ˆäººæœºåä½œï¼‰

ä½¿ç”¨ LangGraph çš„ä¸­æ–­åŠŸèƒ½ï¼Œå¯ä»¥åœ¨å…³é”®å·¥å…·è°ƒç”¨å‰æš‚åœæ‰§è¡Œï¼Œç­‰å¾…äººå·¥å®¡æ‰¹ã€‚

![Human-in-the-Loop æµç¨‹](./images/deep-agent-human-in-the-loop.png)

### åŸºæœ¬é…ç½®

`interrupt_on` å‚æ•°æ§åˆ¶å·¥å…·è°ƒç”¨çš„ä¸­æ–­è¡Œä¸ºï¼š
- `True`: æ‰€æœ‰å·¥å…·è°ƒç”¨éƒ½ä¼šè§¦å‘ä¸­æ–­ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä»…åœ¨å±é™©æ“ä½œæ—¶ï¼‰
- `False`: ç¦ç”¨ä¸­æ–­
- `{"allowed_decisions": [...]}`: è‡ªå®šä¹‰é…ç½®å…è®¸çš„å†³ç­–ç±»å‹

> âš ï¸ **é‡è¦æç¤ºï¼š** Human-in-the-loop åŠŸèƒ½**å¿…é¡»**é…åˆ checkpointer ä½¿ç”¨ï¼Œå¦åˆ™æ— æ³•ä¿å­˜çŠ¶æ€ã€‚

### å†³ç­–é€‰é¡¹

æ‰€æœ‰å¾…å®¡æ‰¹çš„å·¥å…·è°ƒç”¨éƒ½å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

| å†³ç­– | è¯´æ˜ |
|------|------|
| **Approve** | å…è®¸æ™ºèƒ½ä½“æŒ‰åŸè®¡åˆ’æ‰§è¡Œ |
| **Edit** | åœ¨æ‰§è¡Œå‰ä¿®æ”¹å·¥å…·å‚æ•° |
| **Reject** | é˜»æ­¢è¯¥å·¥å…·æ‰§è¡Œ |

### å®ç°æµç¨‹

åŸºæœ¬æµç¨‹ï¼š
1. æ£€æŸ¥ `result.get("__interrupt__")` åˆ¤æ–­æ˜¯å¦éœ€è¦å®¡æ‰¹
2. è·å–ä¸­æ–­ä¿¡æ¯ä¸­çš„ `action_requests` å’Œ `review_configs`
3. åˆ†ææ¯ä¸ªè¯·æ±‚å¹¶åšå‡ºå†³ç­–
4. ä½¿ç”¨ `Command(resume={"decisions": decisions})` ç»§ç»­

### å¤šå·¥å…·å¤„ç†

å½“å¤šä¸ªå·¥å…·éœ€è¦å®¡æ‰¹æ—¶ï¼Œéœ€è¦ä¸ºæ¯ä¸ªå·¥å…·æä¾›å†³ç­–ã€‚`action_requests` ä¸­ä¼šåŒ…å«æ™ºèƒ½ä½“è¯·æ±‚çš„æ‰€æœ‰å·¥å…·è°ƒç”¨ã€‚

### ç¼–è¾‘å‚æ•°

å½“é€‰æ‹© "edit" å†³ç­–æ—¶ï¼Œéœ€è¦æä¾›ä¿®æ”¹åçš„å‚æ•°ï¼š

```python
{
    "decision": "edit",
    "edited_action": {
        "name": action_request["name"],
        "args": {
            # ä¿®æ”¹åçš„å‚æ•°
        }
    }
}
```

### å­æ™ºèƒ½ä½“ä¸­æ–­

å­æ™ºèƒ½ä½“ä¹Ÿå¯ä»¥ç‹¬ç«‹é…ç½®ä¸­æ–­è¡Œä¸ºï¼Œç»§æ‰¿ä¸»æ™ºèƒ½ä½“çš„ `interrupt_on` é…ç½®ã€‚

### æœ€ä½³å®è·µ

- å¿…é¡»ä½¿ç”¨ checkpointerï¼ˆå¦‚ `MemorySaver()`ï¼‰
- åœ¨ invoke å’Œ resume é—´ä¿æŒç›¸åŒçš„ `thread_id`
- å¤„ç†æ‰€æœ‰ `action_requests` ä¸­çš„å†³ç­–
- é…ç½®åˆç†çš„ä¸­æ–­ç­–ç•¥ï¼šé«˜é£é™©å·¥å…·ä¸­æ–­ï¼Œä½é£é™©å·¥å…·è·³è¿‡

---

## é•¿æœŸè®°å¿†

ä½¿ç”¨ `CompositeBackend` å®ç°è·¨ä¼šè¯çš„æŒä¹…åŒ–å­˜å‚¨ã€‚

### æ¶æ„å›¾

![é•¿æœŸè®°å¿†æ¶æ„](./images/deep-agent-path-router.png)

```mermaid
graph LR
    A[Deep Agent] --> B[Path Router]
    B -->|/memories/*| C[Store Backend]
    B -->|å…¶ä»–è·¯å¾„| D[State Backend]

    C --> E[æŒä¹…å­˜å‚¨]
    D --> F[ä¸´æ—¶ä¼šè¯]
```

### åŸºç¡€é…ç½®

```python
from deepagents import create_deep_agent
from deepagents.backends import CompositeBackend, StateBackend, StoreBackend
from langgraph.store.memory import InMemoryStore

def make_backend(runtime):
    return CompositeBackend(
        default=StateBackend(runtime),  # ä¸´æ—¶ä¼šè¯
        routes={
            "/memories/": StoreBackend(runtime)  # æŒä¹…å­˜å‚¨
        }
    )

agent = create_deep_agent(
    store=InMemoryStore(),  # StoreBackend éœ€è¦
    backend=make_backend
)
```

### åŠŸèƒ½è¯´æ˜

**ä¸´æ—¶æ•°æ®ï¼š**
- ä½¿ç”¨ `StateBackend` å­˜å‚¨åœ¨æ™ºèƒ½ä½“å†…å­˜ä¸­
- ä¼šè¯ç»“æŸåä¸¢å¤±
- é€‚åˆè‰ç¨¿ç­‰ä¸´æ—¶å†…å®¹
- ç¤ºä¾‹ï¼š`/notes.txt`, `/workspace/draft.md`

**æŒä¹…æ•°æ®ï¼š**
- ä½¿ç”¨ `StoreBackend` å­˜å‚¨åˆ° LangGraph Store ä¸­
- è·¨ä¼šè¯ä¿ç•™
- ä½¿ç”¨ `/memories/` å‰ç¼€ï¼Œå¦‚ï¼š`/memories/preferences.txt`

### è·¯ç”±è§„åˆ™å¯¹æ¯”

| è·¯å¾„ | å­˜å‚¨ä½ç½® |
|------|----------|
| `/memories/*` | æŒä¹…å­˜å‚¨ |
| å…¶ä»– | ä¸´æ—¶å­˜å‚¨ |

æ™ºèƒ½ä½“é€šè¿‡æ–‡ä»¶è·¯å¾„æ¥å†³å®šæ•°æ®å­˜å‚¨æ–¹å¼ã€‚

### ç¤ºä¾‹

```python
# ä¸´æ—¶æ–‡ä»¶ï¼šä¼šè¯ç»“æŸåä¸¢å¤±
agent.invoke({
    "messages": [{"role": "user", "content": "Write draft to /draft.txt"}]
})

# æŒä¹…æ–‡ä»¶ï¼šè·¨ä¼šè¯ä¿ç•™
agent.invoke({
    "messages": [{"role": "user", "content": "Save final report to /memories/report.txt"}]
})
```

### è·¨ä¼šè¯è®¿é—®

```python
import uuid

# ä¼šè¯ 1ï¼šä¿å­˜åå¥½
config1 = {"configurable": {"thread_id": str(uuid.uuid4())}}
agent.invoke({
    "messages": [{"role": "user", "content": "Save my preferences to /memories/preferences.txt"}]
}, config=config1)

# ä¼šè¯ 2ï¼šè¯»å–ä¹‹å‰ä¿å­˜çš„åå¥½
config2 = {"configurable": {"thread_id": str(uuid.uuid4())}}
agent.invoke({
    "messages": [{"role": "user", "content": "What are my preferences?"}]
}, config=config2)
```

### ä½¿ç”¨åœºæ™¯

#### ä¿å­˜ç”¨æˆ·åå¥½

```python
agent = create_deep_agent(
    store=InMemoryStore(),
    backend=lambda rt: CompositeBackend(
        default=StateBackend(rt),
        routes={"/memories/": StoreBackend(rt)}
    ),
    system_prompt="""When users tell you their preferences, save them to
    /memories/user_preferences.txt so you remember them in future conversations."""
)
```

#### è‡ªæˆ‘ä¿®æ”¹æŒ‡ä»¤

```python
agent = create_deep_agent(
    store=InMemoryStore(),
    backend=lambda rt: CompositeBackend(
        default=StateBackend(rt),
        routes={"/memories/": StoreBackend(rt)}
    ),
    system_prompt="""You have a file at /memories/instructions.txt with additional
    instructions and preferences.

    Read this file at the start of conversations to understand user preferences.

    When users provide feedback like "please always do X" or "I prefer Y",
    update /memories/instructions.txt using the edit_file tool."""
)
```

#### ç ”ç©¶é¡¹ç›®

```python
research_agent = create_deep_agent(
    store=InMemoryStore(),
    backend=lambda rt: CompositeBackend(
        default=StateBackend(rt),
        routes={"/memories/": StoreBackend(rt)}
    ),
    system_prompt="""You are a research assistant.

    Save your research progress to /memories/research/:
    - /memories/research/sources.txt - List of sources found
    - /memories/research/notes.txt - Key findings and notes
    - /memories/research/report.md - Final report draft

    This allows research to continue across multiple sessions."""
)
```

### Store é€‰é¡¹

#### InMemoryStoreï¼ˆä»…å†…å­˜ï¼‰

```python
from langgraph.store.memory import InMemoryStore

store = InMemoryStore()
agent = create_deep_agent(
    store=store,
    backend=lambda rt: CompositeBackend(
        default=StateBackend(rt),
        routes={"/memories/": StoreBackend(rt)}
    )
)
```

#### PostgresStoreï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```python
from langgraph.store.postgres import PostgresStore
import os

store = PostgresStore(connection_string=os.environ["DATABASE_URL"])
agent = create_deep_agent(
    store=store,
    backend=lambda rt: CompositeBackend(
        default=StateBackend(rt),
        routes={"/memories/": StoreBackend(rt)}
    )
)
```

### æœ€ä½³å®è·µ

- **ä½¿ç”¨æœ‰æ„ä¹‰çš„è·¯å¾„**
  - `/memories/user_preferences.txt`
  - `/memories/research/topic_a/sources.txt`
  - `/memories/project/requirements.md`

- **åœ¨ç³»ç»Ÿæç¤ºä¸­æŒ‡å¯¼æ™ºèƒ½ä½“ä½•æ—¶ä¿å­˜æ–‡ä»¶**ï¼Œé¿å…è¿‡åº¦å­˜å‚¨é…ç½®ã€‚

- **æµ‹è¯•è·¨ä¼šè¯è¡Œä¸º**ï¼Œç¡®ä¿è®°å¿†æ­£ç¡®æŒä¹…åŒ–ã€‚

- **é€‰æ‹©åˆé€‚çš„å­˜å‚¨**
  - å¼€å‘ï¼š`InMemoryStore`
  - ç”Ÿäº§ï¼š`PostgresStore` æˆ–å…¶ä»–æŒä¹…å­˜å‚¨
  - å¤šç§Ÿæˆ·ï¼šè€ƒè™‘ä½¿ç”¨ `assistant_id` æ¥éš”ç¦»

---

## ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰

Deep Agent æ”¯æŒä¸‰ç§å†…ç½®ä¸­é—´ä»¶ï¼Œå®ƒä»¬æä¾›äº†å¸¸ç”¨åŠŸèƒ½çš„å·¥å…·ã€åç«¯å­˜å‚¨å’Œå­æ™ºèƒ½ä½“æ”¯æŒã€‚

![ä¸­é—´ä»¶æ¶æ„](./images/deep-agent-middleware-architecture.png)

### ä¸‰ç§å†…ç½®ä¸­é—´ä»¶

#### 1. TodoListMiddleware

å¯ç”¨æ™ºèƒ½ä½“çš„ä»»åŠ¡ç®¡ç†èƒ½åŠ›ï¼Œç»™æ™ºèƒ½ä½“æ·»åŠ  `write_todos` å·¥å…·æ¥åˆ›å»ºå’Œç®¡ç†å¾…åŠäº‹é¡¹ã€‚

```python
from langchain.agents import create_agent
from langchain.agents.middleware import TodoListMiddleware

agent = create_agent(
    model="claude-sonnet-4-5-20250929",
    middleware=[
        TodoListMiddleware(
            system_prompt="Use the write_todos tool to..."
        ),
    ],
)
```

#### 2. FilesystemMiddleware

æä¾›æ–‡ä»¶ç³»ç»Ÿæ“ä½œçš„ä¸€å¥—å·¥å…·ï¼š`ls`ã€`read_file`ã€`write_file` å’Œ `edit_file`ã€‚

**é»˜è®¤å­˜å‚¨ï¼š** ä¼šè¯ä¸´æ—¶ã€‚**æŒä¹…å­˜å‚¨ï¼š** é…ç½® `CompositeBackend` å°† `/memories/` è·¯ç”±åˆ° `StoreBackend`ã€‚

```python
from deepagents.middleware import FilesystemMiddleware
from deepagents.backends import CompositeBackend, StateBackend, StoreBackend
from langgraph.store.memory import InMemoryStore

store = InMemoryStore()

agent = create_agent(
    model="claude-sonnet-4-5-20250929",
    store=store,
    middleware=[
        FilesystemMiddleware(
            backend=lambda rt: CompositeBackend(
                default=StateBackend(rt),
                routes={"/memories/": StoreBackend(rt)}
            ),
        ),
    ],
)
```

#### 3. SubAgentMiddleware

å­æ™ºèƒ½ä½“æ”¯æŒã€‚å…è®¸ä¸»æ™ºèƒ½ä½“åˆ›å»ºå­æ™ºèƒ½ä½“æ¥æ‰§è¡Œä»»åŠ¡ï¼Œæ¯ä¸ªå­æ™ºèƒ½ä½“æœ‰ç‹¬ç«‹çš„å·¥å…·ã€æç¤ºã€æ¨¡å‹å’Œä¸­é—´ä»¶ã€‚

```python
from langchain.tools import tool
from langchain.agents import create_agent
from deepagents.middleware.subagents import SubAgentMiddleware

@tool
def get_weather(city: str) -> str:
    """Get the weather in a city."""
    return f"The weather in {city} is sunny."

agent = create_agent(
    model="claude-sonnet-4-5-20250929",
    middleware=[
        SubAgentMiddleware(
            default_model="claude-sonnet-4-5-20250929",
            default_tools=[],
            subagents=[
                {
                    "name": "weather",
                    "description": "This subagent can get weather in cities.",
                    "system_prompt": "Use the get_weather tool...",
                    "tools": [get_weather],
                    "model": "gpt-4o",
                    "middleware": [],
                }
            ],
        )
    ],
)
```

ç¼–è¯‘åçš„å›¾ä¹Ÿå¯ä»¥é€šè¿‡ `CompiledSubAgent` ä¼ å…¥ï¼Œè®©ä½ é›†æˆä»»æ„è‡ªå®šä¹‰æ™ºèƒ½ä½“ã€‚

---

## CLI å‘½ä»¤è¡Œå·¥å…·

å‘½ä»¤è¡Œå·¥å…·æ–¹ä¾¿å¿«é€Ÿæµ‹è¯•å’Œä½¿ç”¨æ™ºèƒ½ä½“ã€‚

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **äº¤äº’å¼å¯¹è¯** | ä¸æ™ºèƒ½ä½“ç›´æ¥äº¤äº’ï¼Œæ”¯æŒå¤šè½®å¯¹è¯ |
| **Shell å‘½ä»¤æ‰§è¡Œ** | æ™ºèƒ½ä½“å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ˆå¦‚éœ€è¦ Tavily API keyï¼‰ |
| **ç½‘ç»œæœç´¢** | é…ç½® API key åå¯æœç´¢ç½‘ç»œ |
| **HTTP è¯·æ±‚** | å‘é€ API è¯·æ±‚ï¼Œæ”¯æŒ HTTP åè®® |
| **ä»»åŠ¡å’Œæ–‡ä»¶ç®¡ç†** | ç®¡ç†ä»»åŠ¡åˆ—è¡¨å’Œæ–‡ä»¶è¯»å†™æ“ä½œ |
| **è·¨ä¼šè¯è®°å¿†** | æ”¯æŒè·¨ä¼šè¯è®°å¿†å­˜å‚¨ |
| **Human-in-the-loop** | å…³é”®å·¥å…·è°ƒç”¨å‰ç­‰å¾…ç¡®è®¤ |

### å¿«é€Ÿå¼€å§‹

**æ­¥éª¤ 1ï¼šè®¾ç½® API Key**

```bash
# æ–¹å¼ A - ç¯å¢ƒå˜é‡
export ANTHROPIC_API_KEY="your-api-key"

# æ–¹å¼ B - .env æ–‡ä»¶
ANTHROPIC_API_KEY=your-api-key
```

**æ­¥éª¤ 2ï¼šå¯åŠ¨ CLI**

```bash
uvx deepagents-cli
```

**æ­¥éª¤ 3ï¼šå¼€å§‹äº¤äº’**

```bash
> Create a Python script that prints "Hello, World!"
```

æ™ºèƒ½ä½“ä¼šåœ¨å½“å‰ç›®å½•åˆ›å»ºæ–‡ä»¶ï¼Œä¿®æ”¹æ–‡ä»¶ï¼Œå¹¶ç­‰å¾…ä½ ç¡®è®¤ã€‚

### å®‰è£…æ–¹å¼

**ä½¿ç”¨ pip:**
```bash
pip install deepagents-cli
```

**ä½¿ç”¨ uv:**
```bash
uv add deepagents-cli
```

### æ¨¡å‹é…ç½®

**é»˜è®¤ï¼š** Anthropic Claude Sonnet 4

**ä½¿ç”¨ OpenAIï¼š**
```bash
export OPENAI_API_KEY="your-key"
```

**ç½‘ç»œæœç´¢ï¼ˆå¯é€‰ï¼‰ï¼š**
```bash
export TAVILY_API_KEY="your-key"
```

### å‘½ä»¤è¡Œé€‰é¡¹

| é€‰é¡¹ | è¯´æ˜ |
|------|------|
| `--agent NAME` | ä½¿ç”¨ç‰¹å®šåç§°çš„æ™ºèƒ½ä½“ |
| `--auto-approve` | è·³è¿‡å·¥å…·ç¡®è®¤ï¼ˆæˆ–ä½¿ç”¨ `Ctrl+T` åˆ‡æ¢ï¼‰ |
| `--sandbox TYPE` | ä½¿ç”¨äº‘æ²™ç®±è¿è¡Œï¼š`modal`ã€`daytona` æˆ– `runloop` |
| `--sandbox-id ID` | å¤ç”¨ç°æœ‰æ²™ç®± |
| `--sandbox-setup PATH` | æŒ‡å®šæ²™ç®±è®¾ç½®è„šæœ¬ |

### CLI å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `deepagents list` | åˆ—å‡ºæ‰€æœ‰æ™ºèƒ½ä½“ |
| `deepagents help` | æ˜¾ç¤ºå¸®åŠ© |
| `deepagents reset --agent NAME` | å°†æ™ºèƒ½ä½“é‡ç½®ä¸ºé»˜è®¤ |
| `deepagents reset --agent NAME --target SOURCE` | å¤åˆ¶å…¶ä»–æ™ºèƒ½ä½“çš„é…ç½® |

### äº¤äº’å‘½ä»¤

#### æ–œæ å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `/tokens` | æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„ token æ•° |
| `/clear` | æ¸…é™¤ä¸Šä¸‹æ–‡ |
| `/exit` | é€€å‡º CLI |

#### Bash å‘½ä»¤

ä»¥ `!` å‰ç¼€è¿è¡Œ shell å‘½ä»¤ï¼š

```bash
!git status
!npm test
!ls -la
```

#### å¿«æ·é”®

| å¿«æ·é”® | åŠŸèƒ½ |
|--------|------|
| `Enter` | å‘é€ |
| `Alt+Enter` | æ¢è¡Œ |
| `Ctrl+E` | æ‰“å¼€ç¼–è¾‘å™¨ |
| `Ctrl+T` | åˆ‡æ¢è‡ªåŠ¨ç¡®è®¤ |
| `Ctrl+C` | ä¸­æ–­ |
| `Ctrl+D` | é€€å‡º |

### æŒä¹…åŒ–è®°å¿†

æ¯ä¸ªæ™ºèƒ½ä½“å…³é”®é…ç½®ä¼šè‡ªåŠ¨æŒä¹…åŒ–ï¼š
1. **è§„åˆ’** - å­˜å‚¨åœ¨æŒ‡å®šè·¯å¾„ä¸‹çš„å·¥ä½œç›®å½•
2. **åå¥½** - ç”¨æˆ·æ‰§è¡Œä¹ æƒ¯å’Œé…ç½®
3. **æ–‡ä»¶** - è·¨ä¼šè¯çš„æ–‡ä»¶è¯»å†™æ“ä½œ

#### æ–‡ä»¶ç»„ç»‡

```
~/.deepagents/backend-dev/memories/
   api-conventions.md
   database-schema.md
   deployment-process.md
```

#### ä½¿ç”¨ç¤ºä¾‹

**å­˜å‚¨åå¥½**

```bash
uvx deepagents-cli --agent backend-dev
> Our API uses snake_case and includes created_at/updated_at timestamps
```

**åç»­ä½¿ç”¨è‡ªåŠ¨åº”ç”¨**

```bash
> Create a /users endpoint
# è‡ªåŠ¨åº”ç”¨ä¹‹å‰å­˜å‚¨çš„è§„èŒƒ
```

### äº‘æ²™ç®±

#### ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **éš”ç¦»** | åœ¨ç‹¬ç«‹ç¯å¢ƒä¸­è¿è¡Œï¼Œä¸å½±å“æœ¬åœ° |
| **é¢„é…ç½®ç¯å¢ƒ** | å¯ä»¥é¢„å…ˆå®‰è£…ä¾èµ–å’Œé…ç½® |
| **å¹¶è¡Œæ‰§è¡Œ** | å¯åœ¨äº‘ç«¯åŒæ—¶è¿è¡Œå¤šä¸ªæ™ºèƒ½ä½“ |
| **æŒä¹…åŒ–ç¯å¢ƒ** | è¿è¡Œç»“æŸåç¯å¢ƒä¿ç•™ |
| **å¯å®¡è®¡** | ä¾¿äºå®¡æŸ¥æ™ºèƒ½ä½“çš„æ‰€æœ‰æ“ä½œ |

#### é…ç½®æ­¥éª¤

**æ­¥éª¤ 1 - é…ç½®äº‘æœåŠ¡æä¾›å•†**

```bash
# Runloop:
export RUNLOOP_API_KEY="your-key"

# Daytona:
export DAYTONA_API_KEY="your-key"

# Modal:
modal setup
```

**æ­¥éª¤ 2 - ä½¿ç”¨æ²™ç®±å¯åŠ¨ CLI**

```bash
uvx deepagents-cli --sandbox runloop --sandbox-setup ./setup.sh
```

**æ­¥éª¤ 3ï¼ˆå¯é€‰ï¼‰- é…ç½® setup.sh**

```bash
#!/bin/bash
set -e

# ä½¿ç”¨ GitHub token å…‹éš†ä»“åº“
git clone https://x-access-token:${GITHUB_TOKEN}@github.com/username/repo.git $HOME/workspace
cd $HOME/workspace

# è®¾ç½®ç¯å¢ƒå˜é‡
cat >> ~/.bashrc <<'EOF'
export GITHUB_TOKEN="${GITHUB_TOKEN}"
export OPENAI_API_KEY="${OPENAI_API_KEY}"
cd $HOME/workspace
EOF

source ~/.bashrc
```

> âš ï¸ **å®‰å…¨è­¦å‘Šï¼š** äº‘æ²™ç®±ä¸­è¿è¡Œçš„æ™ºèƒ½ä½“å¯ä»¥è®¿é—®é…ç½®çš„æ‰€æœ‰å‡­æ®ã€‚å»ºè®®ä¸ºæ™ºèƒ½ä½“åˆ›å»ºä¸“ç”¨è´¦æˆ·å¹¶é…åˆ human-in-the-loop ç¡®è®¤æ•æ„Ÿæ“ä½œã€‚

---

## å‚è€ƒèµ„æº

- [Deep Agents å®˜æ–¹æ–‡æ¡£](https://docs.langchain.com/oss/python/deepagents/overview)
- [LangGraph æ–‡æ¡£](https://langchain-ai.github.io/langgraph/)
- [LangChain æ–‡æ¡£](https://python.langchain.com/)
- [LangSmith æ–‡æ¡£](https://docs.smith.langchain.com/)

---

## å®Œæ•´æ¡ˆä¾‹ä»£ç ï¼ˆå¯ç›´æ¥è¿è¡Œï¼‰

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Deep Agents ç¤ºä¾‹ï¼Œå±•ç¤ºäº†æ ¸å¿ƒåŠŸèƒ½çš„ä½¿ç”¨æ–¹å¼ï¼š

```python
"""
Deep Agents å®Œæ•´ç¤ºä¾‹
æ¼”ç¤ºï¼šå·¥å…·å®šä¹‰ã€åç«¯é…ç½®ã€å­æ™ºèƒ½ä½“ã€é•¿æœŸè®°å¿†

åœºæ™¯ï¼šæ™ºèƒ½ç ”ç©¶åŠ©æ‰‹
1. ä¸»æ™ºèƒ½ä½“æ¥æ”¶ç”¨æˆ·é—®é¢˜
2. ä½¿ç”¨ç½‘ç»œæœç´¢å·¥å…·è·å–ä¿¡æ¯
3. å¯é€‰æ‹©å§”æ‰˜ç»™ä¸“é—¨çš„å­æ™ºèƒ½ä½“
4. æ”¯æŒè·¨ä¼šè¯çš„é•¿æœŸè®°å¿†
"""

import os
from typing import Literal, List
from typing_extensions import TypedDict
from pydantic import BaseModel, Field
from langchain_openai import ChatOpenAI
from langchain_core.tools import tool
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage

# ========== 1. æ•°æ®æ¨¡å‹å®šä¹‰ ==========

class SearchResult(BaseModel):
    """æœç´¢ç»“æœæ¨¡å‹"""
    title: str = Field(description="ç»“æœæ ‡é¢˜")
    snippet: str = Field(description="å†…å®¹æ‘˜è¦")
    source: str = Field(description="æ¥æº")

class ResearchReport(BaseModel):
    """ç ”ç©¶æŠ¥å‘Šæ¨¡å‹"""
    topic: str = Field(description="ç ”ç©¶ä¸»é¢˜")
    summary: str = Field(description="æ‘˜è¦")
    key_findings: List[str] = Field(description="å…³é”®å‘ç°")
    sources: List[str] = Field(description="å‚è€ƒæ¥æº")

# ========== 2. å·¥å…·å®šä¹‰ ==========

@tool
def search_web(query: str, max_results: int = 3) -> str:
    """
    æœç´¢ç½‘ç»œä¿¡æ¯ã€‚

    Args:
        query: æœç´¢æŸ¥è¯¢å­—ç¬¦ä¸²
        max_results: è¿”å›ç»“æœæ•°é‡ï¼Œé»˜è®¤3æ¡
    """
    # æ¨¡æ‹Ÿæœç´¢ç»“æœï¼ˆå®é™…åº”ç”¨ä¸­ä½¿ç”¨ Tavily APIï¼‰
    results = [
        {
            "title": f"å…³äº {query} çš„æƒå¨ä»‹ç»",
            "snippet": f"è¿™æ˜¯å…³äº {query} çš„è¯¦ç»†è§£é‡Šã€‚Deep Agents æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ™ºèƒ½ä½“æ¡†æ¶...",
            "source": "docs.example.com"
        },
        {
            "title": f"{query} æœ€ä½³å®è·µæŒ‡å—",
            "snippet": f"å­¦ä¹  {query} çš„æœ€ä½³æ–¹æ³•åŒ…æ‹¬ï¼šç†è§£æ ¸å¿ƒæ¦‚å¿µã€åŠ¨æ‰‹å®è·µã€é˜…è¯»æºç ...",
            "source": "guide.example.com"
        },
        {
            "title": f"{query} å®æˆ˜æ¡ˆä¾‹åˆ†æ",
            "snippet": f"åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨ {query}ï¼Œå¯ä»¥æ˜¾è‘—æé«˜å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡...",
            "source": "blog.example.com"
        }
    ]

    formatted = "\n\n".join([
        f"ğŸ“Œ {r['title']}\n   {r['snippet']}\n   æ¥æº: {r['source']}"
        for r in results[:max_results]
    ])

    print(f"ğŸ” æœç´¢å®Œæˆ: {query}")
    return formatted

@tool
def read_document(path: str) -> str:
    """
    è¯»å–æœ¬åœ°æ–‡æ¡£å†…å®¹ã€‚

    Args:
        path: æ–‡æ¡£è·¯å¾„
    """
    # æ¨¡æ‹Ÿæ–‡æ¡£è¯»å–
    print(f"ğŸ“„ è¯»å–æ–‡æ¡£: {path}")
    return f"æ–‡æ¡£ {path} çš„å†…å®¹ï¼šè¿™æ˜¯ä¸€ä»½å…³äº AI æŠ€æœ¯çš„è¯¦ç»†æ–‡æ¡£..."

@tool
def write_notes(content: str, filename: str = "notes.txt") -> str:
    """
    ä¿å­˜ç¬”è®°åˆ°æ–‡ä»¶ã€‚

    Args:
        content: ç¬”è®°å†…å®¹
        filename: æ–‡ä»¶åï¼Œé»˜è®¤ notes.txt
    """
    print(f"ğŸ“ ä¿å­˜ç¬”è®°åˆ°: {filename}")
    return f"ç¬”è®°å·²ä¿å­˜åˆ° {filename}"

@tool
def calculate(expression: str) -> str:
    """
    è®¡ç®—æ•°å­¦è¡¨è¾¾å¼ã€‚

    Args:
        expression: æ•°å­¦è¡¨è¾¾å¼ï¼Œå¦‚ '2 + 2 * 3'
    """
    try:
        result = eval(expression)
        print(f"ğŸ”¢ è®¡ç®—: {expression} = {result}")
        return f"è®¡ç®—ç»“æœ: {result}"
    except Exception as e:
        return f"è®¡ç®—é”™è¯¯: {str(e)}"

# ========== 3. æ¨¡æ‹Ÿ Deep Agent æ ¸å¿ƒåŠŸèƒ½ ==========

class SimpleDeepAgent:
    """
    ç®€åŒ–ç‰ˆ Deep Agent å®ç°
    å±•ç¤ºæ ¸å¿ƒæ¦‚å¿µï¼šå·¥å…·è°ƒç”¨ã€ä»»åŠ¡ç®¡ç†ã€è®°å¿†ç³»ç»Ÿ
    """

    def __init__(
        self,
        model: str = "gpt-4o-mini",
        tools: List = None,
        system_prompt: str = None,
        name: str = "deep-agent"
    ):
        self.name = name
        self.llm = ChatOpenAI(model=model, temperature=0.7)
        self.tools = tools or []
        self.system_prompt = system_prompt or "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ã€‚"
        self.memory = []  # ç®€å•çš„å†…å­˜å­˜å‚¨
        self.todos = []   # ä»»åŠ¡åˆ—è¡¨

        # ç»‘å®šå·¥å…·åˆ° LLM
        if self.tools:
            self.llm_with_tools = self.llm.bind_tools(self.tools)
        else:
            self.llm_with_tools = self.llm

        print(f"ğŸ¤– Agent [{self.name}] åˆå§‹åŒ–å®Œæˆ")
        print(f"   å·¥å…·: {[t.name for t in self.tools]}")

    def add_todo(self, task: str, status: str = "pending"):
        """æ·»åŠ ä»»åŠ¡åˆ°å¾…åŠåˆ—è¡¨"""
        self.todos.append({"task": task, "status": status})
        print(f"ğŸ“‹ æ·»åŠ ä»»åŠ¡: {task}")

    def update_todo(self, task_index: int, status: str):
        """æ›´æ–°ä»»åŠ¡çŠ¶æ€"""
        if 0 <= task_index < len(self.todos):
            self.todos[task_index]["status"] = status
            print(f"âœ… ä»»åŠ¡çŠ¶æ€æ›´æ–°: {self.todos[task_index]['task']} -> {status}")

    def save_to_memory(self, key: str, value: str):
        """ä¿å­˜åˆ°é•¿æœŸè®°å¿†"""
        self.memory.append({"key": key, "value": value})
        print(f"ğŸ’¾ ä¿å­˜åˆ°è®°å¿†: {key}")

    def get_from_memory(self, key: str) -> str:
        """ä»è®°å¿†ä¸­è·å–"""
        for item in self.memory:
            if item["key"] == key:
                return item["value"]
        return None

    def invoke(self, messages: List[dict]) -> dict:
        """
        æ‰§è¡Œæ™ºèƒ½ä½“æ¨ç†

        Args:
            messages: æ¶ˆæ¯åˆ—è¡¨ï¼Œæ ¼å¼ [{"role": "user", "content": "..."}]

        Returns:
            åŒ…å«å“åº”æ¶ˆæ¯çš„å­—å…¸
        """
        # æ„å»ºæ¶ˆæ¯
        formatted_messages = [SystemMessage(content=self.system_prompt)]

        for msg in messages:
            if msg["role"] == "user":
                formatted_messages.append(HumanMessage(content=msg["content"]))
            elif msg["role"] == "assistant":
                formatted_messages.append(AIMessage(content=msg["content"]))

        # è°ƒç”¨ LLM
        response = self.llm_with_tools.invoke(formatted_messages)

        # æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
        if hasattr(response, 'tool_calls') and response.tool_calls:
            tool_results = []

            for tool_call in response.tool_calls:
                tool_name = tool_call["name"]
                tool_args = tool_call["args"]

                # æŸ¥æ‰¾å¹¶æ‰§è¡Œå·¥å…·
                for tool in self.tools:
                    if tool.name == tool_name:
                        result = tool.invoke(tool_args)
                        tool_results.append({
                            "tool": tool_name,
                            "result": result
                        })
                        break

            # å°†å·¥å…·ç»“æœåé¦ˆç»™ LLM ç”Ÿæˆæœ€ç»ˆå›ç­”
            tool_context = "\n".join([
                f"å·¥å…· {r['tool']} è¿”å›:\n{r['result']}"
                for r in tool_results
            ])

            final_prompt = f"""åŸºäºä»¥ä¸‹å·¥å…·è°ƒç”¨ç»“æœï¼Œå›ç­”ç”¨æˆ·é—®é¢˜ï¼š

{tool_context}

è¯·ç»™å‡ºç®€æ´ã€æœ‰å¸®åŠ©çš„å›ç­”ã€‚"""

            formatted_messages.append(AIMessage(content=response.content or ""))
            formatted_messages.append(HumanMessage(content=final_prompt))

            final_response = self.llm.invoke(formatted_messages)
            return {"messages": [{"role": "assistant", "content": final_response.content}]}

        return {"messages": [{"role": "assistant", "content": response.content}]}

    def stream(self, messages: List[dict]):
        """æµå¼æ‰§è¡Œï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        print("â³ å¤„ç†ä¸­...")

        # Step 1: åˆ†æä»»åŠ¡
        yield {"step": "analyze", "content": "æ­£åœ¨åˆ†æç”¨æˆ·è¯·æ±‚..."}

        # Step 2: æ‰§è¡Œ
        result = self.invoke(messages)

        yield {"step": "complete", "content": result["messages"][0]["content"]}

# ========== 4. å­æ™ºèƒ½ä½“å®šä¹‰ ==========

class ResearchSubAgent(SimpleDeepAgent):
    """ç ”ç©¶ä¸“ç”¨å­æ™ºèƒ½ä½“"""

    def __init__(self):
        super().__init__(
            name="research-agent",
            tools=[search_web, read_document],
            system_prompt="""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç ”ç©¶åŠ©æ‰‹ã€‚
ä½ çš„èŒè´£æ˜¯ï¼š
1. æœç´¢å’Œæ•´ç†ç›¸å…³ä¿¡æ¯
2. åˆ†æå’Œæ€»ç»“å…³é”®å‘ç°
3. æä¾›æœ‰æ®å¯æŸ¥çš„å›ç­”

å§‹ç»ˆå¼•ç”¨ä¿¡æ¯æ¥æºã€‚"""
        )

class CalculationSubAgent(SimpleDeepAgent):
    """è®¡ç®—ä¸“ç”¨å­æ™ºèƒ½ä½“"""

    def __init__(self):
        super().__init__(
            name="calc-agent",
            tools=[calculate],
            system_prompt="""ä½ æ˜¯ä¸€ä¸ªè®¡ç®—åŠ©æ‰‹ã€‚
å‡†ç¡®æ‰§è¡Œæ•°å­¦è®¡ç®—ï¼Œå¹¶è§£é‡Šè®¡ç®—è¿‡ç¨‹ã€‚"""
        )

# ========== 5. ä¸»æ™ºèƒ½ä½“ï¼ˆåè°ƒå™¨ï¼‰ ==========

class OrchestratorAgent(SimpleDeepAgent):
    """
    åè°ƒå™¨æ™ºèƒ½ä½“
    ç®¡ç†å­æ™ºèƒ½ä½“å¹¶åˆ†é…ä»»åŠ¡
    """

    def __init__(self):
        super().__init__(
            name="orchestrator",
            tools=[search_web, calculate, write_notes],
            system_prompt="""ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åè°ƒåŠ©æ‰‹ã€‚

ä½ å¯ä»¥ï¼š
1. ä½¿ç”¨ search_web æœç´¢ç½‘ç»œä¿¡æ¯
2. ä½¿ç”¨ calculate è¿›è¡Œæ•°å­¦è®¡ç®—
3. ä½¿ç”¨ write_notes ä¿å­˜ç¬”è®°

æ ¹æ®ç”¨æˆ·éœ€æ±‚é€‰æ‹©åˆé€‚çš„å·¥å…·ã€‚"""
        )

        # æ³¨å†Œå­æ™ºèƒ½ä½“
        self.subagents = {
            "research": ResearchSubAgent(),
            "calculation": CalculationSubAgent()
        }

    def delegate_to_subagent(self, agent_name: str, task: str) -> str:
        """å§”æ‰˜ä»»åŠ¡ç»™å­æ™ºèƒ½ä½“"""
        if agent_name in self.subagents:
            print(f"ğŸ“¤ å§”æ‰˜ä»»åŠ¡ç»™ [{agent_name}]: {task[:50]}...")
            subagent = self.subagents[agent_name]
            result = subagent.invoke([{"role": "user", "content": task}])
            return result["messages"][0]["content"]
        return f"æœªæ‰¾åˆ°å­æ™ºèƒ½ä½“: {agent_name}"

# ========== 6. åç«¯å­˜å‚¨æ¨¡æ‹Ÿ ==========

class SimpleBackend:
    """
    ç®€åŒ–ç‰ˆåç«¯å­˜å‚¨
    æ¨¡æ‹Ÿ StateBackend + StoreBackend ç»„åˆ
    """

    def __init__(self):
        self.state = {}      # ä¸´æ—¶çŠ¶æ€ï¼ˆä¼šè¯å†…ï¼‰
        self.store = {}      # æŒä¹…å­˜å‚¨ï¼ˆè·¨ä¼šè¯ï¼‰

    def write_state(self, key: str, value: any):
        """å†™å…¥ä¸´æ—¶çŠ¶æ€"""
        self.state[key] = value
        print(f"ğŸ’¾ [State] å†™å…¥: {key}")

    def read_state(self, key: str) -> any:
        """è¯»å–ä¸´æ—¶çŠ¶æ€"""
        return self.state.get(key)

    def write_store(self, path: str, content: str):
        """å†™å…¥æŒä¹…å­˜å‚¨"""
        self.store[path] = content
        print(f"ğŸ’¾ [Store] æŒä¹…åŒ–: {path}")

    def read_store(self, path: str) -> str:
        """è¯»å–æŒä¹…å­˜å‚¨"""
        return self.store.get(path, "")

    def list_store(self) -> List[str]:
        """åˆ—å‡ºæ‰€æœ‰æŒä¹…åŒ–æ–‡ä»¶"""
        return list(self.store.keys())

# ========== 7. å®Œæ•´çš„ Deep Agent ç³»ç»Ÿ ==========

class DeepAgentSystem:
    """
    å®Œæ•´çš„ Deep Agent ç³»ç»Ÿ
    æ•´åˆï¼šæ™ºèƒ½ä½“ã€åç«¯ã€è®°å¿†ã€ä»»åŠ¡ç®¡ç†
    """

    def __init__(self):
        self.backend = SimpleBackend()
        self.agent = OrchestratorAgent()
        self.conversation_history = []

    def chat(self, user_input: str) -> str:
        """å¤„ç†ç”¨æˆ·è¾“å…¥"""
        print(f"\n{'='*50}")
        print(f"ğŸ‘¤ ç”¨æˆ·: {user_input}")
        print('='*50)

        # æ·»åŠ åˆ°å¯¹è¯å†å²
        self.conversation_history.append({
            "role": "user",
            "content": user_input
        })

        # æ·»åŠ ä»»åŠ¡
        self.agent.add_todo(f"å¤„ç†: {user_input[:30]}...", "in_progress")

        # æ‰§è¡Œæ™ºèƒ½ä½“
        result = self.agent.invoke(self.conversation_history)
        response = result["messages"][0]["content"]

        # æ›´æ–°å¯¹è¯å†å²
        self.conversation_history.append({
            "role": "assistant",
            "content": response
        })

        # æ›´æ–°ä»»åŠ¡çŠ¶æ€
        self.agent.update_todo(len(self.agent.todos) - 1, "completed")

        # ä¿å­˜åˆ°è®°å¿†ï¼ˆæ¨¡æ‹Ÿé•¿æœŸè®°å¿†ï¼‰
        self.backend.write_store(
            f"/memories/conversation_{len(self.conversation_history)}.txt",
            f"Q: {user_input}\nA: {response[:200]}..."
        )

        print(f"\nğŸ¤– åŠ©æ‰‹: {response}")
        return response

    def show_status(self):
        """æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€"""
        print(f"\n{'='*50}")
        print("ğŸ“Š ç³»ç»ŸçŠ¶æ€")
        print('='*50)

        print(f"\nğŸ“‹ ä»»åŠ¡åˆ—è¡¨ ({len(self.agent.todos)} é¡¹):")
        for i, todo in enumerate(self.agent.todos):
            status_icon = "âœ…" if todo["status"] == "completed" else "â³"
            print(f"  {status_icon} {todo['task']}")

        print(f"\nğŸ’¾ æŒä¹…åŒ–å­˜å‚¨ ({len(self.backend.store)} é¡¹):")
        for path in self.backend.list_store():
            print(f"  ğŸ“„ {path}")

        print(f"\nğŸ’¬ å¯¹è¯å†å² ({len(self.conversation_history)} æ¡æ¶ˆæ¯)")

# ========== 8. ä¸»ç¨‹åº ==========

if __name__ == "__main__":
    print("=" * 60)
    print("ğŸš€ Deep Agents å®Œæ•´ç¤ºä¾‹")
    print("=" * 60)

    # åˆ›å»ºç³»ç»Ÿ
    system = DeepAgentSystem()

    # æµ‹è¯•å¯¹è¯
    print("\n" + "=" * 60)
    print("ğŸ’¬ å¼€å§‹å¯¹è¯æµ‹è¯•")
    print("=" * 60)

    # é—®é¢˜ 1: æœç´¢ä»»åŠ¡
    system.chat("ä»€ä¹ˆæ˜¯ LangGraphï¼Ÿè¯·æœç´¢ç›¸å…³ä¿¡æ¯")

    # é—®é¢˜ 2: è®¡ç®—ä»»åŠ¡
    system.chat("è®¡ç®— 15 * 8 + 42 çš„ç»“æœ")

    # é—®é¢˜ 3: ç»¼åˆä»»åŠ¡
    system.chat("æ€»ç»“ä¸€ä¸‹ AI Agent çš„ä¸»è¦ç‰¹ç‚¹")

    # æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
    system.show_status()

    # æ¼”ç¤ºå­æ™ºèƒ½ä½“å§”æ‰˜
    print("\n" + "=" * 60)
    print("ğŸ“¤ å­æ™ºèƒ½ä½“å§”æ‰˜æ¼”ç¤º")
    print("=" * 60)

    orchestrator = system.agent
    research_result = orchestrator.delegate_to_subagent(
        "research",
        "ç ”ç©¶ Deep Agents æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§"
    )
    print(f"\nç ”ç©¶ç»“æœ: {research_result[:200]}...")

    # æ¼”ç¤ºåç«¯å­˜å‚¨
    print("\n" + "=" * 60)
    print("ğŸ’¾ åç«¯å­˜å‚¨æ¼”ç¤º")
    print("=" * 60)

    backend = system.backend

    # å†™å…¥ä¸´æ—¶çŠ¶æ€
    backend.write_state("current_task", "ç ”ç©¶ Deep Agents")
    backend.write_state("user_preferences", {"theme": "dark", "language": "zh"})

    # å†™å…¥æŒä¹…å­˜å‚¨
    backend.write_store("/memories/user_profile.txt", "ç”¨æˆ·åå¥½: ä¸­æ–‡ï¼ŒæŠ€æœ¯è¯é¢˜")
    backend.write_store("/memories/research_notes.md", "# Deep Agents ç ”ç©¶ç¬”è®°\n\n- æ”¯æŒå­æ™ºèƒ½ä½“\n- å†…ç½®ä»»åŠ¡ç®¡ç†")

    # è¯»å–éªŒè¯
    print(f"\nè¯»å–ä¸´æ—¶çŠ¶æ€: {backend.read_state('current_task')}")
    print(f"è¯»å–æŒä¹…å­˜å‚¨: {backend.read_store('/memories/user_profile.txt')}")

    # æœ€ç»ˆçŠ¶æ€
    print("\n" + "=" * 60)
    print("âœ… æ¼”ç¤ºå®Œæˆ")
    print("=" * 60)

    print(f"""
ğŸ“‹ æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾:

| æ¦‚å¿µ | è¯´æ˜ | ä»£ç ç¤ºä¾‹ |
|------|------|----------|
| **@tool è£…é¥°å™¨** | å®šä¹‰æ™ºèƒ½ä½“å·¥å…· | `@tool def search(query: str)` |
| **å·¥å…·ç»‘å®š** | å°†å·¥å…·ç»‘å®šåˆ° LLM | `llm.bind_tools([tool1, tool2])` |
| **å­æ™ºèƒ½ä½“** | ä¸“é—¨åŒ–ä»»åŠ¡å¤„ç† | `delegate_to_subagent("research", task)` |
| **ä»»åŠ¡ç®¡ç†** | å¾…åŠäº‹é¡¹è¿½è¸ª | `add_todo()`, `update_todo()` |
| **åç«¯å­˜å‚¨** | çŠ¶æ€/æŒä¹…åŒ–åˆ†ç¦» | `StateBackend`, `StoreBackend` |
| **é•¿æœŸè®°å¿†** | è·¨ä¼šè¯æ•°æ®å­˜å‚¨ | `/memories/` è·¯å¾„è·¯ç”± |
| **æ¶ˆæ¯å†å²** | å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç† | `conversation_history` |
""")
```

### è¿è¡Œç»“æœç¤ºä¾‹

```
============================================================
ğŸš€ Deep Agents å®Œæ•´ç¤ºä¾‹
============================================================
ğŸ¤– Agent [orchestrator] åˆå§‹åŒ–å®Œæˆ
   å·¥å…·: ['search_web', 'calculate', 'write_notes']
ğŸ¤– Agent [research-agent] åˆå§‹åŒ–å®Œæˆ
   å·¥å…·: ['search_web', 'read_document']
ğŸ¤– Agent [calc-agent] åˆå§‹åŒ–å®Œæˆ
   å·¥å…·: ['calculate']

============================================================
ğŸ’¬ å¼€å§‹å¯¹è¯æµ‹è¯•
============================================================

==================================================
ğŸ‘¤ ç”¨æˆ·: ä»€ä¹ˆæ˜¯ LangGraphï¼Ÿè¯·æœç´¢ç›¸å…³ä¿¡æ¯
==================================================
ğŸ“‹ æ·»åŠ ä»»åŠ¡: å¤„ç†: ä»€ä¹ˆæ˜¯ LangGraphï¼Ÿè¯·æœç´¢ç›¸å…³ä¿¡æ¯...
ğŸ” æœç´¢å®Œæˆ: LangGraph
âœ… ä»»åŠ¡çŠ¶æ€æ›´æ–°: å¤„ç†: ä»€ä¹ˆæ˜¯ LangGraphï¼Ÿè¯·æœç´¢ç›¸å…³ä¿¡æ¯... -> completed
ğŸ’¾ [Store] æŒä¹…åŒ–: /memories/conversation_2.txt

ğŸ¤– åŠ©æ‰‹: LangGraph æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ AI åº”ç”¨æ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹...

==================================================
ğŸ‘¤ ç”¨æˆ·: è®¡ç®— 15 * 8 + 42 çš„ç»“æœ
==================================================
ğŸ“‹ æ·»åŠ ä»»åŠ¡: å¤„ç†: è®¡ç®— 15 * 8 + 42 çš„ç»“æœ...
ğŸ”¢ è®¡ç®—: 15 * 8 + 42 = 162
âœ… ä»»åŠ¡çŠ¶æ€æ›´æ–°: å¤„ç†: è®¡ç®— 15 * 8 + 42 çš„ç»“æœ... -> completed

ğŸ¤– åŠ©æ‰‹: è®¡ç®—ç»“æœæ˜¯ 162ã€‚è®¡ç®—è¿‡ç¨‹ï¼š15 Ã— 8 = 120ï¼Œç„¶å 120 + 42 = 162ã€‚

==================================================
ğŸ“Š ç³»ç»ŸçŠ¶æ€
==================================================

ğŸ“‹ ä»»åŠ¡åˆ—è¡¨ (3 é¡¹):
  âœ… å¤„ç†: ä»€ä¹ˆæ˜¯ LangGraphï¼Ÿè¯·æœç´¢ç›¸å…³ä¿¡æ¯...
  âœ… å¤„ç†: è®¡ç®— 15 * 8 + 42 çš„ç»“æœ...
  âœ… å¤„ç†: æ€»ç»“ä¸€ä¸‹ AI Agent çš„ä¸»è¦ç‰¹ç‚¹...

ğŸ’¾ æŒä¹…åŒ–å­˜å‚¨ (4 é¡¹):
  ğŸ“„ /memories/conversation_2.txt
  ğŸ“„ /memories/conversation_4.txt
  ğŸ“„ /memories/conversation_6.txt

ğŸ’¬ å¯¹è¯å†å² (6 æ¡æ¶ˆæ¯)

============================================================
ğŸ“¤ å­æ™ºèƒ½ä½“å§”æ‰˜æ¼”ç¤º
============================================================
ğŸ“¤ å§”æ‰˜ä»»åŠ¡ç»™ [research]: ç ”ç©¶ Deep Agents æ¡†æ¶çš„æ ¸å¿ƒç‰¹æ€§...
ğŸ” æœç´¢å®Œæˆ: Deep Agents æ¡†æ¶æ ¸å¿ƒç‰¹æ€§

ç ”ç©¶ç»“æœ: Deep Agents æ˜¯ä¸€ä¸ªåŸºäº LangGraph æ„å»ºçš„é«˜çº§æ™ºèƒ½ä½“æ¡†æ¶...

============================================================
ğŸ’¾ åç«¯å­˜å‚¨æ¼”ç¤º
============================================================
ğŸ’¾ [State] å†™å…¥: current_task
ğŸ’¾ [State] å†™å…¥: user_preferences
ğŸ’¾ [Store] æŒä¹…åŒ–: /memories/user_profile.txt
ğŸ’¾ [Store] æŒä¹…åŒ–: /memories/research_notes.md

è¯»å–ä¸´æ—¶çŠ¶æ€: ç ”ç©¶ Deep Agents
è¯»å–æŒä¹…å­˜å‚¨: ç”¨æˆ·åå¥½: ä¸­æ–‡ï¼ŒæŠ€æœ¯è¯é¢˜

============================================================
âœ… æ¼”ç¤ºå®Œæˆ
============================================================
```

### æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾

| æ¦‚å¿µ | è¯´æ˜ | ä»£ç ç¤ºä¾‹ |
|------|------|----------|
| **@tool è£…é¥°å™¨** | å°†å‡½æ•°è½¬ä¸º LangChain å·¥å…· | `@tool def search(query: str)` |
| **å·¥å…·ç»‘å®š** | è®© LLM èƒ½è°ƒç”¨å·¥å…· | `llm.bind_tools([tool1, tool2])` |
| **å­æ™ºèƒ½ä½“** | ä¸“é—¨åŒ–çš„ä»»åŠ¡å¤„ç†å•å…ƒ | `ResearchSubAgent()` |
| **ä»»åŠ¡å§”æ‰˜** | ä¸»æ™ºèƒ½ä½“åˆ†é…ä»»åŠ¡ | `delegate_to_subagent("research", task)` |
| **ä»»åŠ¡ç®¡ç†** | å¾…åŠäº‹é¡¹è¿½è¸ª | `add_todo()`, `update_todo()` |
| **åç«¯å­˜å‚¨** | çŠ¶æ€ä¸æŒä¹…åŒ–åˆ†ç¦» | `StateBackend` + `StoreBackend` |
| **é•¿æœŸè®°å¿†** | è·¨ä¼šè¯æ•°æ®å­˜å‚¨ | `/memories/` è·¯å¾„è·¯ç”± |
| **CompositeBackend** | ç»„åˆå¤šä¸ªåç«¯ | è·¯ç”±ä¸åŒè·¯å¾„åˆ°ä¸åŒå­˜å‚¨ |

---

**æ€»ç»“ï¼š** Deep Agents æä¾›äº†æ„å»ºç”Ÿäº§çº§ AI æ™ºèƒ½ä½“çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬å­æ™ºèƒ½ä½“ã€äººæœºåä½œã€é•¿æœŸè®°å¿†ç­‰é«˜çº§åŠŸèƒ½ã€‚æ— è®ºæ˜¯é€šè¿‡ Python API è¿˜æ˜¯ CLIï¼ŒDeep Agents éƒ½èƒ½å¸®åŠ©ä½ å¿«é€Ÿæ„å»ºå¯é çš„æ™ºèƒ½ä½“ç³»ç»Ÿã€‚
