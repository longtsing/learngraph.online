# LangGraph Agent è¯¦ç»†è§£è¯»

>  ç½‘ç«™ä½¿ç”¨è¯´æ˜
> - æœ¬ç½‘ç«™å¯ä»¥å…ç™»é™†è¿è¡Œ Python ä»£ç 
> - Python ä»£ç å¯ä»¥ç¼–è¾‘å¹¶ä¸´æ—¶ä¿å­˜ï¼Œä½†ä¸ä¼šæ°¸ä¹…ä¿å­˜ï¼Œç½‘é¡µåˆ·æ–°åä¼šè‡ªåŠ¨è¿˜åŸ
> - å¯¹ç½‘ç«™çš„ä½¿ç”¨æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥åˆ° [é—®é¢˜åé¦ˆ](http://localhost:5173/feedback.html) ï¼ˆæŒ‰é’®åœ¨æ¯ä¸ªé¡µé¢çš„å³ä¸‹è§’ï¼‰å…ç™»å½•è¿›è¡Œè¯„è®º
> - è¿è¡Œ `LangGraph/LangChain`ä»£ç ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥è‡ªå·±çš„ [API Key](http://localhost:5173/python-run.html)
> - é‡è¦å£°æ˜ï¼šæœ¬ç½‘ç«™ä¸ä¼šä¿å­˜ç”¨æˆ·çš„ API Key æ•°æ®ï¼Œè¯·æ”¾å¿ƒè¾“å…¥

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£è¯» LangGraph ä¸­çš„ **Agentï¼ˆæ™ºèƒ½ä½“ï¼‰** æ¶æ„ã€‚è¿™æ˜¯æ„å»ºæ™ºèƒ½ AI åº”ç”¨çš„æ ¸å¿ƒæ¨¡å¼ï¼Œé€šè¿‡è®© AI æ¨¡å‹è‡ªä¸»å†³ç­–ã€è°ƒç”¨å·¥å…·ã€å¹¶åŸºäºç»“æœç»§ç»­æ¨ç†ï¼Œå®ç°å¤æ‚ä»»åŠ¡çš„è‡ªåŠ¨åŒ–å¤„ç†ã€‚

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **Agent** | èƒ½è‡ªä¸»å†³ç­–å’Œè¡ŒåŠ¨çš„ AI ç³»ç»Ÿï¼Œæ”¯æŒå¤šæ­¥æ¨ç†å’Œå·¥å…·è°ƒç”¨ | é€šè¿‡å¾ªç¯è¾¹å®ç°å·¥å…·ç»“æœåé¦ˆåˆ° LLM çš„å›¾ç»“æ„ | â­â­â­â­â­ |
| **ReAct** | Reasoning + Acting æ¶æ„ï¼Œæ¨ç†-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯æ¨¡å¼ | Agent çš„ç»å…¸å®ç°æ¨¡å¼ï¼ŒLLM åŸºäºè§‚å¯Ÿç»“æœæŒç»­å†³ç­– | â­â­â­â­â­ |
| **å¾ªç¯è¾¹ï¼ˆLoop Edgeï¼‰** | ä»å·¥å…·èŠ‚ç‚¹è¿”å›åˆ° LLM èŠ‚ç‚¹çš„è¾¹ï¼Œå½¢æˆæ¨ç†å¾ªç¯ | add_edge("tools", "assistant") åˆ›å»ºå¾ªç¯ç»“æ„ | â­â­â­â­â­ |
| **ToolNode** | è‡ªåŠ¨æ‰§è¡Œå·¥å…·è°ƒç”¨å¹¶è¿”å›ç»“æœçš„é¢„æ„å»ºèŠ‚ç‚¹ | è§£æ tool_callsï¼Œè°ƒç”¨å‡½æ•°ï¼ŒåŒ…è£…ä¸º ToolMessage | â­â­â­â­â­ |
| **tools_condition** | åˆ¤æ–­æ˜¯å¦ç»§ç»­è°ƒç”¨å·¥å…·çš„æ¡ä»¶å‡½æ•° | æ£€æŸ¥ AIMessage.tool_callsï¼Œå†³å®šè·¯ç”±åˆ° tools æˆ– END | â­â­â­â­â­ |
| **parallel_tool_calls** | æ§åˆ¶å·¥å…·å¹¶è¡Œ/é¡ºåºæ‰§è¡Œçš„å‚æ•° | bind_tools å‚æ•°ï¼ŒFalse å¼ºåˆ¶é¡ºåºæ‰§è¡Œï¼ˆå¦‚æ•°å­¦è®¡ç®—ï¼‰ | â­â­â­â­ |
| **SystemMessage** | å®šä¹‰ AI è§’è‰²å’Œè¡Œä¸ºçš„ç³»ç»Ÿæç¤ºæ¶ˆæ¯ | LangChain æ¶ˆæ¯ç±»ï¼ŒæŒ‡å¯¼ LLM å¦‚ä½•ä½¿ç”¨å·¥å…·å’Œæ¨ç† | â­â­â­â­â­ |
| **recursion_limit** | é™åˆ¶ Agent å¾ªç¯æ¬¡æ•°çš„å‚æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯ | compile() å‚æ•°ï¼Œè®¾ç½®æœ€å¤§æ¨ç†æ­¥æ•° | â­â­â­â­ |
| **tool_call_id** | å·¥å…·è°ƒç”¨çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå…³è”è¯·æ±‚å’Œç»“æœ | ToolMessage çš„å¿…éœ€å±æ€§ï¼ŒåŒ¹é… AIMessage.tool_calls ä¸­çš„ id | â­â­â­â­â­ |
| **stream()** | æµå¼æ‰§è¡Œå›¾å¹¶é€æ­¥è¿”å›ç»“æœçš„æ–¹æ³• | å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œyield æ¯ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºï¼Œå®æ—¶è§‚å¯Ÿæ‰§è¡Œè¿‡ç¨‹ | â­â­â­â­ |

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ Agentï¼Ÿ

Agentï¼ˆæ™ºèƒ½ä½“ï¼‰æ˜¯ä¸€ç§èƒ½å¤Ÿè‡ªä¸»å†³ç­–å’Œè¡ŒåŠ¨çš„ AI ç³»ç»Ÿã€‚åœ¨ LangGraph ä¸­ï¼ŒAgent å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **è‡ªä¸»å†³ç­–**
   - AI æ¨¡å‹è‡ªå·±å†³å®šæ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·
   - æ ¹æ®å·¥å…·è¿”å›çš„ç»“æœå†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨
   - å¯ä»¥è¿ç»­è°ƒç”¨å¤šä¸ªå·¥å…·å®Œæˆå¤æ‚ä»»åŠ¡

2. **å·¥å…·è°ƒç”¨**
   - è°ƒç”¨å¤–éƒ¨å‡½æ•°è·å–ä¿¡æ¯æˆ–æ‰§è¡Œæ“ä½œ
   - å°†å·¥å…·ç»“æœä¼ å›æ¨¡å‹ç»§ç»­å¤„ç†
   - æ”¯æŒå¤šè½®å·¥å…·è°ƒç”¨

3. **å¾ªç¯æ¨ç†**
   - æ¨¡å‹å¯ä»¥åŸºäºå·¥å…·ç»“æœç»§ç»­æ€è€ƒ
   - å†³å®šæ˜¯ç»§ç»­è°ƒç”¨å·¥å…·è¿˜æ˜¯ç›´æ¥å›ç­”
   - å½¢æˆ "æ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿ" çš„å¾ªç¯

### ReAct æ¶æ„

![ReAct Architecture](https://cdn.prod.website-files.com/65b8cd72835ceeacd4449a53/66dbac0b4a2c1e5e02f3e78b_agent2.png)

ReActï¼ˆReasoning + Actingï¼‰æ˜¯ä¸€ç§ç»å…¸çš„ Agent æ¶æ„æ¨¡å¼ï¼š

- **Reasonï¼ˆæ¨ç†ï¼‰**ï¼šæ¨¡å‹åˆ†æé—®é¢˜ï¼Œå†³å®šéœ€è¦è°ƒç”¨ä»€ä¹ˆå·¥å…·
- **Actï¼ˆè¡ŒåŠ¨ï¼‰**ï¼šè°ƒç”¨é€‰å®šçš„å·¥å…·
- **Observeï¼ˆè§‚å¯Ÿï¼‰**ï¼šè·å–å·¥å…·è¿”å›ç»“æœ
- **å¾ªç¯**ï¼šåŸºäºè§‚å¯Ÿç»“æœï¼Œå†³å®šç»§ç»­è¡ŒåŠ¨è¿˜æ˜¯ç»™å‡ºæœ€ç»ˆç­”æ¡ˆ

### ä¸ Router çš„åŒºåˆ«

![Router vs Agent](https://cdn.prod.website-files.com/65b8cd72835ceeacd4449a53/66dbac0ba0bd34b541c448cc_agent1.png)

åœ¨ä¹‹å‰çš„ Router æ¨¡å¼ä¸­ï¼š
- æ¨¡å‹è°ƒç”¨å·¥å…·åï¼Œç›´æ¥è¿”å› `ToolMessage` ç»™ç”¨æˆ·
- è¿™æ˜¯ä¸€æ¬¡æ€§çš„å·¥å…·è°ƒç”¨ï¼Œæ²¡æœ‰å¾ªç¯

åœ¨ Agent æ¨¡å¼ä¸­ï¼š
- æ¨¡å‹è°ƒç”¨å·¥å…·åï¼Œ`ToolMessage` è¢«ä¼ å›æ¨¡å‹
- æ¨¡å‹å¯ä»¥åŸºäºç»“æœå†³å®šï¼š
  - ç»§ç»­è°ƒç”¨å…¶ä»–å·¥å…·
  - æˆ–è€…ç›´æ¥å›ç­”ç”¨æˆ·

**å…³é”®å·®å¼‚ï¼šå·¥å…·ç»“æœçš„æµå‘**
```
Router:  ç”¨æˆ· â†’ æ¨¡å‹ â†’ å·¥å…· â†’ ç”¨æˆ·
Agent:   ç”¨æˆ· â†’ æ¨¡å‹ â†’ å·¥å…· â†’ æ¨¡å‹ â†’ ... â†’ ç”¨æˆ·
                    â†‘____________â†“
                      å¾ªç¯åé¦ˆ
```

---

## ğŸ­ å®æˆ˜æ¡ˆä¾‹ï¼šæ•°å­¦è®¡ç®— Agent

æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªæ•°å­¦è®¡ç®—åŠ©æ‰‹ï¼Œæ¼”ç¤º Agent çš„å®Œæ•´å·¥ä½œæµç¨‹ã€‚

**éœ€æ±‚ï¼š**
ç»™å®šä¸€ä¸ªå¤šæ­¥éª¤æ•°å­¦é—®é¢˜ï¼ŒAgent éœ€è¦ï¼š
1. ç†è§£é—®é¢˜éœ€è¦å“ªäº›è®¡ç®—æ­¥éª¤
2. ä¾æ¬¡è°ƒç”¨ç›¸åº”çš„å·¥å…·ï¼ˆåŠ æ³•ã€ä¹˜æ³•ã€é™¤æ³•ï¼‰
3. åŸºäºæ¯ä¸€æ­¥ç»“æœï¼Œå†³å®šä¸‹ä¸€æ­¥æ“ä½œ
4. æœ€ç»ˆç»™å‡ºç­”æ¡ˆ

### ç³»ç»Ÿæ¶æ„å›¾

```
ç”¨æˆ·è¾“å…¥: "Add 3 and 4. Multiply the output by 2. Divide the output by 5"
        â†“
   [assistant] åˆ†æï¼šéœ€è¦å…ˆåšåŠ æ³•
        â†“
    (tools_condition åˆ¤æ–­ï¼šéœ€è¦è°ƒç”¨å·¥å…·)
        â†“
    [tools] è°ƒç”¨ add(3, 4) â†’ è¿”å› 7
        â†“
   [assistant] æ”¶åˆ°ç»“æœ 7ï¼Œåˆ†æï¼šéœ€è¦ä¹˜ä»¥ 2
        â†“
    (tools_condition åˆ¤æ–­ï¼šéœ€è¦è°ƒç”¨å·¥å…·)
        â†“
    [tools] è°ƒç”¨ multiply(7, 2) â†’ è¿”å› 14
        â†“
   [assistant] æ”¶åˆ°ç»“æœ 14ï¼Œåˆ†æï¼šéœ€è¦é™¤ä»¥ 5
        â†“
    (tools_condition åˆ¤æ–­ï¼šéœ€è¦è°ƒç”¨å·¥å…·)
        â†“
    [tools] è°ƒç”¨ divide(14, 5) â†’ è¿”å› 2.8
        â†“
   [assistant] æ”¶åˆ°ç»“æœ 2.8ï¼Œç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
        â†“
    (tools_condition åˆ¤æ–­ï¼šä¸éœ€è¦å·¥å…·)
        â†“
       END â†’ è¿”å›ç»“æœç»™ç”¨æˆ·
```

---

## ğŸ”§ ä»£ç å®ç°è¯¦è§£

### 1. å®šä¹‰å·¥å…·å‡½æ•°

```python
def multiply(a: int, b: int) -> int:
    """Multiply a and b.

    Args:
        a: first int
        b: second int
    """
    return a * b

def add(a: int, b: int) -> int:
    """Adds a and b.

    Args:
        a: first int
        b: second int
    """
    return a + b

def divide(a: int, b: int) -> float:
    """Divide a and b.

    Args:
        a: first int
        b: second int
    """
    return a / b

tools = [add, multiply, divide]
```

**Python çŸ¥è¯†ç‚¹ï¼šå‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²ï¼ˆDocstringï¼‰**

å‡½æ•°çš„æ–‡æ¡£å­—ç¬¦ä¸²ä¸ä»…ä»…æ˜¯æ³¨é‡Šï¼Œå®ƒæ˜¯ Python çš„ä¸€ç­‰å…¬æ°‘ï¼š

```python
def add(a: int, b: int) -> int:
    """Adds a and b.    # â† ç®€çŸ­æè¿°

    Args:               # â† å‚æ•°è¯´æ˜
        a: first int
        b: second int
    """
    return a + b

# å¯ä»¥é€šè¿‡ __doc__ å±æ€§è®¿é—®
print(add.__doc__)
```

**LangChain çš„é­”æ³•ï¼š**
LangChain ä¼šè§£æè¿™äº›æ–‡æ¡£å­—ç¬¦ä¸²ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºå·¥å…·æè¿°ä¼ é€’ç»™ LLMï¼š

```python
# LLM ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å·¥å…·æè¿°ï¼š
# Tool: add
# Description: Adds a and b.
# Parameters:
#   - a: first int
#   - b: second int
```

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ LLM èƒ½å¤Ÿ"ç†è§£"å·¥å…·çš„ä½œç”¨ï¼

---

### 2. ç»‘å®šå·¥å…·åˆ°æ¨¡å‹

```python
from langchain_openai import ChatOpenAI

llm = ChatOpenAI(model="gpt-5-nano")
llm_with_tools = llm.bind_tools(tools, parallel_tool_calls=False)
```

**å…³é”®å‚æ•°ï¼š`parallel_tool_calls=False`**

è¿™ä¸ªå‚æ•°æ§åˆ¶æ¨¡å‹æ˜¯å¦å¯ä»¥åŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·ï¼š

```python
# parallel_tool_calls=Trueï¼ˆé»˜è®¤ï¼‰
# æ¨¡å‹å¯èƒ½åŒæ—¶è°ƒç”¨ï¼šadd(3, 4) å’Œ multiply(7, 2)
# é€‚åˆï¼šå¹¶è¡Œã€ç‹¬ç«‹çš„ä»»åŠ¡

# parallel_tool_calls=False
# æ¨¡å‹å¿…é¡»ä¾æ¬¡è°ƒç”¨ï¼šå…ˆ add(3, 4)ï¼Œç­‰ç»“æœï¼Œå†è°ƒç”¨ multiply
# é€‚åˆï¼šæ•°å­¦è®¡ç®—ç­‰éœ€è¦é¡ºåºæ‰§è¡Œçš„ä»»åŠ¡
```

**ä¸ºä»€ä¹ˆæ•°å­¦è®¡ç®—è¦è®¾ç½®ä¸º Falseï¼Ÿ**

æ•°å­¦è®¡ç®—é€šå¸¸æœ‰ä¾èµ–å…³ç³»ï¼š
```
ç¬¬ä¸€æ­¥ï¼š3 + 4 = 7
ç¬¬äºŒæ­¥ï¼š7 Ã— 2 = 14  â† ä¾èµ–ç¬¬ä¸€æ­¥çš„ç»“æœï¼
ç¬¬ä¸‰æ­¥ï¼š14 Ã· 5 = 2.8  â† ä¾èµ–ç¬¬äºŒæ­¥çš„ç»“æœï¼
```

å¦‚æœå…è®¸å¹¶è¡Œè°ƒç”¨ï¼Œæ¨¡å‹å¯èƒ½åœ¨ä¸çŸ¥é“ç¬¬ä¸€æ­¥ç»“æœçš„æƒ…å†µä¸‹å°±å°è¯•æ‰§è¡Œç¬¬äºŒæ­¥ï¼Œå¯¼è‡´é”™è¯¯ã€‚

---

### 3. å®šä¹‰çŠ¶æ€

```python
from langgraph.graph import MessagesState
from langchain_core.messages import HumanMessage, SystemMessage

# System message
sys_msg = SystemMessage(content="You are a helpful assistant tasked with performing arithmetic on a set of inputs.")
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šMessagesState**

`MessagesState` æ˜¯ LangGraph å†…ç½®çš„çŠ¶æ€ç±»ï¼Œä¸“é—¨ç”¨äºèŠå¤©åœºæ™¯ï¼š

```python
class MessagesState(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]
```

**æ ¸å¿ƒç‰¹æ€§ï¼š**
1. **è‡ªåŠ¨æ¶ˆæ¯ç®¡ç†**ï¼šç»´æŠ¤å¯¹è¯å†å²
2. **æ¶ˆæ¯è¿½åŠ **ï¼šä½¿ç”¨ `add_messages` reducer è‡ªåŠ¨è¿½åŠ æ–°æ¶ˆæ¯
3. **ç±»å‹å®‰å…¨**ï¼šæ”¯æŒä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼ˆHumanMessageã€AIMessageã€ToolMessage ç­‰ï¼‰

**æ¶ˆæ¯ç±»å‹ï¼š**
```python
from langchain_core.messages import (
    HumanMessage,    # ç”¨æˆ·æ¶ˆæ¯
    AIMessage,       # AI å›å¤
    SystemMessage,   # ç³»ç»Ÿæç¤º
    ToolMessage      # å·¥å…·è¿”å›ç»“æœ
)
```

---

### 4. å®šä¹‰ Assistant èŠ‚ç‚¹

```python
def assistant(state: MessagesState):
   return {"messages": [llm_with_tools.invoke([sys_msg] + state["messages"])]}
```

**ä»£ç è§£æï¼š**

```python
[sys_msg] + state["messages"]
# æ„å»ºå®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨ï¼š
# [
#   SystemMessage("You are a helpful assistant..."),  # ç³»ç»Ÿæç¤º
#   HumanMessage("Add 3 and 4..."),                   # ç”¨æˆ·é—®é¢˜
#   AIMessage(tool_calls=[...]),                       # AI çš„å·¥å…·è°ƒç”¨
#   ToolMessage(content="7"),                          # å·¥å…·è¿”å›ç»“æœ
#   ...
# ]
```

**ä¸ºä»€ä¹ˆæ¯æ¬¡éƒ½åŠ ä¸Š sys_msgï¼Ÿ**

æ¯æ¬¡è°ƒç”¨ LLM æ—¶ï¼Œéƒ½éœ€è¦æä¾›å®Œæ•´çš„ä¸Šä¸‹æ–‡ï¼š
- ç³»ç»Ÿæç¤ºå®šä¹‰ AI çš„è§’è‰²å’Œè¡Œä¸º
- å†å²æ¶ˆæ¯æä¾›å¯¹è¯ä¸Šä¸‹æ–‡
- è¿™æ · AI æ‰èƒ½ç†è§£å½“å‰å¤„äºå¯¹è¯çš„å“ªä¸ªé˜¶æ®µ

**è¿”å›æ ¼å¼ï¼š**
```python
return {"messages": [new_message]}
# è¿”å›çš„æ¶ˆæ¯ä¼šè¢«è¿½åŠ åˆ° state["messages"] ä¸­
# å› ä¸º MessagesState ä½¿ç”¨äº† add_messages reducer
```

---

### 5. æ„å»º Agent å›¾

```python
from langgraph.graph import START, StateGraph
from langgraph.prebuilt import tools_condition
from langgraph.prebuilt import ToolNode

# åˆ›å»ºå›¾
builder = StateGraph(MessagesState)

# æ·»åŠ èŠ‚ç‚¹
builder.add_node("assistant", assistant)
builder.add_node("tools", ToolNode(tools))

# æ·»åŠ è¾¹
builder.add_edge(START, "assistant")

# æ¡ä»¶è¾¹ï¼šæ ¹æ® assistant çš„è¾“å‡ºå†³å®šè·¯ç”±
builder.add_conditional_edges(
    "assistant",
    tools_condition,  # æ¡ä»¶å‡½æ•°
)

# å…³é”®ï¼šä» tools å›åˆ° assistant å½¢æˆå¾ªç¯
builder.add_edge("tools", "assistant")

# ç¼–è¯‘
react_graph = builder.compile()

# ğŸ¨ å¯è§†åŒ–å›¾ç»“æ„
from IPython.display import Image, display
display(Image(react_graph.get_graph().draw_mermaid_png()))
```

#### å®Œæ•´æ¡ˆä¾‹ä»£ç ï¼ˆå¯ç›´æ¥è¿è¡Œï¼‰

ä»¥ä¸‹æ˜¯å®Œæ•´çš„å¯è¿è¡Œä»£ç ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„å¯¼å…¥å’Œå®šä¹‰ï¼š

```python
## å®Œæ•´æ¡ˆä¾‹ä»£ç 
from IPython.display import Image, display
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, SystemMessage
from langgraph.graph import START, StateGraph, MessagesState
from langgraph.prebuilt import tools_condition, ToolNode

# 1. å®šä¹‰å·¥å…·å‡½æ•°
def multiply(a: int, b: int) -> int:
    """Multiply a and b.

    Args:
        a: first int
        b: second int
    """
    return a * b

def add(a: int, b: int) -> int:
    """Adds a and b.

    Args:
        a: first int
        b: second int
    """
    return a + b

def divide(a: int, b: int) -> float:
    """Divide a and b.

    Args:
        a: first int
        b: second int
    """
    return a / b

tools = [add, multiply, divide]

# 2. åˆå§‹åŒ–æ¨¡å‹å¹¶ç»‘å®šå·¥å…·ï¼ˆéœ€è¦è®¾ç½® OPENAI_API_KEYï¼‰
llm = ChatOpenAI(model="gpt-4o-mini")
llm_with_tools = llm.bind_tools(tools, parallel_tool_calls=False)

# 3. å®šä¹‰ç³»ç»Ÿæ¶ˆæ¯
sys_msg = SystemMessage(content="You are a helpful assistant tasked with performing arithmetic on a set of inputs.")

# 4. å®šä¹‰ assistant èŠ‚ç‚¹
def assistant(state: MessagesState):
    return {"messages": [llm_with_tools.invoke([sys_msg] + state["messages"])]}

# 5. æ„å»ºå›¾
builder = StateGraph(MessagesState)
builder.add_node("assistant", assistant)
builder.add_node("tools", ToolNode(tools))
builder.add_edge(START, "assistant")
builder.add_conditional_edges("assistant", tools_condition)
builder.add_edge("tools", "assistant")
react_graph = builder.compile()

# 6. å¯è§†åŒ–
display(Image(react_graph.get_graph().draw_mermaid_png()))

# 7. æµ‹è¯•æ‰§è¡Œ
print("=== æµ‹è¯•ï¼šå¤šæ­¥æ•°å­¦è®¡ç®— ===")
messages = [HumanMessage(content="Add 3 and 4. Multiply the output by 2. Divide the output by 5")]
result = react_graph.invoke({"messages": messages})

for m in result['messages']:
    m.pretty_print()
```

**ç”Ÿæˆçš„æµç¨‹å›¾ï¼š**

![Flow Diagram](images/agent-output-10-0.jpg)


**LangGraph çŸ¥è¯†ç‚¹ï¼šToolNode**

`ToolNode` æ˜¯ LangGraph æä¾›çš„é¢„æ„å»ºèŠ‚ç‚¹ï¼Œç”¨äºæ‰§è¡Œå·¥å…·è°ƒç”¨ï¼š

```python
ToolNode(tools)
# è‡ªåŠ¨å¤„ç†ï¼š
# 1. è§£æ AIMessage ä¸­çš„ tool_calls
# 2. è°ƒç”¨å¯¹åº”çš„å·¥å…·å‡½æ•°
# 3. å°†ç»“æœåŒ…è£…æˆ ToolMessage
# 4. è¿”å›ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
```

**ç­‰ä»·çš„æ‰‹åŠ¨å®ç°ï¼š**
```python
def tools_node(state: MessagesState):
    # è·å–æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆAI çš„å·¥å…·è°ƒç”¨ï¼‰
    last_message = state["messages"][-1]

    # æ‰§è¡Œæ‰€æœ‰å·¥å…·è°ƒç”¨
    tool_messages = []
    for tool_call in last_message.tool_calls:
        # æ‰¾åˆ°å¯¹åº”çš„å·¥å…·
        tool = next(t for t in tools if t.name == tool_call["name"])
        # è°ƒç”¨å·¥å…·
        result = tool.invoke(tool_call["args"])
        # åŒ…è£…æˆ ToolMessage
        tool_messages.append(ToolMessage(
            content=str(result),
            tool_call_id=tool_call["id"]
        ))

    return {"messages": tool_messages}
```

**LangGraph çŸ¥è¯†ç‚¹ï¼štools_condition**

`tools_condition` æ˜¯é¢„æ„å»ºçš„æ¡ä»¶å‡½æ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·ï¼š

```python
def tools_condition(state: MessagesState) -> str:
    # è·å–æœ€åä¸€æ¡æ¶ˆæ¯
    last_message = state["messages"][-1]

    # å¦‚æœæ˜¯ AIMessage ä¸”åŒ…å« tool_calls
    if hasattr(last_message, "tool_calls") and last_message.tool_calls:
        return "tools"  # è·¯ç”±åˆ° tools èŠ‚ç‚¹
    else:
        return END  # ç»“æŸå›¾æ‰§è¡Œ
```

**æ¡ä»¶è¾¹çš„å·¥ä½œæµç¨‹ï¼š**
```python
builder.add_conditional_edges("assistant", tools_condition)

# å®Œæ•´æµç¨‹ï¼š
# assistant èŠ‚ç‚¹æ‰§è¡Œå®Œæ¯•
#    â†“
# tools_condition æ£€æŸ¥è¾“å‡º
#    â†“
# å¦‚æœæœ‰ tool_calls â†’ è·¯ç”±åˆ° "tools"
# å¦‚æœæ²¡æœ‰ tool_calls â†’ è·¯ç”±åˆ° END
```

**Agent å¾ªç¯çš„å…³é”®ï¼š**
```python
builder.add_edge("tools", "assistant")  # â† è¿™æ¡è¾¹åˆ›å»ºäº†å¾ªç¯ï¼

# å®Œæ•´å¾ªç¯ï¼š
# assistant â†’ (æœ‰å·¥å…·è°ƒç”¨) â†’ tools â†’ assistant â†’ ...
#          â†’ (æ— å·¥å…·è°ƒç”¨) â†’ END
```

---

### 6. æ‰§è¡Œ Agent

```python
messages = [HumanMessage(content="Add 3 and 4. Multiply the output by 2. Divide the output by 5")]
messages = react_graph.invoke({"messages": messages})
```

**æ‰§è¡Œè¿‡ç¨‹è¯¦è§£ï¼š**

```
æ­¥éª¤ 1ï¼šassistant èŠ‚ç‚¹
è¾“å…¥ï¼š[HumanMessage("Add 3 and 4. Multiply the output by 2. Divide the output by 5")]
è¾“å‡ºï¼šAIMessage(tool_calls=[ToolCall(name="add", args={"a": 3, "b": 4})])
tools_conditionï¼šæ£€æµ‹åˆ° tool_calls â†’ è·¯ç”±åˆ° "tools"

æ­¥éª¤ 2ï¼štools èŠ‚ç‚¹
è¾“å…¥ï¼š[HumanMessage(...), AIMessage(tool_calls=[...])]
æ‰§è¡Œï¼šadd(3, 4) = 7
è¾“å‡ºï¼šToolMessage(content="7", tool_call_id="...")
è‡ªåŠ¨è·¯ç”±ï¼šâ†’ "assistant"

æ­¥éª¤ 3ï¼šassistant èŠ‚ç‚¹
è¾“å…¥ï¼š[HumanMessage(...), AIMessage(...), ToolMessage("7")]
åˆ†æï¼šçœ‹åˆ°ç»“æœæ˜¯ 7ï¼Œéœ€è¦ä¹˜ä»¥ 2
è¾“å‡ºï¼šAIMessage(tool_calls=[ToolCall(name="multiply", args={"a": 7, "b": 2})])
tools_conditionï¼šæ£€æµ‹åˆ° tool_calls â†’ è·¯ç”±åˆ° "tools"

æ­¥éª¤ 4ï¼štools èŠ‚ç‚¹
æ‰§è¡Œï¼šmultiply(7, 2) = 14
è¾“å‡ºï¼šToolMessage(content="14")
è‡ªåŠ¨è·¯ç”±ï¼šâ†’ "assistant"

æ­¥éª¤ 5ï¼šassistant èŠ‚ç‚¹
è¾“å…¥ï¼šåŒ…å« ToolMessage("14") çš„å®Œæ•´å¯¹è¯å†å²
åˆ†æï¼šçœ‹åˆ°ç»“æœæ˜¯ 14ï¼Œéœ€è¦é™¤ä»¥ 5
è¾“å‡ºï¼šAIMessage(tool_calls=[ToolCall(name="divide", args={"a": 14, "b": 5})])
tools_conditionï¼šæ£€æµ‹åˆ° tool_calls â†’ è·¯ç”±åˆ° "tools"

æ­¥éª¤ 6ï¼štools èŠ‚ç‚¹
æ‰§è¡Œï¼šdivide(14, 5) = 2.8
è¾“å‡ºï¼šToolMessage(content="2.8")
è‡ªåŠ¨è·¯ç”±ï¼šâ†’ "assistant"

æ­¥éª¤ 7ï¼šassistant èŠ‚ç‚¹
è¾“å…¥ï¼šåŒ…å«æ‰€æœ‰å†å²æ¶ˆæ¯å’Œæœ€ç»ˆç»“æœ 2.8
åˆ†æï¼šæ‰€æœ‰è®¡ç®—å®Œæˆï¼Œå¯ä»¥ç»™å‡ºæœ€ç»ˆç­”æ¡ˆ
è¾“å‡ºï¼šAIMessage(content="The final result is 2.8")  # æ³¨æ„ï¼šæ²¡æœ‰ tool_calls
tools_conditionï¼šæ²¡æœ‰ tool_calls â†’ è·¯ç”±åˆ° END

å›¾æ‰§è¡Œç»“æŸ
```

---

### 7. æŸ¥çœ‹è¾“å‡º

```python
for m in messages['messages']:
    m.pretty_print()
```

**è¾“å‡ºè§£æï¼š**

```
================================ Human Message =================================
Add 3 and 4. Multiply the output by 2. Divide the output by 5

================================== Ai Message ==================================
Tool Calls:
  add (call_i8zDfMTdvmIG34w4VBA3m93Z)
 Call ID: call_i8zDfMTdvmIG34w4VBA3m93Z
  Args:
    a: 3
    b: 4
```
**è§£é‡Šï¼š**
- AI ç†è§£äº†ä»»åŠ¡ï¼Œå†³å®šå…ˆè°ƒç”¨ `add` å·¥å…·
- `Call ID` æ˜¯å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºè¿½è¸ªå·¥å…·è°ƒç”¨å’Œç»“æœçš„å¯¹åº”å…³ç³»
- `Args` æ˜¯ä¼ é€’ç»™å·¥å…·çš„å‚æ•°

```
================================= Tool Message =================================
Name: add
7
```
**è§£é‡Šï¼š**
- å·¥å…·æ‰§è¡Œç»“æœï¼š3 + 4 = 7
- è¿™ä¸ªç»“æœä¼šè¢«ä¼ å› assistant èŠ‚ç‚¹

```
================================== Ai Message ==================================
Tool Calls:
  multiply (call_nE62D40lrGQC7b67nVOzqGYY)
 Call ID: call_nE62D40lrGQC7b67nVOzqGYY
  Args:
    a: 7
    b: 2
```
**è§£é‡Šï¼š**
- AI æ”¶åˆ°ç»“æœ 7ï¼Œå†³å®šä¸‹ä¸€æ­¥è°ƒç”¨ `multiply`
- æ³¨æ„å‚æ•° `a: 7` æ¥è‡ªä¸Šä¸€æ­¥çš„ç»“æœï¼

```
================================= Tool Message =================================
Name: multiply
14
```
**è§£é‡Šï¼š** 7 Ã— 2 = 14

```
================================== Ai Message ==================================
Tool Calls:
  divide (call_6Q9SjxD2VnYJqEBXFt7O1moe)
 Call ID: call_6Q9SjxD2VnYJqEBXFt7O1moe
  Args:
    a: 14
    b: 5
```
**è§£é‡Šï¼š**
- AI ç»§ç»­æ¨ç†ï¼Œè°ƒç”¨ `divide`
- å‚æ•° `a: 14` æ¥è‡ªä¸Šä¸€æ­¥ç»“æœ

```
================================= Tool Message =================================
Name: divide
2.8
```
**è§£é‡Šï¼š** 14 Ã· 5 = 2.8

```
================================== Ai Message ==================================
The final result after performing the operations (3 + 4) Ã— 2 Ã· 5 is 2.8.
```
**è§£é‡Šï¼š**
- æ‰€æœ‰è®¡ç®—å®Œæˆï¼ŒAI ç»™å‡ºæœ€ç»ˆç­”æ¡ˆ
- è¿™æ¡æ¶ˆæ¯æ²¡æœ‰ `tool_calls`ï¼Œæ‰€ä»¥å›¾æ‰§è¡Œç»“æŸ

**å…³é”®è§‚å¯Ÿç‚¹ï¼š**
1. AI è‡ªä¸»å†³å®šäº†æ¯ä¸€æ­¥çš„å·¥å…·è°ƒç”¨
2. æ¯æ¬¡éƒ½åŸºäºå‰ä¸€æ­¥çš„ç»“æœè¿›è¡Œæ¨ç†
3. æœ€ç»ˆç»™å‡ºäº†è‡ªç„¶è¯­è¨€çš„å›ç­”
4. æ•´ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œæ— éœ€äººå·¥å¹²é¢„

---

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### LangGraph ç‰¹æœ‰æ¦‚å¿µ

#### 1. Agent vs Router

| ç‰¹æ€§ | Router | Agent |
|------|--------|-------|
| å·¥å…·è°ƒç”¨æ¬¡æ•° | ä¸€æ¬¡ | å¤šæ¬¡ï¼ˆå¾ªç¯ï¼‰ |
| å·¥å…·ç»“æœæµå‘ | ç›´æ¥è¿”å›ç”¨æˆ· | è¿”å›æ¨¡å‹ç»§ç»­å¤„ç† |
| å†³ç­–æ¬¡æ•° | ä¸€æ¬¡ | å¤šæ¬¡ï¼ˆæ¯æ¬¡å¾ªç¯éƒ½å†³ç­–ï¼‰ |
| é€‚ç”¨åœºæ™¯ | ç®€å•åˆ†ç±»ã€å•æ¬¡æŸ¥è¯¢ | å¤æ‚ä»»åŠ¡ã€å¤šæ­¥éª¤æ¨ç† |

#### 2. ReAct å¾ªç¯

```python
while True:
    # Reason: AI åˆ†æå½“å‰çŠ¶æ€ï¼Œå†³å®šè¡ŒåŠ¨
    ai_message = assistant(state)

    # åˆ¤æ–­ï¼šéœ€è¦å·¥å…·å—ï¼Ÿ
    if no_tool_calls(ai_message):
        break  # ä¸éœ€è¦ï¼Œè¿”å›ç­”æ¡ˆ

    # Act: è°ƒç”¨å·¥å…·
    tool_result = tools(state)

    # Observe: æ›´æ–°çŠ¶æ€ï¼Œå°†ç»“æœä¼ å› AI
    state = update_state(tool_result)
```

#### 3. æ¡ä»¶è¾¹ä¸å¾ªç¯

```python
# æ¡ä»¶è¾¹ï¼šæ ¹æ®è¾“å‡ºåŠ¨æ€è·¯ç”±
builder.add_conditional_edges("assistant", tools_condition)

# è¿”å›è¾¹ï¼šåˆ›å»ºå¾ªç¯
builder.add_edge("tools", "assistant")

# ç»„åˆæ•ˆæœï¼š
# assistant â†’ [æœ‰å·¥å…·è°ƒç”¨] â†’ tools â†’ assistant â†’ ...
#          â†’ [æ— å·¥å…·è°ƒç”¨] â†’ END
```

#### 4. MessagesState

```python
class MessagesState(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]

# ç‰¹ç‚¹ï¼š
# 1. è‡ªåŠ¨ç»´æŠ¤å¯¹è¯å†å²
# 2. æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹
# 3. ä½¿ç”¨ add_messages reducer è¿½åŠ æ¶ˆæ¯
```

#### 5. ToolNode

```python
ToolNode(tools)

# è‡ªåŠ¨å¤„ç†ï¼š
# - è§£æ tool_calls
# - è°ƒç”¨å‡½æ•°
# - åŒ…è£…ç»“æœä¸º ToolMessage
# - è¿½è¸ª tool_call_id
```

### Python ç‰¹æœ‰çŸ¥è¯†ç‚¹

#### 1. å‡½æ•°ç±»å‹æ³¨è§£

```python
def add(a: int, b: int) -> int:
    """Adds a and b."""
    return a + b

# a: int        â† å‚æ•°ç±»å‹æ³¨è§£
# -> int        â† è¿”å›ç±»å‹æ³¨è§£
# """..."""     â† æ–‡æ¡£å­—ç¬¦ä¸²
```

**ä½œç”¨ï¼š**
- IDE æä¾›æ™ºèƒ½æç¤º
- ç±»å‹æ£€æŸ¥å·¥å…·ï¼ˆmypyï¼‰éªŒè¯ä»£ç 
- LangChain è§£æç”¨äºå·¥å…·æè¿°

#### 2. Docstring è§„èŒƒï¼ˆGoogle é£æ ¼ï¼‰

```python
def multiply(a: int, b: int) -> int:
    """Multiply a and b.          # ç®€çŸ­æè¿°ï¼ˆå¿…é¡»ï¼‰

    Args:                          # å‚æ•°åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
        a: first int
        b: second int

    Returns:                       # è¿”å›å€¼ï¼ˆå¯é€‰ï¼‰
        The product of a and b

    Raises:                        # å¼‚å¸¸ï¼ˆå¯é€‰ï¼‰
        ValueError: If a or b is negative
    """
    return a * b
```

#### 3. åˆ—è¡¨æ‹¼æ¥

```python
[sys_msg] + state["messages"]

# ç­‰ä»·äºï¼š
result = []
result.append(sys_msg)
result.extend(state["messages"])
```

#### 4. å¯¹è±¡å±æ€§æ£€æŸ¥

```python
hasattr(obj, "attribute_name")

# ç¤ºä¾‹ï¼š
hasattr(last_message, "tool_calls")
# æ£€æŸ¥ last_message å¯¹è±¡æ˜¯å¦æœ‰ tool_calls å±æ€§
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½•æ—¶ä½¿ç”¨ Agentï¼Ÿ

âœ… **é€‚ç”¨åœºæ™¯ï¼š**
- éœ€è¦å¤šæ­¥éª¤æ¨ç†çš„ä»»åŠ¡ï¼ˆå¦‚æ•°å­¦è®¡ç®—ã€æ•°æ®åˆ†æï¼‰
- éœ€è¦æ ¹æ®ä¸­é—´ç»“æœåŠ¨æ€è°ƒæ•´ç­–ç•¥
- å·¥å…·è°ƒç”¨é¡ºåºä¸å›ºå®šï¼Œéœ€è¦ AI è‡ªä¸»å†³ç­–
- ä»»åŠ¡å¤æ‚åº¦é«˜ï¼Œéœ€è¦çµæ´»åº”å¯¹

âŒ **ä¸é€‚ç”¨åœºæ™¯ï¼š**
- ç®€å•çš„å•æ¬¡å·¥å…·è°ƒç”¨ï¼ˆç”¨ Router å³å¯ï¼‰
- å›ºå®šæµç¨‹çš„ä»»åŠ¡ï¼ˆç”¨æ™®é€šå›¾å³å¯ï¼‰
- ä¸éœ€è¦å¾ªç¯æ¨ç†çš„åœºæ™¯

### 2. å¹¶è¡Œå·¥å…·è°ƒç”¨çš„é€‰æ‹©

```python
# åœºæ™¯ 1ï¼šæ•°å­¦è®¡ç®— â†’ parallel_tool_calls=False
llm_with_tools = llm.bind_tools([add, multiply, divide], parallel_tool_calls=False)
# åŸå› ï¼šæ­¥éª¤æœ‰ä¾èµ–å…³ç³»ï¼Œå¿…é¡»é¡ºåºæ‰§è¡Œ

# åœºæ™¯ 2ï¼šä¿¡æ¯æ”¶é›† â†’ parallel_tool_calls=Trueï¼ˆé»˜è®¤ï¼‰
llm_with_tools = llm.bind_tools([search_web, query_db, call_api])
# åŸå› ï¼šä¸‰ä¸ªå·¥å…·å¯ä»¥åŒæ—¶è°ƒç”¨ï¼Œæé«˜æ•ˆç‡
```

### 3. ç³»ç»Ÿæç¤ºçš„é‡è¦æ€§

```python
# âœ… å¥½çš„ç³»ç»Ÿæç¤º
sys_msg = SystemMessage(content="""
You are a helpful assistant tasked with performing arithmetic on a set of inputs.
- Break down complex calculations into steps
- Use the appropriate tool for each operation
- Show your reasoning
""")

# âŒ ä¸å¥½çš„ç³»ç»Ÿæç¤º
sys_msg = SystemMessage(content="You are helpful.")
# å¤ªæ¨¡ç³Šï¼ŒAI å¯èƒ½ä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨å·¥å…·
```

### 4. é˜²æ­¢æ— é™å¾ªç¯

Agent æœ‰å¯èƒ½é™·å…¥æ— é™å¾ªç¯ï¼Œéœ€è¦è®¾ç½®é™åˆ¶ï¼š

```python
# æ–¹æ³• 1ï¼šä½¿ç”¨ recursion_limit
react_graph = builder.compile(recursion_limit=10)
# æœ€å¤šæ‰§è¡Œ 10 æ¬¡å¾ªç¯

# æ–¹æ³• 2ï¼šåœ¨çŠ¶æ€ä¸­è®¡æ•°
class MessagesStateWithCount(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]
    iterations: int

def assistant(state: MessagesStateWithCount):
    if state.get("iterations", 0) > 10:
        return {"messages": [AIMessage(content="Reached maximum iterations")]}
    # ... æ­£å¸¸é€»è¾‘
    return {
        "messages": [llm_with_tools.invoke(...)],
        "iterations": state.get("iterations", 0) + 1
    }
```

### 5. å·¥å…·å‡½æ•°è®¾è®¡åŸåˆ™

```python
# âœ… å¥½çš„å·¥å…·è®¾è®¡
def search_database(query: str, limit: int = 10) -> list[dict]:
    """Search the database for matching records.

    Args:
        query: Search query string
        limit: Maximum number of results (default: 10)

    Returns:
        List of matching records
    """
    # å®ç°...
    return results

# ç‰¹ç‚¹ï¼š
# - æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²
# - ç±»å‹æ³¨è§£
# - é»˜è®¤å‚æ•°å€¼
# - è¿”å›ç»“æ„åŒ–æ•°æ®
```

```python
# âŒ ä¸å¥½çš„å·¥å…·è®¾è®¡
def search(q):  # æ²¡æœ‰ç±»å‹æ³¨è§£
    """æœç´¢"""  # æ–‡æ¡£ä¸æ¸…æ¥š
    # AI ä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå·¥å…·
```

---

## ğŸš€ è¿›é˜¶æŠ€å·§

### 1. å¸¦è®°å¿†çš„ Agent

```python
class MessagesStateWithMemory(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]
    user_preferences: dict  # å­˜å‚¨ç”¨æˆ·åå¥½
    conversation_summary: str  # å¯¹è¯æ‘˜è¦

def assistant(state: MessagesStateWithMemory):
    # å¯ä»¥è®¿é—®å†å²åå¥½
    preferences = state.get("user_preferences", {})

    # æ„å»ºå¸¦ä¸Šä¸‹æ–‡çš„æç¤º
    context = f"User preferences: {preferences}\n"
    prompt = context + "\n".join([m.content for m in state["messages"]])

    response = llm_with_tools.invoke(prompt)
    return {"messages": [response]}
```

### 2. åŠ¨æ€å·¥å…·é€‰æ‹©

```python
def assistant(state: MessagesState):
    # æ ¹æ®å¯¹è¯å†…å®¹åŠ¨æ€é€‰æ‹©å¯ç”¨å·¥å…·
    last_message = state["messages"][-1].content

    if "weather" in last_message:
        tools = [get_weather, get_forecast]
    elif "database" in last_message:
        tools = [query_db, insert_db, update_db]
    else:
        tools = all_tools

    llm_with_selected_tools = llm.bind_tools(tools)
    response = llm_with_selected_tools.invoke(state["messages"])
    return {"messages": [response]}
```

### 3. é”™è¯¯å¤„ç†

```python
def tools_node(state: MessagesState):
    last_message = state["messages"][-1]
    tool_messages = []

    for tool_call in last_message.tool_calls:
        try:
            tool = next(t for t in tools if t.name == tool_call["name"])
            result = tool.invoke(tool_call["args"])
            tool_messages.append(ToolMessage(
                content=str(result),
                tool_call_id=tool_call["id"]
            ))
        except Exception as e:
            # è¿”å›é”™è¯¯ä¿¡æ¯ç»™ AI
            tool_messages.append(ToolMessage(
                content=f"Error: {str(e)}",
                tool_call_id=tool_call["id"],
                status="error"
            ))

    return {"messages": tool_messages}
```

### 4. æµå¼è¾“å‡º

```python
# ä½¿ç”¨ stream æ–¹æ³•æŸ¥çœ‹å®æ—¶æ‰§è¡Œè¿‡ç¨‹
for chunk in react_graph.stream({"messages": [HumanMessage("Calculate...")]}):
    print(chunk)

# è¾“å‡ºï¼š
# {'assistant': {'messages': [AIMessage(tool_calls=[...])]}}
# {'tools': {'messages': [ToolMessage(content="7")]}}
# {'assistant': {'messages': [AIMessage(tool_calls=[...])]}}
# ...
```

---

## ğŸ“Š Agent å˜ä½“å¯¹æ¯”

### 1. åŸºç¡€ Agentï¼ˆæœ¬æ•™ç¨‹ï¼‰

```python
builder.add_edge("tools", "assistant")  # å·¥å…·ç»“æœæ€»æ˜¯å›åˆ° assistant
```

**ç‰¹ç‚¹ï¼š** ç®€å•ã€ç›´æ¥ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯

### 2. æ¡ä»¶æ€§è¿”å› Agent

```python
def should_continue(state: MessagesState):
    last_message = state["messages"][-1]
    # å¯ä»¥æ ¹æ®å·¥å…·ç»“æœå†³å®šæ˜¯å¦ç»§ç»­
    if "error" in last_message.content:
        return END
    return "assistant"

builder.add_conditional_edges("tools", should_continue, ["assistant"])
```

**ç‰¹ç‚¹ï¼š** å¯ä»¥æå‰ç»ˆæ­¢ï¼Œå¤„ç†é”™è¯¯æƒ…å†µ

### 3. å¤šè·¯å¾„ Agent

```python
def route_after_tool(state: MessagesState):
    last_message = state["messages"][-1]

    if "final" in last_message.content:
        return "summarize"  # å»æ€»ç»“èŠ‚ç‚¹
    elif "error" in last_message.content:
        return "error_handler"  # å»é”™è¯¯å¤„ç†èŠ‚ç‚¹
    else:
        return "assistant"  # ç»§ç»­æ¨ç†

builder.add_conditional_edges("tools", route_after_tool,
                             ["assistant", "summarize", "error_handler"])
```

**ç‰¹ç‚¹ï¼š** æ›´å¤æ‚çš„æ§åˆ¶æµï¼Œé€‚åˆå¤§å‹åº”ç”¨

---

## ğŸ¯ å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šç ”ç©¶åŠ©æ‰‹

```python
tools = [
    search_web,          # æœç´¢ç½‘ç»œ
    read_paper,          # è¯»å–è®ºæ–‡
    summarize_text,      # æ€»ç»“æ–‡æœ¬
    save_notes           # ä¿å­˜ç¬”è®°
]

# ç”¨æˆ·ï¼šResearch recent advances in quantum computing
# Agent å·¥ä½œæµï¼š
# 1. search_web("quantum computing 2024")
# 2. read_paper(paper_url_1)
# 3. summarize_text(paper_content_1)
# 4. read_paper(paper_url_2)
# 5. summarize_text(paper_content_2)
# 6. save_notes(combined_summary)
# 7. è¿”å›ç ”ç©¶æ€»ç»“
```

### æ¡ˆä¾‹ 2ï¼šæ•°æ®åˆ†æåŠ©æ‰‹

```python
tools = [
    query_database,      # æŸ¥è¯¢æ•°æ®åº“
    calculate_stats,     # è®¡ç®—ç»Ÿè®¡
    create_chart,        # ç”Ÿæˆå›¾è¡¨
    export_report        # å¯¼å‡ºæŠ¥å‘Š
]

# ç”¨æˆ·ï¼šAnalyze sales data for Q4 and create a report
# Agent å·¥ä½œæµï¼š
# 1. query_database("SELECT * FROM sales WHERE quarter = 'Q4'")
# 2. calculate_stats(sales_data)
# 3. create_chart(stats, type="bar")
# 4. create_chart(stats, type="pie")
# 5. export_report(charts, stats)
# 6. è¿”å›æŠ¥å‘Šé“¾æ¥
```

### æ¡ˆä¾‹ 3ï¼šå®¢æˆ·æ”¯æŒåŠ©æ‰‹

```python
tools = [
    search_knowledge_base,  # æœç´¢çŸ¥è¯†åº“
    check_order_status,     # æŸ¥è¯¢è®¢å•
    create_ticket,          # åˆ›å»ºå·¥å•
    send_email              # å‘é€é‚®ä»¶
]

# ç”¨æˆ·ï¼šI haven't received my order #12345
# Agent å·¥ä½œæµï¼š
# 1. check_order_status("12345")
# 2. search_knowledge_base("delayed shipping")
# 3. å‘ç°é—®é¢˜ï¼šç‰©æµå»¶è¯¯
# 4. create_ticket(order_id="12345", issue="shipping_delay")
# 5. send_email(user, "Your order is delayed, ticket created")
# 6. è¿”å›è§£å†³æ–¹æ¡ˆå’Œå·¥å•å·
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: Agent ä»€ä¹ˆæ—¶å€™ä¼šåœæ­¢å¾ªç¯ï¼Ÿ

**ç­”ï¼š** å½“ `assistant` èŠ‚ç‚¹è¿”å›çš„ `AIMessage` ä¸åŒ…å« `tool_calls` æ—¶ï¼š

```python
# ä¼šç»§ç»­å¾ªç¯
AIMessage(tool_calls=[ToolCall(name="add", ...)])

# ä¼šåœæ­¢ï¼ˆè¿›å…¥ ENDï¼‰
AIMessage(content="The answer is 42")
```

### Q2: å¦‚ä½•è®© Agent è°ƒç”¨ç‰¹å®šå·¥å…·ï¼Ÿ

**ç­”ï¼š** é€šè¿‡ç³»ç»Ÿæç¤ºå¼•å¯¼ï¼š

```python
sys_msg = SystemMessage(content="""
You are a helpful assistant.
When the user asks about weather, ALWAYS use the get_weather tool.
When the user asks about time, ALWAYS use the get_time tool.
""")
```

æˆ–è€…ä½¿ç”¨ `tool_choice` å‚æ•°ï¼š

```python
# å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šå·¥å…·
llm_with_tools = llm.bind_tools(tools, tool_choice="get_weather")

# å¼ºåˆ¶è°ƒç”¨ä»»æ„å·¥å…·ï¼ˆä¸èƒ½ç›´æ¥å›ç­”ï¼‰
llm_with_tools = llm.bind_tools(tools, tool_choice="any")

# ç¦æ­¢è°ƒç”¨å·¥å…·
llm_with_tools = llm.bind_tools(tools, tool_choice="none")
```

### Q3: å¦‚ä½•æŸ¥çœ‹ Agent çš„æ‰§è¡Œè¿‡ç¨‹ï¼Ÿ

**æ–¹æ³• 1ï¼šä½¿ç”¨ stream**
```python
for chunk in graph.stream(input_data):
    print(chunk)
```

**æ–¹æ³• 2ï¼šä½¿ç”¨ LangSmith**
```python
import os
os.environ["LANGSMITH_TRACING"] = "true"
os.environ["LANGSMITH_PROJECT"] = "my-agent"

# åœ¨ LangSmith ç½‘ç«™æŸ¥çœ‹è¯¦ç»† trace
```

**æ–¹æ³• 3ï¼šè‡ªå®šä¹‰æ—¥å¿—**
```python
def assistant(state: MessagesState):
    print(f"[Assistant] Processing {len(state['messages'])} messages")
    response = llm_with_tools.invoke(state["messages"])
    print(f"[Assistant] Response: {response}")
    return {"messages": [response]}
```

### Q4: å·¥å…·è°ƒç”¨å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**ç­”ï¼š** åœ¨ ToolNode ä¸­å¤„ç†å¼‚å¸¸ï¼š

```python
def custom_tools_node(state: MessagesState):
    last_message = state["messages"][-1]
    tool_messages = []

    for tool_call in last_message.tool_calls:
        try:
            result = execute_tool(tool_call)
            tool_messages.append(ToolMessage(
                content=str(result),
                tool_call_id=tool_call["id"]
            ))
        except Exception as e:
            # å°†é”™è¯¯è¿”å›ç»™ AIï¼Œè®©å®ƒé‡è¯•æˆ–æ¢æ–¹æ³•
            tool_messages.append(ToolMessage(
                content=f"Error: {str(e)}. Please try a different approach.",
                tool_call_id=tool_call["id"]
            ))

    return {"messages": tool_messages}
```

### Q5: å¦‚ä½•é™åˆ¶ Agent çš„æ‰§è¡Œæˆæœ¬ï¼Ÿ

**æ–¹æ³• 1ï¼šé™åˆ¶å¾ªç¯æ¬¡æ•°**
```python
graph = builder.compile(recursion_limit=5)
```

**æ–¹æ³• 2ï¼šé™åˆ¶ token ä½¿ç”¨**
```python
class TokenTrackingState(MessagesState):
    total_tokens: int

def assistant(state: TokenTrackingState):
    if state.get("total_tokens", 0) > 10000:
        return {"messages": [AIMessage(content="Token limit reached")]}

    # è°ƒç”¨ LLM å¹¶è®°å½• token
    response = llm_with_tools.invoke(state["messages"])
    tokens_used = response.response_metadata.get("token_usage", {}).get("total_tokens", 0)

    return {
        "messages": [response],
        "total_tokens": state.get("total_tokens", 0) + tokens_used
    }
```

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [LangGraph Agent å®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/tutorials/introduction/)
- [ReAct è®ºæ–‡](https://react-lm.github.io/)
- [LangSmith Tracing æŒ‡å—](https://docs.smith.langchain.com/concepts/tracing)
- [Tool Calling æœ€ä½³å®è·µ](https://python.langchain.com/docs/how_to/tool_calling/)

---

**æ€»ç»“**ï¼šAgent æ˜¯ LangGraph çš„æ ¸å¿ƒæ¨¡å¼ï¼Œé€šè¿‡ "æ¨ç†-è¡ŒåŠ¨-è§‚å¯Ÿ" çš„å¾ªç¯ï¼Œè®© AI èƒ½å¤Ÿè‡ªä¸»å®Œæˆå¤æ‚ä»»åŠ¡ã€‚æŒæ¡ Agent çš„æ„å»ºæ–¹æ³•ï¼Œæ˜¯å¼€å‘å¼ºå¤§ AI åº”ç”¨çš„åŸºç¡€ï¼
