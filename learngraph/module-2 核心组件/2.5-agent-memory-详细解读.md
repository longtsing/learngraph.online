# LangGraph Agent Memory å¿«é€Ÿä»‹ç»

>  ç½‘ç«™ä½¿ç”¨è¯´æ˜
> - æœ¬ç½‘ç«™å¯ä»¥å…ç™»é™†è¿è¡Œ Python ä»£ç 
> - Python ä»£ç å¯ä»¥ç¼–è¾‘å¹¶ä¸´æ—¶ä¿å­˜ï¼Œä½†ä¸ä¼šæ°¸ä¹…ä¿å­˜ï¼Œç½‘é¡µåˆ·æ–°åä¼šè‡ªåŠ¨è¿˜åŸ
> - å¯¹ç½‘ç«™çš„ä½¿ç”¨æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥åˆ° [é—®é¢˜åé¦ˆ](http://localhost:5173/feedback.html) ï¼ˆæŒ‰é’®åœ¨æ¯ä¸ªé¡µé¢çš„å³ä¸‹è§’ï¼‰å…ç™»å½•è¿›è¡Œè¯„è®º
> - è¿è¡Œ `LangGraph/LangChain`ä»£ç ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥è‡ªå·±çš„ [API Key](http://localhost:5173/python-run.html)
> - é‡è¦å£°æ˜ï¼šæœ¬ç½‘ç«™ä¸ä¼šä¿å­˜ç”¨æˆ·çš„ API Key æ•°æ®ï¼Œè¯·æ”¾å¿ƒè¾“å…¥

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£è¯» LangGraph ä¸­çš„ **Agent Memoryï¼ˆæ™ºèƒ½ä½“è®°å¿†ï¼‰** æœºåˆ¶ã€‚è¿™æ˜¯æ„å»ºå¤šè½®å¯¹è¯ç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä½¿å¾— AI æ™ºèƒ½ä½“èƒ½å¤Ÿè®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œå®ç°çœŸæ­£çš„ä¸Šä¸‹æ–‡è¿ç»­æ€§ã€‚

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **Checkpointer** | åœ¨æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåè‡ªåŠ¨ä¿å­˜çŠ¶æ€çš„æŒä¹…åŒ–æœºåˆ¶ | æ¥å£ç±»ï¼Œæä¾› save/load checkpoint æ–¹æ³•ï¼Œæ”¯æŒçŠ¶æ€æ¢å¤ | â­â­â­â­â­ |
| **MemorySaver** | åŸºäºå†…å­˜çš„æ£€æŸ¥ç‚¹å™¨ï¼Œç”¨äºå¼€å‘å’Œæµ‹è¯• | Checkpointer å®ç°ï¼Œæ•°æ®å­˜å‚¨åœ¨è¿›ç¨‹å†…å­˜ä¸­ï¼Œé‡å¯åä¸¢å¤± | â­â­â­â­â­ |
| **Thread** | ç‹¬ç«‹çš„å¯¹è¯ä¼šè¯å®¹å™¨ï¼Œéš”ç¦»ä¸åŒç”¨æˆ·/ä¼šè¯çš„çŠ¶æ€ | é€šè¿‡ thread_id æ ‡è¯†ï¼Œæ¯ä¸ª thread ç»´æŠ¤ç‹¬ç«‹çš„ checkpoint å†å² | â­â­â­â­â­ |
| **thread_id** | çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒä¼šè¯ | config["configurable"]["thread_id"] é…ç½®é¡¹ï¼Œå­—ç¬¦ä¸²ç±»å‹ | â­â­â­â­â­ |
| **Config** | è¿è¡Œæ—¶é…ç½®å­—å…¸ï¼Œä¼ é€’ thread_id ç­‰å‚æ•° | invoke/stream æ–¹æ³•çš„ config å‚æ•°ï¼ŒåŒ…å« configurable å­—æ®µ | â­â­â­â­â­ |
| **Checkpoint** | æŸä¸ªæ—¶é—´ç‚¹çš„å®Œæ•´çŠ¶æ€å¿«ç…§ | åŒ…å« messages ç­‰çŠ¶æ€å­—æ®µçš„åºåˆ—åŒ–æ•°æ®ï¼Œå¯ç”¨äºæ¢å¤ | â­â­â­â­ |
| **PostgresSaver** | åŸºäº PostgreSQL æ•°æ®åº“çš„ç”Ÿäº§çº§æ£€æŸ¥ç‚¹å™¨ | Checkpointer å®ç°ï¼Œæ”¯æŒæŒä¹…åŒ–å­˜å‚¨å’Œåˆ†å¸ƒå¼éƒ¨ç½² | â­â­â­â­ |
| **add_messages** | MessagesState ä½¿ç”¨çš„æ™ºèƒ½æ¶ˆæ¯åˆå¹¶ reducer | è‡ªåŠ¨è¿½åŠ æ–°æ¶ˆæ¯ï¼Œç›¸åŒ ID çš„æ¶ˆæ¯ä¼šè¢«æ›¿æ¢è€Œéè¿½åŠ  | â­â­â­â­â­ |
| **MessagesState** | é¢„å®šä¹‰çš„æ¶ˆæ¯çŠ¶æ€ç±»ï¼ŒåŒ…å« messages å­—æ®µ | TypedDict å­ç±»ï¼Œè‡ªåŠ¨ä½¿ç”¨ add_messages reducer | â­â­â­â­â­ |
| **compile(checkpointer)** | ç¼–è¯‘å›¾æ—¶æ³¨å…¥æ£€æŸ¥ç‚¹å™¨çš„æ–¹æ³• | builder.compile(checkpointer=memory) å¯ç”¨çŠ¶æ€æŒä¹…åŒ– | â­â­â­â­â­ |

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ Agent Memoryï¼Ÿ

![Agent Architecture Review](https://cdn.prod.website-files.com/65b8cd72835ceeacd4449a53/66dbab7453080e6802cd1703_agent-memory1.png)

Agent Memory æ˜¯ LangGraph æä¾›çš„æŒä¹…åŒ–æœºåˆ¶ï¼Œå…è®¸æ™ºèƒ½ä½“åœ¨å¤šæ¬¡äº¤äº’ä¹‹é—´ä¿æŒçŠ¶æ€ã€‚å°±åƒäººç±»çš„è®°å¿†ä¸€æ ·ï¼Œå®ƒèƒ½è®© AIï¼š

- **è®°ä½å†å²å¯¹è¯**ï¼šå›å¿†ä¹‹å‰è¯´è¿‡çš„è¯
- **ç†è§£ä¸Šä¸‹æ–‡å¼•ç”¨**ï¼šç†è§£"é‚£ä¸ª"ã€"å®ƒ"ç­‰æŒ‡ä»£è¯
- **ä¿æŒè¿ç»­æ€§**ï¼šåœ¨ä¸­æ–­åç»§ç»­å¯¹è¯
- **ç»´æŠ¤ä¼šè¯çŠ¶æ€**ï¼šè·Ÿè¸ªä»»åŠ¡è¿›åº¦å’Œæ•°æ®

### ä¸ºä»€ä¹ˆéœ€è¦ Memoryï¼Ÿ

**æ²¡æœ‰ Memory çš„é—®é¢˜ï¼š**

```python
# ç¬¬ä¸€è½®å¯¹è¯
user: "3 + 4 ç­‰äºå¤šå°‘ï¼Ÿ"
agent: "ç­‰äº 7"

# ç¬¬äºŒè½®å¯¹è¯ï¼ˆæ–°çš„å›¾æ‰§è¡Œï¼‰
user: "æŠŠå®ƒä¹˜ä»¥ 2"
agent: "æŠŠä»€ä¹ˆä¹˜ä»¥ 2ï¼Ÿ" âŒ è®°ä¸ä½ 7
```

**æœ‰ Memory çš„æ•ˆæœï¼š**

```python
# ç¬¬ä¸€è½®å¯¹è¯
user: "3 + 4 ç­‰äºå¤šå°‘ï¼Ÿ"
agent: "ç­‰äº 7"

# ç¬¬äºŒè½®å¯¹è¯ï¼ˆç»§ç»­ä¹‹å‰çš„çŠ¶æ€ï¼‰
user: "æŠŠå®ƒä¹˜ä»¥ 2"
agent: "7 Ã— 2 = 14" âœ… è®°ä½äº† 7
```

---

## ğŸ”§ æŠ€æœ¯å®ç°è¯¦è§£

### 1. é—®é¢˜æ ¹æºï¼šçŠ¶æ€çš„ä¸´æ—¶æ€§

åœ¨ LangGraph ä¸­ï¼Œ**çŠ¶æ€é»˜è®¤æ˜¯ä¸´æ—¶çš„**ï¼Œåªåœ¨å•æ¬¡å›¾æ‰§è¡ŒæœŸé—´å­˜åœ¨ã€‚

```python
# æ¯æ¬¡è°ƒç”¨ invoke() éƒ½æ˜¯å…¨æ–°çš„æ‰§è¡Œ
react_graph.invoke({"messages": [msg1]})  # æ‰§è¡Œ 1ï¼šæœ‰ msg1
react_graph.invoke({"messages": [msg2]})  # æ‰§è¡Œ 2ï¼šåªæœ‰ msg2ï¼Œå¿˜è®° msg1
```

**é—®é¢˜ç¤ºæ„å›¾ï¼š**

```
æ‰§è¡Œ 1                    æ‰§è¡Œ 2
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State       â”‚          â”‚ State       â”‚
â”‚ msg: [msg1] â”‚          â”‚ msg: [msg2] â”‚  â† å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸ç›¸å…³
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è§£å†³æ–¹æ¡ˆï¼šCheckpointer

LangGraph æä¾› **Checkpointerï¼ˆæ£€æŸ¥ç‚¹å™¨ï¼‰** æœºåˆ¶ï¼Œåœ¨æ¯ä¸ªæ­¥éª¤åè‡ªåŠ¨ä¿å­˜çŠ¶æ€ã€‚

#### æ ¸å¿ƒåŸç†

```python
from langgraph.checkpoint.memory import MemorySaver

# åˆ›å»ºå†…å­˜æ£€æŸ¥ç‚¹å™¨
memory = MemorySaver()

# ç¼–è¯‘å›¾æ—¶æ³¨å…¥æ£€æŸ¥ç‚¹å™¨
graph_with_memory = builder.compile(checkpointer=memory)
```

**å·¥ä½œæµç¨‹ï¼š**

```
ç”¨æˆ·è¾“å…¥ â†’ [èŠ‚ç‚¹ 1] â†’ ğŸ’¾ ä¿å­˜çŠ¶æ€ â†’ [èŠ‚ç‚¹ 2] â†’ ğŸ’¾ ä¿å­˜çŠ¶æ€ â†’ è¾“å‡º
                 â†“                          â†“
            Checkpoint 1               Checkpoint 2
```

æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåï¼Œå½“å‰çŠ¶æ€éƒ½ä¼šè¢«ä¿å­˜åˆ°æ£€æŸ¥ç‚¹ã€‚

---

### 3. Threadï¼šä¼šè¯çº¿ç¨‹

ä¸ºäº†ç®¡ç†å¤šä¸ªç‹¬ç«‹çš„å¯¹è¯ï¼ŒLangGraph ä½¿ç”¨ **Threadï¼ˆçº¿ç¨‹ï¼‰** æ¦‚å¿µã€‚

#### Thread ID çš„ä½œç”¨

```python
# é…ç½®ï¼šæŒ‡å®šçº¿ç¨‹ ID
config = {"configurable": {"thread_id": "1"}}

# ç¬¬ä¸€è½®å¯¹è¯
graph.invoke({"messages": [msg1]}, config)  # ä¿å­˜åˆ° thread_id=1

# ç¬¬äºŒè½®å¯¹è¯ï¼ˆåŒä¸€çº¿ç¨‹ï¼‰
graph.invoke({"messages": [msg2]}, config)  # ç»§ç»­ thread_id=1 çš„çŠ¶æ€
```

**Thread ä¸ Checkpoint å¯è§†åŒ–ï¼š**

![Thread and Checkpoint](https://cdn.prod.website-files.com/65b8cd72835ceeacd4449a53/66e0e9f526b41a4ed9e2d28b_agent-memory2.png)

**Thread ç¤ºæ„å›¾ï¼š**

```
Thread ID: 1                    Thread ID: 2
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Checkpoint 1    â”‚            â”‚ Checkpoint 1    â”‚
â”‚ Checkpoint 2    â”‚            â”‚ Checkpoint 2    â”‚
â”‚ Checkpoint 3    â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘ ç”¨æˆ· A çš„å¯¹è¯                 â†‘ ç”¨æˆ· B çš„å¯¹è¯ï¼ˆç‹¬ç«‹ï¼‰
```

æ¯ä¸ª `thread_id` ç»´æŠ¤ç‹¬ç«‹çš„å¯¹è¯å†å²ï¼Œäº’ä¸å¹²æ‰°ã€‚

---

## ğŸ“– å®Œæ•´ä»£ç å®ç°

### 1. ç¯å¢ƒè®¾ç½®

```python
# å®‰è£…ä¾èµ–
%pip install --quiet -U langchain_openai langchain_core langgraph

# è®¾ç½® API Key
import os, getpass

def _set_env(var: str):
    if not os.environ.get(var):
        os.environ[var] = getpass.getpass(f"{var}: ")

_set_env("OPENAI_API_KEY")
_set_env("LANGSMITH_API_KEY")

os.environ["LANGSMITH_TRACING"] = "true"
os.environ["LANGSMITH_PROJECT"] = "langchain-academy"
```

**è¯´æ˜ï¼š**
- `OPENAI_API_KEY`ï¼šè°ƒç”¨ GPT æ¨¡å‹
- `LANGSMITH_API_KEY`ï¼šå¯ç”¨ LangSmith è¿½è¸ªï¼ˆå¯è§†åŒ–æ‰§è¡Œæµç¨‹ï¼‰

---

### 2. å®šä¹‰å·¥å…·

```python
from langchain_openai import ChatOpenAI

def add(a: int, b: int) -> int:
    """Adds a and b.

    Args:
        a: first int
        b: second int
    """
    return a + b

def multiply(a: int, b: int) -> int:
    """Multiply a and b.

    Args:
        a: first int
        b: second int
    """
    return a * b

def divide(a: int, b: int) -> float:
    """Divide a and b.

    Args:
        a: first int
        b: second int
    """
    return a / b

# å·¥å…·åˆ—è¡¨
tools = [add, multiply, divide]

# åˆ›å»º LLM å¹¶ç»‘å®šå·¥å…·
llm = ChatOpenAI(model="gpt-5-nano")
llm_with_tools = llm.bind_tools(tools)
```

**Python çŸ¥è¯†ç‚¹ï¼šDocstring çš„é‡è¦æ€§**

```python
def add(a: int, b: int) -> int:
    """Adds a and b.  # â† LLM ä¼šè¯»å–è¿™æ®µæè¿°

    Args:
        a: first int   # â† å‚æ•°è¯´æ˜å¸®åŠ© LLM ç†è§£å¦‚ä½•è°ƒç”¨
        b: second int
    """
    return a + b
```

- **LLM é€šè¿‡ Docstring ç†è§£å·¥å…·åŠŸèƒ½**
- æ¸…æ™°çš„æè¿°èƒ½æé«˜å·¥å…·è°ƒç”¨çš„å‡†ç¡®æ€§
- éµå¾ª Google é£æ ¼çš„ Docstring è§„èŒƒ

---

### 3. å®šä¹‰çŠ¶æ€å’ŒèŠ‚ç‚¹

```python
from langgraph.graph import MessagesState
from langchain_core.messages import HumanMessage, SystemMessage

# ç³»ç»Ÿæ¶ˆæ¯
sys_msg = SystemMessage(
    content="You are a helpful assistant tasked with performing arithmetic on a set of inputs."
)

# å®šä¹‰åŠ©æ‰‹èŠ‚ç‚¹
def assistant(state: MessagesState):
    return {"messages": [llm_with_tools.invoke([sys_msg] + state["messages"])]}
```

**LangGraph çŸ¥è¯†ç‚¹ï¼šMessagesState**

`MessagesState` æ˜¯ LangGraph é¢„å®šä¹‰çš„çŠ¶æ€ç±»ï¼Œä¸“é—¨ç”¨äºæ¶ˆæ¯ç®¡ç†ï¼š

```python
class MessagesState(TypedDict):
    messages: Annotated[list, add_messages]
    #          ^^^^^^^^^^^^^^^^^^^^^^^^^^
    #          è‡ªåŠ¨å¤„ç†æ¶ˆæ¯åˆ—è¡¨çš„è¿½åŠ å’Œå»é‡
```

**ç‰¹æ€§ï¼š**
- **è‡ªåŠ¨è¿½åŠ **ï¼šæ–°æ¶ˆæ¯ä¼šè‡ªåŠ¨æ·»åŠ åˆ°åˆ—è¡¨æœ«å°¾
- **æ™ºèƒ½å»é‡**ï¼šç›¸åŒ ID çš„æ¶ˆæ¯ä¼šè¢«æ›´æ–°è€Œéé‡å¤
- **ä¾¿æ·è®¿é—®**ï¼šç›´æ¥é€šè¿‡ `state["messages"]` è®¿é—®

---

### 4. æ„å»ºå›¾ï¼ˆæ—  Memoryï¼‰

```python
from langgraph.graph import START, StateGraph
from langgraph.prebuilt import tools_condition, ToolNode
from IPython.display import Image, display

# åˆ›å»ºå›¾æ„å»ºå™¨
builder = StateGraph(MessagesState)

# æ·»åŠ èŠ‚ç‚¹
builder.add_node("assistant", assistant)
builder.add_node("tools", ToolNode(tools))

# æ·»åŠ è¾¹
builder.add_edge(START, "assistant")

# æ¡ä»¶è¾¹ï¼šå†³å®šæ˜¯å¦è°ƒç”¨å·¥å…·
builder.add_conditional_edges(
    "assistant",
    tools_condition,  # å¦‚æœ assistant è¿”å›å·¥å…·è°ƒç”¨ â†’ tools èŠ‚ç‚¹
                      # å¦åˆ™ â†’ END
)

builder.add_edge("tools", "assistant")

# ç¼–è¯‘ï¼ˆæ—  Memoryï¼‰
react_graph = builder.compile()

# å¯è§†åŒ–
display(Image(react_graph.get_graph(xray=True).draw_mermaid_png()))
```

**LangGraph çŸ¥è¯†ç‚¹ï¼štools_condition**

`tools_condition` æ˜¯ LangGraph é¢„å®šä¹‰çš„æ¡ä»¶å‡½æ•°ï¼š

```python
def tools_condition(state: MessagesState) -> Literal["tools", "__end__"]:
    """æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦åŒ…å«å·¥å…·è°ƒç”¨"""
    last_message = state["messages"][-1]
    if last_message.tool_calls:
        return "tools"  # æœ‰å·¥å…·è°ƒç”¨ â†’ è¿›å…¥ tools èŠ‚ç‚¹
    return "__end__"    # æ— å·¥å…·è°ƒç”¨ â†’ ç»“æŸ
```

**ToolNode çš„ä½œç”¨ï¼š**

```python
ToolNode(tools)
```

- è‡ªåŠ¨æ‰§è¡Œå·¥å…·è°ƒç”¨
- å°†å·¥å…·è¾“å‡ºåŒ…è£…æˆ `ToolMessage`
- æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨ä¸­

---

### 5. æµ‹è¯•æ—  Memory çš„é—®é¢˜

#### ç¬¬ä¸€è½®å¯¹è¯

```python
messages = [HumanMessage(content="Add 3 and 4.")]
messages = react_graph.invoke({"messages": messages})

for m in messages['messages']:
    m.pretty_print()
```

**è¾“å‡ºï¼š**

```
================================ Human Message =================================
Add 3 and 4.

================================== Ai Message ==================================
Tool Calls:
  add (call_zZ4JPASfUinchT8wOqg9hCZO)
  Args:
    a: 3
    b: 4

================================= Tool Message =================================
Name: add
7

================================== Ai Message ==================================
The sum of 3 and 4 is 7.
```

#### ç¬¬äºŒè½®å¯¹è¯ï¼ˆé—®é¢˜å‡ºç°ï¼‰

```python
messages = [HumanMessage(content="Multiply that by 2.")]
messages = react_graph.invoke({"messages": messages})

for m in messages['messages']:
    m.pretty_print()
```

**è¾“å‡ºï¼š**

```
================================ Human Message =================================
Multiply that by 2.

================================== Ai Message ==================================
Tool Calls:
  multiply (call_prnkuG7OYQtbrtVQmH2d3Nl7)
  Args:
    a: 2  # âŒ é”™è¯¯ï¼åº”è¯¥æ˜¯ 7
    b: 2

================================= Tool Message =================================
Name: multiply
4

================================== Ai Message ==================================
The result of multiplying 2 by 2 is 4.  # âŒ åº”è¯¥æ˜¯ 14
```

**é—®é¢˜åˆ†æï¼š**

- LLM ä¸çŸ¥é“"é‚£ä¸ª"ï¼ˆthatï¼‰æŒ‡çš„æ˜¯ä»€ä¹ˆ
- å› ä¸º**æ¯æ¬¡ `invoke()` éƒ½æ˜¯å…¨æ–°çš„æ‰§è¡Œ**ï¼Œæ²¡æœ‰å†å²ä¸Šä¸‹æ–‡
- LLM åªçœ‹åˆ° "Multiply that by 2."ï¼Œæ— æ³•ç†è§£ "that" çš„å«ä¹‰

---

### 6. æ·»åŠ  Memory

```python
from langgraph.checkpoint.memory import MemorySaver

# åˆ›å»ºå†…å­˜æ£€æŸ¥ç‚¹å™¨
memory = MemorySaver()

# é‡æ–°ç¼–è¯‘å›¾ï¼ˆå¸¦ Memoryï¼‰
react_graph_memory = builder.compile(checkpointer=memory)
```

**MemorySaver è¯¦è§£ï¼š**

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **ç±»å‹** | å†…å­˜é”®å€¼å­˜å‚¨ |
| **æŒä¹…åŒ–** | ä»…åœ¨è¿›ç¨‹è¿è¡ŒæœŸé—´ |
| **ç”¨é€”** | å¼€å‘ã€æµ‹è¯•ã€æ¼”ç¤º |
| **ç”Ÿäº§æ›¿ä»£** | PostgresSaver, RedisSaver ç­‰ |

**ä¸ºä»€ä¹ˆä¸ç”¨äºç”Ÿäº§ï¼Ÿ**

```python
memory = MemorySaver()  # æ•°æ®å­˜åœ¨å†…å­˜ä¸­

# é—®é¢˜ï¼š
# 1. è¿›ç¨‹é‡å¯ â†’ æ•°æ®ä¸¢å¤±
# 2. å¤šè¿›ç¨‹éƒ¨ç½² â†’ æ•°æ®ä¸å…±äº«
# 3. æ— æ³•æŒä¹…åŒ–å­˜å‚¨
```

**ç”Ÿäº§ç¯å¢ƒæ¨èï¼š**

```python
from langgraph.checkpoint.postgres import PostgresSaver

# è¿æ¥æ•°æ®åº“
checkpointer = PostgresSaver.from_conn_string(
    "postgresql://user:pass@localhost/db"
)

graph = builder.compile(checkpointer=checkpointer)
```

---

### 7. ä½¿ç”¨ Thread ID

```python
# é…ç½®çº¿ç¨‹ ID
config = {"configurable": {"thread_id": "1"}}

# ç¬¬ä¸€è½®å¯¹è¯
messages = [HumanMessage(content="Add 3 and 4.")]
messages = react_graph_memory.invoke({"messages": messages}, config)

for m in messages['messages']:
    m.pretty_print()
```

**è¾“å‡ºï¼š**

```
================================ Human Message =================================
Add 3 and 4.

================================== Ai Message ==================================
Tool Calls:
  add (call_MSupVAgej4PShIZs7NXOE6En)
  Args:
    a: 3
    b: 4

================================= Tool Message =================================
Name: add
7

================================== Ai Message ==================================
The sum of 3 and 4 is 7.
```

**æ£€æŸ¥ç‚¹ä¿å­˜ç¤ºæ„ï¼š**

```
Thread ID: 1
â”œâ”€ Checkpoint 0: {"messages": [HumanMessage("Add 3 and 4.")]}
â”œâ”€ Checkpoint 1: {"messages": [..., AIMessage(tool_calls=[...])]}
â”œâ”€ Checkpoint 2: {"messages": [..., ToolMessage("7")]}
â””â”€ Checkpoint 3: {"messages": [..., AIMessage("The sum is 7.")]}
```

---

### 8. ç»§ç»­å¯¹è¯ï¼ˆMemory ç”Ÿæ•ˆï¼‰

```python
# åŒä¸€çº¿ç¨‹ï¼Œæ–°æ¶ˆæ¯
messages = [HumanMessage(content="Multiply that by 2.")]
messages = react_graph_memory.invoke({"messages": messages}, config)

for m in messages['messages']:
    m.pretty_print()
```

**è¾“å‡ºï¼š**

```
================================ Human Message =================================
Add 3 and 4.
                                   â†‘ å†å²æ¶ˆæ¯ï¼ˆä»æ£€æŸ¥ç‚¹åŠ è½½ï¼‰

================================== Ai Message ==================================
Tool Calls:
  add (...)
  Args:
    a: 3
    b: 4

================================= Tool Message =================================
Name: add
7

================================== Ai Message ==================================
The sum of 3 and 4 is 7.

================================ Human Message =================================
Multiply that by 2.
                   â†‘ æ–°æ¶ˆæ¯ï¼ˆè¿½åŠ åˆ°å†å²ï¼‰

================================== Ai Message ==================================
Tool Calls:
  multiply (call_fWN7lnSZZm82tAg7RGeuWusO)
  Args:
    a: 7  # âœ… æ­£ç¡®ï¼è®°ä½äº†ä¹‹å‰çš„ 7
    b: 2

================================= Tool Message =================================
Name: multiply
14

================================== Ai Message ==================================
The result of multiplying 7 by 2 is 14.  # âœ… æ­£ç¡®ç­”æ¡ˆ
```

**å…³é”®è§‚å¯Ÿï¼š**

1. **å†å²æ¶ˆæ¯è‡ªåŠ¨åŠ è½½**ï¼šè¾“å‡ºåŒ…å«äº†ç¬¬ä¸€è½®å¯¹è¯çš„æ‰€æœ‰æ¶ˆæ¯
2. **ä¸Šä¸‹æ–‡ç†è§£**ï¼šLLM çŸ¥é“ "that" æŒ‡çš„æ˜¯ 7
3. **æ­£ç¡®è®¡ç®—**ï¼š7 Ã— 2 = 14

---

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### LangGraph ç‰¹æœ‰æ¦‚å¿µ

#### 1. Checkpointerï¼ˆæ£€æŸ¥ç‚¹å™¨ï¼‰

**ä½œç”¨ï¼š** åœ¨æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåè‡ªåŠ¨ä¿å­˜çŠ¶æ€

```python
from langgraph.checkpoint.memory import MemorySaver

memory = MemorySaver()
graph = builder.compile(checkpointer=memory)
```

**ä¿å­˜æ—¶æœºï¼š**

```
èŠ‚ç‚¹æ‰§è¡Œå‰    èŠ‚ç‚¹æ‰§è¡Œ       èŠ‚ç‚¹æ‰§è¡Œå
    â†“          â†“              â†“
 åŠ è½½çŠ¶æ€   â†’ å¤„ç†æ•°æ®   â†’  ğŸ’¾ ä¿å­˜çŠ¶æ€
```

#### 2. Threadï¼ˆçº¿ç¨‹ï¼‰

**ä½œç”¨ï¼š** éš”ç¦»ä¸åŒç”¨æˆ·/ä¼šè¯çš„çŠ¶æ€

```python
# ç”¨æˆ· A
config_a = {"configurable": {"thread_id": "user_a"}}
graph.invoke(input, config_a)

# ç”¨æˆ· Bï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰
config_b = {"configurable": {"thread_id": "user_b"}}
graph.invoke(input, config_b)
```

**Thread å±‚çº§ç»“æ„ï¼š**

```
Checkpointerï¼ˆå…¨å±€ï¼‰
â”œâ”€ Thread: user_a
â”‚  â”œâ”€ Checkpoint 1
â”‚  â”œâ”€ Checkpoint 2
â”‚  â””â”€ Checkpoint 3
â”œâ”€ Thread: user_b
â”‚  â”œâ”€ Checkpoint 1
â”‚  â””â”€ Checkpoint 2
â””â”€ Thread: user_c
   â””â”€ Checkpoint 1
```

#### 3. Configï¼ˆé…ç½®ï¼‰

```python
config = {
    "configurable": {
        "thread_id": "1",           # å¿…éœ€ï¼šçº¿ç¨‹æ ‡è¯†
        "checkpoint_id": "...",     # å¯é€‰ï¼šç‰¹å®šæ£€æŸ¥ç‚¹
        "checkpoint_ns": "..."      # å¯é€‰ï¼šæ£€æŸ¥ç‚¹å‘½åç©ºé—´
    }
}
```

**configurable çš„ä½œç”¨ï¼š**
- ä¼ é€’è¿è¡Œæ—¶é…ç½®
- ä¸å½±å“çŠ¶æ€ç»“æ„
- ç”¨äºæ£€æŸ¥ç‚¹ç®¡ç†

---

### Python ç‰¹æœ‰çŸ¥è¯†ç‚¹

#### 1. Type Hintsï¼ˆç±»å‹æç¤ºï¼‰

```python
def add(a: int, b: int) -> int:
    #      ^^^^^  ^^^^^    ^^^
    #      å‚æ•°ç±»å‹        è¿”å›ç±»å‹
    return a + b
```

**ä¼˜åŠ¿ï¼š**
- **IDE æ”¯æŒ**ï¼šè‡ªåŠ¨è¡¥å…¨ã€ç±»å‹æ£€æŸ¥
- **æ–‡æ¡£ä½œç”¨**ï¼šæ˜ç¡®å‡½æ•°ç­¾å
- **LangChain é›†æˆ**ï¼šè‡ªåŠ¨è½¬æ¢ä¸ºå·¥å…·æ¨¡å¼

#### 2. Docstringï¼ˆæ–‡æ¡£å­—ç¬¦ä¸²ï¼‰

```python
def multiply(a: int, b: int) -> int:
    """Multiply a and b.  # åŠŸèƒ½æè¿°

    Args:                 # å‚æ•°è¯´æ˜
        a: first int
        b: second int
    """
    return a * b
```

**LangChain å¦‚ä½•ä½¿ç”¨ Docstringï¼Ÿ**

```python
# LangChain è‡ªåŠ¨è§£æå‡½æ•°ç­¾å
tools = [multiply]

# ç”Ÿæˆå·¥å…·æ¨¡å¼ï¼ˆOpenAI Function Calling æ ¼å¼ï¼‰
{
    "name": "multiply",
    "description": "Multiply a and b.",  # â† æ¥è‡ª Docstring
    "parameters": {
        "type": "object",
        "properties": {
            "a": {"type": "integer", "description": "first int"},
            "b": {"type": "integer", "description": "second int"}
        }
    }
}
```

#### 3. Literalï¼ˆå­—é¢é‡ç±»å‹ï¼‰

```python
from typing import Literal

def route(state) -> Literal["tools", "__end__"]:
    #                  ^^^^^^^^^^^^^^^^^^^^^^^^
    #                  è¿”å›å€¼åªèƒ½æ˜¯è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²ä¹‹ä¸€
    if condition:
        return "tools"
    return "__end__"
```

**ä½œç”¨ï¼š**
- é™åˆ¶è¿”å›å€¼èŒƒå›´
- IDE å¯ä»¥æ£€æŸ¥æ‹¼å†™é”™è¯¯
- æé«˜ä»£ç å¯é æ€§

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½•æ—¶ä½¿ç”¨ Memoryï¼Ÿ

âœ… **é€‚ç”¨åœºæ™¯ï¼š**
- å¤šè½®å¯¹è¯ç³»ç»Ÿï¼ˆèŠå¤©æœºå™¨äººï¼‰
- éœ€è¦ä¸Šä¸‹æ–‡çš„ä»»åŠ¡ï¼ˆ"ç»§ç»­"ã€"é‚£ä¸ª"ç­‰æŒ‡ä»£ï¼‰
- é•¿æœŸä»»åŠ¡è¿½è¸ªï¼ˆä»»åŠ¡è¿›åº¦ã€ç”¨æˆ·åå¥½ï¼‰
- è°ƒè¯•å’Œå®¡è®¡ï¼ˆæŸ¥çœ‹å†å²æ‰§è¡Œï¼‰

âŒ **ä¸é€‚ç”¨åœºæ™¯ï¼š**
- æ— çŠ¶æ€ APIï¼ˆæ¯æ¬¡è¯·æ±‚ç‹¬ç«‹ï¼‰
- æ‰¹å¤„ç†ä»»åŠ¡ï¼ˆæ— éœ€è®°å¿†ï¼‰
- ä¸€æ¬¡æ€§æŸ¥è¯¢ï¼ˆé—®ç­”ç³»ç»Ÿçš„å•æ¬¡é—®ç­”ï¼‰

### 2. Thread ID è®¾è®¡åŸåˆ™

#### åŸåˆ™ 1ï¼šæŒ‰ç”¨æˆ·éš”ç¦»

```python
# âœ… å¥½çš„è®¾è®¡
config = {"configurable": {"thread_id": f"user_{user_id}"}}

# âŒ ä¸å¥½çš„è®¾è®¡
config = {"configurable": {"thread_id": "global"}}  # æ‰€æœ‰ç”¨æˆ·å…±äº«
```

#### åŸåˆ™ 2ï¼šæŒ‰ä¼šè¯éš”ç¦»

```python
# âœ… æ›´ç»†ç²’åº¦çš„éš”ç¦»
import uuid

session_id = str(uuid.uuid4())
config = {"configurable": {"thread_id": f"{user_id}_{session_id}"}}
```

#### åŸåˆ™ 3ï¼šæœ‰æ„ä¹‰çš„å‘½å

```python
# âœ… æ¸…æ™°çš„å‘½å
thread_id = f"support_ticket_{ticket_id}"
thread_id = f"order_processing_{order_id}"

# âŒ æ— æ„ä¹‰çš„å‘½å
thread_id = "123"
thread_id = "abc"
```

### 3. Checkpointer é€‰æ‹©

| åœºæ™¯ | æ¨è Checkpointer | ç†ç”± |
|------|------------------|------|
| **å¼€å‘/æµ‹è¯•** | `MemorySaver` | ç®€å•ã€å¿«é€Ÿ |
| **ç”Ÿäº§ï¼ˆå°è§„æ¨¡ï¼‰** | `SqliteSaver` | æŒä¹…åŒ–ã€å•æœºéƒ¨ç½² |
| **ç”Ÿäº§ï¼ˆåˆ†å¸ƒå¼ï¼‰** | `PostgresSaver` | æ”¯æŒå¹¶å‘ã€å¯æ‰©å±• |
| **é«˜æ€§èƒ½** | `RedisSaver` | ä½å»¶è¿Ÿã€é«˜åå |

**ç¤ºä¾‹ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®**

```python
from langgraph.checkpoint.postgres import PostgresSaver

# æ•°æ®åº“è¿æ¥
checkpointer = PostgresSaver.from_conn_string(
    "postgresql://user:pass@localhost/langchain_db"
)

# ç¼–è¯‘å›¾
graph = builder.compile(checkpointer=checkpointer)

# ä½¿ç”¨ï¼ˆä¸ MemorySaver å®Œå…¨ç›¸åŒï¼‰
config = {"configurable": {"thread_id": "user_123"}}
graph.invoke(input, config)
```

---

## ğŸš€ è¿›é˜¶æŠ€å·§

### 1. æ£€æŸ¥ç‚¹å†å²æŸ¥è¯¢

```python
# è·å–çº¿ç¨‹çš„æ‰€æœ‰æ£€æŸ¥ç‚¹
config = {"configurable": {"thread_id": "1"}}

# åˆ—å‡ºæ‰€æœ‰æ£€æŸ¥ç‚¹
checkpoints = list(graph.checkpointer.list(config))

for checkpoint in checkpoints:
    print(f"Checkpoint ID: {checkpoint.id}")
    print(f"State: {checkpoint.state}")
```

### 2. å›æº¯åˆ°ç‰¹å®šæ£€æŸ¥ç‚¹

```python
# è·å–ç‰¹å®šæ£€æŸ¥ç‚¹çš„çŠ¶æ€
config = {
    "configurable": {
        "thread_id": "1",
        "checkpoint_id": "abc123"  # æŒ‡å®šæ£€æŸ¥ç‚¹
    }
}

# ä»è¿™ä¸ªæ£€æŸ¥ç‚¹ç»§ç»­æ‰§è¡Œ
graph.invoke(new_input, config)
```

### 3. æ¸…ç†æ—§æ£€æŸ¥ç‚¹

```python
# åˆ é™¤çº¿ç¨‹çš„æ‰€æœ‰æ£€æŸ¥ç‚¹
config = {"configurable": {"thread_id": "1"}}
graph.checkpointer.delete_thread(config)
```

### 4. æ¡ä»¶æ€§ä¿å­˜

```python
# åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹ä¿å­˜æ£€æŸ¥ç‚¹
def conditional_checkpoint(state):
    if state.get("important"):
        # ä¿å­˜
        return state
    else:
        # è·³è¿‡ä¿å­˜ï¼ˆé€šè¿‡è‡ªå®šä¹‰é€»è¾‘ï¼‰
        pass
```

---

## ğŸ“Š Memory vs No Memory å¯¹æ¯”

| ç‰¹æ€§ | æ—  Memory | æœ‰ Memory |
|------|----------|-----------|
| **çŠ¶æ€æŒä¹…åŒ–** | âŒ | âœ… |
| **å¤šè½®å¯¹è¯** | âŒ | âœ… |
| **ä¸Šä¸‹æ–‡å¼•ç”¨** | âŒ | âœ… |
| **è°ƒè¯•ä¾¿åˆ©æ€§** | âŒ | âœ… |
| **æ€§èƒ½å¼€é”€** | ä½ | ä¸­ï¼ˆå–å†³äº Checkpointerï¼‰ |
| **å­˜å‚¨éœ€æ±‚** | æ—  | æœ‰ |
| **é€‚ç”¨åœºæ™¯** | å•æ¬¡æŸ¥è¯¢ | å¯¹è¯ç³»ç»Ÿ |

---

## ğŸ¯ å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šå®¢æœæœºå™¨äºº

```python
# ç”¨æˆ·å¼€å§‹å¯¹è¯
config = {"configurable": {"thread_id": f"customer_{customer_id}"}}

# ç¬¬ 1 è½®
user: "æˆ‘çš„è®¢å•å·æ˜¯ 12345"
agent: "å¥½çš„ï¼Œæˆ‘çœ‹åˆ°æ‚¨çš„è®¢å• 12345 äº†"

# ç¬¬ 2 è½®ï¼ˆå‡ åˆ†é’Ÿåï¼‰
user: "é‚£ä¸ªè®¢å•å‘è´§äº†å—ï¼Ÿ"
agent: "è®¢å• 12345 å·²äºä»Šå¤©ä¸Šåˆå‘è´§"  # âœ… è®°ä½äº†è®¢å•å·
```

### æ¡ˆä¾‹ 2ï¼šå¤šæ­¥éª¤ä»»åŠ¡

```python
# æ•°æ®åˆ†æä»»åŠ¡
config = {"configurable": {"thread_id": f"analysis_{task_id}"}}

# æ­¥éª¤ 1
user: "åŠ è½½ sales.csv"
agent: "å·²åŠ è½½ 1000 æ¡é”€å”®è®°å½•"

# æ­¥éª¤ 2
user: "è®¡ç®—æ€»æ”¶å…¥"
agent: "æ€»æ”¶å…¥ï¼š$50,000"  # âœ… è®°ä½äº†åŠ è½½çš„æ•°æ®

# æ­¥éª¤ 3
user: "ç”Ÿæˆå›¾è¡¨"
agent: "å·²ç”Ÿæˆæ”¶å…¥è¶‹åŠ¿å›¾"  # âœ… åŸºäºä¹‹å‰çš„è®¡ç®—
```

### æ¡ˆä¾‹ 3ï¼šç”¨æˆ·åå¥½å­¦ä¹ 

```python
# é•¿æœŸç”¨æˆ·äº¤äº’
config = {"configurable": {"thread_id": f"user_{user_id}"}}

# ç¬¬ 1 æ¬¡äº¤äº’
user: "æˆ‘å–œæ¬¢ç®€æ´çš„å›ç­”"
agent: "å¥½çš„ï¼Œæˆ‘ä¼šç®€æ´å›å¤"

# ç¬¬ 100 æ¬¡äº¤äº’ï¼ˆæ•°å¤©åï¼‰
user: "è§£é‡Šé‡å­è®¡ç®—"
agent: "ç®€å•è¯´ï¼šç”¨é‡å­æ€å¹¶è¡Œè®¡ç®—"  # âœ… è®°ä½äº†ç”¨æˆ·åå¥½
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: MemorySaver å’Œæ•°æ®åº“ Checkpointer æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**MemorySaverï¼š**
- æ•°æ®å­˜åœ¨ Python è¿›ç¨‹å†…å­˜ä¸­
- è¿›ç¨‹é‡å¯ â†’ æ•°æ®ä¸¢å¤±
- é€‚åˆå¼€å‘å’Œæµ‹è¯•

**PostgresSaverï¼š**
- æ•°æ®å­˜åœ¨æ•°æ®åº“ä¸­
- æŒä¹…åŒ–å­˜å‚¨
- æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
- é€‚åˆç”Ÿäº§ç¯å¢ƒ

### Q2: å¦‚ä½•å®ç°å¤šç”¨æˆ·éš”ç¦»ï¼Ÿ

ä½¿ç”¨ä¸åŒçš„ `thread_id`ï¼š

```python
# ç”¨æˆ· A
config_a = {"configurable": {"thread_id": "user_123"}}
graph.invoke(input_a, config_a)

# ç”¨æˆ· Bï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰
config_b = {"configurable": {"thread_id": "user_456"}}
graph.invoke(input_b, config_b)
```

### Q3: æ£€æŸ¥ç‚¹ä¼šå ç”¨å¤šå°‘å­˜å‚¨ç©ºé—´ï¼Ÿ

**å–å†³äºï¼š**
- æ¶ˆæ¯æ•°é‡å’Œå¤§å°
- æ£€æŸ¥ç‚¹ä¿ç•™ç­–ç•¥
- çŠ¶æ€å¤æ‚åº¦

**ä¼˜åŒ–å»ºè®®ï¼š**

```python
# 1. å®šæœŸæ¸…ç†æ—§çº¿ç¨‹
if thread_inactive_for_days(30):
    checkpointer.delete_thread(config)

# 2. é™åˆ¶æ¶ˆæ¯å†å²é•¿åº¦
def trim_messages(state):
    # åªä¿ç•™æœ€è¿‘ 50 æ¡æ¶ˆæ¯
    state["messages"] = state["messages"][-50:]
    return state
```

### Q4: å¯ä»¥åœ¨ä¸åŒå›¾ä¹‹é—´å…±äº« Memory å—ï¼Ÿ

å¯ä»¥ï¼Œåªè¦ä½¿ç”¨ç›¸åŒçš„ `checkpointer` å’Œ `thread_id`ï¼š

```python
# å…±äº«æ£€æŸ¥ç‚¹å™¨
shared_memory = MemorySaver()

graph_1 = builder_1.compile(checkpointer=shared_memory)
graph_2 = builder_2.compile(checkpointer=shared_memory)

# ä½¿ç”¨ç›¸åŒçš„ thread_id
config = {"configurable": {"thread_id": "shared_thread"}}

graph_1.invoke(input_1, config)  # å†™å…¥çŠ¶æ€
graph_2.invoke(input_2, config)  # è¯»å–ç›¸åŒçŠ¶æ€
```

**æ³¨æ„ï¼š** ä¸¤ä¸ªå›¾çš„çŠ¶æ€ç»“æ„å¿…é¡»å…¼å®¹ï¼

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [LangGraph Persistence å®˜æ–¹æ–‡æ¡£](https://langchain-ai.github.io/langgraph/concepts/persistence/)
- [Checkpointer æ¥å£è¯¦è§£](https://langchain-ai.github.io/langgraph/reference/checkpoints/)
- [Memory ç®¡ç†æœ€ä½³å®è·µ](https://langchain-ai.github.io/langgraph/how-tos/memory/)

---

## ğŸ¬ æ€»ç»“

Agent Memory æ˜¯ LangGraph æ„å»ºå¤šè½®å¯¹è¯ç³»ç»Ÿçš„åŸºç¡€èƒ½åŠ›ï¼š

1. **Checkpointer** è‡ªåŠ¨ä¿å­˜æ¯ä¸ªæ­¥éª¤çš„çŠ¶æ€
2. **Thread ID** éš”ç¦»ä¸åŒç”¨æˆ·/ä¼šè¯çš„æ•°æ®
3. **Config** ä¼ é€’è¿è¡Œæ—¶é…ç½®ï¼Œæ§åˆ¶æ£€æŸ¥ç‚¹è¡Œä¸º

é€šè¿‡è¿™äº›æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºçœŸæ­£å…·æœ‰"è®°å¿†"çš„æ™ºèƒ½ä½“ï¼Œå®ç°è‡ªç„¶ã€è¿è´¯çš„å¤šè½®äº¤äº’ï¼

**æ ¸å¿ƒè¦ç‚¹ï¼š**
- å¼€å‘ç”¨ `MemorySaver`ï¼Œç”Ÿäº§ç”¨ `PostgresSaver`
- æ¯ä¸ªç”¨æˆ·/ä¼šè¯ä½¿ç”¨å”¯ä¸€çš„ `thread_id`
- å®šæœŸæ¸…ç†æ— ç”¨çš„æ£€æŸ¥ç‚¹æ•°æ®
- ç»“åˆ LangSmith è¿½è¸ªï¼Œè°ƒè¯• Memory è¡Œä¸º
