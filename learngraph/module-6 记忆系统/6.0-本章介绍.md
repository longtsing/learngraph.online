# Module-6: è®°å¿†ç³»ç»Ÿï¼ˆMemory Systemsï¼‰- æœ¬ç« ä»‹ç»

> **è‡´å­¦ä¹ è€…çš„ä¸€å°ä¿¡**
>
> æ¬¢è¿æ¥åˆ° Module-6ï¼ä½œä¸ºåœ¨äººå·¥æ™ºèƒ½é¢†åŸŸè€•è€˜æ•°åå¹´çš„ç ”ç©¶è€…ï¼Œæˆ‘è§è¯äº† AI ç³»ç»Ÿä»ç®€å•çš„è§„åˆ™å¼•æ“æ¼”å˜ä¸ºä»Šå¤©å…·å¤‡å¤æ‚è®¤çŸ¥èƒ½åŠ›çš„æ™ºèƒ½ä½“ã€‚è€Œåœ¨è¿™ä¸ªæ¼”å˜è¿‡ç¨‹ä¸­ï¼Œ**è®°å¿†ç³»ç»Ÿ**å§‹ç»ˆæ˜¯æ ¸å¿ƒæŒ‘æˆ˜ä¹‹ä¸€ã€‚
>
> æƒ³è±¡ä¸€ä¸‹ï¼šå¦‚æœ AI åŠ©æ‰‹æ¯æ¬¡å¯¹è¯éƒ½åƒç¬¬ä¸€æ¬¡è§é¢ï¼Œå®ƒå¦‚ä½•èƒ½çœŸæ­£ç†è§£ä½ çš„éœ€æ±‚ï¼Ÿå¦‚ä½•æä¾›ä¸ªæ€§åŒ–çš„æœåŠ¡ï¼Ÿå¦‚ä½•åœ¨é•¿æœŸäº¤äº’ä¸­ä¸æ–­æ”¹è¿›ï¼Ÿè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ç³»ç»ŸåŒ–çš„è®°å¿†æœºåˆ¶ã€‚
>
> åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»è®¤çŸ¥ç§‘å­¦çš„è§’åº¦å‡ºå‘,æ·±å…¥æ¢è®¨å¦‚ä½•ä¸º LangGraph Agent æ„å»º**çŸ­æœŸè®°å¿†**å’Œ**é•¿æœŸè®°å¿†**ç³»ç»Ÿã€‚ä½ å°†å­¦ä¼šå¦‚ä½•è®© AI ä¸ä»…è®°ä½äº‹å®,è¿˜èƒ½ç»“æ„åŒ–åœ°ç»„ç»‡å’Œæ›´æ–°è¿™äº›ä¿¡æ¯ã€‚æ›´é‡è¦çš„æ˜¯,ä½ å°†ç†è§£**ä½•æ—¶ä½¿ç”¨ä½•ç§è®°å¿†æ¨¡å¼**â€”â€”è¿™æ˜¯åŒºåˆ†ä¼˜ç§€å·¥ç¨‹å¸ˆå’Œå“è¶Šæ¶æ„å¸ˆçš„å…³é”®ã€‚
>
> è®°ä½ï¼šå¥½çš„è®°å¿†ç³»ç»Ÿä¸æ˜¯å­˜å‚¨æ‰€æœ‰ä¸œè¥¿,è€Œæ˜¯**æ™ºèƒ½åœ°ä¿å­˜ã€ç»„ç»‡å’Œæ£€ç´¢å…³é”®ä¿¡æ¯**ã€‚è®©æˆ‘ä»¬å¼€å§‹è¿™æ®µæ¿€åŠ¨äººå¿ƒçš„æ—…ç¨‹ï¼
>
> â€”â€” ä½ çš„ LangGraph å¯¼å¸ˆ

---

## ä¸€ã€æœ¬ç« å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬ç« å­¦ä¹ å,ä½ å°†èƒ½å¤Ÿï¼š

### æ ¸å¿ƒèƒ½åŠ›
1. **è®°å¿†ç³»ç»Ÿæ¶æ„**
   - ç†è§£çŸ­æœŸè®°å¿†ï¼ˆCheckpointerï¼‰ä¸é•¿æœŸè®°å¿†ï¼ˆStoreï¼‰çš„æœ¬è´¨åŒºåˆ«
   - æŒæ¡ LangGraph Memory Store çš„ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼šnamespaceã€keyã€value
   - è®¾è®¡é€‚åˆä¸åŒåœºæ™¯çš„è®°å¿†æ¶æ„

2. **ç»“æ„åŒ–è®°å¿†ç®¡ç†**
   - ä½¿ç”¨ Pydantic å®šä¹‰å’ŒéªŒè¯è®°å¿† Schema
   - åŒºåˆ† Profileï¼ˆå•ä¸€å¯¹è±¡ï¼‰å’Œ Collectionï¼ˆè®°å¿†é›†åˆï¼‰çš„ä½¿ç”¨åœºæ™¯
   - å®ç°å¢é‡æ›´æ–°è€Œéå®Œå…¨é‡å†™çš„é«˜æ•ˆè®°å¿†ç®¡ç†

3. **Trustcall é›†æˆ**
   - ä½¿ç”¨ Trustcall ä»å¯¹è¯ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯
   - ç†è§£ JSON Patch æœºåˆ¶å’Œ `enable_inserts` å‚æ•°
   - æ„å»ºèƒ½å¤Ÿè‡ªä¸»å†³ç­–ä½•æ—¶ä¿å­˜è®°å¿†çš„æ™ºèƒ½ Agent

4. **å®æˆ˜åº”ç”¨**
   - æ„å»ºè·¨ä¼šè¯çš„ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äºº
   - å®ç°å¤šç±»å‹è®°å¿†çš„ååŒç®¡ç†ï¼ˆProfile + Collection + Instructionsï¼‰
   - ä¼˜åŒ–è®°å¿†ç³»ç»Ÿçš„æ€§èƒ½å’Œå¯æ‰©å±•æ€§

### è®¤çŸ¥å‡çº§
- **ä»å­˜å‚¨åˆ°æ™ºèƒ½**ï¼šè¶…è¶Šç®€å•çš„é”®å€¼å¯¹å­˜å‚¨ï¼Œç†è§£è®°å¿†çš„è¯­ä¹‰ç»„ç»‡
- **ä»é™æ€åˆ°åŠ¨æ€**ï¼šæŒæ¡è®°å¿†çš„å¢é‡æ›´æ–°å’Œæ™ºèƒ½åˆå¹¶
- **ä»å•ä¸€åˆ°å¤šå…ƒ**ï¼šå­¦ä¼šä¸ºä¸åŒç±»å‹çš„ä¿¡æ¯é€‰æ‹©åˆé€‚çš„è®°å¿†æ¨¡å¼

---

## äºŒã€æ ¸å¿ƒæ¦‚å¿µé¢„è§ˆ

### 2.1 è®°å¿†çš„è®¤çŸ¥ç§‘å­¦åŸºç¡€

åœ¨å¼€å§‹æŠ€æœ¯å®ç°ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç†è§£**è®°å¿†åœ¨è®¤çŸ¥ç§‘å­¦ä¸­çš„åˆ†ç±»**ï¼š

```
äººç±»è®°å¿†ç³»ç»Ÿ
â”œâ”€â”€ çŸ­æœŸè®°å¿†ï¼ˆShort-term Memoryï¼‰
â”‚   â”œâ”€â”€ å·¥ä½œè®°å¿†ï¼ˆWorking Memoryï¼‰
â”‚   â””â”€â”€ å®¹é‡æœ‰é™ï¼ˆ7Â±2 ä¸ªé¡¹ç›®ï¼‰
â”‚
â””â”€â”€ é•¿æœŸè®°å¿†ï¼ˆLong-term Memoryï¼‰
    â”œâ”€â”€ é™ˆè¿°æ€§è®°å¿†ï¼ˆDeclarative Memoryï¼‰
    â”‚   â”œâ”€â”€ è¯­ä¹‰è®°å¿†ï¼ˆSemanticï¼‰â”€â”€ äº‹å®å’ŒçŸ¥è¯†
    â”‚   â””â”€â”€ æƒ…èŠ‚è®°å¿†ï¼ˆEpisodicï¼‰â”€â”€ äº‹ä»¶å’Œç»å†
    â”‚
    â””â”€â”€ ç¨‹åºæ€§è®°å¿†ï¼ˆProcedural Memoryï¼‰â”€â”€ æŠ€èƒ½å’Œä¹ æƒ¯
```

**åœ¨ LangGraph ä¸­çš„æ˜ å°„**ï¼š

| è®¤çŸ¥ç§‘å­¦æ¦‚å¿µ | LangGraph å®ç° | æŠ€æœ¯ç»„ä»¶ | ç”¨é€” |
|------------|---------------|---------|------|
| çŸ­æœŸè®°å¿† | Within-Thread Memory | MemorySaver (Checkpointer) | å•æ¬¡ä¼šè¯çš„å¯¹è¯å†å² |
| è¯­ä¹‰è®°å¿† | Profile / Collection | InMemoryStore | ç”¨æˆ·èµ„æ–™ã€å¾…åŠäº‹é¡¹ |
| ç¨‹åºæ€§è®°å¿† | Instructions | InMemoryStore | ç”¨æˆ·åå¥½ã€ç³»ç»ŸæŒ‡ä»¤ |

### 2.2 LangGraph è®°å¿†ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Memory Agent                             â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  çŸ­æœŸè®°å¿†å±‚ï¼ˆSession Layerï¼‰                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Checkpointer (MemorySaver)                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ å¯¹è¯å†å²ï¼ˆmessagesï¼‰                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ å½“å‰çŠ¶æ€ï¼ˆstateï¼‰                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ ç”Ÿå‘½å‘¨æœŸï¼šå•æ¬¡ä¼šè¯                            â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  é•¿æœŸè®°å¿†å±‚ï¼ˆPersistence Layerï¼‰                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Store (InMemoryStore / PostgresStore)           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Namespace: ("user_123", "profile")              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€ Key: "user_profile"                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â””â”€ Value: {name, location, interests...}      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Namespace: ("user_123", "memories")             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€ Key: uuid-1 â†’ {content: "..."}             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€ Key: uuid-2 â†’ {content: "..."}             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â””â”€ Key: uuid-3 â†’ {content: "..."}             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Namespace: ("user_123", "instructions")         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â””â”€ Key: "preferences" â†’ {instructions...}     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ ç”Ÿå‘½å‘¨æœŸï¼šæŒä¹…åŒ–ï¼ˆè·¨æ‰€æœ‰ä¼šè¯ï¼‰                â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ™ºèƒ½å†³ç­–å±‚ï¼ˆIntelligence Layerï¼‰                      â”‚ â”‚
â”‚  â”‚  â€¢ Trustcallï¼šç»“æ„åŒ–æ•°æ®æå–                           â”‚ â”‚
â”‚  â”‚  â€¢ Conditional Edgesï¼šè·¯ç”±é€»è¾‘                         â”‚ â”‚
â”‚  â”‚  â€¢ ReAct Patternï¼šæ¨ç†-è¡ŒåŠ¨å¾ªç¯                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Store çš„ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ

LangGraph Store ä½¿ç”¨ä¸‰å…ƒç»„æ¥ç»„ç»‡æ•°æ®ï¼š

#### Namespaceï¼ˆå‘½åç©ºé—´ï¼‰- åˆ†å±‚ç»„ç»‡
```python
# å…ƒç»„å½¢å¼çš„å±‚çº§ç»“æ„
("user_1", "profile")        # ç”¨æˆ·1çš„èµ„æ–™
("user_1", "memories")       # ç”¨æˆ·1çš„è®°å¿†é›†åˆ
("user_2", "profile")        # ç”¨æˆ·2çš„èµ„æ–™
("project", "alpha", "settings")  # å¤šå±‚åµŒå¥—
```

**ç±»æ¯”**ï¼šå°±åƒæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•è·¯å¾„
```
/user_1/profile/
/user_1/memories/
/user_2/profile/
```

#### Keyï¼ˆé”®ï¼‰- å”¯ä¸€æ ‡è¯†
```python
# Profile åœºæ™¯ï¼šä½¿ç”¨å›ºå®šé”®
key = "user_profile"

# Collection åœºæ™¯ï¼šä½¿ç”¨ UUID
key = str(uuid.uuid4())  # "e1c4e5ab-ab0f-4cbb-822d-f29240a983af"
```

#### Valueï¼ˆå€¼ï¼‰- å¿…é¡»æ˜¯å­—å…¸
```python
# Profile
value = {
    "user_name": "Lance",
    "user_location": "San Francisco",
    "interests": ["biking", "bakeries"]
}

# Collection
value = {
    "content": "Lance likes biking in San Francisco."
}
```

### 2.4 Profile vs Collectionï¼šä½•æ—¶ä½¿ç”¨å“ªç§æ¨¡å¼ï¼Ÿ

è¿™æ˜¯æœ¬ç« æœ€é‡è¦çš„æ¶æ„å†³ç­–ä¹‹ä¸€ï¼š

```
Profile æ¨¡å¼ï¼ˆå•ä¸€ç»“æ„åŒ–å¯¹è±¡ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·èµ„æ–™                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ user_name: "Lance"        â”‚  â”‚
â”‚  â”‚ user_location: "SF"       â”‚  â”‚
â”‚  â”‚ interests: [...]          â”‚  â”‚
â”‚  â”‚ connections: [...]        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â€¢ å›ºå®šå­—æ®µ                      â”‚
â”‚  â€¢ å¢é‡æ›´æ–°ï¼ˆJSON Patchï¼‰        â”‚
â”‚  â€¢ é€‚åˆç»“æ„åŒ–ä¿¡æ¯                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Collection æ¨¡å¼ï¼ˆè®°å¿†é›†åˆï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®°å¿†é›†åˆ                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ uuid-1: {content: "..."}  â”‚  â”‚
â”‚  â”‚ uuid-2: {content: "..."}  â”‚  â”‚
â”‚  â”‚ uuid-3: {content: "..."}  â”‚  â”‚
â”‚  â”‚ ...å¯æ— é™æ‰©å±•              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â€¢ çµæ´»ç»“æ„                      â”‚
â”‚  â€¢ ç‹¬ç«‹é¡¹ç›®ï¼ˆå¢åˆ æ”¹ï¼‰            â”‚
â”‚  â€¢ é€‚åˆå¼€æ”¾å¼ä¿¡æ¯                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å†³ç­–æ ‘**ï¼š

```mermaid
graph TD
    A[éœ€è¦ä¿å­˜ä¿¡æ¯] --> B{ä¿¡æ¯æ˜¯å¦æœ‰å›ºå®šç»“æ„?}
    B -->|æ˜¯| C[ä½¿ç”¨ Profile]
    B -->|å¦| D[ä½¿ç”¨ Collection]
    
    C --> E{ç¤ºä¾‹}
    E --> E1[ç”¨æˆ·èµ„æ–™]
    E --> E2[ç³»ç»Ÿé…ç½®]
    E --> E3[è®¤è¯ä¿¡æ¯]
    
    D --> F{ç¤ºä¾‹}
    F --> F1[å¯¹è¯è®°å½•]
    F --> F2[å­¦ä¹ ç¬”è®°]
    F --> F3[å¾…åŠäº‹é¡¹]
    F --> F4[ç”¨æˆ·åé¦ˆ]
```

**å¯¹æ¯”è¡¨**ï¼š

| ç»´åº¦ | Profile | Collection |
|------|---------|-----------|
| **æ•°æ®ç»“æ„** | å›ºå®šå­—æ®µçš„å•ä¸€å¯¹è±¡ | ç‹¬ç«‹é¡¹ç›®çš„é›†åˆ |
| **é”®ç­–ç•¥** | å›ºå®šé”®ï¼ˆå¦‚ "user_profile"ï¼‰ | UUID é”®ï¼ˆæ¯é¡¹å”¯ä¸€ï¼‰ |
| **æ›´æ–°æ–¹å¼** | JSON Patchï¼ˆå¢é‡æ›´æ–°ï¼‰ | æ–°å¢/ä¿®æ”¹/åˆ é™¤ç‹¬ç«‹é¡¹ |
| **Schema** | `UserProfile(BaseModel)` | `Memory(BaseModel)` |
| **Trustcall å‚æ•°** | `enable_inserts=False`ï¼ˆé»˜è®¤ï¼‰ | `enable_inserts=True` |
| **é€‚ç”¨åœºæ™¯** | å§“åã€å¹´é¾„ã€åœ°å€ç­‰ç»“æ„åŒ–ä¿¡æ¯ | ç¬”è®°ã€ä»»åŠ¡ã€äº‹ä»¶ç­‰å¼€æ”¾å¼ä¿¡æ¯ |
| **æ‰©å±•æ€§** | éœ€ä¿®æ”¹ Schema | æ— é™æ‰©å±• |

**ä»£ç ç¤ºä¾‹å¯¹æ¯”**ï¼š

```python
# ========== Profile æ¨¡å¼ ==========
from pydantic import BaseModel, Field
from typing import List, Optional

class UserProfile(BaseModel):
    """ç”¨æˆ·èµ„æ–™ Schema"""
    user_name: str = Field(description="ç”¨æˆ·çš„é¦–é€‰åç§°")
    user_location: Optional[str] = Field(description="ç”¨æˆ·çš„ä½ç½®", default=None)
    interests: List[str] = Field(description="ç”¨æˆ·çš„å…´è¶£åˆ—è¡¨", default_factory=list)

# åˆ›å»º Trustcall æå–å™¨ï¼ˆProfileï¼‰
profile_extractor = create_extractor(
    model,
    tools=[UserProfile],
    tool_choice="UserProfile"
    # enable_inserts=False (é»˜è®¤)
)

# ä¿å­˜åˆ° Storeï¼ˆå›ºå®šé”®ï¼‰
namespace = ("user_1", "profile")
key = "user_profile"  # å›ºå®šé”®
value = {
    "user_name": "Lance",
    "user_location": "San Francisco",
    "interests": ["biking", "bakeries"]
}
store.put(namespace, key, value)

# ========== Collection æ¨¡å¼ ==========
class Memory(BaseModel):
    """è®°å¿†é¡¹ Schema"""
    content: str = Field(description="è®°å¿†çš„ä¸»è¦å†…å®¹")

# åˆ›å»º Trustcall æå–å™¨ï¼ˆCollectionï¼‰
memory_extractor = create_extractor(
    model,
    tools=[Memory],
    tool_choice="Memory",
    enable_inserts=True  # å…³é”®ï¼å…è®¸æ’å…¥æ–°é¡¹
)

# ä¿å­˜åˆ° Storeï¼ˆUUID é”®ï¼‰
import uuid

namespace = ("user_1", "memories")

# ç¬¬ä¸€æ¡è®°å¿†
key1 = str(uuid.uuid4())
value1 = {"content": "Lance likes biking."}
store.put(namespace, key1, value1)

# ç¬¬äºŒæ¡è®°å¿†
key2 = str(uuid.uuid4())
value2 = {"content": "Lance visited Tartine bakery."}
store.put(namespace, key2, value2)
```

---

## ä¸‰ã€Trustcallï¼šç»“æ„åŒ–æ•°æ®æå–çš„åˆ©å™¨

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦ Trustcallï¼Ÿ

**æŒ‘æˆ˜**ï¼šä»éç»“æ„åŒ–å¯¹è¯ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯

```
ç”¨æˆ·è¯´ï¼š"æˆ‘å« Lanceï¼Œä½åœ¨æ—§é‡‘å±±ï¼Œå–œæ¬¢éª‘è‡ªè¡Œè½¦å’Œé€›é¢åŒ…åº—ã€‚"

éœ€è¦è½¬æ¢ä¸ºï¼š
{
    "user_name": "Lance",
    "user_location": "San Francisco",
    "interests": ["biking", "bakeries"]
}
```

**ä¼ ç»Ÿæ–¹æ³•çš„é—®é¢˜**ï¼š
- âŒ ä½¿ç”¨ `with_structured_output()` åªèƒ½åˆ›å»ºæ–°å¯¹è±¡ï¼Œä¸èƒ½æ›´æ–°
- âŒ å¤æ‚åµŒå¥— Schema å®¹æ˜“æå–å¤±è´¥
- âŒ æ²¡æœ‰å¢é‡æ›´æ–°æœºåˆ¶ï¼Œæ¯æ¬¡éƒ½è¦é‡æ–°ç”Ÿæˆ

**Trustcall çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… è‡ªåŠ¨æå–ç»“æ„åŒ–ä¿¡æ¯
- âœ… å¢é‡æ›´æ–°ç°æœ‰è®°å½•ï¼ˆJSON Patchï¼‰
- âœ… å¤„ç†å¤æ‚åµŒå¥— Schema
- âœ… è‡ªæˆ‘ä¿®æ­£å’ŒéªŒè¯

### 3.2 Trustcall å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Trustcall å·¥ä½œæµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. å®šä¹‰ Schema (Pydantic)
   â†“
   class UserProfile(BaseModel):
       user_name: str
       interests: List[str]

2. åˆ›å»ºæå–å™¨
   â†“
   extractor = create_extractor(
       model,
       tools=[UserProfile],
       tool_choice="UserProfile"
   )

3. æå–æ–°ä¿¡æ¯ï¼ˆåˆ›å»ºï¼‰
   â†“
   å¯¹è¯ï¼š"My name is Lance, I like biking."
   â†“
   result = extractor.invoke({
       "messages": conversation
   })
   â†“
   è¾“å‡ºï¼š{"user_name": "Lance", "interests": ["biking"]}

4. æ›´æ–°ç°æœ‰ä¿¡æ¯ï¼ˆå¢é‡æ›´æ–°ï¼‰
   â†“
   æ–°å¯¹è¯ï¼š"I also enjoy coffee."
   â†“
   existing = [("0", "UserProfile", {"user_name": "Lance", "interests": ["biking"]})]
   â†“
   result = extractor.invoke({
       "messages": new_conversation,
       "existing": existing
   })
   â†“
   å†…éƒ¨ä½¿ç”¨ JSON Patchï¼š
   [
     {"op": "add", "path": "/interests/1", "value": "coffee"}
   ]
   â†“
   è¾“å‡ºï¼š{"user_name": "Lance", "interests": ["biking", "coffee"]}
```

### 3.3 JSON Patch æœºåˆ¶

JSON Patchï¼ˆRFC 6902ï¼‰æ˜¯ Trustcall å®ç°å¢é‡æ›´æ–°çš„æ ¸å¿ƒï¼š

```python
# åŸå§‹æ•°æ®
original = {
    "user_name": "Lance",
    "interests": ["biking"]
}

# JSON Patch æ“ä½œ
patch = [
    {"op": "add", "path": "/interests/1", "value": "coffee"}
]

# åº”ç”¨ Patch å
result = {
    "user_name": "Lance",
    "interests": ["biking", "coffee"]  # æ·»åŠ äº† "coffee"
}
```

**å¸¸è§æ“ä½œ**ï¼š

| æ“ä½œ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `add` | æ·»åŠ æ–°å€¼ | `{"op": "add", "path": "/interests/1", "value": "coffee"}` |
| `replace` | æ›¿æ¢å€¼ | `{"op": "replace", "path": "/user_name", "value": "Lance Martin"}` |
| `remove` | åˆ é™¤å€¼ | `{"op": "remove", "path": "/interests/0"}` |

**ä¸ºä»€ä¹ˆä½¿ç”¨ JSON Patchï¼Ÿ**
- âœ… **é«˜æ•ˆ**ï¼šåªä¼ è¾“å˜åŒ–çš„éƒ¨åˆ†
- âœ… **ç²¾ç¡®**ï¼šæ˜ç¡®æŒ‡å®šä¿®æ”¹ä½ç½®
- âœ… **å¯è¿½æº¯**ï¼šå¯ä»¥è®°å½•æ‰€æœ‰å˜æ›´å†å²
- âœ… **åŸå­æ€§**ï¼šå¤šä¸ªæ“ä½œå¯ä½œä¸ºä¸€ä¸ªäº‹åŠ¡

### 3.4 Trustcall çš„ç›‘æ§ï¼šSpy ç±»

ç†è§£ Trustcall å†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆï¼š

```python
class Spy:
    """ç›‘æ§ Trustcall çš„å·¥å…·è°ƒç”¨"""
    def __init__(self):
        self.called_tools = []

    def __call__(self, run):
        # éå†æ‰€æœ‰è¿è¡Œè®°å½•ï¼ˆåŒ…æ‹¬å­è¿è¡Œï¼‰
        q = [run]
        while q:
            r = q.pop()
            if r.child_runs:
                q.extend(r.child_runs)
            if r.run_type == "chat_model":
                self.called_tools.append(
                    r.outputs["generations"][0][0]["message"]["kwargs"]["tool_calls"]
                )

# ä½¿ç”¨ Spy
spy = Spy()
extractor_with_spy = extractor.with_listeners(on_end=spy)

# è°ƒç”¨åæŸ¥çœ‹
result = extractor_with_spy.invoke(...)
print(spy.called_tools)  # æŸ¥çœ‹æ‰€æœ‰å·¥å…·è°ƒç”¨
```

---

## å››ã€å®æˆ˜ç¤ºä¾‹ï¼šæ„å»º task_mAIstro Agent

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ï¼Œæ•´åˆæ‰€æœ‰æ¦‚å¿µï¼š

### 4.1 ç³»ç»Ÿæ¶æ„

```
task_mAIstro Agent
â”œâ”€â”€ çŸ­æœŸè®°å¿†
â”‚   â””â”€â”€ MemorySaverï¼šå¯¹è¯å†å²
â”‚
â”œâ”€â”€ é•¿æœŸè®°å¿†ï¼ˆä¸‰ç§ç±»å‹ï¼‰
â”‚   â”œâ”€â”€ Profileï¼ˆè¯­ä¹‰è®°å¿†ï¼‰
â”‚   â”‚   â””â”€â”€ ç”¨æˆ·èµ„æ–™ï¼šå§“åã€ä½ç½®ã€å®¶åº­æˆå‘˜
â”‚   â”‚
â”‚   â”œâ”€â”€ ToDo Collectionï¼ˆè¯­ä¹‰è®°å¿†ï¼‰
â”‚   â”‚   â””â”€â”€ å¾…åŠäº‹é¡¹ï¼šä»»åŠ¡å†…å®¹ã€æˆªæ­¢æ—¥æœŸã€çŠ¶æ€
â”‚   â”‚
â”‚   â””â”€â”€ Instructionsï¼ˆç¨‹åºæ€§è®°å¿†ï¼‰
â”‚       â””â”€â”€ ç”¨æˆ·åå¥½ï¼šå¦‚ä½•åˆ›å»ºä»»åŠ¡ã€ç‰¹æ®Šè¦æ±‚
â”‚
â””â”€â”€ æ™ºèƒ½å†³ç­–
    â”œâ”€â”€ Trustcallï¼šç»“æ„åŒ–æå–
    â””â”€â”€ Conditional Edgesï¼šæ™ºèƒ½è·¯ç”±
```

### 4.2 Schema å®šä¹‰

```python
from pydantic import BaseModel, Field
from typing import List, Optional

# ========== Profile Schema ==========
class UserProfile(BaseModel):
    """ç”¨æˆ·èµ„æ–™"""
    user_name: Optional[str] = Field(description="ç”¨æˆ·çš„é¦–é€‰åç§°", default=None)
    user_location: Optional[str] = Field(description="ç”¨æˆ·çš„ä½ç½®", default=None)
    connections: List[str] = Field(
        description="ç”¨æˆ·çš„å®¶åº­æˆå‘˜ã€æœ‹å‹ç­‰",
        default_factory=list
    )

# ========== ToDo Collection Schema ==========
class ToDo(BaseModel):
    """å¾…åŠäº‹é¡¹"""
    task: str = Field(description="ä»»åŠ¡æè¿°")
    due_date: Optional[str] = Field(description="æˆªæ­¢æ—¥æœŸ", default=None)
    status: str = Field(description="çŠ¶æ€ï¼špending/completed", default="pending")

# ========== Instructions Schema ==========
class Instructions(BaseModel):
    """ç”¨æˆ·åå¥½å’ŒæŒ‡ä»¤"""
    preferences: str = Field(description="ç”¨æˆ·å¸Œæœ›å¦‚ä½•ç®¡ç†ä»»åŠ¡")
```

### 4.3 Graph ç»“æ„

```python
from langgraph.graph import StateGraph, MessagesState, START, END
from langgraph.checkpoint.memory import MemorySaver
from langgraph.store.memory import InMemoryStore

# å®šä¹‰ State
class State(MessagesState):
    pass

# åˆ›å»º Graph
builder = StateGraph(State)

# æ·»åŠ èŠ‚ç‚¹
builder.add_node("chat", call_model)
builder.add_node("write_profile", write_profile)
builder.add_node("write_todos", write_todos)
builder.add_node("write_instructions", write_instructions)

# æ·»åŠ è¾¹
builder.add_edge(START, "chat")
builder.add_conditional_edges(
    "chat",
    route_message,
    {
        "write_profile": "write_profile",
        "write_todos": "write_todos",
        "write_instructions": "write_instructions",
        END: END
    }
)
builder.add_edge("write_profile", END)
builder.add_edge("write_todos", END)
builder.add_edge("write_instructions", END)

# ç¼–è¯‘ï¼ˆåŠ å…¥ Checkpointer å’Œ Storeï¼‰
memory = MemorySaver()
store = InMemoryStore()

graph = builder.compile(checkpointer=memory, store=store)
```

### 4.4 æ™ºèƒ½è·¯ç”±é€»è¾‘

```python
def route_message(state: State) -> str:
    """æ ¹æ®å¯¹è¯å†…å®¹å†³å®šæ˜¯å¦ä¿å­˜è®°å¿†"""
    messages = state["messages"]
    last_message = messages[-1]
    
    # å¦‚æœæ˜¯ AI å›å¤ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«å·¥å…·è°ƒç”¨
    if hasattr(last_message, "tool_calls") and last_message.tool_calls:
        return END
    
    # å¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œåˆ†ææ˜¯å¦éœ€è¦ä¿å­˜è®°å¿†
    # ï¼ˆè¿™é‡Œç®€åŒ–ï¼Œå®é™…ä¼šä½¿ç”¨ LLM åˆ¤æ–­ï¼‰
    content = last_message.content.lower()
    
    if any(word in content for word in ["name", "location", "family"]):
        return "write_profile"
    elif any(word in content for word in ["task", "todo", "deadline"]):
        return "write_todos"
    elif any(word in content for word in ["prefer", "always", "remember"]):
        return "write_instructions"
    else:
        return END
```

### 4.5 è®°å¿†ä¿å­˜èŠ‚ç‚¹

```python
def write_profile(state: State, config: RunnableConfig, store: BaseStore):
    """ä¿å­˜ç”¨æˆ·èµ„æ–™"""
    user_id = config["configurable"]["user_id"]
    namespace = (user_id, "profile")
    
    # æ£€ç´¢ç°æœ‰èµ„æ–™
    existing = store.get(namespace, "user_profile")
    
    # ä½¿ç”¨ Trustcall æå–å’Œæ›´æ–°
    if existing:
        existing_data = [("0", "UserProfile", existing.value)]
    else:
        existing_data = None
    
    # è°ƒç”¨æå–å™¨
    result = profile_extractor.invoke({
        "messages": state["messages"],
        "existing": existing_data
    })
    
    # ä¿å­˜åˆ° Store
    store.put(namespace, "user_profile", result["responses"][0].model_dump())
    
    return {"messages": [AIMessage(content="å·²æ›´æ–°æ‚¨çš„èµ„æ–™ã€‚")]}

def write_todos(state: State, config: RunnableConfig, store: BaseStore):
    """ä¿å­˜å¾…åŠäº‹é¡¹"""
    user_id = config["configurable"]["user_id"]
    namespace = (user_id, "todos")
    
    # æå–å¾…åŠäº‹é¡¹ï¼ˆCollection æ¨¡å¼ï¼‰
    result = todo_extractor.invoke({
        "messages": state["messages"]
    })
    
    # ä¿å­˜æ¯ä¸ªä»»åŠ¡ï¼ˆä½¿ç”¨ UUIDï¼‰
    import uuid
    for todo in result["responses"]:
        key = str(uuid.uuid4())
        store.put(namespace, key, todo.model_dump())
    
    return {"messages": [AIMessage(content="å·²æ·»åŠ å¾…åŠäº‹é¡¹ã€‚")]}
```

---

## äº”ã€å­¦ä¹ è·¯å¾„å»ºè®®

æ ¹æ®ä½ çš„èƒŒæ™¯å’Œç›®æ ‡ï¼Œæˆ‘ä»¬æä¾›ä¸‰ç§å­¦ä¹ è·¯å¾„ï¼š

### è·¯å¾„ 1ï¼šå¿«é€Ÿå®è·µï¼ˆåˆå­¦è€…ï¼‰â±ï¸ 3-4 å¤©

**ç›®æ ‡**ï¼šå¿«é€ŸæŒæ¡åŸºæœ¬çš„è®°å¿†ç³»ç»Ÿå®ç°

```
Day 1: Store åŸºç¡€
â”œâ”€â”€ 6.2 Memory Store - è¯¦ç»†è§£è¯»
â”‚   â”œâ”€â”€ put/get/search ä¸‰ä¸ªåŸºæœ¬æ“ä½œ
â”‚   â”œâ”€â”€ namespaceã€keyã€value æ¦‚å¿µ
â”‚   â””â”€â”€ æ„å»ºç®€å•çš„è®°å¿†èŠå¤©æœºå™¨äºº
â””â”€â”€ å®è·µï¼šå®ç°åŸºç¡€èŠå¤©è®°å¿†

Day 2: ç»“æ„åŒ–è®°å¿†ï¼ˆProfileï¼‰
â”œâ”€â”€ 6.3 Memory Schema - Profile
â”‚   â”œâ”€â”€ Pydantic Schema å®šä¹‰
â”‚   â”œâ”€â”€ with_structured_output() ä½¿ç”¨
â”‚   â””â”€â”€ Trustcall åŸºç¡€
â””â”€â”€ å®è·µï¼šæ„å»ºå¸¦ Profile çš„èŠå¤©æœºå™¨äºº

Day 3: è®°å¿†é›†åˆï¼ˆCollectionï¼‰
â”œâ”€â”€ 6.4 Memory Schema - Collection
â”‚   â”œâ”€â”€ Profile vs Collection åŒºåˆ«
â”‚   â”œâ”€â”€ enable_inserts å‚æ•°
â”‚   â””â”€â”€ UUID ç®¡ç†
â””â”€â”€ å®è·µï¼šå®ç°å¤šè®°å¿†é¡¹ç®¡ç†

Day 4: ç»¼åˆåº”ç”¨
â”œâ”€â”€ 6.1 Memory Agent
â”‚   â”œâ”€â”€ æ•´åˆå¤šç§è®°å¿†ç±»å‹
â”‚   â”œâ”€â”€ æ™ºèƒ½è·¯ç”±é€»è¾‘
â”‚   â””â”€â”€ å®Œæ•´ Agent æ¶æ„
â””â”€â”€ å®è·µï¼šæ„å»º task_mAIstro Agent
```

**å­¦ä¹ é‡ç‚¹**ï¼š
- âœ… ç†è§£ Store çš„åŸºæœ¬æ“ä½œ
- âœ… æŒæ¡ Profile å’Œ Collection çš„åŒºåˆ«
- âœ… èƒ½å¤Ÿå®ç°ç®€å•çš„è®°å¿† Agent

**è·³è¿‡å†…å®¹**ï¼š
- JSON Patch å†…éƒ¨æœºåˆ¶
- å¤æ‚åµŒå¥— Schema çš„ä¼˜åŒ–
- æ€§èƒ½è°ƒä¼˜ç»†èŠ‚

---

### è·¯å¾„ 2ï¼šç³»ç»ŸæŒæ¡ï¼ˆä¸­çº§å¼€å‘è€…ï¼‰â±ï¸ 5-7 å¤©

**ç›®æ ‡**ï¼šæ·±å…¥ç†è§£è®°å¿†ç³»ç»Ÿçš„åŸç†å’Œæœ€ä½³å®è·µ

```
Day 1-2: è®°å¿†ç³»ç»ŸåŸºç¡€
â”œâ”€â”€ è®¤çŸ¥ç§‘å­¦èƒŒæ™¯
â”œâ”€â”€ Store æ·±å…¥ç†è§£
â”‚   â”œâ”€â”€ namespace è®¾è®¡æ¨¡å¼
â”‚   â”œâ”€â”€ key ç­–ç•¥é€‰æ‹©
â”‚   â””â”€â”€ value ç»“æ„ä¼˜åŒ–
â””â”€â”€ å®è·µï¼šè®¾è®¡è®°å¿†æ¶æ„

Day 3-4: ç»“æ„åŒ–æ•°æ®ç®¡ç†
â”œâ”€â”€ Pydantic é«˜çº§ç”¨æ³•
â”‚   â”œâ”€â”€ Field éªŒè¯
â”‚   â”œâ”€â”€ åµŒå¥—æ¨¡å‹
â”‚   â””â”€â”€ è‡ªå®šä¹‰éªŒè¯å™¨
â”œâ”€â”€ Trustcall æ·±å…¥
â”‚   â”œâ”€â”€ JSON Patch æœºåˆ¶
â”‚   â”œâ”€â”€ ç›‘æ§å’Œè°ƒè¯•ï¼ˆSpyï¼‰
â”‚   â””â”€â”€ é”™è¯¯å¤„ç†
â””â”€â”€ å®è·µï¼šå¤æ‚ Schema è®¾è®¡

Day 5-6: æ™ºèƒ½ Agent æ„å»º
â”œâ”€â”€ å¤šç±»å‹è®°å¿†ååŒ
â”‚   â”œâ”€â”€ Profile + Collection + Instructions
â”‚   â”œâ”€â”€ è®°å¿†æ›´æ–°ç­–ç•¥
â”‚   â””â”€â”€ è·¨ä¼šè¯ä¸€è‡´æ€§
â”œâ”€â”€ æ¡ä»¶è·¯ç”±é€»è¾‘
â”‚   â”œâ”€â”€ ä½•æ—¶ä¿å­˜è®°å¿†
â”‚   â”œâ”€â”€ è·¯ç”±å†³ç­–ä¼˜åŒ–
â”‚   â””â”€â”€ æ€§èƒ½è€ƒé‡
â””â”€â”€ å®è·µï¼šå®Œæ•´ Agent å®ç°

Day 7: é«˜çº§ä¸»é¢˜
â”œâ”€â”€ æ€§èƒ½ä¼˜åŒ–
â”‚   â”œâ”€â”€ æ‰¹é‡æ“ä½œ
â”‚   â”œâ”€â”€ ç¼“å­˜ç­–ç•¥
â”‚   â””â”€â”€ å­˜å‚¨åç«¯é€‰æ‹©
â”œâ”€â”€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
â”‚   â”œâ”€â”€ PostgresStore è¿ç§»
â”‚   â”œâ”€â”€ æ•°æ®è¿ç§»
â”‚   â””â”€â”€ ç›‘æ§å’Œç»´æŠ¤
â””â”€â”€ å®è·µï¼šä¼˜åŒ–å’Œéƒ¨ç½²
```

**å­¦ä¹ é‡ç‚¹**ï¼š
- âœ… ç†è§£è®°å¿†ç³»ç»Ÿçš„è®¾è®¡åŸåˆ™
- âœ… æŒæ¡ Trustcall çš„å†…éƒ¨æœºåˆ¶
- âœ… èƒ½å¤Ÿè®¾è®¡å¤æ‚çš„è®°å¿†æ¶æ„
- âœ… äº†è§£æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

---

### è·¯å¾„ 3ï¼šæ¶æ„ç²¾é€šï¼ˆé«˜çº§å·¥ç¨‹å¸ˆï¼‰â±ï¸ 7-10 å¤©

**ç›®æ ‡**ï¼šæˆä¸ºè®°å¿†ç³»ç»Ÿæ¶æ„ä¸“å®¶ï¼Œèƒ½å¤Ÿè®¾è®¡ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆ

```
Week 1: ç†è®ºä¸å®è·µæ·±åº¦ç»“åˆ
â”œâ”€â”€ Day 1-2: è®¤çŸ¥ç§‘å­¦ä¸ç³»ç»Ÿè®¾è®¡
â”‚   â”œâ”€â”€ è®°å¿†ç†è®ºæ·±å…¥ç ”ç©¶
â”‚   â”œâ”€â”€ è®°å¿†ç³»ç»Ÿè®¾è®¡æ¨¡å¼
â”‚   â”œâ”€â”€ æƒè¡¡ä¸å–èˆåˆ†æ
â”‚   â””â”€â”€ å®è·µï¼šæ¶æ„è®¾è®¡æ–‡æ¡£
â”‚
â”œâ”€â”€ Day 3-4: æ ¸å¿ƒæŠ€æœ¯ç²¾é€š
â”‚   â”œâ”€â”€ Store å†…éƒ¨å®ç°åˆ†æ
â”‚   â”œâ”€â”€ Trustcall æºç ç ”è¯»
â”‚   â”œâ”€â”€ JSON Patch è§„èŒƒæ·±å…¥
â”‚   â”œâ”€â”€ è‡ªå®šä¹‰ Store å®ç°
â”‚   â””â”€â”€ å®è·µï¼šæ‰©å±• Store åŠŸèƒ½
â”‚
â””â”€â”€ Day 5-7: é«˜çº§åº”ç”¨åœºæ™¯
    â”œâ”€â”€ å¤šç§Ÿæˆ·è®°å¿†éš”ç¦»
    â”œâ”€â”€ è®°å¿†ç‰ˆæœ¬æ§åˆ¶
    â”œâ”€â”€ åˆ†å¸ƒå¼è®°å¿†åŒæ­¥
    â”œâ”€â”€ è®°å¿†å®‰å…¨ä¸éšç§
    â””â”€â”€ å®è·µï¼šä¼ä¸šçº§æ¶æ„è®¾è®¡

Week 2: æ€§èƒ½ä¸ç”Ÿäº§
â”œâ”€â”€ Day 8-9: æ€§èƒ½å·¥ç¨‹
â”‚   â”œâ”€â”€ è®°å¿†è®¿é—®æ¨¡å¼åˆ†æ
â”‚   â”œâ”€â”€ æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
â”‚   â”œâ”€â”€ ç¼“å­˜å±‚è®¾è®¡
â”‚   â”œâ”€â”€ æ•°æ®åˆ†ç‰‡ç­–ç•¥
â”‚   â””â”€â”€ å®è·µï¼šæ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚
â””â”€â”€ Day 10: ç”Ÿäº§éƒ¨ç½²ä¸è¿ç»´
    â”œâ”€â”€ å­˜å‚¨åç«¯é€‰æ‹©ï¼ˆPostgres/Redis/etcï¼‰
    â”œâ”€â”€ æ•°æ®è¿ç§»ç­–ç•¥
    â”œâ”€â”€ ç›‘æ§ä¸å‘Šè­¦
    â”œâ”€â”€ å®¹ç¾ä¸å¤‡ä»½
    â””â”€â”€ å®è·µï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```

**å­¦ä¹ é‡ç‚¹**ï¼š
- âœ… æ·±å…¥ç†è§£è®°å¿†ç³»ç»Ÿçš„ç†è®ºåŸºç¡€
- âœ… ç²¾é€š Store å’Œ Trustcall çš„å†…éƒ¨å®ç°
- âœ… èƒ½å¤Ÿè®¾è®¡å’Œå®ç°ä¼ä¸šçº§è®°å¿†æ¶æ„
- âœ… æŒæ¡æ€§èƒ½ä¼˜åŒ–å’Œç”Ÿäº§éƒ¨ç½²çš„æœ€ä½³å®è·µ

**é¢å¤–æŒ‘æˆ˜**ï¼š
- ğŸ¯ å®ç°è‡ªå®šä¹‰ Store åç«¯
- ğŸ¯ æ„å»ºè®°å¿†åˆ†æå’Œå¯è§†åŒ–å·¥å…·
- ğŸ¯ è®¾è®¡å¤šæ¨¡æ€è®°å¿†ç³»ç»Ÿï¼ˆæ–‡æœ¬+å›¾åƒ+éŸ³é¢‘ï¼‰
- ğŸ¯ ç ”ç©¶è®°å¿†çš„è¯­ä¹‰æ£€ç´¢å’Œå‘é‡åŒ–

---

## å…­ã€å…³é”®æŠ€æœ¯å¯¹æ¯”ä¸å†³ç­–

### 6.1 çŸ­æœŸè®°å¿† vs é•¿æœŸè®°å¿†

| ç»´åº¦ | çŸ­æœŸè®°å¿†ï¼ˆCheckpointerï¼‰ | é•¿æœŸè®°å¿†ï¼ˆStoreï¼‰ |
|------|-------------------------|------------------|
| **æŠ€æœ¯ç»„ä»¶** | MemorySaver | InMemoryStore / PostgresStore |
| **å­˜å‚¨å†…å®¹** | å¯¹è¯å†å²ï¼ˆmessagesï¼‰ã€å½“å‰çŠ¶æ€ | ç”¨æˆ·èµ„æ–™ã€è®°å¿†é›†åˆã€åå¥½è®¾ç½® |
| **ç”Ÿå‘½å‘¨æœŸ** | å•æ¬¡ä¼šè¯ï¼ˆthreadï¼‰ | è·¨æ‰€æœ‰ä¼šè¯ï¼ˆpersistentï¼‰ |
| **è®¿é—®æ–¹å¼** | é€šè¿‡ `thread_id` | é€šè¿‡ `namespace` + `key` |
| **æ•°æ®ç»“æ„** | Graph Stateï¼ˆTypedDictï¼‰ | å­—å…¸ï¼ˆdictï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å¯¹è¯ä¸Šä¸‹æ–‡ã€ä¸­é—´çŠ¶æ€ | ç”¨æˆ·ä¿¡æ¯ã€çŸ¥è¯†åº“ |
| **ç¤ºä¾‹** | æœ€è¿‘5è½®å¯¹è¯ | ç”¨æˆ·å§“åã€å…´è¶£çˆ±å¥½ |

**ååŒä½¿ç”¨**ï¼š
```python
# çŸ­æœŸè®°å¿†ï¼šè®°ä½æœ¬æ¬¡å¯¹è¯
memory = MemorySaver()

# é•¿æœŸè®°å¿†ï¼šè·¨ä¼šè¯ä¿¡æ¯
store = InMemoryStore()

# åŒæ—¶ä½¿ç”¨
graph = builder.compile(checkpointer=memory, store=store)
```

### 6.2 TypedDict vs Pydantic BaseModel

| ç‰¹æ€§ | TypedDict | Pydantic BaseModel |
|------|-----------|-------------------|
| **ç±»å‹æ£€æŸ¥** | é™æ€ï¼ˆmypyï¼‰ | é™æ€ + è¿è¡Œæ—¶ |
| **æ•°æ®éªŒè¯** | âŒ æ—  | âœ… è‡ªåŠ¨éªŒè¯ |
| **é»˜è®¤å€¼** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **åºåˆ—åŒ–** | æ‰‹åŠ¨ | è‡ªåŠ¨ï¼ˆ`model_dump()`ï¼‰ |
| **æ–‡æ¡£ç”Ÿæˆ** | æœ‰é™ | ä¸°å¯Œï¼ˆdescriptionï¼‰ |
| **IDE æ”¯æŒ** | âœ… æœ‰ | âœ… æ›´å¥½ |
| **æ€§èƒ½** | ç¨å¿« | ç¨æ…¢ï¼ˆéªŒè¯å¼€é”€ï¼‰ |
| **LLM é›†æˆ** | æœ‰é™ | âœ… åŸç”Ÿæ”¯æŒ |

**æ¨è**ï¼š
- åœ¨ LangGraph ä¸­ï¼Œ**ä¼˜å…ˆä½¿ç”¨ Pydantic BaseModel**
- ç‰¹åˆ«æ˜¯éœ€è¦ `with_structured_output()` æˆ– Trustcall æ—¶

### 6.3 with_structured_output() vs Trustcall

| ç»´åº¦ | with_structured_output() | Trustcall |
|------|-------------------------|-----------|
| **åŠŸèƒ½** | ç»“æ„åŒ–è¾“å‡º | ç»“æ„åŒ–æå– + æ›´æ–° |
| **åˆ›å»ºæ–°è®°å½•** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **æ›´æ–°ç°æœ‰è®°å½•** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆJSON Patchï¼‰ |
| **å¤æ‚ Schema** | âš ï¸ å¯èƒ½å¤±è´¥ | âœ… æ›´å¥å£® |
| **å¹¶è¡Œåˆ›å»º** | âŒ å•ä¸ª | âœ… å¤šä¸ª |
| **è‡ªæˆ‘ä¿®æ­£** | âŒ æ—  | âœ… æœ‰ |
| **ä½¿ç”¨å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ |
| **é€‚ç”¨åœºæ™¯** | ç®€å•æå– | è®°å¿†ç®¡ç† |

**å†³ç­–æŒ‡å—**ï¼š

```python
# ç®€å•åœºæ™¯ï¼šåªéœ€æå–ä¸€æ¬¡ï¼Œä¸éœ€è¦æ›´æ–°
model_with_structure = model.with_structured_output(UserProfile)
result = model_with_structure.invoke(messages)

# å¤æ‚åœºæ™¯ï¼šéœ€è¦å¢é‡æ›´æ–°ã€å¤„ç†å¤æ‚ Schema
extractor = create_extractor(
    model,
    tools=[UserProfile],
    tool_choice="UserProfile"
)
result = extractor.invoke({
    "messages": messages,
    "existing": existing_data  # æ”¯æŒæ›´æ–°
})
```

### 6.4 InMemoryStore vs PostgresStore

| ç»´åº¦ | InMemoryStore | PostgresStore |
|------|--------------|--------------|
| **æŒä¹…åŒ–** | âŒ å†…å­˜ï¼ˆé‡å¯ä¸¢å¤±ï¼‰ | âœ… æ•°æ®åº“ï¼ˆæŒä¹…ï¼‰ |
| **æ€§èƒ½** | âš¡ éå¸¸å¿« | ğŸ¢ ç›¸å¯¹æ…¢ |
| **å®¹é‡** | å†…å­˜é™åˆ¶ | ç£ç›˜é™åˆ¶ï¼ˆå¤§ï¼‰ |
| **åˆ†å¸ƒå¼** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **äº‹åŠ¡** | âŒ æ—  | âœ… æ”¯æŒ |
| **æŸ¥è¯¢èƒ½åŠ›** | åŸºç¡€ | å¼ºå¤§ï¼ˆSQLï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å¼€å‘ã€æµ‹è¯• | ç”Ÿäº§ç¯å¢ƒ |
| **è®¾ç½®å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ |

**è¿ç§»ç¤ºä¾‹**ï¼š

```python
# å¼€å‘ç¯å¢ƒ
from langgraph.store.memory import InMemoryStore
store = InMemoryStore()

# ç”Ÿäº§ç¯å¢ƒ
from langgraph.store.postgres import PostgresStore
store = PostgresStore(
    connection_string="postgresql://user:pass@localhost/db"
)

# API ç›¸åŒï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
store.put(namespace, key, value)
store.get(namespace, key)
store.search(namespace)
```

---

## ä¸ƒã€æœ€ä½³å®è·µä¸è®¾è®¡æ¨¡å¼

### 7.1 Namespace è®¾è®¡æ¨¡å¼

#### æ¨¡å¼ 1ï¼šç”¨æˆ·ä¸ºä¸­å¿ƒ
```python
# æŒ‰ç”¨æˆ·ç»„ç»‡
("user_{user_id}", "profile")
("user_{user_id}", "memories")
("user_{user_id}", "todos")
("user_{user_id}", "preferences")
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ˜“äºå®ç°å¤šç§Ÿæˆ·éš”ç¦»
- âœ… æ¸…æ™°çš„æ•°æ®å½’å±
- âœ… æ–¹ä¾¿æŒ‰ç”¨æˆ·åˆ é™¤æˆ–å¯¼å‡ºæ•°æ®

#### æ¨¡å¼ 2ï¼šåŠŸèƒ½ä¸ºä¸­å¿ƒ
```python
# æŒ‰åŠŸèƒ½ç»„ç»‡
("profile", "user_{user_id}")
("memories", "user_{user_id}")
("todos", "user_{user_id}")
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ˜“äºè·¨ç”¨æˆ·åˆ†æ
- âœ… ä¾¿äºåŠŸèƒ½æ¨¡å—åŒ–

#### æ¨¡å¼ 3ï¼šæ··åˆæ¨¡å¼
```python
# å¤šå±‚åµŒå¥—
("company_A", "user_{user_id}", "profile")
("company_A", "user_{user_id}", "memories")
("company_B", "user_{user_id}", "profile")
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ”¯æŒå¤šç§Ÿæˆ· + å¤šåŠŸèƒ½
- âœ… çµæ´»çš„æƒé™æ§åˆ¶

**æ¨è**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ï¼Œ**ä¿æŒä¸€è‡´æ€§**æœ€é‡è¦ã€‚

### 7.2 Key è®¾è®¡ç­–ç•¥

#### åœºæ™¯ 1ï¼šProfileï¼ˆå•ä¸€å¯¹è±¡ï¼‰
```python
# ä½¿ç”¨æè¿°æ€§å›ºå®šé”®
key = "user_profile"
key = "system_settings"
key = "user_preferences"
```

#### åœºæ™¯ 2ï¼šCollectionï¼ˆå¤šä¸ªé¡¹ç›®ï¼‰
```python
# ä½¿ç”¨ UUID
import uuid
key = str(uuid.uuid4())  # "e1c4e5ab-ab0f-4cbb-822d-f29240a983af"
```

#### åœºæ™¯ 3ï¼šæ—¶é—´åºåˆ—æ•°æ®
```python
# ä½¿ç”¨æ—¶é—´æˆ³
from datetime import datetime
key = datetime.now().isoformat()  # "2024-11-04T22:48:16.727572"
```

#### åœºæ™¯ 4ï¼šå±‚çº§æ•°æ®
```python
# ä½¿ç”¨è·¯å¾„é£æ ¼
key = "project/alpha/task/001"
key = "user/settings/notification/email"
```

### 7.3 Value ç»“æ„è®¾è®¡

#### åŸåˆ™ 1ï¼šä¿æŒç®€æ´
```python
# âœ… å¥½çš„è®¾è®¡
{
    "user_name": "Lance",
    "interests": ["biking", "coffee"]
}

# âŒ è¿‡åº¦å¤æ‚
{
    "user": {
        "personal": {
            "name": {
                "first": "Lance",
                "last": None
            }
        },
        "data": {
            "interests": {
                "list": ["biking"]
            }
        }
    }
}
```

#### åŸåˆ™ 2ï¼šåŒ…å«å…ƒæ•°æ®
```python
{
    "content": "User likes biking",
    "created_at": "2024-11-04T22:48:16",
    "importance": 0.8,
    "category": "hobby"
}
```

#### åŸåˆ™ 3ï¼šå¯æ‰©å±•æ€§
```python
class Memory(BaseModel):
    content: str
    # é¢„ç•™æ‰©å±•å­—æ®µ
    metadata: Optional[dict] = None
    tags: List[str] = Field(default_factory=list)
```

### 7.4 è®°å¿†æ›´æ–°ç­–ç•¥

#### ç­–ç•¥ 1ï¼šå®Œå…¨æ›¿æ¢ï¼ˆç®€å•ä½†ä½æ•ˆï¼‰
```python
def update_memory_full_replace(store, namespace, key, new_data):
    """æ¯æ¬¡å®Œå…¨æ›¿æ¢æ•´ä¸ªå¯¹è±¡"""
    store.put(namespace, key, new_data)
```

**é€‚ç”¨**ï¼šæ•°æ®é‡å°ã€æ›´æ–°ä¸é¢‘ç¹

#### ç­–ç•¥ 2ï¼šå¢é‡æ›´æ–°ï¼ˆæ¨èï¼‰
```python
def update_memory_incremental(store, namespace, key, updates):
    """åªæ›´æ–°å˜åŒ–çš„å­—æ®µ"""
    existing = store.get(namespace, key)
    if existing:
        merged = {**existing.value, **updates}
        store.put(namespace, key, merged)
    else:
        store.put(namespace, key, updates)
```

**é€‚ç”¨**ï¼šé¢‘ç¹æ›´æ–°ã€å¤§å¯¹è±¡

#### ç­–ç•¥ 3ï¼šTrustcall è‡ªåŠ¨æ›´æ–°
```python
# Trustcall è‡ªåŠ¨å¤„ç†å¢é‡æ›´æ–°
existing_data = [("0", "UserProfile", existing.value)]
result = extractor.invoke({
    "messages": new_messages,
    "existing": existing_data  # Trustcall è‡ªåŠ¨ä½¿ç”¨ JSON Patch
})
```

**é€‚ç”¨**ï¼šå¤æ‚ Schemaã€éœ€è¦æ™ºèƒ½åˆå¹¶

### 7.5 é”™è¯¯å¤„ç†ä¸éªŒè¯

```python
from pydantic import ValidationError

def safe_put(store, namespace, key, value):
    """å®‰å…¨åœ°ä¿å­˜æ•°æ®ï¼ŒåŒ…å«éªŒè¯å’Œé”™è¯¯å¤„ç†"""
    try:
        # éªŒè¯æ•°æ®
        if not isinstance(value, dict):
            raise ValueError("Value must be a dictionary")
        
        # ä¿å­˜
        store.put(namespace, key, value)
        return True
    
    except ValidationError as e:
        print(f"æ•°æ®éªŒè¯å¤±è´¥ï¼š{e}")
        return False
    
    except Exception as e:
        print(f"ä¿å­˜å¤±è´¥ï¼š{e}")
        return False

def safe_get(store, namespace, key, default=None):
    """å®‰å…¨åœ°è·å–æ•°æ®ï¼ŒåŒ…å«é»˜è®¤å€¼"""
    try:
        result = store.get(namespace, key)
        return result.value if result else default
    except Exception as e:
        print(f"è·å–å¤±è´¥ï¼š{e}")
        return default
```

---

## å…«ã€å¸¸è§é™·é˜±ä¸è°ƒè¯•æŠ€å·§

### 8.1 é™·é˜± 1ï¼šæ··æ·† Profile å’Œ Collection

**é”™è¯¯ç¤ºä¾‹**ï¼š
```python
# âŒ ä½¿ç”¨å›ºå®šé”®ä¿å­˜ Collectionï¼ˆæ¯æ¬¡è¦†ç›–ï¼‰
for memory in memories:
    store.put(namespace, "memory", memory)  # åªä¿ç•™æœ€åä¸€æ¡ï¼
```

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… ä½¿ç”¨ UUID ä¿å­˜ Collection
import uuid
for memory in memories:
    key = str(uuid.uuid4())
    store.put(namespace, key, memory)
```

### 8.2 é™·é˜± 2ï¼šå¿˜è®° enable_inserts

**é”™è¯¯ç¤ºä¾‹**ï¼š
```python
# âŒ Collection åœºæ™¯ä¸‹å¿˜è®° enable_inserts
extractor = create_extractor(
    model,
    tools=[Memory],
    tool_choice="Memory"
    # ç¼ºå°‘ enable_inserts=True
)
# ç»“æœï¼šåªèƒ½æ›´æ–°ï¼Œä¸èƒ½æ·»åŠ æ–°è®°å¿†
```

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… Collection å¿…é¡»å¯ç”¨ enable_inserts
extractor = create_extractor(
    model,
    tools=[Memory],
    tool_choice="Memory",
    enable_inserts=True  # å…³é”®ï¼
)
```

### 8.3 é™·é˜± 3ï¼šNamespace ä¸ä¸€è‡´

**é”™è¯¯ç¤ºä¾‹**ï¼š
```python
# âŒ ä¿å­˜å’Œæ£€ç´¢ä½¿ç”¨ä¸åŒçš„ namespace
store.put(("user_1", "profile"), "key", value)
result = store.get(("user_1", "profiles"), "key")  # æ‹¼å†™é”™è¯¯ï¼
# ç»“æœï¼šNone
```

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… ä½¿ç”¨å¸¸é‡å®šä¹‰ namespace
USER_PROFILE_NS = lambda user_id: (user_id, "profile")
USER_MEMORIES_NS = lambda user_id: (user_id, "memories")

# ä½¿ç”¨æ—¶
namespace = USER_PROFILE_NS("user_1")
store.put(namespace, "key", value)
result = store.get(namespace, "key")
```

### 8.4 é™·é˜± 4ï¼šValue ä¸æ˜¯å­—å…¸

**é”™è¯¯ç¤ºä¾‹**ï¼š
```python
# âŒ Value å¿…é¡»æ˜¯å­—å…¸
store.put(namespace, "key", "string value")  # é”™è¯¯ï¼
store.put(namespace, "key", ["list", "value"])  # é”™è¯¯ï¼
```

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… åŒ…è£…ä¸ºå­—å…¸
store.put(namespace, "key", {"value": "string value"})
store.put(namespace, "key", {"items": ["list", "value"]})
```

### 8.5 è°ƒè¯•æŠ€å·§

#### æŠ€å·§ 1ï¼šä½¿ç”¨ Spy ç›‘æ§ Trustcall
```python
spy = Spy()
extractor_with_spy = extractor.with_listeners(on_end=spy)

result = extractor_with_spy.invoke(...)
print("å·¥å…·è°ƒç”¨ï¼š", spy.called_tools)  # æŸ¥çœ‹å†…éƒ¨è°ƒç”¨
```

#### æŠ€å·§ 2ï¼šæ‰“å° Store å†…å®¹
```python
def debug_store(store, namespace):
    """è°ƒè¯•ï¼šæ‰“å° namespace ä¸­çš„æ‰€æœ‰æ•°æ®"""
    items = store.search(namespace)
    print(f"\n=== Namespace: {namespace} ===")
    for item in items:
        print(f"Key: {item.key}")
        print(f"Value: {item.value}")
        print(f"Created: {item.created_at}")
        print("-" * 40)
```

#### æŠ€å·§ 3ï¼šéªŒè¯ Schema
```python
from pydantic import ValidationError

def validate_data(model_class, data):
    """éªŒè¯æ•°æ®æ˜¯å¦ç¬¦åˆ Schema"""
    try:
        model_class(**data)
        print("âœ… æ•°æ®æœ‰æ•ˆ")
        return True
    except ValidationError as e:
        print("âŒ éªŒè¯å¤±è´¥ï¼š")
        print(e)
        return False

# ä½¿ç”¨
validate_data(UserProfile, {"user_name": "Lance", "interests": ["biking"]})
```

#### æŠ€å·§ 4ï¼šè¿½è¸ªè®°å¿†æ›´æ–°
```python
def put_with_log(store, namespace, key, value):
    """ä¿å­˜æ—¶è®°å½•æ—¥å¿—"""
    print(f"[{datetime.now()}] PUT")
    print(f"  Namespace: {namespace}")
    print(f"  Key: {key}")
    print(f"  Value: {value}")
    store.put(namespace, key, value)
```

---

## ä¹ã€æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### 9.1 æ‰¹é‡æ“ä½œ

```python
# âŒ ä½æ•ˆï¼šé€ä¸ªä¿å­˜
for memory in memories:
    store.put(namespace, str(uuid.uuid4()), memory.model_dump())

# âœ… é«˜æ•ˆï¼šæ‰¹é‡ä¿å­˜ï¼ˆå¦‚æœ Store æ”¯æŒï¼‰
# æ³¨æ„ï¼šInMemoryStore ä¸æ”¯æŒæ‰¹é‡ï¼Œä½† PostgresStore å¯ä»¥ä¼˜åŒ–
items = [
    (str(uuid.uuid4()), memory.model_dump())
    for memory in memories
]
# ä½¿ç”¨äº‹åŠ¡æ‰¹é‡ä¿å­˜ï¼ˆPostgresStoreï¼‰
with store.begin_transaction():
    for key, value in items:
        store.put(namespace, key, value)
```

### 9.2 ç¼“å­˜ç­–ç•¥

```python
from functools import lru_cache
from datetime import datetime, timedelta

class CachedStore:
    """å¸¦ç¼“å­˜çš„ Store åŒ…è£…å™¨"""
    def __init__(self, store):
        self.store = store
        self.cache = {}
        self.cache_ttl = timedelta(minutes=5)
    
    def get(self, namespace, key):
        cache_key = (namespace, key)
        
        # æ£€æŸ¥ç¼“å­˜
        if cache_key in self.cache:
            value, timestamp = self.cache[cache_key]
            if datetime.now() - timestamp < self.cache_ttl:
                return value
        
        # ç¼“å­˜æœªå‘½ä¸­ï¼Œä» Store è·å–
        result = self.store.get(namespace, key)
        
        # æ›´æ–°ç¼“å­˜
        self.cache[cache_key] = (result, datetime.now())
        
        return result
    
    def put(self, namespace, key, value):
        # æ›´æ–° Store
        self.store.put(namespace, key, value)
        
        # å¤±æ•ˆç¼“å­˜
        cache_key = (namespace, key)
        if cache_key in self.cache:
            del self.cache[cache_key]
```

### 9.3 ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–

```python
# PostgresStore å¯ä»¥åˆ›å»ºç´¢å¼•
"""
CREATE INDEX idx_namespace ON store (namespace);
CREATE INDEX idx_created_at ON store (created_at);
"""

# ä½¿ç”¨ç­›é€‰å‡å°‘æ•°æ®ä¼ è¾“
def search_recent_memories(store, namespace, days=7):
    """åªæ£€ç´¢æœ€è¿‘ N å¤©çš„è®°å¿†"""
    all_items = store.search(namespace)
    
    cutoff = datetime.now() - timedelta(days=days)
    recent = [
        item for item in all_items
        if datetime.fromisoformat(item.created_at.replace('+00:00', '')) > cutoff
    ]
    
    return recent
```

### 9.4 å†…å­˜ç®¡ç†

```python
# é™åˆ¶ Collection å¤§å°
MAX_MEMORIES = 1000

def add_memory_with_limit(store, namespace, memory):
    """æ·»åŠ è®°å¿†ï¼Œè¶…è¿‡é™åˆ¶æ—¶åˆ é™¤æœ€æ—§çš„"""
    # è·å–æ‰€æœ‰è®°å¿†
    items = store.search(namespace)
    
    # å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œåˆ é™¤æœ€æ—§çš„
    if len(items) >= MAX_MEMORIES:
        # æŒ‰åˆ›å»ºæ—¶é—´æ’åº
        items_sorted = sorted(items, key=lambda x: x.created_at)
        oldest = items_sorted[0]
        store.delete(namespace, oldest.key)
    
    # æ·»åŠ æ–°è®°å¿†
    key = str(uuid.uuid4())
    store.put(namespace, key, memory)
```

---

## åã€æœ¯è¯­è¡¨

| æœ¯è¯­ | è‹±æ–‡ | å®šä¹‰ | ç¤ºä¾‹ |
|------|------|------|------|
| è®°å¿† | Memory | AI ç³»ç»Ÿå­˜å‚¨å’Œæ£€ç´¢ä¿¡æ¯çš„èƒ½åŠ› | è®°ä½ç”¨æˆ·å§“å |
| çŸ­æœŸè®°å¿† | Short-term Memory | å•æ¬¡ä¼šè¯å†…çš„è®°å¿† | å¯¹è¯å†å² |
| é•¿æœŸè®°å¿† | Long-term Memory | è·¨ä¼šè¯æŒä¹…åŒ–çš„è®°å¿† | ç”¨æˆ·èµ„æ–™ |
| æ£€æŸ¥ç‚¹ | Checkpointer | ä¿å­˜ Graph çŠ¶æ€çš„ç»„ä»¶ | MemorySaver |
| å­˜å‚¨ | Store | é”®å€¼å¯¹æŒä¹…åŒ–å­˜å‚¨ | InMemoryStore |
| å‘½åç©ºé—´ | Namespace | åˆ†å±‚ç»„ç»‡æ•°æ®çš„å…ƒç»„ | `("user_1", "profile")` |
| é”® | Key | æ ‡è¯†ç‰¹å®šå¯¹è±¡çš„å­—ç¬¦ä¸² | `"user_profile"` |
| å€¼ | Value | å­˜å‚¨çš„æ•°æ®ï¼ˆå­—å…¸ï¼‰ | `{"name": "Lance"}` |
| èµ„æ–™ | Profile | å•ä¸€ç»“æ„åŒ–å¯¹è±¡ | ç”¨æˆ·èµ„æ–™ Schema |
| é›†åˆ | Collection | å¤šä¸ªç‹¬ç«‹é¡¹ç›®çš„é›†åˆ | è®°å¿†åˆ—è¡¨ |
| Schema | Schema | æ•°æ®ç»“æ„å®šä¹‰ | Pydantic æ¨¡å‹ |
| Trustcall | Trustcall | ç»“æ„åŒ–æ•°æ®æå–åº“ | æå–å’Œæ›´æ–°è®°å¿† |
| JSON Patch | JSON Patch | å¢é‡æ›´æ–°æœºåˆ¶ | RFC 6902 |
| UUID | UUID | é€šç”¨å”¯ä¸€è¯†åˆ«ç  | `uuid.uuid4()` |
| è¯­ä¹‰è®°å¿† | Semantic Memory | äº‹å®å’ŒçŸ¥è¯† | å§“åã€ä½ç½® |
| æƒ…èŠ‚è®°å¿† | Episodic Memory | äº‹ä»¶å’Œç»å† | ä¸Šå‘¨çš„è®¨è®º |
| ç¨‹åºæ€§è®°å¿† | Procedural Memory | æŠ€èƒ½å’Œä¹ æƒ¯ | ç”¨æˆ·åå¥½ |

---

## åä¸€ã€ç« èŠ‚å†…å®¹æ¦‚è§ˆ

### 6.1 Memory Agentï¼ˆè®°å¿† Agentï¼‰
**éš¾åº¦**ï¼šâ­â­â­â­  
**æ—¶é•¿**ï¼š2-3 å°æ—¶

**æ ¸å¿ƒå†…å®¹**ï¼š
- æ„å»º `task_mAIstro` Agentï¼ˆå¾…åŠäº‹é¡¹ç®¡ç†åŠ©æ‰‹ï¼‰
- æ•´åˆä¸‰ç§è®°å¿†ç±»å‹ï¼šProfile + Collection + Instructions
- ReAct æ¶æ„å’Œæ¡ä»¶è·¯ç”±
- Trustcall å®æˆ˜åº”ç”¨

**å­¦ä¹ æ”¶è·**ï¼š
- âœ… ç†è§£å®Œæ•´çš„ Memory Agent æ¶æ„
- âœ… æŒæ¡å¤šç±»å‹è®°å¿†çš„ååŒç®¡ç†
- âœ… å­¦ä¼šæ™ºèƒ½å†³ç­–ä½•æ—¶ä¿å­˜è®°å¿†

---

### 6.2 Memory Storeï¼ˆè®°å¿†å­˜å‚¨ï¼‰
**éš¾åº¦**ï¼šâ­â­  
**æ—¶é•¿**ï¼š1-2 å°æ—¶

**æ ¸å¿ƒå†…å®¹**ï¼š
- Store çš„ä¸‰ä¸ªåŸºæœ¬æ“ä½œï¼šputã€getã€search
- Namespaceã€Keyã€Value æ ¸å¿ƒæ¦‚å¿µ
- çŸ­æœŸè®°å¿†ä¸é•¿æœŸè®°å¿†çš„åä½œ
- æ„å»ºç®€å•çš„è®°å¿†èŠå¤©æœºå™¨äºº

**å­¦ä¹ æ”¶è·**ï¼š
- âœ… æŒæ¡ Store çš„åŸºæœ¬ä½¿ç”¨
- âœ… ç†è§£è®°å¿†ç³»ç»Ÿçš„è®¤çŸ¥ç§‘å­¦åŸºç¡€
- âœ… èƒ½å¤Ÿå®ç°åŸºç¡€çš„è·¨ä¼šè¯è®°å¿†

---

### 6.3 Memory Schema - Profileï¼ˆè®°å¿†æ¨¡å¼ - èµ„æ–™ï¼‰
**éš¾åº¦**ï¼šâ­â­â­  
**æ—¶é•¿**ï¼š2-3 å°æ—¶

**æ ¸å¿ƒå†…å®¹**ï¼š
- ä»éç»“æ„åŒ–åˆ°ç»“æ„åŒ–è®°å¿†çš„å‡çº§
- Pydantic Schema å®šä¹‰å’ŒéªŒè¯
- `with_structured_output()` æ–¹æ³•
- Trustcall çš„ JSON Patch æ›´æ–°æœºåˆ¶

**å­¦ä¹ æ”¶è·**ï¼š
- âœ… æŒæ¡ç»“æ„åŒ–è®°å¿†çš„è®¾è®¡
- âœ… ç†è§£ Trustcall çš„å·¥ä½œåŸç†
- âœ… å­¦ä¼šå¢é‡æ›´æ–°è€Œéå®Œå…¨é‡å†™

---

### 6.4 Memory Schema - Collectionï¼ˆè®°å¿†æ¨¡å¼ - é›†åˆï¼‰
**éš¾åº¦**ï¼šâ­â­â­  
**æ—¶é•¿**ï¼š2-3 å°æ—¶

**æ ¸å¿ƒå†…å®¹**ï¼š
- Profile vs Collection çš„æœ¬è´¨åŒºåˆ«
- `enable_inserts=True` å‚æ•°çš„ä½œç”¨
- UUID ç®¡ç†å¤šä¸ªè®°å¿†é¡¹
- çµæ´»çš„è®°å¿†æ‰©å±•ç­–ç•¥

**å­¦ä¹ æ”¶è·**ï¼š
- âœ… ç†è§£ä½•æ—¶ä½¿ç”¨ Profileï¼Œä½•æ—¶ä½¿ç”¨ Collection
- âœ… æŒæ¡ Collection çš„å®ç°æ¨¡å¼
- âœ… å­¦ä¼šè®¾è®¡å¯æ‰©å±•çš„è®°å¿†ç³»ç»Ÿ

---

## åäºŒã€å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œè¯·ç¡®ä¿ä½ èƒ½å¤Ÿï¼š

### åŸºç¡€èƒ½åŠ› âœ“
- [ ] è§£é‡ŠçŸ­æœŸè®°å¿†å’Œé•¿æœŸè®°å¿†çš„åŒºåˆ«
- [ ] ä½¿ç”¨ `put()`ã€`get()`ã€`search()` æ“ä½œ Store
- [ ] ç†è§£ namespaceã€keyã€value çš„å«ä¹‰å’Œè®¾è®¡åŸåˆ™
- [ ] å®šä¹‰ç®€å•çš„ Pydantic Schema
- [ ] ä½¿ç”¨ `with_structured_output()` æå–ç»“æ„åŒ–ä¿¡æ¯

### ä¸­çº§èƒ½åŠ› âœ“
- [ ] åŒºåˆ† Profile å’Œ Collection çš„ä½¿ç”¨åœºæ™¯
- [ ] ä½¿ç”¨ Trustcall åˆ›å»ºå’Œæ›´æ–°è®°å¿†
- [ ] ç†è§£ JSON Patch çš„å·¥ä½œåŸç†
- [ ] å®ç°å¸¦è®°å¿†çš„èŠå¤©æœºå™¨äºº
- [ ] è®¾è®¡åˆç†çš„ namespace ç»„ç»‡ç»“æ„

### é«˜çº§èƒ½åŠ› âœ“
- [ ] æ„å»ºå¤šç±»å‹è®°å¿†ååŒçš„ Agent
- [ ] å®ç°æ™ºèƒ½è·¯ç”±é€»è¾‘ï¼ˆä½•æ—¶ä¿å­˜è®°å¿†ï¼‰
- [ ] ä¼˜åŒ–è®°å¿†ç³»ç»Ÿçš„æ€§èƒ½
- [ ] ä» InMemoryStore è¿ç§»åˆ° PostgresStore
- [ ] è®¾è®¡ä¼ä¸šçº§è®°å¿†æ¶æ„

---

## åä¸‰ã€æ¨èèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [LangGraph Memory](https://langchain-ai.github.io/langgraph/concepts/memory/)
- [LangGraph Store](https://langchain-ai.github.io/langgraph/reference/store/)
- [Trustcall æ–‡æ¡£](https://github.com/PrefectHQ/trustcall)
- [Pydantic æ–‡æ¡£](https://docs.pydantic.dev/)

### è®¤çŸ¥ç§‘å­¦èƒŒæ™¯
- [Memory Systems (NIH)](https://pmc.ncbi.nlm.nih.gov/articles/PMC10410470/)
- [Types of Memory](https://en.wikipedia.org/wiki/Memory)

### æŠ€æœ¯è§„èŒƒ
- [JSON Patch RFC 6902](https://datatracker.ietf.org/doc/html/rfc6902)
- [UUID RFC 4122](https://datatracker.ietf.org/doc/html/rfc4122)

---

## åå››ã€å®è·µé¡¹ç›®å»ºè®®

### é¡¹ç›® 1ï¼šä¸ªæ€§åŒ–æ–°é—»åŠ©æ‰‹ ğŸ”° åˆçº§
**æ—¶é•¿**ï¼š3-5 å°æ—¶

**åŠŸèƒ½**ï¼š
- è®°ä½ç”¨æˆ·çš„å…´è¶£ä¸»é¢˜ï¼ˆProfileï¼‰
- ä¿å­˜ç”¨æˆ·é˜…è¯»å†å²ï¼ˆCollectionï¼‰
- æ ¹æ®å…´è¶£æ¨èæ–°é—»

**æŠ€æœ¯è¦ç‚¹**ï¼š
- Store åŸºæœ¬æ“ä½œ
- Profile Schema è®¾è®¡
- ç®€å•çš„æ¨èé€»è¾‘

---

### é¡¹ç›® 2ï¼šæ™ºèƒ½å­¦ä¹ ç¬”è®°ç³»ç»Ÿ â­ ä¸­çº§
**æ—¶é•¿**ï¼š1-2 å¤©

**åŠŸèƒ½**ï¼š
- è®°å½•å­¦ä¹ ç¬”è®°ï¼ˆCollectionï¼‰
- ä¿å­˜å­¦ä¹ åå¥½ï¼ˆProfileï¼‰
- è‡ªåŠ¨åˆ†ç±»å’Œæ ‡ç­¾
- çŸ¥è¯†å›¾è°±å…³è”

**æŠ€æœ¯è¦ç‚¹**ï¼š
- Collection ç®¡ç†
- Trustcall æå–
- å¤æ‚ Schema è®¾è®¡
- è¯­ä¹‰æœç´¢

---

### é¡¹ç›® 3ï¼šä¼ä¸šçº§å®¢æœç³»ç»Ÿ ğŸš€ é«˜çº§
**æ—¶é•¿**ï¼š3-5 å¤©

**åŠŸèƒ½**ï¼š
- å¤šç”¨æˆ·è®°å¿†éš”ç¦»
- å®¢æˆ·èµ„æ–™ç®¡ç†ï¼ˆProfileï¼‰
- å¯¹è¯å†å²ï¼ˆCollectionï¼‰
- å·¥å•ç®¡ç†ï¼ˆCollectionï¼‰
- å®¢æœåå¥½è®¾ç½®ï¼ˆInstructionsï¼‰
- æ•°æ®åˆ†æå’ŒæŠ¥è¡¨

**æŠ€æœ¯è¦ç‚¹**ï¼š
- å¤šç§Ÿæˆ·æ¶æ„
- PostgresStore éƒ¨ç½²
- æ€§èƒ½ä¼˜åŒ–
- ç›‘æ§å’Œæ—¥å¿—
- æ•°æ®å®‰å…¨

---

## åäº”ã€ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆæœ¬ç« åï¼Œä½ å°†å…·å¤‡æ„å»ºå¤æ‚è®°å¿†ç³»ç»Ÿçš„èƒ½åŠ›ã€‚æ¥ä¸‹æ¥çš„å­¦ä¹ æ–¹å‘ï¼š

### Module-7ï¼šé«˜çº§ Agent æ¨¡å¼ï¼ˆå³å°†å­¦ä¹ ï¼‰
- Multi-Agent åä½œ
- Agent ç›‘ç£å’Œç¼–æ’
- åŠ¨æ€å·¥å…·é€‰æ‹©
- Agent æ€§èƒ½ä¼˜åŒ–

### å»¶ä¼¸ä¸»é¢˜
- **å‘é‡æ•°æ®åº“é›†æˆ**ï¼šè¯­ä¹‰æœç´¢è®°å¿†
- **RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰**ï¼šç»“åˆè®°å¿†å’Œå¤–éƒ¨çŸ¥è¯†
- **å¤šæ¨¡æ€è®°å¿†**ï¼šå›¾åƒã€éŸ³é¢‘è®°å¿†ç®¡ç†
- **è®°å¿†å‹ç¼©**ï¼šé•¿æœŸè®°å¿†çš„æ‘˜è¦å’Œå‹ç¼©

---

## åå…­ã€ç»“è¯­

è®°å¿†ç³»ç»Ÿæ˜¯ AI Agent ä»"å·¥å…·"è¿›åŒ–ä¸º"åŠ©æ‰‹"çš„å…³é”®ã€‚é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ ä¸ä»…æŒæ¡äº† LangGraph è®°å¿†ç³»ç»Ÿçš„æŠ€æœ¯å®ç°ï¼Œæ›´é‡è¦çš„æ˜¯ç†è§£äº†**å¦‚ä½•è®¾è®¡æ™ºèƒ½çš„è®°å¿†æ¶æ„**ã€‚

è®°ä½ä¸‰ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š

1. **ç®€æ´ä¼˜äºå¤æ‚**ï¼šä»ç®€å•çš„ Schema å¼€å§‹ï¼Œé€æ­¥æ‰©å±•
2. **å¢é‡ä¼˜äºå…¨é‡**ï¼šä½¿ç”¨ JSON Patch ç­‰å¢é‡æ›´æ–°æœºåˆ¶
3. **æ™ºèƒ½ä¼˜äºå­˜å‚¨**ï¼šä¸æ˜¯è®°ä½æ‰€æœ‰ä¸œè¥¿ï¼Œè€Œæ˜¯è®°ä½**é‡è¦çš„ä¸œè¥¿**

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹æ·±å…¥æ¯ä¸€èŠ‚çš„è¯¦ç»†å†…å®¹ï¼Œæ„å»ºä½ è‡ªå·±çš„æ™ºèƒ½è®°å¿†ç³»ç»Ÿï¼

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬ä» 6.1 Memory Agent å¼€å§‹å§ï¼** ğŸš€
