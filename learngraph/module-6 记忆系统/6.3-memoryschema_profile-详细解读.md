# 5.3 Memory Schema - Profile - è¯¦ç»†è§£è¯»

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **Profile Schema** | å•ä¸€ç»“æ„åŒ–å¯¹è±¡çš„æ•°æ®æ¨¡å¼ï¼Œå®šä¹‰å›ºå®šå­—æ®µï¼ˆå¦‚å§“åã€ä½ç½®ã€å…´è¶£ï¼‰ï¼Œä½¿ç”¨å›ºå®šé”®å­˜å‚¨ | ä½¿ç”¨ Pydantic BaseModel å®šä¹‰ï¼Œå¦‚ `UserProfile(user_name: str, interests: List[str])` | â­â­â­â­â­ |
| **TypedDict** | Python çš„ç±»å‹åŒ–å­—å…¸ï¼Œæä¾›ç±»å‹æç¤ºä½†ä¸åœ¨è¿è¡Œæ—¶éªŒè¯æ•°æ® | `typing.TypedDict` ç±»ï¼Œå®šä¹‰å­—å…¸çš„é”®å’Œå€¼ç±»å‹ï¼Œå¦‚ `class UserProfile(TypedDict): user_name: str` | â­â­â­ |
| **Pydantic BaseModel** | å¸¦è¿è¡Œæ—¶æ•°æ®éªŒè¯çš„ Python æ•°æ®æ¨¡å‹ï¼Œæ”¯æŒç±»å‹æ£€æŸ¥ã€é»˜è®¤å€¼å’Œåºåˆ—åŒ– | ç»§æ‰¿ `pydantic.BaseModel` çš„ç±»ï¼Œè‡ªåŠ¨éªŒè¯å­—æ®µç±»å‹å’Œå€¼ï¼Œå¦‚ `class UserProfile(BaseModel)` | â­â­â­â­â­ |
| **Field** | Pydantic ä¸­å®šä¹‰å­—æ®µçš„å‡½æ•°ï¼Œå¯æ·»åŠ æè¿°ã€é»˜è®¤å€¼å’ŒéªŒè¯è§„åˆ™ | `pydantic.Field(description="...", default=..., ge=0)`ï¼Œä¸º LLM æä¾›ä¸Šä¸‹æ–‡ | â­â­â­â­ |
| **with_structured_output()** | LangChain æ–¹æ³•ï¼Œå¼ºåˆ¶ LLM è¾“å‡ºç¬¦åˆé¢„å®šä¹‰ Schema çš„ç»“æ„åŒ–æ•°æ® | `model.with_structured_output(Schema)` è¿”å› Runnableï¼Œè‡ªåŠ¨è§£æä¸º Python å¯¹è±¡ | â­â­â­â­â­ |
| **Trustcall** | å¼€æºåº“ï¼Œä¸“é—¨ç”¨äºåˆ›å»ºå’Œæ›´æ–° JSON Schemaï¼Œæ”¯æŒå¢é‡æ›´æ–°å’Œè‡ªæˆ‘ä¿®æ­£ | `from trustcall import create_extractor`ï¼Œå¤„ç†å¤æ‚åµŒå¥— Schema å’Œ JSON Patch | â­â­â­â­â­ |
| **JSON Patch** | RFC 6902 æ ‡å‡†ï¼Œæè¿° JSON æ–‡æ¡£å˜æ›´çš„æ“ä½œåˆ—è¡¨ï¼ˆaddã€removeã€replace ç­‰ï¼‰ | æ“ä½œæ•°ç»„ï¼Œå¦‚ `[{"op": "add", "path": "/interests/-", "value": "bakeries"}]` | â­â­â­â­ |
| **create_extractor()** | Trustcall å‡½æ•°ï¼Œåˆ›å»ºç»“æ„åŒ–æ•°æ®æå–å™¨ï¼Œæ”¯æŒå·¥å…·è°ƒç”¨å’Œå¢é‡æ›´æ–° | `create_extractor(model, tools=[Schema], tool_choice="Schema")`ï¼Œè¿”å›å¯è°ƒç”¨çš„æå–å™¨ | â­â­â­â­â­ |
| **model_dump()** | Pydantic æ¨¡å‹æ–¹æ³•ï¼Œå°†å¯¹è±¡è½¬æ¢ä¸º Python å­—å…¸ï¼Œä¾¿äºå­˜å‚¨å’Œåºåˆ—åŒ– | `pydantic_obj.model_dump()` è¿”å› dictï¼ŒPydantic v2 æ›¿ä»£æ—§ç‰ˆ `dict()` æ–¹æ³• | â­â­â­â­ |
| **å¢é‡æ›´æ–°ï¼ˆIncremental Updateï¼‰** | åªæ›´æ–°å˜åŒ–çš„å­—æ®µè€Œä¸æ˜¯é‡æ–°ç”Ÿæˆæ•´ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨ JSON Patch å®ç° | Trustcall è‡ªåŠ¨è¯†åˆ«å˜åŒ–å¹¶ç”Ÿæˆæœ€å°åŒ–çš„æ›´æ–°æ“ä½œï¼ŒèŠ‚çœ Token å’Œä¿ç•™ä¿¡æ¯ | â­â­â­â­â­ |
| **existing å‚æ•°** | Trustcall çš„å…³é”®å‚æ•°ï¼Œä¼ å…¥ç°æœ‰æ•°æ®ä»¥è§¦å‘æ›´æ–°æ¨¡å¼è€Œéåˆ›å»ºæ¨¡å¼ | æ ¼å¼ï¼š`{"existing": {"SchemaName": existing_data}}`ï¼Œå‘Šè¯‰ Trustcall æ‰§è¡Œå¢é‡æ›´æ–° | â­â­â­â­ |
| **è‡ªæˆ‘ä¿®æ­£ï¼ˆSelf-Correctionï¼‰** | Trustcall å†…ç½®æœºåˆ¶ï¼Œå½“æ•°æ®éªŒè¯å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•å¹¶ä¿®æ­£é”™è¯¯ | è‡ªåŠ¨æ•è· ValidationErrorï¼Œç”Ÿæˆä¿®æ­£æç¤ºå¹¶é‡æ–°è°ƒç”¨ LLMï¼Œæé«˜æˆåŠŸç‡ | â­â­â­â­ |

---

## ä¸€ã€æ¦‚è¿°

![Profile Schema Architecture](https://cdn.prod.website-files.com/65b8cd72835ceeacd4449a53/6732d0437060f1754ea79908_Screenshot%202024-11-11%20at%207.48.53%E2%80%AFPM.png)

### 1.1 æœ¬èŠ‚ç®€ä»‹

æœ¬èŠ‚æ˜¯ LangChain Academy Module-5 çš„ç¬¬ä¸‰éƒ¨åˆ†ï¼Œä¸»è¦å†…å®¹æ˜¯å°†**éç»“æ„åŒ–çš„è®°å¿†**å‡çº§ä¸º**ç»“æ„åŒ–çš„ Profile Schemaï¼ˆç”¨æˆ·èµ„æ–™æ¨¡å¼ï¼‰**ï¼Œå¹¶ä½¿ç”¨ **Trustcall** åº“æ¥é«˜æ•ˆåœ°åˆ›å»ºå’Œæ›´æ–°è¿™äº›ç»“æ„åŒ–è®°å¿†ã€‚

### 1.2 ä» 5.2 åˆ° 5.3 çš„è¿›åŒ–

**5.2 èŠ‚çš„å±€é™æ€§**ï¼š

```python
# 5.2 çš„è®°å¿†æ ¼å¼ï¼ˆè‡ªç”±æ–‡æœ¬ï¼‰
{
    "memory": "- User's name is Lance\n- Likes biking in San Francisco"
}
```

**é—®é¢˜**ï¼š
1. âŒ æ²¡æœ‰ç»“æ„ï¼Œéš¾ä»¥æŸ¥è¯¢å’Œå¤„ç†
2. âŒ æ¯æ¬¡æ›´æ–°éƒ½éœ€è¦é‡æ–°ç”Ÿæˆæ•´ä¸ªæ–‡æœ¬
3. âŒ å®¹æ˜“ä¸¢å¤±ä¿¡æ¯
4. âŒ éš¾ä»¥éªŒè¯æ•°æ®å®Œæ•´æ€§

**5.3 çš„æ”¹è¿›ï¼ˆç»“æ„åŒ– Schemaï¼‰**ï¼š

```python
# 5.3 çš„è®°å¿†æ ¼å¼ï¼ˆç»“æ„åŒ–ï¼‰
{
    "user_name": "Lance",
    "user_location": "San Francisco",
    "interests": ["biking", "bakeries"]
}
```

**ä¼˜åŠ¿**ï¼š
1. âœ… æ¸…æ™°çš„æ•°æ®ç»“æ„
2. âœ… å¢é‡æ›´æ–°ï¼ˆåªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†ï¼‰
3. âœ… æ•°æ®éªŒè¯å’Œç±»å‹æ£€æŸ¥
4. âœ… æ˜“äºæŸ¥è¯¢å’Œå¤„ç†

### 1.3 å­¦ä¹ ç›®æ ‡

é€šè¿‡å­¦ä¹ æœ¬èŠ‚å†…å®¹ï¼Œä½ å°†æŒæ¡ï¼š

1. **ç»“æ„åŒ–æ•°æ®çš„å®šä¹‰**ï¼š
   - TypedDict
   - Pydantic BaseModel
   - å­—æ®µç±»å‹å’ŒéªŒè¯

2. **ç»“æ„åŒ–è¾“å‡º**ï¼š
   - `with_structured_output()` æ–¹æ³•
   - å¼ºåˆ¶æ¨¡å‹éµå¾ª Schema
   - å¤„ç†å¤æ‚ Schema çš„æŒ‘æˆ˜

3. **Trustcall åº“**ï¼š
   - åˆ›å»ºå’Œæ›´æ–°ç»“æ„åŒ–è®°å¿†
   - JSON Patch æœºåˆ¶
   - å¤„ç†å¤æ‚åµŒå¥— Schema

4. **å®é™…åº”ç”¨**ï¼š
   - æ„å»ºå¸¦æœ‰ç»“æ„åŒ– Profile çš„èŠå¤©æœºå™¨äºº
   - é«˜æ•ˆçš„è®°å¿†æ›´æ–°ç­–ç•¥

### 1.4 æœ¬èŠ‚çš„æ ¸å¿ƒä»·å€¼

```
éç»“æ„åŒ–è®°å¿† (5.2)         ç»“æ„åŒ–è®°å¿† (5.3)
     â†“                           â†“
è‡ªç”±æ–‡æœ¬                    å®šä¹‰ Schema
     â†“                           â†“
é‡æ–°ç”Ÿæˆ                    å¢é‡æ›´æ–°
     â†“                           â†“
å®¹æ˜“ä¸¢å¤±ä¿¡æ¯               ç²¾ç¡®æ§åˆ¶æ›´æ–°
     â†“                           â†“
éš¾ä»¥æŸ¥è¯¢                    æ˜“äºå¤„ç†
```

---

## äºŒã€ç»“æ„åŒ–æ•°æ®åŸºç¡€

### 2.1 ä»€ä¹ˆæ˜¯ç»“æ„åŒ–æ•°æ®ï¼Ÿ

**ç»“æ„åŒ–æ•°æ®**ï¼šå…·æœ‰æ˜ç¡®å®šä¹‰çš„æ ¼å¼å’Œç±»å‹çš„æ•°æ®ï¼Œå¯ä»¥è¢«ç¨‹åºè½»æ¾è§£æå’Œå¤„ç†ã€‚

**å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | éç»“æ„åŒ– | ç»“æ„åŒ– |
|------|---------|--------|
| æ ¼å¼ | è‡ªç”±æ–‡æœ¬ | å›ºå®šæ ¼å¼ |
| ç±»å‹ | æ— ç±»å‹çº¦æŸ | ä¸¥æ ¼ç±»å‹ |
| éªŒè¯ | éš¾ä»¥éªŒè¯ | è‡ªåŠ¨éªŒè¯ |
| æŸ¥è¯¢ | éœ€è¦è§£æ | ç›´æ¥è®¿é—® |
| ç¤ºä¾‹ | "Lanceå–œæ¬¢éª‘è½¦" | `{"name": "Lance", "hobby": "biking"}` |

### 2.2 Python ä¸­çš„ç»“æ„åŒ–æ•°æ®ç±»å‹

Python æä¾›å¤šç§[ç»“æ„åŒ–æ•°æ®](https://python.langchain.com/docs/concepts/structured_outputs/#schema-definition)çš„æ–¹å¼ï¼š

#### 2.2.1 æ™®é€šå­—å…¸ï¼ˆDictï¼‰

```python
# æ™®é€šå­—å…¸
user = {
    "name": "Lance",
    "age": 30,
    "interests": ["biking", "coffee"]
}

# ä¼˜ç‚¹ï¼šç®€å•ã€çµæ´»
# ç¼ºç‚¹ï¼šæ— ç±»å‹æ£€æŸ¥ã€æ˜“å‡ºé”™
```

#### 2.2.2 TypedDict

```python
from typing import TypedDict, List

class UserProfile(TypedDict):
    """ç”¨æˆ·èµ„æ–™çš„ç±»å‹åŒ–å­—å…¸"""
    user_name: str                # å­—ç¬¦ä¸²ç±»å‹
    interests: List[str]          # å­—ç¬¦ä¸²åˆ—è¡¨

# åˆ›å»ºå®ä¾‹
user: UserProfile = {
    "user_name": "Lance",
    "interests": ["biking", "coffee"]
}
```

**TypedDict çš„ç‰¹ç‚¹**ï¼š
- âœ… æä¾›ç±»å‹æç¤º
- âœ… IDE æ”¯æŒï¼ˆä»£ç è¡¥å…¨ï¼‰
- âœ… ç±»å‹æ£€æŸ¥ï¼ˆmypy ç­‰å·¥å…·ï¼‰
- âŒ è¿è¡Œæ—¶ä¸éªŒè¯
- âŒ æ— é»˜è®¤å€¼æ”¯æŒ

#### 2.2.3 Pydantic BaseModel

```python
from pydantic import BaseModel, Field
from typing import List

class UserProfile(BaseModel):
    """ç”¨æˆ·èµ„æ–™çš„ Pydantic æ¨¡å‹"""
    user_name: str = Field(description="ç”¨æˆ·çš„é¦–é€‰åç§°")
    interests: List[str] = Field(
        description="ç”¨æˆ·çš„å…´è¶£åˆ—è¡¨",
        default_factory=list
    )

# åˆ›å»ºå®ä¾‹
user = UserProfile(
    user_name="Lance",
    interests=["biking"]
)

# è‡ªåŠ¨éªŒè¯
try:
    invalid_user = UserProfile(
        user_name=123,  # é”™è¯¯ï¼šåº”è¯¥æ˜¯å­—ç¬¦ä¸²
        interests="biking"  # é”™è¯¯ï¼šåº”è¯¥æ˜¯åˆ—è¡¨
    )
except Exception as e:
    print(f"éªŒè¯å¤±è´¥ï¼š{e}")
```

**Pydantic çš„ç‰¹ç‚¹**ï¼š
- âœ… è¿è¡Œæ—¶æ•°æ®éªŒè¯
- âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢
- âœ… é»˜è®¤å€¼æ”¯æŒ
- âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- âœ… JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… æ–‡æ¡£ç”Ÿæˆ

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **ç±»å‹æ³¨è§£ï¼ˆType Hintsï¼‰**ï¼š
   ```python
   user_name: str              # å­—ç¬¦ä¸²ç±»å‹
   age: int                    # æ•´æ•°ç±»å‹
   interests: List[str]        # å­—ç¬¦ä¸²åˆ—è¡¨
   location: Optional[str]     # å¯é€‰å­—ç¬¦ä¸²ï¼ˆå¯ä»¥æ˜¯ Noneï¼‰
   ```

2. **Field å‡½æ•°**ï¼š
   ```python
   Field(
       description="å­—æ®µæè¿°",    # ç”¨äºæ–‡æ¡£å’Œ LLM æç¤º
       default="é»˜è®¤å€¼",          # é»˜è®¤å€¼
       default_factory=list,     # é»˜è®¤å€¼å·¥å‚å‡½æ•°
       ge=0,                     # å¤§äºç­‰äº 0ï¼ˆæ•°å­—éªŒè¯ï¼‰
       max_length=100            # æœ€å¤§é•¿åº¦ï¼ˆå­—ç¬¦ä¸²éªŒè¯ï¼‰
   )
   ```

### 2.3 ä¸ºä»€ä¹ˆä½¿ç”¨ Pydanticï¼Ÿ

åœ¨ LangChain ç”Ÿæ€ç³»ç»Ÿä¸­ï¼ŒPydantic æ˜¯é¦–é€‰çš„ç»“æ„åŒ–æ•°æ®å®šä¹‰æ–¹å¼ï¼š

1. **ä¸ LLM é›†æˆ**ï¼š
   - è‡ªåŠ¨ç”Ÿæˆ JSON Schema ä¾› LLM ç†è§£
   - `with_structured_output()` åŸç”Ÿæ”¯æŒ

2. **æ•°æ®éªŒè¯**ï¼š
   - é˜²æ­¢æ— æ•ˆæ•°æ®è¿›å…¥ç³»ç»Ÿ
   - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

3. **æ–‡æ¡£åŒ–**ï¼š
   - `description` å­—æ®µå¸®åŠ© LLM ç†è§£
   - è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£

4. **åºåˆ—åŒ–**ï¼š
   - `model_dump()`ï¼šè½¬æ¢ä¸ºå­—å…¸
   - `model_dump_json()`ï¼šè½¬æ¢ä¸º JSON å­—ç¬¦ä¸²

---

## ä¸‰ã€å®šä¹‰ Profile Schema

### 3.1 ç®€å•çš„ UserProfileï¼ˆTypedDictï¼‰

è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ TypedDict å¼€å§‹ï¼š

```python
from typing import TypedDict, List

class UserProfile(TypedDict):
    """ç”¨æˆ·èµ„æ–™çš„ç±»å‹åŒ–å­—å…¸"""
    user_name: str                # ç”¨æˆ·çš„é¦–é€‰åç§°
    interests: List[str]          # ç”¨æˆ·çš„å…´è¶£åˆ—è¡¨
```

**å­—æ®µè¯´æ˜**ï¼š
- `user_name`ï¼šå­˜å‚¨ç”¨æˆ·çš„åå­—ï¼ˆå¦‚ "Lance"ï¼‰
- `interests`ï¼šå­˜å‚¨ç”¨æˆ·çš„å…´è¶£åˆ—è¡¨ï¼ˆå¦‚ ["biking", "coffee"]ï¼‰

### 3.2 åˆ›å»º TypedDict å®ä¾‹

```python
# åˆ›å»ºç”¨æˆ·èµ„æ–™å®ä¾‹
user_profile: UserProfile = {
    "user_name": "Lance",
    "interests": ["biking", "technology", "coffee"]
}

print(user_profile)
# è¾“å‡ºï¼š{'user_name': 'Lance', 'interests': ['biking', 'technology', 'coffee']}
```

**Python çŸ¥è¯†ç‚¹**ï¼š

**ç±»å‹æ³¨è§£çš„ä½œç”¨**ï¼š
```python
user_profile: UserProfile = {...}
# è¿™å‘Šè¯‰ IDE å’Œç±»å‹æ£€æŸ¥å·¥å…·ï¼š
# - user_profile åº”è¯¥æ˜¯ UserProfile ç±»å‹
# - æä¾›ä»£ç è¡¥å…¨
# - é™æ€ç±»å‹æ£€æŸ¥
```

### 3.3 ä¿å­˜ Schema åˆ° Store

```python
import uuid
from langgraph.store.memory import InMemoryStore

# åˆå§‹åŒ– Store
in_memory_store = InMemoryStore()

# å®šä¹‰å‘½åç©ºé—´
user_id = "1"
namespace_for_memory = (user_id, "memory")

# ä¿å­˜ Profile
key = "user_profile"
value = user_profile  # TypedDict å®ä¾‹ï¼ˆæœ¬è´¨ä¸Šæ˜¯å­—å…¸ï¼‰
in_memory_store.put(namespace_for_memory, key, value)
```

**é‡è¦æç¤º**ï¼š
- Store æ¥å—ä»»ä½• Python å­—å…¸ä½œä¸º value
- TypedDict åœ¨è¿è¡Œæ—¶å°±æ˜¯æ™®é€šå­—å…¸
- å¯ä»¥ç›´æ¥ä¿å­˜åˆ° Store

### 3.4 ä» Store æ£€ç´¢ Schema

```python
# æœç´¢å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰æ•°æ®
for m in in_memory_store.search(namespace_for_memory):
    print(m.dict())
```

**è¾“å‡º**ï¼š
```python
{
    'value': {
        'user_name': 'Lance',
        'interests': ['biking', 'technology', 'coffee']
    },
    'key': 'user_profile',
    'namespace': ['1', 'memory'],
    'created_at': '2024-11-04T23:37:34.871675+00:00',
    'updated_at': '2024-11-04T23:37:34.871680+00:00'
}
```

**è·å–ç‰¹å®šå¯¹è±¡**ï¼š
```python
# é€šè¿‡å‘½åç©ºé—´å’Œé”®è·å–
profile = in_memory_store.get(namespace_for_memory, "user_profile")
print(profile.value)
# è¾“å‡ºï¼š{'user_name': 'Lance', 'interests': ['biking', 'technology', 'coffee']}
```

---

## å››ã€ç»“æ„åŒ–è¾“å‡ºï¼ˆStructured Outputï¼‰

### 4.1 ä»€ä¹ˆæ˜¯ç»“æ„åŒ–è¾“å‡ºï¼Ÿ

**ç»“æ„åŒ–è¾“å‡º**ï¼šå¼ºåˆ¶ LLM çš„è¾“å‡ºç¬¦åˆé¢„å®šä¹‰çš„ Schemaï¼Œè€Œä¸æ˜¯è‡ªç”±æ–‡æœ¬ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦ç»“æ„åŒ–è¾“å‡ºï¼Ÿ**

```
ç”¨æˆ·è¾“å…¥ï¼š"My name is Lance, I like to bike."

è‡ªç”±æ–‡æœ¬è¾“å‡ºï¼š
"The user's name is Lance and he enjoys biking."

ç»“æ„åŒ–è¾“å‡ºï¼š
{
    "user_name": "Lance",
    "interests": ["biking"]
}
```

**ä¼˜åŠ¿**ï¼š
1. âœ… è¾“å‡ºæ ¼å¼å¯é¢„æµ‹
2. âœ… æ˜“äºè§£æå’Œå¤„ç†
3. âœ… æ•°æ®å®Œæ•´æ€§ä¿è¯
4. âœ… ç›´æ¥ç”¨äºä¸‹æ¸¸ä»»åŠ¡

### 4.2 ä½¿ç”¨ with_structured_output()

LangChain çš„èŠå¤©æ¨¡å‹æä¾› [`with_structured_output()`](https://python.langchain.com/docs/concepts/structured_outputs/#recommended-usage) æ–¹æ³•ï¼š

```python
from pydantic import BaseModel, Field
from langchain_core.messages import HumanMessage
from langchain_openai import ChatOpenAI

# åˆå§‹åŒ–æ¨¡å‹
model = ChatOpenAI(model="gpt-5-nano", temperature=0)

# ç»‘å®š Schema åˆ°æ¨¡å‹
model_with_structure = model.with_structured_output(UserProfile)

# è°ƒç”¨æ¨¡å‹
structured_output = model_with_structure.invoke([
    HumanMessage("My name is Lance, I like to bike.")
])

print(structured_output)
# è¾“å‡ºï¼š{'user_name': 'Lance', 'interests': ['biking']}
```

**å·¥ä½œåŸç†**ï¼š

```
1. ç”¨æˆ·æ¶ˆæ¯
   â†“
2. with_structured_output() å°† Schema è½¬æ¢ä¸ºå·¥å…·å®šä¹‰
   â†“
3. æ¨¡å‹ä½¿ç”¨å·¥å…·è°ƒç”¨ï¼ˆTool Callingï¼‰ç”Ÿæˆç»“æ„åŒ–è¾“å‡º
   â†“
4. è‡ªåŠ¨è§£æä¸º Python å¯¹è±¡ï¼ˆå­—å…¸æˆ– Pydantic æ¨¡å‹ï¼‰
```

**Python çŸ¥è¯†ç‚¹**ï¼š

**æ–¹æ³•é“¾ï¼ˆMethod Chainingï¼‰**ï¼š
```python
model                          # ChatOpenAI å®ä¾‹
  .with_structured_output(...)  # è¿”å›æ–°çš„ Runnable
  .invoke(...)                  # è°ƒç”¨å¹¶è·å–ç»“æœ
```

### 4.3 åœ¨èŠå¤©æœºå™¨äººä¸­ä½¿ç”¨ç»“æ„åŒ–è¾“å‡º

è®©æˆ‘ä»¬å°†å…¶é›†æˆåˆ°ä¹‹å‰çš„èŠå¤©æœºå™¨äººä¸­ï¼š

```python
def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):
    """åæ€èŠå¤©å†å²å¹¶ä¿å­˜è®°å¿†åˆ° store"""

    # è·å–ç”¨æˆ· ID
    user_id = config["configurable"]["user_id"]

    # æ£€ç´¢ç°æœ‰è®°å¿†
    namespace = ("memory", user_id)
    existing_memory = store.get(namespace, "user_memory")

    # æ ¼å¼åŒ–ç°æœ‰è®°å¿†
    if existing_memory and existing_memory.value:
        memory_dict = existing_memory.value
        formatted_memory = (
            f"Name: {memory_dict.get('user_name', 'Unknown')}\n"
            f"Interests: {', '.join(memory_dict.get('interests', []))}"
        )
    else:
        formatted_memory = None

    # åˆ›å»ºæŒ‡ä»¤
    system_msg = CREATE_MEMORY_INSTRUCTION.format(memory=formatted_memory)

    # ä½¿ç”¨ with_structured_output ç”Ÿæˆç»“æ„åŒ–è®°å¿†
    new_memory = model_with_structure.invoke([
        SystemMessage(content=system_msg)
    ] + state['messages'])

    # ä¿å­˜åˆ° store
    key = "user_memory"
    store.put(namespace, key, new_memory)
```

**å…³é”®æ”¹å˜**ï¼š
- ä½¿ç”¨ `model_with_structure` è€Œä¸æ˜¯æ™®é€šçš„ `model`
- `new_memory` è‡ªåŠ¨æ˜¯ç¬¦åˆ Schema çš„å­—å…¸
- ç›´æ¥ä¿å­˜åˆ° Storeï¼Œæ— éœ€é¢å¤–å¤„ç†

---

## äº”ã€å¤æ‚ Schema çš„æŒ‘æˆ˜

### 5.1 ç®€å• Schema vs å¤æ‚ Schema

**ç®€å• Schema**ï¼ˆå®¹æ˜“æå–ï¼‰ï¼š
```python
class UserProfile(BaseModel):
    user_name: str
    interests: List[str]
```

**å¤æ‚åµŒå¥— Schema**ï¼ˆéš¾ä»¥æå–ï¼‰ï¼š
```python
class OutputFormat(BaseModel):
    preference: str
    sentence_preference_revealed: str

class TelegramPreferences(BaseModel):
    preferred_encoding: Optional[List[OutputFormat]] = None
    favorite_telegram_operators: Optional[List[OutputFormat]] = None
    preferred_telegram_paper: Optional[List[OutputFormat]] = None

class MorseCode(BaseModel):
    preferred_key_type: Optional[List[OutputFormat]] = None
    favorite_morse_abbreviations: Optional[List[OutputFormat]] = None

class Semaphore(BaseModel):
    preferred_flag_color: Optional[List[OutputFormat]] = None
    semaphore_skill_level: Optional[List[OutputFormat]] = None

class TrustFallPreferences(BaseModel):
    preferred_fall_height: Optional[List[OutputFormat]] = None
    trust_level: Optional[List[OutputFormat]] = None
    preferred_catching_technique: Optional[List[OutputFormat]] = None

class CommunicationPreferences(BaseModel):
    telegram: TelegramPreferences
    morse_code: MorseCode
    semaphore: Semaphore

class UserPreferences(BaseModel):
    communication_preferences: CommunicationPreferences
    trust_fall_preferences: TrustFallPreferences

class TelegramAndTrustFallPreferences(BaseModel):
    pertinent_user_preferences: UserPreferences
```

**å¤æ‚åº¦åˆ†æ**ï¼š
- 6 å±‚åµŒå¥—
- 10+ ä¸ªç±»å®šä¹‰
- å¤§é‡å¯é€‰å­—æ®µ
- å¤æ‚çš„ä¾èµ–å…³ç³»

### 5.2 ä½¿ç”¨ with_structured_output() çš„å¤±è´¥æ¡ˆä¾‹

è®©æˆ‘ä»¬å°è¯•æå–è¿™ä¸ªå¤æ‚ Schemaï¼š

```python
from pydantic import ValidationError

# ç»‘å®šå¤æ‚ Schema
model_with_structure = model.with_structured_output(TelegramAndTrustFallPreferences)

# å¯¹è¯å†…å®¹
conversation = """Operator: How may I assist with your telegram, sir?
Customer: I need to send a message about our trust fall exercise.
Operator: Certainly. Morse code or standard encoding?
Customer: Morse, please. I love using a straight key.
Operator: Excellent. What's your message?
Customer: Tell him I'm ready for a higher fall, and I prefer the diamond formation for catching.
Operator: Done. Shall I use our "Daredevil" paper for this daring message?
Customer: Perfect! Send it by your fastest carrier pigeon.
Operator: It'll be there within the hour, sir."""

# å°è¯•æå–
try:
    result = model_with_structure.invoke(
        f"""Extract the preferences from the following conversation:
        <convo>
        {conversation}
        </convo>"""
    )
except ValidationError as e:
    print(e)
```

**è¾“å‡ºï¼ˆé”™è¯¯ï¼‰**ï¼š
```
1 validation error for TelegramAndTrustFallPreferences
pertinent_user_preferences.communication_preferences.semaphore
  Input should be a valid dictionary or instance of Semaphore [type=model_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.9/v/model_type
```

**å¤±è´¥åŸå› **ï¼š
1. âŒ Schema å¤ªå¤æ‚ï¼Œæ¨¡å‹éš¾ä»¥ç†è§£
2. âŒ åµŒå¥—å±‚çº§å¤ªæ·±
3. âŒ å¯é€‰å­—æ®µå¤„ç†ä¸å½“ï¼ˆè¿”å›äº† None è€Œä¸æ˜¯å¯¹è±¡ï¼‰
4. âŒ å³ä½¿ä½¿ç”¨ GPT-4o è¿™æ ·çš„é«˜çº§æ¨¡å‹ä¹Ÿä¼šå¤±è´¥

### 5.3 ä¸ºä»€ä¹ˆéœ€è¦ Trustcallï¼Ÿ

**é—®é¢˜æ€»ç»“**ï¼š

| é—®é¢˜ | with_structured_output | Trustcall |
|------|----------------------|-----------|
| å¤æ‚ Schema | âŒ å®¹æ˜“å¤±è´¥ | âœ… ä¸“é—¨å¤„ç† |
| æ›´æ–°æ•ˆç‡ | âŒ é‡æ–°ç”Ÿæˆ | âœ… å¢é‡æ›´æ–° |
| ä¿¡æ¯ä¸¢å¤± | âŒ å¯èƒ½ä¸¢å¤± | âœ… ä¿ç•™ç°æœ‰ä¿¡æ¯ |
| Token æ¶ˆè€— | âŒ æ¯æ¬¡ç”Ÿæˆå…¨éƒ¨ | âœ… åªç”Ÿæˆå˜åŒ–éƒ¨åˆ† |
| é”™è¯¯æ¢å¤ | âŒ éœ€è¦é‡è¯• | âœ… è‡ªåŠ¨ä¿®æ­£ |

---

## å…­ã€Trustcall æ·±å…¥è§£æ

### 6.1 ä»€ä¹ˆæ˜¯ Trustcallï¼Ÿ

[Trustcall](https://github.com/hinthornw/trustcall) æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äº**åˆ›å»ºå’Œæ›´æ–° JSON Schema** çš„å¼€æºåº“ï¼Œç”± LangChain å›¢é˜Ÿçš„ [Will Fu-Hinthorn](https://github.com/hinthornw) å¼€å‘ã€‚

**æ ¸å¿ƒç†å¿µ**ï¼š

1. **å¢é‡æ›´æ–°**ï¼šä½¿ç”¨ JSON Patch åªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
2. **æ™ºèƒ½æå–**ï¼šæ›´å¥½åœ°å¤„ç†å¤æ‚åµŒå¥— Schema
3. **è‡ªæˆ‘ä¿®æ­£**ï¼šè‡ªåŠ¨å¤„ç†éªŒè¯é”™è¯¯
4. **ä¿ç•™ä¿¡æ¯**ï¼šä¸ä¼šä¸¢å¤±ç°æœ‰æ•°æ®

### 6.2 JSON Patch ç®€ä»‹

[JSON Patch](https://jsonpatch.com/) æ˜¯ä¸€ä¸ªæè¿° JSON æ–‡æ¡£å˜æ›´çš„æ ‡å‡†ï¼ˆRFC 6902ï¼‰ã€‚

**ç¤ºä¾‹**ï¼š

**åŸå§‹æ•°æ®**ï¼š
```json
{
    "user_name": "Lance",
    "interests": ["biking"]
}
```

**JSON Patch æ“ä½œ**ï¼š
```json
[
    {
        "op": "add",
        "path": "/interests/-",
        "value": "bakeries"
    }
]
```

**ç»“æœ**ï¼š
```json
{
    "user_name": "Lance",
    "interests": ["biking", "bakeries"]
}
```

**JSON Patch æ“ä½œç±»å‹**ï¼š

| æ“ä½œ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| add | æ·»åŠ å­—æ®µæˆ–æ•°ç»„å…ƒç´  | `{"op": "add", "path": "/email", "value": "..."}` |
| remove | åˆ é™¤å­—æ®µæˆ–æ•°ç»„å…ƒç´  | `{"op": "remove", "path": "/interests/0"}` |
| replace | æ›¿æ¢å€¼ | `{"op": "replace", "path": "/name", "value": "..."}` |
| move | ç§»åŠ¨å€¼ | `{"op": "move", "from": "/a", "path": "/b"}` |
| copy | å¤åˆ¶å€¼ | `{"op": "copy", "from": "/a", "path": "/b"}` |
| test | æµ‹è¯•å€¼ | `{"op": "test", "path": "/name", "value": "Lance"}` |

### 6.3 Trustcall çš„å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Trustcall Workflow                â”‚
â”‚                                             â”‚
â”‚  1. æ¥æ”¶è¾“å…¥                                â”‚
â”‚     - æ–°çš„å¯¹è¯æ¶ˆæ¯                          â”‚
â”‚     - ç°æœ‰çš„ Schemaï¼ˆå¦‚æœæœ‰ï¼‰               â”‚
â”‚                                             â”‚
â”‚  2. åˆ†æå˜åŒ–                                â”‚
â”‚     - è¯†åˆ«æ–°ä¿¡æ¯                            â”‚
â”‚     - è¯†åˆ«éœ€è¦æ›´æ–°çš„å­—æ®µ                    â”‚
â”‚                                             â”‚
â”‚  3. ç”Ÿæˆ JSON Patch                         â”‚
â”‚     - åˆ›å»ºç²¾ç¡®çš„æ›´æ–°æ“ä½œ                    â”‚
â”‚     - åªä¿®æ”¹å˜åŒ–çš„éƒ¨åˆ†                      â”‚
â”‚                                             â”‚
â”‚  4. åº”ç”¨ Patch                              â”‚
â”‚     - æ›´æ–°ç°æœ‰ Schema                       â”‚
â”‚     - ä¿ç•™æœªå˜åŒ–çš„ä¿¡æ¯                      â”‚
â”‚                                             â”‚
â”‚  5. éªŒè¯ç»“æœ                                â”‚
â”‚     - ç¡®ä¿ç¬¦åˆ Schema å®šä¹‰                  â”‚
â”‚     - å¦‚æœå¤±è´¥ï¼Œè‡ªåŠ¨ä¿®æ­£                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 åˆ›å»º Trustcall Extractor

```python
from trustcall import create_extractor
from pydantic import BaseModel, Field

# å®šä¹‰ Schema
class UserProfile(BaseModel):
    """ç”¨æˆ·èµ„æ–™"""
    user_name: str = Field(description="ç”¨æˆ·çš„é¦–é€‰åç§°")
    interests: List[str] = Field(description="ç”¨æˆ·çš„å…´è¶£åˆ—è¡¨")

# åˆå§‹åŒ–æ¨¡å‹
model = ChatOpenAI(model="gpt-5-nano", temperature=0)

# åˆ›å»º Trustcall æå–å™¨
trustcall_extractor = create_extractor(
    model,
    tools=[UserProfile],        # å¯ä»¥ä¼ å…¥å¤šä¸ª Schema
    tool_choice="UserProfile"   # å¼ºåˆ¶ä½¿ç”¨ UserProfile å·¥å…·
)
```

**å‚æ•°è¯´æ˜**ï¼š

1. **model**ï¼šè¦ä½¿ç”¨çš„è¯­è¨€æ¨¡å‹
2. **tools**ï¼šSchema åˆ—è¡¨ï¼ˆå¯ä»¥æ˜¯ Pydantic æ¨¡å‹ã€TypedDictã€æˆ– JSON Schemaï¼‰
3. **tool_choice**ï¼šæŒ‡å®šä½¿ç”¨å“ªä¸ªå·¥å…·
   - å¦‚æœä¸æŒ‡å®šï¼Œæ¨¡å‹å¯ä»¥é€‰æ‹©ä»»æ„å·¥å…·æˆ–ä¸ä½¿ç”¨å·¥å…·
   - æŒ‡å®šåï¼Œå¼ºåˆ¶æ¨¡å‹ä½¿ç”¨è¯¥å·¥å…·

**Python çŸ¥è¯†ç‚¹**ï¼š

**åˆ—è¡¨ä½œä¸ºå‚æ•°**ï¼š
```python
tools=[UserProfile]
# ç­‰ä»·äºï¼š
tools=[UserProfile,]  # å•å…ƒç´ åˆ—è¡¨ï¼Œåé¢çš„é€—å·å¯é€‰
```

### 6.5 åŸºç¡€ä½¿ç”¨ï¼šæå–ä¿¡æ¯

```python
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage

# å¯¹è¯å†…å®¹
conversation = [
    HumanMessage(content="Hi, I'm Lance."),
    AIMessage(content="Nice to meet you, Lance."),
    HumanMessage(content="I really like biking around San Francisco.")
]

# æå–æŒ‡ä»¤
system_msg = "Extract the user profile from the following conversation"

# è°ƒç”¨æå–å™¨
result = trustcall_extractor.invoke({
    "messages": [SystemMessage(content=system_msg)] + conversation
})
```

**è¿”å›ç»“æœç»“æ„**ï¼š

```python
result = {
    "messages": [...],           # AI çš„å·¥å…·è°ƒç”¨æ¶ˆæ¯
    "responses": [...],          # è§£æåçš„ Pydantic å¯¹è±¡
    "response_metadata": [...]   # å…ƒæ•°æ®ï¼ˆID ç­‰ï¼‰
}
```

**æŸ¥çœ‹æ¶ˆæ¯**ï¼š
```python
for m in result["messages"]:
    m.pretty_print()
```

**è¾“å‡º**ï¼š
```
================================== Ai Message ==================================
Tool Calls:
  UserProfile (call_spGGUsoaUFXU7oOrUNCASzfL)
 Call ID: call_spGGUsoaUFXU7oOrUNCASzfL
  Args:
    user_name: Lance
    interests: ['biking around San Francisco']
```

**æŸ¥çœ‹æå–çš„ Schema**ï¼š
```python
schema = result["responses"]
print(schema)
# è¾“å‡ºï¼š[UserProfile(user_name='Lance', interests=['biking around San Francisco'])]

# è½¬æ¢ä¸ºå­—å…¸
print(schema[0].model_dump())
# è¾“å‡ºï¼š{'user_name': 'Lance', 'interests': ['biking around San Francisco']}
```

**æŸ¥çœ‹å…ƒæ•°æ®**ï¼š
```python
print(result["response_metadata"])
# è¾“å‡ºï¼š[{'id': 'call_spGGUsoaUFXU7oOrUNCASzfL'}]
```

### 6.6 é«˜çº§ä½¿ç”¨ï¼šæ›´æ–°ç°æœ‰ Schema

Trustcall çš„çœŸæ­£å¨åŠ›åœ¨äº**æ›´æ–°ç°æœ‰ Schema**ã€‚

#### 6.6.1 å‡†å¤‡ç°æœ‰ Schema

```python
# ä¿å­˜ç°æœ‰ Schema ä¸ºå­—å…¸
existing_schema_dict = schema[0].model_dump()
# {'user_name': 'Lance', 'interests': ['biking around San Francisco']}
```

**Python çŸ¥è¯†ç‚¹**ï¼š

**`model_dump()` vs `dict()`**ï¼š
```python
# Pydantic v2
schema.model_dump()      # æ¨èæ–¹å¼

# Pydantic v1ï¼ˆæ—§ç‰ˆï¼‰
schema.dict()            # å·²å¼ƒç”¨

# å¯¹äºæ™®é€šå¯¹è±¡
vars(obj)                # è·å–å¯¹è±¡çš„ __dict__
```

#### 6.6.2 æ›´æ–°æ“ä½œ

```python
# æ›´æ–°å¯¹è¯
updated_conversation = [
    HumanMessage(content="Hi, I'm Lance."),
    AIMessage(content="Nice to meet you, Lance."),
    HumanMessage(content="I really like biking around San Francisco."),
    AIMessage(content="San Francisco is a great city! Where do you go after biking?"),
    HumanMessage(content="I really like to go to a bakery after biking."),
]

# æ›´æ–°æŒ‡ä»¤
system_msg = "Update the memory (JSON doc) to incorporate new information from the following conversation"

# è°ƒç”¨æå–å™¨ï¼Œä¼ å…¥ç°æœ‰ Schema
result = trustcall_extractor.invoke(
    {"messages": [SystemMessage(content=system_msg)] + updated_conversation},
    {"existing": {"UserProfile": existing_schema_dict}}
)
```

**å…³é”®å‚æ•°**ï¼š
```python
{"existing": {"UserProfile": existing_schema_dict}}
```

- `"existing"`ï¼šå‘Šè¯‰ Trustcall è¿™æ˜¯æ›´æ–°æ“ä½œ
- `"UserProfile"`ï¼šSchema çš„åç§°ï¼ˆå·¥å…·åç§°ï¼‰
- `existing_schema_dict`ï¼šç°æœ‰çš„ Schema æ•°æ®ï¼ˆå­—å…¸ï¼‰

**æŸ¥çœ‹æ›´æ–°ç»“æœ**ï¼š
```python
for m in result["messages"]:
    m.pretty_print()
```

**è¾“å‡º**ï¼š
```
================================== Ai Message ==================================
Tool Calls:
  UserProfile (call_WeZl0ACfQStxblim0ps8LNKT)
 Call ID: call_WeZl0ACfQStxblim0ps8LNKT
  Args:
    user_name: Lance
    interests: ['biking', 'visiting bakeries']
```

**æ³¨æ„å˜åŒ–**ï¼š
- åŸæ¥ï¼š`['biking around San Francisco']`
- æ›´æ–°åï¼š`['biking', 'visiting bakeries']`
- æ¨¡å‹æ™ºèƒ½åœ°åˆå¹¶äº†ä¿¡æ¯

**è·å–æ›´æ–°åçš„ Schema**ï¼š
```python
updated_schema = result["responses"][0]
print(updated_schema.model_dump())
# è¾“å‡ºï¼š{'user_name': 'Lance', 'interests': ['biking', 'visiting bakeries']}
```

### 6.7 å¤„ç†å¤æ‚ Schema

ç°åœ¨è®©æˆ‘ä»¬ç”¨ Trustcall å¤„ç†ä¹‹å‰å¤±è´¥çš„å¤æ‚ Schemaï¼š

```python
# åˆ›å»ºå¤æ‚ Schema çš„æå–å™¨
bound = create_extractor(
    model,
    tools=[TelegramAndTrustFallPreferences],
    tool_choice="TelegramAndTrustFallPreferences",
)

# å¯¹è¯å†…å®¹ï¼ˆåŒä¹‹å‰ï¼‰
conversation = """Operator: How may I assist with your telegram, sir?
Customer: I need to send a message about our trust fall exercise.
Operator: Certainly. Morse code or standard encoding?
Customer: Morse, please. I love using a straight key.
Operator: Excellent. What's your message?
Customer: Tell him I'm ready for a higher fall, and I prefer the diamond formation for catching.
Operator: Done. Shall I use our "Daredevil" paper for this daring message?
Customer: Perfect! Send it by your fastest carrier pigeon.
Operator: It'll be there within the hour, sir."""

# æå–
result = bound.invoke(
    f"""Extract the preferences from the following conversation:
    <convo>
    {conversation}
    </convo>"""
)

# æˆåŠŸæå–ï¼
preferences = result["responses"][0]
print(preferences)
```

**æˆåŠŸè¾“å‡º**ï¼š
```python
TelegramAndTrustFallPreferences(
    pertinent_user_preferences=UserPreferences(
        communication_preferences=CommunicationPreferences(
            telegram=TelegramPreferences(
                preferred_encoding=[OutputFormat(
                    preference='standard encoding',
                    sentence_preference_revealed='standard encoding'
                )],
                favorite_telegram_operators=None,
                preferred_telegram_paper=[OutputFormat(
                    preference='Daredevil',
                    sentence_preference_revealed='Daredevil'
                )]
            ),
            morse_code=MorseCode(
                preferred_key_type=[OutputFormat(
                    preference='straight key',
                    sentence_preference_revealed='straight key'
                )],
                favorite_morse_abbreviations=None
            ),
            semaphore=Semaphore(
                preferred_flag_color=None,
                semaphore_skill_level=None
            )
        ),
        trust_fall_preferences=TrustFallPreferences(
            preferred_fall_height=[OutputFormat(
                preference='higher',
                sentence_preference_revealed='higher'
            )],
            trust_level=None,
            preferred_catching_technique=[OutputFormat(
                preference='diamond formation',
                sentence_preference_revealed='diamond formation'
            )]
        )
    )
)
```

**æˆåŠŸçš„å…³é”®**ï¼š
1. âœ… Trustcall æ­£ç¡®å¤„ç†äº†åµŒå¥—ç»“æ„
2. âœ… æ­£ç¡®åˆå§‹åŒ–äº†æ‰€æœ‰å¿…éœ€çš„å­—æ®µï¼ˆå¦‚ Semaphoreï¼‰
3. âœ… æå–äº†æ‰€æœ‰ç›¸å…³ä¿¡æ¯
4. âœ… å³ä½¿æ˜¯ 6 å±‚åµŒå¥—ä¹Ÿèƒ½æ­£ç¡®å¤„ç†

### 6.8 Trustcall vs with_structured_output å¯¹æ¯”

| ç‰¹æ€§ | with_structured_output | Trustcall |
|------|----------------------|-----------|
| **ç®€å• Schema** | âœ… æ•ˆæœå¥½ | âœ… æ•ˆæœå¥½ |
| **å¤æ‚åµŒå¥— Schema** | âŒ å®¹æ˜“å¤±è´¥ | âœ… ä¸“é—¨ä¼˜åŒ– |
| **æ›´æ–°ç­–ç•¥** | âŒ å®Œå…¨é‡æ–°ç”Ÿæˆ | âœ… å¢é‡æ›´æ–°ï¼ˆJSON Patchï¼‰ |
| **Token æ•ˆç‡** | âŒ æ¯æ¬¡ç”Ÿæˆå…¨éƒ¨ | âœ… åªç”Ÿæˆå˜åŒ–éƒ¨åˆ† |
| **ä¿¡æ¯ä¿ç•™** | âš ï¸ å¯èƒ½ä¸¢å¤± | âœ… ä¿ç•™æœªå˜åŒ–ä¿¡æ¯ |
| **é”™è¯¯æ¢å¤** | âŒ éœ€è¦æ‰‹åŠ¨å¤„ç† | âœ… è‡ªåŠ¨ä¿®æ­£ |
| **è®¾ç½®å¤æ‚åº¦** | âœ… ç®€å• | âš ï¸ ç¨å¤æ‚ |
| **é€‚ç”¨åœºæ™¯** | ç®€å• Schemaã€åˆ›å»ºæ“ä½œ | å¤æ‚ Schemaã€æ›´æ–°æ“ä½œ |

---

## ä¸ƒã€æ„å»ºå¸¦æœ‰ Profile Schema çš„èŠå¤©æœºå™¨äºº

### 7.1 å®Œæ•´çš„ Schema å®šä¹‰

```python
from pydantic import BaseModel, Field
from typing import List

class UserProfile(BaseModel):
    """ç”¨æˆ·èµ„æ–™"""
    user_name: str = Field(description="ç”¨æˆ·çš„é¦–é€‰åç§°")
    user_location: str = Field(description="ç”¨æˆ·çš„ä½ç½®")
    interests: List[str] = Field(description="ç”¨æˆ·çš„å…´è¶£åˆ—è¡¨")
```

**ä¸ºä»€ä¹ˆæ·»åŠ  `user_location`ï¼Ÿ**
- æ›´å®Œæ•´çš„ç”¨æˆ·èµ„æ–™
- å¸®åŠ©æä¾›æœ¬åœ°åŒ–å»ºè®®
- å±•ç¤ºå¦‚ä½•å¤„ç†å¤šä¸ªå­—æ®µ

### 7.2 åˆ›å»º Trustcall Extractor

```python
from langchain_openai import ChatOpenAI
from trustcall import create_extractor

# åˆå§‹åŒ–æ¨¡å‹
model = ChatOpenAI(model="gpt-5-nano", temperature=0)

# åˆ›å»ºæå–å™¨
trustcall_extractor = create_extractor(
    model,
    tools=[UserProfile],
    tool_choice="UserProfile",  # å¼ºåˆ¶ä½¿ç”¨ UserProfile
)
```

### 7.3 å®šä¹‰ç³»ç»Ÿæç¤ºè¯

```python
# èŠå¤©æœºå™¨äººæç¤ºè¯
MODEL_SYSTEM_MESSAGE = """You are a helpful assistant with memory that provides information about the user.
If you have memory for this user, use it to personalize your responses.
Here is the memory (it may be empty): {memory}"""

# Trustcall æå–æŒ‡ä»¤
TRUSTCALL_INSTRUCTION = """Create or update the memory (JSON doc) to incorporate information from the following conversation:"""
```

**æç¤ºè¯è®¾è®¡è¦ç‚¹**ï¼š

1. **MODEL_SYSTEM_MESSAGE**ï¼š
   - ç®€æ´æ˜äº†
   - å¼ºè°ƒä¸ªæ€§åŒ–
   - æä¾›è®°å¿†å ä½ç¬¦

2. **TRUSTCALL_INSTRUCTION**ï¼š
   - æ˜ç¡®ä»»åŠ¡ï¼ˆåˆ›å»ºæˆ–æ›´æ–°ï¼‰
   - ç®€æ´ï¼ˆTrustcall ä¼šè‡ªåŠ¨å¤„ç†ç»†èŠ‚ï¼‰

### 7.4 call_model èŠ‚ç‚¹

```python
from langgraph.graph import MessagesState
from langchain_core.runnables.config import RunnableConfig
from langgraph.store.base import BaseStore
from langchain_core.messages import SystemMessage

def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):
    """ä» store åŠ è½½è®°å¿†å¹¶ç”¨å®ƒæ¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å“åº”"""

    # è·å–ç”¨æˆ· ID
    user_id = config["configurable"]["user_id"]

    # ä» store æ£€ç´¢è®°å¿†
    namespace = ("memory", user_id)
    existing_memory = store.get(namespace, "user_memory")

    # æ ¼å¼åŒ–è®°å¿†ä¸ºç³»ç»Ÿæç¤º
    if existing_memory and existing_memory.value:
        memory_dict = existing_memory.value
        formatted_memory = (
            f"Name: {memory_dict.get('user_name', 'Unknown')}\n"
            f"Location: {memory_dict.get('user_location', 'Unknown')}\n"
            f"Interests: {', '.join(memory_dict.get('interests', []))}"
        )
    else:
        formatted_memory = None

    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†
    system_msg = MODEL_SYSTEM_MESSAGE.format(memory=formatted_memory)

    # ä½¿ç”¨è®°å¿†å’ŒèŠå¤©å†å²ç”Ÿæˆå“åº”
    response = model.invoke([
        SystemMessage(content=system_msg)
    ] + state["messages"])

    return {"messages": response}
```

**ä»£ç é€è¡Œè§£æ**ï¼š

**ç¬¬ 7-9 è¡Œ**ï¼šè·å–ç”¨æˆ· ID å’Œæ£€ç´¢è®°å¿†
```python
user_id = config["configurable"]["user_id"]
namespace = ("memory", user_id)
existing_memory = store.get(namespace, "user_memory")
```

**ç¬¬ 11-19 è¡Œ**ï¼šæ ¼å¼åŒ–è®°å¿†
```python
if existing_memory and existing_memory.value:
    memory_dict = existing_memory.value
    formatted_memory = (
        f"Name: {memory_dict.get('user_name', 'Unknown')}\n"
        f"Location: {memory_dict.get('user_location', 'Unknown')}\n"
        f"Interests: {', '.join(memory_dict.get('interests', []))}"
    )
else:
    formatted_memory = None
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ `.get()` æ–¹æ³•ï¼Ÿ**
```python
memory_dict.get('user_name', 'Unknown')
# å¦‚æœ 'user_name' é”®å­˜åœ¨ï¼Œè¿”å›å…¶å€¼
# å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›é»˜è®¤å€¼ 'Unknown'
# é¿å… KeyError
```

**æ ¼å¼åŒ–ç¤ºä¾‹**ï¼š
```python
# memory_dict = {
#     'user_name': 'Lance',
#     'user_location': 'San Francisco',
#     'interests': ['biking', 'bakeries']
# }

formatted_memory = """Name: Lance
Location: San Francisco
Interests: biking, bakeries"""
```

**ç¬¬ 21-27 è¡Œ**ï¼šç”Ÿæˆå“åº”
```python
system_msg = MODEL_SYSTEM_MESSAGE.format(memory=formatted_memory)
response = model.invoke([
    SystemMessage(content=system_msg)
] + state["messages"])
return {"messages": response}
```

### 7.5 write_memory èŠ‚ç‚¹

```python
def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):
    """åæ€èŠå¤©å†å²å¹¶ä¿å­˜è®°å¿†åˆ° store"""

    # è·å–ç”¨æˆ· ID
    user_id = config["configurable"]["user_id"]

    # ä» store æ£€ç´¢ç°æœ‰è®°å¿†
    namespace = ("memory", user_id)
    existing_memory = store.get(namespace, "user_memory")

    # è·å– Profile ä½œä¸ºå€¼ï¼Œå¹¶è½¬æ¢ä¸º Trustcall æ ¼å¼
    existing_profile = {"UserProfile": existing_memory.value} if existing_memory else None

    # è°ƒç”¨ Trustcall æå–å™¨
    result = trustcall_extractor.invoke({
        "messages": [SystemMessage(content=TRUSTCALL_INSTRUCTION)] + state["messages"],
        "existing": existing_profile
    })

    # è·å–æ›´æ–°åçš„ Profile ä½œä¸º JSON å¯¹è±¡
    updated_profile = result["responses"][0].model_dump()

    # ä¿å­˜æ›´æ–°åçš„ Profile
    key = "user_memory"
    store.put(namespace, key, updated_profile)
```

**ä»£ç é€è¡Œè§£æ**ï¼š

**ç¬¬ 11 è¡Œ**ï¼šå‡†å¤‡ç°æœ‰ Profile
```python
existing_profile = {"UserProfile": existing_memory.value} if existing_memory else None
```

**ä¸ºä»€ä¹ˆä½¿ç”¨è¿™ä¸ªæ ¼å¼ï¼Ÿ**
```python
# Trustcall æœŸæœ›çš„æ ¼å¼ï¼š
{
    "å·¥å…·åç§°": {å®é™…æ•°æ®}
}

# ç¤ºä¾‹ï¼š
{
    "UserProfile": {
        "user_name": "Lance",
        "user_location": "San Francisco",
        "interests": ["biking"]
    }
}
```

**ç¬¬ 14-18 è¡Œ**ï¼šè°ƒç”¨ Trustcall
```python
result = trustcall_extractor.invoke({
    "messages": [SystemMessage(content=TRUSTCALL_INSTRUCTION)] + state["messages"],
    "existing": existing_profile
})
```

**å‚æ•°è¯´æ˜**ï¼š
- `messages`ï¼šç³»ç»ŸæŒ‡ä»¤ + å¯¹è¯å†å²
- `existing`ï¼šç°æœ‰çš„ Profileï¼ˆå¦‚æœæœ‰ï¼‰

**ç¬¬ 21 è¡Œ**ï¼šè·å–æ›´æ–°åçš„ Profile
```python
updated_profile = result["responses"][0].model_dump()
```

- `result["responses"]` æ˜¯ Pydantic æ¨¡å‹åˆ—è¡¨
- `[0]` è·å–ç¬¬ä¸€ä¸ªï¼ˆä¹Ÿæ˜¯å”¯ä¸€çš„ï¼‰æ¨¡å‹
- `.model_dump()` è½¬æ¢ä¸ºå­—å…¸

**ç¬¬ 23-25 è¡Œ**ï¼šä¿å­˜åˆ° Store
```python
key = "user_memory"
store.put(namespace, key, updated_profile)
```

### 7.6 æ„å»ºå®Œæ•´çš„å›¾

```python
from langgraph.graph import StateGraph, START, END
from langgraph.checkpoint.memory import MemorySaver
from langgraph.store.memory import InMemoryStore

# å®šä¹‰å›¾
builder = StateGraph(MessagesState)
builder.add_node("call_model", call_model)
builder.add_node("write_memory", write_memory)
builder.add_edge(START, "call_model")
builder.add_edge("call_model", "write_memory")
builder.add_edge("write_memory", END)

# é•¿æœŸè®°å¿†ï¼ˆè·¨çº¿ç¨‹ï¼‰
across_thread_memory = InMemoryStore()

# çŸ­æœŸè®°å¿†ï¼ˆçº¿ç¨‹å†…ï¼‰
within_thread_memory = MemorySaver()

# ç¼–è¯‘å›¾
graph = builder.compile(
    checkpointer=within_thread_memory,
    store=across_thread_memory
)

# ğŸ¨ å¯è§†åŒ–å›¾ç»“æ„
from IPython.display import Image, display
display(Image(graph.get_graph().draw_mermaid_png()))
```

**å›¾ç»“æ„**ï¼š
```
START â†’ call_model â†’ write_memory â†’ END
```

---

## å…«ã€å®æˆ˜æ¼”ç¤º

### 8.1 ç¬¬ä¸€æ¬¡äº¤äº’ï¼šåˆ›å»º Profile

```python
# é…ç½®
config = {
    "configurable": {
        "thread_id": "1",
        "user_id": "1"
    }
}

# ç”¨æˆ·è¾“å…¥
input_messages = [HumanMessage(content="Hi, my name is Lance")]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š
```
================================ Human Message =================================
Hi, my name is Lance

================================== Ai Message ==================================
Hello, Lance! It's nice to meet you. How can I assist you today?
```

**å¹•åå‘ç”Ÿäº†ä»€ä¹ˆ**ï¼š
1. `call_model`ï¼šæ²¡æœ‰æ‰¾åˆ°è®°å¿†ï¼Œä½¿ç”¨é»˜è®¤å“åº”
2. `write_memory`ï¼šTrustcall æå–äº†åå­—å¹¶åˆ›å»º Profile

### 8.2 ç¬¬äºŒæ¬¡äº¤äº’ï¼šæ›´æ–° Profile

```python
# ç”¨æˆ·è¾“å…¥
input_messages = [HumanMessage(content="I like to bike around San Francisco")]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š
```
================================ Human Message =================================
I like to bike around San Francisco

================================== Ai Message ==================================
That sounds like a great way to explore the city! San Francisco has some
beautiful routes and views. Do you have any favorite trails or spots you like
to visit while biking?
```

**åˆ†æ**ï¼š
- AI æ²¡æœ‰æ˜ç¡®æåˆ°ç”¨æˆ·çš„åå­—ï¼ˆå› ä¸ºä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰å¿…è¦ï¼‰
- ä½†è®°å¿†å·²ç»è¢«æ›´æ–°

### 8.3 æŸ¥çœ‹ Profile

```python
# è·å–è®°å¿†
user_id = "1"
namespace = ("memory", user_id)
existing_memory = across_thread_memory.get(namespace, "user_memory")

print(existing_memory.dict())
```

**è¾“å‡º**ï¼š
```python
{
    'value': {
        'user_name': 'Lance',
        'user_location': 'San Francisco',
        'interests': ['biking']
    },
    'key': 'user_memory',
    'namespace': ['memory', '1'],
    'created_at': '2024-11-04T23:51:17.662428+00:00',
    'updated_at': '2024-11-04T23:51:41.697652+00:00'
}
```

**å…³é”®è§‚å¯Ÿ**ï¼š
- `user_name`ï¼šä»ç¬¬ä¸€æ¬¡å¯¹è¯ä¸­æå–
- `user_location`ï¼šä»ç¬¬äºŒæ¬¡å¯¹è¯ä¸­æ¨æ–­ï¼ˆ"around San Francisco"ï¼‰
- `interests`ï¼šä»ç¬¬äºŒæ¬¡å¯¹è¯ä¸­æå–
- `updated_at` æ›´æ–°äº†æ—¶é—´æˆ³

### 8.4 ç»§ç»­æ›´æ–° Profile

```python
# ç”¨æˆ·è¾“å…¥
input_messages = [HumanMessage(content="I also enjoy going to bakeries")]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š
```
================================ Human Message =================================
I also enjoy going to bakeries

================================== Ai Message ==================================
Biking and visiting bakeries sounds like a delightful combination! San Francisco
has some fantastic bakeries. Do you have any favorites, or are you looking for
new recommendations to try out?
```

**æŸ¥çœ‹æ›´æ–°åçš„ Profile**ï¼š
```python
existing_memory = across_thread_memory.get(namespace, "user_memory")
print(existing_memory.value)
```

**è¾“å‡º**ï¼š
```python
{
    'user_name': 'Lance',
    'user_location': 'San Francisco',
    'interests': ['biking', 'bakeries']  # æ–°å¢äº† 'bakeries'
}
```

**Trustcall çš„æ™ºèƒ½æ›´æ–°**ï¼š
- âœ… ä¿ç•™äº† `user_name` å’Œ `user_location`
- âœ… åªæ›´æ–°äº† `interests` åˆ—è¡¨
- âœ… é¿å…äº†é‡æ–°ç”Ÿæˆæ•´ä¸ª Profile

### 8.5 è·¨ä¼šè¯æµ‹è¯•

```python
# æ–°çš„çº¿ç¨‹ï¼Œç›¸åŒçš„ç”¨æˆ·
config = {
    "configurable": {
        "thread_id": "2",  # æ–°ä¼šè¯
        "user_id": "1"     # ç›¸åŒç”¨æˆ·
    }
}

# ç”¨æˆ·è¾“å…¥
input_messages = [HumanMessage(content="What bakeries do you recommend for me?")]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š
```
================================ Human Message =================================
What bakeries do you recommend for me?

================================== Ai Message ==================================
Since you're in San Francisco and enjoy going to bakeries, here are a few
recommendations you might like:

1. **Tartine Bakery** - Known for its delicious bread and pastries, it's a
   must-visit for any bakery enthusiast.
2. **B. Patisserie** - Offers a delightful selection of French pastries,
   including their famous kouign-amann.
3. **Arsicault Bakery** - Renowned for its croissants, which have been praised
   as some of the best in the country.
4. **Craftsman and Wolves** - Known for their inventive pastries and the "Rebel
   Within," a savory muffin with a soft-cooked egg inside.
5. **Mr. Holmes Bakehouse** - Famous for their cruffins and other creative pastries.

These spots should offer a great variety of treats for you to enjoy. Happy bakery hopping!
```

**é•¿æœŸè®°å¿†çš„å¨åŠ›**ï¼š
1. âœ… æ–°ä¼šè¯ï¼Œä½†è®°å¾—ç”¨æˆ·ä¿¡æ¯
2. âœ… "Since you're in San Francisco"ï¼ˆè®°å¾—ä½ç½®ï¼‰
3. âœ… "enjoy going to bakeries"ï¼ˆè®°å¾—å…´è¶£ï¼‰
4. âœ… æä¾›äº†ä¸ªæ€§åŒ–çš„æœ¬åœ°å»ºè®®

---

## ä¹ã€Trustcall çš„é«˜çº§ç‰¹æ€§

### 9.1 å¤š Schema æ”¯æŒ

Trustcall å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ª Schemaï¼š

```python
class UserProfile(BaseModel):
    user_name: str
    interests: List[str]

class UserPreferences(BaseModel):
    language: str
    notification_enabled: bool

# åˆ›å»ºæ”¯æŒå¤šä¸ª Schema çš„æå–å™¨
multi_extractor = create_extractor(
    model,
    tools=[UserProfile, UserPreferences],  # å¤šä¸ª Schema
    # ä¸æŒ‡å®š tool_choiceï¼Œè®©æ¨¡å‹é€‰æ‹©
)
```

### 9.2 è‡ªåŠ¨é”™è¯¯ä¿®æ­£

Trustcall å†…ç½®äº†è‡ªåŠ¨é”™è¯¯ä¿®æ­£æœºåˆ¶ã€‚å½“æ¨¡å‹ç”Ÿæˆçš„è¾“å‡ºä¸ç¬¦åˆ Schema æ—¶ï¼š

1. **æ•è·éªŒè¯é”™è¯¯**
2. **åˆ†æé”™è¯¯åŸå› **
3. **ç”Ÿæˆä¿®æ­£æç¤º**
4. **é‡æ–°è°ƒç”¨æ¨¡å‹**
5. **åº”ç”¨ä¿®æ­£**

æŸ¥çœ‹ [LangSmith è¿½è¸ªç¤ºä¾‹](https://smith.langchain.com/public/5cd23009-3e05-4b00-99f0-c66ee3edd06e/r) å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¿‡ç¨‹ã€‚

### 9.3 enable_inserts å‚æ•°

```python
trustcall_extractor = create_extractor(
    model,
    tools=[ToDo],
    tool_choice="ToDo",
    enable_inserts=True  # å…è®¸æ’å…¥æ–°é¡¹ç›®
)
```

**ç”¨é€”**ï¼š
- å½“ Schema æ˜¯é›†åˆï¼ˆå¦‚ ToDo åˆ—è¡¨ï¼‰æ—¶
- å…è®¸æ·»åŠ æ–°çš„ç‹¬ç«‹é¡¹ç›®
- è€Œä¸æ˜¯åªæ›´æ–°å•ä¸€å¯¹è±¡

**ç¤ºä¾‹**ï¼š
```python
# æ²¡æœ‰ enable_insertsï¼šæ›´æ–°ç°æœ‰çš„å•ä¸€ Profile
# æœ‰ enable_insertsï¼šå¯ä»¥æ·»åŠ å¤šä¸ª ToDo é¡¹
```

### 9.4 å¹¶è¡Œå·¥å…·è°ƒç”¨

Trustcall æ”¯æŒå¹¶è¡Œè°ƒç”¨å¤šä¸ªå·¥å…·ï¼š

```python
# ç³»ç»ŸæŒ‡ä»¤ä¸­æç¤ºå¹¶è¡Œå¤„ç†
instruction = """Use parallel tool calling to handle updates and insertions simultaneously."""

# Trustcall ä¼šè‡ªåŠ¨ï¼š
# 1. è¯†åˆ«éœ€è¦æ›´æ–°çš„ç°æœ‰é¡¹
# 2. è¯†åˆ«éœ€è¦åˆ›å»ºçš„æ–°é¡¹
# 3. å¹¶è¡Œæ‰§è¡Œè¿™äº›æ“ä½œ
```

---

## åã€è®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µ

### 10.1 ä½•æ—¶ä½¿ç”¨ with_structured_outputï¼Ÿ

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… ç®€å•çš„ Schemaï¼ˆ2-3 å±‚åµŒå¥—ï¼‰
- âœ… åˆ›å»ºæ–°å¯¹è±¡ï¼ˆä¸éœ€è¦æ›´æ–°ï¼‰
- âœ… æ¯æ¬¡ç”Ÿæˆçš„æ•°æ®é‡è¾ƒå°
- âœ… ä¸æ‹…å¿ƒä¿¡æ¯ä¸¢å¤±

**ç¤ºä¾‹**ï¼š
```python
class SimpleProfile(BaseModel):
    name: str
    age: int

model_with_structure = model.with_structured_output(SimpleProfile)
```

### 10.2 ä½•æ—¶ä½¿ç”¨ Trustcallï¼Ÿ

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å¤æ‚çš„åµŒå¥— Schema
- âœ… éœ€è¦æ›´æ–°ç°æœ‰æ•°æ®
- âœ… å…³æ³¨ Token æ•ˆç‡
- âœ… éœ€è¦ä¿ç•™ç°æœ‰ä¿¡æ¯
- âœ… éœ€è¦è‡ªåŠ¨é”™è¯¯ä¿®æ­£

**ç¤ºä¾‹**ï¼š
```python
trustcall_extractor = create_extractor(
    model,
    tools=[ComplexProfile],
    tool_choice="ComplexProfile"
)
```

### 10.3 Profile Schema è®¾è®¡åŸåˆ™

**1. å­—æ®µå‘½å**ï¼š
```python
# å¥½çš„å‘½å
user_name: str          # æ¸…æ™°ã€å…·ä½“
user_location: str      # æè¿°æ€§å¼º
interests: List[str]    # å¤æ•°å½¢å¼è¡¨ç¤ºåˆ—è¡¨

# ä¸å¥½çš„å‘½å
name: str               # å¤ªé€šç”¨
loc: str                # ç¼©å†™ä¸æ¸…æ™°
interest: str           # å•æ•°ä½†å®é™…æ˜¯åˆ—è¡¨
```

**2. å­—æ®µæè¿°**ï¼š
```python
# å¥½çš„æè¿°
user_name: str = Field(description="The user's preferred name or nickname")

# ä¸å¥½çš„æè¿°
user_name: str = Field(description="name")  # æ²¡æœ‰é¢å¤–ä¿¡æ¯
```

**3. é»˜è®¤å€¼**ï¼š
```python
# åˆç†ä½¿ç”¨é»˜è®¤å€¼
interests: List[str] = Field(default_factory=list)  # ç©ºåˆ—è¡¨
language: str = Field(default="en")                # é»˜è®¤è¯­è¨€

# é¿å…
required_field: str = Field(default="")  # å¿…éœ€å­—æ®µä¸åº”æœ‰ç©ºé»˜è®¤å€¼
```

**4. å¯é€‰å­—æ®µ**ï¼š
```python
from typing import Optional

# çœŸæ­£å¯é€‰çš„å­—æ®µ
middle_name: Optional[str] = None
bio: Optional[str] = None

# é¿å…è¿‡åº¦ä½¿ç”¨ Optional
# å¦‚æœå­—æ®µé€šå¸¸éƒ½æœ‰å€¼ï¼Œä¸è¦è®¾ä¸º Optional
```

### 10.4 æ›´æ–°ç­–ç•¥é€‰æ‹©

| åœºæ™¯ | æ¨èç­–ç•¥ | åŸå›  |
|------|---------|------|
| å•ä¸€ Profile | Trustcall å¢é‡æ›´æ–° | ä¿ç•™ä¿¡æ¯ï¼Œé«˜æ•ˆ |
| é›†åˆæ•°æ®ï¼ˆå¤šé¡¹ï¼‰ | Trustcall with enable_inserts | å¯ä»¥æ·»åŠ æ–°é¡¹ |
| ç®€å•ä¸´æ—¶æ•°æ® | å®Œå…¨é‡æ–°ç”Ÿæˆ | ç®€å•ï¼Œæ•°æ®é‡å° |
| é¢‘ç¹æ›´æ–° | Trustcall | èŠ‚çœ Token |
| å¶å°”æ›´æ–° | ä»»æ„æ–¹å¼ | å½±å“ä¸å¤§ |

### 10.5 é”™è¯¯å¤„ç†

```python
def write_memory_with_error_handling(state, config, store):
    try:
        # å°è¯•è°ƒç”¨ Trustcall
        result = trustcall_extractor.invoke({
            "messages": [...],
            "existing": existing_profile
        })

        # ä¿å­˜ç»“æœ
        updated_profile = result["responses"][0].model_dump()
        store.put(namespace, key, updated_profile)

    except Exception as e:
        # è®°å½•é”™è¯¯
        print(f"Error updating profile: {e}")

        # é™çº§æ–¹æ¡ˆï¼šä¿æŒç°æœ‰è®°å¿†ä¸å˜
        # æˆ–è€…ä½¿ç”¨ç®€å•çš„æ–¹å¼é‡æ–°ç”Ÿæˆ
        pass
```

---

## åä¸€ã€Python çŸ¥è¯†ç‚¹æ·±å…¥

### 11.1 Pydantic Field çš„é«˜çº§ç”¨æ³•

```python
from pydantic import BaseModel, Field, validator
from typing import List

class UserProfile(BaseModel):
    user_name: str = Field(
        description="ç”¨æˆ·å",
        min_length=1,           # æœ€å°é•¿åº¦
        max_length=50,          # æœ€å¤§é•¿åº¦
        pattern=r"^[a-zA-Z\s]+$"  # æ­£åˆ™è¡¨è¾¾å¼éªŒè¯
    )

    age: int = Field(
        description="å¹´é¾„",
        ge=0,                   # å¤§äºç­‰äº 0
        le=150                  # å°äºç­‰äº 150
    )

    interests: List[str] = Field(
        description="å…´è¶£",
        min_items=0,            # æœ€å°‘é¡¹ç›®æ•°
        max_items=20,           # æœ€å¤šé¡¹ç›®æ•°
        default_factory=list
    )

    # è‡ªå®šä¹‰éªŒè¯å™¨
    @validator('user_name')
    def name_must_not_be_empty(cls, v):
        if not v.strip():
            raise ValueError('åå­—ä¸èƒ½ä¸ºç©º')
        return v.title()  # é¦–å­—æ¯å¤§å†™
```

### 11.2 ç±»å‹æ³¨è§£çš„å®Œæ•´è¯­æ³•

```python
from typing import (
    List,           # åˆ—è¡¨
    Dict,           # å­—å…¸
    Set,            # é›†åˆ
    Tuple,          # å…ƒç»„
    Optional,       # å¯é€‰ï¼ˆå¯ä»¥æ˜¯ Noneï¼‰
    Union,          # è”åˆç±»å‹ï¼ˆå¤šé€‰ä¸€ï¼‰
    Literal,        # å­—é¢é‡ï¼ˆå›ºå®šçš„å‡ ä¸ªå€¼ï¼‰
    Any,            # ä»»æ„ç±»å‹
)

# åŸºç¡€ç±»å‹
name: str
age: int
height: float
is_active: bool

# å®¹å™¨ç±»å‹
interests: List[str]                    # å­—ç¬¦ä¸²åˆ—è¡¨
scores: Dict[str, int]                  # å­—ç¬¦ä¸²åˆ°æ•´æ•°çš„å­—å…¸
tags: Set[str]                          # å­—ç¬¦ä¸²é›†åˆ
coordinates: Tuple[float, float]        # ä¸¤ä¸ªæµ®ç‚¹æ•°çš„å…ƒç»„

# å¯é€‰ç±»å‹
middle_name: Optional[str]              # str æˆ– None
# ç­‰ä»·äº
middle_name: Union[str, None]

# è”åˆç±»å‹
id: Union[int, str]                     # int æˆ– str

# å­—é¢é‡ç±»å‹
status: Literal["active", "inactive"]   # åªèƒ½æ˜¯è¿™ä¸¤ä¸ªå€¼ä¹‹ä¸€

# åµŒå¥—ç±»å‹
matrix: List[List[int]]                 # æ•´æ•°çŸ©é˜µ
user_data: Dict[str, Union[str, int]]   # æ··åˆç±»å‹å­—å…¸
```

### 11.3 æ¨¡å‹çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–

```python
from pydantic import BaseModel

class UserProfile(BaseModel):
    user_name: str
    interests: List[str]

# åˆ›å»ºå®ä¾‹
profile = UserProfile(user_name="Lance", interests=["biking"])

# åºåˆ—åŒ–ä¸ºå­—å…¸
dict_data = profile.model_dump()
# {'user_name': 'Lance', 'interests': ['biking']}

# åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²
json_str = profile.model_dump_json()
# '{"user_name":"Lance","interests":["biking"]}'

# ä»å­—å…¸ååºåˆ—åŒ–
profile2 = UserProfile(**dict_data)

# ä» JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–
profile3 = UserProfile.model_validate_json(json_str)
```

**Python çŸ¥è¯†ç‚¹**ï¼š

**`**` æ“ä½œç¬¦ï¼ˆå­—å…¸è§£åŒ…ï¼‰**ï¼š
```python
dict_data = {'user_name': 'Lance', 'interests': ['biking']}

# ä½¿ç”¨ **
UserProfile(**dict_data)
# ç­‰ä»·äº
UserProfile(user_name='Lance', interests=['biking'])
```

### 11.4 åˆ—è¡¨æ¨å¯¼å¼å’Œå­—å…¸æ¨å¯¼å¼

```python
# åˆ—è¡¨æ¨å¯¼å¼
interests = ['biking', 'coffee', 'coding']
uppercase = [item.upper() for item in interests]
# ['BIKING', 'COFFEE', 'CODING']

# å¸¦æ¡ä»¶çš„åˆ—è¡¨æ¨å¯¼å¼
long_interests = [item for item in interests if len(item) > 5]
# ['biking', 'coffee', 'coding']

# å­—å…¸æ¨å¯¼å¼
interest_lengths = {item: len(item) for item in interests}
# {'biking': 6, 'coffee': 6, 'coding': 6}

# åµŒå¥—æ¨å¯¼å¼
matrix = [[i*j for j in range(3)] for i in range(3)]
# [[0, 0, 0], [0, 1, 2], [0, 2, 4]]
```

---

## åäºŒã€ä¸å‰é¢ç« èŠ‚çš„å¯¹æ¯”æ€»ç»“

### 12.1 è®°å¿†æ ¼å¼çš„æ¼”è¿›

| ç« èŠ‚ | è®°å¿†æ ¼å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| **5.2** | è‡ªç”±æ–‡æœ¬ | çµæ´»ã€ç®€å• | éš¾ä»¥æŸ¥è¯¢ã€æ˜“ä¸¢å¤±ä¿¡æ¯ |
| **5.3 (TypedDict)** | ç»“æ„åŒ–å­—å…¸ | æœ‰ç±»å‹æç¤º | æ— è¿è¡Œæ—¶éªŒè¯ |
| **5.3 (Pydantic)** | ä¸¥æ ¼ Schema | å®Œæ•´éªŒè¯ã€æ–‡æ¡£åŒ– | è®¾ç½®ç¨å¤æ‚ |

### 12.2 æ›´æ–°ç­–ç•¥çš„æ¼”è¿›

| ç« èŠ‚ | æ›´æ–°æ–¹å¼ | Token æ•ˆç‡ | ä¿¡æ¯ä¿ç•™ |
|------|---------|-----------|---------|
| **5.2** | LLM é‡æ–°ç”Ÿæˆå…¨æ–‡ | âŒ ä½ | âš ï¸ å¯èƒ½ä¸¢å¤± |
| **5.3 (basic)** | with_structured_output | âš ï¸ ä¸­ç­‰ | âš ï¸ å¯èƒ½ä¸¢å¤± |
| **5.3 (Trustcall)** | JSON Patch å¢é‡æ›´æ–° | âœ… é«˜ | âœ… ä¿è¯ä¿ç•™ |

### 12.3 å¤æ‚åº¦å¯¹æ¯”

```
5.2: Store â†’ è‡ªç”±æ–‡æœ¬
     ç®€å• â˜…â˜†â˜†â˜†â˜†

5.3 (basic): Store â†’ with_structured_output â†’ Schema
             ä¸­ç­‰ â˜…â˜…â˜…â˜†â˜†

5.3 (Trustcall): Store â†’ Trustcall â†’ å¤æ‚åµŒå¥— Schema
                 å¤æ‚ â˜…â˜…â˜…â˜…â˜†
```

### 12.4 å­¦ä¹ è·¯å¾„å»ºè®®

```
1. æŒæ¡ 5.2ï¼ˆåŸºç¡€ï¼‰
   â†“
   ç†è§£ Store çš„åŸºæœ¬æ¦‚å¿µ
   â†“
2. å­¦ä¹  5.3 åŸºç¡€éƒ¨åˆ†
   â†“
   ç†è§£ç»“æ„åŒ–æ•°æ®çš„ä¼˜åŠ¿
   â†“
3. æŒæ¡ with_structured_output
   â†“
   å¤„ç†ç®€å• Schema
   â†“
4. å­¦ä¹  Trustcall
   â†“
   å¤„ç†å¤æ‚ Schema å’Œæ›´æ–°
```

---

## åä¸‰ã€æ‰©å±•æ€è€ƒå’Œæœªæ¥æ–¹å‘

### 13.1 Schema çš„ç‰ˆæœ¬ç®¡ç†

å½“ Schema éœ€è¦æ¼”è¿›æ—¶ï¼š

```python
# V1
class UserProfileV1(BaseModel):
    user_name: str
    interests: List[str]

# V2 - æ·»åŠ æ–°å­—æ®µ
class UserProfileV2(BaseModel):
    user_name: str
    interests: List[str]
    user_location: str = Field(default="Unknown")  # æ–°å­—æ®µæœ‰é»˜è®¤å€¼
    created_at: datetime = Field(default_factory=datetime.now)

# è¿ç§»å‡½æ•°
def migrate_v1_to_v2(v1_data: dict) -> dict:
    return {
        **v1_data,
        "user_location": "Unknown",
        "created_at": datetime.now().isoformat()
    }
```

### 13.2 å¤šç”¨æˆ·éš”ç¦»

ç¡®ä¿ç”¨æˆ·æ•°æ®éš”ç¦»ï¼š

```python
def get_user_namespace(user_id: str, data_type: str) -> tuple:
    """ç”Ÿæˆç”¨æˆ·ç‰¹å®šçš„å‘½åç©ºé—´"""
    return ("user", user_id, data_type)

# ä½¿ç”¨
profile_ns = get_user_namespace("user_123", "profile")
# ("user", "user_123", "profile")

todos_ns = get_user_namespace("user_123", "todos")
# ("user", "user_123", "todos")
```

### 13.3 æ•°æ®å¯¼å‡ºå’Œå¤‡ä»½

```python
def export_user_data(store: BaseStore, user_id: str) -> dict:
    """å¯¼å‡ºç”¨æˆ·çš„æ‰€æœ‰æ•°æ®"""
    data = {}

    # å¯¼å‡º Profile
    profile = store.get(("memory", user_id), "user_memory")
    if profile:
        data["profile"] = profile.value

    # å¯¼å‡ºå…¶ä»–æ•°æ®...

    return data

def import_user_data(store: BaseStore, user_id: str, data: dict):
    """å¯¼å…¥ç”¨æˆ·æ•°æ®"""
    if "profile" in data:
        store.put(("memory", user_id), "user_memory", data["profile"])

    # å¯¼å…¥å…¶ä»–æ•°æ®...
```

### 13.4 æœç´¢å’ŒæŸ¥è¯¢ä¼˜åŒ–

```python
def search_users_by_interest(store: BaseStore, interest: str) -> List[str]:
    """æŸ¥æ‰¾æœ‰ç‰¹å®šå…´è¶£çš„ç”¨æˆ·"""
    matching_users = []

    # è¿™éœ€è¦æ‰«ææ‰€æœ‰ç”¨æˆ·ï¼ˆæ•ˆç‡è¾ƒä½ï¼‰
    # åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè€ƒè™‘ä½¿ç”¨ä¸“é—¨çš„æœç´¢å¼•æ“

    # ä¼ªä»£ç 
    for user_id in all_user_ids:
        profile = store.get(("memory", user_id), "user_memory")
        if profile and interest in profile.value.get("interests", []):
            matching_users.append(user_id)

    return matching_users
```

---

## åå››ã€æ€»ç»“

### 14.1 æ ¸å¿ƒè¦ç‚¹

1. **ç»“æ„åŒ–è®°å¿†ä¼˜äºè‡ªç”±æ–‡æœ¬**
   - æ˜ç¡®çš„æ•°æ®ç»“æ„
   - ç±»å‹éªŒè¯
   - æ˜“äºæŸ¥è¯¢å’Œå¤„ç†

2. **Pydantic æ˜¯é¦–é€‰çš„ Schema å®šä¹‰æ–¹å¼**
   - è¿è¡Œæ—¶éªŒè¯
   - ä¸°å¯Œçš„åŠŸèƒ½
   - ä¸ LangChain ç”Ÿæ€ç³»ç»Ÿé›†æˆ

3. **with_structured_output é€‚åˆç®€å•åœºæ™¯**
   - åˆ›å»ºæ–° Schema
   - ç®€å•çš„æ•°æ®ç»“æ„
   - å¿«é€Ÿå¼€å§‹

4. **Trustcall æ˜¯å¤æ‚åœºæ™¯çš„åˆ©å™¨**
   - å¤æ‚åµŒå¥— Schema
   - å¢é‡æ›´æ–°
   - è‡ªåŠ¨é”™è¯¯ä¿®æ­£

5. **å¢é‡æ›´æ–°ä¼˜äºå®Œå…¨é‡æ–°ç”Ÿæˆ**
   - èŠ‚çœ Token
   - ä¿ç•™ä¿¡æ¯
   - æ›´ç²¾ç¡®çš„æ§åˆ¶

### 14.2 å­¦åˆ°çš„æŠ€èƒ½

**Python æŠ€èƒ½**ï¼š
- TypedDict å’Œ Pydantic çš„ä½¿ç”¨
- ç±»å‹æ³¨è§£çš„å®Œæ•´è¯­æ³•
- Field éªŒè¯å’Œè‡ªå®šä¹‰éªŒè¯å™¨
- æ¨¡å‹åºåˆ—åŒ–å’Œååºåˆ—åŒ–
- å­—å…¸è§£åŒ…å’Œåˆ—è¡¨æ¨å¯¼å¼

**LangChain æŠ€èƒ½**ï¼š
- with_structured_output() æ–¹æ³•
- ç»“æ„åŒ–è¾“å‡ºçš„ç”Ÿæˆ
- Schema ä¸ LLM çš„é›†æˆ

**Trustcall æŠ€èƒ½**ï¼š
- create_extractor çš„ä½¿ç”¨
- JSON Patch æœºåˆ¶ç†è§£
- å¤æ‚ Schema çš„å¤„ç†
- å¢é‡æ›´æ–°ç­–ç•¥

**ç³»ç»Ÿè®¾è®¡**ï¼š
- Profile Schema è®¾è®¡åŸåˆ™
- æ›´æ–°ç­–ç•¥é€‰æ‹©
- é”™è¯¯å¤„ç†å’Œé™çº§æ–¹æ¡ˆ
- æ•°æ®ç‰ˆæœ¬ç®¡ç†

### 14.3 å®è·µå»ºè®®

**å¼€å§‹å°é¡¹ç›®**ï¼š
1. ä»ç®€å•çš„ TypedDict å¼€å§‹
2. è¿ç§»åˆ° Pydantic
3. é›†æˆ with_structured_output
4. åœ¨éœ€è¦æ—¶å¼•å…¥ Trustcall

**å…³æ³¨ç‚¹**ï¼š
- æ•°æ®éªŒè¯
- é”™è¯¯å¤„ç†
- Token æ•ˆç‡
- ç”¨æˆ·ä½“éªŒ

**æµ‹è¯•**ï¼š
- æµ‹è¯• Schema éªŒè¯
- æµ‹è¯•æ›´æ–°é€»è¾‘
- æµ‹è¯•è¾¹ç•Œæƒ…å†µ
- æ€§èƒ½æµ‹è¯•

### 14.4 ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  Module-5 çš„å…¶ä»–éƒ¨åˆ†ï¼š
1. **5.4 Memory Schema - Collection**ï¼š
   - ç®¡ç†å¤šä¸ªè®°å¿†é¡¹
   - Collection çš„å¢åˆ æ”¹æŸ¥
   - ä¸ Profile çš„åŒºåˆ«

2. **é«˜çº§ä¸»é¢˜**ï¼š
   - è®°å¿†çš„ä¼˜å…ˆçº§å’Œé‡è¦æ€§
   - è®°å¿†çš„æ£€ç´¢å’Œæ’åº
   - å¤§è§„æ¨¡è®°å¿†ç®¡ç†

3. **ç”Ÿäº§å®è·µ**ï¼š
   - æŒä¹…åŒ–å­˜å‚¨ï¼ˆæ•°æ®åº“ï¼‰
   - ç¼“å­˜ç­–ç•¥
   - ç›‘æ§å’Œæ—¥å¿—
   - å®‰å…¨æ€§è€ƒè™‘

---

## åäº”ã€é™„å½•

### A.1 å®Œæ•´ä»£ç æ¸…å•

```python
# å¯¼å…¥ä¾èµ–
from IPython.display import Image, display
from langgraph.checkpoint.memory import MemorySaver
from langgraph.graph import StateGraph, MessagesState, START, END
from langgraph.store.base import BaseStore
from langgraph.store.memory import InMemoryStore
from langchain_core.messages import HumanMessage, SystemMessage
from langchain_core.runnables.config import RunnableConfig
from langchain_openai import ChatOpenAI
from trustcall import create_extractor
from pydantic import BaseModel, Field
from typing import List

# å®šä¹‰ Schema
class UserProfile(BaseModel):
    """ç”¨æˆ·èµ„æ–™"""
    user_name: str = Field(description="ç”¨æˆ·çš„é¦–é€‰åç§°")
    user_location: str = Field(description="ç”¨æˆ·çš„ä½ç½®")
    interests: List[str] = Field(description="ç”¨æˆ·çš„å…´è¶£åˆ—è¡¨")

# åˆå§‹åŒ–æ¨¡å‹
model = ChatOpenAI(model="gpt-5-nano", temperature=0)

# åˆ›å»º Trustcall æå–å™¨
trustcall_extractor = create_extractor(
    model,
    tools=[UserProfile],
    tool_choice="UserProfile",
)

# ç³»ç»Ÿæç¤ºè¯
MODEL_SYSTEM_MESSAGE = """You are a helpful assistant with memory that provides information about the user.
If you have memory for this user, use it to personalize your responses.
Here is the memory (it may be empty): {memory}"""

TRUSTCALL_INSTRUCTION = """Create or update the memory (JSON doc) to incorporate information from the following conversation:"""

# å®šä¹‰èŠ‚ç‚¹
def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):
    user_id = config["configurable"]["user_id"]
    namespace = ("memory", user_id)
    existing_memory = store.get(namespace, "user_memory")

    if existing_memory and existing_memory.value:
        memory_dict = existing_memory.value
        formatted_memory = (
            f"Name: {memory_dict.get('user_name', 'Unknown')}\n"
            f"Location: {memory_dict.get('user_location', 'Unknown')}\n"
            f"Interests: {', '.join(memory_dict.get('interests', []))}"
        )
    else:
        formatted_memory = None

    system_msg = MODEL_SYSTEM_MESSAGE.format(memory=formatted_memory)
    response = model.invoke([SystemMessage(content=system_msg)] + state["messages"])
    return {"messages": response}

def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):
    user_id = config["configurable"]["user_id"]
    namespace = ("memory", user_id)
    existing_memory = store.get(namespace, "user_memory")

    existing_profile = {"UserProfile": existing_memory.value} if existing_memory else None

    result = trustcall_extractor.invoke({
        "messages": [SystemMessage(content=TRUSTCALL_INSTRUCTION)] + state["messages"],
        "existing": existing_profile
    })

    updated_profile = result["responses"][0].model_dump()
    key = "user_memory"
    store.put(namespace, key, updated_profile)

# æ„å»ºå›¾
builder = StateGraph(MessagesState)
builder.add_node("call_model", call_model)
builder.add_node("write_memory", write_memory)
builder.add_edge(START, "call_model")
builder.add_edge("call_model", "write_memory")
builder.add_edge("write_memory", END)

# ç¼–è¯‘å›¾
across_thread_memory = InMemoryStore()
within_thread_memory = MemorySaver()
graph = builder.compile(
    checkpointer=within_thread_memory,
    store=across_thread_memory
)

# ä½¿ç”¨ç¤ºä¾‹
config = {"configurable": {"thread_id": "1", "user_id": "1"}}
input_messages = [HumanMessage(content="Hi, my name is Lance")]

for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

### A.2 Schema è®¾è®¡æ¨¡æ¿

```python
from pydantic import BaseModel, Field, validator
from typing import List, Optional
from datetime import datetime

class UserProfile(BaseModel):
    """ç”¨æˆ·èµ„æ–™ Schema æ¨¡æ¿"""

    # å¿…éœ€å­—æ®µ
    user_name: str = Field(
        description="ç”¨æˆ·çš„é¦–é€‰åç§°",
        min_length=1,
        max_length=100
    )

    # å¯é€‰å­—æ®µ
    user_location: Optional[str] = Field(
        default=None,
        description="ç”¨æˆ·çš„ä½ç½®"
    )

    # åˆ—è¡¨å­—æ®µ
    interests: List[str] = Field(
        default_factory=list,
        description="ç”¨æˆ·çš„å…´è¶£åˆ—è¡¨",
        max_items=50
    )

    # æ—¶é—´æˆ³
    created_at: datetime = Field(
        default_factory=datetime.now,
        description="åˆ›å»ºæ—¶é—´"
    )

    # è‡ªå®šä¹‰éªŒè¯
    @validator('user_name')
    def name_must_not_be_empty(cls, v):
        if not v.strip():
            raise ValueError('åå­—ä¸èƒ½ä¸ºç©ºç™½')
        return v.strip()

    # é…ç½®
    class Config:
        json_schema_extra = {
            "example": {
                "user_name": "Lance",
                "user_location": "San Francisco",
                "interests": ["biking", "bakeries"]
            }
        }
```

### A.3 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```python
# åˆ›å»º Trustcall æå–å™¨
from trustcall import create_extractor

extractor = create_extractor(
    model,
    tools=[Schema],
    tool_choice="Schema"
)

# æå–ï¼ˆåˆ›å»ºï¼‰
result = extractor.invoke({
    "messages": [...]
})

# æå–ï¼ˆæ›´æ–°ï¼‰
result = extractor.invoke(
    {"messages": [...]},
    {"existing": {"Schema": existing_data}}
)

# è·å–ç»“æœ
pydantic_obj = result["responses"][0]
dict_data = pydantic_obj.model_dump()

# ä¿å­˜åˆ° Store
store.put(namespace, key, dict_data)

# ä» Store è·å–
item = store.get(namespace, key)
data = item.value if item else None
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
**æœ€åæ›´æ–°**ï¼š2024-11-05
**ä½œè€…**ï¼šAI Assistant
**åŸºäº**ï¼šLangChain Academy Module-5 Lesson 5.3

å¸Œæœ›è¿™ä»½è¯¦ç»†è§£è¯»èƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£ç»“æ„åŒ–è®°å¿†å’Œ Trustcall çš„ä½¿ç”¨ï¼
