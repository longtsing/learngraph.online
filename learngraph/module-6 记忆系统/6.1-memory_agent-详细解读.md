# 5.1 Memory Agent - è¯¦ç»†è§£è¯»

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **Memory Agentï¼ˆè®°å¿† Agentï¼‰** | å…·å¤‡è®°å¿†èƒ½åŠ›çš„æ™ºèƒ½ä½“ï¼Œå¯è·¨ä¼šè¯ä¿å­˜å’Œè®¿é—®ç”¨æˆ·ä¿¡æ¯ã€åå¥½å’Œå†å²æ•°æ® | ä½¿ç”¨ LangGraph çš„ Store å’Œ Checkpointer å®ç°ï¼Œæ”¯æŒè¯­ä¹‰ã€æƒ…èŠ‚å’Œç¨‹åºæ€§è®°å¿† | â­â­â­â­â­ |
| **task_mAIstro** | æœ¬èŠ‚æ„å»ºçš„å¾…åŠäº‹é¡¹ç®¡ç† Agentï¼Œæ•´åˆ Profileã€ToDo Collection å’Œ Instructions | ä½¿ç”¨ ReAct æ¶æ„ã€æ¡ä»¶è·¯ç”±å’Œå¤šç±»å‹ Trustcall å·¥å…·çš„å®Œæ•´ Agent å®ç° | â­â­â­â­ |
| **ReAct æ¶æ„** | Reasoning + Acting æ¨¡å¼ï¼ŒAgent å¾ªç¯æ¨ç†å’Œæ‰§è¡Œå·¥å…·ç›´åˆ°å®Œæˆä»»åŠ¡ | èŠ‚ç‚¹æµç¨‹ï¼š`agent â†’ tools â†’ agent â†’ ...`ï¼Œé€šè¿‡ `should_continue()` åˆ¤æ–­æ˜¯å¦ç»§ç»­ | â­â­â­â­â­ |
| **UpdateMemory å·¥å…·** | Trustcall æä¾›çš„ç‰¹æ®Šå·¥å…·ç±»ï¼Œç”¨äºåœ¨ Agent ä¸­æ›´æ–°ç»“æ„åŒ–è®°å¿† | `from trustcall import UpdateMemory`ï¼Œé…ç½® Schema å’Œ enable_insertsï¼Œåœ¨å·¥å…·åˆ—è¡¨ä¸­ä½¿ç”¨ | â­â­â­â­â­ |
| **è¯­ä¹‰è®°å¿†ï¼ˆSemanticï¼‰** | å­˜å‚¨äº‹å®å’ŒçŸ¥è¯†çš„è®°å¿†ç±»å‹ï¼Œå¦‚ Profileï¼ˆç”¨æˆ·èµ„æ–™ï¼‰å’Œ ToDo Collectionï¼ˆä»»åŠ¡ï¼‰ | Pydantic æ¨¡å‹å®šä¹‰ï¼Œå¦‚ `UserProfile(name, location)` å’Œ `ToDo(task, deadline)` | â­â­â­â­â­ |
| **ç¨‹åºæ€§è®°å¿†ï¼ˆProceduralï¼‰** | å­˜å‚¨æ“ä½œæ–¹æ³•çš„è®°å¿†ç±»å‹ï¼Œå¦‚ Instructionsï¼ˆç”¨æˆ·åå¥½çš„ä»»åŠ¡åˆ›å»ºæ–¹å¼ï¼‰ | Pydantic æ¨¡å‹ï¼š`Instructions(task_creation_instructions: str)`ï¼ŒæŒ‡å¯¼ Agent è¡Œä¸º | â­â­â­â­ |
| **æƒ…èŠ‚è®°å¿†ï¼ˆEpisodicï¼‰** | å­˜å‚¨ç‰¹å®šäº‹ä»¶å’Œç»å†çš„è®°å¿†ç±»å‹ï¼Œå¦‚å¯¹è¯å†å²å’Œæ—¶é—´åºåˆ—äº‹ä»¶ | é€šè¿‡ Checkpointer ä¿å­˜å¯¹è¯å†å²ï¼Œæˆ–åœ¨ Collection ä¸­æŒ‰æ—¶é—´æˆ³å­˜å‚¨äº‹ä»¶ | â­â­â­â­ |
| **æ¡ä»¶è¾¹ï¼ˆConditional Edgesï¼‰** | æ ¹æ®çŠ¶æ€åŠ¨æ€å†³å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è¾¹ï¼Œç”¨äºå®ç°æ™ºèƒ½è·¯ç”±å’Œå†³ç­– | `add_conditional_edges(source, route_fn, edge_mapping)`ï¼Œå¦‚åˆ¤æ–­å·¥å…·è°ƒç”¨ç»“æœ | â­â­â­â­â­ |
| **should_continue()** | è·¯ç”±å‡½æ•°ï¼Œåˆ¤æ–­ Agent æ˜¯å¦åº”ç»§ç»­æ‰§è¡Œå·¥å…·è¿˜æ˜¯ç»“æŸ | æ£€æŸ¥ `state["messages"][-1].tool_calls`ï¼Œæœ‰åˆ™è¿”å› "tools"ï¼Œå¦åˆ™è¿”å› END | â­â­â­â­â­ |
| **bind_tools()** | LangChain æ–¹æ³•ï¼Œå°†å·¥å…·åˆ—è¡¨ç»‘å®šåˆ° LLMï¼Œä½¿å…¶å¯é€šè¿‡å·¥å…·è°ƒç”¨ä¸å¤–éƒ¨äº¤äº’ | `model.bind_tools([tool1, tool2, ...])`ï¼ŒLLM è¾“å‡ºåŒ…å« tool_calls å­—æ®µ | â­â­â­â­â­ |
| **ToolNode** | LangGraph é¢„æ„å»ºèŠ‚ç‚¹ï¼Œè‡ªåŠ¨æ‰§è¡Œå·¥å…·è°ƒç”¨å¹¶è¿”å›ç»“æœ | `from langgraph.prebuilt import ToolNode`ï¼Œå¤„ç† AIMessage ä¸­çš„ tool_calls | â­â­â­â­ |
| **å¤šç±»å‹è®°å¿†ååŒ** | Profileã€Collection å’Œ Instructions ä¸‰ç§è®°å¿†ç±»å‹åŒæ—¶ä½¿ç”¨ï¼Œäº’ç›¸è¡¥å…… | ä¸åŒ namespace åˆ†åˆ«å­˜å‚¨ï¼š`(user_id, "profile")`ã€`(user_id, "todos")`ã€`(user_id, "instructions")` | â­â­â­â­â­ |

---

## ä¸€ã€æ¦‚è¿°

### 1.1 æœ¬èŠ‚ç®€ä»‹

æœ¬èŠ‚æ˜¯ LangChain Academy Module-5 çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œä¸»è¦å†…å®¹æ˜¯æ„å»ºä¸€ä¸ª**å¸¦æœ‰é•¿æœŸè®°å¿†çš„æ™ºèƒ½ Agent**ã€‚è¿™ä¸ª Agent è¢«å‘½åä¸º `task_mAIstro`ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯å¸®åŠ©ç”¨æˆ·ç®¡ç†å¾…åŠäº‹é¡¹ï¼ˆToDo Listï¼‰ã€‚

ä¸ä¹‹å‰æ„å»ºçš„ç®€å•èŠå¤©æœºå™¨äººä¸åŒï¼Œ`task_mAIstro` å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **æ™ºèƒ½å†³ç­–**ï¼šå¯ä»¥è‡ªä¸»å†³å®šä½•æ—¶ä¿å­˜è®°å¿†ï¼Œè€Œä¸æ˜¯æ¯æ¬¡å¯¹è¯éƒ½ä¿å­˜
2. **å¤šç±»å‹è®°å¿†**ï¼šå¯ä»¥ç®¡ç†ä¸‰ç§ä¸åŒç±»å‹çš„è®°å¿†ï¼š
   - ç”¨æˆ·ä¸ªäººèµ„æ–™ï¼ˆProfileï¼‰- è¯­ä¹‰è®°å¿†
   - å¾…åŠäº‹é¡¹åˆ—è¡¨ï¼ˆToDo Collectionï¼‰- è¯­ä¹‰è®°å¿†
   - ç”¨æˆ·åå¥½è®¾ç½®ï¼ˆInstructionsï¼‰- ç¨‹åºæ€§è®°å¿†
3. **è·¨ä¼šè¯è®°å¿†**ï¼šè®°å¿†å¯ä»¥åœ¨ä¸åŒçš„å¯¹è¯ä¼šè¯ä¸­æŒä¹…ä¿å­˜å’Œè®¿é—®

### 1.2 å­¦ä¹ ç›®æ ‡

é€šè¿‡å­¦ä¹ æœ¬èŠ‚å†…å®¹ï¼Œä½ å°†æŒæ¡ï¼š

1. å¦‚ä½•ä½¿ç”¨ **Trustcall** åº“æ¥ç®¡ç†å’Œæ›´æ–°ç»“æ„åŒ–æ•°æ®
2. å¦‚ä½•ç›‘æ§å’Œè¿½è¸ª Trustcall çš„å·¥å…·è°ƒç”¨è¿‡ç¨‹
3. å¦‚ä½•æ„å»ºä¸€ä¸ª **ReAct æ¶æ„**çš„ Agent
4. å¦‚ä½•åœ¨ LangGraph ä¸­å®ç°**çŸ­æœŸè®°å¿†**å’Œ**é•¿æœŸè®°å¿†**
5. å¦‚ä½•ä½¿ç”¨ **æ¡ä»¶è¾¹ï¼ˆConditional Edgesï¼‰** å®ç°æ™ºèƒ½è·¯ç”±
6. Pydantic æ¨¡å‹çš„é«˜çº§ç”¨æ³•

### 1.3 ä¸å‰é¢å†…å®¹çš„è”ç³»

åœ¨ Module-5 ä¹‹å‰çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ï¼š
- å¦‚ä½•åˆ›å»ºä¿å­˜å•ä¸€ç±»å‹è®°å¿†ï¼ˆProfile æˆ– Collectionï¼‰çš„èŠå¤©æœºå™¨äºº
- å¦‚ä½•ä½¿ç”¨ Trustcall æ¥æ›´æ–°ç»“æ„åŒ–æ•°æ®æ¨¡å¼

æœ¬èŠ‚å°†è¿™äº›çŸ¥è¯†æ•´åˆèµ·æ¥ï¼Œæ„å»ºä¸€ä¸ªæ›´åŠ å®Œæ•´å’Œå®ç”¨çš„ Agent ç³»ç»Ÿã€‚

---

## äºŒã€æ ¸å¿ƒæ¦‚å¿µä»‹ç»

### 2.1 ä»€ä¹ˆæ˜¯ Memory Agentï¼ˆè®°å¿† Agentï¼‰

**Agentï¼ˆæ™ºèƒ½ä½“ï¼‰** æ˜¯ä¸€ä¸ªå¯ä»¥è‡ªä¸»å†³ç­–å’Œæ‰§è¡Œä»»åŠ¡çš„ç¨‹åºã€‚å®ƒé€šå¸¸åŒ…å«ä»¥ä¸‹èƒ½åŠ›ï¼š

1. **æ„ŸçŸ¥**ï¼šæ¥æ”¶ç”¨æˆ·è¾“å…¥å’Œç¯å¢ƒä¿¡æ¯
2. **æ¨ç†**ï¼šåˆ†æä¿¡æ¯å¹¶åšå‡ºå†³ç­–
3. **è¡ŒåŠ¨**ï¼šè°ƒç”¨å·¥å…·æ‰§è¡Œå…·ä½“ä»»åŠ¡
4. **è®°å¿†**ï¼šä¿å­˜é‡è¦ä¿¡æ¯ä¾›æœªæ¥ä½¿ç”¨

**Memory Agent** å°±æ˜¯å…·å¤‡è®°å¿†èƒ½åŠ›çš„ Agentï¼Œå®ƒå¯ä»¥ï¼š
- è®°ä½ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯
- è®°ä½å†å²å¯¹è¯å†…å®¹
- è®°ä½ç”¨æˆ·çš„åå¥½è®¾ç½®
- åœ¨ä¸åŒä¼šè¯ä¸­è®¿é—®è¿™äº›è®°å¿†

### 2.2 ä¸‰ç§è®°å¿†ç±»å‹

åœ¨è®¤çŸ¥ç§‘å­¦ä¸­ï¼Œäººç±»çš„è®°å¿†å¯ä»¥åˆ†ä¸ºä¸åŒç±»å‹ã€‚æœ¬èŠ‚å®ç°äº†å…¶ä¸­ä¸¤ç§ï¼š

#### 2.2.1 è¯­ä¹‰è®°å¿†ï¼ˆSemantic Memoryï¼‰

è¯­ä¹‰è®°å¿†æ˜¯å…³äº**äº‹å®å’ŒçŸ¥è¯†**çš„è®°å¿†ã€‚åœ¨æœ¬ä¾‹ä¸­åŒ…æ‹¬ï¼š

**ç”¨æˆ· Profileï¼ˆä¸ªäººèµ„æ–™ï¼‰**ï¼š
- å§“åã€å±…ä½åœ°ã€èŒä¸š
- å®¶åº­æˆå‘˜ä¿¡æ¯
- å…´è¶£çˆ±å¥½

**ToDo Collectionï¼ˆå¾…åŠäº‹é¡¹é›†åˆï¼‰**ï¼š
- æ¯ä¸ªä»»åŠ¡çš„å…·ä½“å†…å®¹
- å®Œæˆæ—¶é—´ä¼°è®¡
- æˆªæ­¢æ—¥æœŸ
- å…·ä½“çš„è§£å†³æ–¹æ¡ˆ
- ä»»åŠ¡çŠ¶æ€

#### 2.2.2 ç¨‹åºæ€§è®°å¿†ï¼ˆProcedural Memoryï¼‰

ç¨‹åºæ€§è®°å¿†æ˜¯å…³äº**å¦‚ä½•åšæŸäº‹**çš„è®°å¿†ã€‚åœ¨æœ¬ä¾‹ä¸­æ˜¯ï¼š

**Instructionsï¼ˆæŒ‡ä»¤/åå¥½ï¼‰**ï¼š
- å¦‚ä½•åˆ›å»ºå¾…åŠäº‹é¡¹
- ç”¨æˆ·å¸Œæœ›ä»¥ä»€ä¹ˆæ–¹å¼ç»„ç»‡ä»»åŠ¡
- ç‰¹æ®Šè¦æ±‚ï¼ˆä¾‹å¦‚ï¼šåŒ…å«æœ¬åœ°å•†å®¶ä¿¡æ¯ï¼‰

#### 2.2.3 çŸ­æœŸè®°å¿† vs é•¿æœŸè®°å¿†

**çŸ­æœŸè®°å¿†ï¼ˆWithin-thread Memoryï¼‰**ï¼š
- åœ¨**å•æ¬¡ä¼šè¯**ä¸­ä¿æŒçš„è®°å¿†
- ä½¿ç”¨ `MemorySaver`ï¼ˆCheckpointerï¼‰å®ç°
- ä¿å­˜å¯¹è¯å†å²
- ä¼šè¯ç»“æŸåå¯èƒ½ä¸¢å¤±

**é•¿æœŸè®°å¿†ï¼ˆAcross-thread Memoryï¼‰**ï¼š
- åœ¨**å¤šæ¬¡ä¼šè¯**é—´æŒä¹…ä¿å­˜çš„è®°å¿†
- ä½¿ç”¨ `InMemoryStore`ï¼ˆStoreï¼‰å®ç°
- ä¿å­˜ Profileã€ToDoã€Instructions
- å¯ä»¥è·¨ä¼šè¯è®¿é—®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Memory Agent                   â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   çŸ­æœŸè®°å¿† (MemorySaver)           â”‚ â”‚
â”‚  â”‚   - å¯¹è¯å†å²                       â”‚ â”‚
â”‚  â”‚   - å½“å‰ä¼šè¯çŠ¶æ€                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   é•¿æœŸè®°å¿† (InMemoryStore)         â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚   â”‚ Profile (è¯­ä¹‰è®°å¿†)           â”‚ â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚   â”‚ ToDo Collection (è¯­ä¹‰è®°å¿†)   â”‚ â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚   â”‚ Instructions (ç¨‹åºæ€§è®°å¿†)    â”‚ â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Trustcall åº“

#### 2.3.1 ä»€ä¹ˆæ˜¯ Trustcall

Trustcall æ˜¯ä¸€ä¸ªç”¨äº**ä»éç»“æ„åŒ–å¯¹è¯ä¸­æå–ç»“æ„åŒ–æ•°æ®**çš„åº“ã€‚å®ƒå¯ä»¥ï¼š

1. å®šä¹‰æ•°æ®æ¨¡å¼ï¼ˆSchemaï¼‰ä½¿ç”¨ Pydantic
2. ä»å¯¹è¯ä¸­æå–ç¬¦åˆæ¨¡å¼çš„ä¿¡æ¯
3. è‡ªåŠ¨æ›´æ–°ç°æœ‰çš„æ•°æ®è®°å½•
4. å¤„ç†éªŒè¯é”™è¯¯å¹¶è‡ªæˆ‘ä¿®æ­£

#### 2.3.2 ä¸ºä»€ä¹ˆéœ€è¦ Trustcall

å‡è®¾ç”¨æˆ·è¯´ï¼š"æˆ‘ä½åœ¨æ—§é‡‘å±±ï¼Œå’Œå¦»å­è¿˜æœ‰ä¸€å²çš„å¥³å„¿ä¸€èµ·ç”Ÿæ´»ã€‚"

æˆ‘ä»¬éœ€è¦æŠŠè¿™æ®µè¯è½¬æ¢æˆç»“æ„åŒ–æ•°æ®ï¼š

```python
{
    "name": "Lance",
    "location": "æ—§é‡‘å±±",
    "connections": ["å¦»å­", "ä¸€å²çš„å¥³å„¿"]
}
```

Trustcall å¯ä»¥è‡ªåŠ¨å®Œæˆè¿™ä¸ªè½¬æ¢ï¼Œå¹¶ç¡®ä¿æ•°æ®ç¬¦åˆæˆ‘ä»¬å®šä¹‰çš„æ¨¡å¼ã€‚

#### 2.3.3 Trustcall çš„æ ¸å¿ƒåŠŸèƒ½

1. **åˆ›å»ºæ–°è®°å½•**ï¼šæå–ä¿¡æ¯å¹¶åˆ›å»ºæ–°çš„æ•°æ®å¯¹è±¡
2. **æ›´æ–°ç°æœ‰è®°å½•**ï¼šä½¿ç”¨ JSON Patch æ›´æ–°å·²æœ‰æ•°æ®
3. **è‡ªæˆ‘ä¿®æ­£**ï¼šå½“æ•°æ®éªŒè¯å¤±è´¥æ—¶è‡ªåŠ¨ä¿®æ­£
4. **å¹¶è¡Œå¤„ç†**ï¼šå¯ä»¥åŒæ—¶åˆ›å»ºå¤šä¸ªè®°å½•

---

## ä¸‰ã€ç¯å¢ƒå‡†å¤‡å’Œä¾èµ–å®‰è£…

### 3.1 å®‰è£…ä¾èµ–åŒ…

```python
%%capture --no-stderr
%pip install -U langchain_openai langgraph trustcall langchain_core
```

**ä¾èµ–åŒ…è¯´æ˜**ï¼š

- `langchain_openai`ï¼šOpenAI æ¨¡å‹çš„ LangChain é›†æˆ
- `langgraph`ï¼šæ„å»ºæœ‰çŠ¶æ€çš„å¤š Actor åº”ç”¨çš„æ¡†æ¶
- `trustcall`ï¼šç»“æ„åŒ–æ•°æ®æå–åº“
- `langchain_core`ï¼šLangChain æ ¸å¿ƒç»„ä»¶

### 3.2 é…ç½®ç¯å¢ƒå˜é‡

```python
import os, getpass

def _set_env(var: str):
    # æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦å·²è®¾ç½®
    env_value = os.environ.get(var)
    if not env_value:
        # å¦‚æœæœªè®¾ç½®ï¼Œæç¤ºç”¨æˆ·è¾“å…¥
        env_value = getpass.getpass(f"{var}: ")

    # ä¸ºå½“å‰è¿›ç¨‹è®¾ç½®ç¯å¢ƒå˜é‡
    os.environ[var] = env_value

# é…ç½® LangSmithï¼ˆç”¨äºè¿½è¸ªå’Œè°ƒè¯•ï¼‰
_set_env("LANGSMITH_API_KEY")
os.environ["LANGSMITH_TRACING"] = "true"
os.environ["LANGSMITH_PROJECT"] = "langchain-academy"

# é…ç½® OpenAI
_set_env("OPENAI_API_KEY")
```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **`getpass.getpass()`**ï¼šå®‰å…¨åœ°è·å–å¯†ç è¾“å…¥ï¼Œè¾“å…¥å†…å®¹ä¸ä¼šæ˜¾ç¤ºåœ¨å±å¹•ä¸Š
2. **`os.environ.get()`**ï¼šè·å–ç¯å¢ƒå˜é‡ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å› None
3. **`os.environ[key] = value`**ï¼šè®¾ç½®ç¯å¢ƒå˜é‡

---

## å››ã€Trustcall æ·±å…¥ç†è§£

### 4.1 å®šä¹‰æ•°æ®æ¨¡å¼

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Pydantic å®šä¹‰æ•°æ®ç»“æ„ï¼š

```python
from pydantic import BaseModel, Field

class Memory(BaseModel):
    content: str = Field(
        description="The main content of the memory. For example: User expressed interest in learning about French."
    )

class MemoryCollection(BaseModel):
    memories: list[Memory] = Field(
        description="A list of memories about the user."
    )
```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **`BaseModel`**ï¼šPydantic çš„åŸºç±»ï¼Œç”¨äºå®šä¹‰æ•°æ®æ¨¡å‹
2. **`Field`**ï¼šå®šä¹‰å­—æ®µçš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æè¿°ã€é»˜è®¤å€¼ã€éªŒè¯è§„åˆ™ç­‰
3. **ç±»å‹æ³¨è§£**ï¼š
   - `str`ï¼šå­—ç¬¦ä¸²ç±»å‹
   - `list[Memory]`ï¼šMemory å¯¹è±¡çš„åˆ—è¡¨

**Pydantic çš„ä½œç”¨**ï¼š

- **æ•°æ®éªŒè¯**ï¼šç¡®ä¿æ•°æ®ç±»å‹æ­£ç¡®
- **æ•°æ®åºåˆ—åŒ–**ï¼šè½¬æ¢ä¸º JSON ç­‰æ ¼å¼
- **è‡ªåŠ¨æ–‡æ¡£**ï¼šç”Ÿæˆ API æ–‡æ¡£
- **IDE æ”¯æŒ**ï¼šæä¾›ä»£ç è¡¥å…¨å’Œç±»å‹æ£€æŸ¥

### 4.2 ç›‘æ§ Trustcall çš„å·¥å…·è°ƒç”¨ï¼ˆSpy ç±»ï¼‰

Trustcall åœ¨å†…éƒ¨ä¼šè°ƒç”¨ä¸€äº›å·¥å…·æ¥å¤„ç†æ•°æ®ï¼Œæˆ‘ä»¬å¯èƒ½æƒ³çŸ¥é“å®ƒå…·ä½“åšäº†ä»€ä¹ˆã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª"é—´è°"ç±»æ¥ç›‘æ§ï¼š

```python
from trustcall import create_extractor
from langchain_openai import ChatOpenAI

# ç›‘æ§ Trustcall çš„å·¥å…·è°ƒç”¨
class Spy:
    def __init__(self):
        self.called_tools = []

    def __call__(self, run):
        # æ”¶é›†æå–å™¨æ‰§è¡Œçš„å·¥å…·è°ƒç”¨ä¿¡æ¯
        q = [run]
        while q:
            r = q.pop()
            if r.child_runs:
                q.extend(r.child_runs)
            if r.run_type == "chat_model":
                self.called_tools.append(
                    r.outputs["generations"][0][0]["message"]["kwargs"]["tool_calls"]
                )
```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **`__init__` æ–¹æ³•**ï¼šç±»çš„æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–å¯¹è±¡æ—¶è‡ªåŠ¨è°ƒç”¨
2. **`__call__` æ–¹æ³•**ï¼šè®©å¯¹è±¡å¯ä»¥åƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨
   ```python
   spy = Spy()
   spy(some_data)  # ç­‰åŒäºè°ƒç”¨ spy.__call__(some_data)
   ```
3. **é˜Ÿåˆ—éå†**ï¼šä½¿ç”¨åˆ—è¡¨æ¨¡æ‹Ÿé˜Ÿåˆ—è¿›è¡Œå¹¿åº¦ä¼˜å…ˆæœç´¢
   - `q.pop()`ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ 
   - `q.extend(list)`ï¼šå°†åˆ—è¡¨çš„æ‰€æœ‰å…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­

**ä»£ç é€»è¾‘è§£é‡Š**ï¼š

è¿™ä¸ª Spy ç±»çš„å·¥ä½œåŸç†ï¼š

1. åˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨ `called_tools` æ¥å­˜å‚¨å·¥å…·è°ƒç”¨ä¿¡æ¯
2. å½“è¢«è°ƒç”¨æ—¶ï¼Œéå†æ‰€æœ‰è¿è¡Œè®°å½•ï¼ˆåŒ…æ‹¬å­è¿è¡Œï¼‰
3. æ‰¾åˆ°æ‰€æœ‰ `chat_model` ç±»å‹çš„è¿è¡Œ
4. æå–å…¶ä¸­çš„å·¥å…·è°ƒç”¨ï¼ˆtool_callsï¼‰ä¿¡æ¯

### 4.3 åˆ›å»º Trustcall æå–å™¨

```python
# åˆå§‹åŒ– Spy
spy = Spy()

# åˆå§‹åŒ–æ¨¡å‹
model = ChatOpenAI(model="gpt-5-nano", temperature=0)

# åˆ›å»ºæå–å™¨
trustcall_extractor = create_extractor(
    model,
    tools=[Memory],
    tool_choice="Memory",
    enable_inserts=True,
)

# æ·»åŠ  Spy ä½œä¸ºç›‘å¬å™¨
trustcall_extractor_see_all_tool_calls = trustcall_extractor.with_listeners(
    on_end=spy
)
```

**å‚æ•°è¯´æ˜**ï¼š

- `model`ï¼šä½¿ç”¨çš„è¯­è¨€æ¨¡å‹
- `tools=[Memory]`ï¼šå¯ç”¨çš„æ•°æ®æ¨¡å¼ï¼ˆå·¥å…·ï¼‰
- `tool_choice="Memory"`ï¼šå¼ºåˆ¶ä½¿ç”¨ Memory å·¥å…·
- `enable_inserts=True`ï¼šå…è®¸æ’å…¥æ–°è®°å½•
- `with_listeners(on_end=spy)`ï¼šæ·»åŠ ç›‘å¬å™¨ï¼Œåœ¨æ‰§è¡Œç»“æŸæ—¶è°ƒç”¨ spy

### 4.4 æå–è®°å¿† - åŸºç¡€ç¤ºä¾‹

```python
from langchain_core.messages import HumanMessage, SystemMessage, AIMessage

# æŒ‡ä»¤
instruction = """Extract memories from the following conversation:"""

# å¯¹è¯å†…å®¹
conversation = [
    HumanMessage(content="Hi, I'm Lance."),
    AIMessage(content="Nice to meet you, Lance."),
    HumanMessage(content="This morning I had a nice bike ride in San Francisco.")
]

# è°ƒç”¨æå–å™¨
result = trustcall_extractor.invoke({
    "messages": [SystemMessage(content=instruction)] + conversation
})
```

**LangChain æ¶ˆæ¯ç±»å‹**ï¼š

1. **`HumanMessage`**ï¼šç”¨æˆ·çš„æ¶ˆæ¯
2. **`AIMessage`**ï¼šAI çš„å›å¤
3. **`SystemMessage`**ï¼šç³»ç»ŸæŒ‡ä»¤ï¼ˆä¸æ˜¾ç¤ºç»™ç”¨æˆ·ï¼‰

### 4.5 æŸ¥çœ‹æå–ç»“æœ

```python
# æ¶ˆæ¯åŒ…å«å·¥å…·è°ƒç”¨
for m in result["messages"]:
    m.pretty_print()
```

**è¾“å‡º**ï¼š
```
================================== Ai Message ==================================
Tool Calls:
  Memory (call_NkjwwJGjrgxHzTb7KwD8lTaH)
 Call ID: call_NkjwwJGjrgxHzTb7KwD8lTaH
  Args:
    content: Lance had a nice bike ride in San Francisco this morning.
```

```python
# å“åº”åŒ…å«ç¬¦åˆæ¨¡å¼çš„è®°å¿†
for m in result["responses"]:
    print(m)
```

**è¾“å‡º**ï¼š
```
content='Lance had a nice bike ride in San Francisco this morning.'
```

```python
# å…ƒæ•°æ®åŒ…å«å·¥å…·è°ƒç”¨ ID
for m in result["response_metadata"]:
    print(m)
```

**è¾“å‡º**ï¼š
```
{'id': 'call_NkjwwJGjrgxHzTb7KwD8lTaH'}
```

**ç»“æœç»“æ„è¯´æ˜**ï¼š

- `messages`ï¼šåŒ…å« AI çš„å·¥å…·è°ƒç”¨æ¶ˆæ¯
- `responses`ï¼šè§£æåçš„ Pydantic å¯¹è±¡åˆ—è¡¨
- `response_metadata`ï¼šæ¯ä¸ªå“åº”çš„å…ƒæ•°æ®ï¼ˆåŒ…æ‹¬ IDï¼‰

### 4.6 æ›´æ–°ç°æœ‰è®°å¿†

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æ›´æ–°å·²æœ‰çš„è®°å¿†ï¼š

```python
# æ›´æ–°å¯¹è¯
updated_conversation = [
    AIMessage(content="That's great, did you do after?"),
    HumanMessage(content="I went to Tartine and ate a croissant."),
    AIMessage(content="What else is on your mind?"),
    HumanMessage(content="I was thinking about my Japan, and going back this winter!"),
]

# æ›´æ–°æŒ‡ä»¤
system_msg = """Update existing memories and create new ones based on the following conversation:"""

# ä¿å­˜ç°æœ‰è®°å¿†ï¼Œç»™å®ƒä»¬åˆ†é… IDã€keyï¼ˆå·¥å…·åï¼‰å’Œ value
tool_name = "Memory"
existing_memories = [
    (str(i), tool_name, memory.model_dump())
    for i, memory in enumerate(result["responses"])
] if result["responses"] else None

print(existing_memories)
```

**è¾“å‡º**ï¼š
```python
[('0',
  'Memory',
  {'content': 'Lance had a nice bike ride in San Francisco this morning.'})]
```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **åˆ—è¡¨æ¨å¯¼å¼**ï¼š`[expression for item in iterable if condition]`
   ```python
   # ç­‰ä»·äºï¼š
   existing_memories = []
   if result["responses"]:
       for i, memory in enumerate(result["responses"]):
           existing_memories.append((str(i), tool_name, memory.model_dump()))
   else:
       existing_memories = None
   ```

2. **`enumerate()`**ï¼šåŒæ—¶è·å–ç´¢å¼•å’Œå€¼
   ```python
   for i, item in enumerate(['a', 'b', 'c']):
       print(i, item)
   # è¾“å‡ºï¼š
   # 0 a
   # 1 b
   # 2 c
   ```

3. **`model_dump()`**ï¼šå°† Pydantic æ¨¡å‹è½¬æ¢ä¸ºå­—å…¸

4. **å…ƒç»„**ï¼š`(id, tool_name, value)` æ˜¯ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªå…ƒç´ çš„å…ƒç»„

5. **ä¸‰å…ƒè¡¨è¾¾å¼**ï¼š`value if condition else other_value`

### 4.7 ä½¿ç”¨ Spy ç›‘æ§æ›´æ–°è¿‡ç¨‹

```python
# è°ƒç”¨æå–å™¨ï¼Œä¼ å…¥æ›´æ–°çš„å¯¹è¯å’Œç°æœ‰è®°å¿†
result = trustcall_extractor_see_all_tool_calls.invoke({
    "messages": updated_conversation,
    "existing": existing_memories
})
```

æŸ¥çœ‹å·¥å…·è°ƒç”¨ï¼š

```python
# æŸ¥çœ‹æ¶ˆæ¯ä¸­çš„å·¥å…·è°ƒç”¨
for m in result["messages"]:
    m.pretty_print()
```

**è¾“å‡º**ï¼š
```
================================== Ai Message ==================================
Tool Calls:
  Memory (call_bF0w0hE4YZmGyDbuJVe1mh5H)
 Call ID: call_bF0w0hE4YZmGyDbuJVe1mh5H
  Args:
    content: Lance had a nice bike ride in San Francisco this morning. Afterward, he went to Tartine and ate a croissant. He was also thinking about his trip to Japan and going back this winter.
  Memory (call_fQAxxRypV914Xev6nJ9VKw3X)
 Call ID: call_fQAxxRypV914Xev6nJ9VKw3X
  Args:
    content: Lance went to Tartine and ate a croissant. He was also thinking about his trip to Japan and going back this winter.
```

æ³¨æ„ï¼šç¬¬ä¸€ä¸ªå·¥å…·è°ƒç”¨æ›´æ–°äº†ç°æœ‰è®°å¿†ï¼ˆID ä¸º 0 çš„è®°å¿†ï¼‰ï¼Œç¬¬äºŒä¸ªåˆ›å»ºäº†æ–°è®°å¿†ã€‚

æŸ¥çœ‹ Spy æ•è·çš„å·¥å…·è°ƒç”¨ï¼š

```python
spy.called_tools
```

**è¾“å‡º**ï¼š
```python
[[{'name': 'PatchDoc',
   'args': {
       'json_doc_id': '0',
       'planned_edits': '1. Replace the existing content with the updated memory...',
       'patches': [{
           'op': 'replace',
           'path': '/content',
           'value': 'Lance had a nice bike ride in San Francisco this morning. Afterward, he went to Tartine and ate a croissant. He was also thinking about his trip to Japan and going back this winter.'
       }]
   },
   'id': 'call_bF0w0hE4YZmGyDbuJVe1mh5H',
   'type': 'tool_call'},
  {'name': 'Memory',
   'args': {
       'content': 'Lance went to Tartine and ate a croissant. He was also thinking about his trip to Japan and going back this winter.'
   },
   'id': 'call_fQAxxRypV914Xev6nJ9VKw3X',
   'type': 'tool_call'}]]
```

**å…³é”®å‘ç°**ï¼š

1. **PatchDoc å·¥å…·**ï¼šTrustcall å†…éƒ¨ä½¿ç”¨çš„å·¥å…·ï¼Œç”¨äºæ›´æ–°ç°æœ‰æ–‡æ¡£
   - `json_doc_id: '0'`ï¼šæŒ‡å®šè¦æ›´æ–°çš„æ–‡æ¡£ ID
   - `planned_edits`ï¼šæè¿°è®¡åˆ’çš„ç¼–è¾‘å†…å®¹
   - `patches`ï¼šJSON Patch æ“ä½œï¼ˆRFC 6902 æ ‡å‡†ï¼‰
     - `op: 'replace'`ï¼šæ›¿æ¢æ“ä½œ
     - `path: '/content'`ï¼šè¦ä¿®æ”¹çš„å­—æ®µè·¯å¾„
     - `value`ï¼šæ–°å€¼

2. **Memory å·¥å…·**ï¼šåˆ›å»ºæ–°è®°å¿†

### 4.8 æå–å·¥å…·ä¿¡æ¯çš„è¾…åŠ©å‡½æ•°

ä¸ºäº†æ›´æ–¹ä¾¿åœ°æŸ¥çœ‹ Trustcall çš„æ“ä½œï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼š

```python
def extract_tool_info(tool_calls, schema_name="Memory"):
    """ä»å·¥å…·è°ƒç”¨ä¸­æå–ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¥ä¸å’Œæ–°è®°å¿†

    Args:
        tool_calls: æ¨¡å‹çš„å·¥å…·è°ƒç”¨åˆ—è¡¨
        schema_name: æ¨¡å¼å·¥å…·çš„åç§°ï¼ˆä¾‹å¦‚ "Memory"ã€"ToDo"ã€"Profile"ï¼‰
    """

    # åˆå§‹åŒ–å˜æ›´åˆ—è¡¨
    changes = []

    for call_group in tool_calls:
        for call in call_group:
            if call['name'] == 'PatchDoc':
                changes.append({
                    'type': 'update',
                    'doc_id': call['args']['json_doc_id'],
                    'planned_edits': call['args']['planned_edits'],
                    'value': call['args']['patches'][0]['value']
                })
            elif call['name'] == schema_name:
                changes.append({
                    'type': 'new',
                    'value': call['args']
                })

    # å°†ç»“æœæ ¼å¼åŒ–ä¸ºå•ä¸ªå­—ç¬¦ä¸²
    result_parts = []
    for change in changes:
        if change['type'] == 'update':
            result_parts.append(
                f"Document {change['doc_id']} updated:\n"
                f"Plan: {change['planned_edits']}\n"
                f"Added content: {change['value']}"
            )
        else:
            result_parts.append(
                f"New {schema_name} created:\n"
                f"Content: {change['value']}"
            )

    return "\n\n".join(result_parts)

# ä½¿ç”¨è¾…åŠ©å‡½æ•°æŸ¥çœ‹å˜æ›´
schema_name = "Memory"
changes = extract_tool_info(spy.called_tools, schema_name)
print(changes)
```

**è¾“å‡º**ï¼š
```
Document 0 updated:
Plan: 1. Replace the existing content with the updated memory that includes the new activities: going to Tartine for a croissant and thinking about going back to Japan this winter.
Added content: Lance had a nice bike ride in San Francisco this morning. Afterward, he went to Tartine and ate a croissant. He was also thinking about his trip to Japan and going back this winter.

New Memory created:
Content: {'content': 'Lance went to Tartine and ate a croissant. He was also thinking about his trip to Japan and going back this winter.'}
```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **å‡½æ•°å‚æ•°é»˜è®¤å€¼**ï¼š`schema_name="Memory"`
   - è°ƒç”¨æ—¶å¯ä»¥ä¸æä¾›è¯¥å‚æ•°ï¼Œä½¿ç”¨é»˜è®¤å€¼
   - ä¾‹å¦‚ï¼š`extract_tool_info(calls)` ç­‰åŒäº `extract_tool_info(calls, "Memory")`

2. **å­—ç¬¦ä¸²çš„ `join()` æ–¹æ³•**ï¼š
   ```python
   "\n\n".join(['a', 'b', 'c'])  # è¿”å› "a\n\nb\n\nc"
   ```

3. **f-stringï¼ˆæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼‰**ï¼š
   ```python
   name = "Alice"
   age = 30
   print(f"Name: {name}, Age: {age}")  # Name: Alice, Age: 30
   ```

---

## äº”ã€æ„å»º task_mAIstro Agent

ç°åœ¨æˆ‘ä»¬å·²ç»ç†è§£äº† Trustcall çš„å·¥ä½œåŸç†ï¼Œè®©æˆ‘ä»¬å¼€å§‹æ„å»ºå®Œæ•´çš„ Agentã€‚

### 5.1 å®šä¹‰æ›´æ–°ç±»å‹

é¦–å…ˆå®šä¹‰ Agent å¯ä»¥æ›´æ–°å“ªäº›ç±»å‹çš„è®°å¿†ï¼š

```python
from typing import TypedDict, Literal

# æ›´æ–°è®°å¿†å·¥å…·
class UpdateMemory(TypedDict):
    """ å†³å®šæ›´æ–°å“ªç§è®°å¿†ç±»å‹ """
    update_type: Literal['user', 'todo', 'instructions']
```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **`TypedDict`**ï¼šåˆ›å»ºå…·æœ‰ç‰¹å®šå­—æ®µçš„å­—å…¸ç±»å‹
   ```python
   # UpdateMemory æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå¿…é¡»åŒ…å« update_type é”®
   update = UpdateMemory(update_type='user')
   ```

2. **`Literal`**ï¼šé™åˆ¶å€¼åªèƒ½æ˜¯æŒ‡å®šçš„å‡ ä¸ªé€‰é¡¹ä¹‹ä¸€
   ```python
   Literal['user', 'todo', 'instructions']
   # update_type åªèƒ½æ˜¯è¿™ä¸‰ä¸ªå€¼ä¹‹ä¸€
   ```

### 5.2 å®šä¹‰æ•°æ®æ¨¡å¼

#### 5.2.1 ç”¨æˆ· Profile æ¨¡å¼

```python
from typing import Optional
from pydantic import BaseModel, Field

class Profile(BaseModel):
    """è¿™æ˜¯ä½ æ­£åœ¨èŠå¤©çš„ç”¨æˆ·çš„ä¸ªäººèµ„æ–™"""
    name: Optional[str] = Field(
        description="The user's name",
        default=None
    )
    location: Optional[str] = Field(
        description="The user's location",
        default=None
    )
    job: Optional[str] = Field(
        description="The user's job",
        default=None
    )
    connections: list[str] = Field(
        description="Personal connection of the user, such as family members, friends, or coworkers",
        default_factory=list
    )
    interests: list[str] = Field(
        description="Interests that the user has",
        default_factory=list
    )
```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **`Optional[str]`**ï¼šè¡¨ç¤ºè¯¥å­—æ®µå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ– None
   ```python
   # ç­‰ä»·äºï¼š
   from typing import Union
   name: Union[str, None]
   ```

2. **`default=None`**ï¼šå­—æ®µçš„é»˜è®¤å€¼ä¸º None

3. **`default_factory=list`**ï¼šä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»ºé»˜è®¤å€¼
   ```python
   # æ¯ä¸ªå®ä¾‹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºåˆ—è¡¨
   # ä¸è¦ä½¿ç”¨ default=[]ï¼Œä¼šå¯¼è‡´æ‰€æœ‰å®ä¾‹å…±äº«åŒä¸€ä¸ªåˆ—è¡¨
   ```

#### 5.2.2 ToDo æ¨¡å¼

```python
from datetime import datetime
from typing import Literal

class ToDo(BaseModel):
    task: str = Field(
        description="The task to be completed."
    )
    time_to_complete: Optional[int] = Field(
        description="Estimated time to complete the task (minutes)."
    )
    deadline: Optional[datetime] = Field(
        description="When the task needs to be completed by (if applicable)",
        default=None
    )
    solutions: list[str] = Field(
        description="List of specific, actionable solutions (e.g., specific ideas, service providers, or concrete options relevant to completing the task)",
        min_items=1,
        default_factory=list
    )
    status: Literal["not started", "in progress", "done", "archived"] = Field(
        description="Current status of the task",
        default="not started"
    )
```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **`datetime`**ï¼šPython çš„æ—¥æœŸæ—¶é—´ç±»å‹
   ```python
   from datetime import datetime
   now = datetime.now()
   print(now)  # 2024-11-04 13:00:00.123456
   ```

2. **`min_items=1`**ï¼šPydantic éªŒè¯è§„åˆ™ï¼Œåˆ—è¡¨è‡³å°‘è¦æœ‰ 1 ä¸ªå…ƒç´ 

3. **æšä¸¾çŠ¶æ€**ï¼šä½¿ç”¨ `Literal` é™åˆ¶çŠ¶æ€å€¼
   ```python
   # status åªèƒ½æ˜¯è¿™å››ä¸ªå€¼ä¹‹ä¸€ï¼š
   # "not started", "in progress", "done", "archived"
   ```

### 5.3 åˆ›å»º Trustcall æå–å™¨

```python
from trustcall import create_extractor
from langchain_openai import ChatOpenAI

model = ChatOpenAI(model="gpt-5-nano", temperature=0)

# åˆ›å»ºç”¨äºæ›´æ–°ç”¨æˆ· Profile çš„ Trustcall æå–å™¨
profile_extractor = create_extractor(
    model,
    tools=[Profile],
    tool_choice="Profile",
)
```

æ³¨æ„ï¼šæˆ‘ä»¬è¿™é‡Œåªåˆ›å»ºäº† Profile çš„æå–å™¨ï¼ŒToDo çš„æå–å™¨ä¼šåœ¨èŠ‚ç‚¹å‡½æ•°ä¸­åˆ›å»ºã€‚

### 5.4 å®šä¹‰ç³»ç»Ÿæç¤ºè¯

è¿™æ˜¯ Agent çš„æ ¸å¿ƒæŒ‡ä»¤ï¼Œå‘Šè¯‰å®ƒå¦‚ä½•è¡Œä¸ºï¼š

```python
MODEL_SYSTEM_MESSAGE = """You are a helpful chatbot.

You are designed to be a companion to a user, helping them keep track of their ToDo list.

You have a long term memory which keeps track of three things:
1. The user's profile (general information about them)
2. The user's ToDo list
3. General instructions for updating the ToDo list

Here is the current User Profile (may be empty if no information has been collected yet):
<user_profile>
{user_profile}
</user_profile>

Here is the current ToDo List (may be empty if no tasks have been added yet):
<todo>
{todo}
</todo>

Here are the current user-specified preferences for updating the ToDo list (may be empty if no preferences have been specified yet):
<instructions>
{instructions}
</instructions>

Here are your instructions for reasoning about the user's messages:

1. Reason carefully about the user's messages as presented below.

2. Decide whether any of the your long-term memory should be updated:
- If personal information was provided about the user, update the user's profile by calling UpdateMemory tool with type `user`
- If tasks are mentioned, update the ToDo list by calling UpdateMemory tool with type `todo`
- If the user has specified preferences for how to update the ToDo list, update the instructions by calling UpdateMemory tool with type `instructions`

3. Tell the user that you have updated your memory, if appropriate:
- Do not tell the user you have updated the user's profile
- Tell the user them when you update the todo list
- Do not tell the user that you have updated instructions

4. Err on the side of updating the todo list. No need to ask for explicit permission.

5. Respond naturally to user user after a tool call was made to save memories, or if no tool call was made."""
```

**æç¤ºè¯è®¾è®¡è¦ç‚¹**ï¼š

1. **æ˜ç¡®è§’è‰²å®šä¹‰**ï¼š"You are a helpful chatbot..."
2. **æä¾›ä¸Šä¸‹æ–‡**ï¼šæ˜¾ç¤ºå½“å‰çš„ Profileã€ToDoã€Instructions
3. **æ˜ç¡®æŒ‡ä»¤**ï¼šä½•æ—¶æ›´æ–°è®°å¿†ã€å¦‚ä½•å“åº”ç”¨æˆ·
4. **ä½¿ç”¨ XML æ ‡ç­¾**ï¼šä½¿å†…å®¹ç»“æ„æ¸…æ™°ï¼ˆ`<user_profile>`, `<todo>`, `<instructions>`ï¼‰

### 5.5 å®šä¹‰ Trustcall æŒ‡ä»¤

```python
TRUSTCALL_INSTRUCTION = """Reflect on following interaction.

Use the provided tools to retain any necessary memories about the user.

Use parallel tool calling to handle updates and insertions simultaneously.

System Time: {time}"""
```

è¿™ä¸ªæŒ‡ä»¤ä¼šä¼ é€’ç»™ Trustcallï¼Œå‘Šè¯‰å®ƒï¼š
- åæ€å¯¹è¯å†…å®¹
- ä½¿ç”¨å·¥å…·ä¿å­˜è®°å¿†
- å¹¶è¡Œå¤„ç†æ›´æ–°å’Œæ’å…¥æ“ä½œ
- æä¾›å½“å‰æ—¶é—´ï¼ˆç”¨äºå¤„ç†æ—¥æœŸç›¸å…³çš„ä»»åŠ¡ï¼‰

### 5.6 å®šä¹‰æ›´æ–° Instructions çš„æŒ‡ä»¤

```python
CREATE_INSTRUCTIONS = """Reflect on the following interaction.

Based on this interaction, update your instructions for how to update ToDo list items.

Use any feedback from the user to update how they like to have items added, etc.

Your current instructions are:

<current_instructions>
{current_instructions}
</current_instructions>"""
```

### 5.7 å®šä¹‰èŠ‚ç‚¹å‡½æ•°

#### 5.7.1 task_mAIstro èŠ‚ç‚¹ï¼ˆä¸»èŠ‚ç‚¹ï¼‰

è¿™æ˜¯ Agent çš„æ ¸å¿ƒèŠ‚ç‚¹ï¼Œè´Ÿè´£ä¸ç”¨æˆ·äº¤äº’å¹¶å†³å®šæ˜¯å¦æ›´æ–°è®°å¿†ï¼š

```python
from langgraph.graph import MessagesState
from langchain_core.runnables import RunnableConfig
from langgraph.store.base import BaseStore

def task_mAIstro(state: MessagesState, config: RunnableConfig, store: BaseStore):
    """ä» store åŠ è½½è®°å¿†å¹¶ç”¨å®ƒä»¬ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å“åº”"""

    # ä» config è·å–ç”¨æˆ· ID
    user_id = config["configurable"]["user_id"]

    # ä» store æ£€ç´¢ Profile è®°å¿†
    namespace = ("profile", user_id)
    memories = store.search(namespace)
    if memories:
        user_profile = memories[0].value
    else:
        user_profile = None

    # ä» store æ£€ç´¢ä»»åŠ¡è®°å¿†
    namespace = ("todo", user_id)
    memories = store.search(namespace)
    todo = "\n".join(f"{mem.value}" for mem in memories)

    # æ£€ç´¢è‡ªå®šä¹‰æŒ‡ä»¤
    namespace = ("instructions", user_id)
    memories = store.search(namespace)
    if memories:
        instructions = memories[0].value
    else:
        instructions = ""

    # æ ¼å¼åŒ–ç³»ç»Ÿæ¶ˆæ¯
    system_msg = MODEL_SYSTEM_MESSAGE.format(
        user_profile=user_profile,
        todo=todo,
        instructions=instructions
    )

    # ä½¿ç”¨è®°å¿†å’ŒèŠå¤©å†å²ç”Ÿæˆå“åº”
    response = model.bind_tools(
        [UpdateMemory],
        parallel_tool_calls=False
    ).invoke(
        [SystemMessage(content=system_msg)] + state["messages"]
    )

    return {"messages": [response]}
```

**LangGraph çŸ¥è¯†ç‚¹**ï¼š

1. **`MessagesState`**ï¼šLangGraph çš„å†…ç½®çŠ¶æ€ç±»å‹ï¼ŒåŒ…å«æ¶ˆæ¯åˆ—è¡¨
   ```python
   state = {
       "messages": [HumanMessage(...), AIMessage(...), ...]
   }
   ```

2. **`RunnableConfig`**ï¼šé…ç½®å¯¹è±¡ï¼ŒåŒ…å«è¿è¡Œæ—¶ä¿¡æ¯
   ```python
   config = {
       "configurable": {
           "thread_id": "1",
           "user_id": "Lance"
       }
   }
   ```

3. **`BaseStore`**ï¼šå­˜å‚¨æ¥å£ï¼Œç”¨äºè®¿é—®é•¿æœŸè®°å¿†
   - `store.search(namespace)`ï¼šæœç´¢æŒ‡å®šå‘½åç©ºé—´çš„è®°å¿†
   - `store.get(namespace, key)`ï¼šè·å–ç‰¹å®šè®°å¿†
   - `store.put(namespace, key, value)`ï¼šä¿å­˜è®°å¿†

4. **Namespaceï¼ˆå‘½åç©ºé—´ï¼‰**ï¼šç”¨å…ƒç»„è¡¨ç¤ºçš„åˆ†å±‚ç»“æ„
   ```python
   ("profile", "Lance")  # ç”¨æˆ· Lance çš„ profile
   ("todo", "Lance")     # ç”¨æˆ· Lance çš„ todo
   ("instructions", "Lance")  # ç”¨æˆ· Lance çš„ instructions
   ```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **`"\n".join()`**ï¼šç”¨æ¢è¡Œç¬¦è¿æ¥å­—ç¬¦ä¸²
   ```python
   todos = ["Buy milk", "Call mom"]
   result = "\n".join(todos)
   # ç»“æœï¼š
   # Buy milk
   # Call mom
   ```

2. **ç”Ÿæˆå™¨è¡¨è¾¾å¼**ï¼š
   ```python
   "\n".join(f"{mem.value}" for mem in memories)
   # ç­‰ä»·äºï¼š
   result = []
   for mem in memories:
       result.append(f"{mem.value}")
   "\n".join(result)
   ```

3. **`model.bind_tools()`**ï¼šå°†å·¥å…·ç»‘å®šåˆ°æ¨¡å‹
   - `parallel_tool_calls=False`ï¼šä¸å…è®¸å¹¶è¡Œè°ƒç”¨å·¥å…·ï¼ˆä¸€æ¬¡åªè°ƒç”¨ä¸€ä¸ªï¼‰

#### 5.7.2 update_profile èŠ‚ç‚¹

æ›´æ–°ç”¨æˆ·ä¸ªäººèµ„æ–™ï¼š

```python
import uuid
from langchain_core.messages import merge_message_runs

def update_profile(state: MessagesState, config: RunnableConfig, store: BaseStore):
    """åæ€èŠå¤©å†å²å¹¶æ›´æ–°è®°å¿†é›†åˆ"""

    # è·å–ç”¨æˆ· ID
    user_id = config["configurable"]["user_id"]

    # å®šä¹‰è®°å¿†çš„å‘½åç©ºé—´
    namespace = ("profile", user_id)

    # æ£€ç´¢æœ€è¿‘çš„è®°å¿†ä½œä¸ºä¸Šä¸‹æ–‡
    existing_items = store.search(namespace)

    # ä¸º Trustcall æå–å™¨æ ¼å¼åŒ–ç°æœ‰è®°å¿†
    tool_name = "Profile"
    existing_memories = (
        [(existing_item.key, tool_name, existing_item.value)
         for existing_item in existing_items]
        if existing_items
        else None
    )

    # åˆå¹¶èŠå¤©å†å²å’ŒæŒ‡ä»¤
    TRUSTCALL_INSTRUCTION_FORMATTED = TRUSTCALL_INSTRUCTION.format(
        time=datetime.now().isoformat()
    )
    updated_messages = list(merge_message_runs(
        messages=[SystemMessage(content=TRUSTCALL_INSTRUCTION_FORMATTED)] + state["messages"][:-1]
    ))

    # è°ƒç”¨æå–å™¨
    result = profile_extractor.invoke({
        "messages": updated_messages,
        "existing": existing_memories
    })

    # å°† Trustcall çš„è®°å¿†ä¿å­˜åˆ° store
    for r, rmeta in zip(result["responses"], result["response_metadata"]):
        store.put(
            namespace,
            rmeta.get("json_doc_id", str(uuid.uuid4())),
            r.model_dump(mode="json"),
        )

    # å“åº”å·¥å…·è°ƒç”¨
    tool_calls = state['messages'][-1].tool_calls
    return {
        "messages": [{
            "role": "tool",
            "content": "updated profile",
            "tool_call_id": tool_calls[0]['id']
        }]
    }
```

**Python çŸ¥è¯†ç‚¹**ï¼š

1. **`uuid.uuid4()`**ï¼šç”Ÿæˆéšæœºçš„ UUIDï¼ˆé€šç”¨å”¯ä¸€è¯†åˆ«ç ï¼‰
   ```python
   import uuid
   id = str(uuid.uuid4())  # ä¾‹å¦‚ï¼š'550e8400-e29b-41d4-a716-446655440000'
   ```

2. **`datetime.now().isoformat()`**ï¼šè·å– ISO 8601 æ ¼å¼çš„æ—¶é—´æˆ³
   ```python
   from datetime import datetime
   time = datetime.now().isoformat()
   # ä¾‹å¦‚ï¼š'2024-11-04T13:30:00.123456'
   ```

3. **`zip()` å‡½æ•°**ï¼šå¹¶è¡Œè¿­ä»£å¤šä¸ªåºåˆ—
   ```python
   names = ['Alice', 'Bob']
   ages = [25, 30]
   for name, age in zip(names, ages):
       print(f"{name} is {age} years old")
   # è¾“å‡ºï¼š
   # Alice is 25 years old
   # Bob is 30 years old
   ```

4. **å­—å…¸çš„ `get()` æ–¹æ³•**ï¼šå®‰å…¨åœ°è·å–å€¼ï¼Œæä¾›é»˜è®¤å€¼
   ```python
   d = {'a': 1}
   d.get('a', 0)  # è¿”å› 1
   d.get('b', 0)  # è¿”å› 0ï¼ˆé”®ä¸å­˜åœ¨ï¼‰
   ```

**LangGraph çŸ¥è¯†ç‚¹**ï¼š

1. **`merge_message_runs()`**ï¼šåˆå¹¶è¿ç»­çš„ç›¸åŒè§’è‰²æ¶ˆæ¯
   ```python
   # åˆå¹¶å‰ï¼š
   [HumanMessage("Hi"), HumanMessage("How are you?")]
   # åˆå¹¶åï¼š
   [HumanMessage("Hi\nHow are you?")]
   ```

2. **Tool Message**ï¼šå“åº”å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯
   ```python
   {
       "role": "tool",          # è§’è‰²æ˜¯ tool
       "content": "ç»“æœå†…å®¹",    # å·¥å…·æ‰§è¡Œçš„ç»“æœ
       "tool_call_id": "xxx"   # å¯¹åº”çš„å·¥å…·è°ƒç”¨ ID
   }
   ```

3. **`state["messages"][:-1]`**ï¼šè·å–é™¤æœ€åä¸€æ¡æ¶ˆæ¯å¤–çš„æ‰€æœ‰æ¶ˆæ¯
   ```python
   messages = ['a', 'b', 'c', 'd']
   messages[:-1]  # ['a', 'b', 'c']
   ```

#### 5.7.3 update_todos èŠ‚ç‚¹

æ›´æ–°å¾…åŠäº‹é¡¹åˆ—è¡¨ï¼ˆä¸ update_profile ç±»ä¼¼ï¼Œä½†ä½¿ç”¨ Spy ç›‘æ§ï¼‰ï¼š

```python
def update_todos(state: MessagesState, config: RunnableConfig, store: BaseStore):
    """åæ€èŠå¤©å†å²å¹¶æ›´æ–°è®°å¿†é›†åˆ"""

    # è·å–ç”¨æˆ· ID
    user_id = config["configurable"]["user_id"]

    # å®šä¹‰è®°å¿†çš„å‘½åç©ºé—´
    namespace = ("todo", user_id)

    # æ£€ç´¢æœ€è¿‘çš„è®°å¿†ä½œä¸ºä¸Šä¸‹æ–‡
    existing_items = store.search(namespace)

    # ä¸º Trustcall æå–å™¨æ ¼å¼åŒ–ç°æœ‰è®°å¿†
    tool_name = "ToDo"
    existing_memories = (
        [(existing_item.key, tool_name, existing_item.value)
         for existing_item in existing_items]
        if existing_items
        else None
    )

    # åˆå¹¶èŠå¤©å†å²å’ŒæŒ‡ä»¤
    TRUSTCALL_INSTRUCTION_FORMATTED = TRUSTCALL_INSTRUCTION.format(
        time=datetime.now().isoformat()
    )
    updated_messages = list(merge_message_runs(
        messages=[SystemMessage(content=TRUSTCALL_INSTRUCTION_FORMATTED)] + state["messages"][:-1]
    ))

    # åˆå§‹åŒ– Spy ä»¥ç›‘æ§ Trustcall çš„å·¥å…·è°ƒç”¨
    spy = Spy()

    # åˆ›å»ºç”¨äºæ›´æ–° ToDo åˆ—è¡¨çš„ Trustcall æå–å™¨
    todo_extractor = create_extractor(
        model,
        tools=[ToDo],
        tool_choice=tool_name,
        enable_inserts=True
    ).with_listeners(on_end=spy)

    # è°ƒç”¨æå–å™¨
    result = todo_extractor.invoke({
        "messages": updated_messages,
        "existing": existing_memories
    })

    # å°† Trustcall çš„è®°å¿†ä¿å­˜åˆ° store
    for r, rmeta in zip(result["responses"], result["response_metadata"]):
        store.put(
            namespace,
            rmeta.get("json_doc_id", str(uuid.uuid4())),
            r.model_dump(mode="json"),
        )

    # å“åº”å·¥å…·è°ƒç”¨ï¼Œç¡®è®¤æ›´æ–°
    tool_calls = state['messages'][-1].tool_calls

    # æå– Trustcall çš„å˜æ›´å¹¶æ·»åŠ åˆ°è¿”å›ç»™ task_mAIstro çš„ ToolMessage ä¸­
    todo_update_msg = extract_tool_info(spy.called_tools, tool_name)
    return {
        "messages": [{
            "role": "tool",
            "content": todo_update_msg,
            "tool_call_id": tool_calls[0]['id']
        }]
    }
```

**å…³é”®åŒºåˆ«**ï¼š

ä¸ `update_profile` çš„ä¸»è¦åŒºåˆ«ï¼š
1. åˆ›å»ºäº† ToDo ä¸“ç”¨çš„æå–å™¨ï¼ˆå¯ç”¨äº† `enable_inserts`ï¼‰
2. æ·»åŠ äº† Spy ç›‘å¬å™¨
3. è¿”å›çš„ ToolMessage åŒ…å«è¯¦ç»†çš„å˜æ›´ä¿¡æ¯ï¼ˆè€Œä¸ä»…ä»…æ˜¯ "updated todo"ï¼‰

#### 5.7.4 update_instructions èŠ‚ç‚¹

æ›´æ–°ç”¨æˆ·åå¥½è®¾ç½®ï¼š

```python
def update_instructions(state: MessagesState, config: RunnableConfig, store: BaseStore):
    """åæ€èŠå¤©å†å²å¹¶æ›´æ–°è®°å¿†é›†åˆ"""

    # è·å–ç”¨æˆ· ID
    user_id = config["configurable"]["user_id"]

    namespace = ("instructions", user_id)

    # è·å–ç°æœ‰è®°å¿†
    existing_memory = store.get(namespace, "user_instructions")

    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†
    system_msg = CREATE_INSTRUCTIONS.format(
        current_instructions=existing_memory.value if existing_memory else None
    )

    # è®©æ¨¡å‹ç”Ÿæˆæ–°çš„æŒ‡ä»¤
    new_memory = model.invoke([
        SystemMessage(content=system_msg)
    ] + state['messages'][:-1] + [
        HumanMessage(content="Please update the instructions based on the conversation")
    ])

    # è¦†ç›– store ä¸­çš„ç°æœ‰è®°å¿†
    key = "user_instructions"
    store.put(namespace, key, {"memory": new_memory.content})

    # å“åº”å·¥å…·è°ƒç”¨
    tool_calls = state['messages'][-1].tool_calls
    return {
        "messages": [{
            "role": "tool",
            "content": "updated instructions",
            "tool_call_id": tool_calls[0]['id']
        }]
    }
```

**ä¸å…¶ä»–èŠ‚ç‚¹çš„åŒºåˆ«**ï¼š

1. ä¸ä½¿ç”¨ Trustcallï¼ˆå› ä¸ºæŒ‡ä»¤æ˜¯è‡ªç”±æ–‡æœ¬ï¼Œä¸æ˜¯ç»“æ„åŒ–æ•°æ®ï¼‰
2. ä½¿ç”¨å›ºå®šçš„ keyï¼š"user_instructions"
3. ç›´æ¥ç”¨æ¨¡å‹ç”Ÿæˆæ–°çš„æŒ‡ä»¤æ–‡æœ¬

### 5.8 å®šä¹‰è·¯ç”±å‡½æ•°

è·¯ç”±å‡½æ•°å†³å®šæµç¨‹çš„èµ°å‘ï¼š

```python
from typing import Literal
from langgraph.graph import END

def route_message(
    state: MessagesState,
    config: RunnableConfig,
    store: BaseStore
) -> Literal[END, "update_todos", "update_instructions", "update_profile"]:
    """æ ¹æ®è®°å¿†å’ŒèŠå¤©å†å²å†³å®šæ˜¯å¦æ›´æ–°è®°å¿†é›†åˆ"""

    message = state['messages'][-1]

    # å¦‚æœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œç»“æŸ
    if len(message.tool_calls) == 0:
        return END
    else:
        # æ ¹æ®å·¥å…·è°ƒç”¨çš„ç±»å‹å†³å®šè·¯ç”±
        tool_call = message.tool_calls[0]
        if tool_call['args']['update_type'] == "user":
            return "update_profile"
        elif tool_call['args']['update_type'] == "todo":
            return "update_todos"
        elif tool_call['args']['update_type'] == "instructions":
            return "update_instructions"
        else:
            raise ValueError
```

**LangGraph çŸ¥è¯†ç‚¹**ï¼š

1. **`END`**ï¼šç‰¹æ®Šæ ‡è®°ï¼Œè¡¨ç¤ºå›¾çš„æ‰§è¡Œç»“æŸ
   ```python
   from langgraph.graph import END
   ```

2. **æ¡ä»¶è¾¹çš„è¿”å›å€¼**ï¼š
   - è¿”å›èŠ‚ç‚¹åç§°ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼šè·³è½¬åˆ°è¯¥èŠ‚ç‚¹
   - è¿”å› `END`ï¼šç»“æŸæ‰§è¡Œ

3. **ç±»å‹æ³¨è§£**ï¼š`Literal[END, "node1", "node2"]`
   - é™åˆ¶è¿”å›å€¼åªèƒ½æ˜¯è¿™å‡ ä¸ªé€‰é¡¹ä¹‹ä¸€

**é€»è¾‘è¯´æ˜**ï¼š

1. æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆAI çš„å“åº”ï¼‰
2. å¦‚æœæ²¡æœ‰å·¥å…·è°ƒç”¨ â†’ ç»“æŸï¼ˆç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼‰
3. å¦‚æœæœ‰å·¥å…·è°ƒç”¨ â†’ æ ¹æ® `update_type` è·¯ç”±åˆ°ç›¸åº”èŠ‚ç‚¹

### 5.9 æ„å»ºçŠ¶æ€å›¾

ç°åœ¨æŠŠæ‰€æœ‰éƒ¨åˆ†ç»„è£…èµ·æ¥ï¼š

```python
from langgraph.graph import StateGraph, START
from langgraph.checkpoint.memory import MemorySaver
from langgraph.store.memory import InMemoryStore

# åˆ›å»ºå›¾æ„å»ºå™¨
builder = StateGraph(MessagesState)

# æ·»åŠ èŠ‚ç‚¹
builder.add_node(task_mAIstro)
builder.add_node(update_todos)
builder.add_node(update_profile)
builder.add_node(update_instructions)

# å®šä¹‰è¾¹
builder.add_edge(START, "task_mAIstro")
builder.add_conditional_edges("task_mAIstro", route_message)
builder.add_edge("update_todos", "task_mAIstro")
builder.add_edge("update_profile", "task_mAIstro")
builder.add_edge("update_instructions", "task_mAIstro")

# é•¿æœŸè®°å¿†ï¼ˆè·¨çº¿ç¨‹ï¼‰çš„ Store
across_thread_memory = InMemoryStore()

# çŸ­æœŸè®°å¿†ï¼ˆçº¿ç¨‹å†…ï¼‰çš„ Checkpointer
within_thread_memory = MemorySaver()

# ç¼–è¯‘å›¾
graph = builder.compile(
    checkpointer=within_thread_memory,
    store=across_thread_memory
)

# å¯è§†åŒ–å›¾ç»“æ„
from IPython.display import Image, display
display(Image(graph.get_graph(xray=1).draw_mermaid_png()))
```

**å›¾ç»“æ„è¯´æ˜**ï¼š

```
START â†’ task_mAIstro â†’ [æ¡ä»¶è·¯ç”±]
                         â”œâ†’ END
                         â”œâ†’ update_profile â†’ task_mAIstro
                         â”œâ†’ update_todos â†’ task_mAIstro
                         â””â†’ update_instructions â†’ task_mAIstro
```

**LangGraph çŸ¥è¯†ç‚¹**ï¼š

1. **`StateGraph(MessagesState)`**ï¼šåˆ›å»ºçŠ¶æ€å›¾
   - `MessagesState`ï¼šå®šä¹‰çŠ¶æ€çš„ç±»å‹

2. **`add_node(function)`**ï¼šæ·»åŠ èŠ‚ç‚¹
   - èŠ‚ç‚¹åç§°é»˜è®¤ä¸ºå‡½æ•°å
   - ä¹Ÿå¯ä»¥æŒ‡å®šï¼š`add_node("custom_name", function)`

3. **`add_edge(from_node, to_node)`**ï¼šæ·»åŠ ç¡®å®šæ€§è¾¹
   - ä» `from_node` æ€»æ˜¯å‰å¾€ `to_node`

4. **`add_conditional_edges(from_node, routing_function)`**ï¼šæ·»åŠ æ¡ä»¶è¾¹
   - `routing_function` çš„è¿”å›å€¼å†³å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹

5. **`compile()`**ï¼šç¼–è¯‘å›¾ï¼Œç”Ÿæˆå¯æ‰§è¡Œçš„è¿è¡Œæ—¶
   - `checkpointer`ï¼šç”¨äºä¿å­˜æ£€æŸ¥ç‚¹ï¼ˆçŸ­æœŸè®°å¿†ï¼‰
   - `store`ï¼šç”¨äºæŒä¹…åŒ–å­˜å‚¨ï¼ˆé•¿æœŸè®°å¿†ï¼‰

6. **`START`**ï¼šç‰¹æ®Šæ ‡è®°ï¼Œå›¾çš„å…¥å£ç‚¹

7. **å¯è§†åŒ–**ï¼š
   - `get_graph(xray=1)`ï¼šè·å–å›¾çš„è¯¦ç»†ç»“æ„
   - `draw_mermaid_png()`ï¼šç”Ÿæˆ Mermaid æ ¼å¼çš„æµç¨‹å›¾

---

## å…­ã€å®æˆ˜æ¼”ç¤º

### 6.1 é…ç½®å’Œåˆå§‹åŒ–

```python
# æä¾›çº¿ç¨‹ IDï¼ˆçŸ­æœŸè®°å¿†ï¼‰
# æä¾›ç”¨æˆ· IDï¼ˆé•¿æœŸè®°å¿†ï¼‰
config = {
    "configurable": {
        "thread_id": "1",      # ä¼šè¯ ID
        "user_id": "Lance"     # ç”¨æˆ· ID
    }
}
```

**é…ç½®è¯´æ˜**ï¼š

- `thread_id`ï¼šæ ‡è¯†ä¸€ä¸ªå¯¹è¯ä¼šè¯ï¼Œç›¸åŒ thread_id çš„æ¶ˆæ¯å…±äº«çŸ­æœŸè®°å¿†
- `user_id`ï¼šæ ‡è¯†ç”¨æˆ·ï¼Œç›¸åŒ user_id çš„ä¼šè¯å…±äº«é•¿æœŸè®°å¿†

### 6.2 åˆ›å»ºç”¨æˆ· Profile

```python
# ç”¨æˆ·è¾“å…¥ä»¥åˆ›å»º Profile è®°å¿†
input_messages = [HumanMessage(
    content="My name is Lance. I live in SF with my wife. I have a 1 year old daughter."
)]

# è¿è¡Œå›¾
for chunk in graph.stream(
    {"messages": input_messages},
    config,
    stream_mode="values"
):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
My name is Lance. I live in SF with my wife. I have a 1 year old daughter.

================================== Ai Message ==================================
Tool Calls:
  UpdateMemory (call_rOuw3bLYjFFKuSVWsIHF27k5)
 Call ID: call_rOuw3bLYjFFKuSVWsIHF27k5
  Args:
    update_type: user

================================= Tool Message =================================
updated profile

================================== Ai Message ==================================
Got it! How can I assist you today, Lance?
```

**æ‰§è¡Œæµç¨‹åˆ†æ**ï¼š

1. **Human Message**ï¼šç”¨æˆ·è¾“å…¥
2. **AI Messageï¼ˆå·¥å…·è°ƒç”¨ï¼‰**ï¼š`task_mAIstro` å†³å®šæ›´æ–°ç”¨æˆ·èµ„æ–™
   - è°ƒç”¨ `UpdateMemory` å·¥å…·
   - `update_type: "user"`
3. **Tool Message**ï¼š`update_profile` èŠ‚ç‚¹æ‰§è¡Œå¹¶è¿”å›ç»“æœ
4. **AI Messageï¼ˆå“åº”ï¼‰**ï¼š`task_mAIstro` ç”Ÿæˆè‡ªç„¶è¯­è¨€å“åº”

**LangGraph çŸ¥è¯†ç‚¹**ï¼š

1. **`graph.stream()`**ï¼šæµå¼æ‰§è¡Œå›¾
   ```python
   graph.stream(
       input_data,           # è¾“å…¥æ•°æ®
       config,               # é…ç½®
       stream_mode="values"  # æµæ¨¡å¼
   )
   ```

2. **`stream_mode="values"`**ï¼š
   - æ¯æ¬¡çŠ¶æ€æ›´æ–°æ—¶äº§å‡ºå®Œæ•´çš„çŠ¶æ€
   - å…¶ä»–é€‰é¡¹ï¼š`"updates"`ï¼ˆåªäº§å‡ºæ›´æ–°éƒ¨åˆ†ï¼‰

3. **æµå¼è¾“å‡º**ï¼š
   - æ¯ä¸ª `chunk` æ˜¯ä¸€æ¬¡çŠ¶æ€æ›´æ–°
   - `chunk["messages"][-1]` æ˜¯æœ€æ–°æ·»åŠ çš„æ¶ˆæ¯

### 6.3 æ·»åŠ  ToDo é¡¹

```python
# ç”¨æˆ·è¾“å…¥ä»¥åˆ›å»º ToDo
input_messages = [HumanMessage(
    content="My wife asked me to book swim lessons for the baby."
)]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
My wife asked me to book swim lessons for the baby.

================================== Ai Message ==================================
Tool Calls:
  UpdateMemory (call_VjLbRpbLqniJ8we2CNKQ0m3P)
 Call ID: call_VjLbRpbLqniJ8we2CNKQ0m3P
  Args:
    update_type: todo

================================= Tool Message =================================
New ToDo created:
Content: {'task': 'Book swim lessons for 1-year-old daughter.',
          'time_to_complete': 30,
          'solutions': ['Check local swim schools in SF',
                       'Look for baby swim classes online',
                       'Ask friends for recommendations'],
          'status': 'not started'}

================================== Ai Message ==================================
I've added "Book swim lessons for your 1-year-old daughter" to your ToDo list.
If you need any help with that, just let me know!
```

**åˆ†æ**ï¼š

1. Agent è¯†åˆ«å‡ºè¿™æ˜¯ä¸€ä¸ªä»»åŠ¡ï¼Œè°ƒç”¨ `UpdateMemory` å·¥å…·ï¼ˆtype: "todo"ï¼‰
2. `update_todos` èŠ‚ç‚¹è¢«è°ƒç”¨
3. Trustcall åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ ToDo é¡¹ï¼ŒåŒ…å«ï¼š
   - ä»»åŠ¡æè¿°
   - é¢„è®¡å®Œæˆæ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
   - å…·ä½“è§£å†³æ–¹æ¡ˆ
   - çŠ¶æ€ï¼ˆnot startedï¼‰
4. Agent å‘ŠçŸ¥ç”¨æˆ·å·²æ·»åŠ ä»»åŠ¡

**æ™ºèƒ½ä¹‹å¤„**ï¼š

- Agent è‡ªåŠ¨æ¨æ–­ä»»åŠ¡çš„å®Œæˆæ—¶é—´
- è‡ªåŠ¨ç”Ÿæˆå…·ä½“å¯è¡Œçš„è§£å†³æ–¹æ¡ˆ
- è‡ªåŠ¨è®¾ç½®çŠ¶æ€

### 6.4 æ›´æ–° Instructionsï¼ˆç¨‹åºæ€§è®°å¿†ï¼‰

```python
# ç”¨æˆ·è¾“å…¥ä»¥æ›´æ–°åˆ›å»º ToDo çš„æŒ‡ä»¤
input_messages = [HumanMessage(
    content="When creating or updating ToDo items, include specific local businesses / vendors."
)]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
When creating or updating ToDo items, include specific local businesses / vendors.

================================== Ai Message ==================================
Tool Calls:
  UpdateMemory (call_22w3V3Krhjf8WxDeH9YrQILa)
 Call ID: call_22w3V3Krhjf8WxDeH9YrQILa
  Args:
    update_type: instructions

================================= Tool Message =================================
updated instructions

================================== Ai Message ==================================
Got it! I'll make sure to include specific local businesses or vendors in San Francisco
when creating or updating your ToDo items. Let me know if there's anything else you need!
```

æŸ¥çœ‹ä¿å­˜çš„ Instructionsï¼š

```python
user_id = "Lance"

# æœç´¢ Instructions
for memory in across_thread_memory.search(("instructions", user_id)):
    print(memory.value)
```

**è¾“å‡º**ï¼š

```python
{'memory': '<current_instructions>\nWhen creating or updating ToDo list items for Lance, include specific local businesses or vendors in San Francisco. For example, when adding a task like booking swim lessons, suggest local swim schools or classes in the area.\n</current_instructions>'}
```

**ç¨‹åºæ€§è®°å¿†çš„ä½œç”¨**ï¼š

è¿™æ¡æŒ‡ä»¤ä¼šå½±å“ Agent æœªæ¥åˆ›å»º ToDo é¡¹çš„æ–¹å¼ã€‚è®©æˆ‘ä»¬éªŒè¯ä¸€ä¸‹ã€‚

### 6.5 éªŒè¯ Instructions çš„æ•ˆæœ

```python
# ç”¨æˆ·è¾“å…¥æ–°çš„ ToDo
input_messages = [HumanMessage(
    content="I need to fix the jammed electric Yale lock on the door."
)]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
I need to fix the jammed electric Yale lock on the door.

================================== Ai Message ==================================
Tool Calls:
  UpdateMemory (call_7ooNemi3d6qWMfjf2g2h97EF)
 Call ID: call_7ooNemi3d6qWMfjf2g2h97EF
  Args:
    update_type: todo

================================= Tool Message =================================
New ToDo created:
Content: {'task': 'Fix the jammed electric Yale lock on the door.',
          'time_to_complete': 60,
          'solutions': ['Contact a local locksmith in SF',
                       "Check Yale's customer support for troubleshooting",
                       'Look for repair guides online'],
          'status': 'not started'}

Document ed0af900-52fa-4f15-907c-1aed1e17b0ce updated:
Plan: Add specific local businesses or vendors to the solutions for booking swim lessons.
Added content: ['Check local swim schools in SF',
                'Look for baby swim classes online',
                'Ask friends for recommendations',
                'Contact La Petite Baleen Swim School',
                'Check with SF Recreation and Parks for classes']

================================== Ai Message ==================================
I've added "Fix the jammed electric Yale lock on the door" to your ToDo list.
If you need any specific recommendations or help, feel free to ask!
```

**é‡è¦å‘ç°**ï¼š

1. **åˆ›å»ºäº†æ–° ToDo**ï¼šä¿®ç†é—¨é”
   - è§£å†³æ–¹æ¡ˆåŒ…å« "Contact a local locksmith in SF"ï¼ˆå…·ä½“åˆ°æœ¬åœ°ï¼‰

2. **è‡ªåŠ¨æ›´æ–°äº†æ—§ ToDo**ï¼šé¢„è®¢æ¸¸æ³³è¯¾
   - æ·»åŠ äº†å…·ä½“çš„æœ¬åœ°å•†å®¶ï¼š
     - "Contact La Petite Baleen Swim School"
     - "Check with SF Recreation and Parks for classes"

è¿™å±•ç¤ºäº†ç¨‹åºæ€§è®°å¿†çš„å¼ºå¤§ä¹‹å¤„ï¼šAgent å­¦ä¼šäº†ç”¨æˆ·çš„åå¥½ï¼Œå¹¶åº”ç”¨åˆ°æ‰€æœ‰ç›¸å…³ä»»åŠ¡ä¸Šã€‚

### 6.6 æŸ¥çœ‹æ‰€æœ‰ ToDo é¡¹

```python
user_id = "Lance"

# æœç´¢æ‰€æœ‰ ToDo
for memory in across_thread_memory.search(("todo", user_id)):
    print(memory.value)
```

**è¾“å‡º**ï¼š

```python
{'task': 'Book swim lessons for 1-year-old daughter.',
 'time_to_complete': 30,
 'deadline': None,
 'solutions': ['Check local swim schools in SF',
               'Look for baby swim classes online',
               'Ask friends for recommendations',
               'Contact La Petite Baleen Swim School',
               'Check with SF Recreation and Parks for classes'],
 'status': 'not started'}

{'task': 'Fix the jammed electric Yale lock on the door.',
 'time_to_complete': 60,
 'deadline': None,
 'solutions': ['Contact a local locksmith in SF',
               "Check Yale's customer support for troubleshooting",
               'Look for repair guides online'],
 'status': 'not started'}
```

### 6.7 æ›´æ–°ç°æœ‰ ToDoï¼ˆæ·»åŠ æˆªæ­¢æ—¥æœŸï¼‰

```python
# ç”¨æˆ·è¾“å…¥ä»¥æ›´æ–°ç°æœ‰ ToDo
input_messages = [HumanMessage(
    content="For the swim lessons, I need to get that done by end of November."
)]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
For the swim lessons, I need to get that done by end of November.

================================== Ai Message ==================================
Tool Calls:
  UpdateMemory (call_6AbsrTps4EPyD0gKBzkMIC90)
 Call ID: call_6AbsrTps4EPyD0gKBzkMIC90
  Args:
    update_type: todo

================================= Tool Message =================================
Document ed0af900-52fa-4f15-907c-1aed1e17b0ce updated:
Plan: Add a deadline for the swim lessons task to ensure it is completed by the end of November.
Added content: 2024-11-30T23:59:59

================================== Ai Message ==================================
I've updated the swim lessons task with a deadline to be completed by the end of November.
If there's anything else you need, just let me know!
```

**åˆ†æ**ï¼š

- Trustcall è¯†åˆ«å‡ºè¿™æ˜¯å¯¹ç°æœ‰ ToDo çš„æ›´æ–°
- ä½¿ç”¨ `PatchDoc` å·¥å…·æ›´æ–°æ–‡æ¡£
- æ·»åŠ äº†æˆªæ­¢æ—¥æœŸï¼š2024-11-30T23:59:59

### 6.8 æ·»åŠ æ›´å¤š ToDoï¼ˆè§‚å¯Ÿè‡ªåŠ¨æ›´æ–°ï¼‰

```python
# ç”¨æˆ·è¾“å…¥æ–°çš„ ToDo
input_messages = [HumanMessage(
    content="Need to call back City Toyota to schedule car service."
)]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
Need to call back City Toyota to schedule car service.

================================== Ai Message ==================================
Tool Calls:
  UpdateMemory (call_tDuYZL7njpwOkg2YMEcf6DDJ)
 Call ID: call_tDuYZL7njpwOkg2YMEcf6DDJ
  Args:
    update_type: todo

================================= Tool Message =================================
New ToDo created:
Content: {'task': 'Call back City Toyota to schedule car service.',
          'time_to_complete': 10,
          'solutions': ["Find City Toyota's contact number",
                       'Check car service availability',
                       'Prepare car details for service scheduling'],
          'status': 'not started'}

Document a77482f0-d654-4b41-ab74-d6f2b343a969 updated:
Plan: Add specific local businesses or vendors to the solutions for fixing the jammed electric Yale lock.
Added content: Contact City Locksmith SF

================================== Ai Message ==================================
I've added "Call back City Toyota to schedule car service" to your ToDo list.
If you need any assistance with that, just let me know!
```

**å†æ¬¡éªŒè¯ç¨‹åºæ€§è®°å¿†**ï¼š

- åˆ›å»ºäº†æ–°ä»»åŠ¡ï¼šé¢„çº¦æ±½è½¦ä¿å…»
- è‡ªåŠ¨æ›´æ–°äº†é”åŒ ä»»åŠ¡ï¼Œæ·»åŠ äº†æœ¬åœ°å•†å®¶ï¼š"Contact City Locksmith SF"

æŸ¥çœ‹æ‰€æœ‰ ToDoï¼š

```python
for memory in across_thread_memory.search(("todo", "Lance")):
    print(memory.value)
```

**è¾“å‡º**ï¼š

```python
{'task': 'Book swim lessons for 1-year-old daughter.',
 'time_to_complete': 30,
 'deadline': '2024-11-30T23:59:59',
 'solutions': ['Check local swim schools in SF', ...],
 'status': 'not started'}

{'task': 'Fix the jammed electric Yale lock on the door.',
 'time_to_complete': 60,
 'deadline': None,
 'solutions': ['Contact a local locksmith in SF',
               "Check Yale's customer support for troubleshooting",
               'Look for repair guides online',
               'Contact City Locksmith SF',          # æ–°æ·»åŠ 
               'Visit SF Lock and Key for assistance'], # æ–°æ·»åŠ 
 'status': 'not started'}

{'task': 'Call back City Toyota to schedule car service.',
 'time_to_complete': 10,
 'deadline': None,
 'solutions': [...],
 'status': 'not started'}
```

### 6.9 è·¨ä¼šè¯è®¿é—®è®°å¿†

ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ï¼ˆä¸åŒçš„ thread_idï¼‰ï¼š

```python
# æ–°çš„ thread_idï¼Œä½†ç›¸åŒçš„ user_id
config = {
    "configurable": {
        "thread_id": "2",      # æ–°ä¼šè¯
        "user_id": "Lance"     # ç›¸åŒç”¨æˆ·
    }
}

# ç”¨æˆ·è¾“å…¥
input_messages = [HumanMessage(
    content="I have 30 minutes, what tasks can I get done?"
)]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
I have 30 minutes, what tasks can I get done?

================================== Ai Message ==================================
You can work on the following tasks that fit within your 30-minute timeframe:

1. **Book swim lessons for your 1-year-old daughter.**
   - Estimated time to complete: 30 minutes
   - Solutions include checking local swim schools in SF, looking for baby swim classes online,
     asking friends for recommendations, contacting La Petite Baleen Swim School,
     or checking with SF Recreation and Parks for classes.

2. **Call back City Toyota to schedule car service.**
   - Estimated time to complete: 10 minutes
   - Solutions include finding City Toyota's contact number, checking car service availability,
     and preparing car details for service scheduling.

You can choose either of these tasks to complete within your available time.
```

**é•¿æœŸè®°å¿†çš„å¨åŠ›**ï¼š

- è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„ä¼šè¯ï¼ˆthread_id: "2"ï¼‰
- Agent ä»ç„¶è®°å¾—æ‰€æœ‰ ToDo é¡¹
- Agent æ ¹æ®æ—¶é—´é™åˆ¶ï¼ˆ30åˆ†é’Ÿï¼‰æ™ºèƒ½æ¨èä»»åŠ¡
- Agent æä¾›äº†è¯¦ç»†çš„è§£å†³æ–¹æ¡ˆ

ç»§ç»­å¯¹è¯ï¼š

```python
# ç”¨æˆ·è¾“å…¥
input_messages = [HumanMessage(
    content="Yes, give me some options to call for swim lessons."
)]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
Yes, give me some options to call for swim lessons.

================================== Ai Message ==================================
Here are some options you can consider for booking swim lessons for your 1-year-old daughter in San Francisco:

1. **La Petite Baleen Swim School**: Known for their baby swim classes,
   you can contact them to inquire about their schedule and availability.

2. **SF Recreation and Parks**: They often offer swim classes for young children.
   Check their website or contact them for more information.

3. **Local Swim Schools**: Search for other local swim schools in SF that offer baby swim classes.
   You might find some good options nearby.

4. **Ask Friends for Recommendations**: Reach out to friends or family in the area
   who might have experience with swim lessons for young children.

These options should help you get started on booking swim lessons.
```

**è·¨ä¼šè¯è¿è´¯æ€§**ï¼š

- Agent ç†è§£ä¸Šä¸‹æ–‡ï¼ˆ"Yes" æŒ‡çš„æ˜¯æ¸¸æ³³è¯¾ï¼‰
- æä¾›äº†ä¹‹å‰å­˜å‚¨çš„å…·ä½“å•†å®¶ä¿¡æ¯
- å¯¹è¯è‡ªç„¶æµç•…ï¼Œå°±åƒè¿ç»­å¯¹è¯ä¸€æ ·

---

## ä¸ƒã€Python çŸ¥è¯†ç‚¹æ€»ç»“

### 7.1 ç±»å‹æ³¨è§£ï¼ˆType Hintsï¼‰

```python
from typing import Optional, Literal, TypedDict

# åŸºç¡€ç±»å‹
name: str = "Alice"
age: int = 30
height: float = 1.75

# Optional - å¯é€‰ç±»å‹
middle_name: Optional[str] = None  # å¯ä»¥æ˜¯ str æˆ– None

# List - åˆ—è¡¨ç±»å‹
names: list[str] = ["Alice", "Bob"]

# Literal - å­—é¢é‡ç±»å‹
status: Literal["active", "inactive"] = "active"

# TypedDict - ç±»å‹åŒ–å­—å…¸
class Config(TypedDict):
    host: str
    port: int

config: Config = {"host": "localhost", "port": 8080}
```

**ä½œç”¨**ï¼š
- æä¾›ä»£ç è¡¥å…¨å’Œç±»å‹æ£€æŸ¥
- ä½¿ä»£ç æ›´æ˜“è¯»å’Œç»´æŠ¤
- å¸®åŠ©å‘ç°æ½œåœ¨é”™è¯¯

### 7.2 Pydantic æ¨¡å‹

```python
from pydantic import BaseModel, Field

class User(BaseModel):
    name: str = Field(description="ç”¨æˆ·å")
    age: int = Field(ge=0, le=150, description="å¹´é¾„")
    email: Optional[str] = None
    tags: list[str] = Field(default_factory=list)

# åˆ›å»ºå®ä¾‹
user = User(name="Alice", age=30)

# éªŒè¯ï¼ˆè‡ªåŠ¨è¿›è¡Œï¼‰
try:
    invalid_user = User(name="Bob", age=-5)  # ä¼šæŠ›å‡ºéªŒè¯é”™è¯¯
except ValueError as e:
    print(e)

# è½¬æ¢ä¸ºå­—å…¸
user_dict = user.model_dump()

# è½¬æ¢ä¸º JSON
user_json = user.model_dump_json()
```

**ä¼˜åŠ¿**ï¼š
- è‡ªåŠ¨æ•°æ®éªŒè¯
- æ¸…æ™°çš„æ•°æ®ç»“æ„
- æ˜“äºåºåˆ—åŒ–/ååºåˆ—åŒ–

### 7.3 åˆ—è¡¨æ¨å¯¼å¼å’Œç”Ÿæˆå™¨è¡¨è¾¾å¼

```python
# åˆ—è¡¨æ¨å¯¼å¼
squares = [x**2 for x in range(10)]
# [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]

# å¸¦æ¡ä»¶çš„åˆ—è¡¨æ¨å¯¼å¼
even_squares = [x**2 for x in range(10) if x % 2 == 0]
# [0, 4, 16, 36, 64]

# åµŒå¥—åˆ—è¡¨æ¨å¯¼å¼
matrix = [[i*j for j in range(3)] for i in range(3)]
# [[0, 0, 0], [0, 1, 2], [0, 2, 4]]

# ç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼ˆå†…å­˜é«˜æ•ˆï¼‰
gen = (x**2 for x in range(1000000))  # ä¸ç«‹å³è®¡ç®—
```

### 7.4 ç‰¹æ®Šæ–¹æ³•ï¼ˆMagic Methodsï¼‰

```python
class Counter:
    def __init__(self, start=0):
        """æ„é€ å‡½æ•° - åˆå§‹åŒ–å¯¹è±¡"""
        self.count = start

    def __call__(self):
        """ä½¿å¯¹è±¡å¯è°ƒç”¨"""
        self.count += 1
        return self.count

    def __str__(self):
        """å­—ç¬¦ä¸²è¡¨ç¤º - print()"""
        return f"Counter: {self.count}"

    def __repr__(self):
        """å¼€å‘è€…å‹å¥½çš„è¡¨ç¤º"""
        return f"Counter(start={self.count})"

# ä½¿ç”¨
counter = Counter(10)
print(counter())  # 11 - è°ƒç”¨ __call__
print(counter)    # Counter: 11 - è°ƒç”¨ __str__
```

### 7.5 å¸¸ç”¨å†…ç½®å‡½æ•°

```python
# enumerate - åŒæ—¶è·å–ç´¢å¼•å’Œå€¼
for i, item in enumerate(['a', 'b', 'c']):
    print(f"{i}: {item}")

# zip - å¹¶è¡Œè¿­ä»£
names = ['Alice', 'Bob']
ages = [25, 30]
for name, age in zip(names, ages):
    print(f"{name} is {age}")

# any/all - é€»è¾‘åˆ¤æ–­
all([True, True, True])   # True
any([False, True, False]) # True

# map - æ˜ å°„å‡½æ•°
squares = list(map(lambda x: x**2, [1, 2, 3]))  # [1, 4, 9]

# filter - è¿‡æ»¤
evens = list(filter(lambda x: x % 2 == 0, [1, 2, 3, 4]))  # [2, 4]
```

### 7.6 å­—ç¬¦ä¸²æ“ä½œ

```python
# f-string - æ ¼å¼åŒ–å­—ç¬¦ä¸²
name = "Alice"
age = 30
print(f"{name} is {age} years old")

# join - è¿æ¥å­—ç¬¦ä¸²
words = ["Hello", "World"]
sentence = " ".join(words)  # "Hello World"

# split - åˆ†å‰²å­—ç¬¦ä¸²
sentence = "Hello World"
words = sentence.split()  # ["Hello", "World"]

# å¤šè¡Œå­—ç¬¦ä¸²
text = """
Line 1
Line 2
Line 3
"""
```

---

## å…«ã€LangGraph çŸ¥è¯†ç‚¹æ€»ç»“

### 8.1 æ ¸å¿ƒæ¦‚å¿µ

#### 8.1.1 çŠ¶æ€ï¼ˆStateï¼‰

```python
from langgraph.graph import MessagesState

# MessagesState æ˜¯å†…ç½®çš„çŠ¶æ€ç±»å‹
# åŒ…å« messages å­—æ®µï¼ˆæ¶ˆæ¯åˆ—è¡¨ï¼‰
state = {
    "messages": [
        HumanMessage(content="Hi"),
        AIMessage(content="Hello!")
    ]
}

# è‡ªå®šä¹‰çŠ¶æ€
from typing import TypedDict, Annotated
from langgraph.graph import add_messages

class CustomState(TypedDict):
    messages: Annotated[list, add_messages]  # ä½¿ç”¨ reducer
    user_info: dict
    counter: int
```

**Reducerï¼ˆå½’çº¦å™¨ï¼‰**ï¼š
- `add_messages`ï¼šæ™ºèƒ½åˆå¹¶æ¶ˆæ¯åˆ—è¡¨
- è‡ªå®šä¹‰ reducerï¼šæ§åˆ¶çŠ¶æ€æ›´æ–°é€»è¾‘

#### 8.1.2 èŠ‚ç‚¹ï¼ˆNodesï¼‰

```python
def my_node(state: MessagesState, config: RunnableConfig, store: BaseStore):
    """
    èŠ‚ç‚¹å‡½æ•°ç­¾åï¼š
    - state: å½“å‰çŠ¶æ€
    - config: è¿è¡Œé…ç½®ï¼ˆå¯é€‰ï¼‰
    - store: æŒä¹…åŒ–å­˜å‚¨ï¼ˆå¯é€‰ï¼‰

    è¿”å›å€¼ï¼šçŠ¶æ€æ›´æ–°ï¼ˆå­—å…¸ï¼‰
    """
    # å¤„ç†é€»è¾‘
    result = some_operation(state["messages"])

    # è¿”å›çŠ¶æ€æ›´æ–°
    return {"messages": [AIMessage(content=result)]}
```

#### 8.1.3 è¾¹ï¼ˆEdgesï¼‰

```python
from langgraph.graph import StateGraph, START, END

builder = StateGraph(MessagesState)

# 1. ç¡®å®šæ€§è¾¹
builder.add_edge(START, "node1")      # å¼€å§‹ â†’ node1
builder.add_edge("node1", "node2")    # node1 â†’ node2
builder.add_edge("node2", END)        # node2 â†’ ç»“æŸ

# 2. æ¡ä»¶è¾¹
def router(state):
    if some_condition(state):
        return "path_a"
    else:
        return "path_b"

builder.add_conditional_edges(
    "decision_node",  # ä»å“ªä¸ªèŠ‚ç‚¹
    router,           # è·¯ç”±å‡½æ•°
    {                 # è·¯ç”±æ˜ å°„ï¼ˆå¯é€‰ï¼‰
        "path_a": "node_a",
        "path_b": "node_b"
    }
)
```

### 8.2 è®°å¿†ç³»ç»Ÿ

#### 8.2.1 Checkpointerï¼ˆçŸ­æœŸè®°å¿†ï¼‰

```python
from langgraph.checkpoint.memory import MemorySaver

# åœ¨å†…å­˜ä¸­ä¿å­˜æ£€æŸ¥ç‚¹
checkpointer = MemorySaver()

# ç¼–è¯‘æ—¶ä¼ å…¥
graph = builder.compile(checkpointer=checkpointer)

# ä½¿ç”¨ thread_id åŒºåˆ†ä¸åŒä¼šè¯
config = {"configurable": {"thread_id": "session_1"}}
graph.invoke(input, config)
```

**ä½œç”¨**ï¼š
- ä¿å­˜å¯¹è¯å†å²
- æ”¯æŒä¸­æ–­å’Œæ¢å¤
- å®ç°å¤šè½®å¯¹è¯

#### 8.2.2 Storeï¼ˆé•¿æœŸè®°å¿†ï¼‰

```python
from langgraph.store.memory import InMemoryStore

store = InMemoryStore()

# ä¿å­˜æ•°æ®
store.put(
    namespace=("profile", "user_123"),  # å‘½åç©ºé—´ï¼ˆåˆ†å±‚ï¼‰
    key="basic_info",                   # é”®
    value={"name": "Alice", "age": 30}  # å€¼
)

# æ£€ç´¢æ•°æ®
item = store.get(
    namespace=("profile", "user_123"),
    key="basic_info"
)

# æœç´¢æ•°æ®
items = store.search(
    namespace=("profile", "user_123")
)
```

**Namespaceï¼ˆå‘½åç©ºé—´ï¼‰**ï¼š
- ä½¿ç”¨å…ƒç»„è¡¨ç¤ºå±‚çº§ç»“æ„
- ä¾‹å¦‚ï¼š`("profile", "user_id")`, `("todo", "user_id")`
- ä¾¿äºç»„ç»‡å’ŒæŸ¥è¯¢æ•°æ®

### 8.3 æµå¼æ‰§è¡Œ

```python
# stream - æµå¼æ‰§è¡Œ
for chunk in graph.stream(input_data, config, stream_mode="values"):
    # chunk æ˜¯æ¯æ¬¡çŠ¶æ€æ›´æ–°
    print(chunk)

# stream_mode é€‰é¡¹ï¼š
# - "values": å®Œæ•´çŠ¶æ€
# - "updates": ä»…æ›´æ–°éƒ¨åˆ†
# - "messages": ä»…æ¶ˆæ¯

# invoke - ä¸€æ¬¡æ€§æ‰§è¡Œ
result = graph.invoke(input_data, config)
```

### 8.4 å·¥å…·è°ƒç”¨ï¼ˆTool Callingï¼‰

```python
from langchain_core.tools import tool

@tool
def calculator(expression: str) -> float:
    """è®¡ç®—æ•°å­¦è¡¨è¾¾å¼"""
    return eval(expression)

# ç»‘å®šå·¥å…·åˆ°æ¨¡å‹
model_with_tools = model.bind_tools([calculator])

# è°ƒç”¨
response = model_with_tools.invoke("What is 2+2?")

# æ£€æŸ¥å·¥å…·è°ƒç”¨
if response.tool_calls:
    for tool_call in response.tool_calls:
        print(tool_call['name'])  # å·¥å…·å
        print(tool_call['args'])  # å‚æ•°
        print(tool_call['id'])    # è°ƒç”¨ ID
```

### 8.5 å®Œæ•´ç¤ºä¾‹

```python
from langgraph.graph import StateGraph, MessagesState, START, END
from langgraph.checkpoint.memory import MemorySaver

# 1. å®šä¹‰èŠ‚ç‚¹
def chatbot(state: MessagesState):
    response = model.invoke(state["messages"])
    return {"messages": [response]}

# 2. æ„å»ºå›¾
builder = StateGraph(MessagesState)
builder.add_node("chatbot", chatbot)
builder.add_edge(START, "chatbot")
builder.add_edge("chatbot", END)

# 3. ç¼–è¯‘
graph = builder.compile(checkpointer=MemorySaver())

# 4. è¿è¡Œ
config = {"configurable": {"thread_id": "1"}}
result = graph.invoke(
    {"messages": [HumanMessage(content="Hello!")]},
    config
)
```

---

## ä¹ã€æ¶æ„è®¾è®¡æ€è€ƒ

### 9.1 ä¸ºä»€ä¹ˆéœ€è¦æ¡ä»¶è¾¹ï¼Ÿ

æ¡ä»¶è¾¹å…è®¸ Agent æ ¹æ®æƒ…å†µåšå‡ºä¸åŒå†³ç­–ï¼š

```python
ç”¨æˆ·æ¶ˆæ¯ â†’ task_mAIstro â†’ [å†³ç­–]
                           â”œâ†’ ä¸éœ€è¦æ›´æ–° â†’ ç›´æ¥å“åº”
                           â”œâ†’ æ›´æ–° Profile â†’ ä¿å­˜ä¸ªäººä¿¡æ¯
                           â”œâ†’ æ›´æ–° ToDo â†’ ä¿å­˜ä»»åŠ¡
                           â””â†’ æ›´æ–° Instructions â†’ ä¿å­˜åå¥½
```

å¦‚æœæ²¡æœ‰æ¡ä»¶è¾¹ï¼ŒAgent è¦ä¹ˆï¼š
- æ¯æ¬¡éƒ½ä¿å­˜è®°å¿†ï¼ˆæµªè´¹èµ„æºï¼‰
- ä»ä¸ä¿å­˜è®°å¿†ï¼ˆæ— æ³•å­¦ä¹ ï¼‰

### 9.2 ä¸ºä»€ä¹ˆæ›´æ–°åè¦è¿”å› task_mAIstroï¼Ÿ

```python
builder.add_edge("update_todos", "task_mAIstro")
```

è¿™å½¢æˆäº†ä¸€ä¸ªå¾ªç¯ï¼š

```
task_mAIstro â†’ update_todos â†’ task_mAIstro â†’ [ç»“æŸæˆ–ç»§ç»­]
```

**åŸå› **ï¼š
1. **ç”Ÿæˆè‡ªç„¶è¯­è¨€å“åº”**ï¼šæ›´æ–°è®°å¿†åéœ€è¦å‘Šè¯‰ç”¨æˆ·
2. **å¯èƒ½éœ€è¦å¤šæ¬¡æ›´æ–°**ï¼šä¸€æ¬¡å¯¹è¯å¯èƒ½è§¦å‘å¤šä¸ªæ›´æ–°
3. **ä¿æŒå¯¹è¯æµç•…**ï¼šè®© Agent æœ‰æœºä¼šç»§ç»­äº¤äº’

### 9.3 ä¸ºä»€ä¹ˆ ToDo ä½¿ç”¨ Spyï¼Ÿ

```python
spy = Spy()
todo_extractor = create_extractor(...).with_listeners(on_end=spy)
```

**åŸå› **ï¼š
- ToDo é¡¹ç»å¸¸è¢«æ›´æ–°ï¼ˆæ·»åŠ ã€ä¿®æ”¹ã€å®Œæˆï¼‰
- ç”¨æˆ·éœ€è¦çŸ¥é“å…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–
- Spy æ•è· Trustcall çš„æ“ä½œï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰
- æä¾›è¯¦ç»†åé¦ˆç»™ç”¨æˆ·

**å¯¹æ¯”**ï¼š
- Profile æ›´æ–°ä¸å‘Šè¯‰ç”¨æˆ·ï¼ˆéšç§ï¼‰
- Instructions æ›´æ–°ä¸éœ€è¦è¯¦æƒ…ï¼ˆå†…éƒ¨é€»è¾‘ï¼‰
- ToDo æ›´æ–°éœ€è¦ç¡®è®¤ï¼ˆç”¨æˆ·ä¸»è¦å…³æ³¨ç‚¹ï¼‰

### 9.4 é•¿æœŸè®°å¿† vs çŸ­æœŸè®°å¿†

| ç‰¹æ€§ | çŸ­æœŸè®°å¿†ï¼ˆCheckpointerï¼‰ | é•¿æœŸè®°å¿†ï¼ˆStoreï¼‰ |
|------|------------------------|------------------|
| ä½œç”¨åŸŸ | å•ä¸ªä¼šè¯ï¼ˆthreadï¼‰ | è·¨ä¼šè¯ï¼ˆuserï¼‰ |
| å†…å®¹ | å¯¹è¯å†å² | ç»“æ„åŒ–çŸ¥è¯† |
| ç”Ÿå‘½å‘¨æœŸ | ä¼šè¯ç»“æŸå¯èƒ½æ¸…é™¤ | æŒä¹…ä¿å­˜ |
| æŸ¥è¯¢æ–¹å¼ | è‡ªåŠ¨åŠ è½½ | éœ€è¦ä¸»åŠ¨æŸ¥è¯¢ |
| ä½¿ç”¨åœºæ™¯ | ä¸Šä¸‹æ–‡ç†è§£ | ä¸ªæ€§åŒ–ã€çŸ¥è¯†ç§¯ç´¯ |

**è®¾è®¡åŸåˆ™**ï¼š
- çŸ­æœŸè®°å¿†ï¼šå¿«é€Ÿè®¿é—®ã€è‡ªåŠ¨ç®¡ç†
- é•¿æœŸè®°å¿†ï¼šç²¾å¿ƒç»„ç»‡ã€ä¸»åŠ¨æ£€ç´¢

---

## åã€å®è·µå»ºè®®

### 10.1 ä½•æ—¶ä½¿ç”¨ Memory Agent

é€‚ç”¨åœºæ™¯ï¼š
1. **éœ€è¦ä¸ªæ€§åŒ–**ï¼šè®°ä½ç”¨æˆ·åå¥½å’Œä¿¡æ¯
2. **é•¿æœŸäº¤äº’**ï¼šè·¨ä¼šè¯ä¿æŒè¿è´¯æ€§
3. **ä»»åŠ¡ç®¡ç†**ï¼šè·Ÿè¸ªå¾…åŠäº‹é¡¹ã€é¡¹ç›®ç­‰
4. **å­¦ä¹ ç”¨æˆ·ä¹ æƒ¯**ï¼šæ”¹è¿›å“åº”è´¨é‡

ä¸é€‚ç”¨åœºæ™¯ï¼š
1. **ä¸€æ¬¡æ€§æŸ¥è¯¢**ï¼šç®€å•é—®ç­”
2. **æ— çŠ¶æ€æœåŠ¡**ï¼šæ¯æ¬¡è¯·æ±‚ç‹¬ç«‹
3. **é«˜éšç§è¦æ±‚**ï¼šä¸èƒ½ä¿å­˜ç”¨æˆ·æ•°æ®

### 10.2 æ•°æ®æ¨¡å¼è®¾è®¡åŸåˆ™

1. **æ˜ç¡®çš„å­—æ®µæè¿°**ï¼š
   ```python
   name: str = Field(description="ç”¨æˆ·çš„å…¨åï¼ŒåŒ…æ‹¬å§“å’Œå")
   ```

2. **åˆç†çš„é»˜è®¤å€¼**ï¼š
   ```python
   status: Literal["not started", "in progress", "done"] = "not started"
   ```

3. **é€‚å½“çš„éªŒè¯è§„åˆ™**ï¼š
   ```python
   age: int = Field(ge=0, le=150)  # å¹´é¾„åœ¨ 0-150 ä¹‹é—´
   ```

4. **ä½¿ç”¨ `default_factory` é¿å…å¯å˜é»˜è®¤å€¼**ï¼š
   ```python
   # æ­£ç¡®
   tags: list[str] = Field(default_factory=list)

   # é”™è¯¯ï¼ˆæ‰€æœ‰å®ä¾‹å…±äº«åŒä¸€ä¸ªåˆ—è¡¨ï¼‰
   tags: list[str] = Field(default=[])
   ```

### 10.3 æç¤ºè¯å·¥ç¨‹æŠ€å·§

1. **æ¸…æ™°çš„è§’è‰²å®šä¹‰**ï¼š
   ```
   You are a helpful chatbot designed to...
   ```

2. **æä¾›å……åˆ†ä¸Šä¸‹æ–‡**ï¼š
   ```xml
   <user_profile>
   {profile}
   </user_profile>
   ```

3. **æ˜ç¡®çš„æŒ‡ä»¤åˆ—è¡¨**ï¼š
   ```
   1. Do this
   2. Then do that
   3. Finally do this
   ```

4. **ç¤ºä¾‹å’Œæ ¼å¼**ï¼š
   ```
   For example: "User lives in San Francisco" â†’ location: "San Francisco"
   ```

### 10.4 è°ƒè¯•æŠ€å·§

1. **ä½¿ç”¨ LangSmith è¿½è¸ª**ï¼š
   ```python
   os.environ["LANGSMITH_TRACING"] = "true"
   ```

2. **æ‰“å°ä¸­é—´çŠ¶æ€**ï¼š
   ```python
   for chunk in graph.stream(...):
       print(chunk)  # æŸ¥çœ‹æ¯æ­¥çš„çŠ¶æ€
   ```

3. **ä½¿ç”¨ Spy ç›‘æ§å·¥å…·è°ƒç”¨**ï¼š
   ```python
   spy = Spy()
   extractor.with_listeners(on_end=spy)
   print(spy.called_tools)  # æŸ¥çœ‹å®é™…è°ƒç”¨
   ```

4. **å¯è§†åŒ–å›¾ç»“æ„**ï¼š
   ```python
   from IPython.display import Image
   display(Image(graph.get_graph().draw_mermaid_png()))
   ```

---

## åä¸€ã€æ‰©å±•æ€è€ƒ

### 11.1 å¯èƒ½çš„æ”¹è¿›

1. **æ›´ä¸°å¯Œçš„ ToDo åŠŸèƒ½**ï¼š
   - ä»»åŠ¡ä¼˜å…ˆçº§
   - å­ä»»åŠ¡
   - æ ‡ç­¾å’Œåˆ†ç±»
   - é‡å¤ä»»åŠ¡

2. **æ™ºèƒ½æé†’**ï¼š
   - åŸºäºæˆªæ­¢æ—¥æœŸçš„æé†’
   - åŸºäºä¸Šä¸‹æ–‡çš„å»ºè®®ï¼ˆ"ä½ ç°åœ¨æœ‰ç©ºï¼Œè¦ä¸è¦...ï¼Ÿ"ï¼‰

3. **åä½œåŠŸèƒ½**ï¼š
   - åˆ†äº«ä»»åŠ¡ç»™å…¶ä»–ç”¨æˆ·
   - å›¢é˜Ÿå¾…åŠäº‹é¡¹

4. **æ•°æ®æŒä¹…åŒ–**ï¼š
   - ä½¿ç”¨çœŸå®æ•°æ®åº“ï¼ˆPostgreSQLã€MongoDBï¼‰
   - è€Œä¸æ˜¯ InMemoryStore

5. **æ›´å¤æ‚çš„è®°å¿†ç®¡ç†**ï¼š
   - è®°å¿†çš„é‡è¦æ€§è¯„åˆ†
   - è‡ªåŠ¨å½’æ¡£æ—§è®°å¿†
   - è®°å¿†çš„å…³è”å’Œç´¢å¼•

### 11.2 å®‰å…¨å’Œéšç§è€ƒè™‘

1. **æ•°æ®åŠ å¯†**ï¼š
   - æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
   - ä¼ è¾“å±‚åŠ å¯†

2. **è®¿é—®æ§åˆ¶**ï¼š
   - ç”¨æˆ·èº«ä»½éªŒè¯
   - ç»†ç²’åº¦æƒé™ç®¡ç†

3. **æ•°æ®ä¿ç•™æ”¿ç­–**ï¼š
   - è‡ªåŠ¨åˆ é™¤è¿‡æœŸæ•°æ®
   - ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„æ•°æ®

4. **å®¡è®¡æ—¥å¿—**ï¼š
   - è®°å½•æ‰€æœ‰æ•°æ®è®¿é—®
   - ç›‘æ§å¼‚å¸¸è¡Œä¸º

### 11.3 æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜**ï¼š
   - ç¼“å­˜é¢‘ç¹è®¿é—®çš„è®°å¿†
   - å‡å°‘æ•°æ®åº“æŸ¥è¯¢

2. **æ‰¹å¤„ç†**ï¼š
   - æ‰¹é‡æ›´æ–°å¤šä¸ªè®°å¿†
   - å‡å°‘ç½‘ç»œå¾€è¿”

3. **å¼‚æ­¥å¤„ç†**ï¼š
   - éé˜»å¡çš„è®°å¿†æ›´æ–°
   - åå°ä»»åŠ¡å¤„ç†

4. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºç´¢å¼•
   - ä½¿ç”¨å…¨æ–‡æœç´¢

---

## åäºŒã€æ€»ç»“

### 12.1 æ ¸å¿ƒè¦ç‚¹

1. **Memory Agent** æ˜¯å…·å¤‡é•¿æœŸè®°å¿†èƒ½åŠ›çš„æ™ºèƒ½ä½“ï¼Œå¯ä»¥è·¨ä¼šè¯ä¿æŒçŠ¶æ€

2. **ä¸‰ç§è®°å¿†ç±»å‹**ï¼š
   - è¯­ä¹‰è®°å¿†ï¼šäº‹å®å’ŒçŸ¥è¯†ï¼ˆProfileã€ToDoï¼‰
   - ç¨‹åºæ€§è®°å¿†ï¼šè¡Œä¸ºè§„åˆ™ï¼ˆInstructionsï¼‰
   - çŸ­æœŸ vs é•¿æœŸè®°å¿†

3. **Trustcall** æä¾›ç»“æ„åŒ–æ•°æ®æå–å’Œæ›´æ–°èƒ½åŠ›ï¼š
   - è‡ªåŠ¨ä»å¯¹è¯ä¸­æå–æ•°æ®
   - ä½¿ç”¨ JSON Patch æ›´æ–°ç°æœ‰è®°å½•
   - æ”¯æŒå¹¶è¡Œæ“ä½œ

4. **LangGraph** æä¾›çµæ´»çš„çŠ¶æ€ç®¡ç†å’Œæµç¨‹æ§åˆ¶ï¼š
   - çŠ¶æ€å›¾æ¶æ„
   - æ¡ä»¶è¾¹å®ç°æ™ºèƒ½è·¯ç”±
   - Checkpointer å’Œ Store åˆ†åˆ«ç®¡ç†çŸ­æœŸå’Œé•¿æœŸè®°å¿†

5. **ReAct æ¶æ„**ï¼šAgent å¯ä»¥ï¼š
   - æ¨ç†ï¼ˆReasoningï¼‰ï¼šåˆ†æç”¨æˆ·è¾“å…¥
   - è¡ŒåŠ¨ï¼ˆActingï¼‰ï¼šè°ƒç”¨å·¥å…·æ›´æ–°è®°å¿†
   - è§‚å¯Ÿï¼ˆObservingï¼‰ï¼šæŸ¥çœ‹å·¥å…·ç»“æœå¹¶å“åº”

### 12.2 å­¦åˆ°çš„æŠ€èƒ½

**Python æŠ€èƒ½**ï¼š
- Pydantic æ¨¡å‹å®šä¹‰å’ŒéªŒè¯
- ç±»å‹æ³¨è§£å’Œç±»å‹ç³»ç»Ÿ
- åˆ—è¡¨æ¨å¯¼å¼å’Œç”Ÿæˆå™¨
- ç‰¹æ®Šæ–¹æ³•ï¼ˆ`__init__`, `__call__`ï¼‰
- è£…é¥°å™¨å’Œç›‘å¬å™¨æ¨¡å¼

**LangChain/LangGraph æŠ€èƒ½**ï¼š
- æ„å»ºçŠ¶æ€å›¾
- å®šä¹‰èŠ‚ç‚¹å’Œè¾¹
- æ¡ä»¶è·¯ç”±
- å·¥å…·è°ƒç”¨
- è®°å¿†ç®¡ç†ï¼ˆCheckpointer å’Œ Storeï¼‰
- æµå¼æ‰§è¡Œ

**AI å·¥ç¨‹æŠ€èƒ½**ï¼š
- æç¤ºè¯å·¥ç¨‹
- Agent æ¶æ„è®¾è®¡
- æ•°æ®æ¨¡å¼è®¾è®¡
- è°ƒè¯•å’Œè¿½è¸ª

### 12.3 ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹ ï¼š
1. **Module-5 çš„å…¶ä»–éƒ¨åˆ†**ï¼š
   - Memory Store è¯¦è§£
   - Memory Schemaï¼ˆProfile å’Œ Collectionï¼‰

2. **é«˜çº§ Agent æ¨¡å¼**ï¼š
   - å¤š Agent åä½œ
   - å·¥å…·çš„åŠ¨æ€é€‰æ‹©
   - æ›´å¤æ‚çš„å†³ç­–é€»è¾‘

3. **ç”Ÿäº§éƒ¨ç½²**ï¼š
   - ä½¿ç”¨çœŸå®æ•°æ®åº“
   - API è®¾è®¡
   - ç›‘æ§å’Œæ—¥å¿—
   - æ€§èƒ½ä¼˜åŒ–

---

## é™„å½•ï¼šå®Œæ•´ä»£ç æ¸…å•

### A.1 æ•°æ®æ¨¡å‹å®šä¹‰

```python
from pydantic import BaseModel, Field
from typing import Optional, Literal
from datetime import datetime

class Profile(BaseModel):
    """ç”¨æˆ·ä¸ªäººèµ„æ–™"""
    name: Optional[str] = Field(description="ç”¨æˆ·å§“å", default=None)
    location: Optional[str] = Field(description="ç”¨æˆ·ä½ç½®", default=None)
    job: Optional[str] = Field(description="ç”¨æˆ·èŒä¸š", default=None)
    connections: list[str] = Field(
        description="ä¸ªäººå…³ç³»ï¼ˆå®¶äººã€æœ‹å‹ã€åŒäº‹ï¼‰",
        default_factory=list
    )
    interests: list[str] = Field(
        description="ç”¨æˆ·å…´è¶£",
        default_factory=list
    )

class ToDo(BaseModel):
    """å¾…åŠäº‹é¡¹"""
    task: str = Field(description="ä»»åŠ¡æè¿°")
    time_to_complete: Optional[int] = Field(
        description="é¢„è®¡å®Œæˆæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰"
    )
    deadline: Optional[datetime] = Field(
        description="æˆªæ­¢æ—¥æœŸ",
        default=None
    )
    solutions: list[str] = Field(
        description="å…·ä½“å¯è¡Œçš„è§£å†³æ–¹æ¡ˆåˆ—è¡¨",
        min_items=1,
        default_factory=list
    )
    status: Literal["not started", "in progress", "done", "archived"] = Field(
        description="ä»»åŠ¡çŠ¶æ€",
        default="not started"
    )

class UpdateMemory(TypedDict):
    """æ›´æ–°è®°å¿†å·¥å…·"""
    update_type: Literal['user', 'todo', 'instructions']
```

### A.2 è¾…åŠ©å·¥å…·

```python
class Spy:
    """ç›‘æ§å·¥å…·è°ƒç”¨"""
    def __init__(self):
        self.called_tools = []

    def __call__(self, run):
        q = [run]
        while q:
            r = q.pop()
            if r.child_runs:
                q.extend(r.child_runs)
            if r.run_type == "chat_model":
                self.called_tools.append(
                    r.outputs["generations"][0][0]["message"]["kwargs"]["tool_calls"]
                )

def extract_tool_info(tool_calls, schema_name="Memory"):
    """æå–å·¥å…·è°ƒç”¨ä¿¡æ¯"""
    changes = []

    for call_group in tool_calls:
        for call in call_group:
            if call['name'] == 'PatchDoc':
                changes.append({
                    'type': 'update',
                    'doc_id': call['args']['json_doc_id'],
                    'planned_edits': call['args']['planned_edits'],
                    'value': call['args']['patches'][0]['value']
                })
            elif call['name'] == schema_name:
                changes.append({
                    'type': 'new',
                    'value': call['args']
                })

    result_parts = []
    for change in changes:
        if change['type'] == 'update':
            result_parts.append(
                f"Document {change['doc_id']} updated:\n"
                f"Plan: {change['planned_edits']}\n"
                f"Added content: {change['value']}"
            )
        else:
            result_parts.append(
                f"New {schema_name} created:\n"
                f"Content: {change['value']}"
            )

    return "\n\n".join(result_parts)
```

### A.3 ç³»ç»Ÿæç¤ºè¯

```python
MODEL_SYSTEM_MESSAGE = """You are a helpful chatbot.

You are designed to be a companion to a user, helping them keep track of their ToDo list.

You have a long term memory which keeps track of three things:
1. The user's profile (general information about them)
2. The user's ToDo list
3. General instructions for updating the ToDo list

Here is the current User Profile:
<user_profile>
{user_profile}
</user_profile>

Here is the current ToDo List:
<todo>
{todo}
</todo>

Here are the current user-specified preferences:
<instructions>
{instructions}
</instructions>

Instructions:
1. Reason carefully about the user's messages
2. Decide whether to update long-term memory:
   - Personal info â†’ UpdateMemory tool with type `user`
   - Tasks â†’ UpdateMemory tool with type `todo`
   - Preferences â†’ UpdateMemory tool with type `instructions`
3. Tell the user about todo updates (not profile or instructions)
4. Err on the side of updating the todo list
5. Respond naturally to the user"""

TRUSTCALL_INSTRUCTION = """Reflect on following interaction.

Use the provided tools to retain any necessary memories about the user.

Use parallel tool calling to handle updates and insertions simultaneously.

System Time: {time}"""

CREATE_INSTRUCTIONS = """Reflect on the following interaction.

Based on this interaction, update your instructions for how to update ToDo list items.

Use any feedback from the user to update how they like to have items added.

Your current instructions are:
<current_instructions>
{current_instructions}
</current_instructions>"""
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
**æœ€åæ›´æ–°**ï¼š2024-11-04
**ä½œè€…**ï¼šAI Assistant
**åŸºäº**ï¼šLangChain Academy Module-5 Lesson 5.1

å¸Œæœ›è¿™ä»½è¯¦ç»†è§£è¯»èƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£ LangGraph çš„ Memory Agent ç³»ç»Ÿï¼
