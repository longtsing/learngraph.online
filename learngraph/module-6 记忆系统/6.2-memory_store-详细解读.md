# 5.2 Memory Store - è¯¦ç»†è§£è¯»

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­åç§° | LangGraph å®šä¹‰å’Œè§£è¯» | Python å®šä¹‰å’Œè¯´æ˜ | é‡è¦ç¨‹åº¦ |
|---------|---------------------|------------------|---------|
| **Store** | LangGraph ä¸­ç”¨äºè·¨çº¿ç¨‹ï¼ˆä¼šè¯ï¼‰å­˜å‚¨å’Œæ£€ç´¢ä¿¡æ¯çš„æŒä¹…åŒ–é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œæ”¯æŒå‘½åç©ºé—´åˆ†å±‚ç»„ç»‡ | å®ç° BaseStore æ¥å£çš„å­˜å‚¨åç«¯ï¼Œå¦‚ InMemoryStoreï¼ˆå†…å­˜ï¼‰æˆ– PostgresStoreï¼ˆæ•°æ®åº“ï¼‰ | â­â­â­â­â­ |
| **InMemoryStore** | åœ¨å†…å­˜ä¸­ä¿å­˜æ•°æ®çš„ Store å®ç°ï¼Œé€‚åˆå¼€å‘å’Œæµ‹è¯•ï¼Œæ•°æ®åœ¨è¿›ç¨‹é‡å¯åä¸¢å¤± | Python ç±»ï¼Œç»§æ‰¿è‡ª BaseStoreï¼Œä½¿ç”¨å†…å­˜å­—å…¸å­˜å‚¨æ•°æ® | â­â­â­â­ |
| **Namespaceï¼ˆå‘½åç©ºé—´ï¼‰** | ç”¨å…ƒç»„è¡¨ç¤ºçš„åˆ†å±‚ç»“æ„ï¼Œç±»ä¼¼æ–‡ä»¶ç³»ç»Ÿç›®å½•ï¼Œç”¨äºç»„ç»‡å’Œéš”ç¦»ä¸åŒç”¨æˆ·æˆ–ç±»å‹çš„æ•°æ® | Python å…ƒç»„ç±»å‹ï¼Œå¦‚ `("user_1", "memories")`ï¼Œä½œä¸ºæ•°æ®åˆ†ç»„çš„é”® | â­â­â­â­â­ |
| **Keyï¼ˆé”®ï¼‰** | åœ¨å‘½åç©ºé—´å†…æ ‡è¯†ç‰¹å®šå¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ˜¯å›ºå®šåç§°æˆ– UUID | Python å­—ç¬¦ä¸²ç±»å‹ï¼Œå¦‚ `"user_memory"` æˆ– `str(uuid.uuid4())` | â­â­â­â­â­ |
| **Valueï¼ˆå€¼ï¼‰** | Store ä¸­å­˜å‚¨çš„å®é™…æ•°æ®ï¼Œå¿…é¡»æ˜¯ Python å­—å…¸ç±»å‹ï¼Œå¯åŒ…å«ä»»æ„å¯åºåˆ—åŒ–çš„æ•°æ® | Python dict ç±»å‹ï¼Œå¦‚ `{"memory": "User's name is Lance"}` | â­â­â­â­â­ |
| **put() æ–¹æ³•** | Store çš„ä¿å­˜æ“ä½œï¼Œå°†æ•°æ®å†™å…¥æŒ‡å®šçš„å‘½åç©ºé—´å’Œé”®ï¼Œå¦‚æœé”®å·²å­˜åœ¨åˆ™è¦†ç›– | æ–¹æ³•ç­¾åï¼š`put(namespace: tuple, key: str, value: dict) -> None` | â­â­â­â­â­ |
| **get() æ–¹æ³•** | Store çš„ç²¾ç¡®è·å–æ“ä½œï¼Œé€šè¿‡å‘½åç©ºé—´å’Œé”®è·å–ç‰¹å®šçš„å•ä¸ªå¯¹è±¡ | æ–¹æ³•ç­¾åï¼š`get(namespace: tuple, key: str) -> Item`ï¼Œè¿”å› Item å¯¹è±¡æˆ– None | â­â­â­â­â­ |
| **search() æ–¹æ³•** | Store çš„æœç´¢æ“ä½œï¼Œè¿”å›æŒ‡å®šå‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰å¯¹è±¡åˆ—è¡¨ | æ–¹æ³•ç­¾åï¼š`search(namespace: tuple) -> list[Item]`ï¼Œéå†è¯¥å‘½åç©ºé—´ | â­â­â­â­â­ |
| **çŸ­æœŸè®°å¿†ï¼ˆWithin-Threadï¼‰** | ä½¿ç”¨ MemorySaver (Checkpointer) å®ç°çš„å•æ¬¡ä¼šè¯è®°å¿†ï¼Œä¿å­˜å¯¹è¯å†å²å’ŒçŠ¶æ€ | é€šè¿‡ thread_id æ ‡è¯†ï¼Œå­˜å‚¨åœ¨ checkpoint ä¸­ï¼Œä¼šè¯æœŸé—´æœ‰æ•ˆ | â­â­â­â­â­ |
| **é•¿æœŸè®°å¿†ï¼ˆAcross-Threadï¼‰** | ä½¿ç”¨ InMemoryStore (Store) å®ç°çš„è·¨ä¼šè¯è®°å¿†ï¼ŒæŒä¹…åŒ–ä¿å­˜ç”¨æˆ·ä¿¡æ¯ | é€šè¿‡ namespace + key æ ‡è¯†ï¼Œè·¨æ‰€æœ‰ä¼šè¯å…±äº«å’Œè®¿é—® | â­â­â­â­â­ |
| **è¯­ä¹‰è®°å¿†ï¼ˆSemantic Memoryï¼‰** | å…³äºäº‹å®å’ŒçŸ¥è¯†çš„è®°å¿†ï¼Œå¦‚ç”¨æˆ·å§“åã€ä½ç½®ã€å…´è¶£ç­‰ç»“æ„åŒ–ä¿¡æ¯ | å­˜å‚¨åœ¨ Store ä¸­çš„å­—å…¸æ•°æ®ï¼Œå¦‚ `{"user_name": "Lance", "interests": ["biking"]}` | â­â­â­â­ |
| **çƒ­è·¯å¾„ï¼ˆHot Pathï¼‰** | åœ¨ç”¨æˆ·ç­‰å¾…å“åº”çš„è¿‡ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œï¼Œå¦‚å®æ—¶ä¿å­˜è®°å¿†ï¼ˆåŒæ­¥å¤„ç†ï¼‰ | åœ¨ä¸»æ‰§è¡Œæµç¨‹ä¸­è°ƒç”¨çš„å‡½æ•°ï¼Œä¼šå¢åŠ ç”¨æˆ·æ„ŸçŸ¥çš„å»¶è¿Ÿ | â­â­â­ |

---

## ä¸€ã€æ¦‚è¿°

### 1.1 æœ¬èŠ‚ç®€ä»‹

æœ¬èŠ‚æ˜¯ LangChain Academy Module-5 çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œä¸»è¦å†…å®¹æ˜¯æ·±å…¥ç†è§£ **LangGraph Memory Store**ï¼ˆè®°å¿†å­˜å‚¨ç³»ç»Ÿï¼‰ã€‚è¿™æ˜¯æ„å»ºå…·æœ‰é•¿æœŸè®°å¿†èƒ½åŠ›çš„ AI åº”ç”¨çš„åŸºç¡€ç»„ä»¶ã€‚

ä¸ 5.1 èŠ‚ç›¸æ¯”ï¼Œæœ¬èŠ‚æ›´åŠ **åŸºç¡€å’Œèšç„¦**ï¼š
- **5.1** æ„å»ºäº†ä¸€ä¸ªå¤æ‚çš„ Memory Agentï¼ˆtask_mAIstroï¼‰ï¼Œæ¶‰åŠå¤šç§è®°å¿†ç±»å‹ã€Trustcallã€æ¡ä»¶è·¯ç”±ç­‰
- **5.2** ä¸“æ³¨äº Store çš„åŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ï¼Œæ„å»ºä¸€ä¸ªç®€å•ä½†å®Œæ•´çš„è®°å¿†èŠå¤©æœºå™¨äºº

### 1.2 å­¦ä¹ ç›®æ ‡

é€šè¿‡å­¦ä¹ æœ¬èŠ‚å†…å®¹ï¼Œä½ å°†æŒæ¡ï¼š

1. **LangGraph Store çš„æ ¸å¿ƒæ¦‚å¿µ**ï¼šnamespaceã€keyã€value
2. **Store çš„ä¸‰ä¸ªåŸºæœ¬æ“ä½œ**ï¼šputï¼ˆä¿å­˜ï¼‰ã€getï¼ˆè·å–ï¼‰ã€searchï¼ˆæœç´¢ï¼‰
3. **çŸ­æœŸè®°å¿†ä¸é•¿æœŸè®°å¿†çš„åä½œ**ï¼šCheckpointer + Store
4. **åœ¨çƒ­è·¯å¾„ä¸­ä¿å­˜è®°å¿†**ï¼š"çƒ­è·¯å¾„"æ„å‘³ç€åœ¨ç”¨æˆ·èŠå¤©æ—¶å®æ—¶ä¿å­˜ï¼Œè€Œä¸æ˜¯å¼‚æ­¥åå°å¤„ç†
5. **è·¨ä¼šè¯è®°å¿†**ï¼šå¦‚ä½•è®© AI åœ¨ä¸åŒå¯¹è¯ä¼šè¯ä¸­è®°ä½ç”¨æˆ·ä¿¡æ¯

### 1.3 å®é™…åº”ç”¨åœºæ™¯

è¿™ç§è®°å¿†ç³»ç»Ÿé€‚ç”¨äºï¼š
- **ä¸ªæ€§åŒ–å®¢æœæœºå™¨äºº**ï¼šè®°ä½ç”¨æˆ·çš„åå¥½å’Œå†å²é—®é¢˜
- **ä¸ªäººåŠ©ç†åº”ç”¨**ï¼šè®°ä½ç”¨æˆ·çš„ä¹ æƒ¯ã€æ—¥ç¨‹å®‰æ’
- **æ•™è‚²è¾…å¯¼ç³»ç»Ÿ**ï¼šè®°ä½å­¦ç”Ÿçš„å­¦ä¹ è¿›åº¦å’Œå¼±ç‚¹
- **åŒ»ç–—å¥åº·åº”ç”¨**ï¼šè®°ä½æ‚£è€…çš„ç—…å²å’Œæ²»ç–—åå¥½

---

## äºŒã€è®°å¿†ï¼ˆMemoryï¼‰çš„è®¤çŸ¥ç§‘å­¦åŸºç¡€

### 2.1 ä»€ä¹ˆæ˜¯è®°å¿†ï¼Ÿ

æ ¹æ®[è®¤çŸ¥ç§‘å­¦ç ”ç©¶](https://pmc.ncbi.nlm.nih.gov/articles/PMC10410470/)ï¼Œ**è®°å¿†**æ˜¯ä¸€ç§è®¤çŸ¥åŠŸèƒ½ï¼Œå…è®¸äººä»¬å­˜å‚¨ã€æ£€ç´¢å’Œä½¿ç”¨ä¿¡æ¯æ¥ç†è§£ç°åœ¨å’Œæœªæ¥ã€‚

åœ¨ AI åº”ç”¨ä¸­ï¼Œè®°å¿†ç³»ç»Ÿæ¨¡æ‹Ÿäº†äººç±»è®°å¿†çš„æŸäº›ç‰¹å¾ï¼š
- **å­˜å‚¨**ï¼šä¿å­˜é‡è¦ä¿¡æ¯
- **æ£€ç´¢**ï¼šåœ¨éœ€è¦æ—¶æ‰¾åˆ°ç›¸å…³ä¿¡æ¯
- **åº”ç”¨**ï¼šä½¿ç”¨è®°å¿†æ¥ä¸ªæ€§åŒ–å“åº”

### 2.2 é•¿æœŸè®°å¿†çš„ç±»å‹

åœ¨ AI åº”ç”¨ä¸­ï¼Œ[é•¿æœŸè®°å¿†](https://langchain-ai.github.io/langgraph/concepts/memory/#memory)å¯ä»¥åˆ†ä¸ºå‡ ç§ç±»å‹ï¼š

#### è¯­ä¹‰è®°å¿†ï¼ˆSemantic Memoryï¼‰
å…³äº**äº‹å®å’ŒçŸ¥è¯†**çš„è®°å¿†ï¼š
- ç”¨æˆ·çš„å§“åã€ä½ç½®ã€èŒä¸š
- ç”¨æˆ·çš„å…´è¶£å’Œçˆ±å¥½
- å†å²äº‹ä»¶å’Œäº‹å®

**æœ¬èŠ‚é‡ç‚¹**ï¼šæˆ‘ä»¬å°†ä¸“æ³¨äºæ„å»ºè¯­ä¹‰è®°å¿†ç³»ç»Ÿï¼Œä¿å­˜å…³äºç”¨æˆ·çš„äº‹å®ä¿¡æ¯ã€‚

#### æƒ…èŠ‚è®°å¿†ï¼ˆEpisodic Memoryï¼‰
å…³äº**ç‰¹å®šäº‹ä»¶å’Œç»å†**çš„è®°å¿†ï¼š
- "ä¸Šå‘¨æˆ‘ä»¬è®¨è®ºäº†é¡¹ç›® A"
- "ä¸‰æ¬¡å¯¹è¯å‰ï¼Œä½ æåˆ°äº†..."

#### ç¨‹åºæ€§è®°å¿†ï¼ˆProcedural Memoryï¼‰
å…³äº**å¦‚ä½•åšæŸäº‹**çš„è®°å¿†ï¼š
- å¦‚ä½•æ ¼å¼åŒ–è¾“å‡º
- ç”¨æˆ·å–œæ¬¢çš„äº¤äº’æ–¹å¼

### 2.3 æœ¬èŠ‚çš„è®°å¿†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Chatbot with Memory                 â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  çŸ­æœŸè®°å¿†ï¼ˆWithin-Thread Memoryï¼‰          â”‚ â”‚
â”‚  â”‚  ä½¿ç”¨ï¼šMemorySaver (Checkpointer)          â”‚ â”‚
â”‚  â”‚  ä½œç”¨ï¼šä¿å­˜å•æ¬¡ä¼šè¯çš„å¯¹è¯å†å²              â”‚ â”‚
â”‚  â”‚  ç”Ÿå‘½å‘¨æœŸï¼šä¼šè¯æœŸé—´                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  é•¿æœŸè®°å¿†ï¼ˆAcross-Thread Memoryï¼‰          â”‚ â”‚
â”‚  â”‚  ä½¿ç”¨ï¼šInMemoryStore (Store)               â”‚ â”‚
â”‚  â”‚  ä½œç”¨ï¼šè·¨ä¼šè¯ä¿å­˜ç”¨æˆ·ä¿¡æ¯                  â”‚ â”‚
â”‚  â”‚  ç”Ÿå‘½å‘¨æœŸï¼šæŒä¹…åŒ–ï¼ˆè·¨æ‰€æœ‰ä¼šè¯ï¼‰            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€LangGraph Store åŸºç¡€

### 3.1 ä»€ä¹ˆæ˜¯ LangGraph Storeï¼Ÿ

[LangGraph Memory Store](https://langchain-ai.github.io/langgraph/reference/store/#langgraph.store.base.BaseStore) æ˜¯ä¸€ä¸ªç”¨äºåœ¨ LangGraph ä¸­**è·¨çº¿ç¨‹ï¼ˆä¼šè¯ï¼‰å­˜å‚¨å’Œæ£€ç´¢ä¿¡æ¯**çš„æŒä¹…åŒ–é”®å€¼å­˜å‚¨ç³»ç»Ÿã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

1. **è·¨çº¿ç¨‹æŒä¹…åŒ–**ï¼šæ•°æ®åœ¨ä¸åŒçš„å¯¹è¯ä¼šè¯ä¸­ä¿æŒå¯è®¿é—®
2. **é”®å€¼å­˜å‚¨**ï¼šç®€å•è€Œå¼ºå¤§çš„æ•°æ®ç»„ç»‡æ–¹å¼
3. **å¼€æºåŸºç±»**ï¼šå¯ä»¥å®ç°ä¸åŒçš„å­˜å‚¨åç«¯ï¼ˆå†…å­˜ã€æ•°æ®åº“ç­‰ï¼‰
4. **å‘½åç©ºé—´æ”¯æŒ**ï¼šåˆ†å±‚ç»„ç»‡æ•°æ®

### 3.2 Store çš„åŸºæœ¬æ¦‚å¿µ

LangGraph Store ä½¿ç”¨ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µæ¥ç»„ç»‡æ•°æ®ï¼š

#### 3.2.1 Namespaceï¼ˆå‘½åç©ºé—´ï¼‰

**å®šä¹‰**ï¼šç”¨å…ƒç»„è¡¨ç¤ºçš„åˆ†å±‚ç»“æ„ï¼Œç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ã€‚

**ç¤ºä¾‹**ï¼š
```python
("user_1", "memories")           # ç”¨æˆ· 1 çš„è®°å¿†
("user_2", "memories")           # ç”¨æˆ· 2 çš„è®°å¿†
("memory", "user_123")           # å¦ä¸€ç§ç»„ç»‡æ–¹å¼
("project", "alpha", "settings") # å¤šå±‚å‘½åç©ºé—´
```

**ä¸ºä»€ä¹ˆä½¿ç”¨å…ƒç»„ï¼Ÿ**
- å…ƒç»„æ˜¯ä¸å¯å˜çš„ï¼Œé€‚åˆä½œä¸ºé”®
- å¤©ç„¶æ”¯æŒå±‚çº§ç»“æ„
- å¯ä»¥çµæ´»ç»„ç»‡æ•°æ®

**ç±»æ¯”**ï¼š
```
Namespace           ç±»ä¼¼äº
("user_1", "memories")  â†’  /user_1/memories/
```

#### 3.2.2 Keyï¼ˆé”®ï¼‰

**å®šä¹‰**ï¼šåœ¨å‘½åç©ºé—´å†…æ ‡è¯†ç‰¹å®šå¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œç±»ä¼¼äºæ–‡ä»¶åã€‚

**ç¤ºä¾‹**ï¼š
```python
"user_memory"                    # ç®€å•çš„é”®
"preference_settings"            # æè¿°æ€§çš„é”®
str(uuid.uuid4())                # UUID é”®ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
# ä¾‹å¦‚ï¼š"a754b8c5-e8b7-40ec-834b-c426a9a7c7cc"
```

**æœ€ä½³å®è·µ**ï¼š
- ä½¿ç”¨æè¿°æ€§çš„é”®å
- å¯¹äºé›†åˆç±»æ•°æ®ï¼Œä½¿ç”¨ UUID
- å¯¹äºå•ä¸€è®°å½•ï¼Œä½¿ç”¨å›ºå®šçš„é”®å

#### 3.2.3 Valueï¼ˆå€¼ï¼‰

**å®šä¹‰**ï¼šå­˜å‚¨çš„å®é™…æ•°æ®ï¼Œ**å¿…é¡»æ˜¯å­—å…¸ç±»å‹**ã€‚

**ç¤ºä¾‹**ï¼š
```python
{"food_preference": "I like pizza"}
{"memory": "User's name is Lance"}
{"task": "Buy milk", "status": "pending"}
```

**é‡è¦çº¦æŸ**ï¼š
- å€¼å¿…é¡»æ˜¯ Python å­—å…¸ï¼ˆdictï¼‰
- å¯ä»¥åŒ…å«åµŒå¥—ç»“æ„
- é€šå¸¸åŒ…å«å­—ç¬¦ä¸²ã€æ•°å­—ã€åˆ—è¡¨ç­‰å¯åºåˆ—åŒ–çš„æ•°æ®

### 3.3 Store çš„æ•°æ®æ¨¡å‹å›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   InMemoryStore                      â”‚
â”‚                                                      â”‚
â”‚  Namespace: ("user_1", "memories")                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Key: "a754..."                                â”‚ â”‚
â”‚  â”‚ Value: {"food_preference": "I like pizza"}    â”‚ â”‚
â”‚  â”‚ Created: 2024-11-04T22:48:16                  â”‚ â”‚
â”‚  â”‚ Updated: 2024-11-04T22:48:16                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Key: "b892..."                                â”‚ â”‚
â”‚  â”‚ Value: {"hobby": "biking"}                    â”‚ â”‚
â”‚  â”‚ Created: 2024-11-04T22:50:00                  â”‚ â”‚
â”‚  â”‚ Updated: 2024-11-04T22:50:00                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                      â”‚
â”‚  Namespace: ("user_2", "memories")                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Key: "c123..."                                â”‚ â”‚
â”‚  â”‚ Value: {"name": "Alice"}                      â”‚ â”‚
â”‚  â”‚ Created: 2024-11-04T23:00:00                  â”‚ â”‚
â”‚  â”‚ Updated: 2024-11-04T23:00:00                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€ç¯å¢ƒå‡†å¤‡

### 4.1 å®‰è£…ä¾èµ–åŒ…

```python
%%capture --no-stderr
%pip install -U langchain_openai langgraph langchain_core
```

**ä¾èµ–åŒ…è¯´æ˜**ï¼š
- `langchain_openai`ï¼šOpenAI æ¨¡å‹çš„ LangChain é›†æˆ
- `langgraph`ï¼šæ„å»ºæœ‰çŠ¶æ€å›¾çš„æ¡†æ¶
- `langchain_core`ï¼šLangChain æ ¸å¿ƒç»„ä»¶

### 4.2 é…ç½®ç¯å¢ƒå˜é‡

```python
import os, getpass

def _set_env(var: str):
    if not os.environ.get(var):
        os.environ[var] = getpass.getpass(f"{var}: ")

# é…ç½® LangSmithï¼ˆç”¨äºè¿½è¸ªï¼‰
_set_env("LANGSMITH_API_KEY")
os.environ["LANGSMITH_TRACING"] = "true"
os.environ["LANGSMITH_PROJECT"] = "langchain-academy"
```

**LangSmith çš„ä½œç”¨**ï¼š
- **è¿½è¸ªï¼ˆTracingï¼‰**ï¼šè®°å½•æ¯æ¬¡ LLM è°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯
- **è°ƒè¯•**ï¼šæŸ¥çœ‹è¾“å…¥è¾“å‡ºã€token ä½¿ç”¨ã€å»¶è¿Ÿç­‰
- **ä¼˜åŒ–**ï¼šåˆ†ææ€§èƒ½ç“¶é¢ˆ

---

## äº”ã€Store çš„åŸºæœ¬æ“ä½œ

### 5.1 åˆ›å»º Store å®ä¾‹

```python
import uuid
from langgraph.store.memory import InMemoryStore

# åˆ›å»ºå†…å­˜å­˜å‚¨å®ä¾‹
in_memory_store = InMemoryStore()
```

**InMemoryStore**ï¼š
- åœ¨å†…å­˜ä¸­ä¿å­˜æ•°æ®
- é€‚åˆå¼€å‘å’Œæµ‹è¯•
- ç”Ÿäº§ç¯å¢ƒé€šå¸¸ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰

**Python çŸ¥è¯†ç‚¹**ï¼š
- `uuid`ï¼šé€šç”¨å”¯ä¸€è¯†åˆ«ç ï¼ˆUniversally Unique Identifierï¼‰
- ç”¨äºç”Ÿæˆå…¨å±€å”¯ä¸€çš„ ID

### 5.2 ä¿å­˜æ•°æ®ï¼šput() æ–¹æ³•

#### 5.2.1 åŸºæœ¬ç”¨æ³•

```python
# å®šä¹‰å‘½åç©ºé—´
user_id = "1"
namespace_for_memory = (user_id, "memories")

# ç”Ÿæˆå”¯ä¸€çš„é”®
key = str(uuid.uuid4())
# ä¾‹å¦‚ï¼š'a754b8c5-e8b7-40ec-834b-c426a9a7c7cc'

# å€¼å¿…é¡»æ˜¯å­—å…¸
value = {"food_preference": "I like pizza"}

# ä¿å­˜åˆ° store
in_memory_store.put(namespace_for_memory, key, value)
```

**æ–¹æ³•ç­¾å**ï¼š
```python
def put(
    namespace: tuple,      # å‘½åç©ºé—´ï¼ˆå…ƒç»„ï¼‰
    key: str,              # é”®ï¼ˆå­—ç¬¦ä¸²ï¼‰
    value: dict            # å€¼ï¼ˆå­—å…¸ï¼‰
) -> None:
```

**å‚æ•°è¯¦è§£**ï¼š

1. **namespace**ï¼š`(user_id, "memories")`
   - ç¬¬ä¸€ä¸ªå…ƒç´ ï¼šç”¨æˆ· IDï¼ˆå­—ç¬¦ä¸²ï¼‰
   - ç¬¬äºŒä¸ªå…ƒç´ ï¼šæ•°æ®ç±»å‹ï¼ˆ"memories"ï¼‰
   - å¯ä»¥æœ‰æ›´å¤šå±‚çº§

2. **key**ï¼š`str(uuid.uuid4())`
   - ä½¿ç”¨ UUID ç¡®ä¿å”¯ä¸€æ€§
   - ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å­—ç¬¦ä¸²

3. **value**ï¼š`{"food_preference": "I like pizza"}`
   - å¿…é¡»æ˜¯å­—å…¸
   - å¯ä»¥åŒ…å«ä»»æ„å¯åºåˆ—åŒ–çš„æ•°æ®

#### 5.2.2 UUID è¯¦è§£

```python
import uuid

# ç”Ÿæˆ UUID
unique_id = uuid.uuid4()
print(unique_id)
# è¾“å‡ºï¼šUUID('a754b8c5-e8b7-40ec-834b-c426a9a7c7cc')

# è½¬æ¢ä¸ºå­—ç¬¦ä¸²
key = str(unique_id)
print(key)
# è¾“å‡ºï¼š'a754b8c5-e8b7-40ec-834b-c426a9a7c7cc'
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ UUIDï¼Ÿ**
- å…¨å±€å”¯ä¸€ï¼šæä½çš„ç¢°æ’æ¦‚ç‡ï¼ˆ2^122ï¼‰
- æ— éœ€ä¸­å¤®åè°ƒï¼šå¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç‹¬ç«‹ç”Ÿæˆ
- æ ‡å‡†åŒ–ï¼šç¬¦åˆ RFC 4122 æ ‡å‡†

**UUID çš„ç‰ˆæœ¬**ï¼š
- `uuid.uuid1()`ï¼šåŸºäºæ—¶é—´æˆ³å’Œ MAC åœ°å€
- `uuid.uuid4()`ï¼šéšæœºç”Ÿæˆï¼ˆæœ€å¸¸ç”¨ï¼‰
- `uuid.uuid5()`ï¼šåŸºäºå‘½åç©ºé—´å’Œåç§°çš„å“ˆå¸Œ

### 5.3 æœç´¢æ•°æ®ï¼šsearch() æ–¹æ³•

#### 5.3.1 åŸºæœ¬ç”¨æ³•

```python
# æœç´¢å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰æ•°æ®
memories = in_memory_store.search(namespace_for_memory)

# è¿”å›å€¼æ˜¯åˆ—è¡¨
print(type(memories))
# è¾“å‡ºï¼š<class 'list'>
```

**æ–¹æ³•ç­¾å**ï¼š
```python
def search(
    namespace: tuple     # å‘½åç©ºé—´
) -> list:               # è¿”å›é¡¹ç›®åˆ—è¡¨
```

#### 5.3.2 æŸ¥çœ‹æœç´¢ç»“æœ

```python
# æŸ¥çœ‹ç¬¬ä¸€ä¸ªç»“æœçš„æ‰€æœ‰ä¿¡æ¯
print(memories[0].dict())
```

**è¾“å‡º**ï¼š
```python
{
    'value': {'food_preference': 'I like pizza'},
    'key': 'a754b8c5-e8b7-40ec-834b-c426a9a7c7cc',
    'namespace': ['1', 'memories'],
    'created_at': '2024-11-04T22:48:16.727572+00:00',
    'updated_at': '2024-11-04T22:48:16.727574+00:00'
}
```

**è¿”å›å¯¹è±¡çš„å±æ€§**ï¼š

1. **value**ï¼šå­˜å‚¨çš„æ•°æ®ï¼ˆå­—å…¸ï¼‰
2. **key**ï¼šå¯¹è±¡çš„é”®
3. **namespace**ï¼šå‘½åç©ºé—´ï¼ˆåˆ—è¡¨å½¢å¼ï¼‰
4. **created_at**ï¼šåˆ›å»ºæ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰
5. **updated_at**ï¼šæœ€åæ›´æ–°æ—¶é—´

**Python çŸ¥è¯†ç‚¹**ï¼š

`.dict()` æ–¹æ³•ï¼š
- Pydantic æ¨¡å‹çš„æ–¹æ³•
- å°†å¯¹è±¡è½¬æ¢ä¸ºå­—å…¸
- ä¾¿äºæŸ¥çœ‹å’Œåºåˆ—åŒ–

#### 5.3.3 è®¿é—®é”®å’Œå€¼

```python
# è·å–é”®å’Œå€¼
print(memories[0].key, memories[0].value)
```

**è¾“å‡º**ï¼š
```
a754b8c5-e8b7-40ec-834b-c426a9a7c7cc {'food_preference': 'I like pizza'}
```

**è®¿é—®åµŒå¥—æ•°æ®**ï¼š
```python
# è·å–å…·ä½“çš„åå¥½
food_pref = memories[0].value['food_preference']
print(food_pref)
# è¾“å‡ºï¼šI like pizza
```

### 5.4 è·å–æ•°æ®ï¼šget() æ–¹æ³•

#### 5.4.1 åŸºæœ¬ç”¨æ³•

```python
# é€šè¿‡å‘½åç©ºé—´å’Œé”®è·å–ç‰¹å®šå¯¹è±¡
memory = in_memory_store.get(namespace_for_memory, key)

# æŸ¥çœ‹ç»“æœ
print(memory.dict())
```

**è¾“å‡º**ï¼š
```python
{
    'value': {'food_preference': 'I like pizza'},
    'key': 'a754b8c5-e8b7-40ec-834b-c426a9a7c7cc',
    'namespace': ['1', 'memories'],
    'created_at': '2024-11-04T22:48:16.727572+00:00',
    'updated_at': '2024-11-04T22:48:16.727574+00:00'
}
```

**æ–¹æ³•ç­¾å**ï¼š
```python
def get(
    namespace: tuple,    # å‘½åç©ºé—´
    key: str            # é”®
) -> Item:              # è¿”å›å•ä¸ªé¡¹ç›®
```

#### 5.4.2 search() vs get()

| ç‰¹æ€§ | search() | get() |
|------|----------|-------|
| å‚æ•° | ä»…éœ€è¦ namespace | éœ€è¦ namespace å’Œ key |
| è¿”å›ç±»å‹ | åˆ—è¡¨ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ | å•ä¸ªå¯¹è±¡æˆ– None |
| ä½¿ç”¨åœºæ™¯ | è·å–æŸç±»æ‰€æœ‰æ•°æ® | è·å–ç‰¹å®šçš„ä¸€æ¡æ•°æ® |
| æ€§èƒ½ | å¯èƒ½è¾ƒæ…¢ï¼ˆæ‰«æï¼‰ | æ›´å¿«ï¼ˆç›´æ¥æŸ¥æ‰¾ï¼‰ |

**ç¤ºä¾‹å¯¹æ¯”**ï¼š

```python
# search - è·å–ç”¨æˆ·çš„æ‰€æœ‰è®°å¿†
all_memories = store.search(("user_1", "memories"))
# è¿”å›ï¼š[memory1, memory2, memory3, ...]

# get - è·å–ç‰¹å®šçš„ä¸€æ¡è®°å¿†
specific_memory = store.get(("user_1", "memories"), "key_123")
# è¿”å›ï¼šmemory1 æˆ– None
```

### 5.5 Store çš„ä¸‰ä¸ªæ“ä½œæ€»ç»“

```python
# 1. put - ä¿å­˜æ•°æ®
store.put(
    namespace=("user_1", "memories"),
    key="pref_001",
    value={"food": "pizza"}
)

# 2. search - æœç´¢å‘½åç©ºé—´
memories = store.search(("user_1", "memories"))
# è¿”å›è¯¥å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰é¡¹ç›®

# 3. get - è·å–ç‰¹å®šé¡¹ç›®
memory = store.get(("user_1", "memories"), "pref_001")
# è¿”å›ç‰¹å®šçš„é¡¹ç›®
```

**è®°å¿†å£è¯€**ï¼š
- **put**ï¼šä¿å­˜æ–°æ•°æ®æˆ–è¦†ç›–ç°æœ‰æ•°æ®
- **search**ï¼šæœç´¢å‘½åç©ºé—´ï¼Œè¿”å›åˆ—è¡¨
- **get**ï¼šç²¾ç¡®è·å–ï¼Œè¿”å›å•ä¸ªå¯¹è±¡

---

## å…­ã€æ„å»ºè®°å¿†èŠå¤©æœºå™¨äºº

ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨ Store æ„å»ºä¸€ä¸ªå®Œæ•´çš„èŠå¤©æœºå™¨äººï¼Œå®ƒå…·æœ‰ï¼š
1. **çŸ­æœŸè®°å¿†**ï¼šè®°ä½å½“å‰ä¼šè¯çš„å¯¹è¯å†å²
2. **é•¿æœŸè®°å¿†**ï¼šè®°ä½ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ï¼Œè·¨ä¼šè¯ä½¿ç”¨

### 6.1 åˆå§‹åŒ–æ¨¡å‹

```python
from langchain_openai import ChatOpenAI

# é…ç½® OpenAI API Key
_set_env("OPENAI_API_KEY")

# åˆå§‹åŒ–æ¨¡å‹
model = ChatOpenAI(model="gpt-5-nano", temperature=0)
```

**å‚æ•°è¯´æ˜**ï¼š
- `model="gpt-5-nano"`ï¼šä½¿ç”¨ GPT-4o æ¨¡å‹
- `temperature=0`ï¼šç¡®å®šæ€§è¾“å‡ºï¼ˆæ¯æ¬¡è¾“å…¥ç›¸åŒï¼Œè¾“å‡ºä¹Ÿç›¸åŒï¼‰

### 6.2 å®šä¹‰ç³»ç»Ÿæç¤ºè¯

#### 6.2.1 èŠå¤©æœºå™¨äººæç¤ºè¯

```python
MODEL_SYSTEM_MESSAGE = """You are a helpful assistant with memory that provides information about the user.
If you have memory for this user, use it to personalize your responses.
Here is the memory (it may be empty): {memory}"""
```

**æç¤ºè¯è®¾è®¡è¦ç‚¹**ï¼š

1. **è§’è‰²å®šä¹‰**ï¼š"You are a helpful assistant with memory"
   - æ˜ç¡®å‘Šè¯‰æ¨¡å‹å®ƒæœ‰è®°å¿†èƒ½åŠ›

2. **ä½¿ç”¨æŒ‡ä»¤**ï¼š"use it to personalize your responses"
   - æŒ‡ç¤ºå¦‚ä½•ä½¿ç”¨è®°å¿†

3. **ä¸Šä¸‹æ–‡å ä½ç¬¦**ï¼š`{memory}`
   - å°†è¢«å®é™…çš„è®°å¿†å†…å®¹æ›¿æ¢

#### 6.2.2 åˆ›å»ºè®°å¿†çš„æç¤ºè¯

```python
CREATE_MEMORY_INSTRUCTION = """You are collecting information about the user to personalize your responses.

CURRENT USER INFORMATION:
{memory}

INSTRUCTIONS:
1. Review the chat history below carefully
2. Identify new information about the user, such as:
   - Personal details (name, location)
   - Preferences (likes, dislikes)
   - Interests and hobbies
   - Past experiences
   - Goals or future plans
3. Merge any new information with existing memory
4. Format the memory as a clear, bulleted list
5. If new information conflicts with existing memory, keep the most recent version

Remember: Only include factual information directly stated by the user. Do not make assumptions or inferences.

Based on the chat history below, please update the user information:"""
```

**æç¤ºè¯ç»“æ„åˆ†æ**ï¼š

1. **ä»»åŠ¡è¯´æ˜**ï¼š
   - "You are collecting information..."
   - æ˜ç¡®ä»»åŠ¡ç›®æ ‡

2. **å½“å‰çŠ¶æ€**ï¼š
   - "CURRENT USER INFORMATION: {memory}"
   - æ˜¾ç¤ºç°æœ‰è®°å¿†

3. **è¯¦ç»†æŒ‡ä»¤**ï¼š
   - 5 æ¡æ˜ç¡®çš„æ­¥éª¤
   - å‘Šè¯‰æ¨¡å‹è¦æå–ä»€ä¹ˆä¿¡æ¯

4. **çº¦æŸæ¡ä»¶**ï¼š
   - "Only include factual information"
   - é¿å…æ¨¡å‹æ¨æµ‹æˆ–è‡†æ–­

5. **è¾“å‡ºæ ¼å¼**ï¼š
   - "Format as a clear, bulleted list"
   - ç¡®ä¿è¾“å‡ºç»“æ„åŒ–

**æç¤ºè¯å·¥ç¨‹æŠ€å·§**ï¼š
- âœ… ä½¿ç”¨å¤§å†™æ ‡é¢˜ï¼ˆCURRENT USER INFORMATIONï¼‰çªå‡ºé‡è¦éƒ¨åˆ†
- âœ… ä½¿ç”¨ç¼–å·åˆ—è¡¨ä½¿æŒ‡ä»¤æ¸…æ™°
- âœ… æä¾›å…·ä½“ç¤ºä¾‹ï¼ˆ"name, location"ï¼‰
- âœ… è®¾ç½®çº¦æŸæ¡ä»¶ï¼ˆ"Only include factual information"ï¼‰
- âœ… æ˜ç¡®è¾“å‡ºæ ¼å¼ï¼ˆ"bulleted list"ï¼‰

### 6.3 å®šä¹‰èŠ‚ç‚¹å‡½æ•°

#### 6.3.1 call_model èŠ‚ç‚¹

è¿™æ˜¯ä¸»èŠ‚ç‚¹ï¼Œè´Ÿè´£ä¸ç”¨æˆ·äº¤äº’ï¼š

```python
from langgraph.graph import MessagesState
from langchain_core.runnables.config import RunnableConfig
from langgraph.store.base import BaseStore
from langchain_core.messages import SystemMessage

def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):
    """ä» store åŠ è½½è®°å¿†å¹¶ç”¨å®ƒæ¥ä¸ªæ€§åŒ–èŠå¤©æœºå™¨äººçš„å“åº”"""

    # ä» config è·å–ç”¨æˆ· ID
    user_id = config["configurable"]["user_id"]

    # ä» store æ£€ç´¢è®°å¿†
    namespace = ("memory", user_id)
    key = "user_memory"
    existing_memory = store.get(namespace, key)

    # æå–å®é™…çš„è®°å¿†å†…å®¹
    if existing_memory:
        # Value æ˜¯ä¸€ä¸ªåŒ…å« memory é”®çš„å­—å…¸
        existing_memory_content = existing_memory.value.get('memory')
    else:
        existing_memory_content = "No existing memory found."

    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†
    system_msg = MODEL_SYSTEM_MESSAGE.format(memory=existing_memory_content)

    # ä½¿ç”¨è®°å¿†å’ŒèŠå¤©å†å²ç”Ÿæˆå“åº”
    response = model.invoke([SystemMessage(content=system_msg)] + state["messages"])

    return {"messages": response}
```

**ä»£ç é€è¡Œè§£æ**ï¼š

**ç¬¬ 1-2 è¡Œ**ï¼šå‡½æ•°ç­¾å
```python
def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):
```
- `state`ï¼šåŒ…å«æ¶ˆæ¯åˆ—è¡¨çš„çŠ¶æ€å¯¹è±¡
- `config`ï¼šè¿è¡Œæ—¶é…ç½®ï¼ˆåŒ…å« user_idã€thread_idï¼‰
- `store`ï¼šé•¿æœŸè®°å¿†å­˜å‚¨

**ç¬¬ 5 è¡Œ**ï¼šè·å–ç”¨æˆ· ID
```python
user_id = config["configurable"]["user_id"]
```
- ä»é…ç½®ä¸­æå–ç”¨æˆ·æ ‡è¯†
- ç”¨äºæŸ¥æ‰¾è¯¥ç”¨æˆ·çš„è®°å¿†

**ç¬¬ 7-10 è¡Œ**ï¼šæ£€ç´¢è®°å¿†
```python
namespace = ("memory", user_id)
key = "user_memory"
existing_memory = store.get(namespace, key)
```
- æ„å»ºå‘½åç©ºé—´ï¼š`("memory", "1")`
- ä½¿ç”¨å›ºå®šçš„é”®ï¼š`"user_memory"`
- è°ƒç”¨ `get()` æ–¹æ³•è·å–è®°å¿†

**ç¬¬ 12-16 è¡Œ**ï¼šæå–è®°å¿†å†…å®¹
```python
if existing_memory:
    existing_memory_content = existing_memory.value.get('memory')
else:
    existing_memory_content = "No existing memory found."
```
- å¦‚æœè®°å¿†å­˜åœ¨ï¼Œæå– `value['memory']`
- å¦‚æœä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯

**ä¸ºä»€ä¹ˆä½¿ç”¨ `.get('memory')`ï¼Ÿ**
```python
# store ä¸­ä¿å­˜çš„æ ¼å¼ï¼š
{
    "memory": "- User's name is Lance\n- Likes biking"
}

# æ‰€ä»¥éœ€è¦æå– 'memory' é”®çš„å€¼
existing_memory.value.get('memory')
```

**ç¬¬ 18-19 è¡Œ**ï¼šæ ¼å¼åŒ–ç³»ç»Ÿæ¶ˆæ¯
```python
system_msg = MODEL_SYSTEM_MESSAGE.format(memory=existing_memory_content)
```
- å°†è®°å¿†å†…å®¹æ’å…¥æç¤ºè¯æ¨¡æ¿
- ä¾‹å¦‚ï¼š`"Here is the memory: - User's name is Lance..."`

**ç¬¬ 21-22 è¡Œ**ï¼šç”Ÿæˆå“åº”
```python
response = model.invoke([SystemMessage(content=system_msg)] + state["messages"])
```
- æ„å»ºæ¶ˆæ¯åˆ—è¡¨ï¼š`[SystemMessage, HumanMessage, AIMessage, ...]`
- è°ƒç”¨æ¨¡å‹ç”Ÿæˆå“åº”

**ç¬¬ 24 è¡Œ**ï¼šè¿”å›çŠ¶æ€æ›´æ–°
```python
return {"messages": response}
```
- è¿”å›åŒ…å«æ–°æ¶ˆæ¯çš„å­—å…¸
- LangGraph ä¼šå°†å…¶åˆå¹¶åˆ°çŠ¶æ€ä¸­

#### 6.3.2 write_memory èŠ‚ç‚¹

è¿™ä¸ªèŠ‚ç‚¹è´Ÿè´£åæ€å¯¹è¯å¹¶ä¿å­˜è®°å¿†ï¼š

```python
from langchain_core.messages import SystemMessage

def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):
    """åæ€èŠå¤©å†å²å¹¶ä¿å­˜è®°å¿†åˆ° store"""

    # è·å–ç”¨æˆ· ID
    user_id = config["configurable"]["user_id"]

    # ä» store æ£€ç´¢ç°æœ‰è®°å¿†
    namespace = ("memory", user_id)
    existing_memory = store.get(namespace, "user_memory")

    # æå–è®°å¿†å†…å®¹
    if existing_memory:
        existing_memory_content = existing_memory.value.get('memory')
    else:
        existing_memory_content = "No existing memory found."

    # åœ¨ç³»ç»Ÿæç¤ºä¸­æ ¼å¼åŒ–è®°å¿†
    system_msg = CREATE_MEMORY_INSTRUCTION.format(memory=existing_memory_content)

    # è®©æ¨¡å‹ç”Ÿæˆæ›´æ–°åçš„è®°å¿†
    new_memory = model.invoke([SystemMessage(content=system_msg)] + state['messages'])

    # è¦†ç›– store ä¸­çš„ç°æœ‰è®°å¿†
    key = "user_memory"

    # å°†å€¼å†™ä¸ºåŒ…å« memory é”®çš„å­—å…¸
    store.put(namespace, key, {"memory": new_memory.content})
```

**ä»£ç é€è¡Œè§£æ**ï¼š

**ç¬¬ 7-11 è¡Œ**ï¼šè·å–ç°æœ‰è®°å¿†
```python
user_id = config["configurable"]["user_id"]
namespace = ("memory", user_id)
existing_memory = store.get(namespace, "user_memory")
```
- ä¸ `call_model` ç±»ä¼¼ï¼Œè·å–ç”¨æˆ·çš„ç°æœ‰è®°å¿†

**ç¬¬ 13-17 è¡Œ**ï¼šæå–è®°å¿†å†…å®¹
```python
if existing_memory:
    existing_memory_content = existing_memory.value.get('memory')
else:
    existing_memory_content = "No existing memory found."
```
- æä¾›ç°æœ‰è®°å¿†ç»™æ¨¡å‹ä½œä¸ºä¸Šä¸‹æ–‡

**ç¬¬ 19-23 è¡Œ**ï¼šç”Ÿæˆæ–°è®°å¿†
```python
system_msg = CREATE_MEMORY_INSTRUCTION.format(memory=existing_memory_content)
new_memory = model.invoke([SystemMessage(content=system_msg)] + state['messages'])
```
- ä½¿ç”¨ `CREATE_MEMORY_INSTRUCTION` æç¤ºè¯
- è®©æ¨¡å‹åˆ†æå¯¹è¯å¹¶ç”Ÿæˆæ›´æ–°çš„è®°å¿†
- `new_memory.content` æ˜¯æ¨¡å‹ç”Ÿæˆçš„æ–‡æœ¬

**ç¬¬ 25-29 è¡Œ**ï¼šä¿å­˜åˆ° store
```python
key = "user_memory"
store.put(namespace, key, {"memory": new_memory.content})
```
- ä½¿ç”¨å›ºå®šçš„é”®ï¼š`"user_memory"`
- ä¿å­˜æ ¼å¼ï¼š`{"memory": "å®é™…çš„è®°å¿†å†…å®¹"}`
- å¦‚æœå·²å­˜åœ¨ï¼Œä¼šè¢«è¦†ç›–

**é‡è¦ç»†èŠ‚**ï¼š

ä¸ºä»€ä¹ˆè¦†ç›–è€Œä¸æ˜¯è¿½åŠ ï¼Ÿ
- å› ä¸ºæ¨¡å‹å·²ç»åœ¨ `CREATE_MEMORY_INSTRUCTION` ä¸­è¢«è¦æ±‚åˆå¹¶æ–°æ—§ä¿¡æ¯
- æ¨¡å‹ç”Ÿæˆçš„ `new_memory` å·²ç»åŒ…å«äº†å®Œæ•´çš„æ›´æ–°è®°å¿†
- ç®€åŒ–äº†æ•°æ®ç®¡ç†é€»è¾‘

### 6.4 æ„å»ºçŠ¶æ€å›¾

```python
from IPython.display import Image, display
from langgraph.checkpoint.memory import MemorySaver
from langgraph.graph import StateGraph, START, END

# å®šä¹‰å›¾
builder = StateGraph(MessagesState)
builder.add_node("call_model", call_model)
builder.add_node("write_memory", write_memory)

# å®šä¹‰è¾¹
builder.add_edge(START, "call_model")
builder.add_edge("call_model", "write_memory")
builder.add_edge("write_memory", END)

# é•¿æœŸè®°å¿†ï¼ˆè·¨çº¿ç¨‹ï¼‰çš„ Store
across_thread_memory = InMemoryStore()

# çŸ­æœŸè®°å¿†ï¼ˆçº¿ç¨‹å†…ï¼‰çš„ Checkpointer
within_thread_memory = MemorySaver()

# ç¼–è¯‘å›¾
graph = builder.compile(
    checkpointer=within_thread_memory,
    store=across_thread_memory
)

# å¯è§†åŒ–
display(Image(graph.get_graph(xray=1).draw_mermaid_png()))
```

**å›¾ç»“æ„**ï¼š

```
START â†’ call_model â†’ write_memory â†’ END
```

**æµç¨‹è¯´æ˜**ï¼š

1. **START**ï¼šå¼€å§‹æ‰§è¡Œ
2. **call_model**ï¼š
   - åŠ è½½ç”¨æˆ·çš„é•¿æœŸè®°å¿†
   - åŠ è½½å¯¹è¯å†å²ï¼ˆçŸ­æœŸè®°å¿†ï¼‰
   - ç”Ÿæˆä¸ªæ€§åŒ–å“åº”
3. **write_memory**ï¼š
   - åæ€æ•´ä¸ªå¯¹è¯
   - æå–æ–°ä¿¡æ¯
   - æ›´æ–°é•¿æœŸè®°å¿†
4. **END**ï¼šç»“æŸæ‰§è¡Œ

**ä¸ºä»€ä¹ˆæ˜¯çº¿æ€§æµç¨‹ï¼Ÿ**

ä¸ 5.1 èŠ‚çš„å¤æ‚è·¯ç”±ä¸åŒï¼Œè¿™é‡Œæ˜¯ç®€å•çš„çº¿æ€§æµç¨‹ï¼š
- **5.1**ï¼šAgent å†³å®šæ˜¯å¦ä¿å­˜è®°å¿†ï¼ˆæ¡ä»¶è·¯ç”±ï¼‰
- **5.2**ï¼šæ¯æ¬¡å¯¹è¯åéƒ½ä¿å­˜è®°å¿†ï¼ˆå›ºå®šæµç¨‹ï¼‰

**ä¼˜ç¼ºç‚¹å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | 5.2 çº¿æ€§æµç¨‹ | 5.1 æ¡ä»¶è·¯ç”± |
|------|-------------|-------------|
| ç®€å•æ€§ | âœ… æ›´ç®€å• | âŒ æ›´å¤æ‚ |
| çµæ´»æ€§ | âŒ å›ºå®šæµç¨‹ | âœ… æ™ºèƒ½å†³ç­– |
| èµ„æºä½¿ç”¨ | âŒ æ¯æ¬¡éƒ½è°ƒç”¨ LLM | âœ… æŒ‰éœ€è°ƒç”¨ |
| é€‚ç”¨åœºæ™¯ | ç®€å•åº”ç”¨ | å¤æ‚ Agent |

### 6.5 ç¼–è¯‘é…ç½®

```python
graph = builder.compile(
    checkpointer=within_thread_memory,
    store=across_thread_memory
)
```

**å‚æ•°è¯´æ˜**ï¼š

1. **checkpointer**ï¼š`within_thread_memory`ï¼ˆMemorySaverï¼‰
   - ä¿å­˜çŸ­æœŸè®°å¿†ï¼ˆå¯¹è¯å†å²ï¼‰
   - åœ¨å•ä¸ª thread å†…æŒä¹…åŒ–
   - æ”¯æŒä¸­æ–­å’Œæ¢å¤

2. **store**ï¼š`across_thread_memory`ï¼ˆInMemoryStoreï¼‰
   - ä¿å­˜é•¿æœŸè®°å¿†ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
   - è·¨æ‰€æœ‰ thread å…±äº«
   - æŒä¹…åŒ–ç”¨æˆ·æ•°æ®

**ä¸¤ç§è®°å¿†çš„é…åˆ**ï¼š

```
ç”¨æˆ·ç¬¬ä¸€æ¬¡å¯¹è¯ï¼ˆThread 1ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Checkpointer (Thread 1)             â”‚
â”‚ - "Hi, my name is Lance"            â”‚
â”‚ - "Hello, Lance!"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ write_memory æå–ä¿¡æ¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Store (User 1)                      â”‚
â”‚ - Name: Lance                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·ç¬¬äºŒæ¬¡å¯¹è¯ï¼ˆThread 2ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Checkpointer (Thread 2)             â”‚
â”‚ - "Where should I go biking?"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ call_model åŠ è½½è®°å¿†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Store (User 1)                      â”‚
â”‚ - Name: Lance                       â”‚
â”‚ - Likes biking in San Francisco     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
å“åº”ï¼š"Hi Lance! For biking in SF..."
```

---

## ä¸ƒã€å®æˆ˜æ¼”ç¤º

### 7.1 é…ç½®å’Œåˆå§‹åŒ–

```python
# æä¾› thread IDï¼ˆçŸ­æœŸè®°å¿†ï¼‰å’Œ user IDï¼ˆé•¿æœŸè®°å¿†ï¼‰
config = {
    "configurable": {
        "thread_id": "1",      # ä¼šè¯æ ‡è¯†
        "user_id": "1"         # ç”¨æˆ·æ ‡è¯†
    }
}
```

**é…ç½®è¯´æ˜**ï¼š
- `thread_id`ï¼šæ ‡è¯†ä¸€æ¬¡å¯¹è¯ä¼šè¯
- `user_id`ï¼šæ ‡è¯†ç”¨æˆ·ï¼Œç”¨äºå‘½åç©ºé—´

### 7.2 ç¬¬ä¸€æ¬¡äº¤äº’ï¼šä»‹ç»è‡ªå·±

```python
# ç”¨æˆ·è¾“å…¥
input_messages = [HumanMessage(content="Hi, my name is Lance")]

# è¿è¡Œå›¾
for chunk in graph.stream(
    {"messages": input_messages},
    config,
    stream_mode="values"
):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
Hi, my name is Lance

================================== Ai Message ==================================
Hello, Lance! It's nice to meet you. How can I assist you today?
```

**æ‰§è¡Œæµç¨‹åˆ†æ**ï¼š

1. **call_model èŠ‚ç‚¹**ï¼š
   - æ£€æŸ¥ store ä¸­çš„è®°å¿†ï¼šæ²¡æœ‰æ‰¾åˆ°
   - ä½¿ç”¨é»˜è®¤æ¶ˆæ¯ï¼š"No existing memory found."
   - ç”Ÿæˆå“åº”ï¼š"Hello, Lance!..."

2. **write_memory èŠ‚ç‚¹**ï¼š
   - åˆ†æå¯¹è¯å†å²
   - è¯†åˆ«æ–°ä¿¡æ¯ï¼š"User's name is Lance"
   - ä¿å­˜åˆ° store

### 7.3 ç¬¬äºŒæ¬¡äº¤äº’ï¼šåˆ†äº«å…´è¶£

```python
# ç”¨æˆ·è¾“å…¥
input_messages = [HumanMessage(content="I like to bike around San Francisco")]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
I like to bike around San Francisco

================================== Ai Message ==================================
That sounds like a great way to explore the city, Lance! San Francisco has some
beautiful routes and views. Do you have a favorite trail or area you like to bike in?
```

**æ³¨æ„**ï¼š
- AI ä½¿ç”¨äº†ç”¨æˆ·çš„åå­—ï¼š"Lance"
- è¯´æ˜å®ƒå·²ç»ä»è®°å¿†ä¸­è¯»å–äº†ç”¨æˆ·ä¿¡æ¯

### 7.4 æŸ¥çœ‹çŸ­æœŸè®°å¿†ï¼ˆå¯¹è¯å†å²ï¼‰

```python
# è·å–çº¿ç¨‹çŠ¶æ€
thread = {"configurable": {"thread_id": "1"}}
state = graph.get_state(thread).values

# æ‰“å°æ‰€æœ‰æ¶ˆæ¯
for m in state["messages"]:
    m.pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
Hi, my name is Lance

================================== Ai Message ==================================
Hello, Lance! It's nice to meet you. How can I assist you today?

================================ Human Message =================================
I like to bike around San Francisco

================================== Ai Message ==================================
That sounds like a great way to explore the city, Lance! San Francisco has some
beautiful routes and views. Do you have a favorite trail or area you like to bike in?
```

**åˆ†æ**ï¼š
- æ‰€æœ‰çš„å¯¹è¯å†å²éƒ½ä¿å­˜åœ¨ Checkpointer ä¸­
- é€šè¿‡ `thread_id` å¯ä»¥è®¿é—®
- è¿™æ˜¯çŸ­æœŸè®°å¿†ï¼Œä»…åœ¨å½“å‰ä¼šè¯ä¸­

### 7.5 æŸ¥çœ‹é•¿æœŸè®°å¿†ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰

```python
# å®šä¹‰å‘½åç©ºé—´
user_id = "1"
namespace = ("memory", user_id)

# è·å–è®°å¿†
existing_memory = across_thread_memory.get(namespace, "user_memory")

# æŸ¥çœ‹å®Œæ•´ä¿¡æ¯
print(existing_memory.dict())
```

**è¾“å‡º**ï¼š

```python
{
    'value': {
        'memory': "**Updated User Information:**\n- User's name is Lance.\n- Likes to bike around San Francisco."
    },
    'key': 'user_memory',
    'namespace': ['memory', '1'],
    'created_at': '2024-11-05T00:12:17.383918+00:00',
    'updated_at': '2024-11-05T00:12:25.469528+00:00'
}
```

**è®°å¿†å†…å®¹è§£æ**ï¼š

```
**Updated User Information:**
- User's name is Lance.
- Likes to bike around San Francisco.
```

**å…³é”®è§‚å¯Ÿ**ï¼š
1. æ¨¡å‹æå–äº†ä¸¤æ¡ä¿¡æ¯
2. æ ¼å¼åŒ–ä¸ºæ¸…æ™°çš„é¡¹ç›®ç¬¦å·åˆ—è¡¨
3. åŒ…å«æ—¶é—´æˆ³ï¼ˆåˆ›å»ºå’Œæ›´æ–°æ—¶é—´ï¼‰

### 7.6 è·¨ä¼šè¯æµ‹è¯•ï¼šæ–°çš„å¯¹è¯

ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª**æ–°çš„ä¼šè¯**ï¼ˆä¸åŒçš„ thread_idï¼‰ï¼Œä½†ä½¿ç”¨**ç›¸åŒçš„ç”¨æˆ·**ï¼ˆç›¸åŒçš„ user_idï¼‰ï¼š

```python
# æ–°çš„ thread_idï¼Œä½†ç›¸åŒçš„ user_id
config = {
    "configurable": {
        "thread_id": "2",      # æ–°ä¼šè¯
        "user_id": "1"         # ç›¸åŒç”¨æˆ·
    }
}

# ç”¨æˆ·è¾“å…¥
input_messages = [HumanMessage(
    content="Hi! Where would you recommend that I go biking?"
)]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
Hi! Where would you recommend that I go biking?

================================== Ai Message ==================================
Hi Lance! Since you enjoy biking around San Francisco, there are some fantastic
routes you might love. Here are a few recommendations:

1. **Golden Gate Park**: This is a classic choice with plenty of trails and
   beautiful scenery. You can explore the park's many attractions, like the
   Conservatory of Flowers and the Japanese Tea Garden.

2. **The Embarcadero**: A ride along the Embarcadero offers stunning views of
   the Bay Bridge and the waterfront. It's a great way to experience the city's
   vibrant atmosphere.

3. **Marin Headlands**: If you're up for a bit of a challenge, biking across
   the Golden Gate Bridge to the Marin Headlands offers breathtaking views of
   the city and the Pacific Ocean.

4. **Presidio**: This area has a network of trails with varying difficulty
   levels, and you can enjoy views of the Golden Gate Bridge and the bay.

5. **Twin Peaks**: For a more challenging ride, head up to Twin Peaks. The
   climb is worth it for the panoramic views of the city.

Let me know if you want more details on any of these routes!
```

**é•¿æœŸè®°å¿†çš„å¨åŠ›**ï¼š

1. **è®°ä½äº†åå­—**ï¼š"Hi Lance!"
   - è™½ç„¶è¿™æ˜¯æ–°ä¼šè¯ï¼Œä½† AI è®°å¾—ç”¨æˆ·çš„åå­—

2. **è®°ä½äº†å…´è¶£**ï¼š"Since you enjoy biking around San Francisco"
   - AI çŸ¥é“ç”¨æˆ·å–œæ¬¢åœ¨æ—§é‡‘å±±éª‘è½¦

3. **ä¸ªæ€§åŒ–å»ºè®®**ï¼š
   - æä¾›äº†å…·ä½“çš„æ—§é‡‘å±±éª‘è¡Œè·¯çº¿
   - é’ˆå¯¹ç”¨æˆ·çš„å…´è¶£å®šåˆ¶å“åº”

### 7.7 ç»§ç»­å¯¹è¯ï¼šè¿›ä¸€æ­¥ä¸ªæ€§åŒ–

```python
# ç”¨æˆ·è¾“å…¥
input_messages = [HumanMessage(
    content="Great, are there any bakeries nearby that I can check out? I like a croissant after biking."
)]

# è¿è¡Œå›¾
for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

**è¾“å‡º**ï¼š

```
================================ Human Message =================================
Great, are there any bakeries nearby that I can check out? I like a croissant after biking.

================================== Ai Message ==================================
Absolutely, Lance! Here are a few bakeries in San Francisco where you can enjoy
a delicious croissant after your ride:

1. **Tartine Bakery**: Located in the Mission District, Tartine is famous for
   its pastries, and their croissants are a must-try.

2. **Arsicault Bakery**: This bakery in the Richmond District has been praised
   for its buttery, flaky croissants. It's a bit of a detour, but worth it!

3. **b. Patisserie**: Situated in Lower Pacific Heights, b. Patisserie offers
   a variety of pastries, and their croissants are particularly popular.

4. **Le Marais Bakery**: With locations in the Marina and Castro, Le Marais
   offers a charming French bakery experience with excellent croissants.

5. **Neighbor Bakehouse**: Located in the Dogpatch, this bakery is known for
   its creative pastries, including some fantastic croissants.

These spots should provide a delightful treat after your biking adventures.
Enjoy your ride and your croissant!
```

**æ–°ä¿¡æ¯ä¼šè¢«ä¿å­˜**ï¼š
- ç”¨æˆ·å–œæ¬¢éª‘è½¦ååƒå¯é¢‚
- è¿™æ¡ä¿¡æ¯ä¼šè¢«æ·»åŠ åˆ°é•¿æœŸè®°å¿†ä¸­
- åœ¨æœªæ¥çš„å¯¹è¯ä¸­å¯ä»¥ä½¿ç”¨

**è®°å¿†æ›´æ–°æµç¨‹**ï¼š

```
å¯¹è¯å‰çš„è®°å¿†ï¼š
- User's name is Lance
- Likes to bike around San Francisco

å¯¹è¯åçš„è®°å¿†ï¼š
- User's name is Lance
- Likes to bike around San Francisco
- Enjoys eating croissants after biking  â† æ–°å¢
```

---

## å…«ã€åœ¨çƒ­è·¯å¾„ä¸­ä¿å­˜è®°å¿†

### 8.1 ä»€ä¹ˆæ˜¯"çƒ­è·¯å¾„"ï¼Ÿ

**çƒ­è·¯å¾„ï¼ˆHot Pathï¼‰**ï¼šåœ¨ç”¨æˆ·ç­‰å¾…å“åº”çš„è¿‡ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œã€‚

**å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | çƒ­è·¯å¾„ï¼ˆHot Pathï¼‰ | å†·è·¯å¾„ï¼ˆCold Pathï¼‰ |
|------|------------------|-------------------|
| æ‰§è¡Œæ—¶æœº | ç”¨æˆ·ç­‰å¾…å“åº”æ—¶ | åå°å¼‚æ­¥å¤„ç† |
| ç”¨æˆ·ä½“éªŒ | å¯èƒ½å¢åŠ å»¶è¿Ÿ | ä¸å½±å“å“åº”é€Ÿåº¦ |
| å®æ—¶æ€§ | ç«‹å³å¯ç”¨ | æœ‰å»¶è¿Ÿ |
| å®ç°å¤æ‚åº¦ | ç®€å• | éœ€è¦é˜Ÿåˆ—/ä»»åŠ¡è°ƒåº¦ |

**æœ¬èŠ‚çš„å®ç°**ï¼š

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
call_modelï¼ˆç”Ÿæˆå“åº”ï¼‰  â† ç”¨æˆ·ç­‰å¾…
    â†“
write_memoryï¼ˆä¿å­˜è®°å¿†ï¼‰ â† ç”¨æˆ·ç­‰å¾…
    â†“
è¿”å›å“åº”ç»™ç”¨æˆ·
```

### 8.2 çƒ­è·¯å¾„çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**ï¼š
1. âœ… **å®æ—¶æ›´æ–°**ï¼šè®°å¿†ç«‹å³ä¿å­˜ï¼Œä¸‹æ¬¡å¯¹è¯å¯ç”¨
2. âœ… **å®ç°ç®€å•**ï¼šä¸éœ€è¦é¢å¤–çš„åå°ä»»åŠ¡ç³»ç»Ÿ
3. âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šé¿å…å¹¶å‘é—®é¢˜

**ç¼ºç‚¹**ï¼š
1. âŒ **å¢åŠ å»¶è¿Ÿ**ï¼šç”¨æˆ·éœ€è¦ç­‰å¾…è®°å¿†ä¿å­˜
2. âŒ **èµ„æºæ¶ˆè€—**ï¼šæ¯æ¬¡å¯¹è¯éƒ½è°ƒç”¨ LLM æå–è®°å¿†
3. âŒ **å¯èƒ½å¤±è´¥**ï¼šå¦‚æœä¿å­˜å¤±è´¥ï¼Œç”¨æˆ·ä¼šæ„ŸçŸ¥åˆ°

### 8.3 å†·è·¯å¾„çš„æ›¿ä»£æ–¹æ¡ˆ

å¦‚æœå¯¹å“åº”é€Ÿåº¦è¦æ±‚é«˜ï¼Œå¯ä»¥è€ƒè™‘å†·è·¯å¾„ï¼š

```python
from langgraph.graph import StateGraph, START, END

# æ–¹æ¡ˆ 1ï¼šåˆ†ç¦»å“åº”å’Œè®°å¿†ä¿å­˜
builder = StateGraph(MessagesState)
builder.add_node("call_model", call_model)
builder.add_node("write_memory", write_memory)

# å“åº”åç«‹å³ç»“æŸ
builder.add_edge(START, "call_model")
builder.add_edge("call_model", END)

# è®°å¿†ä¿å­˜ä½œä¸ºåå°ä»»åŠ¡ï¼ˆéœ€è¦é¢å¤–å®ç°ï¼‰
# background_task_queue.add(write_memory_task)
```

**å®ç°æ–¹å¼**ï¼š
1. ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ RabbitMQã€Celeryï¼‰
2. ä½¿ç”¨ LangGraph çš„ [Background Execution](https://langchain-ai.github.io/langgraph/how-tos/background-execution/)
3. å®šæœŸæ‰¹å¤„ç†è®°å¿†æ›´æ–°

### 8.4 é€‰æ‹©ç­–ç•¥

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ |
|------|---------|
| å¯¹è¯é¢‘ç‡ä½ | çƒ­è·¯å¾„ |
| å“åº”é€Ÿåº¦å…³é”® | å†·è·¯å¾„ |
| è®°å¿†å¿…é¡»å®æ—¶ | çƒ­è·¯å¾„ |
| å¤§è§„æ¨¡ç”¨æˆ· | å†·è·¯å¾„ + ç¼“å­˜ |

---

## ä¹ã€è°ƒè¯•å’Œè¿½è¸ª

### 9.1 ä½¿ç”¨ LangSmith è¿½è¸ª

LangSmith æä¾›äº†å¼ºå¤§çš„è¿½è¸ªåŠŸèƒ½ï¼Œå¯ä»¥æŸ¥çœ‹æ¯æ¬¡æ‰§è¡Œçš„è¯¦ç»†ä¿¡æ¯ã€‚

**æŸ¥çœ‹è¿½è¸ª**ï¼š
- æ¯æ¬¡è¿è¡Œåï¼ŒLangSmith ä¼šè‡ªåŠ¨è®°å½•
- å¯ä»¥åœ¨ [LangSmith UI](https://smith.langchain.com/) ä¸­æŸ¥çœ‹
- ç¤ºä¾‹è¿½è¸ªï¼šhttps://smith.langchain.com/public/10268d64-82ff-434e-ac02-4afa5cc15432/r

**è¿½è¸ªå†…å®¹**ï¼š

1. **è¾“å…¥è¾“å‡º**ï¼š
   - ç”¨æˆ·æ¶ˆæ¯
   - ç³»ç»Ÿæç¤ºï¼ˆåŒ…å«è®°å¿†ï¼‰
   - AI å“åº”

2. **ä¸­é—´æ­¥éª¤**ï¼š
   - `call_model` èŠ‚ç‚¹çš„æ‰§è¡Œ
   - `write_memory` èŠ‚ç‚¹çš„æ‰§è¡Œ

3. **æ€§èƒ½æŒ‡æ ‡**ï¼š
   - Token ä½¿ç”¨é‡
   - å»¶è¿Ÿæ—¶é—´
   - æˆæœ¬ä¼°ç®—

### 9.2 æŸ¥çœ‹è®°å¿†åŠ è½½è¿‡ç¨‹

ä»è¿½è¸ªä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è®°å¿†æ˜¯å¦‚ä½•è¢«åŠ è½½å’Œä½¿ç”¨çš„ï¼š

**System Message ç¤ºä¾‹**ï¼š

```
You are a helpful assistant with memory that provides information about the user.
If you have memory for this user, use it to personalize your responses.
Here is the memory (it may be empty):

**Updated User Information:**
- User's name is Lance.
- Likes to bike around San Francisco.
```

**åˆ†æ**ï¼š
- è®°å¿†è¢«æˆåŠŸåŠ è½½å¹¶æ’å…¥åˆ°ç³»ç»Ÿæç¤ºä¸­
- æ¨¡å‹å¯ä»¥çœ‹åˆ°å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
- è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆå“åº”èƒ½å¤Ÿä¸ªæ€§åŒ–

### 9.3 è°ƒè¯•å¸¸è§é—®é¢˜

#### é—®é¢˜ 1ï¼šè®°å¿†æ²¡æœ‰è¢«ä½¿ç”¨

**ç—‡çŠ¶**ï¼šAI çš„å“åº”æ²¡æœ‰ä½“ç°ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… ç¡®è®¤ `user_id` é…ç½®æ­£ç¡®
2. âœ… æ£€æŸ¥ store ä¸­æ˜¯å¦æœ‰è®°å¿†
   ```python
   memory = store.get(("memory", user_id), "user_memory")
   print(memory)
   ```
3. âœ… æŸ¥çœ‹ LangSmith è¿½è¸ªï¼Œç¡®è®¤ç³»ç»Ÿæç¤ºä¸­åŒ…å«è®°å¿†

#### é—®é¢˜ 2ï¼šè®°å¿†æ²¡æœ‰è¢«ä¿å­˜

**ç—‡çŠ¶**ï¼šä¸‹æ¬¡å¯¹è¯æ—¶ï¼ŒAI ä¸è®°å¾—ä¹‹å‰çš„ä¿¡æ¯

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… ç¡®è®¤ `write_memory` èŠ‚ç‚¹è¢«æ‰§è¡Œ
2. âœ… æ£€æŸ¥ store çš„å†…å®¹
   ```python
   memories = store.search(("memory", user_id))
   for m in memories:
       print(m.value)
   ```
3. âœ… æŸ¥çœ‹æ˜¯å¦æœ‰å¼‚å¸¸æŠ›å‡º

#### é—®é¢˜ 3ï¼šè®°å¿†æ ¼å¼é”™è¯¯

**ç—‡çŠ¶**ï¼šè®°å¿†å­˜åœ¨ä½†æ— æ³•æ­£ç¡®è§£æ

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… ç¡®è®¤ value æ˜¯å­—å…¸æ ¼å¼
2. âœ… ç¡®è®¤åŒ…å« 'memory' é”®
   ```python
   # æ­£ç¡®æ ¼å¼
   {"memory": "- User's name is Lance"}

   # é”™è¯¯æ ¼å¼
   "- User's name is Lance"  # ä¸æ˜¯å­—å…¸
   {"info": "..."}           # ç¼ºå°‘ 'memory' é”®
   ```

---

## åã€Python çŸ¥è¯†ç‚¹æ€»ç»“

### 10.1 UUIDï¼ˆé€šç”¨å”¯ä¸€è¯†åˆ«ç ï¼‰

```python
import uuid

# ç”Ÿæˆ UUID
id1 = uuid.uuid4()
print(id1)
# è¾“å‡ºï¼šUUID('a754b8c5-e8b7-40ec-834b-c426a9a7c7cc')

# è½¬æ¢ä¸ºå­—ç¬¦ä¸²
id_str = str(id1)
print(id_str)
# è¾“å‡ºï¼š'a754b8c5-e8b7-40ec-834b-c426a9a7c7cc'

# æ¯”è¾ƒ
id2 = uuid.uuid4()
print(id1 == id2)  # Falseï¼ˆå‡ ä¹ä¸å¯èƒ½ç›¸åŒï¼‰
```

**UUID çš„ç‰¹ç‚¹**ï¼š
- å…¨å±€å”¯ä¸€ï¼ˆæ¦‚ç‡æ„ä¹‰ä¸Šï¼‰
- æ— éœ€ä¸­å¤®åè°ƒ
- 128 ä½ï¼ˆ32 ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰
- æ ‡å‡†æ ¼å¼ï¼š8-4-4-4-12

### 10.2 å­—å…¸çš„ get() æ–¹æ³•

```python
# åŸºæœ¬ç”¨æ³•
data = {"name": "Alice", "age": 30}

# è·å–å­˜åœ¨çš„é”®
print(data.get("name"))  # 'Alice'

# è·å–ä¸å­˜åœ¨çš„é”®
print(data.get("email"))  # None

# æä¾›é»˜è®¤å€¼
print(data.get("email", "no-email@example.com"))
# è¾“å‡ºï¼š'no-email@example.com'
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ get() è€Œä¸æ˜¯ []ï¼Ÿ**

```python
# ä½¿ç”¨ []
data = {"name": "Alice"}
email = data["email"]  # KeyError!

# ä½¿ç”¨ get()
email = data.get("email", "unknown")  # å®‰å…¨ï¼Œè¿”å› 'unknown'
```

### 10.3 f-string æ ¼å¼åŒ–

```python
name = "Alice"
age = 30

# åŸºæœ¬ç”¨æ³•
print(f"Name: {name}, Age: {age}")
# è¾“å‡ºï¼šName: Alice, Age: 30

# è¡¨è¾¾å¼
print(f"Next year: {age + 1}")
# è¾“å‡ºï¼šNext year: 31

# æ ¼å¼åŒ–
pi = 3.14159
print(f"Pi: {pi:.2f}")
# è¾“å‡ºï¼šPi: 3.14

# å¯¹é½
print(f"{name:>10}")  # å³å¯¹é½ï¼Œå®½åº¦ 10
# è¾“å‡ºï¼š'     Alice'
```

### 10.4 å­—ç¬¦ä¸²çš„ format() æ–¹æ³•

```python
# åŸºæœ¬ç”¨æ³•
template = "Hello, {name}!"
result = template.format(name="Alice")
print(result)
# è¾“å‡ºï¼šHello, Alice!

# å¤šä¸ªå ä½ç¬¦
template = "{greeting}, {name}! You are {age} years old."
result = template.format(greeting="Hi", name="Bob", age=25)
print(result)
# è¾“å‡ºï¼šHi, Bob! You are 25 years old.

# ä½ç½®å‚æ•°
template = "{0} {1} {0}"
result = template.format("Hello", "World")
print(result)
# è¾“å‡ºï¼šHello World Hello
```

**åœ¨æœ¬èŠ‚ä¸­çš„åº”ç”¨**ï¼š
```python
MODEL_SYSTEM_MESSAGE = """Here is the memory: {memory}"""
system_msg = MODEL_SYSTEM_MESSAGE.format(memory="User likes pizza")
# ç»“æœï¼šHere is the memory: User likes pizza
```

---

## åä¸€ã€LangGraph çŸ¥è¯†ç‚¹æ€»ç»“

### 11.1 Checkpointer vs Store

| ç‰¹æ€§ | Checkpointer | Store |
|------|--------------|-------|
| **ä½œç”¨åŸŸ** | å•ä¸ª threadï¼ˆä¼šè¯ï¼‰ | è·¨ threadï¼ˆç”¨æˆ·ï¼‰ |
| **ç”Ÿå‘½å‘¨æœŸ** | ä¼šè¯æœŸé—´ | æŒä¹…åŒ– |
| **å­˜å‚¨å†…å®¹** | çŠ¶æ€å¿«ç…§ï¼ˆæ¶ˆæ¯åˆ—è¡¨ç­‰ï¼‰ | ç»“æ„åŒ–æ•°æ®ï¼ˆé”®å€¼å¯¹ï¼‰ |
| **è®¿é—®æ–¹å¼** | è‡ªåŠ¨åŠ è½½åˆ°çŠ¶æ€ | éœ€è¦æ˜¾å¼è°ƒç”¨ get/search |
| **ä¸»è¦ç”¨é€”** | å¯¹è¯å†å²ã€ä¸­æ–­æ¢å¤ | ç”¨æˆ·ä¿¡æ¯ã€é•¿æœŸè®°å¿† |
| **æ ‡è¯†ç¬¦** | thread_id | namespace + key |

### 11.2 Config çš„ä½¿ç”¨

```python
# å®šä¹‰é…ç½®
config = {
    "configurable": {
        "thread_id": "session_123",
        "user_id": "user_456"
    }
}

# åœ¨èŠ‚ç‚¹ä¸­è®¿é—®
def my_node(state, config, store):
    thread_id = config["configurable"]["thread_id"]
    user_id = config["configurable"]["user_id"]
    # ä½¿ç”¨è¿™äº› ID...
```

**Config çš„ä½œç”¨**ï¼š
- ä¼ é€’è¿è¡Œæ—¶å‚æ•°
- æ ‡è¯†ä¼šè¯å’Œç”¨æˆ·
- å¯ä»¥åŒ…å«å…¶ä»–è‡ªå®šä¹‰é…ç½®

### 11.3 çŠ¶æ€æ›´æ–°æœºåˆ¶

```python
def my_node(state: MessagesState):
    # çŠ¶æ€åŒ…å« messages åˆ—è¡¨
    current_messages = state["messages"]

    # ç”Ÿæˆæ–°æ¶ˆæ¯
    new_message = AIMessage(content="Hello!")

    # è¿”å›çŠ¶æ€æ›´æ–°
    return {"messages": [new_message]}
    # æˆ–è€…è¿”å›å¤šæ¡æ¶ˆæ¯
    return {"messages": [message1, message2]}
```

**LangGraph ä¼šè‡ªåŠ¨åˆå¹¶**ï¼š
```python
# åŸå§‹çŠ¶æ€
state = {"messages": [msg1, msg2]}

# èŠ‚ç‚¹è¿”å›
return {"messages": [msg3]}

# åˆå¹¶åçš„çŠ¶æ€
state = {"messages": [msg1, msg2, msg3]}
```

### 11.4 æµå¼æ‰§è¡Œ

```python
# stream() - æµå¼æ‰§è¡Œ
for chunk in graph.stream(input_data, config, stream_mode="values"):
    # æ¯æ¬¡çŠ¶æ€æ›´æ–°æ—¶äº§ç”Ÿä¸€ä¸ª chunk
    latest_message = chunk["messages"][-1]
    latest_message.pretty_print()

# invoke() - ä¸€æ¬¡æ€§æ‰§è¡Œ
result = graph.invoke(input_data, config)
# è¿”å›æœ€ç»ˆçŠ¶æ€
```

**stream_mode é€‰é¡¹**ï¼š
- `"values"`ï¼šæ¯æ¬¡äº§ç”Ÿå®Œæ•´çŠ¶æ€
- `"updates"`ï¼šåªäº§ç”Ÿæ›´æ–°éƒ¨åˆ†
- `"messages"`ï¼šåªäº§ç”Ÿæ–°æ¶ˆæ¯

---

## åäºŒã€æ¶æ„è®¾è®¡åˆ†æ

### 12.1 ä¸ºä»€ä¹ˆæ¯æ¬¡éƒ½ä¿å­˜è®°å¿†ï¼Ÿ

æœ¬èŠ‚çš„è®¾è®¡æ˜¯æ¯æ¬¡å¯¹è¯åéƒ½è°ƒç”¨ `write_memory`ï¼š

```
call_model â†’ write_memory â†’ END
```

**ä¼˜ç‚¹**ï¼š
1. âœ… ç®€å•ç›´æ¥
2. âœ… ä¸ä¼šé—æ¼ä¿¡æ¯
3. âœ… è®°å¿†å§‹ç»ˆæœ€æ–°

**ç¼ºç‚¹**ï¼š
1. âŒ æµªè´¹èµ„æºï¼ˆæœ‰æ—¶å¯¹è¯æ²¡æœ‰æ–°ä¿¡æ¯ï¼‰
2. âŒ å¢åŠ å»¶è¿Ÿ
3. âŒ å¢åŠ æˆæœ¬ï¼ˆæ¯æ¬¡éƒ½è°ƒç”¨ LLMï¼‰

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
å‚è€ƒ 5.1 èŠ‚ï¼Œä½¿ç”¨æ¡ä»¶è·¯ç”±ï¼š

```python
def should_save_memory(state):
    # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ä¿¡æ¯
    if has_new_information(state):
        return "write_memory"
    else:
        return END

builder.add_conditional_edges("call_model", should_save_memory)
```

### 12.2 ä¸ºä»€ä¹ˆä½¿ç”¨å›ºå®šçš„ keyï¼Ÿ

```python
key = "user_memory"
store.put(namespace, key, {"memory": new_memory.content})
```

**ä½¿ç”¨å›ºå®š key çš„åŸå› **ï¼š
- æ¯ä¸ªç”¨æˆ·åªæœ‰ä¸€ä¸ªè®°å¿†æ–‡æ¡£
- æ¯æ¬¡æ›´æ–°éƒ½è¦†ç›–æ•´ä¸ªæ–‡æ¡£
- ç®€åŒ–äº†æ£€ç´¢é€»è¾‘ï¼ˆä¸éœ€è¦æœç´¢ï¼‰

**å¯¹æ¯” UUID key**ï¼š

| ç‰¹æ€§ | å›ºå®š key | UUID key |
|------|---------|----------|
| æ•°é‡ | æ¯ä¸ªç”¨æˆ·ä¸€ä¸ª | æ¯ä¸ªç”¨æˆ·å¤šä¸ª |
| æ›´æ–°æ–¹å¼ | è¦†ç›– | è¿½åŠ  |
| æ£€ç´¢ | get() | search() |
| é€‚ç”¨åœºæ™¯ | å•ä¸€è®°å¿†æ–‡æ¡£ | è®°å¿†é›†åˆ |

**åœ¨ 5.1 èŠ‚ä¸­**ï¼š
- ä½¿ç”¨ UUID key ä¿å­˜å¤šä¸ª ToDo é¡¹
- æ¯ä¸ª ToDo æ˜¯ç‹¬ç«‹çš„æ–‡æ¡£
- å¯ä»¥å•ç‹¬æ›´æ–°æ¯ä¸ª ToDo

### 12.3 è®°å¿†åˆå¹¶ç­–ç•¥

æœ¬èŠ‚ä½¿ç”¨ LLM æ¥åˆå¹¶æ–°æ—§è®°å¿†ï¼š

```python
CREATE_MEMORY_INSTRUCTION = """
...
3. Merge any new information with existing memory
4. Format the memory as a clear, bulleted list
5. If new information conflicts with existing memory, keep the most recent version
...
"""
```

**ä¼˜ç‚¹**ï¼š
- LLM å¯ä»¥ç†è§£è¯­ä¹‰
- è‡ªåŠ¨è§£å†³å†²çª
- æ ¼å¼åŒ–è¾“å‡º

**ç¼ºç‚¹**ï¼š
- ä¾èµ– LLM èƒ½åŠ›
- å¯èƒ½å‡ºé”™æˆ–é—æ¼
- æˆæœ¬è¾ƒé«˜

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨ Trustcallï¼ˆ5.1 èŠ‚ï¼‰ï¼š
- ç»“æ„åŒ–æ›´æ–°
- JSON Patch ç²¾ç¡®æ§åˆ¶
- æ›´å¯é 

---

## åä¸‰ã€å®è·µå»ºè®®

### 13.1 å‘½åç©ºé—´è®¾è®¡åŸåˆ™

**æ¨èæ¨¡å¼**ï¼š

```python
# æ¨¡å¼ 1ï¼šç±»å‹ + ç”¨æˆ· ID
("memory", "user_123")
("preferences", "user_123")
("history", "user_123")

# æ¨¡å¼ 2ï¼šç”¨æˆ· ID + ç±»å‹
("user_123", "memory")
("user_123", "preferences")
("user_123", "history")

# æ¨¡å¼ 3ï¼šå¤šå±‚ç»“æ„
("organization", "team_A", "user_123", "memory")
```

**é€‰æ‹©å»ºè®®**ï¼š
- ç¬¬ä¸€å±‚é€šå¸¸æ˜¯æœ€å¸¸ç”¨çš„æŸ¥è¯¢ç»´åº¦
- è€ƒè™‘æœªæ¥çš„æ‰©å±•æ€§
- ä¿æŒä¸€è‡´æ€§

### 13.2 è®°å¿†å†…å®¹æ ¼å¼

**æ¨èæ ¼å¼**ï¼š

```python
# é¡¹ç›®ç¬¦å·åˆ—è¡¨ï¼ˆæ˜“è¯»ï¼‰
{
    "memory": """
    - User's name is Lance
    - Lives in San Francisco
    - Likes biking and croissants
    """
}

# JSON ç»“æ„ï¼ˆæ˜“è§£æï¼‰
{
    "profile": {
        "name": "Lance",
        "location": "San Francisco",
        "interests": ["biking", "croissants"]
    }
}

# æ··åˆæ ¼å¼
{
    "summary": "Lance from SF, likes biking",
    "details": {
        "name": "Lance",
        "location": "San Francisco"
    }
}
```

**é€‰æ‹©å»ºè®®**ï¼š
- ç®€å•åº”ç”¨ï¼šé¡¹ç›®ç¬¦å·åˆ—è¡¨
- å¤æ‚åº”ç”¨ï¼šJSON ç»“æ„
- éœ€è¦æœç´¢ï¼šè€ƒè™‘æ·»åŠ æ ‡ç­¾å’Œå…ƒæ•°æ®

### 13.3 æç¤ºè¯ä¼˜åŒ–

**åˆ›å»ºè®°å¿†çš„æç¤ºè¯å…³é”®è¦ç´ **ï¼š

1. **æ˜ç¡®ä»»åŠ¡**ï¼š
   ```
   You are collecting information about the user...
   ```

2. **æ˜¾ç¤ºç°æœ‰è®°å¿†**ï¼š
   ```
   CURRENT USER INFORMATION:
   {memory}
   ```

3. **åˆ—å‡ºè¦æå–çš„ä¿¡æ¯ç±»å‹**ï¼š
   ```
   - Personal details (name, location)
   - Preferences (likes, dislikes)
   ...
   ```

4. **å¤„ç†å†²çª**ï¼š
   ```
   If new information conflicts with existing memory, keep the most recent version
   ```

5. **è®¾ç½®çº¦æŸ**ï¼š
   ```
   Only include factual information directly stated by the user.
   ```

### 13.4 é”™è¯¯å¤„ç†

```python
def call_model(state, config, store):
    try:
        user_id = config["configurable"]["user_id"]
        namespace = ("memory", user_id)

        # å®‰å…¨åœ°è·å–è®°å¿†
        existing_memory = store.get(namespace, "user_memory")
        if existing_memory:
            memory_content = existing_memory.value.get('memory', '')
        else:
            memory_content = "No existing memory found."

        # ç”Ÿæˆå“åº”
        system_msg = MODEL_SYSTEM_MESSAGE.format(memory=memory_content)
        response = model.invoke([SystemMessage(content=system_msg)] + state["messages"])

        return {"messages": response}

    except KeyError as e:
        # é…ç½®é”™è¯¯
        print(f"Config error: {e}")
        return {"messages": [AIMessage(content="Sorry, configuration error.")]}

    except Exception as e:
        # å…¶ä»–é”™è¯¯
        print(f"Unexpected error: {e}")
        return {"messages": [AIMessage(content="Sorry, an error occurred.")]}
```

---

## åå››ã€æ‰©å±•æ€è€ƒ

### 14.1 ä¸ 5.1 èŠ‚çš„å¯¹æ¯”

| ç‰¹æ€§ | 5.2 Memory Store | 5.1 Memory Agent |
|------|-----------------|------------------|
| **å¤æ‚åº¦** | ç®€å• | å¤æ‚ |
| **è®°å¿†ç±»å‹** | å•ä¸€ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰ | å¤šç§ï¼ˆProfileã€ToDoã€Instructionsï¼‰ |
| **æ›´æ–°ç­–ç•¥** | æ¯æ¬¡éƒ½æ›´æ–° | æ¡ä»¶æ›´æ–° |
| **æ•°æ®ç»“æ„** | è‡ªç”±æ–‡æœ¬ | ç»“æ„åŒ–ï¼ˆPydanticï¼‰ |
| **å·¥å…·** | æ—  | Trustcallã€UpdateMemory |
| **è·¯ç”±** | çº¿æ€§ | æ¡ä»¶è·¯ç”± |
| **é€‚ç”¨åœºæ™¯** | ç®€å•èŠå¤©æœºå™¨äºº | å¤æ‚ Agent ç³»ç»Ÿ |

**å­¦ä¹ è·¯å¾„å»ºè®®**ï¼š
1. å…ˆæŒæ¡ 5.2 çš„åŸºç¡€æ¦‚å¿µï¼ˆStore çš„ä½¿ç”¨ï¼‰
2. å†å­¦ä¹  5.1 çš„é«˜çº§æŠ€å·§ï¼ˆTrustcallã€æ¡ä»¶è·¯ç”±ï¼‰

### 14.2 ç”Ÿäº§ç¯å¢ƒè€ƒè™‘

#### 14.2.1 æŒä¹…åŒ–å­˜å‚¨

å¼€å‘ç¯å¢ƒï¼š
```python
store = InMemoryStore()  # æ•°æ®åœ¨å†…å­˜ä¸­ï¼Œé‡å¯ä¸¢å¤±
```

ç”Ÿäº§ç¯å¢ƒï¼ˆç¤ºä¾‹ï¼‰ï¼š
```python
# ä½¿ç”¨ PostgreSQL
from langgraph.store.postgres import PostgresStore

store = PostgresStore(
    connection_string="postgresql://user:pass@localhost/dbname"
)

# æˆ–ä½¿ç”¨ Redis
from langgraph.store.redis import RedisStore

store = RedisStore(
    redis_url="redis://localhost:6379"
)
```

#### 14.2.2 æ€§èƒ½ä¼˜åŒ–

**ç¼“å­˜**ï¼š
```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_user_memory(user_id):
    namespace = ("memory", user_id)
    memory = store.get(namespace, "user_memory")
    return memory.value if memory else None
```

**æ‰¹é‡æ“ä½œ**ï¼š
```python
# æ‰¹é‡è·å–å¤šä¸ªç”¨æˆ·çš„è®°å¿†
user_ids = ["user_1", "user_2", "user_3"]
namespaces = [("memory", uid) for uid in user_ids]

# ä½¿ç”¨æ‰¹é‡ APIï¼ˆå¦‚æœæ”¯æŒï¼‰
memories = store.batch_get(namespaces, "user_memory")
```

#### 14.2.3 å®‰å…¨æ€§

**æ•°æ®åŠ å¯†**ï¼š
```python
import json
from cryptography.fernet import Fernet

# ç”Ÿæˆå¯†é’¥
key = Fernet.generate_key()
cipher = Fernet(key)

# åŠ å¯†ä¿å­˜
def save_encrypted_memory(store, namespace, key, data):
    encrypted_data = cipher.encrypt(json.dumps(data).encode())
    store.put(namespace, key, {"encrypted": encrypted_data.decode()})

# è§£å¯†è¯»å–
def load_encrypted_memory(store, namespace, key):
    item = store.get(namespace, key)
    if item:
        encrypted_data = item.value["encrypted"].encode()
        decrypted_data = cipher.decrypt(encrypted_data)
        return json.loads(decrypted_data)
    return None
```

**è®¿é—®æ§åˆ¶**ï¼š
```python
def call_model(state, config, store):
    user_id = config["configurable"]["user_id"]

    # éªŒè¯ç”¨æˆ·æƒé™
    if not has_permission(user_id, "read_memory"):
        return {"messages": [AIMessage(content="Access denied.")]}

    # ç»§ç»­å¤„ç†...
```

---

## åäº”ã€æ€»ç»“

### 15.1 æ ¸å¿ƒè¦ç‚¹

1. **LangGraph Store** æ˜¯è·¨çº¿ç¨‹ï¼ˆä¼šè¯ï¼‰æŒä¹…åŒ–å­˜å‚¨çš„åŸºç¡€
   - ä½¿ç”¨å‘½åç©ºé—´ã€é”®ã€å€¼ç»„ç»‡æ•°æ®
   - æä¾› putã€getã€search ä¸‰ä¸ªåŸºæœ¬æ“ä½œ

2. **çŸ­æœŸè®°å¿† + é•¿æœŸè®°å¿†** çš„æ¶æ„
   - Checkpointerï¼šä¿å­˜å¯¹è¯å†å²ï¼ˆçŸ­æœŸï¼‰
   - Storeï¼šä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆé•¿æœŸï¼‰
   - ä¸¤è€…é…åˆå®ç°å®Œæ•´çš„è®°å¿†ç³»ç»Ÿ

3. **åœ¨çƒ­è·¯å¾„ä¸­ä¿å­˜è®°å¿†**
   - å®æ—¶æ›´æ–°ï¼Œç«‹å³å¯ç”¨
   - ç®€å•ä½†å¯èƒ½å½±å“æ€§èƒ½

4. **æç¤ºè¯å·¥ç¨‹** æ˜¯è®°å¿†è´¨é‡çš„å…³é”®
   - æ˜ç¡®æŒ‡ä»¤
   - æ˜¾ç¤ºç°æœ‰è®°å¿†
   - å¤„ç†å†²çª

### 15.2 å­¦åˆ°çš„æŠ€èƒ½

**Python æŠ€èƒ½**ï¼š
- UUID çš„ç”Ÿæˆå’Œä½¿ç”¨
- å­—å…¸çš„ get() æ–¹æ³•
- f-string å’Œ format() æ ¼å¼åŒ–
- é”™è¯¯å¤„ç†

**LangGraph æŠ€èƒ½**ï¼š
- Store çš„åŸºæœ¬æ“ä½œ
- Checkpointer çš„ä½¿ç”¨
- é…ç½®ï¼ˆConfigï¼‰çš„ä¼ é€’
- çŠ¶æ€æ›´æ–°æœºåˆ¶
- æµå¼æ‰§è¡Œ

**ç³»ç»Ÿè®¾è®¡**ï¼š
- è®°å¿†ç³»ç»Ÿæ¶æ„
- å‘½åç©ºé—´è®¾è®¡
- çƒ­è·¯å¾„ vs å†·è·¯å¾„
- æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 15.3 ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  Module-5 çš„å…¶ä»–éƒ¨åˆ†ï¼š
1. **5.3 Memory Schema - Profile**ï¼š
   - æ›´ç»“æ„åŒ–çš„ç”¨æˆ·èµ„æ–™ç®¡ç†
   - ä½¿ç”¨ Pydantic å®šä¹‰æ¨¡å¼

2. **5.4 Memory Schema - Collection**ï¼š
   - ç®¡ç†è®°å¿†é›†åˆï¼ˆå¦‚å¤šä¸ªå…´è¶£ã€å¤šä¸ªåå¥½ï¼‰
   - ä½¿ç”¨ Trustcall æ›´æ–°

3. **é«˜çº§ä¸»é¢˜**ï¼š
   - è®°å¿†çš„æœç´¢å’Œæ£€ç´¢
   - è®°å¿†çš„ä¼˜å…ˆçº§å’Œé‡è¦æ€§
   - è®°å¿†çš„é—å¿˜æœºåˆ¶

---

## åå…­ã€é™„å½•

### A.1 å®Œæ•´ä»£ç æ¸…å•

```python
# å¯¼å…¥ä¾èµ–
from IPython.display import Image, display
from langgraph.checkpoint.memory import MemorySaver
from langgraph.graph import StateGraph, MessagesState, START, END
from langgraph.store.base import BaseStore
from langgraph.store.memory import InMemoryStore
from langchain_core.messages import HumanMessage, SystemMessage
from langchain_core.runnables.config import RunnableConfig
from langchain_openai import ChatOpenAI

# åˆå§‹åŒ–æ¨¡å‹
model = ChatOpenAI(model="gpt-5-nano", temperature=0)

# ç³»ç»Ÿæç¤ºè¯
MODEL_SYSTEM_MESSAGE = """You are a helpful assistant with memory that provides information about the user.
If you have memory for this user, use it to personalize your responses.
Here is the memory (it may be empty): {memory}"""

CREATE_MEMORY_INSTRUCTION = """You are collecting information about the user to personalize your responses.

CURRENT USER INFORMATION:
{memory}

INSTRUCTIONS:
1. Review the chat history below carefully
2. Identify new information about the user, such as:
   - Personal details (name, location)
   - Preferences (likes, dislikes)
   - Interests and hobbies
   - Past experiences
   - Goals or future plans
3. Merge any new information with existing memory
4. Format the memory as a clear, bulleted list
5. If new information conflicts with existing memory, keep the most recent version

Remember: Only include factual information directly stated by the user. Do not make assumptions or inferences.

Based on the chat history below, please update the user information:"""

# å®šä¹‰èŠ‚ç‚¹
def call_model(state: MessagesState, config: RunnableConfig, store: BaseStore):
    user_id = config["configurable"]["user_id"]
    namespace = ("memory", user_id)
    key = "user_memory"
    existing_memory = store.get(namespace, key)

    if existing_memory:
        existing_memory_content = existing_memory.value.get('memory')
    else:
        existing_memory_content = "No existing memory found."

    system_msg = MODEL_SYSTEM_MESSAGE.format(memory=existing_memory_content)
    response = model.invoke([SystemMessage(content=system_msg)] + state["messages"])
    return {"messages": response}

def write_memory(state: MessagesState, config: RunnableConfig, store: BaseStore):
    user_id = config["configurable"]["user_id"]
    namespace = ("memory", user_id)
    existing_memory = store.get(namespace, "user_memory")

    if existing_memory:
        existing_memory_content = existing_memory.value.get('memory')
    else:
        existing_memory_content = "No existing memory found."

    system_msg = CREATE_MEMORY_INSTRUCTION.format(memory=existing_memory_content)
    new_memory = model.invoke([SystemMessage(content=system_msg)] + state['messages'])
    key = "user_memory"
    store.put(namespace, key, {"memory": new_memory.content})

# æ„å»ºå›¾
builder = StateGraph(MessagesState)
builder.add_node("call_model", call_model)
builder.add_node("write_memory", write_memory)
builder.add_edge(START, "call_model")
builder.add_edge("call_model", "write_memory")
builder.add_edge("write_memory", END)

# ç¼–è¯‘å›¾
across_thread_memory = InMemoryStore()
within_thread_memory = MemorySaver()
graph = builder.compile(
    checkpointer=within_thread_memory,
    store=across_thread_memory
)

# ğŸ¨ å¯è§†åŒ–å›¾ç»“æ„
from IPython.display import Image, display
display(Image(graph.get_graph().draw_mermaid_png()))

# ä½¿ç”¨ç¤ºä¾‹
config = {"configurable": {"thread_id": "1", "user_id": "1"}}
input_messages = [HumanMessage(content="Hi, my name is Lance")]

for chunk in graph.stream({"messages": input_messages}, config, stream_mode="values"):
    chunk["messages"][-1].pretty_print()
```

### A.2 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```python
# åˆ›å»º Store
from langgraph.store.memory import InMemoryStore
store = InMemoryStore()

# ä¿å­˜æ•°æ®
store.put(
    namespace=("memory", "user_123"),
    key="user_memory",
    value={"memory": "User info here"}
)

# è·å–æ•°æ®
item = store.get(("memory", "user_123"), "user_memory")
if item:
    print(item.value)

# æœç´¢æ•°æ®
items = store.search(("memory", "user_123"))
for item in items:
    print(item.key, item.value)

# æŸ¥çœ‹çŠ¶æ€
state = graph.get_state({"configurable": {"thread_id": "1"}})
print(state.values)
```

---

## å®Œæ•´æ¡ˆä¾‹ä»£ç ï¼ˆå¯ç›´æ¥è¿è¡Œï¼‰

ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Memory Store ç¤ºä¾‹ï¼Œæ¼”ç¤ºçŸ­æœŸè®°å¿†ï¼ˆCheckpointerï¼‰å’Œé•¿æœŸè®°å¿†ï¼ˆStoreï¼‰çš„åä½œï¼š

```python
"""
LangGraph Memory Store å®Œæ•´ç¤ºä¾‹
æ¼”ç¤ºï¼šInMemoryStore çš„ put/get/search æ“ä½œ + è·¨ä¼šè¯è®°å¿†
"""
from langgraph.graph import StateGraph, MessagesState, START, END
from langgraph.checkpoint.memory import MemorySaver
from langgraph.store.memory import InMemoryStore
from langgraph.store.base import BaseStore
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage
from langchain_core.runnables import RunnableConfig

# ============ 1. åˆ›å»ºå­˜å‚¨ç³»ç»Ÿ ============

# é•¿æœŸè®°å¿†ï¼šè·¨ä¼šè¯å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
store = InMemoryStore()

# çŸ­æœŸè®°å¿†ï¼šå•æ¬¡ä¼šè¯çš„å¯¹è¯å†å²
checkpointer = MemorySaver()

# ============ 2. æ¼”ç¤º Store åŸºæœ¬æ“ä½œ ============

print("=" * 50)
print("Store åŸºæœ¬æ“ä½œæ¼”ç¤º")
print("=" * 50)

# put: ä¿å­˜æ•°æ®
store.put(
    namespace=("users", "alice"),  # å‘½åç©ºé—´ï¼šå…ƒç»„å½¢å¼
    key="profile",                  # é”®ï¼šå­—ç¬¦ä¸²
    value={"name": "Alice", "age": 28, "city": "Shanghai"}  # å€¼ï¼šå­—å…¸
)

store.put(
    namespace=("users", "alice"),
    key="preferences",
    value={"language": "Chinese", "theme": "dark"}
)

store.put(
    namespace=("users", "bob"),
    key="profile",
    value={"name": "Bob", "age": 32, "city": "Beijing"}
)

print("\nâœ… æ•°æ®å·²ä¿å­˜åˆ° Store")

# get: ç²¾ç¡®è·å–
item = store.get(("users", "alice"), "profile")
print(f"\nğŸ“– get alice/profile: {item.value}")

# search: æœç´¢å‘½åç©ºé—´ä¸‹æ‰€æœ‰æ•°æ®
print(f"\nğŸ” search alice çš„æ‰€æœ‰æ•°æ®:")
for item in store.search(("users", "alice")):
    print(f"   - {item.key}: {item.value}")

# ============ 3. å®šä¹‰èŠ‚ç‚¹å‡½æ•° ============

def chatbot(state: MessagesState, config: RunnableConfig, *, store: BaseStore):
    """èŠå¤©æœºå™¨äººèŠ‚ç‚¹ï¼šä½¿ç”¨é•¿æœŸè®°å¿†å“åº”ç”¨æˆ·"""
    user_id = config["configurable"].get("user_id", "default")

    # ä» Store è·å–ç”¨æˆ·èµ„æ–™
    profile_item = store.get(("users", user_id), "profile")
    profile = profile_item.value if profile_item else {}

    # è·å–ç”¨æˆ·åå¥½
    pref_item = store.get(("users", user_id), "preferences")
    preferences = pref_item.value if pref_item else {}

    # æ„å»ºå“åº”
    user_name = profile.get("name", "æœ‹å‹")
    user_city = profile.get("city", "æœªçŸ¥")

    last_msg = state["messages"][-1].content

    if "ä½ å¥½" in last_msg or "hi" in last_msg.lower():
        response = f"ä½ å¥½ {user_name}ï¼æˆ‘è®°å¾—ä½ ä½åœ¨{user_city}ã€‚ä»Šå¤©æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ"
    elif "è®°ä½" in last_msg:
        # è§£æå¹¶ä¿å­˜æ–°ä¿¡æ¯
        if "å–œæ¬¢" in last_msg:
            hobby = last_msg.split("å–œæ¬¢")[-1].strip().rstrip("ã€‚")
            profile["hobby"] = hobby
            store.put(("users", user_id), "profile", profile)
            response = f"å¥½çš„ï¼Œæˆ‘å·²ç»è®°ä½ä½ å–œæ¬¢{hobby}äº†ï¼"
        else:
            response = "å¥½çš„ï¼Œè¯·å‘Šè¯‰æˆ‘ä½ æƒ³è®©æˆ‘è®°ä½ä»€ä¹ˆï¼Ÿ"
    elif "æˆ‘çš„ä¿¡æ¯" in last_msg or "æˆ‘æ˜¯è°" in last_msg:
        info_parts = [f"å§“å: {profile.get('name', 'æœªçŸ¥')}"]
        info_parts.append(f"åŸå¸‚: {profile.get('city', 'æœªçŸ¥')}")
        if profile.get('hobby'):
            info_parts.append(f"çˆ±å¥½: {profile.get('hobby')}")
        if preferences:
            info_parts.append(f"åå¥½: {preferences}")
        response = "æ ¹æ®æˆ‘çš„è®°å¿†ï¼Œä½ çš„ä¿¡æ¯æ˜¯ï¼š\n" + "\n".join(info_parts)
    else:
        response = f"{user_name}ï¼Œæˆ‘ç†è§£ä½ è¯´çš„æ˜¯: {last_msg}"

    return {"messages": [AIMessage(content=response)]}

# ============ 4. æ„å»ºå›¾ ============

builder = StateGraph(MessagesState)
builder.add_node("chatbot", chatbot)
builder.add_edge(START, "chatbot")
builder.add_edge("chatbot", END)

# ç¼–è¯‘å›¾
graph = builder.compile(checkpointer=checkpointer, store=store)

# ============ 5. å¯è§†åŒ– ============

print("\n" + "=" * 50)
print("å›¾ç»“æ„")
print("=" * 50)

try:
    from IPython.display import display, Image
    display(Image(graph.get_graph().draw_mermaid_png()))
except Exception:
    print(graph.get_graph().draw_mermaid())

# ============ 6. æµ‹è¯•è¿è¡Œ ============

print("\n" + "=" * 50)
print("æµ‹è¯• 1: Alice çš„å¯¹è¯ï¼ˆä¼šè¯ 1ï¼‰")
print("=" * 50)

config_alice_1 = {"configurable": {"thread_id": "alice_session1", "user_id": "alice"}}

# å¯¹è¯ 1
result = graph.invoke(
    {"messages": [HumanMessage(content="ä½ å¥½")]},
    config_alice_1
)
print(f"Human: ä½ å¥½")
print(f"AI: {result['messages'][-1].content}")

# å¯¹è¯ 2 - åŒä¸€ä¼šè¯
result = graph.invoke(
    {"messages": [HumanMessage(content="è¯·è®°ä½æˆ‘å–œæ¬¢ç¼–ç¨‹")]},
    config_alice_1
)
print(f"\nHuman: è¯·è®°ä½æˆ‘å–œæ¬¢ç¼–ç¨‹")
print(f"AI: {result['messages'][-1].content}")

print("\n" + "=" * 50)
print("æµ‹è¯• 2: Alice çš„æ–°ä¼šè¯ï¼ˆéªŒè¯è·¨ä¼šè¯è®°å¿†ï¼‰")
print("=" * 50)

# æ–°ä¼šè¯ï¼Œç›¸åŒç”¨æˆ·
config_alice_2 = {"configurable": {"thread_id": "alice_session2", "user_id": "alice"}}

result = graph.invoke(
    {"messages": [HumanMessage(content="æˆ‘çš„ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Ÿ")]},
    config_alice_2
)
print(f"Human: æˆ‘çš„ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Ÿ")
print(f"AI: {result['messages'][-1].content}")

print("\n" + "=" * 50)
print("æµ‹è¯• 3: Bob çš„å¯¹è¯ï¼ˆä¸åŒç”¨æˆ·ï¼‰")
print("=" * 50)

config_bob = {"configurable": {"thread_id": "bob_session1", "user_id": "bob"}}

result = graph.invoke(
    {"messages": [HumanMessage(content="ä½ å¥½")]},
    config_bob
)
print(f"Human: ä½ å¥½")
print(f"AI: {result['messages'][-1].content}")

print("\n" + "=" * 50)
print("æµ‹è¯• 4: éªŒè¯ Store ä¸­çš„æ•°æ®")
print("=" * 50)

print("\nAlice çš„æ‰€æœ‰æ•°æ®:")
for item in store.search(("users", "alice")):
    print(f"  [{item.key}]: {item.value}")

print("\nBob çš„æ‰€æœ‰æ•°æ®:")
for item in store.search(("users", "bob")):
    print(f"  [{item.key}]: {item.value}")
```

**é¢„æœŸè¾“å‡º**ï¼š

```
==================================================
Store åŸºæœ¬æ“ä½œæ¼”ç¤º
==================================================

âœ… æ•°æ®å·²ä¿å­˜åˆ° Store

ğŸ“– get alice/profile: {'name': 'Alice', 'age': 28, 'city': 'Shanghai'}

ğŸ” search alice çš„æ‰€æœ‰æ•°æ®:
   - profile: {'name': 'Alice', 'age': 28, 'city': 'Shanghai'}
   - preferences: {'language': 'Chinese', 'theme': 'dark'}

==================================================
å›¾ç»“æ„
==================================================
[Mermaid å›¾è¾“å‡º]

==================================================
æµ‹è¯• 1: Alice çš„å¯¹è¯ï¼ˆä¼šè¯ 1ï¼‰
==================================================
Human: ä½ å¥½
AI: ä½ å¥½ Aliceï¼æˆ‘è®°å¾—ä½ ä½åœ¨Shanghaiã€‚ä»Šå¤©æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ

Human: è¯·è®°ä½æˆ‘å–œæ¬¢ç¼–ç¨‹
AI: å¥½çš„ï¼Œæˆ‘å·²ç»è®°ä½ä½ å–œæ¬¢ç¼–ç¨‹äº†ï¼

==================================================
æµ‹è¯• 2: Alice çš„æ–°ä¼šè¯ï¼ˆéªŒè¯è·¨ä¼šè¯è®°å¿†ï¼‰
==================================================
Human: æˆ‘çš„ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Ÿ
AI: æ ¹æ®æˆ‘çš„è®°å¿†ï¼Œä½ çš„ä¿¡æ¯æ˜¯ï¼š
å§“å: Alice
åŸå¸‚: Shanghai
çˆ±å¥½: ç¼–ç¨‹
åå¥½: {'language': 'Chinese', 'theme': 'dark'}

==================================================
æµ‹è¯• 3: Bob çš„å¯¹è¯ï¼ˆä¸åŒç”¨æˆ·ï¼‰
==================================================
Human: ä½ å¥½
AI: ä½ å¥½ Bobï¼æˆ‘è®°å¾—ä½ ä½åœ¨Beijingã€‚ä»Šå¤©æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ

==================================================
æµ‹è¯• 4: éªŒè¯ Store ä¸­çš„æ•°æ®
==================================================

Alice çš„æ‰€æœ‰æ•°æ®:
  [profile]: {'name': 'Alice', 'age': 28, 'city': 'Shanghai', 'hobby': 'ç¼–ç¨‹'}
  [preferences]: {'language': 'Chinese', 'theme': 'dark'}

Bob çš„æ‰€æœ‰æ•°æ®:
  [profile]: {'name': 'Bob', 'age': 32, 'city': 'Beijing'}
```

### å…³é”®æ¦‚å¿µæ€»ç»“

| æ¦‚å¿µ | è¯´æ˜ | ä»£ç ç¤ºä¾‹ |
|------|------|---------|
| **InMemoryStore** | å†…å­˜ä¸­çš„é”®å€¼å­˜å‚¨ | `store = InMemoryStore()` |
| **Namespace** | ç”¨å…ƒç»„ç»„ç»‡æ•°æ® | `("users", user_id)` |
| **put()** | ä¿å­˜æ•°æ® | `store.put(namespace, key, value)` |
| **get()** | ç²¾ç¡®è·å– | `store.get(namespace, key)` |
| **search()** | æœç´¢æ‰€æœ‰æ•°æ® | `store.search(namespace)` |
| **è·¨ä¼šè¯è®°å¿†** | ä¸åŒ thread_idï¼Œç›¸åŒ user_id | Store æ•°æ®æŒä¹…ä¿å­˜ |

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
**æœ€åæ›´æ–°**ï¼š2024-11-05
**ä½œè€…**ï¼šAI Assistant
**åŸºäº**ï¼šLangChain Academy Module-5 Lesson 5.2

å¸Œæœ›è¿™ä»½è¯¦ç»†è§£è¯»èƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£ LangGraph Store çš„ä½¿ç”¨å’Œè®°å¿†ç³»ç»Ÿçš„è®¾è®¡ï¼
