# 1.2 é«˜é˜¶å‡½æ•°ä¸å‡½æ•°å¼ç¼–ç¨‹

## å¼•è¨€ï¼šå‡½æ•°ä½œä¸ºä¸€ç­‰å…¬æ°‘

åœ¨ Python ä¸­ï¼Œå‡½æ•°ä¸ä»…ä»…æ˜¯ä»£ç å—â€”â€”å®ƒä»¬æ˜¯**ä¸€ç­‰å…¬æ°‘ï¼ˆFirst-Class Citizensï¼‰**ã€‚è¿™æ„å‘³ç€å‡½æ•°å¯ä»¥ï¼š
- èµ‹å€¼ç»™å˜é‡
- ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–å‡½æ•°
- ä½œä¸ºè¿”å›å€¼ä»å‡½æ•°ä¸­è¿”å›
- å­˜å‚¨åœ¨æ•°æ®ç»“æ„ä¸­ï¼ˆå¦‚åˆ—è¡¨ã€å­—å…¸ï¼‰

è¿™ç§ç‰¹æ€§ä½¿å¾— Python èƒ½å¤Ÿæ”¯æŒ**å‡½æ•°å¼ç¼–ç¨‹**èŒƒå¼ï¼Œè€Œè¿™æ­£æ˜¯ LangChain å’Œ LangGraph å¤§é‡ä½¿ç”¨çš„ç¼–ç¨‹é£æ ¼ã€‚

## å­¦ä¹ ç›®æ ‡

- âœ… ç†è§£å‡½æ•°ä½œä¸ºä¸€ç­‰å…¬æ°‘çš„æ¦‚å¿µ
- âœ… æŒæ¡ map(), filter(), reduce() ç­‰é«˜é˜¶å‡½æ•°
- âœ… ä½¿ç”¨ Lambda è¡¨è¾¾å¼ç®€åŒ–ä»£ç 
- âœ… ç†è§£é—­åŒ…ï¼ˆClosureï¼‰æœºåˆ¶
- âœ… å®æˆ˜ï¼šæ„å»ºå¯é…ç½®çš„ Agent å·¥å‚

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šå‡½æ•°ä½œä¸ºä¸€ç­‰å…¬æ°‘

### å‡½æ•°å¯ä»¥èµ‹å€¼ç»™å˜é‡

```python
def greet(name: str) -> str:
    return f"Hello, {name}!"

# å°†å‡½æ•°èµ‹å€¼ç»™å˜é‡
say_hello = greet

# é€šè¿‡å˜é‡è°ƒç”¨å‡½æ•°
message = say_hello("Claude")
print(message)  # Hello, Claude!

# å‡½æ•°åæœ¬èº«å°±æ˜¯å¯¹å‡½æ•°å¯¹è±¡çš„å¼•ç”¨
print(type(greet))  # <class 'function'>
print(greet)        # <function greet at 0x...>
```

### å‡½æ•°å¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’

```python
def apply_operation(
    value: int,
    operation: callable
) -> int:
    """
    å¯¹å€¼åº”ç”¨æ“ä½œå‡½æ•°
    
    Args:
        value: è¾“å…¥å€¼
        operation: è¦åº”ç”¨çš„å‡½æ•°
    
    Returns:
        æ“ä½œåçš„ç»“æœ
    """
    return operation(value)

# å®šä¹‰å‡ ä¸ªæ“ä½œå‡½æ•°
def double(x: int) -> int:
    return x * 2

def square(x: int) -> int:
    return x ** 2

# ä¼ é€’ä¸åŒçš„å‡½æ•°
result1 = apply_operation(5, double)  # 10
result2 = apply_operation(5, square)  # 25

print(f"Double: {result1}, Square: {result2}")
```

> **ğŸ”— ä¸ Agent çš„è”ç³»**ï¼šLangGraph çš„æ¡ä»¶è·¯ç”±å°±æ˜¯ä¼ é€’å‡½æ•°ä½œä¸ºå‚æ•°ï¼š
> ```python
> workflow.add_conditional_edges(
>     "agent",
>     lambda x: "tools" if x["needs_tool"] else "end"
> )
> ```

### å‡½æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼

```python
def create_multiplier(factor: int) -> callable:
    """
    åˆ›å»ºä¸€ä¸ªä¹˜æ³•å‡½æ•°å·¥å‚
    
    Args:
        factor: ä¹˜æ•°å› å­
    
    Returns:
        ä¸€ä¸ªæ‰§è¡Œä¹˜æ³•çš„å‡½æ•°
    """
    def multiplier(x: int) -> int:
        return x * factor
    
    return multiplier

# åˆ›å»ºä¸åŒçš„ä¹˜æ³•å™¨
double = create_multiplier(2)
triple = create_multiplier(3)

print(double(5))  # 10
print(triple(5))  # 15
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šå†…ç½®é«˜é˜¶å‡½æ•°

### map() - æ˜ å°„è½¬æ¢

```python
# ä¼ ç»Ÿæ–¹å¼
messages = ["hello", "world", "ai"]
uppercased = []
for msg in messages:
    uppercased.append(msg.upper())

# ä½¿ç”¨ map()
messages = ["hello", "world", "ai"]
uppercased = list(map(str.upper, messages))
print(uppercased)  # ['HELLO', 'WORLD', 'AI']

# ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°
def format_message(msg: str) -> str:
    return f"[Agent] {msg}"

formatted = list(map(format_message, messages))
print(formatted)  # ['[Agent] hello', '[Agent] world', '[Agent] ai']
```

**AI Agent åº”ç”¨**ï¼š
```python
# æ‰¹é‡æ ¼å¼åŒ–æç¤ºè¯
prompts = ["Explain AI", "What is ML", "Define NLP"]

def create_full_prompt(query: str) -> str:
    return f"You are a helpful assistant. User asks: {query}"

full_prompts = list(map(create_full_prompt, prompts))
```

### filter() - è¿‡æ»¤ç­›é€‰

```python
# è¿‡æ»¤å‡ºæœ‰æ•ˆçš„æ¶ˆæ¯ï¼ˆéç©ºï¼‰
messages = ["Hello", "", "World", "", "AI"]
valid_messages = list(filter(lambda x: x != "", messages))
print(valid_messages)  # ['Hello', 'World', 'AI']

# è¿‡æ»¤å‡ºé«˜ç½®ä¿¡åº¦çš„ç»“æœ
results = [
    {"text": "Result 1", "confidence": 0.9},
    {"text": "Result 2", "confidence": 0.3},
    {"text": "Result 3", "confidence": 0.8},
]

def is_high_confidence(result: dict) -> bool:
    return result["confidence"] >= 0.7

high_conf_results = list(filter(is_high_confidence, results))
print(len(high_conf_results))  # 2
```

### reduce() - ç´¯ç§¯èšåˆ

```python
from functools import reduce

# è®¡ç®—æ€» token æ•°
token_counts = [100, 250, 180, 320]
total = reduce(lambda a, b: a + b, token_counts)
print(f"Total tokens: {total}")  # 850

# æ›´å¤æ‚çš„ä¾‹å­ï¼šåˆå¹¶å¤šä¸ªå­—å…¸
configs = [
    {"model": "gpt-3.5-turbo"},
    {"temperature": 0.7},
    {"max_tokens": 2000},
]

def merge_dicts(dict1: dict, dict2: dict) -> dict:
    return {**dict1, **dict2}

merged_config = reduce(merge_dicts, configs)
print(merged_config)
# {'model': 'gpt-3.5-turbo', 'temperature': 0.7, 'max_tokens': 2000}
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šLambda è¡¨è¾¾å¼

### Lambda åŸºç¡€

```python
# æ™®é€šå‡½æ•°
def add(x: int, y: int) -> int:
    return x + y

# ç­‰ä»·çš„ Lambda è¡¨è¾¾å¼
add_lambda = lambda x, y: x + y

print(add(3, 5))        # 8
print(add_lambda(3, 5)) # 8
```

### Lambda çš„é€‚ç”¨åœºæ™¯

```python
# 1. ä½œä¸º sort çš„ key å‚æ•°
agents = [
    {"name": "Agent A", "score": 85},
    {"name": "Agent B", "score": 92},
    {"name": "Agent C", "score": 78},
]

# æŒ‰åˆ†æ•°æ’åº
sorted_agents = sorted(agents, key=lambda x: x["score"], reverse=True)
print([a["name"] for a in sorted_agents])  # ['Agent B', 'Agent A', 'Agent C']

# 2. åœ¨ map/filter ä¸­ä½¿ç”¨
numbers = [1, 2, 3, 4, 5]
squares = list(map(lambda x: x ** 2, numbers))
evens = list(filter(lambda x: x % 2 == 0, numbers))

# 3. LangGraph æ¡ä»¶è·¯ç”±
# workflow.add_conditional_edges(
#     "agent",
#     lambda x: "continue" if x["iteration"] < 5 else "end"
# )
```

> **âš ï¸ Lambda çš„é™åˆ¶**ï¼š
> - åªèƒ½åŒ…å«å•ä¸ªè¡¨è¾¾å¼
> - ä¸èƒ½åŒ…å«è¯­å¥ï¼ˆå¦‚ if/for/whileï¼‰
> - ä¸èƒ½æœ‰ç±»å‹æ³¨è§£
> - éš¾ä»¥è°ƒè¯•

**æœ€ä½³å®è·µ**ï¼š
- âœ… ç®€å•çš„å•è¡Œæ“ä½œä½¿ç”¨ Lambda
- âŒ å¤æ‚é€»è¾‘ä½¿ç”¨å‘½åå‡½æ•°

---

## ç¬¬å››éƒ¨åˆ†ï¼šé—­åŒ…ï¼ˆClosureï¼‰

### ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿ

é—­åŒ…æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒ"è®°ä½"äº†å®šä¹‰æ—¶çš„å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡ã€‚

```python
def create_counter(start: int = 0):
    """
    åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨é—­åŒ…
    
    Args:
        start: èµ·å§‹å€¼
    
    Returns:
        è®¡æ•°å™¨å‡½æ•°
    """
    count = start  # å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡
    
    def counter() -> int:
        nonlocal count  # å£°æ˜ä½¿ç”¨å¤–éƒ¨å˜é‡
        count += 1
        return count
    
    return counter

# åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨
counter1 = create_counter(0)
counter2 = create_counter(100)

print(counter1())  # 1
print(counter1())  # 2
print(counter2())  # 101
print(counter1())  # 3
```

### AI Agent ä¸­çš„é—­åŒ…åº”ç”¨

```python
def create_rate_limiter(max_calls: int, window_seconds: int):
    """
    åˆ›å»ºä¸€ä¸ªé€Ÿç‡é™åˆ¶å™¨ï¼ˆé—­åŒ…å®ç°ï¼‰
    
    Args:
        max_calls: æ—¶é—´çª—å£å†…æœ€å¤§è°ƒç”¨æ¬¡æ•°
        window_seconds: æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
    
    Returns:
        æ£€æŸ¥å‡½æ•°
    """
    import time
    from collections import deque
    
    call_times = deque(maxlen=max_calls)
    
    def can_call() -> bool:
        """æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘èµ·è°ƒç”¨"""
        now = time.time()
        
        # ç§»é™¤çª—å£å¤–çš„è°ƒç”¨è®°å½•
        while call_times and call_times[0] < now - window_seconds:
            call_times.popleft()
        
        if len(call_times) < max_calls:
            call_times.append(now)
            return True
        
        return False
    
    return can_call

# ä½¿ç”¨é€Ÿç‡é™åˆ¶å™¨
rate_limiter = create_rate_limiter(max_calls=3, window_seconds=10)

for i in range(5):
    if rate_limiter.can_call():
        print(f"è°ƒç”¨ #{i+1} å…è®¸")
    else:
        print(f"è°ƒç”¨ #{i+1} è¢«é™åˆ¶")
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®æˆ˜ - å¯é…ç½®çš„ Agent å·¥å‚

```python
"""
Agent å·¥å‚ï¼šä½¿ç”¨é«˜é˜¶å‡½æ•°å’Œé—­åŒ…æ„å»ºå¯é…ç½®çš„ Agent
"""

from typing import Callable, Optional


def create_agent_factory(
    default_model: str = "gpt-3.5-turbo",
    default_temperature: float = 0.7
) -> Callable:
    """
    åˆ›å»º Agent å·¥å‚å‡½æ•°
    
    è¿™æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªé…ç½®å¥½çš„ Agent åˆ›å»ºå™¨
    
    Args:
        default_model: é»˜è®¤æ¨¡å‹
        default_temperature: é»˜è®¤æ¸©åº¦
    
    Returns:
        Agent åˆ›å»ºå‡½æ•°
    """
    def create_agent(
        name: str,
        system_prompt: str,
        tools: Optional[list] = None,
        model: Optional[str] = None,
        temperature: Optional[float] = None
    ) -> dict:
        """
        åˆ›å»º Agent å®ä¾‹
        
        Args:
            name: Agent åç§°
            system_prompt: ç³»ç»Ÿæç¤ºè¯
            tools: å¯ç”¨å·¥å…·åˆ—è¡¨
            model: æ¨¡å‹ï¼ˆå¯é€‰ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰
            temperature: æ¸©åº¦ï¼ˆå¯é€‰ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰
        
        Returns:
            Agent é…ç½®å­—å…¸
        """
        return {
            "name": name,
            "model": model or default_model,
            "temperature": temperature or default_temperature,
            "system_prompt": system_prompt,
            "tools": tools or [],
            "created_with_defaults": {
                "model": default_model,
                "temperature": default_temperature
            }
        }
    
    return create_agent


def create_tool_registry():
    """
    åˆ›å»ºå·¥å…·æ³¨å†Œè¡¨ï¼ˆä½¿ç”¨é—­åŒ…ï¼‰
    
    Returns:
        åŒ…å«æ³¨å†Œå’Œè·å–å‡½æ•°çš„å­—å…¸
    """
    tools: dict[str, Callable] = {}
    
    def register(name: str, func: Callable) -> None:
        """æ³¨å†Œå·¥å…·"""
        tools[name] = func
        print(f"å·¥å…· '{name}' å·²æ³¨å†Œ")
    
    def get(name: str) -> Optional[Callable]:
        """è·å–å·¥å…·"""
        return tools.get(name)
    
    def list_tools() -> list[str]:
        """åˆ—å‡ºæ‰€æœ‰å·¥å…·"""
        return list(tools.keys())
    
    return {
        "register": register,
        "get": get,
        "list": list_tools
    }


def compose(*functions: Callable) -> Callable:
    """
    å‡½æ•°ç»„åˆï¼šå°†å¤šä¸ªå‡½æ•°ç»„åˆæˆä¸€ä¸ª
    
    Args:
        *functions: è¦ç»„åˆçš„å‡½æ•°åˆ—è¡¨
    
    Returns:
        ç»„åˆåçš„å‡½æ•°
    
    Example:
        >>> def add_one(x): return x + 1
        >>> def double(x): return x * 2
        >>> f = compose(add_one, double)
        >>> f(3)  # double(add_one(3)) = double(4) = 8
        8
    """
    from functools import reduce
    
    def compose_two(f: Callable, g: Callable) -> Callable:
        return lambda x: g(f(x))
    
    return reduce(compose_two, functions, lambda x: x)


# æ¼”ç¤ºä½¿ç”¨
def main() -> None:
    """ä¸»å‡½æ•°ï¼šæ¼”ç¤ºé«˜é˜¶å‡½æ•°å’Œé—­åŒ…"""
    
    # 1. Agent å·¥å‚
    print("=== Agent å·¥å‚ ===")
    factory = create_agent_factory(
        default_model="gpt-4",
        default_temperature=0.5
    )
    
    agent1 = factory(
        name="ResearchBot",
        system_prompt="You are a research assistant"
    )
    
    agent2 = factory(
        name="ChatBot",
        system_prompt="You are a friendly chatbot",
        model="gpt-3.5-turbo",
        temperature=0.9
    )
    
    print(f"Agent1: {agent1['name']}, æ¨¡å‹: {agent1['model']}")
    print(f"Agent2: {agent2['name']}, æ¨¡å‹: {agent2['model']}")
    
    # 2. å·¥å…·æ³¨å†Œè¡¨
    print("\n=== å·¥å…·æ³¨å†Œè¡¨ ===")
    registry = create_tool_registry()
    
    def weather_tool(location: str) -> str:
        return f"Weather in {location}: Sunny"
    
    def calculator_tool(expression: str) -> str:
        return f"Calculating: {expression}"
    
    registry["register"]("weather", weather_tool)
    registry["register"]("calculator", calculator_tool)
    
    print(f"å·²æ³¨å†Œå·¥å…·: {registry['list']()}")
    
    tool = registry["get"]("weather")
    if tool:
        print(tool("Beijing"))
    
    # 3. å‡½æ•°ç»„åˆ
    print("\n=== å‡½æ•°ç»„åˆ ===")
    
    def clean_text(text: str) -> str:
        return text.strip().lower()
    
    def remove_punctuation(text: str) -> str:
        import string
        return text.translate(str.maketrans("", "", string.punctuation))
    
    def tokenize(text: str) -> list[str]:
        return text.split()
    
    # ç»„åˆå¤„ç†æµç¨‹
    process_text = compose(clean_text, remove_punctuation)
    
    input_text = "  Hello, World!  "
    processed = process_text(input_text)
    print(f"åŸå§‹: '{input_text}'")
    print(f"å¤„ç†å: '{processed}'")


if __name__ == "__main__":
    main()
```

---

## æœ¬èŠ‚æ€»ç»“

### æ ¸å¿ƒæ¦‚å¿µ

1. **å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘** - å¯ä»¥åƒå˜é‡ä¸€æ ·ä¼ é€’å’Œæ“ä½œ
2. **é«˜é˜¶å‡½æ•°** - æ¥å—å‡½æ•°ä½œä¸ºå‚æ•°æˆ–è¿”å›å‡½æ•°
3. **map/filter/reduce** - å‡½æ•°å¼ç¼–ç¨‹çš„ä¸‰å¤§åŸºçŸ³
4. **Lambda** - ç®€æ´çš„åŒ¿åå‡½æ•°
5. **é—­åŒ…** - è®°ä½å¤–éƒ¨ä½œç”¨åŸŸçš„å‡½æ•°

### ä¸ AI Agent çš„è”ç³»

| æ¦‚å¿µ | åœ¨ Agent ä¸­çš„åº”ç”¨ |
|------|------------------|
| **é«˜é˜¶å‡½æ•°** | Agent å·¥å‚ã€é…ç½®ç”Ÿæˆå™¨ |
| **Lambda** | LangGraph æ¡ä»¶è·¯ç”± |
| **é—­åŒ…** | é€Ÿç‡é™åˆ¶å™¨ã€çŠ¶æ€ç®¡ç† |
| **map** | æ‰¹é‡å¤„ç†æç¤ºè¯ã€ç»“æœ |
| **filter** | ç­›é€‰é«˜è´¨é‡å“åº” |
| **compose** | æ„å»ºå¤„ç†ç®¡é“ |

---

**ä¸‹ä¸€èŠ‚ï¼š[1.3 è£…é¥°å™¨ï¼šLangChain çš„æ ¸å¿ƒæ¨¡å¼](1.3-è£…é¥°å™¨ï¼šLangChainçš„æ ¸å¿ƒæ¨¡å¼.md)**
