# 1.2 é«˜é˜¶å‡½æ•°ä¸å‡½æ•°å¼ç¼–ç¨‹

## å¼•è¨€ï¼šå‡½æ•°ä½œä¸ºä¸€ç­‰å…¬æ°‘

åœ¨ Python ä¸­ï¼Œå‡½æ•°ä¸ä»…ä»…æ˜¯ä»£ç å—â€”â€”å®ƒä»¬æ˜¯**ä¸€ç­‰å…¬æ°‘ï¼ˆFirst-Class Citizensï¼‰**ã€‚è¿™æ„å‘³ç€å‡½æ•°å¯ä»¥ï¼š
- èµ‹å€¼ç»™å˜é‡
- ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–å‡½æ•°
- ä½œä¸ºè¿”å›å€¼ä»å‡½æ•°ä¸­è¿”å›
- å­˜å‚¨åœ¨æ•°æ®ç»“æ„ä¸­ï¼ˆå¦‚åˆ—è¡¨ã€å­—å…¸ï¼‰

è¿™ç§ç‰¹æ€§ä½¿å¾— Python èƒ½å¤Ÿæ”¯æŒ**å‡½æ•°å¼ç¼–ç¨‹**èŒƒå¼ï¼Œè€Œè¿™æ­£æ˜¯ LangChain å’Œ LangGraph å¤§é‡ä½¿ç”¨çš„ç¼–ç¨‹é£æ ¼ã€‚

> **é€šä¿—ç†è§£**ï¼šæƒ³è±¡å‡½æ•°å°±åƒä¸€å¼ **é£Ÿè°±å¡ç‰‡**ã€‚åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œé£Ÿè°±åªèƒ½è¢«å¨å¸ˆä½¿ç”¨ï¼›ä½†åœ¨ Python ä¸­ï¼Œè¿™å¼ é£Ÿè°±å¡ç‰‡å¯ä»¥ï¼š
> - äº¤ç»™åˆ«äººï¼ˆèµ‹å€¼ç»™å˜é‡ï¼‰
> - æ”¾è¿›ä¸€ä¸ª"é£Ÿè°±ç›’"é‡Œï¼ˆå­˜å‚¨åœ¨åˆ—è¡¨ä¸­ï¼‰
> - å‘Šè¯‰å¦ä¸€ä¸ªå¨å¸ˆ"æŒ‰è¿™ä¸ªåš"ï¼ˆä½œä¸ºå‚æ•°ä¼ é€’ï¼‰
> - ç”šè‡³å¯ä»¥"åˆ¶é€ "å‡ºæ–°çš„é£Ÿè°±ï¼ˆä½œä¸ºè¿”å›å€¼ï¼‰

## å­¦ä¹ ç›®æ ‡

- âœ… ç†è§£å‡½æ•°ä½œä¸ºä¸€ç­‰å…¬æ°‘çš„æ¦‚å¿µ
- âœ… æŒæ¡ map(), filter(), reduce() ç­‰é«˜é˜¶å‡½æ•°
- âœ… ä½¿ç”¨ Lambda è¡¨è¾¾å¼ç®€åŒ–ä»£ç 
- âœ… ç†è§£é—­åŒ…ï¼ˆClosureï¼‰æœºåˆ¶
- âœ… å®æˆ˜ï¼šæ„å»ºå¯é…ç½®çš„ Agent å·¥å‚

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šå‡½æ•°ä½œä¸ºä¸€ç­‰å…¬æ°‘

### ä¸ºä»€ä¹ˆéœ€è¦ç†è§£è¿™ä¸ªï¼Ÿ

> **å°ç™½è§£è¯»**ï¼šå¦‚æœä½ ä¸ç†è§£"å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘"ï¼Œä½ ä¼šè§‰å¾—å¾ˆå¤šé«˜çº§ä»£ç "çœ‹ä¸æ‡‚"ã€‚æ¯”å¦‚ LangGraph ä¸­ç»å¸¸å‡ºç°ï¼š
> ```python
> workflow.add_conditional_edges("agent", some_function)
> ```
> ä¸ºä»€ä¹ˆ `some_function` åé¢æ²¡æœ‰æ‹¬å· `()` ï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨**ä¼ é€’å‡½æ•°æœ¬èº«**ï¼Œè€Œä¸æ˜¯è°ƒç”¨å®ƒï¼

### å‡½æ•°å¯ä»¥èµ‹å€¼ç»™å˜é‡

```python
def greet(name: str) -> str:
    return f"Hello, {name}!"

# å°†å‡½æ•°èµ‹å€¼ç»™å˜é‡
say_hello = greet

# é€šè¿‡å˜é‡è°ƒç”¨å‡½æ•°
message = say_hello("Claude")
print(message)  # Hello, Claude!

# å‡½æ•°åæœ¬èº«å°±æ˜¯å¯¹å‡½æ•°å¯¹è±¡çš„å¼•ç”¨
print(type(greet))  # <class 'function'>
print(greet)        # <function greet at 0x...>
```

> **é€šä¿—ç†è§£**ï¼š
> - `greet` æ˜¯å‡½æ•°çš„"åå­—"ï¼Œå°±åƒä½ çš„åå­—
> - `say_hello = greet` å°±åƒç»™ä½ èµ·ä¸€ä¸ª"å¤–å·"
> - ç”¨åå­—æˆ–å¤–å·éƒ½èƒ½æ‰¾åˆ°ä½ ï¼ˆè°ƒç”¨ä½ ï¼‰
> - **å…³é”®**ï¼š`greet`ï¼ˆæ²¡æœ‰æ‹¬å·ï¼‰= å‡½æ•°æœ¬èº«ï¼›`greet()`ï¼ˆæœ‰æ‹¬å·ï¼‰= è°ƒç”¨å‡½æ•°

### å‡½æ•°å¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’

```python
def apply_operation(
    value: int,
    operation: callable
) -> int:
    """
    å¯¹å€¼åº”ç”¨æ“ä½œå‡½æ•°

    Args:
        value: è¾“å…¥å€¼
        operation: è¦åº”ç”¨çš„å‡½æ•°

    Returns:
        æ“ä½œåçš„ç»“æœ
    """
    return operation(value)

# å®šä¹‰å‡ ä¸ªæ“ä½œå‡½æ•°
def double(x: int) -> int:
    return x * 2

def square(x: int) -> int:
    return x ** 2

# ä¼ é€’ä¸åŒçš„å‡½æ•°
result1 = apply_operation(5, double)  # 10
result2 = apply_operation(5, square)  # 25

print(f"Double: {result1}, Square: {result2}")
```

> **é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ æ˜¯ä¸€ä¸ª**ä¸‡èƒ½è®¡ç®—å™¨**ï¼ˆ`apply_operation`ï¼‰ï¼š
> - ç”¨æˆ·ç»™ä½ ä¸€ä¸ªæ•°å­—ï¼ˆ`value`ï¼‰
> - ç”¨æˆ·è¿˜ç»™ä½ ä¸€å¼ "æ“ä½œè¯´æ˜"ï¼ˆ`operation`ï¼‰
> - ä½ æŒ‰ç…§è¯´æ˜æ¥å¤„ç†è¿™ä¸ªæ•°å­—
>
> è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼š**è®¡ç®—å™¨ä¸éœ€è¦æå‰çŸ¥é“æ‰€æœ‰å¯èƒ½çš„æ“ä½œ**ã€‚ç”¨æˆ·å¯ä»¥éšæ—¶"å‘æ˜"æ–°æ“ä½œï¼Œç„¶åä¼ ç»™ä½ ï¼

> **ğŸ”— ä¸ Agent çš„è”ç³»**ï¼šLangGraph çš„æ¡ä»¶è·¯ç”±å°±æ˜¯ä¼ é€’å‡½æ•°ä½œä¸ºå‚æ•°ï¼š
> ```python
> workflow.add_conditional_edges(
>     "agent",
>     lambda x: "tools" if x["needs_tool"] else "end"
> )
> ```

### å‡½æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼

```python
def create_multiplier(factor: int) -> callable:
    """
    åˆ›å»ºä¸€ä¸ªä¹˜æ³•å‡½æ•°å·¥å‚

    Args:
        factor: ä¹˜æ•°å› å­

    Returns:
        ä¸€ä¸ªæ‰§è¡Œä¹˜æ³•çš„å‡½æ•°
    """
    def multiplier(x: int) -> int:
        return x * factor

    return multiplier

# åˆ›å»ºä¸åŒçš„ä¹˜æ³•å™¨
double = create_multiplier(2)
triple = create_multiplier(3)

print(double(5))  # 10
print(triple(5))  # 15
```

> **é€šä¿—ç†è§£ - å‡½æ•°å·¥å‚**ï¼š
>
> æƒ³è±¡ `create_multiplier` æ˜¯ä¸€ä¸ª**æœºå™¨åˆ¶é€ å‚**ï¼š
> - ä½ å‘Šè¯‰å·¥å‚ï¼š"æˆ‘è¦ä¸€ä¸ªÃ—2çš„æœºå™¨"
> - å·¥å‚ç»™ä½ é€ å‡º `double` è¿™å°æœºå™¨
> - ä½ å‘Šè¯‰å·¥å‚ï¼š"æˆ‘è¦ä¸€ä¸ªÃ—3çš„æœºå™¨"
> - å·¥å‚ç»™ä½ é€ å‡º `triple` è¿™å°æœºå™¨
>
> æ¯å°æœºå™¨éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œäº’ä¸å½±å“ã€‚è¿™å°±æ˜¯"**å‡½æ•°è¿”å›å‡½æ•°**"çš„å¨åŠ›ï¼

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šå†…ç½®é«˜é˜¶å‡½æ•°

> **ä»€ä¹ˆæ˜¯é«˜é˜¶å‡½æ•°ï¼Ÿ**
>
> æ¥å—å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œæˆ–è€…è¿”å›å‡½æ•°çš„å‡½æ•°ï¼Œå°±å«**é«˜é˜¶å‡½æ•°**ã€‚
>
> ç±»æ¯”ï¼šæ™®é€šå‡½æ•°åƒæ˜¯"å·¥äºº"ï¼Œåªèƒ½å¹²æ´»ï¼›é«˜é˜¶å‡½æ•°åƒæ˜¯"åŒ…å·¥å¤´"ï¼Œå¯ä»¥æŒ‡æŒ¥å·¥äººå¹²æ´»ã€‚

### map() - æ˜ å°„è½¬æ¢

**ä¸€å¥è¯è§£é‡Š**ï¼š`map()` å°±æ˜¯"å¯¹åˆ—è¡¨ä¸­çš„**æ¯ä¸€ä¸ªå…ƒç´ **æ‰§è¡Œç›¸åŒçš„æ“ä½œ"ã€‚

```python
# ä¼ ç»Ÿæ–¹å¼
messages = ["hello", "world", "ai"]
uppercased = []
for msg in messages:
    uppercased.append(msg.upper())

# ä½¿ç”¨ map()
messages = ["hello", "world", "ai"]
uppercased = list(map(str.upper, messages))
print(uppercased)  # ['HELLO', 'WORLD', 'AI']

# ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°
def format_message(msg: str) -> str:
    return f"[Agent] {msg}"

formatted = list(map(format_message, messages))
print(formatted)  # ['[Agent] hello', '[Agent] world', '[Agent] ai']
```

> **é€šä¿—ç†è§£ - æµæ°´çº¿å·¥å‚**ï¼š
>
> æƒ³è±¡ä½ æœ‰ä¸€æ¡**æµæ°´çº¿**ï¼š
> ```
> åŸææ–™ â†’ [å·¥äºº1] â†’ [å·¥äºº2] â†’ [å·¥äºº3] â†’ æˆå“
> hello     â†“         â†“          â†“
>           HELLO     HELLO      HELLO
> world     â†“         â†“          â†“
>           WORLD     WORLD      WORLD
> ai        â†“         â†“          â†“
>           AI        AI         AI
> ```
>
> `map(str.upper, messages)` å°±æ˜¯ï¼š
> - åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ ä¾æ¬¡è¿›å…¥æµæ°´çº¿
> - æ¯ä¸ªå…ƒç´ éƒ½è¢« `str.upper` è¿™ä¸ª"å·¥äºº"å¤„ç†
> - å¤„ç†å®Œçš„ç»“æœç»„æˆæ–°åˆ—è¡¨

**AI Agent åº”ç”¨**ï¼š
```python
# æ‰¹é‡æ ¼å¼åŒ–æç¤ºè¯
prompts = ["Explain AI", "What is ML", "Define NLP"]

def create_full_prompt(query: str) -> str:
    return f"You are a helpful assistant. User asks: {query}"

full_prompts = list(map(create_full_prompt, prompts))
```

### filter() - è¿‡æ»¤ç­›é€‰

**ä¸€å¥è¯è§£é‡Š**ï¼š`filter()` å°±æ˜¯"åªä¿ç•™**ç¬¦åˆæ¡ä»¶**çš„å…ƒç´ "ã€‚

```python
# è¿‡æ»¤å‡ºæœ‰æ•ˆçš„æ¶ˆæ¯ï¼ˆéç©ºï¼‰
messages = ["Hello", "", "World", "", "AI"]
valid_messages = list(filter(lambda x: x != "", messages))
print(valid_messages)  # ['Hello', 'World', 'AI']

# è¿‡æ»¤å‡ºé«˜ç½®ä¿¡åº¦çš„ç»“æœ
results = [
    {"text": "Result 1", "confidence": 0.9},
    {"text": "Result 2", "confidence": 0.3},
    {"text": "Result 3", "confidence": 0.8},
]

def is_high_confidence(result: dict) -> bool:
    return result["confidence"] >= 0.7

high_conf_results = list(filter(is_high_confidence, results))
print(len(high_conf_results))  # 2
```

> **é€šä¿—ç†è§£ - å®‰æ£€é—¨**ï¼š
>
> æƒ³è±¡ `filter()` æ˜¯ä¸€é“**å®‰æ£€é—¨**ï¼š
> ```
> æ‰€æœ‰ä¹˜å®¢ â†’ [å®‰æ£€é—¨ï¼šæœ‰ç¥¨å—ï¼Ÿ] â†’ é€šè¿‡çš„ä¹˜å®¢
>    å¼ ä¸‰ âœ…    â†’    é€šè¿‡
>    æå›› âŒ    â†’    æ‹¦ä¸‹
>    ç‹äº” âœ…    â†’    é€šè¿‡
> ```
>
> `filter(is_high_confidence, results)` å°±æ˜¯ï¼š
> - æ¯ä¸ªç»“æœéƒ½è¦è¿‡"å®‰æ£€"
> - å®‰æ£€å‘˜ï¼ˆ`is_high_confidence`ï¼‰æ£€æŸ¥æ˜¯å¦ç¬¦åˆæ¡ä»¶
> - åªæœ‰è¿”å› `True` çš„æ‰èƒ½é€šè¿‡

### reduce() - ç´¯ç§¯èšåˆ

**ä¸€å¥è¯è§£é‡Š**ï¼š`reduce()` å°±æ˜¯"æŠŠåˆ—è¡¨ä¸­çš„æ‰€æœ‰å…ƒç´ **é€ä¸ªç´¯ç§¯**æˆä¸€ä¸ªç»“æœ"ã€‚

```python
from functools import reduce

# è®¡ç®—æ€» token æ•°
token_counts = [100, 250, 180, 320]
total = reduce(lambda a, b: a + b, token_counts)
print(f"Total tokens: {total}")  # 850

# æ›´å¤æ‚çš„ä¾‹å­ï¼šåˆå¹¶å¤šä¸ªå­—å…¸
configs = [
    {"model": "gpt-3.5-turbo"},
    {"temperature": 0.7},
    {"max_tokens": 2000},
]

def merge_dicts(dict1: dict, dict2: dict) -> dict:
    return {**dict1, **dict2}

merged_config = reduce(merge_dicts, configs)
print(merged_config)
# {'model': 'gpt-3.5-turbo', 'temperature': 0.7, 'max_tokens': 2000}
```

> **é€šä¿—ç†è§£ - æ»šé›ªçƒ**ï¼š
>
> æƒ³è±¡ä½ åœ¨**æ»šé›ªçƒ**ï¼š
> ```
> èµ·ç‚¹     ç¬¬1æ¬¡      ç¬¬2æ¬¡       ç¬¬3æ¬¡       æœ€ç»ˆ
>  0   â†’  0+100  â†’  100+250  â†’  350+180  â†’  530+320 = 850
>         =100      =350        =530
> ```
>
> `reduce(lambda a, b: a + b, [100, 250, 180, 320])` å°±æ˜¯ï¼š
> - ä»å·¦åˆ°å³ï¼Œä¸¤ä¸¤ç´¯ç§¯
> - `a` æ˜¯ä¹‹å‰ç´¯ç§¯çš„ç»“æœï¼ˆé›ªçƒå¤§å°ï¼‰
> - `b` æ˜¯å½“å‰è¦åŠ å…¥çš„å…ƒç´ ï¼ˆæ–°é›ªï¼‰
> - æœ€åé›ªçƒåŒ…å«äº†æ‰€æœ‰çš„é›ª

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šLambda è¡¨è¾¾å¼

### ä¸ºä»€ä¹ˆéœ€è¦ Lambdaï¼Ÿ

> **å°ç™½è§£è¯»**ï¼šæœ‰æ—¶å€™ä½ åªéœ€è¦ä¸€ä¸ª**ä¸€æ¬¡æ€§çš„å°å‡½æ•°**ï¼Œä¸“é—¨ä¸ºå®ƒå†™ `def` å¤ªéº»çƒ¦äº†ã€‚Lambda å°±æ˜¯"**ä¸´æ—¶å·¥**"å‡½æ•°ï¼

### Lambda åŸºç¡€

```python
# æ™®é€šå‡½æ•°
def add(x: int, y: int) -> int:
    return x + y

# ç­‰ä»·çš„ Lambda è¡¨è¾¾å¼
add_lambda = lambda x, y: x + y

print(add(3, 5))        # 8
print(add_lambda(3, 5)) # 8
```

> **é€šä¿—ç†è§£ - Lambda è¯­æ³•è§£æ**ï¼š
> ```python
> lambda x, y: x + y
> â”‚      â”‚  â”‚  â””â”€â”€ è¿”å›ä»€ä¹ˆï¼ˆè¡¨è¾¾å¼ï¼‰
> â”‚      â”‚  â””â”€â”€ å†’å·åˆ†éš”
> â”‚      â””â”€â”€ å‚æ•°åˆ—è¡¨
> â””â”€â”€ å…³é”®å­—"lambda"ï¼Œå‘Šè¯‰ Python è¿™æ˜¯ä¸ªåŒ¿åå‡½æ•°
> ```
>
> ç›¸å½“äºï¼š
> ```python
> def ???(x, y):    # æ²¡æœ‰åå­—
>     return x + y
> ```

### Lambda çš„é€‚ç”¨åœºæ™¯

```python
# 1. ä½œä¸º sort çš„ key å‚æ•°
agents = [
    {"name": "Agent A", "score": 85},
    {"name": "Agent B", "score": 92},
    {"name": "Agent C", "score": 78},
]

# æŒ‰åˆ†æ•°æ’åº
sorted_agents = sorted(agents, key=lambda x: x["score"], reverse=True)
print([a["name"] for a in sorted_agents])  # ['Agent B', 'Agent A', 'Agent C']

# 2. åœ¨ map/filter ä¸­ä½¿ç”¨
numbers = [1, 2, 3, 4, 5]
squares = list(map(lambda x: x ** 2, numbers))
evens = list(filter(lambda x: x % 2 == 0, numbers))

# 3. LangGraph æ¡ä»¶è·¯ç”±
# workflow.add_conditional_edges(
#     "agent",
#     lambda x: "continue" if x["iteration"] < 5 else "end"
# )
```

> **é€šä¿—ç†è§£ - æ’åºçš„ key å‚æ•°**ï¼š
>
> æƒ³è±¡ä½ è¦ç»™å­¦ç”ŸæŒ‰æˆç»©æ’åï¼š
> - å­¦ç”Ÿæ•°æ®ï¼š`[{"name": "å°æ˜", "score": 85}, ...]`
> - `sorted()` é—®ä½ ï¼š"æ€ä¹ˆæ¯”è¾ƒä¸¤ä¸ªå­¦ç”Ÿçš„å¤§å°ï¼Ÿ"
> - ä½ è¯´ï¼š"`lambda x: x["score"]`"ï¼ˆçœ‹åˆ†æ•°ï¼‰
> - äºæ˜¯ `sorted()` å°±æŒ‰åˆ†æ•°æ¥æ’åº
>
> **key å‚æ•°å°±åƒæ˜¯ç»™ sorted() ä¸€ä¸ª"æ¯”è¾ƒè¯´æ˜ä¹¦"**

> **âš ï¸ Lambda çš„é™åˆ¶**ï¼š
> - åªèƒ½åŒ…å«å•ä¸ªè¡¨è¾¾å¼
> - ä¸èƒ½åŒ…å«è¯­å¥ï¼ˆå¦‚ if/for/whileï¼‰
> - ä¸èƒ½æœ‰ç±»å‹æ³¨è§£
> - éš¾ä»¥è°ƒè¯•

**æœ€ä½³å®è·µ**ï¼š
- âœ… ç®€å•çš„å•è¡Œæ“ä½œä½¿ç”¨ Lambda
- âŒ å¤æ‚é€»è¾‘ä½¿ç”¨å‘½åå‡½æ•°

---

## ç¬¬å››éƒ¨åˆ†ï¼šé—­åŒ…ï¼ˆClosureï¼‰

### ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿ

é—­åŒ…æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒ"è®°ä½"äº†å®šä¹‰æ—¶çš„å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡ã€‚

> **å°ç™½è§£è¯»**ï¼šé—­åŒ…æ˜¯è¿™é—¨è¯¾**æœ€éš¾ç†è§£**çš„æ¦‚å¿µä¹‹ä¸€ï¼Œä½†ä¹Ÿæ˜¯æœ€å¼ºå¤§çš„ï¼
>
> **é€šä¿—æ¯”å–» - è®°å¿†èƒ¶å›Š**ï¼š
>
> æƒ³è±¡ä½ ç»™å„¿å­ä¸€ä¸ª"è®°å¿†èƒ¶å›Š"ï¼ˆé—­åŒ…ï¼‰ï¼š
> - èƒ¶å›Šé‡Œè£…ç€ä½ å®¶çš„åœ°å€ï¼ˆå¤–éƒ¨å˜é‡ï¼‰
> - å„¿å­å¸¦ç€èƒ¶å›Šå»äº†å¤–åœ°ï¼ˆå‡½æ•°è¢«è¿”å›ï¼‰
> - å¤šå¹´åå„¿å­æ‰“å¼€èƒ¶å›Šï¼Œè¿˜èƒ½æ‰¾åˆ°å›å®¶çš„è·¯ï¼ˆè®¿é—®å¤–éƒ¨å˜é‡ï¼‰
>
> **å³ä½¿å¤–éƒ¨å‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œé—­åŒ…ä»ç„¶"è®°å¾—"é‚£äº›å˜é‡ï¼**

```python
def create_counter(start: int = 0):
    """
    åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨é—­åŒ…

    Args:
        start: èµ·å§‹å€¼

    Returns:
        è®¡æ•°å™¨å‡½æ•°
    """
    count = start  # å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡

    def counter() -> int:
        nonlocal count  # å£°æ˜ä½¿ç”¨å¤–éƒ¨å˜é‡
        count += 1
        return count

    return counter

# åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨
counter1 = create_counter(0)
counter2 = create_counter(100)

print(counter1())  # 1
print(counter1())  # 2
print(counter2())  # 101
print(counter1())  # 3
```

> **å›¾è§£é—­åŒ…åŸç†**ï¼š
> ```
> create_counter(0) è¢«è°ƒç”¨
> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
> â”‚  count = 0  â† å¤–éƒ¨å˜é‡       â”‚
> â”‚                             â”‚
> â”‚  def counter():             â”‚
> â”‚      nonlocal count         â”‚
> â”‚      count += 1   â† ä½¿ç”¨å¤–éƒ¨å˜é‡
> â”‚      return count           â”‚
> â”‚                             â”‚
> â”‚  return counter â† è¿”å›å†…éƒ¨å‡½æ•° â”‚
> â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
>         â”‚
>         â–¼
> counter1 = <counterå‡½æ•° + å®ƒè®°ä½çš„count=0>
>
> å½“è°ƒç”¨ counter1() æ—¶ï¼š
> - å®ƒæ‰¾åˆ°è‡ªå·±"è®°ä½"çš„ countï¼ˆç°åœ¨æ˜¯0ï¼‰
> - æŠŠ count åŠ  1ï¼ˆå˜æˆ1ï¼‰
> - è¿”å› 1
>
> å†æ¬¡è°ƒç”¨ counter1()ï¼š
> - å®ƒæ‰¾åˆ°è‡ªå·±"è®°ä½"çš„ countï¼ˆç°åœ¨æ˜¯1ï¼‰
> - æŠŠ count åŠ  1ï¼ˆå˜æˆ2ï¼‰
> - è¿”å› 2
> ```
>
> **å…³é”®ç‚¹**ï¼š
> - `counter1` å’Œ `counter2` å„è‡ª"è®°ä½"äº†è‡ªå·±çš„ `count`
> - å®ƒä»¬äº’ä¸å½±å“ï¼Œå°±åƒä¸¤ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨

### `nonlocal` å…³é”®å­—æ˜¯ä»€ä¹ˆï¼Ÿ

```python
def outer():
    x = 10

    def inner():
        nonlocal x  # å‘Šè¯‰ Pythonï¼šæˆ‘è¦ç”¨å¤–é¢çš„ xï¼Œä¸æ˜¯åˆ›å»ºæ–°çš„
        x = 20      # ä¿®æ”¹å¤–éƒ¨çš„ x

    inner()
    print(x)  # 20

outer()
```

> **é€šä¿—ç†è§£**ï¼š
> - å¦‚æœä¸å†™ `nonlocal x`ï¼Œ`x = 20` ä¼šåˆ›å»ºä¸€ä¸ª**æ–°çš„å±€éƒ¨å˜é‡** x
> - å†™äº† `nonlocal x`ï¼Œå°±æ˜¯å‘Šè¯‰ Pythonï¼š"æˆ‘è¯´çš„æ˜¯**å¤–é¢é‚£ä¸ª** x"

### AI Agent ä¸­çš„é—­åŒ…åº”ç”¨

```python
def create_rate_limiter(max_calls: int, window_seconds: int):
    """
    åˆ›å»ºä¸€ä¸ªé€Ÿç‡é™åˆ¶å™¨ï¼ˆé—­åŒ…å®ç°ï¼‰

    Args:
        max_calls: æ—¶é—´çª—å£å†…æœ€å¤§è°ƒç”¨æ¬¡æ•°
        window_seconds: æ—¶é—´çª—å£ï¼ˆç§’ï¼‰

    Returns:
        æ£€æŸ¥å‡½æ•°
    """
    import time
    from collections import deque

    call_times = deque(maxlen=max_calls)

    def can_call() -> bool:
        """æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘èµ·è°ƒç”¨"""
        now = time.time()

        # ç§»é™¤çª—å£å¤–çš„è°ƒç”¨è®°å½•
        while call_times and call_times[0] < now - window_seconds:
            call_times.popleft()

        if len(call_times) < max_calls:
            call_times.append(now)
            return True

        return False

    return can_call

# ä½¿ç”¨é€Ÿç‡é™åˆ¶å™¨
rate_limiter = create_rate_limiter(max_calls=3, window_seconds=10)

for i in range(5):
    if rate_limiter():
        print(f"è°ƒç”¨ #{i+1} å…è®¸")
    else:
        print(f"è°ƒç”¨ #{i+1} è¢«é™åˆ¶")
```

> **ä¸ºä»€ä¹ˆç”¨é—­åŒ…å®ç°é€Ÿç‡é™åˆ¶å™¨ï¼Ÿ**
>
> å› ä¸º `call_times`ï¼ˆè°ƒç”¨è®°å½•ï¼‰éœ€è¦åœ¨å¤šæ¬¡è°ƒç”¨ä¹‹é—´**æŒç»­å­˜åœ¨**ï¼š
> - å¦‚æœç”¨æ™®é€šå‡½æ•°ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šé‡æ–°åˆ›å»º `call_times`
> - ç”¨é—­åŒ…ï¼Œ`call_times` è¢«"è®°ä½"äº†ï¼Œå¯ä»¥ç´¯ç§¯è°ƒç”¨è®°å½•

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®æˆ˜ - å¯é…ç½®çš„ Agent å·¥å‚

```python
"""
Agent å·¥å‚ï¼šä½¿ç”¨é«˜é˜¶å‡½æ•°å’Œé—­åŒ…æ„å»ºå¯é…ç½®çš„ Agent
"""

from typing import Callable, Optional


def create_agent_factory(
    default_model: str = "gpt-3.5-turbo",
    default_temperature: float = 0.7
) -> Callable:
    """
    åˆ›å»º Agent å·¥å‚å‡½æ•°

    è¿™æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªé…ç½®å¥½çš„ Agent åˆ›å»ºå™¨

    Args:
        default_model: é»˜è®¤æ¨¡å‹
        default_temperature: é»˜è®¤æ¸©åº¦

    Returns:
        Agent åˆ›å»ºå‡½æ•°
    """
    def create_agent(
        name: str,
        system_prompt: str,
        tools: Optional[list] = None,
        model: Optional[str] = None,
        temperature: Optional[float] = None
    ) -> dict:
        """
        åˆ›å»º Agent å®ä¾‹

        Args:
            name: Agent åç§°
            system_prompt: ç³»ç»Ÿæç¤ºè¯
            tools: å¯ç”¨å·¥å…·åˆ—è¡¨
            model: æ¨¡å‹ï¼ˆå¯é€‰ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰
            temperature: æ¸©åº¦ï¼ˆå¯é€‰ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰

        Returns:
            Agent é…ç½®å­—å…¸
        """
        return {
            "name": name,
            "model": model or default_model,
            "temperature": temperature or default_temperature,
            "system_prompt": system_prompt,
            "tools": tools or [],
            "created_with_defaults": {
                "model": default_model,
                "temperature": default_temperature
            }
        }

    return create_agent


def create_tool_registry():
    """
    åˆ›å»ºå·¥å…·æ³¨å†Œè¡¨ï¼ˆä½¿ç”¨é—­åŒ…ï¼‰

    Returns:
        åŒ…å«æ³¨å†Œå’Œè·å–å‡½æ•°çš„å­—å…¸
    """
    tools: dict[str, Callable] = {}

    def register(name: str, func: Callable) -> None:
        """æ³¨å†Œå·¥å…·"""
        tools[name] = func
        print(f"å·¥å…· '{name}' å·²æ³¨å†Œ")

    def get(name: str) -> Optional[Callable]:
        """è·å–å·¥å…·"""
        return tools.get(name)

    def list_tools() -> list[str]:
        """åˆ—å‡ºæ‰€æœ‰å·¥å…·"""
        return list(tools.keys())

    return {
        "register": register,
        "get": get,
        "list": list_tools
    }


def compose(*functions: Callable) -> Callable:
    """
    å‡½æ•°ç»„åˆï¼šå°†å¤šä¸ªå‡½æ•°ç»„åˆæˆä¸€ä¸ª

    Args:
        *functions: è¦ç»„åˆçš„å‡½æ•°åˆ—è¡¨

    Returns:
        ç»„åˆåçš„å‡½æ•°

    Example:
        >>> def add_one(x): return x + 1
        >>> def double(x): return x * 2
        >>> f = compose(add_one, double)
        >>> f(3)  # double(add_one(3)) = double(4) = 8
        8
    """
    from functools import reduce

    def compose_two(f: Callable, g: Callable) -> Callable:
        return lambda x: g(f(x))

    return reduce(compose_two, functions, lambda x: x)


# æ¼”ç¤ºä½¿ç”¨
def main() -> None:
    """ä¸»å‡½æ•°ï¼šæ¼”ç¤ºé«˜é˜¶å‡½æ•°å’Œé—­åŒ…"""

    # 1. Agent å·¥å‚
    print("=== Agent å·¥å‚ ===")
    factory = create_agent_factory(
        default_model="gpt-4",
        default_temperature=0.5
    )

    agent1 = factory(
        name="ResearchBot",
        system_prompt="You are a research assistant"
    )

    agent2 = factory(
        name="ChatBot",
        system_prompt="You are a friendly chatbot",
        model="gpt-3.5-turbo",
        temperature=0.9
    )

    print(f"Agent1: {agent1['name']}, æ¨¡å‹: {agent1['model']}")
    print(f"Agent2: {agent2['name']}, æ¨¡å‹: {agent2['model']}")

    # 2. å·¥å…·æ³¨å†Œè¡¨
    print("\n=== å·¥å…·æ³¨å†Œè¡¨ ===")
    registry = create_tool_registry()

    def weather_tool(location: str) -> str:
        return f"Weather in {location}: Sunny"

    def calculator_tool(expression: str) -> str:
        return f"Calculating: {expression}"

    registry["register"]("weather", weather_tool)
    registry["register"]("calculator", calculator_tool)

    print(f"å·²æ³¨å†Œå·¥å…·: {registry['list']()}")

    tool = registry["get"]("weather")
    if tool:
        print(tool("Beijing"))

    # 3. å‡½æ•°ç»„åˆ
    print("\n=== å‡½æ•°ç»„åˆ ===")

    def clean_text(text: str) -> str:
        return text.strip().lower()

    def remove_punctuation(text: str) -> str:
        import string
        return text.translate(str.maketrans("", "", string.punctuation))

    def tokenize(text: str) -> list[str]:
        return text.split()

    # ç»„åˆå¤„ç†æµç¨‹
    process_text = compose(clean_text, remove_punctuation)

    input_text = "  Hello, World!  "
    processed = process_text(input_text)
    print(f"åŸå§‹: '{input_text}'")
    print(f"å¤„ç†å: '{processed}'")


if __name__ == "__main__":
    main()
```

---

## æœ¬èŠ‚æ€»ç»“

### æ ¸å¿ƒæ¦‚å¿µä¸€è§ˆè¡¨

| æ¦‚å¿µ | ä¸€å¥è¯è§£é‡Š | ç”Ÿæ´»æ¯”å–» |
|------|----------|---------|
| **ä¸€ç­‰å…¬æ°‘** | å‡½æ•°å¯ä»¥åƒå˜é‡ä¸€æ ·ä¼ é€’ | é£Ÿè°±å¡ç‰‡å¯ä»¥é€äººã€æ”¶è—ã€å¤åˆ¶ |
| **é«˜é˜¶å‡½æ•°** | æ¥å—æˆ–è¿”å›å‡½æ•°çš„å‡½æ•° | åŒ…å·¥å¤´æŒ‡æŒ¥å·¥äººå¹²æ´» |
| **map()** | å¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡Œç›¸åŒæ“ä½œ | æµæ°´çº¿æ‰¹é‡åŠ å·¥ |
| **filter()** | ä¿ç•™ç¬¦åˆæ¡ä»¶çš„å…ƒç´  | å®‰æ£€é—¨ç­›é€‰ä¹˜å®¢ |
| **reduce()** | ç´¯ç§¯æ‰€æœ‰å…ƒç´ æˆä¸€ä¸ªç»“æœ | æ»šé›ªçƒè¶Šæ»šè¶Šå¤§ |
| **Lambda** | ä¸€æ¬¡æ€§çš„åŒ¿åå°å‡½æ•° | ä¸´æ—¶å·¥ |
| **é—­åŒ…** | è®°ä½å¤–éƒ¨å˜é‡çš„å‡½æ•° | å¸¦ç€å®¶ä¹¡åœ°å€çš„æ¸¸å­ |

### ä¸ AI Agent çš„è”ç³»

| æ¦‚å¿µ | åœ¨ Agent ä¸­çš„åº”ç”¨ |
|------|------------------|
| **é«˜é˜¶å‡½æ•°** | Agent å·¥å‚ã€é…ç½®ç”Ÿæˆå™¨ |
| **Lambda** | LangGraph æ¡ä»¶è·¯ç”± |
| **é—­åŒ…** | é€Ÿç‡é™åˆ¶å™¨ã€çŠ¶æ€ç®¡ç† |
| **map** | æ‰¹é‡å¤„ç†æç¤ºè¯ã€ç»“æœ |
| **filter** | ç­›é€‰é«˜è´¨é‡å“åº” |
| **compose** | æ„å»ºå¤„ç†ç®¡é“ |

### æ–°æ‰‹å¸¸è§é—®é¢˜

**Q1ï¼š`greet` å’Œ `greet()` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
- `greet` = å‡½æ•°å¯¹è±¡æœ¬èº«ï¼ˆå¯ä»¥ä¼ é€’ï¼‰
- `greet()` = è°ƒç”¨å‡½æ•°ï¼Œæ‰§è¡Œå®ƒçš„ä»£ç 

**Q2ï¼šLambda å’Œæ™®é€šå‡½æ•°æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
- Lambda æ˜¯åŒ¿åçš„ï¼Œä¸€æ¬¡æ€§ä½¿ç”¨
- æ™®é€šå‡½æ•°æœ‰åå­—ï¼Œå¯ä»¥å¤ç”¨
- Lambda åªèƒ½å†™ä¸€è¡Œè¡¨è¾¾å¼

**Q3ï¼šé—­åŒ…æœ‰ä»€ä¹ˆå®é™…ç”¨é€”ï¼Ÿ**
- åˆ›å»ºå¸¦"è®°å¿†"çš„å‡½æ•°ï¼ˆå¦‚è®¡æ•°å™¨ï¼‰
- å®ç°æ•°æ®éšè—ï¼ˆå¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—®å†…éƒ¨å˜é‡ï¼‰
- å·¥å‚æ¨¡å¼ï¼ˆæ‰¹é‡åˆ›å»ºé…ç½®å¥½çš„å‡½æ•°ï¼‰

---

**ä¸‹ä¸€èŠ‚ï¼š[1.3 è£…é¥°å™¨ï¼šLangChain çš„æ ¸å¿ƒæ¨¡å¼](1.3-è£…é¥°å™¨ï¼šLangChainçš„æ ¸å¿ƒæ¨¡å¼.md)**
