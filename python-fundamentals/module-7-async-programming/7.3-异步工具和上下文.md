# 6.2 å¼‚æ­¥å·¥å…·å’Œä¸Šä¸‹æ–‡

## å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šä»€ä¹ˆæ˜¯"ä¸Šä¸‹æ–‡ç®¡ç†å™¨"ï¼Ÿ**
>
> è¿˜è®°å¾— `with open("file.txt") as f:` å—ï¼Ÿè¿™å°±æ˜¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚
>
> å®ƒå¸®ä½ è‡ªåŠ¨å¤„ç†**èµ„æºçš„æ‰“å¼€å’Œå…³é—­**ï¼š
> - è¿›å…¥ `with` å—æ—¶ï¼Œè‡ªåŠ¨æ‰“å¼€èµ„æº
> - ç¦»å¼€ `with` å—æ—¶ï¼Œè‡ªåŠ¨å…³é—­èµ„æºï¼ˆå³ä½¿å‡ºé”™ä¹Ÿä¼šå…³é—­ï¼‰
>
> **å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨**æ˜¯å®ƒçš„å¼‚æ­¥ç‰ˆæœ¬ï¼š
> - ç”¨ `async with` ä»£æ›¿ `with`
> - ç”¨ `__aenter__` ä»£æ›¿ `__enter__`
> - ç”¨ `__aexit__` ä»£æ›¿ `__exit__`
>
> é€‚ç”¨äºæ•°æ®åº“è¿æ¥ã€HTTP ä¼šè¯ç­‰éœ€è¦å¼‚æ­¥æ‰“å¼€/å…³é—­çš„èµ„æºã€‚

```python
import asyncio

class AsyncDatabaseConnection:
    """å¼‚æ­¥æ•°æ®åº“è¿æ¥"""

    async def __aenter__(self):
        """è¿›å…¥ä¸Šä¸‹æ–‡â€”â€”è¿æ¥æ•°æ®åº“"""
        print("è¿æ¥æ•°æ®åº“...")
        await asyncio.sleep(0.1)  # æ¨¡æ‹Ÿå¼‚æ­¥è¿æ¥
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """é€€å‡ºä¸Šä¸‹æ–‡â€”â€”å…³é—­æ•°æ®åº“ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼Œå³ä½¿å‡ºé”™ï¼‰"""
        print("å…³é—­æ•°æ®åº“...")
        await asyncio.sleep(0.1)

    async def query(self, sql: str) -> list:
        """æ‰§è¡ŒæŸ¥è¯¢"""
        await asyncio.sleep(0.1)
        return [{"result": "data"}]

async def main():
    # ğŸ¯ async with ä¼šè‡ªåŠ¨è°ƒç”¨ __aenter__ å’Œ __aexit__
    async with AsyncDatabaseConnection() as db:
        results = await db.query("SELECT * FROM agents")
        print(results)
    # ç¦»å¼€ with å—åï¼Œæ•°æ®åº“è¿æ¥è‡ªåŠ¨å…³é—­

asyncio.run(main())
```

## å¼‚æ­¥ LangChain Tool

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šä¸ºä»€ä¹ˆ Tool éœ€è¦å¼‚æ­¥ç‰ˆæœ¬ï¼Ÿ**
>
> LangChain çš„ Toolï¼ˆå·¥å…·ï¼‰ç»å¸¸éœ€è¦è°ƒç”¨å¤–éƒ¨ APIï¼š
> - æœç´¢å·¥å…·è°ƒç”¨ Google API
> - å¤©æ°”å·¥å…·è°ƒç”¨å¤©æ°” API
> - æ•°æ®åº“å·¥å…·æŸ¥è¯¢æ•°æ®åº“
>
> è¿™äº›æ“ä½œéƒ½éœ€è¦**ç­‰å¾…ç½‘ç»œå“åº”**ã€‚å¦‚æœç”¨åŒæ­¥æ–¹å¼ï¼ŒAgent è°ƒç”¨ 5 ä¸ªå·¥å…·å°±è¦ç­‰ 5 æ¬¡ã€‚
>
> ç”¨å¼‚æ­¥å·¥å…·çš„ `arun()` æ–¹æ³•ï¼Œå¯ä»¥**åŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·**ï¼Œå¤§å¤§åŠ é€Ÿï¼
>
> LangChain çš„å‘½åè§„åˆ™ï¼š
> - `run()` = åŒæ­¥æ–¹æ³•
> - `arun()` = å¼‚æ­¥æ–¹æ³•ï¼ˆå‰é¢åŠ ä¸ª aï¼Œä»£è¡¨ asyncï¼‰

```python
from typing import Optional
import asyncio

class AsyncTool:
    """å¼‚æ­¥å·¥å…·åŸºç±»"""

    async def arun(self, query: str) -> str:
        """å¼‚æ­¥è¿è¡Œï¼ˆå­ç±»å¿…é¡»å®ç°ï¼‰"""
        raise NotImplementedError

class AsyncSearchTool(AsyncTool):
    """å¼‚æ­¥æœç´¢å·¥å…·"""

    async def arun(self, query: str) -> str:
        await asyncio.sleep(0.5)  # æ¨¡æ‹Ÿ API è°ƒç”¨ï¼ˆå®é™…ä¼šæ˜¯ç½‘ç»œè¯·æ±‚ï¼‰
        return f"æœç´¢ç»“æœ: {query}"

async def main():
    tool = AsyncSearchTool()
    result = await tool.arun("Python")
    print(result)

    # ğŸ¯ å¼‚æ­¥å·¥å…·çš„å¨åŠ›ï¼šåŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·
    tools = [AsyncSearchTool(), AsyncSearchTool(), AsyncSearchTool()]
    queries = ["Python", "LangChain", "å¼‚æ­¥ç¼–ç¨‹"]

    # åŒæ—¶å‘èµ· 3 ä¸ªæœç´¢ï¼Œåªéœ€è¦ 0.5 ç§’è€Œä¸æ˜¯ 1.5 ç§’
    results = await asyncio.gather(*[
        tool.arun(query) for tool, query in zip(tools, queries)
    ])
    print(results)

asyncio.run(main())
```

---

**ä¸‹ä¸€èŠ‚ï¼š[6.3 å®æˆ˜ï¼šå¼‚æ­¥ Agent](6.3-å®æˆ˜ï¼šå¼‚æ­¥Agent.md)**
