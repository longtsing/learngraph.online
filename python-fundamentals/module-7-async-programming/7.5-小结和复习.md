# 6.4 å°ç»“å’Œå¤ä¹ 

## æœ¬ç« æ ¸å¿ƒæ¦‚å¿µ

> **ğŸ¯ å°ç™½æ€»ç»“ï¼šå¼‚æ­¥ç¼–ç¨‹æ ¸å¿ƒè®°å¿†å¡**
>
> | æ¦‚å¿µ | ç”¨é€” | ç”Ÿæ´»æ¯”å–» |
> |-----|------|---------|
> | `async def` | å®šä¹‰å¼‚æ­¥å‡½æ•° | åˆ›å»ºä¸€ä¸ª"å¯æš‚åœ"çš„ä»»åŠ¡ |
> | `await` | ç­‰å¾…æ“ä½œå®Œæˆ | ç­‰å¤–å–æ—¶å¯ä»¥åˆ·æ‰‹æœº |
> | `gather()` | åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ | åŒæ—¶ç‚¹å’–å•¡å’Œè›‹ç³• |
> | `Semaphore` | é™åˆ¶å¹¶å‘æ•° | é¤å…åªæœ‰5ä¸ªå¨å¸ˆ |
> | `Queue` | ä»»åŠ¡æ’é˜Ÿ | å–å·æœº |
> | æµå¼å“åº” | è¾¹ç”Ÿæˆè¾¹è¿”å› | æ‰“å­—æœºæ•ˆæœ |

### 1. å¼‚æ­¥ç¼–ç¨‹åŸºç¡€
- **async/await è¯­æ³•**ï¼šå®šä¹‰å’Œè°ƒç”¨å¼‚æ­¥å‡½æ•°
- **asyncio.gather()**ï¼šå¹¶å‘æ‰§è¡Œå¤šä¸ªåç¨‹
- **asyncio.create_task()**ï¼šåˆ›å»ºåå°ä»»åŠ¡
- **å¹¶å‘ vs å¹¶è¡Œ**ï¼šç†è§£ I/O å¯†é›†å‹ä»»åŠ¡çš„ä¼˜åŒ–

> **ğŸ¯ å°ç™½æ³¨æ„ï¼šå¹¶å‘ â‰  å¹¶è¡Œ**
>
> - **å¹¶å‘ï¼ˆConcurrentï¼‰**ï¼šäº¤æ›¿æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼ˆå•æ ¸ä¹Ÿèƒ½åšåˆ°ï¼‰
> - **å¹¶è¡Œï¼ˆParallelï¼‰**ï¼šçœŸæ­£åŒæ—¶æ‰§è¡Œï¼ˆéœ€è¦å¤šæ ¸ï¼‰
>
> å¼‚æ­¥æ˜¯**å¹¶å‘**ï¼Œé€‚åˆ I/O å¯†é›†å‹ä»»åŠ¡ï¼ˆç­‰ç½‘ç»œã€ç­‰æ–‡ä»¶ï¼‰ã€‚
> å¤šè¿›ç¨‹æ˜¯**å¹¶è¡Œ**ï¼Œé€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡ï¼ˆå¤æ‚è®¡ç®—ï¼‰ã€‚

### 2. å¼‚æ­¥å·¥å…·
- **å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨**ï¼š`__aenter__` å’Œ `__aexit__`
- **å¼‚æ­¥è¿­ä»£å™¨**ï¼š`__aiter__` å’Œ `__anext__`
- **å¼‚æ­¥å·¥å…·ç±»**ï¼šå®ç° `arun()` æ–¹æ³•
- **å¼‚æ­¥è£…é¥°å™¨**ï¼šåŒ…è£…å¼‚æ­¥å‡½æ•°

### 3. å®æˆ˜æŠ€å·§
- **æµå¼å“åº”**ï¼šå®æ—¶ç”Ÿæˆå’Œå±•ç¤ºç»“æœ
- **æ‰¹å¤„ç†ç³»ç»Ÿ**ï¼šé˜Ÿåˆ— + å·¥ä½œåç¨‹ + Semaphore
- **é‡è¯•æœºåˆ¶**ï¼šæŒ‡æ•°é€€é¿ç­–ç•¥
- **æ€§èƒ½ç›‘æ§**ï¼šè·Ÿè¸ªè€—æ—¶å’Œé”™è¯¯ç‡

## çŸ¥è¯†è‡ªæµ‹

> **ğŸ¯ å°ç™½æç¤ºï¼šåšé¢˜å‰çš„æ ¸å¿ƒæ¦‚å¿µå›é¡¾**
>
> 1. **å¼‚æ­¥ = ä¸å‚»ç­‰**ï¼šé‡åˆ°ç­‰å¾…å°±å»åšåˆ«çš„äº‹
> 2. **I/O å¯†é›†å‹ç”¨å¼‚æ­¥**ï¼šç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ã€æ•°æ®åº“æŸ¥è¯¢
> 3. **CPU å¯†é›†å‹ç”¨å¤šè¿›ç¨‹**ï¼šå¤æ‚è®¡ç®—ã€å›¾åƒå¤„ç†
> 4. **å…³é”®è¯­æ³•**ï¼š`async def` å®šä¹‰ã€`await` ç­‰å¾…ã€`gather()` å¹¶å‘

### é€‰æ‹©é¢˜

1. ä¸‹é¢å“ªä¸ªä¸æ˜¯ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹çš„ä¸»è¦åŸå› ï¼Ÿ
   - A. æé«˜ I/O å¯†é›†å‹ä»»åŠ¡çš„æ•ˆç‡
   - B. å®ç° CPU å¯†é›†å‹ä»»åŠ¡çš„å¹¶è¡Œè®¡ç®—
   - C. å‡å°‘ç­‰å¾…æ—¶é—´
   - D. æé«˜ç³»ç»Ÿååé‡

2. `asyncio.gather()` å’Œ `asyncio.wait()` çš„ä¸»è¦åŒºåˆ«æ˜¯ï¼Ÿ
   - A. gather è¿”å›ç»“æœåˆ—è¡¨ï¼Œwait è¿”å›å®Œæˆå’Œå¾…å®Œæˆçš„é›†åˆ
   - B. gather æ›´å¿«
   - C. wait æ›´å®‰å…¨
   - D. æ²¡æœ‰åŒºåˆ«

3. å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨éœ€è¦å®ç°å“ªäº›æ–¹æ³•ï¼Ÿ
   - A. `__enter__` å’Œ `__exit__`
   - B. `__aenter__` å’Œ `__aexit__`
   - C. `__init__` å’Œ `__del__`
   - D. `__call__` å’Œ `__await__`

<details>
<summary>æŸ¥çœ‹ç­”æ¡ˆ</summary>

1. **B** - å¼‚æ­¥ç¼–ç¨‹ä¸»è¦ç”¨äº I/O å¯†é›†å‹ä»»åŠ¡ï¼ŒCPU å¯†é›†å‹ä»»åŠ¡éœ€è¦å¤šè¿›ç¨‹
2. **A** - gather è¿”å›ç»“æœåˆ—è¡¨ï¼Œwait è¿”å› (done, pending) é›†åˆ
3. **B** - å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä½¿ç”¨ `__aenter__` å’Œ `__aexit__`

</details>

---

## é«˜éš¾åº¦ç¼–ç¨‹æŒ‘æˆ˜

> **ğŸ¯ å°ç™½é¡»çŸ¥ï¼šè¿™äº›æŒ‘æˆ˜æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ**
>
> è¿™ä¸¤ä¸ªæŒ‘æˆ˜æ˜¯**è¿›é˜¶ç»ƒä¹ **ï¼Œç”¨æ¥æ£€éªŒä½ å¯¹å¼‚æ­¥ç¼–ç¨‹çš„æ·±å…¥ç†è§£ã€‚
>
> - **æŒ‘æˆ˜ 1ï¼ˆè°ƒåº¦å™¨ï¼‰**ï¼šåƒåŒ»é™¢çš„å«å·ç³»ç»Ÿâ€”â€”ç®¡ç†ä»»åŠ¡çš„ä¼˜å…ˆçº§ã€ç­‰å¾…ã€æ‰§è¡Œ
> - **æŒ‘æˆ˜ 2ï¼ˆåˆ†å¸ƒå¼ï¼‰**ï¼šåƒå¤–å–å¹³å°â€”â€”å¤šä¸ªéª‘æ‰‹ï¼ˆAgentï¼‰åä½œå®Œæˆå¤šä¸ªè®¢å•
>
> å¦‚æœæ„Ÿè§‰å¤ªéš¾ï¼Œå¯ä»¥å…ˆè·³è¿‡ï¼Œå­¦å®Œåé¢çš„ç« èŠ‚å†å›æ¥æŒ‘æˆ˜ï¼

### æŒ‘æˆ˜ 1ï¼šæ™ºèƒ½ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆéš¾åº¦ï¼šâ­â­â­â­ï¼‰

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šä»€ä¹ˆæ˜¯"ä»»åŠ¡è°ƒåº¦å™¨"ï¼Ÿ**
>
> æƒ³è±¡ä½ æ˜¯åŒ»é™¢çš„**å¯¼è¯Šå°**ï¼Œéœ€è¦å®‰æ’ç—…äººçœ‹ç—…ï¼š
>
> | è°ƒåº¦å™¨åŠŸèƒ½ | åŒ»é™¢æ¯”å–» |
> |-----------|---------|
> | ä¼˜å…ˆçº§é˜Ÿåˆ— | æ€¥è¯Šä¼˜å…ˆã€è€äººä¼˜å…ˆ |
> | ä»»åŠ¡ä¾èµ– | å…ˆæŠ½è¡€ï¼Œå†çœ‹åŒ–éªŒç»“æœ |
> | å¹¶å‘é™åˆ¶ | åªæœ‰ 5 ä¸ªè¯Šå®¤ |
> | è¶…æ—¶æ§åˆ¶ | ç­‰å¤ªä¹…å°±é‡æ–°æ’é˜Ÿ |
> | é‡è¯•æœºåˆ¶ | æ£€æŸ¥å¤±è´¥ï¼Œé‡åšä¸€æ¬¡ |
>
> è¿™ä¸ªè°ƒåº¦å™¨å°±æ˜¯ç”¨ä»£ç å®ç°è¿™å¥—"åŒ»é™¢ç®¡ç†ç³»ç»Ÿ"ï¼

**éœ€æ±‚**ï¼š
å®ç°ä¸€ä¸ªæ™ºèƒ½çš„å¼‚æ­¥ä»»åŠ¡è°ƒåº¦å™¨ï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š
1. ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆé«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œï¼‰
2. ä»»åŠ¡ä¾èµ–ï¼ˆä»»åŠ¡ B ä¾èµ–ä»»åŠ¡ A çš„ç»“æœï¼‰
3. å¹¶å‘é™åˆ¶ï¼ˆæœ€å¤šåŒæ—¶æ‰§è¡Œ N ä¸ªä»»åŠ¡ï¼‰
4. è¶…æ—¶æ§åˆ¶ï¼ˆä»»åŠ¡è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼‰
5. é‡è¯•æœºåˆ¶ï¼ˆå¤±è´¥ä»»åŠ¡è‡ªåŠ¨é‡è¯•ï¼‰
6. å®æ—¶ç›‘æ§ï¼ˆæ˜¾ç¤ºä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦ï¼‰

**ä»£ç æ¡†æ¶**ï¼š

> **ğŸ¯ ä»£ç è§£è¯»ï¼šå…³é”®æ¦‚å¿µé€ŸæŸ¥**
>
> | ä»£ç  | ä½œç”¨ | ç”Ÿæ´»æ¯”å–» |
> |-----|------|---------|
> | `heapq` | ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆè‡ªåŠ¨æ’åºï¼‰ | VIP é€šé“ |
> | `TaskStatus` | ä»»åŠ¡çŠ¶æ€æšä¸¾ | è®¢å•çŠ¶æ€ï¼šå¾…å¤„ç†/è¿›è¡Œä¸­/å·²å®Œæˆ |
> | `@dataclass` | è‡ªåŠ¨ç”Ÿæˆ `__init__` ç­‰æ–¹æ³• | ç®€åŒ–ä»£ç çš„è¯­æ³•ç³– |
> | `Semaphore` | é™åˆ¶å¹¶å‘æ•° | åªæœ‰ N ä¸ªçª—å£ |
> | `dependencies` | ä»»åŠ¡ä¾èµ–å…³ç³» | å…ˆåš A æ‰èƒ½åš B |

```python
import asyncio
from typing import List, Dict, Any, Optional, Callable, Set
from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
import heapq  # ğŸ¯ å †é˜Ÿåˆ—ï¼Œè‡ªåŠ¨æŒ‰ä¼˜å…ˆçº§æ’åº

class TaskStatus(Enum):
    """ä»»åŠ¡çŠ¶æ€â€”â€”åƒè®¢å•çš„çŠ¶æ€æµè½¬"""
    PENDING = "pending"      # å¾…å¤„ç†
    WAITING = "waiting"      # ç­‰å¾…ä¾èµ–ï¼ˆæ¯”å¦‚ç­‰åŒ–éªŒç»“æœï¼‰
    RUNNING = "running"      # æ‰§è¡Œä¸­
    COMPLETED = "completed"  # å·²å®Œæˆ
    FAILED = "failed"        # å¤±è´¥
    TIMEOUT = "timeout"      # è¶…æ—¶
    CANCELLED = "cancelled"  # å·²å–æ¶ˆ

@dataclass  # ğŸ¯ è‡ªåŠ¨ç”Ÿæˆ __init__ã€__repr__ ç­‰æ–¹æ³•
class Task:
    """ä»»åŠ¡æ•°æ®ç±»"""
    id: str
    func: Callable
    args: tuple = field(default_factory=tuple)
    kwargs: dict = field(default_factory=dict)
    priority: int = 1  # æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
    dependencies: Set[str] = field(default_factory=set)
    timeout: float = 30.0
    max_retries: int = 3
    retry_delay: float = 1.0
    
    # è¿è¡Œæ—¶çŠ¶æ€
    status: TaskStatus = TaskStatus.PENDING
    result: Any = None
    error: Optional[Exception] = None
    retries: int = 0
    created_at: datetime = field(default_factory=datetime.now)
    started_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None
    
    def __lt__(self, other):
        """æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—"""
        return self.priority < other.priority

class SmartScheduler:
    """æ™ºèƒ½ä»»åŠ¡è°ƒåº¦å™¨"""
    
    def __init__(self, max_workers: int = 5):
        self.max_workers = max_workers
        # TODO: å®ç°ä»¥ä¸‹åŠŸèƒ½
        # 1. ä½¿ç”¨ heapq å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—
        # 2. å®ç°ä¾èµ–å…³ç³»ç®¡ç†
        # 3. ä½¿ç”¨ Semaphore æ§åˆ¶å¹¶å‘
        # 4. å®ç°è¶…æ—¶å’Œé‡è¯•
        # 5. å®ç°å®æ—¶ç›‘æ§
        pass
    
    async def add_task(self, task: Task) -> str:
        """æ·»åŠ ä»»åŠ¡"""
        # TODO: å®ç°ä»»åŠ¡æ·»åŠ é€»è¾‘
        pass
    
    async def process_task(self, task: Task) -> Task:
        """å¤„ç†å•ä¸ªä»»åŠ¡"""
        # TODO: å®ç°ä»»åŠ¡å¤„ç†é€»è¾‘
        # - æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæˆ
        # - æ‰§è¡Œä»»åŠ¡ï¼ˆå¸¦è¶…æ—¶ï¼‰
        # - å¤„ç†é‡è¯•
        pass
    
    async def run(self) -> Dict[str, Task]:
        """è¿è¡Œè°ƒåº¦å™¨"""
        # TODO: å®ç°ä¸»è°ƒåº¦å¾ªç¯
        pass
    
    def get_stats(self) -> Dict[str, Any]:
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        # TODO: è¿”å›ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡
        pass

# æµ‹è¯•ä»£ç 
async def test_scheduler():
    scheduler = SmartScheduler(max_workers=3)
    
    # å®šä¹‰æµ‹è¯•ä»»åŠ¡
    async def task_a():
        await asyncio.sleep(1)
        return "Aå®Œæˆ"
    
    async def task_b(a_result: str):
        await asyncio.sleep(1)
        return f"Bå®Œæˆï¼ˆä¾èµ–: {a_result}ï¼‰"
    
    async def task_c():
        await asyncio.sleep(0.5)
        return "Cå®Œæˆ"
    
    async def task_fail():
        raise Exception("æ¨¡æ‹Ÿå¤±è´¥")
    
    # æ·»åŠ ä»»åŠ¡
    task_a_id = await scheduler.add_task(Task(
        id="task-a",
        func=task_a,
        priority=1
    ))
    
    task_b_id = await scheduler.add_task(Task(
        id="task-b",
        func=task_b,
        priority=2,
        dependencies={"task-a"}
    ))
    
    await scheduler.add_task(Task(
        id="task-c",
        func=task_c,
        priority=1
    ))
    
    await scheduler.add_task(Task(
        id="task-fail",
        func=task_fail,
        max_retries=2
    ))
    
    # è¿è¡Œè°ƒåº¦å™¨
    results = await scheduler.run()
    
    # æ‰“å°ç»“æœ
    print("\n=== ä»»åŠ¡ç»“æœ ===")
    for task_id, task in results.items():
        print(f"{task_id}: {task.status.value} - {task.result or task.error}")
    
    print(f"\n=== ç»Ÿè®¡ä¿¡æ¯ ===")
    print(scheduler.get_stats())

# asyncio.run(test_scheduler())
```

**è¯„åˆ†æ ‡å‡†**ï¼š
- ä¼˜å…ˆçº§é˜Ÿåˆ—æ­£ç¡®å®ç°ï¼ˆ20åˆ†ï¼‰
- ä¾èµ–å…³ç³»æ­£ç¡®å¤„ç†ï¼ˆ25åˆ†ï¼‰
- å¹¶å‘æ§åˆ¶å’Œè¶…æ—¶å¤„ç†ï¼ˆ20åˆ†ï¼‰
- é‡è¯•æœºåˆ¶ï¼ˆ15åˆ†ï¼‰
- å®æ—¶ç›‘æ§å’Œç»Ÿè®¡ï¼ˆ20åˆ†ï¼‰

---

### æŒ‘æˆ˜ 2ï¼šåˆ†å¸ƒå¼ Agent ç³»ç»Ÿï¼ˆéš¾åº¦ï¼šâ­â­â­â­â­ï¼‰

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šä»€ä¹ˆæ˜¯"åˆ†å¸ƒå¼ Agent ç³»ç»Ÿ"ï¼Ÿ**
>
> æƒ³è±¡ä½ åœ¨è¿è¥ä¸€ä¸ª**å¤–å–å¹³å°**ï¼š
>
> | ç³»ç»Ÿç»„ä»¶ | å¤–å–å¹³å°æ¯”å–» |
> |---------|-------------|
> | Agent | å¤–å–éª‘æ‰‹ï¼ˆå„æœ‰ä¸“é•¿ï¼šé€é¤ã€å–é¤ï¼‰ |
> | Coordinator | è°ƒåº¦ä¸­å¿ƒï¼ˆåˆ†é…è®¢å•ï¼‰ |
> | èƒ½åŠ›æ³¨å†Œ | éª‘æ‰‹ç™»è®°è‡ªå·±ä¼šé€ä»€ä¹ˆåŒºåŸŸ |
> | ä»»åŠ¡åˆ†å‘ | æ ¹æ®éª‘æ‰‹ä½ç½®åˆ†é…è®¢å• |
> | æ¶ˆæ¯ä¼ é€’ | éª‘æ‰‹å’Œè°ƒåº¦ä¸­å¿ƒçš„å¯¹è®²æœº |
> | è´Ÿè½½å‡è¡¡ | ä¸è®©ä¸€ä¸ªéª‘æ‰‹å¤ªå¿™ |
> | å®¹é”™æœºåˆ¶ | éª‘æ‰‹è¯·å‡ï¼Œè®¢å•è½¬ç»™åˆ«äºº |
>
> **ä¸ºä»€ä¹ˆè¿™ä¹ˆéš¾ï¼Ÿ** å› ä¸ºéœ€è¦åŒæ—¶è€ƒè™‘ï¼š
> - å¤šä¸ª Agent å¹¶å‘è¿è¡Œ
> - Agent ä¹‹é—´çš„é€šä¿¡
> - ä»»åŠ¡çš„æ™ºèƒ½åˆ†é…
> - æ•…éšœçš„è‡ªåŠ¨æ¢å¤

**éœ€æ±‚**ï¼š
è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼ Agent ç³»ç»Ÿï¼Œæ”¯æŒå¤šä¸ª Agent åä½œå®Œæˆå¤æ‚ä»»åŠ¡ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. **Agent æ³¨å†Œä¸å‘ç°**ï¼šAgent å¯ä»¥æ³¨å†Œè‡ªå·±çš„èƒ½åŠ›
2. **ä»»åŠ¡åˆ†å‘**ï¼šæ ¹æ® Agent èƒ½åŠ›è‡ªåŠ¨åˆ†å‘ä»»åŠ¡
3. **æ¶ˆæ¯ä¼ é€’**ï¼šAgent ä¹‹é—´å¯ä»¥å¼‚æ­¥é€šä¿¡
4. **è´Ÿè½½å‡è¡¡**ï¼šè‡ªåŠ¨åˆ†é…ä»»åŠ¡åˆ°ç©ºé—² Agent
5. **å®¹é”™æœºåˆ¶**ï¼šAgent å¤±è´¥æ—¶è‡ªåŠ¨é‡æ–°åˆ†é…ä»»åŠ¡
6. **åè°ƒå™¨**ï¼šä¸­å¤®åè°ƒå™¨ç®¡ç†æ‰€æœ‰ Agent

**ä»£ç æ¡†æ¶**ï¼š

```python
import asyncio
from typing import Dict, List, Set, Any, Optional, Callable
from dataclasses import dataclass, field
from enum import Enum
from abc import ABC, abstractmethod
import json

class AgentCapability(Enum):
    """Agent èƒ½åŠ›"""
    SEARCH = "search"
    CALCULATE = "calculate"
    SUMMARIZE = "summarize"
    TRANSLATE = "translate"

class MessageType(Enum):
    """æ¶ˆæ¯ç±»å‹"""
    TASK_REQUEST = "task_request"
    TASK_RESULT = "task_result"
    AGENT_STATUS = "agent_status"
    HEARTBEAT = "heartbeat"

@dataclass
class Message:
    """æ¶ˆæ¯æ•°æ®ç±»"""
    type: MessageType
    sender: str
    receiver: str
    content: Any
    timestamp: float = field(default_factory=lambda: asyncio.get_event_loop().time())

@dataclass
class AgentInfo:
    """Agent ä¿¡æ¯"""
    id: str
    capabilities: Set[AgentCapability]
    status: str = "idle"  # idle, busy, offline
    tasks_completed: int = 0
    last_heartbeat: float = field(default_factory=lambda: asyncio.get_event_loop().time())

class BaseAgent(ABC):
    """Agent åŸºç±»"""
    
    def __init__(self, agent_id: str, capabilities: Set[AgentCapability]):
        self.id = agent_id
        self.capabilities = capabilities
        self.message_queue: asyncio.Queue = asyncio.Queue()
        self.coordinator: Optional['Coordinator'] = None
        self.running = False
    
    async def connect(self, coordinator: 'Coordinator'):
        """è¿æ¥åˆ°åè°ƒå™¨"""
        self.coordinator = coordinator
        await coordinator.register_agent(self)
    
    @abstractmethod
    async def process_task(self, task: Dict[str, Any]) -> Any:
        """å¤„ç†ä»»åŠ¡ï¼ˆå­ç±»å®ç°ï¼‰"""
        pass
    
    async def run(self):
        """è¿è¡Œ Agent"""
        # TODO: å®ç° Agent ä¸»å¾ªç¯
        # - æ¥æ”¶æ¶ˆæ¯
        # - å¤„ç†ä»»åŠ¡
        # - å‘é€å¿ƒè·³
        pass
    
    async def send_message(self, message: Message):
        """å‘é€æ¶ˆæ¯"""
        # TODO: å®ç°æ¶ˆæ¯å‘é€
        pass

class Coordinator:
    """åè°ƒå™¨"""
    
    def __init__(self):
        self.agents: Dict[str, AgentInfo] = {}
        self.message_bus: Dict[str, asyncio.Queue] = {}
        self.task_queue: asyncio.Queue = asyncio.Queue()
        self.results: Dict[str, Any] = {}
    
    async def register_agent(self, agent: BaseAgent):
        """æ³¨å†Œ Agent"""
        # TODO: å®ç° Agent æ³¨å†Œé€»è¾‘
        pass
    
    async def assign_task(self, task: Dict[str, Any]) -> str:
        """åˆ†é…ä»»åŠ¡"""
        # TODO: å®ç°ä»»åŠ¡åˆ†é…é€»è¾‘
        # - æ ¹æ®èƒ½åŠ›é€‰æ‹© Agent
        # - å®ç°è´Ÿè½½å‡è¡¡
        pass
    
    async def monitor_agents(self):
        """ç›‘æ§ Agent çŠ¶æ€"""
        # TODO: å®ç°ç›‘æ§é€»è¾‘
        # - æ£€æŸ¥å¿ƒè·³
        # - å¤„ç† Agent å¤±è´¥
        pass
    
    async def run(self):
        """è¿è¡Œåè°ƒå™¨"""
        # TODO: å®ç°åè°ƒå™¨ä¸»å¾ªç¯
        pass

# å…·ä½“ Agent å®ç°
class SearchAgent(BaseAgent):
    """æœç´¢ Agent"""
    
    def __init__(self, agent_id: str):
        super().__init__(agent_id, {AgentCapability.SEARCH})
    
    async def process_task(self, task: Dict[str, Any]) -> Any:
        query = task.get("query")
        await asyncio.sleep(1)  # æ¨¡æ‹Ÿæœç´¢
        return {"results": f"æœç´¢ç»“æœ: {query}"}

class CalculatorAgent(BaseAgent):
    """è®¡ç®— Agent"""
    
    def __init__(self, agent_id: str):
        super().__init__(agent_id, {AgentCapability.CALCULATE})
    
    async def process_task(self, task: Dict[str, Any]) -> Any:
        expression = task.get("expression")
        await asyncio.sleep(0.5)
        return {"result": eval(expression)}

# æµ‹è¯•ä»£ç 
async def test_distributed_system():
    # åˆ›å»ºåè°ƒå™¨
    coordinator = Coordinator()
    
    # åˆ›å»º Agent
    agents = [
        SearchAgent("search-1"),
        SearchAgent("search-2"),
        CalculatorAgent("calc-1"),
    ]
    
    # è¿æ¥ Agent
    for agent in agents:
        await agent.connect(coordinator)
    
    # æäº¤ä»»åŠ¡
    tasks = [
        {"type": AgentCapability.SEARCH, "query": "Python async"},
        {"type": AgentCapability.CALCULATE, "expression": "10 + 20"},
        {"type": AgentCapability.SEARCH, "query": "LangChain"},
    ]
    
    # TODO: è¿è¡Œç³»ç»Ÿå¹¶è·å–ç»“æœ
    pass

# asyncio.run(test_distributed_system())
```

**è¯„åˆ†æ ‡å‡†**ï¼š
- Agent æ³¨å†Œä¸èƒ½åŠ›ç®¡ç†ï¼ˆ20åˆ†ï¼‰
- ä»»åŠ¡åˆ†å‘å’Œè´Ÿè½½å‡è¡¡ï¼ˆ25åˆ†ï¼‰
- æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼ˆ20åˆ†ï¼‰
- å®¹é”™å’Œæ•…éšœæ¢å¤ï¼ˆ20åˆ†ï¼‰
- ç³»ç»Ÿç›‘æ§å’Œç»Ÿè®¡ï¼ˆ15åˆ†ï¼‰

---

## å‚è€ƒè§£å†³æ–¹æ¡ˆ

<details>
<summary>æŒ‘æˆ˜ 1 å‚è€ƒå®ç°ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>

```python
import asyncio
from typing import List, Dict, Any, Optional, Callable, Set
from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
import heapq

class TaskStatus(Enum):
    PENDING = "pending"
    WAITING = "waiting"
    RUNNING = "running"
    COMPLETED = "completed"
    FAILED = "failed"
    TIMEOUT = "timeout"
    CANCELLED = "cancelled"

@dataclass
class Task:
    id: str
    func: Callable
    args: tuple = field(default_factory=tuple)
    kwargs: dict = field(default_factory=dict)
    priority: int = 1
    dependencies: Set[str] = field(default_factory=set)
    timeout: float = 30.0
    max_retries: int = 3
    retry_delay: float = 1.0
    
    status: TaskStatus = TaskStatus.PENDING
    result: Any = None
    error: Optional[Exception] = None
    retries: int = 0
    created_at: datetime = field(default_factory=datetime.now)
    started_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None
    
    def __lt__(self, other):
        return self.priority < other.priority

class SmartScheduler:
    def __init__(self, max_workers: int = 5):
        self.max_workers = max_workers
        self.semaphore = asyncio.Semaphore(max_workers)
        self.tasks: Dict[str, Task] = {}
        self.pending_queue: List[Task] = []
        self.completed_dependencies: Dict[str, Any] = {}
        self.running_tasks: Set[str] = set()
    
    async def add_task(self, task: Task) -> str:
        self.tasks[task.id] = task
        heapq.heappush(self.pending_queue, task)
        return task.id
    
    def _can_run(self, task: Task) -> bool:
        """æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å¯ä»¥è¿è¡Œ"""
        return all(dep in self.completed_dependencies for dep in task.dependencies)
    
    async def _execute_with_timeout(self, task: Task) -> Any:
        """æ‰§è¡Œä»»åŠ¡ï¼ˆå¸¦è¶…æ—¶ï¼‰"""
        # æ³¨å…¥ä¾èµ–ç»“æœ
        if task.dependencies:
            dep_results = {dep: self.completed_dependencies[dep] 
                          for dep in task.dependencies}
            task.kwargs['dependencies'] = dep_results
        
        return await asyncio.wait_for(
            task.func(*task.args, **task.kwargs),
            timeout=task.timeout
        )
    
    async def process_task(self, task: Task) -> Task:
        async with self.semaphore:
            task.status = TaskStatus.RUNNING
            task.started_at = datetime.now()
            self.running_tasks.add(task.id)
            
            while task.retries <= task.max_retries:
                try:
                    task.result = await self._execute_with_timeout(task)
                    task.status = TaskStatus.COMPLETED
                    task.completed_at = datetime.now()
                    self.completed_dependencies[task.id] = task.result
                    break
                
                except asyncio.TimeoutError:
                    task.status = TaskStatus.TIMEOUT
                    task.error = Exception("ä»»åŠ¡è¶…æ—¶")
                    break
                
                except Exception as e:
                    task.error = e
                    task.retries += 1
                    
                    if task.retries <= task.max_retries:
                        await asyncio.sleep(task.retry_delay * task.retries)
                    else:
                        task.status = TaskStatus.FAILED
                        break
            
            self.running_tasks.remove(task.id)
            return task
    
    async def run(self) -> Dict[str, Task]:
        workers = []
        
        while self.pending_queue or workers:
            # å¯åŠ¨å¯è¿è¡Œçš„ä»»åŠ¡
            ready_tasks = []
            remaining = []
            
            while self.pending_queue:
                task = heapq.heappop(self.pending_queue)
                if self._can_run(task):
                    ready_tasks.append(task)
                else:
                    task.status = TaskStatus.WAITING
                    remaining.append(task)
            
            # é‡æ–°åŠ å…¥é˜Ÿåˆ—
            for task in remaining:
                heapq.heappush(self.pending_queue, task)
            
            # å¯åŠ¨æ–°ä»»åŠ¡
            for task in ready_tasks:
                workers.append(asyncio.create_task(self.process_task(task)))
            
            # ç­‰å¾…ä»»åŠ¡å®Œæˆ
            if workers:
                done, workers = await asyncio.wait(
                    workers,
                    return_when=asyncio.FIRST_COMPLETED
                )
            
            await asyncio.sleep(0.1)  # çŸ­æš‚ä¼‘çœ ï¼Œé¿å…busy loop
        
        return self.tasks
    
    def get_stats(self) -> Dict[str, Any]:
        status_counts = {}
        for status in TaskStatus:
            status_counts[status.value] = sum(
                1 for t in self.tasks.values() if t.status == status
            )
        
        return {
            "total": len(self.tasks),
            "status": status_counts,
            "completed": sum(1 for t in self.tasks.values() 
                           if t.status == TaskStatus.COMPLETED),
            "failed": sum(1 for t in self.tasks.values() 
                         if t.status in [TaskStatus.FAILED, TaskStatus.TIMEOUT])
        }
```

</details>

---

## å­¦ä¹ èµ„æº

> **ğŸ¯ å°ç™½å­¦ä¹ å»ºè®®ï¼šå¼‚æ­¥ç¼–ç¨‹çš„å­¦ä¹ è·¯çº¿**
>
> 1. **å…ˆç†è§£æ¦‚å¿µ**ï¼šææ¸…æ¥š"ä¸ºä»€ä¹ˆè¦å¼‚æ­¥"æ¯”"æ€ä¹ˆå†™"æ›´é‡è¦
> 2. **å¤šå†™å¤šç»ƒ**ï¼šå…‰çœ‹ä¸ç»ƒæ°¸è¿œå­¦ä¸ä¼šï¼Œè¯•ç€æ”¹æ”¹ç¤ºä¾‹ä»£ç 
> 3. **ä»ç®€å•å¼€å§‹**ï¼šå…ˆç”¨ `gather()` å¹¶å‘å‡ ä¸ªä»»åŠ¡ï¼Œå†å­¦å¤æ‚çš„
> 4. **è°ƒè¯•æŠ€å·§**ï¼šå¤šç”¨ `print()` çœ‹æ‰§è¡Œé¡ºåºï¼Œç†è§£å¹¶å‘è¡Œä¸º

### æ¨èé˜…è¯»
- [Python asyncio å®˜æ–¹æ–‡æ¡£](https://docs.python.org/3/library/asyncio.html)
- [Real Python - Async IO](https://realpython.com/async-io-python/)
- [LangChain å¼‚æ­¥æ”¯æŒæ–‡æ¡£](https://python.langchain.com/docs/expression_language/interface)

### è¿›é˜¶ä¸»é¢˜
- `asyncio` å†…éƒ¨å®ç°åŸç†
- `uvloop` é«˜æ€§èƒ½äº‹ä»¶å¾ªç¯
- å¼‚æ­¥æ•°æ®åº“æ“ä½œï¼ˆasyncpg, motorï¼‰
- WebSocket å’Œ Server-Sent Events

---

**ä¸‹ä¸€ç« ï¼š[Module 7 - ç¯å¢ƒç®¡ç†ä¸ API é›†æˆ](../module-7-environment-apis/7.0-æœ¬ç« ä»‹ç».md)**
