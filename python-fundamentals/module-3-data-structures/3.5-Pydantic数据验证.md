# 2.4 Pydanticï¼šæ•°æ®éªŒè¯çš„åˆ©å™¨

## ä¸ºä»€ä¹ˆé€‰æ‹© Pydanticï¼Ÿ

TypedDict æä¾›ç±»å‹æç¤ºï¼Œä½†ä¸åšè¿è¡Œæ—¶éªŒè¯ã€‚Pydantic æä¾›ï¼š
- âœ… è¿è¡Œæ—¶æ•°æ®éªŒè¯
- âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢
- âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- âœ… JSON åºåˆ—åŒ–/ååºåˆ—åŒ–

LangChain å’Œ LangGraph å¤§é‡ä½¿ç”¨ Pydanticï¼

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šTypedDict vs Pydantic æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
>
> æƒ³è±¡ä½ åœ¨å¼€ä¸€å®¶é¤å…ï¼š
>
> **TypedDict** å°±åƒ**èœå•ä¸Šå†™ç€"ä»·æ ¼æ˜¯æ•°å­—"**ï¼š
> - é¡¾å®¢çœ‹åˆ°äº†çŸ¥é“åº”è¯¥å¡«æ•°å­—
> - ä½†å¦‚æœé¡¾å®¢éè¦å†™"äº”åå—"ï¼Œç³»ç»Ÿä¸ä¼šé˜»æ­¢
> - åªæ˜¯ä¸€ä¸ª"æç¤º"ï¼Œä¸å¼ºåˆ¶æ‰§è¡Œ
>
> **Pydantic** å°±åƒ**æ”¶é“¶ç³»ç»Ÿ**ï¼š
> - å¿…é¡»æ˜¯æ•°å­—æ‰èƒ½ç»“è´¦
> - å†™"äº”åå—"ä¼šæŠ¥é”™ï¼š"è¯·è¾“å…¥æ•°å­—ï¼"
> - å†™"50.0"ä¼šè‡ªåŠ¨è½¬æˆ 50
> - çœŸæ­£çš„"éªŒè¯"ï¼Œç¡®ä¿æ•°æ®æ­£ç¡®
>
> **ä¸ºä»€ä¹ˆ LangChain/LangGraph ç”¨ Pydanticï¼Ÿ**
> å› ä¸º AI å·¥å…·éœ€è¦æ¥æ”¶å„ç§ç”¨æˆ·è¾“å…¥ï¼Œå¿…é¡»ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚æ¯”å¦‚ï¼šæ¸©åº¦å¿…é¡»åœ¨ 0-2 ä¹‹é—´ï¼ŒAPI Key ä¸èƒ½ä¸ºç©ºâ€¦â€¦

## åŸºç¡€ç”¨æ³•

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šPydantic ä»£ç æ€ä¹ˆè¯»ï¼Ÿ**
>
> ```python
> class AgentConfig(BaseModel):
>     temperature: float = Field(default=0.7, ge=0, le=2)
> ```
>
> è¿™è¡Œä»£ç çš„æ„æ€æ˜¯ï¼š
> - `temperature`ï¼šå­—æ®µåå«"æ¸©åº¦"
> - `float`ï¼šç±»å‹æ˜¯å°æ•°
> - `default=0.7`ï¼šå¦‚æœä¸å¡«ï¼Œé»˜è®¤æ˜¯ 0.7
> - `ge=0`ï¼šå¿…é¡»**å¤§äºç­‰äº**ï¼ˆgreater or equalï¼‰0
> - `le=2`ï¼šå¿…é¡»**å°äºç­‰äº**ï¼ˆless or equalï¼‰2
>
> æ‰€ä»¥ `temperature` å¿…é¡»æ˜¯ 0 åˆ° 2 ä¹‹é—´çš„å°æ•°ï¼Œå¦åˆ™æŠ¥é”™ï¼

```python
from pydantic import BaseModel, Field, validator
from typing import Optional

class AgentConfig(BaseModel):
    """Agent é…ç½®æ¨¡å‹"""
    model: str = Field(description="æ¨¡å‹åç§°")
    temperature: float = Field(default=0.7, ge=0, le=2)
    max_tokens: int = Field(default=2000, gt=0)
    api_key: Optional[str] = None

    @validator("model")
    def validate_model(cls, v):
        """éªŒè¯æ¨¡å‹åç§°"""
        allowed = ["gpt-3.5-turbo", "gpt-4", "claude-3-opus"]
        if v not in allowed:
            raise ValueError(f"æ¨¡å‹å¿…é¡»æ˜¯ {allowed} ä¹‹ä¸€")
        return v

# åˆ›å»ºå®ä¾‹ï¼ˆè‡ªåŠ¨éªŒè¯ï¼‰
config = AgentConfig(
    model="gpt-4",
    temperature=0.5,
    max_tokens=3000
)

print(config.model_dump())  # è½¬ä¸ºå­—å…¸
print(config.model_dump_json())  # è½¬ä¸º JSON
```

### å­—æ®µéªŒè¯

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼š@validator å’Œ @field_validator æ˜¯ä»€ä¹ˆï¼Ÿ**
>
> è¿™äº›æ˜¯**è‡ªå®šä¹‰éªŒè¯å™¨**â€”â€”å½“å†…ç½®çš„éªŒè¯è§„åˆ™ä¸å¤Ÿç”¨æ—¶ï¼Œä½ å¯ä»¥å†™è‡ªå·±çš„éªŒè¯é€»è¾‘ã€‚
>
> æ¯”å¦‚ï¼š
> - `Field(ge=0)` åªèƒ½æ£€æŸ¥"å¤§äºç­‰äº0"
> - ä½†"å†…å®¹ä¸èƒ½æ˜¯çº¯ç©ºæ ¼"è¿™ç§è§„åˆ™ï¼Œéœ€è¦è‡ªå·±å†™
>
> `@field_validator("content")` çš„æ„æ€æ˜¯ï¼š"å½“è®¾ç½® content å­—æ®µæ—¶ï¼Œå…ˆæ‰§è¡Œä¸‹é¢è¿™ä¸ªå‡½æ•°æ£€æŸ¥ä¸€ä¸‹"ã€‚

```python
from pydantic import BaseModel, Field, field_validator

class Message(BaseModel):
    role: str = Field(pattern="^(user|assistant|system)$")
    content: str = Field(min_length=1, max_length=10000)
    timestamp: float = Field(gt=0)

    @field_validator("content")
    @classmethod
    def content_not_empty(cls, v: str) -> str:
        if not v.strip():
            raise ValueError("å†…å®¹ä¸èƒ½ä¸ºç©ºç™½")
        return v.strip()

# ä½¿ç”¨
msg = Message(
    role="user",
    content="  Hello  ",
    timestamp=1234567890.0
)
print(msg.content)  # "Hello" (å·²å»é™¤ç©ºæ ¼)
```

---

## åœ¨ LangChain ä¸­çš„åº”ç”¨

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šä¸ºä»€ä¹ˆ LangChain Tool éœ€è¦ Pydanticï¼Ÿ**
>
> AI Agent åœ¨è°ƒç”¨å·¥å…·æ—¶ï¼Œéœ€è¦çŸ¥é“ï¼š
> 1. å·¥å…·éœ€è¦ä»€ä¹ˆå‚æ•°ï¼Ÿï¼ˆå‚æ•°åã€ç±»å‹ï¼‰
> 2. å‚æ•°æœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿï¼ˆæœ€å°å€¼ã€æœ€å¤§å€¼ã€æ ¼å¼ï¼‰
>
> Pydantic çš„ `args_schema` å¸® AI ç†è§£"è¿™ä¸ªå·¥å…·æ€ä¹ˆç”¨"ï¼ŒåŒæ—¶ç¡®ä¿ AI ä¼ å…¥çš„å‚æ•°æ˜¯åˆæ³•çš„ã€‚
>
> æ¯”å¦‚æœç´¢å·¥å…·ï¼šAI å¿…é¡»ä¼ å…¥ä¸€ä¸ªè‡³å°‘ 2 ä¸ªå­—ç¬¦çš„æŸ¥è¯¢è¯ï¼Œæœ€å¤šè¿”å› 20 æ¡ç»“æœã€‚

### Tool å‚æ•°éªŒè¯

```python
from langchain.tools import tool
from pydantic import BaseModel, Field

class SearchInput(BaseModel):
    """æœç´¢å·¥å…·è¾“å…¥"""
    query: str = Field(description="æœç´¢æŸ¥è¯¢", min_length=2)
    max_results: int = Field(default=5, ge=1, le=20)
    language: str = Field(default="zh", pattern="^(zh|en)$")

@tool(args_schema=SearchInput)
def search_web(query: str, max_results: int = 5, language: str = "zh") -> str:
    """æœç´¢ç½‘ç»œ"""
    return f"æœç´¢ '{query}': {max_results} ä¸ªç»“æœ ({language})"

# Pydantic è‡ªåŠ¨éªŒè¯å‚æ•°ï¼
```

---

## å®æˆ˜ï¼šå®Œæ•´çš„ Agent é…ç½®ç³»ç»Ÿ

```python
from pydantic import BaseModel, Field, field_validator
from typing import Optional, Literal
import os

class LLMConfig(BaseModel):
    """LLM é…ç½®"""
    provider: Literal["openai", "anthropic"] = "openai"
    model: str = Field(description="æ¨¡å‹åç§°")
    temperature: float = Field(default=0.7, ge=0, le=2)
    max_tokens: int = Field(default=2000, gt=0, le=100000)
    api_key: Optional[str] = None
    
    @field_validator("api_key")
    @classmethod
    def load_api_key(cls, v: Optional[str], info) -> str:
        """ä»ç¯å¢ƒå˜é‡åŠ è½½ API å¯†é’¥"""
        if v:
            return v
        
        provider = info.data.get("provider", "openai")
        env_var = f"{provider.upper()}_API_KEY"
        key = os.getenv(env_var)
        
        if not key:
            raise ValueError(f"æœªæ‰¾åˆ° {env_var} ç¯å¢ƒå˜é‡")
        return key

class AgentConfig(BaseModel):
    """å®Œæ•´çš„ Agent é…ç½®"""
    name: str = Field(description="Agent åç§°")
    llm: LLMConfig
    system_prompt: str = Field(default="You are a helpful assistant.")
    tools: list[str] = Field(default_factory=list)
    max_iterations: int = Field(default=10, gt=0, le=50)
    
    class Config:
        # å…è®¸ä»ç¯å¢ƒå˜é‡è¯»å–
        env_prefix = "AGENT_"

# ä½¿ç”¨
config = AgentConfig(
    name="ResearchBot",
    llm=LLMConfig(
        provider="openai",
        model="gpt-4",
        temperature=0.5
    ),
    tools=["search", "calculator"]
)

print(config.model_dump_json(indent=2))
```

---

**ä¸‹ä¸€èŠ‚ï¼š[2.5 å®æˆ˜ï¼šLangGraph çŠ¶æ€ç³»ç»Ÿ](2.5-å®æˆ˜ï¼šLangGraphçŠ¶æ€ç³»ç»Ÿ.md)**
