# 2.3 é›†åˆä¸ TypedDict

## ç¬¬ä¸€éƒ¨åˆ†ï¼šé›†åˆï¼ˆSetï¼‰

### ä»€ä¹ˆæ˜¯é›†åˆï¼Ÿ

é›†åˆæ˜¯**æ— åºã€ä¸é‡å¤**çš„å…ƒç´ é›†åˆã€‚åœ¨ AI Agent ä¸­ç”¨äºï¼š
- å»é‡ï¼ˆå·²å¤„ç†çš„ä»»åŠ¡IDï¼‰
- æˆå‘˜æ£€æŸ¥ï¼ˆæ˜¯å¦ä½¿ç”¨è¿‡æŸå·¥å…·ï¼‰
- é›†åˆè¿ç®—ï¼ˆäº¤é›†ã€å¹¶é›†ã€å·®é›†ï¼‰

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šä»€ä¹ˆæ˜¯"é›†åˆ"ï¼Ÿ**
>
> é›†åˆå°±åƒ**ç­¾åˆ°è¡¨**æˆ–**æŠ•ç¥¨ç®±**ï¼š
>
> - **ä¸é‡å¤**ï¼šä¸€ä¸ªäººåªèƒ½ç­¾ä¸€æ¬¡åˆ°ï¼Œé‡å¤ç­¾ä¹Ÿåªç®—ä¸€ä¸ªäºº
> - **æ— é¡ºåº**ï¼šä¸å…³å¿ƒè°å…ˆæ¥è°åæ¥ï¼Œåªå…³å¿ƒ"æ¥æ²¡æ¥è¿‡"
> - **æŸ¥æ‰¾è¶…å¿«**ï¼šåˆ¤æ–­æŸäººæ˜¯å¦ç­¾è¿‡åˆ°ï¼Œä¸€ç¬é—´å°±èƒ½çŸ¥é“
>
> åœ¨ AI Agent ä¸­ï¼Œé›†åˆå¸¸ç”¨äºï¼š
> - "è¿™ä¸ªä»»åŠ¡å¤„ç†è¿‡æ²¡ï¼Ÿ"ï¼ˆä»»åŠ¡å»é‡ï¼‰
> - "è¿™ä¸ªå·¥å…·ç”¨è¿‡æ²¡ï¼Ÿ"ï¼ˆå·¥å…·è¿½è¸ªï¼‰
> - "è¿™ä¸ªç½‘é¡µçˆ¬è¿‡æ²¡ï¼Ÿ"ï¼ˆé¿å…é‡å¤çˆ¬å–ï¼‰

```python
# åˆ›å»ºé›†åˆ
tools_used = {"search", "calculator", "search"}  # è‡ªåŠ¨å»é‡
print(tools_used)  # {'search', 'calculator'}

# ç©ºé›†åˆ
empty_set = set()  # æ³¨æ„ï¼š{} æ˜¯å­—å…¸ï¼

# ä»åˆ—è¡¨åˆ›å»º
ids = [1, 2, 2, 3, 3, 3]
unique_ids = set(ids)  # {1, 2, 3}
```

### é›†åˆæ“ä½œ

```python
# æ·»åŠ å…ƒç´ 
tools = set()
tools.add("search")
tools.add("calculator")

# åˆ é™¤å…ƒç´ 
tools.remove("search")  # KeyError if not exists
tools.discard("weather")  # No error if not exists

# æˆå‘˜æ£€æŸ¥ï¼ˆéå¸¸å¿«ï¼O(1)ï¼‰
if "search" in tools:
    print("å·²ä½¿ç”¨æœç´¢å·¥å…·")

# é›†åˆè¿ç®—
a = {1, 2, 3}
b = {2, 3, 4}

print(a | b)  # å¹¶é›†: {1, 2, 3, 4}
print(a & b)  # äº¤é›†: {2, 3}
print(a - b)  # å·®é›†: {1}
print(a ^ b)  # å¯¹ç§°å·®: {1, 4}
```

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šé›†åˆè¿ç®—æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ**
>
> æƒ³è±¡ä¸¤ä¸ªç­çº§çš„å­¦ç”Ÿåå•ï¼š
>
> - **å¹¶é›† `|`**ï¼šä¸¤ä¸ªç­æ‰€æœ‰å­¦ç”Ÿï¼ˆåˆå¹¶ï¼Œå»é‡ï¼‰
> - **äº¤é›† `&`**ï¼šä¸¤ä¸ªç­éƒ½æœ‰çš„å­¦ç”Ÿï¼ˆåŒæ—¶åœ¨ä¸¤è¾¹çš„ï¼‰
> - **å·®é›† `-`**ï¼šåªåœ¨Aç­ã€ä¸åœ¨Bç­çš„å­¦ç”Ÿ
> - **å¯¹ç§°å·® `^`**ï¼šåªåœ¨ä¸€ä¸ªç­çš„å­¦ç”Ÿï¼ˆä¸åŒæ—¶å‡ºç°çš„ï¼‰
>
> ```python
> ç­çº§A = {"å°æ˜", "å°çº¢", "å°åˆš"}
> ç­çº§B = {"å°çº¢", "å°åˆš", "å°ç¾"}
>
> ç­çº§A | ç­çº§B  # {"å°æ˜", "å°çº¢", "å°åˆš", "å°ç¾"} æ‰€æœ‰äºº
> ç­çº§A & ç­çº§B  # {"å°çº¢", "å°åˆš"} ä¸¤è¾¹éƒ½æœ‰çš„äºº
> ç­çº§A - ç­çº§B  # {"å°æ˜"} åªåœ¨Aç­çš„äºº
> ```

### AI åº”ç”¨ï¼šä»»åŠ¡å»é‡ç³»ç»Ÿ

```python
class TaskDeduplicator:
    """ä»»åŠ¡å»é‡å™¨"""
    
    def __init__(self):
        self.processed_tasks: set[str] = set()
    
    def is_duplicate(self, task_id: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦é‡å¤"""
        return task_id in self.processed_tasks
    
    def mark_processed(self, task_id: str) -> None:
        """æ ‡è®°ä¸ºå·²å¤„ç†"""
        self.processed_tasks.add(task_id)
    
    def process_task(self, task_id: str, task_content: str) -> str:
        """å¤„ç†ä»»åŠ¡"""
        if self.is_duplicate(task_id):
            return f"ä»»åŠ¡ {task_id} å·²å¤„ç†ï¼Œè·³è¿‡"
        
        # å¤„ç†é€»è¾‘
        result = f"å¤„ç†ä»»åŠ¡: {task_content}"
        self.mark_processed(task_id)
        return result

# ä½¿ç”¨
dedup = TaskDeduplicator()
print(dedup.process_task("task_1", "æœç´¢Python"))
print(dedup.process_task("task_1", "æœç´¢Python"))  # è·³è¿‡
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šTypedDict

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šä»€ä¹ˆæ˜¯ TypedDictï¼Ÿ**
>
> æ™®é€šå­—å…¸å°±åƒä¸€ä¸ª**éšä¾¿å†™çš„ä¾¿ç­¾**â€”â€”ä½ æƒ³å†™ä»€ä¹ˆé”®éƒ½è¡Œï¼Œå†™é”™äº†ä¹Ÿæ²¡äººæé†’ã€‚
>
> TypedDict å°±åƒä¸€ä¸ª**è¡¨æ ¼æ¨¡æ¿**â€”â€”è§„å®šå¥½äº†æœ‰å“ªäº›åˆ—ã€æ¯åˆ—å¡«ä»€ä¹ˆç±»å‹çš„æ•°æ®ã€‚
>
> æ¯”å¦‚"ç”¨æˆ·ä¿¡æ¯è¡¨"å¿…é¡»æœ‰ï¼šå§“åï¼ˆæ–‡å­—ï¼‰ã€å¹´é¾„ï¼ˆæ•°å­—ï¼‰ã€é‚®ç®±ï¼ˆæ–‡å­—ï¼‰ã€‚å¦‚æœä½ æ¼å¡«æˆ–è€…å¡«é”™ç±»å‹ï¼Œç³»ç»Ÿä¼šæé†’ä½ ã€‚
>
> **ä¸ºä»€ä¹ˆåœ¨ LangGraph ä¸­å¾ˆé‡è¦ï¼Ÿ**
> LangGraph çš„ Stateï¼ˆçŠ¶æ€ï¼‰å°±æ˜¯ç”¨ TypedDict å®šä¹‰çš„ï¼å®ƒç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¼ é€’çš„çŠ¶æ€éƒ½æœ‰ç»Ÿä¸€çš„ç»“æ„ï¼Œä¸ä¼šå› ä¸ºæ‹¼å†™é”™è¯¯æˆ–å°‘ä¼ å­—æ®µè€Œå‡ºbugã€‚

### ä¸ºä»€ä¹ˆéœ€è¦ TypedDictï¼Ÿ

æ™®é€šå­—å…¸æ²¡æœ‰ç±»å‹æ£€æŸ¥ï¼š

```python
# é—®é¢˜ï¼šå­—å…¸çš„é”®å’Œå€¼ç±»å‹ä¸æ˜ç¡®
config = {
    "model": "gpt-4",
    "temperature": 0.7,
    "max_tokens": 2000
}

# IDE æ— æ³•æä¾›è¡¥å…¨
# æ‹¼å†™é”™è¯¯æ— æ³•æ£€æµ‹
temp = config["temprature"]  # typo!
```

TypedDict è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼š

```python
from typing import TypedDict

class AgentConfig(TypedDict):
    model: str
    temperature: float
    max_tokens: int

# ç°åœ¨æœ‰ç±»å‹æ£€æŸ¥ï¼
config: AgentConfig = {
    "model": "gpt-4",
    "temperature": 0.7,
    "max_tokens": 2000
}

# IDE ä¼šæä¾›è¡¥å…¨å’Œæ£€æŸ¥
temp = config["temperature"]  # âœ…
```

### å¯é€‰å­—æ®µ

```python
from typing import TypedDict, NotRequired

class AgentState(TypedDict):
    messages: list[str]  # å¿…éœ€
    context: NotRequired[dict]  # å¯é€‰
    metadata: NotRequired[dict]  # å¯é€‰

# æœ‰æ•ˆ
state1: AgentState = {"messages": []}
state2: AgentState = {"messages": [], "context": {}}
```

### ä¸ LangGraph çš„è”ç³»

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šAnnotated æ˜¯ä»€ä¹ˆï¼Ÿ**
>
> `Annotated` å°±æ˜¯ç»™ç±»å‹**åŠ æ³¨é‡Š/åŠ è¯´æ˜**ã€‚
>
> - `messages: list` åªè¯´"è¿™æ˜¯ä¸€ä¸ªåˆ—è¡¨"
> - `messages: Annotated[list, "æ¶ˆæ¯å†å²"]` è¯´"è¿™æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œè€Œä¸”å®ƒæ˜¯æ¶ˆæ¯å†å²"
>
> åœ¨ LangGraph ä¸­ï¼ŒAnnotated è¿˜å¯ä»¥æŒ‡å®š**çŠ¶æ€åˆå¹¶ç­–ç•¥**ï¼ˆæ¯”å¦‚æ¶ˆæ¯æ˜¯è¿½åŠ è¿˜æ˜¯æ›¿æ¢ï¼‰ï¼Œè¿™åœ¨åé¢çš„ç« èŠ‚ä¼šè¯¦ç»†è®²ã€‚

```python
from typing import TypedDict, Annotated
from langgraph.graph import StateGraph
from langchain_core.messages import BaseMessage

class MyAgentState(TypedDict):
    """LangGraph Agent çŠ¶æ€"""
    messages: Annotated[list[BaseMessage], "æ¶ˆæ¯å†å²"]
    iteration: Annotated[int, "è¿­ä»£æ¬¡æ•°"]
    next_action: Annotated[str, "ä¸‹ä¸€æ­¥åŠ¨ä½œ"]

# åœ¨ LangGraph ä¸­ä½¿ç”¨
workflow = StateGraph(MyAgentState)
```

---

## å®æˆ˜ï¼šå®Œæ•´çš„çŠ¶æ€ç³»ç»Ÿ

```python
from typing import TypedDict, NotRequired, Literal
from dataclasses import dataclass
from datetime import datetime

# TypedDict å®šä¹‰çŠ¶æ€ç»“æ„
class ConversationState(TypedDict):
    session_id: str
    messages: list[dict]
    current_step: Literal["greeting", "processing", "responding"]
    confidence: float
    tools_used: set[str]
    metadata: NotRequired[dict]

@dataclass
class StateManager:
    """çŠ¶æ€ç®¡ç†å™¨"""
    
    def create_initial_state(self, session_id: str) -> ConversationState:
        """åˆ›å»ºåˆå§‹çŠ¶æ€"""
        return {
            "session_id": session_id,
            "messages": [],
            "current_step": "greeting",
            "confidence": 0.0,
            "tools_used": set()
        }
    
    def validate_state(self, state: ConversationState) -> bool:
        """éªŒè¯çŠ¶æ€å®Œæ•´æ€§"""
        required_keys = {"session_id", "messages", "current_step"}
        return all(key in state for key in required_keys)

# ä½¿ç”¨
manager = StateManager()
state = manager.create_initial_state("session_001")
print(f"çŠ¶æ€æœ‰æ•ˆ: {manager.validate_state(state)}")
```

---

**ä¸‹ä¸€èŠ‚ï¼š[2.4 Pydantic æ•°æ®éªŒè¯](2.4-Pydanticæ•°æ®éªŒè¯.md)**
