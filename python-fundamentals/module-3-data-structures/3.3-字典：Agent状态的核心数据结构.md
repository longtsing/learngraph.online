# 2.2 å­—å…¸ï¼šAgent çŠ¶æ€çš„æ ¸å¿ƒæ•°æ®ç»“æ„

## å¼•è¨€ï¼šAgent çš„"å¤§è„‘"

åœ¨ LangGraph ä¸­ï¼Œ**Stateï¼ˆçŠ¶æ€ï¼‰** æ˜¯æ ¸å¿ƒæ¦‚å¿µã€‚æ¯ä¸ª Agent çš„çŠ¶æ€æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª**å­—å…¸**ï¼š

```python
{
    "messages": [...],
    "current_step": "analyzing",
    "confidence": 0.85,
    "tools_used": ["search", "calculator"],
    "metadata": {"user_id": "123"}
}
```

å­—å…¸æ˜¯ Python ä¸­æœ€çµæ´»ã€æœ€å¼ºå¤§çš„æ•°æ®ç»“æ„ï¼Œç†è§£å­—å…¸å°±æ˜¯ç†è§£å¦‚ä½•ç®¡ç† Agent çš„çŠ¶æ€ã€‚

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šä»€ä¹ˆæ˜¯"å­—å…¸"ï¼Ÿ**
>
> Python çš„å­—å…¸å°±åƒ**çœŸå®ä¸–ç•Œçš„å­—å…¸**æˆ–**é€šè®¯å½•**ï¼š
>
> - é€šè®¯å½•é‡Œä½ ç”¨**åå­—**æ‰¾**ç”µè¯å·ç **
> - Python å­—å…¸é‡Œä½ ç”¨**é”®ï¼ˆkeyï¼‰**æ‰¾**å€¼ï¼ˆvalueï¼‰**
>
> ```python
> # é€šè®¯å½•çš„ä¾‹å­
> contacts = {
>     "å¼ ä¸‰": "138-1234-5678",
>     "æå››": "139-8765-4321"
> }
> print(contacts["å¼ ä¸‰"])  # è¾“å‡ºï¼š138-1234-5678
> ```
>
> **ä¸ºä»€ä¹ˆ AI Agent çˆ±ç”¨å­—å…¸ï¼Ÿ**
> å› ä¸º Agent éœ€è¦åŒæ—¶è®°ä½å¾ˆå¤šä¸åŒç±»å‹çš„ä¿¡æ¯ï¼šå½“å‰åœ¨åšä»€ä¹ˆã€ç”¨æˆ·è¯´äº†ä»€ä¹ˆã€ç”¨äº†å“ªäº›å·¥å…·â€¦â€¦å­—å…¸å¯ä»¥æŠŠè¿™äº›ä¿¡æ¯**åˆ†é—¨åˆ«ç±»**å­˜å¥½ï¼Œéœ€è¦æ—¶ç«‹åˆ»å–å‡ºæ¥ã€‚

## å­¦ä¹ ç›®æ ‡

- âœ… æŒæ¡å­—å…¸çš„åˆ›å»ºå’Œæ“ä½œ
- âœ… ç†è§£å­—å…¸çš„é«˜çº§ç”¨æ³•
- âœ… æŒæ¡ defaultdict å’Œ Counter
- âœ… å®æˆ˜ï¼šæ„å»º Agent çŠ¶æ€ç®¡ç†ç³»ç»Ÿ

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šå­—å…¸åŸºç¡€

### åˆ›å»ºå­—å…¸

```python
# ç©ºå­—å…¸
config: dict = {}
config: dict[str, int] = {}  # å¸¦ç±»å‹æ³¨è§£

# å­—é¢é‡åˆ›å»º
agent_config = {
    "model": "gpt-5",
    "temperature": 0.7,
    "max_tokens": 2000
}

# dict() æ„é€ å‡½æ•°
config = dict(model="gpt-5", temperature=0.7)

# ä»é”®å€¼å¯¹åˆ—è¡¨åˆ›å»º
pairs = [("a", 1), ("b", 2)]
d = dict(pairs)  # {'a': 1, 'b': 2}
```

### åŸºæœ¬æ“ä½œ

```python
config = {"model": "gpt-5-turbo", "temperature": 0.7}

# è®¿é—®å€¼
print(config["model"])  # 'gpt-3.5-turbo'

# å®‰å…¨è®¿é—®ï¼ˆä½¿ç”¨ getï¼‰
temp = config.get("temperature")  # 0.7
max_tokens = config.get("max_tokens", 2000)  # ä¸å­˜åœ¨è¿”å›é»˜è®¤å€¼

# ğŸ¯ å°ç™½æç¤ºï¼šget() æ˜¯"å®‰å…¨è®¿é—®"
# config["xxx"] å¦‚æœé”®ä¸å­˜åœ¨ä¼šæŠ¥é”™å´©æºƒ
# config.get("xxx") é”®ä¸å­˜åœ¨ä¼šè¿”å› Noneï¼Œç¨‹åºä¸ä¼šå´©
# config.get("xxx", é»˜è®¤å€¼) é”®ä¸å­˜åœ¨è¿”å›ä½ æŒ‡å®šçš„é»˜è®¤å€¼

# æ·»åŠ /ä¿®æ”¹é”®å€¼å¯¹
config["max_tokens"] = 2000
config["temperature"] = 0.5  # ä¿®æ”¹

# åˆ é™¤é”®
del config["temperature"]
removed = config.pop("model")  # åˆ é™¤å¹¶è¿”å›å€¼

# æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
if "model" in config:
    print("æ¨¡å‹å·²é…ç½®")

# è·å–æ‰€æœ‰é”®ã€å€¼ã€é”®å€¼å¯¹
keys = config.keys()      # dict_keys(['max_tokens'])
values = config.values()  # dict_values([2000])
items = config.items()    # dict_items([('max_tokens', 2000)])
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šå­—å…¸é«˜çº§æ“ä½œ

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šä»€ä¹ˆæ˜¯"å­—å…¸æ¨å¯¼å¼"ï¼Ÿ**
>
> å’Œåˆ—è¡¨æ¨å¯¼å¼ä¸€æ ·ï¼Œå­—å…¸æ¨å¯¼å¼æ˜¯**å¿«é€Ÿåˆ›å»ºå­—å…¸çš„è¯­æ³•ç³–**ã€‚
>
> è¯­æ³•æ¨¡æ¿ï¼š`{é”®: å€¼ for å˜é‡ in åºåˆ—}`
>
> æ¯”å¦‚ä½ æƒ³åˆ›å»ºä¸€ä¸ª"æ•°å­—â†’å¹³æ–¹"çš„å¯¹ç…§è¡¨ï¼Œä¼ ç»Ÿæ–¹å¼è¦å†™å¥½å‡ è¡Œï¼Œæ¨å¯¼å¼ä¸€è¡Œæå®šï¼

### å­—å…¸æ¨å¯¼å¼

```python
# åŸºæœ¬å­—å…¸æ¨å¯¼å¼
squares = {x: x**2 for x in range(5)}
# {0: 0, 1: 1, 2: 4, 3: 9, 4: 16}

# å¸¦æ¡ä»¶
even_squares = {x: x**2 for x in range(10) if x % 2 == 0}

# AI åº”ç”¨ï¼šä»åˆ—è¡¨åˆ›å»ºç´¢å¼•æ˜ å°„
tools = ["search", "calculator", "weather"]
tool_map = {tool: i for i, tool in enumerate(tools)}
# {'search': 0, 'calculator': 1, 'weather': 2}

# åè½¬å­—å…¸
original = {"a": 1, "b": 2, "c": 3}
reversed_dict = {v: k for k, v in original.items()}
# {1: 'a', 2: 'b', 3: 'c'}
```

### åˆå¹¶å­—å…¸

```python
# Python 3.9+ ä½¿ç”¨ | è¿ç®—ç¬¦
dict1 = {"a": 1, "b": 2}
dict2 = {"c": 3, "d": 4}
merged = dict1 | dict2  # {'a': 1, 'b': 2, 'c': 3, 'd': 4}

# æ›´æ–°ï¼ˆåè€…è¦†ç›–å‰è€…ï¼‰
dict1 = {"a": 1, "b": 2}
dict2 = {"b": 3, "c": 4}
merged = dict1 | dict2  # {'a': 1, 'b': 3, 'c': 4}

# update() æ–¹æ³•
config = {"model": "gpt-3.5-turbo"}
config.update({"temperature": 0.7, "max_tokens": 2000})

# ** è§£åŒ…ï¼ˆæ¨èï¼‰
defaults = {"temperature": 0.7, "max_tokens": 2000}
user_config = {"temperature": 0.5}
final_config = {**defaults, **user_config}
# {'temperature': 0.5, 'max_tokens': 2000}
```

### åµŒå¥—å­—å…¸

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šä»€ä¹ˆæ˜¯"åµŒå¥—å­—å…¸"ï¼Ÿ**
>
> å°±æ˜¯**å­—å…¸é‡Œé¢å¥—å­—å…¸**ï¼Œåƒä¿„ç½—æ–¯å¥—å¨ƒä¸€æ ·ã€‚
>
> æƒ³è±¡ä¸€ä¸ªå…¬å¸çš„ç»„ç»‡æ¶æ„ï¼š
> - å…¬å¸ â†’ éƒ¨é—¨ â†’ å‘˜å·¥
> - æ¯ä¸€å±‚éƒ½å¯ä»¥ç”¨å­—å…¸è¡¨ç¤º
>
> åœ¨ AI Agent ä¸­ï¼ŒçŠ¶æ€ä¿¡æ¯å¾€å¾€æ˜¯**å¤šå±‚åµŒå¥—çš„**ï¼šç”¨æˆ·ä¿¡æ¯é‡Œæœ‰å§“åã€IDï¼›å¯¹è¯ä¿¡æ¯é‡Œæœ‰æ¶ˆæ¯åˆ—è¡¨ã€è½®æ•°â€¦â€¦

```python
agent_state = {
    "user": {
        "id": "123",
        "name": "Alice"
    },
    "conversation": {
        "messages": [],
        "turn_count": 0
    },
    "tools": {
        "available": ["search", "calculator"],
        "used": []
    }
}

# è®¿é—®åµŒå¥—å€¼
user_name = agent_state["user"]["name"]

# å®‰å…¨è®¿é—®åµŒå¥—å€¼
from typing import Any

def get_nested(d: dict, *keys: str, default: Any = None) -> Any:
    """å®‰å…¨è·å–åµŒå¥—å­—å…¸çš„å€¼"""
    for key in keys:
        if isinstance(d, dict):
            d = d.get(key, default)
        else:
            return default
    return d

# ä½¿ç”¨
name = get_nested(agent_state, "user", "name")  # 'Alice'
missing = get_nested(agent_state, "user", "age", default=0)  # 0
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šdefaultdict å’Œ Counter

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šdefaultdict è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ**
>
> æ™®é€šå­—å…¸è®¿é—®ä¸å­˜åœ¨çš„é”®ä¼š**æŠ¥é”™**ã€‚ä½†æœ‰æ—¶å€™æˆ‘ä»¬æƒ³ï¼šå¦‚æœé”®ä¸å­˜åœ¨ï¼Œå°±**è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤å€¼**ã€‚
>
> æ¯”å¦‚ç»Ÿè®¡å•è¯å‡ºç°æ¬¡æ•°ï¼š
> - æ™®é€šå­—å…¸ï¼šå…ˆæ£€æŸ¥é”®å­˜ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±è®¾ä¸º 0ï¼Œç„¶å +1
> - defaultdictï¼šç›´æ¥ +1ï¼Œä¸å­˜åœ¨ä¼šè‡ªåŠ¨å˜æˆ 0 å† +1
>
> è¿™å°±åƒè‡ªåŠ¨å”®è´§æœºï¼šæ™®é€šå­—å…¸æ˜¯"æ²¡è´§å°±æŠ¥é”™"ï¼Œdefaultdict æ˜¯"æ²¡è´§å°±è‡ªåŠ¨è¡¥ä¸Šå†å–"ã€‚

### defaultdict

```python
from collections import defaultdict

# é—®é¢˜ï¼šæ™®é€šå­—å…¸éœ€è¦æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
word_count = {}
for word in ["apple", "banana", "apple"]:
    if word in word_count:
        word_count[word] += 1
    else:
        word_count[word] = 1

# è§£å†³æ–¹æ¡ˆï¼šdefaultdict
word_count = defaultdict(int)  # é»˜è®¤å€¼ä¸º 0
for word in ["apple", "banana", "apple"]:
    word_count[word] += 1

print(dict(word_count))  # {'apple': 2, 'banana': 1}

# å…¶ä»–é»˜è®¤ç±»å‹
# defaultdict(list) - é»˜è®¤å€¼ä¸º []
# defaultdict(set) - é»˜è®¤å€¼ä¸º set()
# defaultdict(dict) - é»˜è®¤å€¼ä¸º {}

# AI åº”ç”¨ï¼šæŒ‰ç±»åˆ«ç»„ç»‡å·¥å…·
from collections import defaultdict

tools_by_category = defaultdict(list)
tools_by_category["search"].append("google_search")
tools_by_category["search"].append("bing_search")
tools_by_category["math"].append("calculator")
```

### Counter

> **ğŸ¯ å°ç™½ç†è§£æŒ‡å—ï¼šCounter æ˜¯ä»€ä¹ˆï¼Ÿ**
>
> Counter æ˜¯ Python å†…ç½®çš„**è®¡æ•°ç¥å™¨**â€”â€”ä¸“é—¨ç”¨æ¥æ•°"æ¯ä¸ªä¸œè¥¿å‡ºç°äº†å‡ æ¬¡"ã€‚
>
> æƒ³è±¡ä½ åœ¨æ•°ä¸€ç­æ°´æœï¼šè‹¹æœ3ä¸ªã€é¦™è•‰2ä¸ªã€æ¨±æ¡ƒ1ä¸ªã€‚
> Counter å¯ä»¥ä¸€è¡Œä»£ç å¸®ä½ æ•°å¥½ï¼
>
> å®ƒè¿˜èƒ½å‘Šè¯‰ä½ "å‡ºç°æœ€å¤šçš„æ˜¯ä»€ä¹ˆ"ï¼ˆmost_commonï¼‰ï¼Œåœ¨ç»Ÿè®¡ AI å·¥å…·ä½¿ç”¨é¢‘ç‡æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚

```python
from collections import Counter

# è®¡æ•°å™¨
words = ["apple", "banana", "apple", "cherry", "banana", "apple"]
counter = Counter(words)
print(counter)  # Counter({'apple': 3, 'banana': 2, 'cherry': 1})

# æœ€å¸¸è§çš„å…ƒç´ 
print(counter.most_common(2))  # [('apple', 3), ('banana', 2)]

# AI åº”ç”¨ï¼šç»Ÿè®¡ Agent ä½¿ç”¨çš„å·¥å…·
tool_usage = Counter()
tool_usage["search"] += 1
tool_usage["calculator"] += 1
tool_usage["search"] += 1

print(f"æœç´¢å·¥å…·ä½¿ç”¨äº† {tool_usage['search']} æ¬¡")
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šå®æˆ˜ - Agent çŠ¶æ€ç®¡ç†ç³»ç»Ÿ

```python
"""
Agent çŠ¶æ€ç®¡ç†ç³»ç»Ÿ
æ¼”ç¤ºå­—å…¸åœ¨ AI Agent ä¸­çš„æ ¸å¿ƒåº”ç”¨
"""

from typing import Dict, List, Any, Optional
from dataclasses import dataclass, field
from datetime import datetime
from collections import defaultdict, Counter
import json


@dataclass
class AgentState:
    """Agent çŠ¶æ€æ•°æ®ç±»"""
    
    # å¿…éœ€å­—æ®µ
    session_id: str
    
    # æ¶ˆæ¯å†å²
    messages: List[Dict[str, str]] = field(default_factory=list)
    
    # å½“å‰çŠ¶æ€
    current_step: str = "init"
    confidence: float = 0.0
    
    # å·¥å…·ä½¿ç”¨
    tools_available: List[str] = field(default_factory=list)
    tools_used: List[str] = field(default_factory=list)
    
    # å…ƒæ•°æ®
    metadata: Dict[str, Any] = field(default_factory=dict)
    
    # ç»Ÿè®¡ä¿¡æ¯
    stats: Dict[str, int] = field(default_factory=lambda: defaultdict(int))
    
    # æ—¶é—´æˆ³
    created_at: datetime = field(default_factory=datetime.now)
    updated_at: datetime = field(default_factory=datetime.now)


class StateManager:
    """çŠ¶æ€ç®¡ç†å™¨"""
    
    def __init__(self):
        """åˆå§‹åŒ–çŠ¶æ€ç®¡ç†å™¨"""
        self.states: Dict[str, AgentState] = {}
    
    def create_state(
        self,
        session_id: str,
        tools: Optional[List[str]] = None
    ) -> AgentState:
        """
        åˆ›å»ºæ–°çŠ¶æ€
        
        Args:
            session_id: ä¼šè¯ID
            tools: å¯ç”¨å·¥å…·åˆ—è¡¨
        
        Returns:
            æ–°åˆ›å»ºçš„çŠ¶æ€
        """
        state = AgentState(
            session_id=session_id,
            tools_available=tools or []
        )
        self.states[session_id] = state
        return state
    
    def get_state(self, session_id: str) -> Optional[AgentState]:
        """è·å–çŠ¶æ€"""
        return self.states.get(session_id)
    
    def update_state(
        self,
        session_id: str,
        updates: Dict[str, Any]
    ) -> None:
        """
        æ›´æ–°çŠ¶æ€
        
        Args:
            session_id: ä¼šè¯ID
            updates: è¦æ›´æ–°çš„å­—æ®µ
        """
        state = self.states.get(session_id)
        if not state:
            raise ValueError(f"çŠ¶æ€ {session_id} ä¸å­˜åœ¨")
        
        # æ›´æ–°å­—æ®µ
        for key, value in updates.items():
            if hasattr(state, key):
                setattr(state, key, value)
        
        state.updated_at = datetime.now()
    
    def add_message(
        self,
        session_id: str,
        role: str,
        content: str
    ) -> None:
        """æ·»åŠ æ¶ˆæ¯åˆ°å†å²"""
        state = self.states.get(session_id)
        if state:
            state.messages.append({
                "role": role,
                "content": content,
                "timestamp": datetime.now().isoformat()
            })
            state.stats["message_count"] += 1
    
    def record_tool_use(self, session_id: str, tool_name: str) -> None:
        """è®°å½•å·¥å…·ä½¿ç”¨"""
        state = self.states.get(session_id)
        if state:
            state.tools_used.append(tool_name)
            state.stats[f"tool_{tool_name}"] += 1
    
    def get_stats(self, session_id: str) -> Dict:
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        state = self.states.get(session_id)
        if not state:
            return {}
        
        # å·¥å…·ä½¿ç”¨ç»Ÿè®¡
        tool_counter = Counter(state.tools_used)
        
        return {
            "session_id": session_id,
            "total_messages": len(state.messages),
            "current_step": state.current_step,
            "confidence": state.confidence,
            "tools_used_count": dict(tool_counter),
            "session_duration": (
                state.updated_at - state.created_at
            ).total_seconds(),
        }
    
    def export_state(self, session_id: str) -> str:
        """å¯¼å‡ºçŠ¶æ€ä¸º JSON"""
        state = self.states.get(session_id)
        if not state:
            return "{}"
        
        return json.dumps({
            "session_id": state.session_id,
            "messages": state.messages,
            "current_step": state.current_step,
            "confidence": state.confidence,
            "tools_used": state.tools_used,
            "metadata": state.metadata,
            "stats": dict(state.stats),
        }, indent=2, default=str)


# ä½¿ç”¨ç¤ºä¾‹
def main():
    """æ¼”ç¤ºçŠ¶æ€ç®¡ç†ç³»ç»Ÿ"""
    manager = StateManager()
    
    # åˆ›å»ºçŠ¶æ€
    state = manager.create_state(
        session_id="session_001",
        tools=["search", "calculator", "weather"]
    )
    print(f"åˆ›å»ºçŠ¶æ€: {state.session_id}")
    
    # æ·»åŠ æ¶ˆæ¯
    manager.add_message("session_001", "user", "ä½ å¥½")
    manager.add_message("session_001", "assistant", "æ‚¨å¥½ï¼")
    manager.add_message("session_001", "user", "å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ")
    
    # è®°å½•å·¥å…·ä½¿ç”¨
    manager.record_tool_use("session_001", "weather")
    manager.record_tool_use("session_001", "search")
    manager.record_tool_use("session_001", "weather")
    
    # æ›´æ–°çŠ¶æ€
    manager.update_state("session_001", {
        "current_step": "processing",
        "confidence": 0.85
    })
    
    # è·å–ç»Ÿè®¡
    stats = manager.get_stats("session_001")
    print("\nç»Ÿè®¡ä¿¡æ¯:")
    print(json.dumps(stats, indent=2))
    
    # å¯¼å‡ºçŠ¶æ€
    print("\nå¯¼å‡ºçŠ¶æ€:")
    print(manager.export_state("session_001"))


if __name__ == "__main__":
    main()
```

---

## æœ¬èŠ‚æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **å­—å…¸**ï¼šé”®å€¼å¯¹ï¼Œå¿«é€ŸæŸ¥æ‰¾
2. **get() æ–¹æ³•**ï¼šå®‰å…¨è®¿é—®ï¼Œé¿å… KeyError
3. **å­—å…¸æ¨å¯¼å¼**ï¼šç®€æ´åˆ›å»ºå­—å…¸
4. **defaultdict**ï¼šè‡ªåŠ¨åˆå§‹åŒ–é»˜è®¤å€¼
5. **Counter**ï¼šè®¡æ•°ç»Ÿè®¡

### åœ¨ AI Agent ä¸­çš„åº”ç”¨

| æ“ä½œ | åº”ç”¨åœºæ™¯ |
|------|----------|
| å­—å…¸ | Agent çŠ¶æ€ã€é…ç½®ã€API å“åº” |
| get() | å®‰å…¨è®¿é—®å¯é€‰é…ç½® |
| \*\*è§£åŒ… | åˆå¹¶é»˜è®¤é…ç½®å’Œç”¨æˆ·é…ç½® |
| defaultdict | åˆ†ç»„æ•°æ®ã€è®¡æ•° |
| Counter | ç»Ÿè®¡å·¥å…·ä½¿ç”¨é¢‘ç‡ |

---

**ä¸‹ä¸€èŠ‚ï¼š[2.3 é›†åˆä¸ TypedDict](2.3-é›†åˆä¸TypedDict.md)**
