# 8.2 å®žçŽ°æ ¸å¿ƒåŠŸèƒ½

> **ðŸŽ¯ å°ç™½ç†è§£æŒ‡å—ï¼šè¿™ä¸€èŠ‚è®²ä»€ä¹ˆï¼Ÿ**
>
> å‰é¢æ˜¯"ç”»è“å›¾"ï¼Œè¿™ä¸€èŠ‚æ˜¯**"ç›–æˆ¿å­"**â€”â€”æŠŠè®¾è®¡å˜æˆå¯è¿è¡Œçš„ä»£ç ï¼
>
> ä¸‹é¢è¿™æ®µä»£ç è™½ç„¶æœ‰ç‚¹é•¿ï¼Œä½†æ¯ä¸€éƒ¨åˆ†éƒ½å¯¹åº”ä½ å­¦è¿‡çš„çŸ¥è¯†ï¼š
>
> | ä»£ç éƒ¨åˆ† | å¯¹åº” Module | ä½œç”¨ |
> |---------|------------|------|
> | AgentState | Module 2 æ•°æ®ç»“æž„ | å®šä¹‰ Agent çš„è®°å¿† |
> | @tool | Module 1 å‡½æ•° | å®šä¹‰ Agent çš„æŠ€èƒ½ |
> | create_react_agent | Module 3 é¢å‘å¯¹è±¡ | ç»„è£… Agent |
> | SqliteSaver | Module 4 æ–‡ä»¶å¤„ç† | ä¿å­˜å¯¹è¯åŽ†å² |
> | logging | Module 5 å¼‚å¸¸å¤„ç† | è®°å½•è¿è¡Œæ—¥å¿— |
> | async/await | Module 6 å¼‚æ­¥ç¼–ç¨‹ | å¼‚æ­¥æ‰§è¡Œ |
>
> **åˆ«è¢«ä»£ç é•¿åº¦å“åˆ°ï¼Œä¸€æ­¥ä¸€æ­¥çœ‹æ³¨é‡Šå°±æ‡‚äº†ï¼**

## å®Œæ•´çš„ Agent å®žçŽ°

```python
"""
å®Œæ•´çš„ LangGraph Agent å®žçŽ°
æ•´åˆæ‰€æœ‰ Module çš„çŸ¥è¯†

ðŸŽ¯ å°ç™½å¯¼è¯»ï¼šè¿™æ®µä»£ç åšäº†ä»€ä¹ˆï¼Ÿ
1. å®šä¹‰ Agent è¦è®°ä½ä»€ä¹ˆï¼ˆStateï¼‰
2. å®šä¹‰ Agent ä¼šä»€ä¹ˆæŠ€èƒ½ï¼ˆToolsï¼‰
3. ç»„è£…æˆä¸€ä¸ªå®Œæ•´çš„ Agent
4. è¿è¡Œå¹¶å¤„ç†ç”¨æˆ·æŸ¥è¯¢
"""

from typing import TypedDict, List, Annotated
from langchain_core.messages import BaseMessage, HumanMessage
from langchain_openai import ChatOpenAI
from langgraph.graph import StateGraph, END
from langgraph.prebuilt import create_react_agent
from langgraph.checkpoint.sqlite import SqliteSaver
from langchain.tools import tool
import asyncio
import logging

# ==================== ç¬¬ 1 æ­¥ï¼šé…ç½®æ—¥å¿— ====================
# ðŸŽ¯ æ—¥å¿—å°±åƒ"è¡Œè½¦è®°å½•ä»ª"ï¼Œè®°å½•ç¨‹åºè¿è¡Œè¿‡ç¨‹ï¼Œå‡ºé—®é¢˜æ—¶æ–¹ä¾¿æŽ’æŸ¥
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


# ==================== ç¬¬ 2 æ­¥ï¼šå®šä¹‰çŠ¶æ€ (Module 2) ====================
# ðŸŽ¯ AgentState æ˜¯ Agent çš„"è®°å¿†ç»“æž„"
class AgentState(TypedDict):
    messages: List[BaseMessage]  # èŠå¤©è®°å½•
    context: dict                 # ä¸Šä¸‹æ–‡ä¿¡æ¯
    iteration: int                # è¿­ä»£æ¬¡æ•°ï¼ˆé˜²æ­¢æ­»å¾ªçŽ¯ï¼‰


# ==================== ç¬¬ 3 æ­¥ï¼šå®šä¹‰å·¥å…· (Module 1, 3) ====================
# ðŸŽ¯ @tool è£…é¥°å™¨æŠŠæ™®é€šå‡½æ•°å˜æˆ Agent å¯è°ƒç”¨çš„"æŠ€èƒ½"

@tool
def search_web(query: str) -> str:
    """æœç´¢ç½‘ç»œ

    ðŸŽ¯ è¿™æ˜¯ Agent çš„"æœç´¢æŠ€èƒ½"
    çœŸå®žé¡¹ç›®ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨ Google/Bing API
    """
    logger.info(f"æœç´¢: {query}")  # è®°å½•æ—¥å¿—
    return f"æœç´¢ç»“æžœ: {query}"


@tool
def calculator(expression: str) -> str:
    """è®¡ç®—æ•°å­¦è¡¨è¾¾å¼

    ðŸŽ¯ è¿™æ˜¯ Agent çš„"è®¡ç®—æŠ€èƒ½"
    ç”¨ try/except å¤„ç†é”™è¯¯ï¼Œé˜²æ­¢å´©æºƒ
    """
    try:
        result = eval(expression)  # è®¡ç®—è¡¨è¾¾å¼
        return f"ç»“æžœ: {result}"
    except Exception as e:
        return f"é”™è¯¯: {e}"  # å‡ºé”™è¿”å›žé”™è¯¯ä¿¡æ¯ï¼Œä¸å´©æºƒ


# ==================== ç¬¬ 4 æ­¥ï¼šç»„è£… Agent ====================
# ðŸŽ¯ æŠŠå¤§è„‘ï¼ˆLLMï¼‰+ æŠ€èƒ½ï¼ˆToolsï¼‰+ è®°å¿†ï¼ˆMemoryï¼‰ç»„è£…åœ¨ä¸€èµ·

def create_production_agent():
    """åˆ›å»ºç”Ÿäº§çº§ Agent"""

    # 1. åˆ›å»ºå¤§è„‘ â€”â€” é€‰æ‹© GPT-4ï¼Œtemperature=0 è®©å›žç­”æ›´ç¨³å®š
    llm = ChatOpenAI(model="gpt-4", temperature=0)

    # 2. å‡†å¤‡æŠ€èƒ½ â€”â€” æŠŠå·¥å…·æ”¾è¿›åˆ—è¡¨
    tools = [search_web, calculator]

    # 3. åˆ›å»ºè®°å¿† â€”â€” ç”¨ SQLite ä¿å­˜å¯¹è¯åŽ†å²
    # ðŸŽ¯ ":memory:" è¡¨ç¤ºä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç¨‹åºå…³é—­å°±æ¸…ç©º
    # çœŸå®žé¡¹ç›®ç”¨ "agent.db" è¿™æ ·çš„æ–‡ä»¶åï¼Œæ°¸ä¹…ä¿å­˜
    memory = SqliteSaver.from_conn_string(":memory:")

    # 4. ä¸€é”®ç»„è£…ï¼
    # ðŸŽ¯ create_react_agent æ˜¯ LangGraph çš„"å‚»ç“œå¼"åˆ›å»ºå‡½æ•°
    agent = create_react_agent(
        model=llm,           # å¤§è„‘
        tools=tools,         # æŠ€èƒ½
        checkpointer=memory  # è®°å¿†
    )

    return agent


# ==================== ç¬¬ 5 æ­¥ï¼šå¼‚æ­¥è¿è¡Œ (Module 6) ====================
# ðŸŽ¯ ç”¨ async/await è®© Agent å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚

async def run_agent_async(query: str):
    """å¼‚æ­¥è¿è¡Œ Agent"""
    agent = create_production_agent()

    # thread_id åŒºåˆ†ä¸åŒçš„å¯¹è¯ï¼Œå°±åƒå¾®ä¿¡é‡Œä¸åŒçš„èŠå¤©çª—å£
    config = {"configurable": {"thread_id": "session_001"}}

    # ainvoke = async invokeï¼Œå¼‚æ­¥è°ƒç”¨
    result = await agent.ainvoke(
        {"messages": [HumanMessage(content=query)]},  # ç”¨æˆ·çš„æ¶ˆæ¯
        config=config
    )

    return result


# ==================== ç¬¬ 6 æ­¥ï¼šä¸»å‡½æ•° ====================
# ðŸŽ¯ ç¨‹åºå…¥å£ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨è¿™ä¸ª Agent

def main():
    """ä¸»å‡½æ•°"""
    # å‡†å¤‡å‡ ä¸ªæµ‹è¯•é—®é¢˜
    queries = [
        "æœç´¢ Python æ•™ç¨‹",
        "è®¡ç®— 123 * 456",
    ]

    # é€ä¸ªå¤„ç†
    for query in queries:
        print(f"\næŸ¥è¯¢: {query}")
        # asyncio.run() å¯åŠ¨å¼‚æ­¥ç¨‹åº
        result = asyncio.run(run_agent_async(query))
        # å–æœ€åŽä¸€æ¡æ¶ˆæ¯ï¼ˆå°±æ˜¯ Agent çš„å›žç­”ï¼‰
        print(f"ç»“æžœ: {result['messages'][-1].content}")


# ðŸŽ¯ Python ç»å…¸å…¥å£ï¼šåªæœ‰ç›´æŽ¥è¿è¡Œè¿™ä¸ªæ–‡ä»¶æ—¶æ‰æ‰§è¡Œ main()
if __name__ == "__main__":
    main()
```

> **ðŸŽ¯ å°ç™½æ€»ç»“ï¼šè¿™æ®µä»£ç çš„æ‰§è¡Œæµç¨‹**
>
> ```
> main() å¯åŠ¨
>   â†“
> åˆ›å»º Agentï¼ˆå¤§è„‘ + æŠ€èƒ½ + è®°å¿†ï¼‰
>   â†“
> ç”¨æˆ·æé—®ï¼š"æœç´¢ Python æ•™ç¨‹"
>   â†“
> Agent æ€è€ƒï¼š"è¿™éœ€è¦ç”¨æœç´¢æŠ€èƒ½"
>   â†“
> è°ƒç”¨ search_web("Python æ•™ç¨‹")
>   â†“
> è¿”å›žç»“æžœç»™ç”¨æˆ·
> ```

---

**ä¸‹ä¸€èŠ‚ï¼š[8.3 æµ‹è¯•ä¸Žéƒ¨ç½²](8.3-æµ‹è¯•ä¸Žéƒ¨ç½².md)**
