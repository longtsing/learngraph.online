# 2.5 实战：LangGraph 状态系统

## 完整的 LangGraph Agent 状态实现

```python
"""
生产级 LangGraph 状态管理系统
整合 TypedDict + Pydantic + 数据结构
"""

from typing import TypedDict, Annotated, Sequence
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage
from langgraph.graph import StateGraph, END
from langgraph.checkpoint.sqlite import SqliteSaver
import operator

# 1. 定义状态结构
class AgentState(TypedDict):
    """Agent 状态"""
    # 消息列表 - 使用 Annotated 定义合并策略
    messages: Annotated[Sequence[BaseMessage], operator.add]
    
    # 当前步骤
    current_step: str
    
    # 迭代计数
    iteration: int
    
    # 工具使用历史
    tools_used: list[str]
    
    # 上下文信息
    context: dict

# 2. 节点函数
def agent_node(state: AgentState) -> AgentState:
    """Agent 节点：处理用户输入"""
    messages = state["messages"]
    iteration = state["iteration"]
    
    # 模拟 LLM 调用
    last_message = messages[-1]
    response = AIMessage(content=f"处理: {last_message.content}")
    
    return {
        "messages": [response],
        "iteration": iteration + 1,
        "current_step": "processing"
    }

def tool_node(state: AgentState) -> AgentState:
    """工具节点：调用外部工具"""
    return {
        "current_step": "responding",
        "tools_used": state["tools_used"] + ["search"]
    }

# 3. 路由逻辑
def should_continue(state: AgentState) -> str:
    """决定下一步"""
    if state["iteration"] >= 3:
        return "end"
    
    last_message = state["messages"][-1]
    if "搜索" in last_message.content:
        return "tools"
    
    return "end"

# 4. 构建图
def create_agent_graph():
    """创建 Agent 图"""
    workflow = StateGraph(AgentState)
    
    # 添加节点
    workflow.add_node("agent", agent_node)
    workflow.add_node("tools", tool_node)
    
    # 设置入口
    workflow.set_entry_point("agent")
    
    # 添加条件边
    workflow.add_conditional_edges(
        "agent",
        should_continue,
        {
            "tools": "tools",
            "end": END
        }
    )
    
    # 工具节点返回 agent
    workflow.add_edge("tools", "agent")
    
    # 编译
    memory = SqliteSaver.from_conn_string(":memory:")
    app = workflow.compile(checkpointer=memory)
    
    return app

# 5. 使用
def main():
    app = create_agent_graph()
    
    # 初始状态
    initial_state = {
        "messages": [HumanMessage(content="帮我搜索Python教程")],
        "current_step": "init",
        "iteration": 0,
        "tools_used": [],
        "context": {}
    }
    
    # 配置（启用持久化）
    config = {"configurable": {"thread_id": "1"}}
    
    # 运行
    result = app.invoke(initial_state, config)
    
    print("最终状态:")
    print(f"迭代次数: {result['iteration']}")
    print(f"使用工具: {result['tools_used']}")
    print(f"消息数: {len(result['messages'])}")

if __name__ == "__main__":
    main()
```

---

**下一节：[2.6 小结和复习](2.6-小结和复习.md)**
