# 7.1 ç¯å¢ƒå˜é‡ç®¡ç†

> **ğŸ¯ å°ç™½ç†è§£**ï¼šä»€ä¹ˆæ˜¯"ç¯å¢ƒå˜é‡"ï¼Ÿ
>
> æƒ³è±¡ä½ å¼€äº†ä¸€å®¶é¤å…ï¼Œæœ‰äº›ä¿¡æ¯ä¸èƒ½å†™åœ¨èœå•ä¸Šï¼š
>
> - èœå•ï¼ˆä»£ç ï¼‰ï¼šå†™"ä½¿ç”¨ API è·å–æ•°æ®"
> - ä¿é™©ç®±ï¼ˆç¯å¢ƒå˜é‡ï¼‰ï¼šå­˜æ”¾çœŸæ­£çš„ API å¯†é’¥ `sk-xxxxx`
>
> **ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æŠŠå¯†é’¥å†™åœ¨ä»£ç é‡Œï¼Ÿ**
>
> ```python
> # âŒ é”™è¯¯åšæ³•ï¼å¯†é’¥ä¼šè¢«ä¸Šä¼ åˆ° GitHub
> api_key = "sk-abc123xyz456"
>
> # âœ… æ­£ç¡®åšæ³•ï¼å¯†é’¥å­˜åœ¨ç¯å¢ƒå˜é‡é‡Œ
> api_key = os.getenv("OPENAI_API_KEY")
> ```
>
> **ç¯å¢ƒå˜é‡çš„å¥½å¤„**ï¼š
>
> | ä¼˜ç‚¹ | è§£é‡Š |
> |------|------|
> | **å®‰å…¨** | å¯†é’¥ä¸ä¼šè¢«æäº¤åˆ° Git |
> | **çµæ´»** | ä¸æ”¹ä»£ç å°±èƒ½æ¢é…ç½® |
> | **åˆ†ç¦»** | å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç”¨ä¸åŒçš„å€¼ |
>
> **ç±»æ¯”**ï¼šç¯å¢ƒå˜é‡å°±åƒå¯†ç ç®¡ç†å™¨â€”â€”ä½ çš„ç¨‹åºçŸ¥é“å»å“ªé‡Œå–å¯†é’¥ï¼Œä½†å¯†é’¥æœ¬èº«ä¸ä¼šæš´éœ²åœ¨ä»£ç é‡Œã€‚

## ç¯å¢ƒå˜é‡åŸºç¡€

> **ğŸ¯ å°ç™½ç†è§£**ï¼š`os.getenv()` æ€ä¹ˆç”¨ï¼Ÿ
>
> ```python
> os.getenv("å˜é‡å")           # è·å–å˜é‡ï¼Œæ²¡æœ‰åˆ™è¿”å› None
> os.getenv("å˜é‡å", "é»˜è®¤å€¼")  # è·å–å˜é‡ï¼Œæ²¡æœ‰åˆ™è¿”å›é»˜è®¤å€¼
> ```
>
> å°±åƒä»ä¿é™©ç®±å–ä¸œè¥¿ï¼šæœ‰å°±æ‹¿å‡ºæ¥ï¼Œæ²¡æœ‰å°±ç”¨å¤‡ç”¨æ–¹æ¡ˆã€‚

```python
import os
from pathlib import Path

# è¯»å–ç¯å¢ƒå˜é‡
api_key = os.getenv("OPENAI_API_KEY")
model = os.getenv("MODEL_NAME", "gpt-4")  # å¸¦é»˜è®¤å€¼

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå½“å‰è¿›ç¨‹ï¼‰
os.environ["DEBUG"] = "true"

# æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨
if "OPENAI_API_KEY" in os.environ:
    print("API Key å·²é…ç½®")
else:
    print("è­¦å‘Š: API Key æœªé…ç½®")
```

## .env æ–‡ä»¶ç®¡ç†

> **ğŸ¯ å°ç™½ç†è§£**ï¼šä»€ä¹ˆæ˜¯ `.env` æ–‡ä»¶ï¼Ÿ
>
> `.env` æ–‡ä»¶å°±æ˜¯ä¸€ä¸ªä¸“é—¨å­˜æ”¾ç¯å¢ƒå˜é‡çš„"é…ç½®æ–‡ä»¶"ï¼š
>
> ```
> æ–‡ä»¶å: .envï¼ˆä»¥ç‚¹å¼€å¤´ï¼Œæ˜¯éšè—æ–‡ä»¶ï¼‰
> ä½ç½®: æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•
> æ ¼å¼: å˜é‡å=å€¼ï¼ˆä¸€è¡Œä¸€ä¸ªï¼‰
> ```
>
> **ä¸ºä»€ä¹ˆç”¨ .env æ–‡ä»¶ï¼Ÿ**
>
> - ä¸ç”¨æ¯æ¬¡åœ¨ç»ˆç«¯è®¾ç½®ç¯å¢ƒå˜é‡
> - æ–¹ä¾¿å›¢é˜Ÿå…±äº«é…ç½®ï¼ˆä½†ä¸å…±äº«çœŸå®å¯†é’¥ï¼ï¼‰
> - ä½¿ç”¨ `python-dotenv` åº“è‡ªåŠ¨åŠ è½½
>
> **âš ï¸ é‡è¦è§„åˆ™**ï¼š
>
> 1. `.env` æ–‡ä»¶**ç»å¯¹ä¸èƒ½**æäº¤åˆ° Gitï¼ˆåŠ å…¥ `.gitignore`ï¼‰
> 2. åˆ›å»º `.env.example` ä½œä¸ºæ¨¡æ¿ï¼ˆåªå†™å˜é‡åï¼Œä¸å†™çœŸå®å€¼ï¼‰

### å®‰è£… python-dotenv

```bash
pip install python-dotenv
```

### åˆ›å»º .env æ–‡ä»¶

```env
# .env æ–‡ä»¶å†…å®¹
OPENAI_API_KEY=sk-xxx
ANTHROPIC_API_KEY=sk-ant-xxx
MODEL_NAME=gpt-4
TEMPERATURE=0.7
MAX_TOKENS=2000
DEBUG=false
LOG_LEVEL=INFO
DATABASE_URL=postgresql://user:pass@localhost/db
```

### åŠ è½½ç¯å¢ƒå˜é‡

```python
from dotenv import load_dotenv
import os
from pathlib import Path

# æ–¹æ³• 1: ä»å½“å‰ç›®å½•åŠ è½½
load_dotenv()

# æ–¹æ³• 2: æŒ‡å®š .env æ–‡ä»¶è·¯å¾„
env_path = Path(".") / ".env"
load_dotenv(dotenv_path=env_path)

# æ–¹æ³• 3: è¦†ç›–å·²æœ‰ç¯å¢ƒå˜é‡
load_dotenv(override=True)

# ä½¿ç”¨ç¯å¢ƒå˜é‡
api_key = os.getenv("OPENAI_API_KEY")
model = os.getenv("MODEL_NAME")
temperature = float(os.getenv("TEMPERATURE", 0.7))
debug = os.getenv("DEBUG", "false").lower() == "true"

print(f"æ¨¡å‹: {model}")
print(f"æ¸©åº¦: {temperature}")
print(f"è°ƒè¯•æ¨¡å¼: {debug}")
```

## é…ç½®ç®¡ç†ç±»

> **ğŸ¯ å°ç™½ç†è§£**ï¼šä¸ºä»€ä¹ˆè¦å†™"é…ç½®ç®¡ç†ç±»"ï¼Ÿ
>
> ç›´æ¥ç”¨ `os.getenv()` æœ‰å‡ ä¸ªé—®é¢˜ï¼š
>
> 1. æ¯æ¬¡éƒ½è¦å†™ `os.getenv("OPENAI_API_KEY")`ï¼Œå¾ˆé•¿
> 2. å®¹æ˜“æ‰“é”™å˜é‡åï¼ˆå­—ç¬¦ä¸²æ²¡æœ‰ä»£ç è¡¥å…¨ï¼‰
> 3. ç±»å‹ä¸å®‰å…¨ï¼ˆ`os.getenv()` è¿”å›çš„éƒ½æ˜¯å­—ç¬¦ä¸²ï¼‰
>
> **é…ç½®ç±»çš„å¥½å¤„**ï¼š
>
> ```python
> # æ²¡æœ‰é…ç½®ç±»
> api_key = os.getenv("OPENAI_API_KEY")  # æ¯æ¬¡éƒ½å†™è¿™ä¹ˆé•¿
> temp = float(os.getenv("TEMPERATURE", "0.7"))  # è¿˜è¦æ‰‹åŠ¨è½¬ç±»å‹
>
> # æœ‰é…ç½®ç±»
> config = Config.from_env()
> api_key = config.openai_api_key  # ä»£ç è¡¥å…¨ï¼
> temp = config.temperature        # å·²ç»æ˜¯ float ç±»å‹ï¼
> ```
>
> é…ç½®ç±»å°±åƒä¸€ä¸ª"åŠ©æ‰‹"ï¼Œå¸®ä½ æŠŠæ‰€æœ‰ç¯å¢ƒå˜é‡æ•´ç†å¥½ã€è½¬æ¢å¥½ç±»å‹ã€éªŒè¯å¥½æ ¼å¼ã€‚

```python
from typing import Optional, Dict, Any
from dataclasses import dataclass, field
from pathlib import Path
import os
from dotenv import load_dotenv

@dataclass
class Config:
    """åº”ç”¨é…ç½®ç®¡ç†"""
    
    # API é…ç½®
    openai_api_key: str
    anthropic_api_key: Optional[str] = None
    
    # æ¨¡å‹é…ç½®
    model_name: str = "gpt-4"
    temperature: float = 0.7
    max_tokens: int = 2000
    
    # åº”ç”¨é…ç½®
    debug: bool = False
    log_level: str = "INFO"
    
    # æ•°æ®åº“é…ç½®
    database_url: Optional[str] = None
    
    @classmethod
    def from_env(cls, env_file: str = ".env") -> "Config":
        """ä»ç¯å¢ƒå˜é‡åŠ è½½é…ç½®"""
        # åŠ è½½ .env æ–‡ä»¶
        if Path(env_file).exists():
            load_dotenv(env_file)
        
        # è¯»å–é…ç½®
        return cls(
            openai_api_key=os.getenv("OPENAI_API_KEY", ""),
            anthropic_api_key=os.getenv("ANTHROPIC_API_KEY"),
            model_name=os.getenv("MODEL_NAME", "gpt-4"),
            temperature=float(os.getenv("TEMPERATURE", "0.7")),
            max_tokens=int(os.getenv("MAX_TOKENS", "2000")),
            debug=os.getenv("DEBUG", "false").lower() == "true",
            log_level=os.getenv("LOG_LEVEL", "INFO"),
            database_url=os.getenv("DATABASE_URL")
        )
    
    def validate(self) -> bool:
        """éªŒè¯é…ç½®"""
        if not self.openai_api_key:
            raise ValueError("OPENAI_API_KEY æœªé…ç½®")
        
        if not self.openai_api_key.startswith("sk-"):
            raise ValueError("OPENAI_API_KEY æ ¼å¼é”™è¯¯")
        
        if self.temperature < 0 or self.temperature > 2:
            raise ValueError("temperature å¿…é¡»åœ¨ 0-2 ä¹‹é—´")
        
        return True
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰"""
        return {
            "openai_api_key": "sk-***" if self.openai_api_key else None,
            "anthropic_api_key": "sk-ant-***" if self.anthropic_api_key else None,
            "model_name": self.model_name,
            "temperature": self.temperature,
            "max_tokens": self.max_tokens,
            "debug": self.debug,
            "log_level": self.log_level,
            "database_url": "***" if self.database_url else None
        }

# ä½¿ç”¨ç¤ºä¾‹
config = Config.from_env()
config.validate()
print(config.to_dict())
```

## å¤šç¯å¢ƒé…ç½®

```python
from enum import Enum
from pathlib import Path
import os

class Environment(Enum):
    """ç¯å¢ƒç±»å‹"""
    DEVELOPMENT = "development"
    STAGING = "staging"
    PRODUCTION = "production"

class EnvironmentConfig:
    """å¤šç¯å¢ƒé…ç½®ç®¡ç†"""
    
    def __init__(self):
        self.env = self._detect_environment()
        self._load_config()
    
    def _detect_environment(self) -> Environment:
        """æ£€æµ‹å½“å‰ç¯å¢ƒ"""
        env_name = os.getenv("ENV", "development").lower()
        
        if env_name in ["prod", "production"]:
            return Environment.PRODUCTION
        elif env_name in ["stage", "staging"]:
            return Environment.STAGING
        else:
            return Environment.DEVELOPMENT
    
    def _load_config(self):
        """åŠ è½½å¯¹åº”ç¯å¢ƒçš„é…ç½®"""
        # åŠ è½½åŸºç¡€é…ç½®
        base_env = Path(".env")
        if base_env.exists():
            load_dotenv(base_env)
        
        # åŠ è½½ç¯å¢ƒç‰¹å®šé…ç½®
        env_file = Path(f".env.{self.env.value}")
        if env_file.exists():
            load_dotenv(env_file, override=True)
    
    @property
    def is_production(self) -> bool:
        return self.env == Environment.PRODUCTION
    
    @property
    def is_development(self) -> bool:
        return self.env == Environment.DEVELOPMENT
    
    def get_config(self) -> Config:
        """è·å–é…ç½®"""
        return Config.from_env()

# ä½¿ç”¨ç¤ºä¾‹
env_config = EnvironmentConfig()
print(f"å½“å‰ç¯å¢ƒ: {env_config.env.value}")
print(f"æ˜¯å¦ç”Ÿäº§ç¯å¢ƒ: {env_config.is_production}")

config = env_config.get_config()
```

## Agent é…ç½®ç³»ç»Ÿ

```python
from typing import Optional, List, Dict, Any
from dataclasses import dataclass, field
from pathlib import Path
import os
from dotenv import load_dotenv

@dataclass
class AgentConfig:
    """Agent é…ç½®"""
    
    # åŸºç¡€é…ç½®
    name: str
    description: str
    
    # LLM é…ç½®
    model: str = "gpt-4"
    temperature: float = 0.7
    max_tokens: int = 2000
    
    # å·¥å…·é…ç½®
    tools: List[str] = field(default_factory=list)
    
    # ç³»ç»Ÿæç¤ºè¯
    system_prompt: str = "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ã€‚"
    
    # API é…ç½®
    api_key: Optional[str] = None
    api_base: Optional[str] = None
    
    # é«˜çº§é…ç½®
    streaming: bool = True
    retry_attempts: int = 3
    timeout: float = 30.0
    
    @classmethod
    def from_env(cls, agent_name: str) -> "AgentConfig":
        """ä»ç¯å¢ƒå˜é‡åŠ è½½ Agent é…ç½®"""
        load_dotenv()
        
        # è¯»å–é€šç”¨é…ç½®
        prefix = f"{agent_name.upper()}_"
        
        return cls(
            name=agent_name,
            description=os.getenv(f"{prefix}DESCRIPTION", ""),
            model=os.getenv(f"{prefix}MODEL", os.getenv("MODEL_NAME", "gpt-4")),
            temperature=float(os.getenv(f"{prefix}TEMPERATURE", 
                                       os.getenv("TEMPERATURE", "0.7"))),
            max_tokens=int(os.getenv(f"{prefix}MAX_TOKENS", 
                                     os.getenv("MAX_TOKENS", "2000"))),
            tools=os.getenv(f"{prefix}TOOLS", "").split(",") if os.getenv(f"{prefix}TOOLS") else [],
            system_prompt=os.getenv(f"{prefix}SYSTEM_PROMPT", "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ã€‚"),
            api_key=os.getenv("OPENAI_API_KEY"),
            api_base=os.getenv("OPENAI_API_BASE"),
            streaming=os.getenv(f"{prefix}STREAMING", "true").lower() == "true",
            retry_attempts=int(os.getenv(f"{prefix}RETRY_ATTEMPTS", "3")),
            timeout=float(os.getenv(f"{prefix}TIMEOUT", "30.0"))
        )

# .env ç¤ºä¾‹
"""
# é€šç”¨é…ç½®
OPENAI_API_KEY=sk-xxx
MODEL_NAME=gpt-4
TEMPERATURE=0.7

# Research Agent é…ç½®
RESEARCH_DESCRIPTION=ä¸“ä¸šçš„ç ”ç©¶åŠ©æ‰‹
RESEARCH_MODEL=gpt-4
RESEARCH_TOOLS=search,calculator,wikipedia
RESEARCH_SYSTEM_PROMPT=ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç ”ç©¶åŠ©æ‰‹ï¼Œæ“…é•¿æŸ¥æ‰¾å’Œåˆ†æä¿¡æ¯ã€‚

# Writer Agent é…ç½®
WRITER_DESCRIPTION=ä¸“ä¸šçš„å†™ä½œåŠ©æ‰‹
WRITER_MODEL=gpt-3.5-turbo
WRITER_TEMPERATURE=0.9
WRITER_SYSTEM_PROMPT=ä½ æ˜¯ä¸€ä¸ªåˆ›æ„å†™ä½œåŠ©æ‰‹ï¼Œé£æ ¼ä¼˜ç¾ç®€æ´ã€‚
"""

# ä½¿ç”¨ç¤ºä¾‹
research_config = AgentConfig.from_env("research")
writer_config = AgentConfig.from_env("writer")

print(f"Research Agent: {research_config.model}, å·¥å…·: {research_config.tools}")
print(f"Writer Agent: {writer_config.model}, æ¸©åº¦: {writer_config.temperature}")
```

## å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ

> **ğŸ¯ å°ç™½ç†è§£**ï¼šä¸ºä»€ä¹ˆéœ€è¦"å¯†é’¥ç®¡ç†"ï¼Ÿ
>
> API å¯†é’¥å°±åƒä½ å®¶çš„é’¥åŒ™ï¼š
>
> - **æ³„éœ²äº†** = åˆ«äººå¯ä»¥ç”¨ä½ çš„é’±è°ƒç”¨ API
> - **æ ¼å¼é”™äº†** = ç¨‹åºä¼šæŠ¥é”™
> - **æ²¡é…ç½®** = ç¨‹åºæ— æ³•è¿è¡Œ
>
> **SecretManager èƒ½å¸®ä½ **ï¼š
>
> | åŠŸèƒ½ | ä½œç”¨ |
> |------|------|
> | `get_api_key()` | å®‰å…¨è·å–å¯†é’¥ï¼Œæ²¡æœ‰å°±æŠ¥é”™ |
> | `validate_api_key()` | æ£€æŸ¥å¯†é’¥æ ¼å¼æ˜¯å¦æ­£ç¡® |
> | `mask_secret()` | éšè—å¯†é’¥ï¼ˆæ‰“å°æ—¥å¿—æ—¶ç”¨ï¼‰|
>
> **ä¸ºä»€ä¹ˆè¦éšè—å¯†é’¥ï¼Ÿ**
>
> ```python
> # âŒ å±é™©ï¼å¯†é’¥ä¼šå‡ºç°åœ¨æ—¥å¿—é‡Œ
> print(f"ä½¿ç”¨å¯†é’¥: {api_key}")
>
> # âœ… å®‰å…¨ï¼åªæ˜¾ç¤ºå‰å‡ ä½
> print(f"ä½¿ç”¨å¯†é’¥: {mask_secret(api_key)}")  # è¾“å‡º: sk-a***
> ```

```python
import os
from pathlib import Path
from typing import Optional
import secrets

class SecretManager:
    """å¯†é’¥ç®¡ç†å™¨"""
    
    @staticmethod
    def generate_secret_key(length: int = 32) -> str:
        """ç”Ÿæˆéšæœºå¯†é’¥"""
        return secrets.token_urlsafe(length)
    
    @staticmethod
    def get_api_key(key_name: str, required: bool = True) -> Optional[str]:
        """å®‰å…¨è·å– API Key"""
        key = os.getenv(key_name)
        
        if required and not key:
            raise ValueError(f"ç¯å¢ƒå˜é‡ {key_name} æœªé…ç½®")
        
        if key and not SecretManager.validate_api_key(key):
            raise ValueError(f"API Key æ ¼å¼é”™è¯¯: {key_name}")
        
        return key
    
    @staticmethod
    def validate_api_key(key: str) -> bool:
        """éªŒè¯ API Key æ ¼å¼"""
        if not key:
            return False
        
        # OpenAI Key æ ¼å¼
        if key.startswith("sk-"):
            return len(key) > 20
        
        # Anthropic Key æ ¼å¼
        if key.startswith("sk-ant-"):
            return len(key) > 30
        
        return True
    
    @staticmethod
    def mask_secret(secret: str, visible_chars: int = 4) -> str:
        """éšè—å¯†é’¥ï¼ˆä»…æ˜¾ç¤ºå‰å‡ ä½ï¼‰"""
        if not secret:
            return "None"
        
        if len(secret) <= visible_chars:
            return "*" * len(secret)
        
        return f"{secret[:visible_chars]}***"

# ä½¿ç”¨ç¤ºä¾‹
manager = SecretManager()

# è·å– API Key
try:
    openai_key = manager.get_api_key("OPENAI_API_KEY", required=True)
    anthropic_key = manager.get_api_key("ANTHROPIC_API_KEY", required=False)
    
    print(f"OpenAI Key: {manager.mask_secret(openai_key)}")
    print(f"Anthropic Key: {manager.mask_secret(anthropic_key) if anthropic_key else 'Not configured'}")
except ValueError as e:
    print(f"é…ç½®é”™è¯¯: {e}")

# ç”Ÿæˆæ–°å¯†é’¥
new_secret = manager.generate_secret_key()
print(f"æ–°å¯†é’¥: {manager.mask_secret(new_secret)}")
```

## .gitignore æœ€ä½³å®è·µ

```gitignore
# ç¯å¢ƒå˜é‡æ–‡ä»¶
.env
.env.*
!.env.example

# Python
__pycache__/
*.py[cod]
*.so
.Python

# è™šæ‹Ÿç¯å¢ƒ
venv/
env/
ENV/

# IDE
.vscode/
.idea/
*.swp

# æ—¥å¿—
*.log
logs/

# æ•°æ®åº“
*.db
*.sqlite3

# å¯†é’¥å’Œè¯ä¹¦
*.pem
*.key
*.cert
```

## å…³é”®è¦ç‚¹

1. **æ°¸è¿œä¸è¦æäº¤ .env æ–‡ä»¶åˆ° Git**
2. **ä½¿ç”¨ .env.example ä½œä¸ºæ¨¡æ¿**
3. **éªŒè¯æ‰€æœ‰é…ç½®å€¼**
4. **åœ¨æ—¥å¿—ä¸­éšè—æ•æ„Ÿä¿¡æ¯**
5. **ä½¿ç”¨ç±»å‹å®‰å…¨çš„é…ç½®ç±»**

---

**ä¸‹ä¸€èŠ‚ï¼š[7.2 HTTP è¯·æ±‚ä¸ API è°ƒç”¨](7.2-HTTPè¯·æ±‚ä¸APIè°ƒç”¨.md)**
