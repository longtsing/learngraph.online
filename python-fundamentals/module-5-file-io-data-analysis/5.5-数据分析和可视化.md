# 5.5 数据分析和可视化

## 概述

数据分析和可视化是 Python 最强大的应用领域之一。本节介绍五个核心库：

- **NumPy**：高效数值计算
- **Pandas**：数据分析和处理
- **Matplotlib**：基础绑图库
- **Seaborn**：统计可视化
- **Plotly**：交互式图表

> **提示**：请在本地 Python 环境中运行代码。建议使用 Jupyter Notebook 以便直接查看图表输出。

---

## NumPy：数值计算基础

NumPy 是科学计算的基石，提供高性能的多维数组运算。

### 数组创建和基本操作

```python
import numpy as np

# 创建数组
arr1 = np.array([1, 2, 3, 4, 5])
arr2 = np.array([[1, 2, 3], [4, 5, 6]])

print("一维数组:", arr1)
print("二维数组:")
print(arr2)
print(f"形状: {arr2.shape}, 维度: {arr2.ndim}")

# 特殊数组
zeros = np.zeros((3, 3))
ones = np.ones((2, 4))
eye = np.eye(3)  # 单位矩阵

print("\n零矩阵:")
print(zeros)
print("\n单位矩阵:")
print(eye)

# 数值范围
range_arr = np.arange(0, 10, 2)  # [0, 2, 4, 6, 8]
linspace_arr = np.linspace(0, 1, 5)  # 等间距 5 个点

print(f"\narange: {range_arr}")
print(f"linspace: {linspace_arr}")
```

**输出**：
```
一维数组: [1 2 3 4 5]
二维数组:
[[1 2 3]
 [4 5 6]]
形状: (2, 3), 维度: 2

零矩阵:
[[0. 0. 0.]
 [0. 0. 0.]
 [0. 0. 0.]]

单位矩阵:
[[1. 0. 0.]
 [0. 1. 0.]
 [0. 0. 1.]]

arange: [0 2 4 6 8]
linspace: [0.   0.25 0.5  0.75 1.  ]
```

### 数组运算

```python
import numpy as np

# 向量化运算（比 Python 循环快 100 倍）
a = np.array([1, 2, 3, 4])
b = np.array([10, 20, 30, 40])

print("加法:", a + b)
print("乘法:", a * b)
print("平方:", a ** 2)
print("求和:", np.sum(a))
print("均值:", np.mean(a))
print("标准差:", np.std(a))

# 矩阵运算
matrix_a = np.array([[1, 2], [3, 4]])
matrix_b = np.array([[5, 6], [7, 8]])

print("\n矩阵乘法:")
print(np.dot(matrix_a, matrix_b))  # 或 matrix_a @ matrix_b

# 统计函数
data = np.random.randn(1000)  # 1000 个标准正态分布随机数
print(f"\n随机数统计:")
print(f"均值: {np.mean(data):.4f}")
print(f"标准差: {np.std(data):.4f}")
print(f"最小值: {np.min(data):.4f}")
print(f"最大值: {np.max(data):.4f}")
```

**输出**：
```
加法: [11 22 33 44]
乘法: [ 10  40  90 160]
平方: [ 1  4  9 16]
求和: 10
均值: 2.5
标准差: 1.118033988749895

矩阵乘法:
[[19 22]
 [43 50]]

随机数统计:
均值: 0.0156
标准差: 1.0023
最小值: -3.2145
最大值: 3.1876
```

---

## Pandas：数据分析利器

Pandas 提供 DataFrame 数据结构，是数据分析的标准工具。

### 创建和查看数据

```python
import pandas as pd
import numpy as np

# 从字典创建 DataFrame
data = {
    '姓名': ['张三', '李四', '王五', '赵六', '钱七'],
    '年龄': [25, 30, 35, 28, 32],
    '城市': ['北京', '上海', '广州', '深圳', '杭州'],
    '薪资': [15000, 20000, 18000, 22000, 25000]
}

df = pd.DataFrame(data)

print("DataFrame 内容:")
print(df)
print(f"\n数据形状: {df.shape}")
print(f"\n数据类型:\n{df.dtypes}")
print(f"\n统计摘要:\n{df.describe()}")
```

**输出**：
```
DataFrame 内容:
   姓名  年龄  城市    薪资
0  张三  25  北京  15000
1  李四  30  上海  20000
2  王五  35  广州  18000
3  赵六  28  深圳  22000
4  钱七  32  杭州  25000

数据形状: (5, 4)

数据类型:
姓名    object
年龄     int64
城市    object
薪资     int64
dtype: object

统计摘要:
              年龄           薪资
count   5.000000      5.000000
mean   30.000000  20000.000000
std     3.807887   3807.886553
min    25.000000  15000.000000
25%    28.000000  18000.000000
50%    30.000000  20000.000000
75%    32.000000  22000.000000
max    35.000000  25000.000000
```

### 数据筛选和操作

```python
import pandas as pd

# 创建示例数据
data = {
    '姓名': ['张三', '李四', '王五', '赵六', '钱七'],
    '年龄': [25, 30, 35, 28, 32],
    '部门': ['技术', '销售', '技术', '销售', '技术'],
    '薪资': [15000, 20000, 18000, 22000, 25000]
}
df = pd.DataFrame(data)

# 选择列
print("选择单列:")
print(df['姓名'])

print("\n选择多列:")
print(df[['姓名', '薪资']])

# 条件筛选
print("\n年龄大于 28 的员工:")
print(df[df['年龄'] > 28])

print("\n技术部门的员工:")
print(df[df['部门'] == '技术'])

# 多条件筛选
print("\n技术部门且薪资大于 17000:")
print(df[(df['部门'] == '技术') & (df['薪资'] > 17000)])

# 添加新列
df['年薪'] = df['薪资'] * 12
print("\n添加年薪列:")
print(df)

# 分组统计
print("\n按部门统计平均薪资:")
print(df.groupby('部门')['薪资'].mean())
```

### 读写文件

```python
import pandas as pd

# 创建示例数据并保存
data = {
    '产品': ['手机', '电脑', '平板', '耳机'],
    '销量': [1000, 500, 800, 1500],
    '单价': [5000, 8000, 3000, 500]
}
df = pd.DataFrame(data)

# 保存为 CSV
df.to_csv('sales_data.csv', index=False, encoding='utf-8')
print("已保存为 sales_data.csv")

# 读取 CSV
df_loaded = pd.read_csv('sales_data.csv', encoding='utf-8')
print("\n读取的数据:")
print(df_loaded)

# 保存为 JSON
df.to_json('sales_data.json', orient='records', force_ascii=False, indent=2)
print("\n已保存为 sales_data.json")
```

---

## Matplotlib：基础绑图

Matplotlib 是 Python 最基础的绑图库，功能强大且灵活。

### 折线图

```python
import matplotlib.pyplot as plt
import numpy as np

# 设置中文字体（解决中文乱码）
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# 数据
months = ['1月', '2月', '3月', '4月', '5月', '6月']
sales_a = [120, 135, 150, 145, 160, 180]
sales_b = [100, 115, 125, 140, 135, 155]

# 创建图形
plt.figure(figsize=(10, 6))
plt.plot(months, sales_a, marker='o', linewidth=2, label='产品A')
plt.plot(months, sales_b, marker='s', linewidth=2, label='产品B')

plt.title('2024年上半年销售趋势', fontsize=16)
plt.xlabel('月份', fontsize=12)
plt.ylabel('销量（万元）', fontsize=12)
plt.legend()
plt.grid(True, linestyle='--', alpha=0.7)

plt.tight_layout()
plt.savefig('line_chart.png', dpi=150)
plt.show()

print("折线图已保存为 line_chart.png")
```

**输出图表**：显示两条折线分别代表产品A和产品B的销售趋势。

### 柱状图

```python
import matplotlib.pyplot as plt
import numpy as np

# 设置中文字体
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# 数据
categories = ['北京', '上海', '广州', '深圳', '杭州']
values_2023 = [85, 92, 78, 88, 70]
values_2024 = [95, 98, 85, 95, 82]

x = np.arange(len(categories))
width = 0.35

# 创建图形
fig, ax = plt.subplots(figsize=(10, 6))
bars1 = ax.bar(x - width/2, values_2023, width, label='2023年', color='steelblue')
bars2 = ax.bar(x + width/2, values_2024, width, label='2024年', color='coral')

ax.set_title('各城市销售对比', fontsize=16)
ax.set_xlabel('城市', fontsize=12)
ax.set_ylabel('销售额（亿元）', fontsize=12)
ax.set_xticks(x)
ax.set_xticklabels(categories)
ax.legend()

# 添加数值标签
for bar in bars1:
    height = bar.get_height()
    ax.annotate(f'{height}',
                xy=(bar.get_x() + bar.get_width() / 2, height),
                xytext=(0, 3),
                textcoords="offset points",
                ha='center', va='bottom', fontsize=9)

for bar in bars2:
    height = bar.get_height()
    ax.annotate(f'{height}',
                xy=(bar.get_x() + bar.get_width() / 2, height),
                xytext=(0, 3),
                textcoords="offset points",
                ha='center', va='bottom', fontsize=9)

plt.tight_layout()
plt.savefig('bar_chart.png', dpi=150)
plt.show()

print("柱状图已保存为 bar_chart.png")
```

### 饼图

```python
import matplotlib.pyplot as plt

# 设置中文字体
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# 数据
labels = ['技术部', '销售部', '市场部', '人事部', '财务部']
sizes = [35, 25, 20, 12, 8]
colors = ['#ff9999', '#66b3ff', '#99ff99', '#ffcc99', '#ff99cc']
explode = (0.05, 0, 0, 0, 0)  # 突出显示第一块

# 创建图形
fig, ax = plt.subplots(figsize=(8, 8))
wedges, texts, autotexts = ax.pie(
    sizes,
    explode=explode,
    labels=labels,
    colors=colors,
    autopct='%1.1f%%',
    shadow=True,
    startangle=90
)

ax.set_title('公司各部门人员占比', fontsize=16)
plt.setp(autotexts, size=11, weight='bold')

plt.tight_layout()
plt.savefig('pie_chart.png', dpi=150)
plt.show()

print("饼图已保存为 pie_chart.png")
```

### 散点图

```python
import matplotlib
# matplotlib.use('Agg') # 如果在无图形界面的环境运行，请取消注释
import matplotlib.pyplot as plt
import numpy as np

# 设置中文字体
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# 生成模拟数据
np.random.seed(42)
n = 100
x = np.random.randn(n) * 10 + 50  # 工作经验（月）
y = x * 200 + np.random.randn(n) * 2000 + 5000  # 薪资

# 创建图形
plt.figure(figsize=(10, 6))
scatter = plt.scatter(x, y, c=y, cmap='viridis', alpha=0.7, s=60)
plt.colorbar(scatter, label='薪资水平')

# 添加趋势线
z = np.polyfit(x, y, 1)
p = np.poly1d(z)
plt.plot(x, p(x), "r--", linewidth=2, label=f'趋势线: y={z[0]:.1f}x+{z[1]:.1f}')

plt.title('工作经验与薪资关系', fontsize=16)
plt.xlabel('工作经验（月）', fontsize=12)
plt.ylabel('月薪（元）', fontsize=12)
plt.legend()
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('scatter_chart.png', dpi=150)
plt.show()

print("散点图已保存为 scatter_chart.png")
```

### 子图布局

```python
import matplotlib.pyplot as plt
import numpy as np

# 设置中文字体
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# 准备数据
np.random.seed(42)
x = np.linspace(0, 10, 100)

# 创建 2x2 子图
fig, axes = plt.subplots(2, 2, figsize=(12, 10))

# 子图1: 正弦波
axes[0, 0].plot(x, np.sin(x), 'b-', linewidth=2)
axes[0, 0].set_title('正弦函数')
axes[0, 0].set_xlabel('x')
axes[0, 0].set_ylabel('sin(x)')
axes[0, 0].grid(True, alpha=0.3)

# 子图2: 直方图
data = np.random.randn(1000)
axes[0, 1].hist(data, bins=30, color='green', alpha=0.7, edgecolor='black')
axes[0, 1].set_title('正态分布直方图')
axes[0, 1].set_xlabel('值')
axes[0, 1].set_ylabel('频次')

# 子图3: 柱状图
categories = ['A', 'B', 'C', 'D', 'E']
values = [23, 45, 56, 78, 32]
axes[1, 0].bar(categories, values, color='coral')
axes[1, 0].set_title('分类数据')
axes[1, 0].set_xlabel('类别')
axes[1, 0].set_ylabel('数值')

# 子图4: 箱线图
data_box = [np.random.randn(100) + i for i in range(4)]
axes[1, 1].boxplot(data_box, labels=['组1', '组2', '组3', '组4'])
axes[1, 1].set_title('箱线图对比')
axes[1, 1].set_ylabel('数值')

plt.suptitle('Matplotlib 子图示例', fontsize=16, y=1.02)
plt.tight_layout()
plt.savefig('subplot_chart.png', dpi=150)
plt.show()

print("子图已保存为 subplot_chart.png")
```

---

## Seaborn：统计可视化

Seaborn 基于 Matplotlib，提供更美观的统计图表和更简洁的 API。

### 分布图

```python
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

# 设置中文字体和风格
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False
sns.set_style("whitegrid")

# 生成模拟数据
np.random.seed(42)
data = pd.DataFrame({
    '年龄': np.random.normal(35, 10, 500).astype(int),
    '收入': np.random.normal(50000, 15000, 500),
    '性别': np.random.choice(['男', '女'], 500)
})

# 创建 1x2 子图
fig, axes = plt.subplots(1, 2, figsize=(14, 5))

# 直方图 + 核密度估计
sns.histplot(data=data, x='年龄', kde=True, ax=axes[0], color='steelblue')
axes[0].set_title('年龄分布', fontsize=14)

# 分组直方图
sns.histplot(data=data, x='收入', hue='性别', kde=True, ax=axes[1])
axes[1].set_title('收入分布（按性别）', fontsize=14)

plt.tight_layout()
plt.savefig('seaborn_dist.png', dpi=150)
plt.show()

print("分布图已保存为 seaborn_dist.png")
```

### 关系图

```python
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

# 设置
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False
sns.set_style("whitegrid")

# 生成模拟数据
np.random.seed(42)
n = 200
data = pd.DataFrame({
    '广告投入': np.random.uniform(10, 100, n),
    '销售额': None,
    '地区': np.random.choice(['华东', '华南', '华北', '西部'], n)
})
data['销售额'] = data['广告投入'] * 2.5 + np.random.normal(0, 20, n) + 50

# 创建关系图
fig, axes = plt.subplots(1, 2, figsize=(14, 5))

# 散点图 + 回归线
sns.regplot(data=data, x='广告投入', y='销售额', ax=axes[0],
            scatter_kws={'alpha': 0.5}, line_kws={'color': 'red'})
axes[0].set_title('广告投入 vs 销售额（带回归线）', fontsize=14)

# 按类别着色的散点图
sns.scatterplot(data=data, x='广告投入', y='销售额', hue='地区',
                style='地区', s=80, ax=axes[1])
axes[1].set_title('广告投入 vs 销售额（按地区）', fontsize=14)

plt.tight_layout()
plt.savefig('seaborn_relation.png', dpi=150)
plt.show()

print("关系图已保存为 seaborn_relation.png")
```

### 分类图

```python
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

# 设置
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False
sns.set_style("whitegrid")

# 生成模拟员工数据
np.random.seed(42)
data = pd.DataFrame({
    '部门': np.repeat(['技术', '销售', '市场', '人事'], 50),
    '薪资': np.concatenate([
        np.random.normal(18000, 3000, 50),
        np.random.normal(15000, 4000, 50),
        np.random.normal(14000, 2500, 50),
        np.random.normal(12000, 2000, 50)
    ]),
    '工作年限': np.random.randint(1, 10, 200)
})

# 创建 2x2 子图
fig, axes = plt.subplots(2, 2, figsize=(14, 12))

# 箱线图
sns.boxplot(data=data, x='部门', y='薪资', ax=axes[0, 0], palette='Set2')
axes[0, 0].set_title('各部门薪资分布（箱线图）', fontsize=14)

# 小提琴图
sns.violinplot(data=data, x='部门', y='薪资', ax=axes[0, 1], palette='Set3')
axes[0, 1].set_title('各部门薪资分布（小提琴图）', fontsize=14)

# 带散点的箱线图
sns.boxplot(data=data, x='部门', y='薪资', ax=axes[1, 0], palette='pastel')
sns.stripplot(data=data, x='部门', y='薪资', ax=axes[1, 0],
              color='black', alpha=0.3, size=3)
axes[1, 0].set_title('薪资分布（带数据点）', fontsize=14)

# 条形图（显示均值和置信区间）
sns.barplot(data=data, x='部门', y='薪资', ax=axes[1, 1],
            palette='coolwarm', errorbar='ci')
axes[1, 1].set_title('各部门平均薪资', fontsize=14)

plt.tight_layout()
plt.savefig('seaborn_category.png', dpi=150)
plt.show()

print("分类图已保存为 seaborn_category.png")
```

### 热力图

```python
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

# 设置
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# 创建相关矩阵数据
np.random.seed(42)
n = 200
data = pd.DataFrame({
    '年龄': np.random.randint(22, 60, n),
    '工作年限': np.random.randint(0, 30, n),
    '学历等级': np.random.randint(1, 5, n),
    '绩效评分': np.random.uniform(60, 100, n),
    '薪资': np.random.normal(15000, 5000, n)
})

# 计算相关系数
correlation = data.corr()

# 创建热力图
plt.figure(figsize=(10, 8))
sns.heatmap(correlation,
            annot=True,  # 显示数值
            fmt='.2f',   # 保留两位小数
            cmap='coolwarm',  # 颜色方案
            center=0,    # 颜色中心点
            square=True, # 正方形单元格
            linewidths=0.5)

plt.title('变量相关性热力图', fontsize=16)
plt.tight_layout()
plt.savefig('seaborn_heatmap.png', dpi=150)
plt.show()

print("热力图已保存为 seaborn_heatmap.png")
```

### 成对关系图

```python
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

# 设置
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# 创建数据
np.random.seed(42)
n = 150
species = np.repeat(['A类', 'B类', 'C类'], 50)
data = pd.DataFrame({
    '特征1': np.concatenate([
        np.random.normal(5, 1, 50),
        np.random.normal(7, 1.2, 50),
        np.random.normal(6, 0.8, 50)
    ]),
    '特征2': np.concatenate([
        np.random.normal(3, 0.5, 50),
        np.random.normal(4, 0.8, 50),
        np.random.normal(5, 0.6, 50)
    ]),
    '特征3': np.concatenate([
        np.random.normal(1.5, 0.3, 50),
        np.random.normal(4, 0.5, 50),
        np.random.normal(5.5, 0.4, 50)
    ]),
    '类别': species
})

# 创建成对关系图
pairplot = sns.pairplot(data, hue='类别', palette='husl',
                        diag_kind='kde', plot_kws={'alpha': 0.6})
pairplot.fig.suptitle('多变量成对关系图', y=1.02, fontsize=16)

plt.savefig('seaborn_pairplot.png', dpi=150)
plt.show()

print("成对关系图已保存为 seaborn_pairplot.png")
```

---

## Plotly：交互式可视化

Plotly 创建可交互的动态图表，支持缩放、悬停提示等功能。

### 基础折线图

```python
import plotly.express as px
import pandas as pd
import numpy as np

# 准备数据
np.random.seed(42)
months = pd.date_range('2024-01-01', periods=12, freq='M')
data = pd.DataFrame({
    '日期': months,
    '销售额': np.cumsum(np.random.randint(80, 150, 12)) + 1000,
    '利润': np.cumsum(np.random.randint(20, 50, 12)) + 200
})

# 创建折线图
fig = px.line(data, x='日期', y=['销售额', '利润'],
              title='2024年月度销售趋势',
              labels={'value': '金额（万元）', 'variable': '指标'})

fig.update_layout(
    hovermode='x unified',
    legend=dict(orientation='h', yanchor='bottom', y=1.02)
)

# 保存为 HTML（可交互）
fig.write_html('plotly_line.html')
# 也可以保存为静态图片
# fig.write_image('plotly_line.png')
fig.show()

print("交互式折线图已保存为 plotly_line.html")
```

### 交互式散点图

```python
import plotly.express as px
import pandas as pd
import numpy as np

# 生成数据
np.random.seed(42)
n = 100
data = pd.DataFrame({
    '广告支出': np.random.uniform(10, 100, n),
    '销售收入': None,
    '产品类别': np.random.choice(['电子产品', '服装', '食品', '家居'], n),
    '客户数': np.random.randint(100, 1000, n)
})
data['销售收入'] = data['广告支出'] * 3 + np.random.normal(0, 15, n) + 50

# 创建散点图
fig = px.scatter(
    data,
    x='广告支出',
    y='销售收入',
    color='产品类别',
    size='客户数',
    hover_data=['客户数'],
    title='广告支出与销售收入关系',
    labels={'广告支出': '广告支出（万元）', '销售收入': '销售收入（万元）'}
)

fig.update_layout(
    legend=dict(orientation='h', yanchor='bottom', y=1.02)
)

fig.write_html('plotly_scatter.html')
fig.show()

print("交互式散点图已保存为 plotly_scatter.html")
```

### 交互式柱状图

```python
import plotly.express as px
import pandas as pd
import numpy as np

# 准备数据
data = pd.DataFrame({
    '季度': ['Q1', 'Q2', 'Q3', 'Q4'] * 3,
    '地区': ['华东'] * 4 + ['华南'] * 4 + ['华北'] * 4,
    '销售额': [120, 135, 128, 145, 98, 112, 105, 125, 85, 95, 92, 108]
})

# 创建分组柱状图
fig = px.bar(
    data,
    x='季度',
    y='销售额',
    color='地区',
    barmode='group',
    title='各地区季度销售对比',
    labels={'销售额': '销售额（万元）'},
    text='销售额'
)

fig.update_traces(textposition='outside')
fig.update_layout(uniformtext_minsize=8, uniformtext_mode='hide')

fig.write_html('plotly_bar.html')
fig.show()

print("交互式柱状图已保存为 plotly_bar.html")
```

### 饼图和环形图

```python
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import pandas as pd

# 准备数据
data = pd.DataFrame({
    '类别': ['技术', '销售', '市场', '运营', '人事'],
    '占比': [35, 25, 18, 15, 7]
})

# 创建子图：饼图和环形图
fig = make_subplots(rows=1, cols=2,
                    specs=[[{'type': 'pie'}, {'type': 'pie'}]],
                    subplot_titles=['饼图', '环形图'])

# 饼图
fig.add_trace(
    go.Pie(labels=data['类别'], values=data['占比'], name='饼图'),
    row=1, col=1
)

# 环形图
fig.add_trace(
    go.Pie(labels=data['类别'], values=data['占比'], hole=0.4, name='环形图'),
    row=1, col=2
)

fig.update_layout(title_text='部门人员分布', showlegend=True)

fig.write_html('plotly_pie.html')
fig.show()

print("饼图已保存为 plotly_pie.html")
```

### 热力图

```python
import plotly.express as px
import pandas as pd
import numpy as np

# 生成销售数据矩阵
np.random.seed(42)
products = ['产品A', '产品B', '产品C', '产品D', '产品E']
months = ['1月', '2月', '3月', '4月', '5月', '6月']

sales_matrix = np.random.randint(50, 200, (len(products), len(months)))

# 创建 DataFrame
data = pd.DataFrame(sales_matrix, index=products, columns=months)

# 创建热力图
fig = px.imshow(
    data,
    labels=dict(x='月份', y='产品', color='销量'),
    title='产品月度销量热力图',
    color_continuous_scale='RdYlGn',
    text_auto=True
)

fig.update_layout(
    xaxis_title='月份',
    yaxis_title='产品'
)

fig.write_html('plotly_heatmap.html')
fig.show()

print("热力图已保存为 plotly_heatmap.html")
```

### 3D 散点图

```python
import plotly.express as px
import pandas as pd
import numpy as np

# 生成 3D 数据
np.random.seed(42)
n = 200
data = pd.DataFrame({
    'X': np.random.randn(n),
    'Y': np.random.randn(n),
    'Z': np.random.randn(n),
    '类别': np.random.choice(['A', 'B', 'C'], n)
})

# 创建 3D 散点图
fig = px.scatter_3d(
    data,
    x='X', y='Y', z='Z',
    color='类别',
    title='3D 数据分布',
    opacity=0.7
)

fig.update_layout(
    scene=dict(
        xaxis_title='X 轴',
        yaxis_title='Y 轴',
        zaxis_title='Z 轴'
    )
)

fig.write_html('plotly_3d.html')
fig.show()

print("3D 散点图已保存为 plotly_3d.html")
```

---

## 综合案例：销售数据分析报告

以下是一个完整的数据分析和可视化案例：

```python
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# 设置中文和风格
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False
sns.set_style("whitegrid")

# 1. 生成模拟销售数据
np.random.seed(42)
n = 500

data = pd.DataFrame({
    '订单ID': range(1, n + 1),
    '日期': pd.date_range('2024-01-01', periods=n, freq='D')[:n],
    '产品类别': np.random.choice(['电子产品', '服装', '食品', '家居用品'], n),
    '销售渠道': np.random.choice(['线上', '线下'], n, p=[0.6, 0.4]),
    '销售额': np.random.exponential(500, n) + 100,
    '数量': np.random.randint(1, 10, n),
    '客户评分': np.random.uniform(3.0, 5.0, n)
})

# 添加月份列
data['月份'] = data['日期'].dt.to_period('M').astype(str)

print("数据预览:")
print(data.head(10))
print(f"\n数据集大小: {data.shape}")

# 2. 数据统计分析
print("\n" + "=" * 50)
print("数据统计分析")
print("=" * 50)

print("\n基础统计:")
print(data.describe())

print("\n按产品类别统计:")
category_stats = data.groupby('产品类别').agg({
    '销售额': ['sum', 'mean', 'count'],
    '客户评分': 'mean'
}).round(2)
print(category_stats)

print("\n按销售渠道统计:")
channel_stats = data.groupby('销售渠道').agg({
    '销售额': ['sum', 'mean'],
    '数量': 'sum'
}).round(2)
print(channel_stats)

# 3. 可视化分析
fig, axes = plt.subplots(2, 3, figsize=(18, 12))

# 图1: 月度销售趋势
monthly_sales = data.groupby('月份')['销售额'].sum().reset_index()
axes[0, 0].plot(monthly_sales['月份'], monthly_sales['销售额'],
                marker='o', linewidth=2, color='steelblue')
axes[0, 0].set_title('月度销售趋势', fontsize=14)
axes[0, 0].set_xlabel('月份')
axes[0, 0].set_ylabel('销售额（元）')
axes[0, 0].tick_params(axis='x', rotation=45)

# 图2: 产品类别销售占比
category_sales = data.groupby('产品类别')['销售额'].sum()
colors = ['#ff9999', '#66b3ff', '#99ff99', '#ffcc99']
axes[0, 1].pie(category_sales, labels=category_sales.index, autopct='%1.1f%%',
               colors=colors, startangle=90)
axes[0, 1].set_title('产品类别销售占比', fontsize=14)

# 图3: 销售渠道对比
channel_sales = data.groupby('销售渠道')['销售额'].sum()
axes[0, 2].bar(channel_sales.index, channel_sales.values,
               color=['coral', 'steelblue'])
axes[0, 2].set_title('销售渠道对比', fontsize=14)
axes[0, 2].set_ylabel('销售额（元）')
for i, v in enumerate(channel_sales.values):
    axes[0, 2].text(i, v + 1000, f'{v:,.0f}', ha='center')

# 图4: 销售额分布
sns.histplot(data=data, x='销售额', kde=True, ax=axes[1, 0], color='steelblue')
axes[1, 0].set_title('销售额分布', fontsize=14)
axes[1, 0].set_xlabel('销售额（元）')

# 图5: 各类别客户评分箱线图
sns.boxplot(data=data, x='产品类别', y='客户评分', ax=axes[1, 1], palette='Set2')
axes[1, 1].set_title('各类别客户评分分布', fontsize=14)
axes[1, 1].tick_params(axis='x', rotation=15)

# 图6: 销售额与数量关系
sns.scatterplot(data=data, x='数量', y='销售额', hue='销售渠道',
                ax=axes[1, 2], alpha=0.6)
axes[1, 2].set_title('销售额与购买数量关系', fontsize=14)
axes[1, 2].set_xlabel('购买数量')
axes[1, 2].set_ylabel('销售额（元）')

plt.suptitle('销售数据分析报告', fontsize=18, y=1.02)
plt.tight_layout()
plt.savefig('sales_analysis_report.png', dpi=150, bbox_inches='tight')
plt.show()

print("\n分析报告已保存为 sales_analysis_report.png")
```

---

## 安装指南

```bash
# 使用 pip 安装
pip install numpy pandas matplotlib seaborn plotly

# 使用 conda 安装
conda install numpy pandas matplotlib seaborn plotly

# Jupyter Notebook 中显示 Plotly 图表
pip install nbformat
```

---

## 小结

本节介绍了 Python 数据分析和可视化的五大核心库：

| 库 | 用途 | 特点 |
|---|---|---|
| **NumPy** | 数值计算 | 高效数组运算，科学计算基础 |
| **Pandas** | 数据分析 | DataFrame 结构，数据处理利器 |
| **Matplotlib** | 基础绑图 | 功能全面，高度可定制 |
| **Seaborn** | 统计可视化 | 美观简洁，统计图表 |
| **Plotly** | 交互式图表 | 动态交互，支持 Web |

**最佳实践**：
- 数据处理首选 Pandas + NumPy
- 快速探索用 Seaborn
- 精细控制用 Matplotlib
- 交互式展示用 Plotly

---

**下一节：[5.6 小结和复习](5.6-小结和复习.md)**
