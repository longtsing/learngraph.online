# 8.2 实现核心功能

## 完整的 Agent 实现

```python
"""
完整的 LangGraph Agent 实现
整合所有 Module 的知识
"""

from typing import TypedDict, List, Annotated
from langchain_core.messages import BaseMessage, HumanMessage
from langchain_openai import ChatOpenAI
from langgraph.graph import StateGraph, END
from langgraph.prebuilt import create_react_agent
from langgraph.checkpoint.sqlite import SqliteSaver
from langchain.tools import tool
import asyncio
import logging

# 配置日志
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


# 1. 状态定义 (Module 2)
class AgentState(TypedDict):
    messages: List[BaseMessage]
    context: dict
    iteration: int


# 2. 自定义 Tools (Module 1, 3)
@tool
def search_web(query: str) -> str:
    """搜索网络"""
    logger.info(f"搜索: {query}")
    return f"搜索结果: {query}"


@tool
def calculator(expression: str) -> str:
    """计算数学表达式"""
    try:
        result = eval(expression)
        return f"结果: {result}"
    except Exception as e:
        return f"错误: {e}"


# 3. Agent 创建 (所有 Modules 综合)
def create_production_agent():
    """创建生产级 Agent"""
    
    # LLM
    llm = ChatOpenAI(model="gpt-4", temperature=0)
    
    # Tools
    tools = [search_web, calculator]
    
    # 持久化 (Module 4)
    memory = SqliteSaver.from_conn_string(":memory:")
    
    # 创建 Agent
    agent = create_react_agent(
        model=llm,
        tools=tools,
        checkpointer=memory
    )
    
    return agent


# 4. 异步执行 (Module 6)
async def run_agent_async(query: str):
    """异步运行 Agent"""
    agent = create_production_agent()
    
    config = {"configurable": {"thread_id": "session_001"}}
    
    result = await agent.ainvoke(
        {"messages": [HumanMessage(content=query)]},
        config=config
    )
    
    return result


# 5. 主函数
def main():
    """主函数"""
    queries = [
        "搜索 Python 教程",
        "计算 123 * 456",
    ]
    
    for query in queries:
        print(f"\n查询: {query}")
        result = asyncio.run(run_agent_async(query))
        print(f"结果: {result['messages'][-1].content}")


if __name__ == "__main__":
    main()
```

---

**下一节：[8.3 测试与部署](8.3-测试与部署.md)**
