# 6.2 Connecting to a LangGraph Platform Deployment - è¯¦ç»†è§£è¯»

## ä¸€ã€æ¦‚è¿°

### 1.1 æœ¬èŠ‚ç®€ä»‹

åœ¨ 6.1 èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¼šäº†å¦‚ä½•åˆ›å»º LangGraph éƒ¨ç½²ã€‚ç°åœ¨åœ¨ 6.2 èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•**è¿æ¥å’Œä½¿ç”¨**è¿™ä¸ªéƒ¨ç½²ã€‚è¿™æ˜¯ä»å¼€å‘è€…è§†è§’è½¬å‘ç”¨æˆ·è§†è§’çš„é‡è¦ä¸€æ­¥ã€‚

**æ ¸å¿ƒé—®é¢˜**ï¼š
- å¦‚ä½•è¿æ¥åˆ°éƒ¨ç½²çš„æœåŠ¡ï¼Ÿ
- å¦‚ä½•æ‰§è¡Œå›¾çš„è¿è¡Œï¼Ÿ
- å¦‚ä½•ç®¡ç†å¤šè½®å¯¹è¯ï¼Ÿ
- å¦‚ä½•æ“ä½œé•¿æœŸè®°å¿†ï¼Ÿ

### 1.2 éƒ¨ç½²åå¯ä»¥è®¿é—®ä»€ä¹ˆï¼Ÿ

ä¸€æ—¦éƒ¨ç½²æˆåŠŸï¼Œä½ å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼è®¿é—®ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         LangGraph Platform éƒ¨ç½²                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  1. HTTP API                                    â”‚
â”‚     http://localhost:8123                       â”‚
â”‚     â†’ åŸå§‹ REST API ç«¯ç‚¹                         â”‚
â”‚                                                  â”‚
â”‚  2. API æ–‡æ¡£ (Swagger UI)                        â”‚
â”‚     http://localhost:8123/docs                  â”‚
â”‚     â†’ äº¤äº’å¼ API æµ‹è¯•ç•Œé¢                         â”‚
â”‚                                                  â”‚
â”‚  3. LangGraph Studio                            â”‚
â”‚     https://smith.langchain.com/studio/         â”‚
â”‚     â†’ å¯è§†åŒ–è°ƒè¯•å’Œç›‘æ§                            â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 API ç«¯ç‚¹çš„ä¸‰å¤§ç±»åˆ«

LangGraph Server æä¾›çš„ API å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»ï¼š

```
API ç«¯ç‚¹åˆ†ç±»
â”œâ”€â”€ Runsï¼ˆè¿è¡Œï¼‰
â”‚   â””â”€â”€ åŸå­åŒ–çš„å›¾æ‰§è¡Œ
â”‚       - å•æ¬¡æ‰§è¡Œ
â”‚       - å¯ä»¥åå°è¿è¡Œ
â”‚       - å¯ä»¥æµå¼ä¼ è¾“
â”‚
â”œâ”€â”€ Threadsï¼ˆçº¿ç¨‹ï¼‰
â”‚   â””â”€â”€ å¤šè½®äº¤äº’
â”‚       - å¯¹è¯å†å²
â”‚       - çŠ¶æ€ç®¡ç†
â”‚       - Human in the loop
â”‚
â””â”€â”€ Storeï¼ˆå­˜å‚¨ï¼‰
    â””â”€â”€ é•¿æœŸè®°å¿†
        - è·¨çº¿ç¨‹æ•°æ®
        - ç”¨æˆ·è®°å¿†
        - æŒä¹…åŒ–å­˜å‚¨
```

### 1.4 å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œä½ å°†æŒæ¡ï¼š

1. **è¿æ¥åˆ°éƒ¨ç½²**
   - ä½¿ç”¨ LangGraph SDK
   - ä½¿ç”¨ Remote Graph

2. **Runsï¼ˆè¿è¡Œï¼‰**
   - åå°è¿è¡Œï¼ˆfire and forgetï¼‰
   - é˜»å¡è¿è¡Œï¼ˆblockingï¼‰
   - æµå¼è¿è¡Œï¼ˆstreamingï¼‰

3. **Threadsï¼ˆçº¿ç¨‹ï¼‰**
   - æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€
   - å¤åˆ¶çº¿ç¨‹
   - Human in the loop
   - çŠ¶æ€ç¼–è¾‘å’Œæ—¶é—´æ—…è¡Œ

4. **Store API**
   - æœç´¢è®°å¿†é¡¹
   - æ·»åŠ è®°å¿†é¡¹
   - åˆ é™¤è®°å¿†é¡¹

### 1.5 ä»å¼€å‘åˆ°ç”Ÿäº§çš„è½¬å˜

**å¼€å‘ç¯å¢ƒ**ï¼š
```python
# ç›´æ¥è°ƒç”¨å›¾
result = graph.invoke({"messages": [HumanMessage("Hello")]})
```

**ç”Ÿäº§ç¯å¢ƒ**ï¼š
```python
# é€šè¿‡ HTTP API è°ƒç”¨
run = await client.runs.create(
    thread_id,
    "task_maistro",
    input={"messages": [HumanMessage("Hello")]}
)
```

---

## äºŒã€è¿æ¥åˆ°éƒ¨ç½²

### 2.1 éƒ¨ç½²å¯åŠ¨ç¡®è®¤

åœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®ä¿ä½ çš„éƒ¨ç½²æ­£åœ¨è¿è¡Œï¼š

```bash
# ç¡®è®¤ docker-compose æ­£åœ¨è¿è¡Œ
$ cd module-6/deployment
$ docker compose ps

# åº”è¯¥çœ‹åˆ°ä¸‰ä¸ªæœåŠ¡éƒ½åœ¨è¿è¡Œ
NAME                              STATUS
deployment-langgraph-api-1        Up
deployment-langgraph-postgres-1   Up
deployment-langgraph-redis-1      Up
```

**æµ‹è¯•è¿æ¥**ï¼š
```bash
# æµ‹è¯• API å¥åº·çŠ¶æ€
$ curl http://localhost:8123/health
{"status": "ok"}
```

### 2.2 æ–¹æ³•ä¸€ï¼šä½¿ç”¨ LangGraph SDK

**LangGraph SDK** æ˜¯æ¨èçš„è¿æ¥æ–¹å¼ï¼Œæä¾›äº† Python å’Œ JavaScript ä¸¤ä¸ªç‰ˆæœ¬ã€‚

#### 2.2.1 å®‰è£… SDK

```python
%%capture --no-stderr
%pip install -U langgraph_sdk
```

**å‘½ä»¤è§£æ**ï¼š
- `%%capture --no-stderr`ï¼šJupyter é­”æ³•å‘½ä»¤ï¼Œæ•è·è¾“å‡ºä½†æ˜¾ç¤ºé”™è¯¯
- `-U`ï¼šå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
- `langgraph_sdk`ï¼šSDK åŒ…åï¼ˆæ³¨æ„æ˜¯ä¸‹åˆ’çº¿ï¼‰

#### 2.2.2 åˆ›å»ºå®¢æˆ·ç«¯

```python
from langgraph_sdk import get_client

# è¿æ¥åˆ°éƒ¨ç½²
url_for_cli_deployment = "http://localhost:8123"
client = get_client(url=url_for_cli_deployment)
```

**ä»£ç è§£æ**ï¼š
- `get_client()`ï¼šåˆ›å»º SDK å®¢æˆ·ç«¯
- `url`ï¼šéƒ¨ç½²çš„ URLï¼ˆå¯ä»¥æ˜¯æœ¬åœ°æˆ–è¿œç¨‹ï¼‰

**å®¢æˆ·ç«¯å¯¹è±¡æä¾›çš„åŠŸèƒ½**ï¼š
```python
client.runs       # è¿è¡Œç®¡ç†
client.threads    # çº¿ç¨‹ç®¡ç†
client.store      # å­˜å‚¨ç®¡ç†
client.assistants # åŠ©æ‰‹ç®¡ç†ï¼ˆ6.4 èŠ‚ï¼‰
```

### 2.3 æ–¹æ³•äºŒï¼šä½¿ç”¨ Remote Graph

**Remote Graph** å…è®¸ä½ åƒä½¿ç”¨æœ¬åœ°å›¾ä¸€æ ·ä½¿ç”¨è¿œç¨‹éƒ¨ç½²çš„å›¾ã€‚

#### 2.3.1 å®‰è£…ä¾èµ–

```python
%%capture --no-stderr
%pip install -U langchain_openai langgraph langchain_core
```

#### 2.3.2 åˆ›å»º Remote Graph

```python
from langgraph.pregel.remote import RemoteGraph
from langchain_core.messages import convert_to_messages
from langchain_core.messages import HumanMessage, SystemMessage

# è¿æ¥åˆ°è¿œç¨‹å›¾
url = "http://localhost:8123"
graph_name = "task_maistro"
remote_graph = RemoteGraph(graph_name, url=url)
```

**å‚æ•°è¯´æ˜**ï¼š
- `graph_name`ï¼šå›¾çš„åç§°ï¼ˆåœ¨ langgraph.json ä¸­å®šä¹‰çš„ï¼‰
- `url`ï¼šéƒ¨ç½²çš„ URL

#### 2.3.3 SDK vs Remote Graph

| ç‰¹æ€§ | LangGraph SDK | Remote Graph |
|------|--------------|--------------|
| **ç”¨é€”** | å…¨åŠŸèƒ½ API å®¢æˆ·ç«¯ | ç±»ä¼¼æœ¬åœ°å›¾çš„æ¥å£ |
| **é€‚åˆåœºæ™¯** | ç”Ÿäº§ç¯å¢ƒï¼Œå®Œæ•´æ§åˆ¶ | å¿«é€ŸåŸå‹ï¼Œæœ€å°æ”¹åŠ¨ |
| **åŠŸèƒ½èŒƒå›´** | å…¨éƒ¨ API åŠŸèƒ½ | å›¾æ‰§è¡Œå’Œæµå¼ä¼ è¾“ |
| **å­¦ä¹ æ›²çº¿** | éœ€è¦äº†è§£ API æ¦‚å¿µ | ç†Ÿæ‚‰ LangGraph å³å¯ |
| **çµæ´»æ€§** | é«˜ï¼ˆå®Œå…¨æ§åˆ¶ï¼‰ | ä¸­ï¼ˆç®€åŒ–æ¥å£ï¼‰ |

**ä½•æ—¶ä½¿ç”¨å“ªä¸ªï¼Ÿ**

**ä½¿ç”¨ SDK**ï¼š
- ç”Ÿäº§ç¯å¢ƒåº”ç”¨
- éœ€è¦ç®¡ç† threadsã€runsã€store
- éœ€è¦å®Œæ•´çš„æ§åˆ¶å’Œç›‘æ§

**ä½¿ç”¨ Remote Graph**ï¼š
- å¿«é€ŸåŸå‹å¼€å‘
- ä»æœ¬åœ°å›¾è¿ç§»åˆ°è¿œç¨‹å›¾
- åªéœ€è¦åŸºæœ¬çš„å›¾æ‰§è¡ŒåŠŸèƒ½

---

## ä¸‰ã€Runsï¼ˆè¿è¡Œï¼‰

### 3.1 ä»€ä¹ˆæ˜¯ Runï¼Ÿ

**Runï¼ˆè¿è¡Œï¼‰** = å›¾çš„ä¸€æ¬¡å®Œæ•´æ‰§è¡Œ

**å…³é”®ç‰¹æ€§**ï¼š
- æ¯ä¸ª run æœ‰å”¯ä¸€çš„ ID
- ç»“æœå­˜å‚¨åœ¨ PostgreSQL
- å¯ä»¥æŸ¥è¯¢çŠ¶æ€å’Œç»“æœ
- å¯ä»¥è¿½è¸ªæ‰§è¡Œå†å²

**Run çš„ç”Ÿå‘½å‘¨æœŸ**ï¼š
```
pending â†’ running â†’ success/error
  â†“         â†“            â†“
 åˆ›å»º      æ‰§è¡Œä¸­        å®Œæˆ
```

### 3.2 Run çš„ç±»å‹

LangGraph Server æ”¯æŒä¸‰ç§ç±»å‹çš„ runsï¼š

```
Run ç±»å‹
â”œâ”€â”€ Background Runï¼ˆåå°è¿è¡Œï¼‰
â”‚   â””â”€â”€ Fire and forget
â”‚       - ä¸ç­‰å¾…å®Œæˆ
â”‚       - é€‚åˆé•¿æ—¶é—´ä»»åŠ¡
â”‚       - å¯ä»¥è½®è¯¢çŠ¶æ€
â”‚
â”œâ”€â”€ Blocking Runï¼ˆé˜»å¡è¿è¡Œï¼‰
â”‚   â””â”€â”€ Wait for completion
â”‚       - ç­‰å¾…å®Œæˆåè¿”å›
â”‚       - ç¡®ä¿é¡ºåºæ‰§è¡Œ
â”‚       - åŒæ­¥æ“ä½œ
â”‚
â””â”€â”€ Streaming Runï¼ˆæµå¼è¿è¡Œï¼‰
    â””â”€â”€ Real-time updates
        - å®æ—¶æ¥æ”¶æ›´æ–°
        - æµå¼ä¼ è¾“ tokens
        - æ”¹å–„ç”¨æˆ·ä½“éªŒ
```

### 3.3 Background Runsï¼ˆåå°è¿è¡Œï¼‰

#### 3.3.1 åˆ›å»ºçº¿ç¨‹

```python
# åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹
thread = await client.threads.create()
thread
```

**è¾“å‡º**ï¼š
```python
{
    'thread_id': '7f71c0dd-768b-4e53-8349-42bdd10e7caf',
    'created_at': '2024-11-14T19:36:08.459457+00:00',
    'updated_at': '2024-11-14T19:36:08.459457+00:00',
    'metadata': {},
    'status': 'idle',
    'config': {},
    'values': None
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|--------|
| `thread_id` | çº¿ç¨‹å”¯ä¸€æ ‡è¯† | UUID |
| `created_at` | åˆ›å»ºæ—¶é—´ | ISO 8601 æ ¼å¼ |
| `updated_at` | æ›´æ–°æ—¶é—´ | ISO 8601 æ ¼å¼ |
| `status` | å½“å‰çŠ¶æ€ | idle/busy |
| `metadata` | å…ƒæ•°æ® | å­—å…¸ |
| `config` | é…ç½® | å­—å…¸ |
| `values` | å½“å‰çŠ¶æ€å€¼ | Noneï¼ˆæ–°çº¿ç¨‹ï¼‰ |

#### 3.3.2 æ£€æŸ¥çº¿ç¨‹ä¸Šçš„è¿è¡Œ

```python
# æ£€æŸ¥çº¿ç¨‹ä¸Šæ˜¯å¦æœ‰è¿è¡Œ
thread = await client.threads.create()
runs = await client.runs.list(thread["thread_id"])
print(runs)
```

**è¾“å‡º**ï¼š
```python
[]
```
- æ–°çº¿ç¨‹æ²¡æœ‰ä»»ä½•è¿è¡Œè®°å½•

#### 3.3.3 åˆ›å»ºåå°è¿è¡Œ

```python
# åˆ›å»ºä¸€äº› ToDos
user_input = "Add a ToDo to finish booking travel to Hong Kong by end of next week. Also, add a ToDo to call parents back about Thanksgiving plans."
config = {"configurable": {"user_id": "Test"}}
graph_name = "task_maistro"

# åˆ›å»ºè¿è¡Œï¼ˆåå°æ‰§è¡Œï¼‰
run = await client.runs.create(
    thread["thread_id"],
    graph_name,
    input={"messages": [HumanMessage(content=user_input)]},
    config=config
)
```

**å‚æ•°è¯¦è§£**ï¼š

```python
await client.runs.create(
    thread_id,         # çº¿ç¨‹ ID
    assistant_id,      # å›¾/åŠ©æ‰‹åç§°
    input={...},       # è¾“å…¥æ•°æ®
    config={...}       # é…ç½®ï¼ˆå¦‚ user_idï¼‰
)
```

**è¿™æ˜¯ä¸€ä¸ªåå°è¿è¡Œ**ï¼š
- å‡½æ•°ç«‹å³è¿”å›
- ä¸ç­‰å¾…æ‰§è¡Œå®Œæˆ
- å›¾åœ¨åå°å¼‚æ­¥æ‰§è¡Œ

#### 3.3.4 å¯åŠ¨æ–°è¿è¡Œå¹¶æ£€æŸ¥çŠ¶æ€

```python
# åˆ›å»ºæ–°çº¿ç¨‹å’Œæ–°è¿è¡Œ
thread = await client.threads.create()
user_input = "Give me a summary of all ToDos."
config = {"configurable": {"user_id": "Test"}}
graph_name = "task_maistro"

# åˆ›å»ºè¿è¡Œ
run = await client.runs.create(
    thread["thread_id"],
    graph_name,
    input={"messages": [HumanMessage(content=user_input)]},
    config=config
)

# æ£€æŸ¥è¿è¡ŒçŠ¶æ€
print(await client.runs.get(thread["thread_id"], run["run_id"]))
```

**è¾“å‡ºï¼ˆç®€åŒ–ï¼‰**ï¼š
```python
{
    'run_id': '1efa2c00-63e4-6f4a-9c5b-ca3f5f9bff07',
    'thread_id': '641c195a-9e31-4250-a729-6b742c089df8',
    'status': 'pending',  # ä»åœ¨è¿è¡Œ
    'created_at': '2024-11-14T19:38:29.394777+00:00',
    'updated_at': '2024-11-14T19:38:29.394777+00:00',
    ...
}
```

**æ³¨æ„**ï¼š`'status': 'pending'` è¡¨ç¤ºè¿è¡Œä»åœ¨è¿›è¡Œä¸­ã€‚

**Run çŠ¶æ€è¯´æ˜**ï¼š

| çŠ¶æ€ | å«ä¹‰ | è¯´æ˜ |
|------|------|------|
| `pending` | ç­‰å¾…æ‰§è¡Œ | åœ¨é˜Ÿåˆ—ä¸­ |
| `running` | æ­£åœ¨æ‰§è¡Œ | Queue worker å¤„ç†ä¸­ |
| `success` | æˆåŠŸå®Œæˆ | æ­£å¸¸ç»“æŸ |
| `error` | æ‰§è¡Œå¤±è´¥ | å‘ç”Ÿé”™è¯¯ |
| `interrupted` | è¢«ä¸­æ–­ | äººä¸ºä¸­æ–­ |
| `cancelled` | è¢«å–æ¶ˆ | ä¸»åŠ¨å–æ¶ˆ |

### 3.4 Blocking Runsï¼ˆé˜»å¡è¿è¡Œï¼‰

#### 3.4.1 ä½¿ç”¨ client.runs.join

å¦‚æœä½ æƒ³ç­‰å¾…è¿è¡Œå®Œæˆï¼ˆé˜»å¡è¿è¡Œï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `client.runs.join`ï¼š

```python
# ç­‰å¾…è¿è¡Œå®Œæˆ
await client.runs.join(thread["thread_id"], run["run_id"])

# å†æ¬¡æ£€æŸ¥çŠ¶æ€
print(await client.runs.get(thread["thread_id"], run["run_id"]))
```

**è¾“å‡º**ï¼š
```python
{
    'run_id': '1efa2c00-63e4-6f4a-9c5b-ca3f5f9bff07',
    'thread_id': '641c195a-9e31-4250-a729-6b742c089df8',
    'status': 'success',  # å·²å®Œæˆ
    ...
}
```

**`client.runs.join` çš„ä½œç”¨**ï¼š
- é˜»å¡å½“å‰æ‰§è¡Œ
- ç­‰å¾…æŒ‡å®š run å®Œæˆ
- ç¡®ä¿åœ¨è¯¥çº¿ç¨‹ä¸Šä¸ä¼šå¯åŠ¨æ–° runï¼Œç›´åˆ°å½“å‰ run å®Œæˆ

**ä½¿ç”¨åœºæ™¯**ï¼š
- éœ€è¦ç¡®ä¿é¡ºåºæ‰§è¡Œ
- åç»­æ“ä½œä¾èµ–å½“å‰ç»“æœ
- æµ‹è¯•å’Œè°ƒè¯•

### 3.5 Streaming Runsï¼ˆæµå¼è¿è¡Œï¼‰

#### 3.5.1 æµå¼ä¼ è¾“çš„æ¶æ„

```
å®¢æˆ·ç«¯å‘èµ·æµå¼è¯·æ±‚
       â†“
HTTP Worker ç”Ÿæˆ run_id
       â†“
Queue Worker å¼€å§‹æ‰§è¡Œ
       â†“ (æ‰§è¡Œè¿‡ç¨‹ä¸­)
Queue Worker å‘å¸ƒæ›´æ–°åˆ° Redis
       â†“
HTTP Worker ä» Redis è®¢é˜…æ›´æ–°
       â†“
å®æ—¶æ¨é€ç»™å®¢æˆ·ç«¯
       â†“
æ‰§è¡Œå®Œæˆï¼Œå…³é—­è¿æ¥
```

#### 3.5.2 æµå¼ä¼ è¾“ tokens

æœ€å¸¸ç”¨çš„æµå¼ä¼ è¾“æ–¹å¼æ˜¯ **streaming tokens**ï¼ˆé€ token è¿”å›ï¼‰ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒã€‚

```python
user_input = "What ToDo should I focus on first."

async for chunk in client.runs.stream(
    thread["thread_id"],
    graph_name,
    input={"messages": [HumanMessage(content=user_input)]},
    config=config,
    stream_mode="messages-tuple"
):
    if chunk.event == "messages":
        print("".join(
            data_item['content']
            for data_item in chunk.data
            if 'content' in data_item
        ), end="", flush=True)
```

**è¾“å‡ºï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰**ï¼š
```
You might want to focus on "Call parents back about Thanksgiving plans" first. It has a shorter estimated time to complete (15 minutes) and doesn't have a specific deadline, so it could be a quick task to check off your list. Once that's done, you can dedicate more time to "Finish booking travel to Hong Kong," which is more time-consuming and has a deadline.
```

**ä»£ç è¯¦è§£**ï¼š

**`client.runs.stream()`**ï¼š
```python
async for chunk in client.runs.stream(
    thread_id,              # çº¿ç¨‹ ID
    assistant_id,           # å›¾åç§°
    input={...},            # è¾“å…¥
    config={...},           # é…ç½®
    stream_mode="messages-tuple"  # æµå¼æ¨¡å¼
):
    # å¤„ç†æ¯ä¸ª chunk
    pass
```

**`stream_mode` é€‰é¡¹**ï¼š

| æ¨¡å¼ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `values` | å®Œæ•´çš„çŠ¶æ€å€¼ | æŸ¥çœ‹æ¯ä¸ªèŠ‚ç‚¹åçš„å®Œæ•´çŠ¶æ€ |
| `updates` | çŠ¶æ€æ›´æ–° | æŸ¥çœ‹æ¯ä¸ªèŠ‚ç‚¹çš„æ›´æ–° |
| `messages` | æ¶ˆæ¯åˆ—è¡¨ | æŸ¥çœ‹æ¶ˆæ¯æµ |
| `messages-tuple` | æ¶ˆæ¯å…ƒç»„ï¼ˆæ¨èï¼‰ | é€ token æµå¼ä¼ è¾“ |
| `custom` | è‡ªå®šä¹‰æµ | é«˜çº§ç”¨ä¾‹ |

**æ‰“å°é€»è¾‘**ï¼š
```python
if chunk.event == "messages":
    # æå–æ‰€æœ‰åŒ…å« 'content' çš„ data_item
    content = "".join(
        data_item['content']
        for data_item in chunk.data
        if 'content' in data_item
    )
    # å®æ—¶æ‰“å°ï¼Œä¸æ¢è¡Œ
    print(content, end="", flush=True)
```

**Python çŸ¥è¯†ç‚¹ - print å‚æ•°**ï¼š
```python
print(text, end="", flush=True)
#           ^^^^^^  ^^^^^^^^^^
#           ä¸æ¢è¡Œ   ç«‹å³åˆ·æ–°ç¼“å†²åŒº

# é»˜è®¤è¡Œä¸ºï¼š
print(text)  # ç­‰ä»·äº print(text, end="\n", flush=False)

# end="" çš„ä½œç”¨ï¼š
print("Hello", end="")
print("World")
# è¾“å‡ºï¼šHelloWorld

# flush=True çš„ä½œç”¨ï¼š
# ç«‹å³è¾“å‡ºï¼Œä¸ç­‰å¾…ç¼“å†²åŒºæ»¡
# å¯¹äºå®æ—¶æµå¼ä¼ è¾“å¾ˆé‡è¦
```

#### 3.5.3 æµå¼ä¼ è¾“çš„ä¼˜åŠ¿

**æ²¡æœ‰æµå¼ä¼ è¾“**ï¼š
```
ç”¨æˆ·å‘é€è¯·æ±‚
     â†“
ç­‰å¾… 30 ç§’...ï¼ˆç”¨æˆ·çœ‹ä¸åˆ°ä»»ä½•åé¦ˆï¼‰
     â†“
ä¸€æ¬¡æ€§è¿”å›å®Œæ•´å“åº”
```

**æœ‰æµå¼ä¼ è¾“**ï¼š
```
ç”¨æˆ·å‘é€è¯·æ±‚
     â†“
ç«‹å³çœ‹åˆ°å¼€å§‹ç”Ÿæˆ
     â†“
é€å­—å®æ—¶æ˜¾ç¤º
     â†“
ç”¨æˆ·ä½“éªŒæ›´å¥½
```

---

## å››ã€Threadsï¼ˆçº¿ç¨‹ï¼‰

### 4.1 Run vs Thread

**é‡è¦åŒºåˆ«**ï¼š

```
Runï¼ˆè¿è¡Œï¼‰                 Threadï¼ˆçº¿ç¨‹ï¼‰
    â†“                          â†“
ä¸€æ¬¡æ‰§è¡Œ                    å¤šè½®äº¤äº’
æ— çŠ¶æ€                      æœ‰çŠ¶æ€
å•æ¬¡ä»»åŠ¡                    å¯¹è¯å†å²
```

**ç±»æ¯”**ï¼š
- **Run** = ä¸€æ¬¡å‡½æ•°è°ƒç”¨
- **Thread** = ä¸€ä¸ªä¼šè¯/å¯¹è¯

### 4.2 Thread çš„æŒä¹…åŒ–

å½“å®¢æˆ·ç«¯ä½¿ç”¨ `thread_id` æ‰§è¡Œå›¾æ—¶ï¼š
1. æœåŠ¡å™¨ä¿å­˜æ‰€æœ‰ **checkpoints**ï¼ˆæ£€æŸ¥ç‚¹ï¼‰åˆ°çº¿ç¨‹
2. Checkpoints å­˜å‚¨åœ¨ PostgreSQL ä¸­
3. æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåéƒ½ä¼šåˆ›å»ºä¸€ä¸ª checkpoint
4. å¯ä»¥ä»ä»»ä½• checkpoint ç»§ç»­æ‰§è¡Œ

**Checkpoint çš„ä½œç”¨**ï¼š
- ä¿å­˜æ‰§è¡Œå†å²
- æ”¯æŒæ—¶é—´æ—…è¡Œï¼ˆtime travelï¼‰
- å®ç° Human in the loop
- é”™è¯¯æ¢å¤

### 4.3 æ£€æŸ¥çº¿ç¨‹çŠ¶æ€

```python
# è·å–çº¿ç¨‹çš„å½“å‰çŠ¶æ€
thread_state = await client.threads.get_state(thread['thread_id'])

# æ‰“å°æ¶ˆæ¯å†å²
for m in convert_to_messages(thread_state['values']['messages']):
    m.pretty_print()
```

**è¾“å‡º**ï¼š
```
================================ Human Message =================================
Give me a summary of all ToDos.

================================== Ai Message ==================================
Here's a summary of your current ToDo list:

1. **Task:** Finish booking travel to Hong Kong
   - **Status:** Not started
   - **Deadline:** November 22, 2024
   - **Solutions:**
     - Check flight prices on Skyscanner
     - Book hotel through Booking.com
     - Arrange airport transfer
   - **Estimated Time to Complete:** 120 minutes

2. **Task:** Call parents back about Thanksgiving plans
   - **Status:** Not started
   - **Deadline:** None
   - **Solutions:**
     - Check calendar for availability
     - Discuss travel arrangements
     - Confirm dinner plans
   - **Estimated Time to Complete:** 15 minutes

Let me know if there's anything else you'd like to do with your ToDo list!

================================ Human Message =================================
What ToDo should I focus on first.

================================== Ai Message ==================================
You might want to focus on "Call parents back about Thanksgiving plans" first...
```

**åˆ†æ**ï¼š
- çº¿ç¨‹ä¿å­˜äº†å®Œæ•´çš„å¯¹è¯å†å²
- åŒ…å«æ‰€æœ‰ç”¨æˆ·è¾“å…¥å’Œ AI å“åº”
- è¿™æ˜¯å¤šè½®å¯¹è¯çš„åŸºç¡€

### 4.4 å¤åˆ¶çº¿ç¨‹ï¼ˆForkï¼‰

**å¤åˆ¶çº¿ç¨‹**å…è®¸ä½ "åˆ†å‰"å¯¹è¯ï¼Œåˆ›å»ºç‹¬ç«‹çš„åˆ†æ”¯ã€‚

```python
# å¤åˆ¶çº¿ç¨‹
copied_thread = await client.threads.copy(thread['thread_id'])

# æ£€æŸ¥å¤åˆ¶çš„çº¿ç¨‹çŠ¶æ€
copied_thread_state = await client.threads.get_state(copied_thread['thread_id'])
for m in convert_to_messages(copied_thread_state['values']['messages']):
    m.pretty_print()
```

**è¾“å‡º**ï¼šå¤åˆ¶çš„çº¿ç¨‹åŒ…å«å®Œå…¨ç›¸åŒçš„å†å²è®°å½•ã€‚

**ä½¿ç”¨åœºæ™¯**ï¼š

```
åŸå§‹çº¿ç¨‹
    â”‚
    â”œâ”€ Run 1: "ç»™æˆ‘ ToDo æ€»ç»“"
    â”œâ”€ Run 2: "åº”è¯¥å…ˆåšå“ªä¸ªï¼Ÿ"
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚
å¤åˆ¶çº¿ç¨‹ A  å¤åˆ¶çº¿ç¨‹ B  åŸå§‹çº¿ç¨‹ç»§ç»­
    â”‚         â”‚         â”‚
    â†“         â†“         â†“
æ¢ç´¢ä¸åŒ   æµ‹è¯•æ–°    æ­£å¸¸ä½¿ç”¨
çš„å¯¹è¯    åŠŸèƒ½
è·¯å¾„
```

**å®é™…åº”ç”¨**ï¼š
1. **A/B æµ‹è¯•**ï¼šæµ‹è¯•ä¸åŒçš„å¯¹è¯è·¯å¾„
2. **What-if åˆ†æ**ï¼šæ¢ç´¢ä¸åŒçš„å†³ç­–ç»“æœ
3. **å¹¶è¡Œå®éªŒ**ï¼šåœ¨ä¸å½±å“åŸå§‹å¯¹è¯çš„æƒ…å†µä¸‹æµ‹è¯•
4. **å¿«ç…§ä¿å­˜**ï¼šä¿å­˜å¯¹è¯çš„æŸä¸ªæ—¶åˆ»

### 4.5 Human in the Loop

#### 4.5.1 æ¦‚å¿µå›é¡¾

åœ¨ Module 3 ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº† **Human in the loop**ï¼ˆäººæœºåä½œï¼‰ï¼š
- åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æš‚åœ
- äººç±»æ£€æŸ¥å’Œä¿®æ”¹çŠ¶æ€
- ä»ä¿®æ”¹åçš„çŠ¶æ€ç»§ç»­æ‰§è¡Œ

#### 4.5.2 è·å–çº¿ç¨‹å†å²

```python
# è·å–çº¿ç¨‹çš„å®Œæ•´å†å²
states = await client.threads.get_history(thread['thread_id'])

# é€‰æ‹©ä¸€ä¸ªå†å²çŠ¶æ€æ¥åˆ†å‰
to_fork = states[-2]  # å€’æ•°ç¬¬äºŒä¸ªçŠ¶æ€
to_fork['values']
```

**è¾“å‡º**ï¼š
```python
{
    'messages': [
        {
            'content': 'Give me a summary of all ToDos.',
            'type': 'human',
            'id': '3680da45-e3a5-4a47-b5b1-4fd4d3e8baf9',
            ...
        }
    ]
}
```

**states åˆ—è¡¨ç»“æ„**ï¼š
```python
states = [
    state_0,  # æœ€æ–°çŠ¶æ€
    state_1,  # ä¸Šä¸€ä¸ªçŠ¶æ€
    state_2,  # æ›´æ—©çš„çŠ¶æ€
    ...
]

# states[-1] = æœ€æ—©çš„çŠ¶æ€
# states[-2] = å€’æ•°ç¬¬äºŒä¸ªçŠ¶æ€
# states[0]  = æœ€æ–°çŠ¶æ€
```

#### 4.5.3 æ£€æŸ¥çŠ¶æ€è¯¦æƒ…

```python
# æ£€æŸ¥æ¶ˆæ¯ ID
print(to_fork['values']['messages'][0]['id'])
# è¾“å‡ºï¼š'3680da45-e3a5-4a47-b5b1-4fd4d3e8baf9'

# æ£€æŸ¥ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹
print(to_fork['next'])
# è¾“å‡ºï¼š['task_mAIstro']

# æ£€æŸ¥ checkpoint ID
print(to_fork['checkpoint_id'])
# è¾“å‡ºï¼š'1efa2c00-6609-67ff-8000-491b1dcf8129'
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `values` | å½“å‰çŠ¶æ€å€¼ | åŒ…å«æ¶ˆæ¯ã€æ•°æ®ç­‰ |
| `next` | ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹ | çŸ¥é“ä»å“ªé‡Œç»§ç»­ |
| `checkpoint_id` | æ£€æŸ¥ç‚¹ ID | ç”¨äºæ—¶é—´æ—…è¡Œ |
| `metadata` | å…ƒæ•°æ® | é¢å¤–ä¿¡æ¯ |

#### 4.5.4 ç¼–è¾‘çŠ¶æ€

**å…³é”®æ¦‚å¿µ**ï¼šæ¶ˆæ¯ reducer çš„å·¥ä½œæ–¹å¼

```python
# å›é¡¾ Module-2ï¼šæ¶ˆæ¯ reducer
def add_messages(left, right):
    # å¦‚æœæä¾›äº†æ¶ˆæ¯ IDï¼Œåˆ™æ›´æ–°ï¼ˆè¦†ç›–ï¼‰
    # å¦‚æœæ²¡æœ‰ IDï¼Œåˆ™è¿½åŠ 
    ...
```

**ç¼–è¾‘çŠ¶æ€çš„æŠ€å·§**ï¼š
1. **ä¸æä¾› ID** â†’ è¿½åŠ æ–°æ¶ˆæ¯
2. **æä¾› ID** â†’ è¦†ç›–ç°æœ‰æ¶ˆæ¯

```python
# åˆ›å»ºæ–°æ¶ˆæ¯ï¼Œä½†ä½¿ç”¨æ—§æ¶ˆæ¯çš„ IDï¼ˆè¦†ç›–ï¼‰
forked_input = {
    "messages": HumanMessage(
        content="Give me a summary of all ToDos that need to be done in the next week.",
        id=to_fork['values']['messages'][0]['id']  # ä½¿ç”¨æ—§ ID
    )
}

# æ›´æ–°çŠ¶æ€ï¼Œåˆ›å»ºæ–°çš„ checkpoint
forked_config = await client.threads.update_state(
    thread["thread_id"],
    forked_input,
    checkpoint_id=to_fork['checkpoint_id']  # ä»è¿™ä¸ª checkpoint åˆ†å‰
)
```

**è¿™è¡Œä»£ç çš„ä½œç”¨**ï¼š
```
åŸå§‹çº¿ç¨‹å†å²ï¼š
checkpoint_0 â†’ checkpoint_1 â†’ checkpoint_2
                â†‘
                â””â”€ ä»è¿™é‡Œåˆ†å‰
                   åˆ›å»ºæ–°åˆ†æ”¯ï¼š
                   checkpoint_1' â†’ checkpoint_2' â†’ ...
```

#### 4.5.5 ä»æ–° checkpoint ç»§ç»­æ‰§è¡Œ

```python
# ä»æ–° checkpoint è¿è¡Œå›¾
async for chunk in client.runs.stream(
    thread["thread_id"],
    graph_name,
    input=None,  # ä¸éœ€è¦æ–°è¾“å…¥ï¼Œä½¿ç”¨æ›´æ–°åçš„çŠ¶æ€
    config=config,
    checkpoint_id=forked_config['checkpoint_id'],  # ä»è¿™ä¸ª checkpoint å¼€å§‹
    stream_mode="messages-tuple"
):
    if chunk.event == "messages":
        print("".join(
            data_item['content']
            for data_item in chunk.data
            if 'content' in data_item
        ), end="", flush=True)
```

**è¾“å‡º**ï¼š
```
Here's a summary of your ToDos that need to be done in the next week:

1. **Finish booking travel to Hong Kong**
   - **Status:** Not started
   - **Deadline:** November 22, 2024
   - **Solutions:**
     - Check flight prices on Skyscanner
     - Book hotel through Booking.com
     - Arrange airport transfer
   - **Estimated Time to Complete:** 120 minutes

It looks like this task is due soon, so you might want to prioritize it. Let me know if there's anything else you need help with!
```

**æ³¨æ„**ï¼š
- AI åªè¿”å›äº†ä¸‹å‘¨éœ€è¦å®Œæˆçš„ä»»åŠ¡
- æ²¡æœ‰è¿”å›æ²¡æœ‰æˆªæ­¢æ—¥æœŸçš„ä»»åŠ¡
- è¿™è¯æ˜äº†çŠ¶æ€ç¼–è¾‘æˆåŠŸäº†ï¼

#### 4.5.6 æ—¶é—´æ—…è¡Œï¼ˆTime Travelï¼‰æ€»ç»“

```
å®Œæ•´çš„æ—¶é—´æ—…è¡Œæµç¨‹ï¼š

1. è·å–å†å²ï¼šget_history()
   â†“
2. é€‰æ‹©æ£€æŸ¥ç‚¹ï¼šstates[-2]
   â†“
3. æ£€æŸ¥è¯¦æƒ…ï¼šnext, checkpoint_id
   â†“
4. ç¼–è¾‘çŠ¶æ€ï¼šupdate_state() with message ID
   â†“
5. åˆ›å»ºæ–°åˆ†æ”¯ï¼šæ–°çš„ checkpoint
   â†“
6. ä»æ–°åˆ†æ”¯ç»§ç»­ï¼šstream() with checkpoint_id
```

**å®é™…åº”ç”¨åœºæ™¯**ï¼š
1. **ç”¨æˆ·çº æ­£é”™è¯¯**ï¼š
   ```
   ç”¨æˆ·ï¼š"é¢„è®¢é¦™æ¸¯çš„æœºç¥¨"
   AIï¼š[é”™è¯¯ç†è§£]
   ç”¨æˆ·ï¼šâ† å›åˆ°ä¸Šä¸€æ­¥ï¼Œé‡æ–°è¾“å…¥
   ```

2. **æ¢ç´¢ä¸åŒé€‰é¡¹**ï¼š
   ```
   é€‰æ‹©ç‚¹ A
   â”œâ”€ é€‰é¡¹ 1 â†’ ç»“æœ 1
   â”œâ”€ é€‰é¡¹ 2 â†’ ç»“æœ 2
   â””â”€ é€‰é¡¹ 3 â†’ ç»“æœ 3
   ```

3. **è°ƒè¯•å’Œæµ‹è¯•**ï¼š
   ```
   é—®é¢˜å‡ºç°
     â†“
   å›åˆ°å‡ºé”™å‰çš„çŠ¶æ€
     â†“
   ä¿®æ”¹è¾“å…¥é‡æ–°æ‰§è¡Œ
     â†“
   éªŒè¯ä¿®å¤
   ```

---

## äº”ã€è·¨çº¿ç¨‹è®°å¿†ï¼ˆStore APIï¼‰

### 5.1 Store çš„ä½œç”¨å›é¡¾

åœ¨ Module-5 ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº† **Store**ï¼ˆé•¿æœŸè®°å¿†ï¼‰ï¼š
- ä¿å­˜è·¨çº¿ç¨‹çš„ä¿¡æ¯
- æŒ‰ namespace ç»„ç»‡
- æŒä¹…åŒ–å­˜å‚¨

**å¼€å‘ vs ç”Ÿäº§**ï¼š

| ç¯å¢ƒ | Store å®ç° |
|------|-----------|
| å¼€å‘ | `InMemoryStore`ï¼ˆå†…å­˜ï¼‰ |
| ç”Ÿäº§ | PostgreSQLï¼ˆæ•°æ®åº“ï¼‰ |

### 5.2 task_maistro çš„ Store ä½¿ç”¨

`task_maistro` å›¾ä½¿ç”¨ Store ä¿å­˜ ToDosï¼š

**Namespace ç»“æ„**ï¼š
```python
("todo", "todo_category", "user_id")
# ä¾‹å¦‚ï¼š
("todo", "general", "Test")
("todo", "work", "lance")
("todo", "personal", "lance")
```

**é»˜è®¤å€¼**ï¼š
- `todo_category` é»˜è®¤ä¸º `"general"`ï¼ˆåœ¨ `deployment/configuration.py` ä¸­å®šä¹‰ï¼‰

### 5.3 æœç´¢è®°å¿†é¡¹

```python
# æœç´¢ç‰¹å®š namespace ä¸­çš„æ‰€æœ‰ items
items = await client.store.search_items(
    ("todo", "general", "Test"),
    limit=5,     # æœ€å¤šè¿”å› 5 ä¸ª
    offset=0     # ä»ç¬¬ 0 ä¸ªå¼€å§‹
)

items['items']
```

**è¾“å‡º**ï¼š
```python
[
    {
        'value': {
            'task': 'Finish booking travel to Hong Kong',
            'status': 'not started',
            'deadline': '2024-11-22T23:59:59',
            'solutions': [
                'Check flight prices on Skyscanner',
                'Book hotel through Booking.com',
                'Arrange airport transfer'
            ],
            'time_to_complete': 120
        },
        'key': '18524803-c182-49de-9b10-08ccb0a06843',
        'namespace': ['todo', 'general', 'Test'],
        'created_at': '2024-11-14T19:37:41.664827+00:00',
        'updated_at': '2024-11-14T19:37:41.664827+00:00'
    },
    {
        'value': {
            'task': 'Call parents back about Thanksgiving plans',
            'status': 'not started',
            'deadline': None,
            'solutions': [
                'Check calendar for availability',
                'Discuss travel arrangements',
                'Confirm dinner plans'
            ],
            'time_to_complete': 15
        },
        'key': '375d9596-edf8-4de2-985b-bacdc623d6ef',
        'namespace': ['todo', 'general', 'Test'],
        'created_at': '2024-11-14T19:37:41.664827+00:00',
        'updated_at': '2024-11-14T19:37:41.664827+00:00'
    }
]
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `value` | å®é™…æ•°æ®ï¼ˆå­—å…¸ï¼‰ | ToDo çš„è¯¦ç»†ä¿¡æ¯ |
| `key` | å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰ | ç”¨äºæ›´æ–°/åˆ é™¤ |
| `namespace` | å‘½åç©ºé—´ | `["todo", "general", "Test"]` |
| `created_at` | åˆ›å»ºæ—¶é—´ | ISO 8601 æ ¼å¼ |
| `updated_at` | æ›´æ–°æ—¶é—´ | ISO 8601 æ ¼å¼ |

**`search_items` å‚æ•°**ï¼š

```python
await client.store.search_items(
    namespace,     # å¿…éœ€ï¼šå‘½åç©ºé—´å…ƒç»„
    limit=10,      # å¯é€‰ï¼šæœ€å¤§è¿”å›æ•°é‡
    offset=0,      # å¯é€‰ï¼šåç§»é‡ï¼ˆåˆ†é¡µï¼‰
    filter={}      # å¯é€‰ï¼šè¿‡æ»¤æ¡ä»¶
)
```

**åˆ†é¡µç¤ºä¾‹**ï¼š
```python
# ç¬¬ä¸€é¡µï¼ˆ0-9ï¼‰
page1 = await client.store.search_items(
    ("todo", "general", "Test"),
    limit=10,
    offset=0
)

# ç¬¬äºŒé¡µï¼ˆ10-19ï¼‰
page2 = await client.store.search_items(
    ("todo", "general", "Test"),
    limit=10,
    offset=10
)
```

### 5.4 æ·»åŠ è®°å¿†é¡¹

åœ¨å›¾çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `store.put()` æ·»åŠ é¡¹ã€‚
ä½¿ç”¨ SDKï¼Œæˆ‘ä»¬å¯ä»¥**åœ¨å›¾å¤–éƒ¨**ç›´æ¥æ·»åŠ é¡¹ï¼š

```python
from uuid import uuid4

# ç›´æ¥æ·»åŠ é¡¹åˆ° store
await client.store.put_item(
    ("testing", "Test"),          # namespace
    key=str(uuid4()),              # ç”Ÿæˆå”¯ä¸€ key
    value={"todo": "Test SDK put_item"}  # æ•°æ®
)
```

**éªŒè¯æ·»åŠ **ï¼š
```python
# æœç´¢åˆšæ·»åŠ çš„é¡¹
items = await client.store.search_items(
    ("testing", "Test"),
    limit=5,
    offset=0
)

items['items']
```

**è¾“å‡º**ï¼š
```python
[
    {
        'value': {'todo': 'Test SDK put_item'},
        'key': '3de441ba-8c79-4beb-8f52-00e4dcba68d4',
        'namespace': ['testing', 'Test'],
        'created_at': '2024-11-14T19:56:30.452808+00:00',
        'updated_at': '2024-11-14T19:56:30.452808+00:00'
    }
]
```

**`put_item` å‚æ•°**ï¼š

```python
await client.store.put_item(
    namespace,     # å‘½åç©ºé—´å…ƒç»„
    key=key,       # å”¯ä¸€é”®ï¼ˆå­—ç¬¦ä¸²ï¼‰
    value=value    # æ•°æ®ï¼ˆå­—å…¸ï¼‰
)
```

**Key ç®¡ç†ç­–ç•¥**ï¼š

```python
# ç­–ç•¥ 1ï¼šä½¿ç”¨ UUIDï¼ˆæ¨èï¼‰
from uuid import uuid4
key = str(uuid4())

# ç­–ç•¥ 2ï¼šä½¿ç”¨è‡ªå®šä¹‰ ID
key = f"todo_{user_id}_{task_id}"

# ç­–ç•¥ 3ï¼šä½¿ç”¨å†…å®¹å“ˆå¸Œ
import hashlib
key = hashlib.md5(content.encode()).hexdigest()
```

### 5.5 åˆ é™¤è®°å¿†é¡¹

```python
# è·å–æ‰€æœ‰ item çš„ keys
keys = [item['key'] for item in items['items']]
print(keys)
# è¾“å‡ºï¼š['3de441ba-8c79-4beb-8f52-00e4dcba68d4', ...]

# åˆ é™¤ç‰¹å®š item
await client.store.delete_item(
    ("testing", "Test"),                        # namespace
    key='3de441ba-8c79-4beb-8f52-00e4dcba68d4'  # key
)
```

**éªŒè¯åˆ é™¤**ï¼š
```python
# å†æ¬¡æœç´¢
items = await client.store.search_items(
    ("testing", "Test"),
    limit=5,
    offset=0
)

items['items']
# è¾“å‡ºï¼šåªå‰©ä¸€ä¸ª item
```

**Python çŸ¥è¯†ç‚¹ - åˆ—è¡¨æ¨å¯¼å¼**ï¼š
```python
keys = [item['key'] for item in items['items']]

# ç­‰ä»·äºï¼š
keys = []
for item in items['items']:
    keys.append(item['key'])

# æ›´å¤æ‚çš„ä¾‹å­ï¼š
active_tasks = [
    item['value']['task']
    for item in items['items']
    if item['value']['status'] == 'not started'
]
```

### 5.6 Store API å®Œæ•´æ€»ç»“

```python
# 1. æœç´¢
items = await client.store.search_items(
    namespace,
    limit=10,
    offset=0
)

# 2. æ·»åŠ /æ›´æ–°
await client.store.put_item(
    namespace,
    key=key,
    value=value
)

# 3. è·å–å•ä¸ª
item = await client.store.get_item(
    namespace,
    key=key
)

# 4. åˆ é™¤
await client.store.delete_item(
    namespace,
    key=key
)
```

---

## å…­ã€LangGraph Platform æ¶æ„æ·±å…¥ç†è§£

### 6.1 å®Œæ•´çš„è¯·æ±‚æµç¨‹

**åŒæ­¥è¯·æ±‚ï¼ˆBlocking Runï¼‰**ï¼š

```
å®¢æˆ·ç«¯
  â†“ å‘é€è¯·æ±‚
HTTP Worker
  â†“ åˆ›å»º run_id
  â†“ å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼ˆRedisï¼‰
  â†“ ç­‰å¾…å®Œæˆ
Queue Worker
  â†“ ä»é˜Ÿåˆ—è·å–ä»»åŠ¡
  â†“ æ‰§è¡Œå›¾
  â†“ å†™å…¥ç»“æœï¼ˆPostgreSQLï¼‰
  â†“ é€šçŸ¥å®Œæˆï¼ˆRedisï¼‰
HTTP Worker
  â†“ æ¥æ”¶å®Œæˆé€šçŸ¥
  â†“ è¿”å›ç»“æœ
å®¢æˆ·ç«¯
  â†“ æ¥æ”¶å“åº”
```

**æµå¼è¯·æ±‚ï¼ˆStreaming Runï¼‰**ï¼š

```
å®¢æˆ·ç«¯
  â†“ å‘é€æµå¼è¯·æ±‚
HTTP Worker
  â†“ å»ºç«‹ WebSocket è¿æ¥
  â†“ åˆ›å»º run_id
  â†“ è®¢é˜… Redis é¢‘é“
Queue Worker
  â†“ æ‰§è¡Œå›¾
  â†“ å‘å¸ƒæ›´æ–°åˆ° Redisï¼ˆæ¯ä¸ªèŠ‚ç‚¹ï¼‰
  â†“
Redis
  â†“ å®æ—¶ä¼ é€’æ›´æ–°
HTTP Worker
  â†“ æ¥æ”¶æ›´æ–°
  â†“ æ¨é€ç»™å®¢æˆ·ç«¯
å®¢æˆ·ç«¯
  â†“ å®æ—¶æ¥æ”¶ chunks
```

### 6.2 æ•°æ®æµ

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     LangGraph Server              â”‚
â”‚                                   â”‚
â”‚  HTTP Worker                      â”‚
â”‚    â†“                              â”‚
â”‚  Redis (æ¶ˆæ¯é˜Ÿåˆ—/ç¼“å­˜)             â”‚
â”‚    â†“                              â”‚
â”‚  Queue Worker                     â”‚
â”‚    â†“                              â”‚
â”‚  PostgreSQL (æŒä¹…åŒ–)              â”‚
â”‚    - threads                      â”‚
â”‚    - runs                         â”‚
â”‚    - checkpoints                  â”‚
â”‚    - store                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å®¢æˆ·ç«¯å“åº”
```

### 6.3 æ‰©å±•æ€§

**æ°´å¹³æ‰©å±•**ï¼š

```
            è´Ÿè½½å‡è¡¡å™¨
                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“           â†“           â†“
HTTP Worker HTTP Worker HTTP Worker
    â†“           â†“           â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
              Redis
                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“           â†“           â†“
Queue Worker Queue Worker Queue Worker
    â†“           â†“           â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
           PostgreSQL
```

**æ‰©å±•ç­–ç•¥**ï¼š
1. å¢åŠ  HTTP Workers â†’ å¤„ç†æ›´å¤šå¹¶å‘è¯·æ±‚
2. å¢åŠ  Queue Workers â†’ å¤„ç†æ›´å¤šä»»åŠ¡
3. Redis Cluster â†’ æé«˜ç¼“å­˜æ€§èƒ½
4. PostgreSQL ä¸»ä»å¤åˆ¶ â†’ æé«˜è¯»æ€§èƒ½

---

## ä¸ƒã€å®æˆ˜æ¼”ç¤º

### 7.1 å®Œæ•´çš„å¯¹è¯æµç¨‹

```python
from langgraph_sdk import get_client
from langchain_core.messages import HumanMessage

# 1. è¿æ¥åˆ°éƒ¨ç½²
client = get_client(url="http://localhost:8123")

# 2. åˆ›å»ºçº¿ç¨‹
thread = await client.threads.create()

# 3. é…ç½®
config = {"configurable": {"user_id": "demo_user"}}

# 4. ç¬¬ä¸€è½®å¯¹è¯
async for chunk in client.runs.stream(
    thread["thread_id"],
    "task_maistro",
    input={"messages": [HumanMessage("Add a ToDo to buy groceries")]},
    config=config,
    stream_mode="messages-tuple"
):
    if chunk.event == "messages":
        print("".join(
            d['content'] for d in chunk.data if 'content' in d
        ), end="", flush=True)

# 5. ç¬¬äºŒè½®å¯¹è¯ï¼ˆåœ¨åŒä¸€çº¿ç¨‹ä¸­ï¼‰
async for chunk in client.runs.stream(
    thread["thread_id"],
    "task_maistro",
    input={"messages": [HumanMessage("What's on my ToDo list?")]},
    config=config,
    stream_mode="messages-tuple"
):
    if chunk.event == "messages":
        print("".join(
            d['content'] for d in chunk.data if 'content' in d
        ), end="", flush=True)

# 6. æ£€æŸ¥ Store
todos = await client.store.search_items(
    ("todo", "general", "demo_user")
)

for todo in todos['items']:
    print(f"- {todo['value']['task']}")
```

### 7.2 æ‰¹é‡æ“ä½œç¤ºä¾‹

```python
# æ‰¹é‡åˆ›å»º ToDos
tasks = [
    "Finish project report",
    "Call dentist for appointment",
    "Buy birthday gift for mom",
    "Review code PRs"
]

for task in tasks:
    await client.runs.create(
        thread["thread_id"],
        "task_maistro",
        input={"messages": [HumanMessage(f"Add ToDo: {task}")]},
        config=config
    )
    # ç­‰å¾…å®Œæˆ
    await client.runs.join(thread["thread_id"], run["run_id"])

# è·å–æ‰€æœ‰ ToDos
all_todos = await client.store.search_items(
    ("todo", "general", "demo_user"),
    limit=100
)

print(f"Total: {len(all_todos['items'])} ToDos")
```

---

## å…«ã€æœ€ä½³å®è·µ

### 8.1 é”™è¯¯å¤„ç†

```python
import httpx

try:
    run = await client.runs.create(
        thread["thread_id"],
        "task_maistro",
        input={"messages": [HumanMessage("Hello")]},
        config=config
    )
except httpx.HTTPStatusError as e:
    if e.response.status_code == 409:
        print("Conflict: Another run is already in progress")
    elif e.response.status_code == 404:
        print("Not found: Thread or graph doesn't exist")
    else:
        print(f"HTTP error: {e}")
except Exception as e:
    print(f"Unexpected error: {e}")
```

### 8.2 è¶…æ—¶å¤„ç†

```python
import asyncio

async def run_with_timeout(client, thread_id, assistant_id, input, config, timeout=30):
    """è¿è¡Œå›¾ï¼Œå¸¦è¶…æ—¶"""
    try:
        run = await client.runs.create(thread_id, assistant_id, input=input, config=config)
        await asyncio.wait_for(
            client.runs.join(thread_id, run["run_id"]),
            timeout=timeout
        )
        return await client.runs.get(thread_id, run["run_id"])
    except asyncio.TimeoutError:
        print(f"Run timed out after {timeout} seconds")
        return None
```

### 8.3 é‡è¯•æœºåˆ¶

```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=4, max=10)
)
async def create_run_with_retry(client, thread_id, assistant_id, input, config):
    """åˆ›å»ºè¿è¡Œï¼Œå¸¦é‡è¯•"""
    return await client.runs.create(thread_id, assistant_id, input=input, config=config)
```

### 8.4 æ—¥å¿—è®°å½•

```python
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

async def create_run_with_logging(client, thread_id, assistant_id, input, config):
    """åˆ›å»ºè¿è¡Œï¼Œå¸¦æ—¥å¿—"""
    logger.info(f"Creating run for thread {thread_id}")

    run = await client.runs.create(thread_id, assistant_id, input=input, config=config)

    logger.info(f"Run created: {run['run_id']}")
    logger.info(f"Status: {run['status']}")

    return run
```

---

## ä¹ã€å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 9.1 è¿æ¥å¤±è´¥

**é—®é¢˜**ï¼šæ— æ³•è¿æ¥åˆ° `http://localhost:8123`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥éƒ¨ç½²æ˜¯å¦è¿è¡Œ
$ docker compose ps

# 2. æ£€æŸ¥ç«¯å£æ˜ å°„
$ docker compose ps | grep 8123

# 3. æµ‹è¯•è¿æ¥
$ curl http://localhost:8123/health

# 4. æŸ¥çœ‹æ—¥å¿—
$ docker compose logs langgraph-api
```

### 9.2 Run ä¸€ç›´æ˜¯ pending çŠ¶æ€

**é—®é¢˜**ï¼šRun é•¿æ—¶é—´åœç•™åœ¨ `pending` çŠ¶æ€

**å¯èƒ½åŸå› **ï¼š
1. Queue Worker æ²¡æœ‰è¿è¡Œ
2. Redis è¿æ¥é—®é¢˜
3. ä»»åŠ¡é˜Ÿåˆ—å µå¡

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
$ docker compose ps

# æŸ¥çœ‹ Queue Worker æ—¥å¿—
$ docker compose logs langgraph-api | grep -i "worker"

# é‡å¯æœåŠ¡
$ docker compose restart
```

### 9.3 Thread çŠ¶æ€ä¸æ›´æ–°

**é—®é¢˜**ï¼šçº¿ç¨‹çŠ¶æ€çœ‹èµ·æ¥æ²¡æœ‰æ›´æ–°

**åŸå› **ï¼šå¯èƒ½æ˜¯ç¼“å­˜é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# å¼ºåˆ¶åˆ·æ–°çŠ¶æ€
thread_state = await client.threads.get_state(
    thread['thread_id'],
    checkpoint_id=None  # è·å–æœ€æ–°çŠ¶æ€
)
```

### 9.4 Store æ•°æ®ä¸¢å¤±

**é—®é¢˜**ï¼šStore ä¸­çš„æ•°æ®ä¸è§äº†

**æ£€æŸ¥æ¸…å•**ï¼š
1. Namespace æ˜¯å¦æ­£ç¡®ï¼Ÿ
2. PostgreSQL æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Ÿ
3. æ˜¯å¦æ‰§è¡Œäº† `docker compose down -v`ï¼ˆåˆ é™¤äº†æ•°æ®å·ï¼‰ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# éªŒè¯ namespace
items = await client.store.search_items(
    ("todo", "general", "Test"),  # ç¡®ä¿ namespace æ­£ç¡®
    limit=100
)

print(f"Found {len(items['items'])} items")
```

---

## åã€æ€§èƒ½ä¼˜åŒ–

### 10.1 æ‰¹é‡æ“ä½œ

**ä¸å¥½çš„åšæ³•**ï¼š
```python
# é€ä¸ªåˆ›å»ºè¿è¡Œ
for task in tasks:
    run = await client.runs.create(...)
    await client.runs.join(...)  # ç­‰å¾…æ¯ä¸ªå®Œæˆ
```

**å¥½çš„åšæ³•**ï¼š
```python
# å¹¶å‘åˆ›å»ºè¿è¡Œ
runs = []
for task in tasks:
    run = await client.runs.create(...)
    runs.append(run)

# ä¸€æ¬¡æ€§ç­‰å¾…æ‰€æœ‰å®Œæˆ
await asyncio.gather(*[
    client.runs.join(thread_id, run["run_id"])
    for run in runs
])
```

### 10.2 è¿æ¥æ± 

```python
import httpx

# ä½¿ç”¨è¿æ¥æ± 
async with httpx.AsyncClient() as http_client:
    client = get_client(
        url="http://localhost:8123",
        http_client=http_client
    )

    # ä½¿ç”¨ client...
```

### 10.3 ç¼“å­˜

```python
from functools import lru_cache
from datetime import datetime, timedelta

# ç¼“å­˜çº¿ç¨‹çŠ¶æ€
_state_cache = {}
_cache_ttl = timedelta(seconds=5)

async def get_thread_state_cached(client, thread_id):
    now = datetime.now()

    if thread_id in _state_cache:
        state, timestamp = _state_cache[thread_id]
        if now - timestamp < _cache_ttl:
            return state

    state = await client.threads.get_state(thread_id)
    _state_cache[thread_id] = (state, now)
    return state
```

---

## åä¸€ã€Python å’Œå¼‚æ­¥ç¼–ç¨‹çŸ¥è¯†æ€»ç»“

### 11.1 async/await åŸºç¡€

```python
# å¼‚æ­¥å‡½æ•°å®šä¹‰
async def my_async_function():
    # å¼‚æ­¥æ“ä½œ
    result = await some_async_operation()
    return result

# è°ƒç”¨å¼‚æ­¥å‡½æ•°
result = await my_async_function()

# åœ¨ Jupyter ä¸­
# å¯ä»¥ç›´æ¥ä½¿ç”¨ await
thread = await client.threads.create()

# åœ¨æ™®é€š Python è„šæœ¬ä¸­
# éœ€è¦ä½¿ç”¨ asyncio.run()
import asyncio
asyncio.run(my_async_function())
```

### 11.2 å¼‚æ­¥è¿­ä»£

```python
# å¼‚æ­¥ for å¾ªç¯
async for chunk in client.runs.stream(...):
    print(chunk)

# ç­‰ä»·äºåŒæ­¥ç‰ˆæœ¬ï¼š
# for item in sync_iterator:
#     print(item)
```

### 11.3 å¹¶å‘æ‰§è¡Œ

```python
import asyncio

# æ–¹æ³• 1ï¼šasyncio.gatherï¼ˆæ¨èï¼‰
results = await asyncio.gather(
    client.threads.create(),
    client.threads.create(),
    client.threads.create()
)
# è¿”å› [thread1, thread2, thread3]

# æ–¹æ³• 2ï¼šasyncio.wait
tasks = [
    client.threads.create(),
    client.threads.create()
]
done, pending = await asyncio.wait(tasks)

# æ–¹æ³• 3ï¼šæ‰‹åŠ¨ç®¡ç†
tasks = []
for i in range(10):
    task = asyncio.create_task(client.threads.create())
    tasks.append(task)

results = await asyncio.gather(*tasks)
```

### 11.4 å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
# å¼‚æ­¥ with è¯­å¥
async with httpx.AsyncClient() as client:
    response = await client.get("http://...")

# ç­‰ä»·äºï¼š
client = httpx.AsyncClient()
try:
    response = await client.get("http://...")
finally:
    await client.aclose()
```

---

## åäºŒã€æ€»ç»“

### 12.1 æ ¸å¿ƒè¦ç‚¹

1. **ä¸¤ç§è¿æ¥æ–¹å¼**
   - LangGraph SDKï¼šå…¨åŠŸèƒ½ï¼Œæ¨èç”Ÿäº§ç¯å¢ƒ
   - Remote Graphï¼šç®€åŒ–æ¥å£ï¼Œå¿«é€ŸåŸå‹

2. **ä¸‰ç§è¿è¡Œç±»å‹**
   - Background Runï¼šåå°æ‰§è¡Œï¼Œä¸ç­‰å¾…
   - Blocking Runï¼šç­‰å¾…å®Œæˆ
   - Streaming Runï¼šå®æ—¶æµå¼ä¼ è¾“

3. **Threads çš„å¨åŠ›**
   - å¤šè½®å¯¹è¯
   - çŠ¶æ€æŒä¹…åŒ–
   - æ—¶é—´æ—…è¡Œ
   - Human in the loop

4. **Store API**
   - è·¨çº¿ç¨‹è®°å¿†
   - search/put/delete æ“ä½œ
   - Namespace ç»„ç»‡

### 12.2 API å¿«é€Ÿå‚è€ƒ

```python
# è¿æ¥
client = get_client(url="http://localhost:8123")

# Threads
thread = await client.threads.create()
state = await client.threads.get_state(thread_id)
copied = await client.threads.copy(thread_id)
history = await client.threads.get_history(thread_id)
await client.threads.update_state(thread_id, values, checkpoint_id)

# Runs
run = await client.runs.create(thread_id, assistant_id, input, config)
status = await client.runs.get(thread_id, run_id)
await client.runs.join(thread_id, run_id)
async for chunk in client.runs.stream(thread_id, assistant_id, ...):
    pass

# Store
items = await client.store.search_items(namespace, limit, offset)
await client.store.put_item(namespace, key, value)
item = await client.store.get_item(namespace, key)
await client.store.delete_item(namespace, key)
```

### 12.3 æœ€ä½³å®è·µæ¸…å•

- âœ… ä½¿ç”¨ LangGraph SDK è€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ REST API
- âœ… ä¸ºé•¿æ—¶é—´ä»»åŠ¡ä½¿ç”¨æµå¼ä¼ è¾“
- âœ… åˆç†ä½¿ç”¨ threads è¿›è¡Œå¤šè½®å¯¹è¯
- âœ… åˆ©ç”¨ checkpoints å®ç° Human in the loop
- âœ… ä½¿ç”¨ store ä¿å­˜è·¨çº¿ç¨‹è®°å¿†
- âœ… å®ç°é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- âœ… è®°å½•æ—¥å¿—ä¾¿äºè°ƒè¯•
- âœ… ä½¿ç”¨å¼‚æ­¥å¹¶å‘æé«˜æ€§èƒ½

### 12.4 ä¸‹èŠ‚é¢„å‘Š

åœ¨ **6.3-double-texting** ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š
- ä»€ä¹ˆæ˜¯ double textingï¼ˆå¹¶å‘è¯·æ±‚ï¼‰
- Reject ç­–ç•¥ï¼šæ‹’ç»æ–°è¯·æ±‚
- Enqueue ç­–ç•¥ï¼šæ’é˜Ÿç­‰å¾…
- Interrupt ç­–ç•¥ï¼šä¸­æ–­å½“å‰
- Rollback ç­–ç•¥ï¼šå›æ»šé‡æ–°å¼€å§‹
- å¦‚ä½•é€‰æ‹©åˆé€‚çš„ç­–ç•¥

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
**æœ€åæ›´æ–°**ï¼š2024-11-05
**ä½œè€…**ï¼šAI Assistant
**åŸºäº**ï¼šLangChain Academy Module-6 Lesson 6.2

æ­å–œä½ æŒæ¡äº† LangGraph Platform çš„æ ¸å¿ƒ APIï¼ç°åœ¨ä½ å¯ä»¥è‡ªç”±åœ°è¿æ¥å’Œä½¿ç”¨éƒ¨ç½²çš„å›¾äº†ã€‚ğŸ‰
