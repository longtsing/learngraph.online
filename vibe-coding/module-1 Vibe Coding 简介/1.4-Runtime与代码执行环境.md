# 1.4 Runtime + Agent + Code Execution 环境

> **核心问题:** AI 生成的代码在哪里运行?如何确保安全、高效、可靠?

---

## 🎯 什么是 AI 代码执行环境?

### 定义

**AI 代码执行环境(Code Execution Runtime)** 是专为 AI Agent 设计的安全、隔离的代码运行环境,提供:

- 🔒 **沙盒隔离** - 防止恶意代码破坏系统
- ⚡ **即时执行** - 无需本地配置环境
- 🌐 **云端运行** - 随时随地访问
- 🔧 **工具集成** - 预装常用库和工具
- 📊 **状态管理** - 保持会话和数据

### 为什么需要专门的执行环境?

**传统方式 vs AI 执行环境:**

| 问题 | 传统本地执行 | AI 执行环境 |
|------|------------|-----------|
| **安全性** | AI 生成代码可能有风险 | 完全隔离的沙盒 |
| **环境配置** | 需要手动安装依赖 | 预配置环境 |
| **资源限制** | 受限于本地硬件 | 云端弹性扩展 |
| **持久化** | 需要手动管理 | 自动状态保存 |
| **协作** | 难以共享环境 | 云端共享 |

---

## 🏆 主流 AI 代码执行平台对比

### 综合对比表

| 平台 | 类型 | 定位 | 价格 | 执行时长 | 最佳场景 |
|------|------|------|------|---------|---------|
| **E2B** | Agent Runtime | AI Agent 后端基础设施 | 使用量计费 | 无限制 | AI Agent 开发 |
| **Replit Agent** | 全功能 IDE | 自主编程 Agent | 免费-$20/月 | 200 分钟 | 全栈应用开发 |
| **Modal** | 函数级执行 | 数据/AI 工作负载 | 使用量计费 | 分钟-小时 | ML Pipeline |
| **Steprun.ai** | 安全 REPL | 企业级安全 | 按需定价 | 分钟级 | 企业 AI Agent |
| **SkyPilot** | 自托管方案 | 多云 LLM 沙盒 | 云成本 | 自定义 | 私有部署 |

---

## 🔷 E2B - AI Agent 的云端基础设施

### 核心能力

**E2B (Everything at Build)** 是专为 AI Agent 设计的云端执行环境。

#### 1. 核心概念

**Agent Runtime:**
```
E2B Runtime = 独立的云端容器
├─ 完整的 Linux 环境
├─ 预装开发工具(Node, Python, Git 等)
├─ 文件系统访问
├─ 互联网连接
└─ 可编程的 API
```

#### 2. 工作流程

**创建和使用:**
```typescript
import { Sandbox } from '@e2b/sdk'

// 创建沙盒环境
const sandbox = await Sandbox.create({
  template: 'base',  // 或自定义模板
  timeout: 300000    // 5 分钟超时
})

// AI Agent 执行代码
const result = await sandbox.runCode(`
import pandas as pd
df = pd.read_csv('data.csv')
print(df.describe())
`)

console.log(result.stdout)

// 关闭环境
await sandbox.kill()
```

#### 3. 关键特性

**Ephemeral Environments(临时环境):**
```
特点:
├─ 随时创建,用完即删
├─ 完全隔离,互不干扰
├─ 自动清理,无残留
└─ 秒级启动速度
```

**Persistent Sessions(持久会话):**
```
场景:长时间运行的 AI 任务
├─ 保存文件和状态
├─ 断线重连
├─ 跨请求共享数据
└─ 适合开发服务器
```

#### 4. 使用场景

**典型应用:**

```
场景 A: AI 代码生成器
├─ AI 生成代码
├─ E2B 沙盒中执行
├─ 返回结果或错误
└─ AI 根据反馈修复

场景 B: 数据分析 Agent
├─ 用户上传数据
├─ AI 在 E2B 中运行分析
├─ 生成可视化图表
└─ 返回洞察报告

场景 C: 自动化测试
├─ AI 编写测试代码
├─ E2B 运行测试套件
├─ 收集覆盖率报告
└─ AI 优化测试
```

### 定价模型(2025)

**按使用量计费:**
```
免费层:
├─ 100 小时/月 运行时间
├─ 1 GB 存储
└─ 标准 CPU/内存

付费层:
├─ $0.10/小时 运行时间
├─ $0.02/GB 存储/月
└─ 自定义资源配置
```

### 与竞品对比

**E2B vs Replit vs Codesandbox:**

| 特性 | E2B | Replit | Codesandbox |
|------|-----|--------|------------|
| **定位** | AI Agent 后端 | 协作 IDE | 前端沙盒 |
| **编程式 API** | ✅ 核心功能 | ⚠️ 有限 | ❌ 不支持 |
| **自定义环境** | ✅ 完全自定义 | ⚠️ 部分支持 | ⚠️ 模板限制 |
| **多语言支持** | ✅ 全栈 | ✅ 全栈 | ⭐ 偏前端 |
| **AI 集成** | ✅ 专为 AI 设计 | ✅ 内置 Agent | ❌ 无原生支持 |

### 最佳场景

```
✅ 构建 AI 编程工具(如 Cursor 的后端)
✅ 数据分析和 ML 实验
✅ 代码执行即服务(Code Execution as a Service)
✅ 自动化 CI/CD Pipeline
❌ 不适合长期运行的生产服务
```

---

## 🟢 Replit Agent 3 - 自主全栈开发 Agent

### 核心能力

**Replit Agent** 是内置在 Replit IDE 中的自主编程 Agent,2025 年推出的 Agent 3 版本实现了重大升级。

#### 1. 扩展自主性

**200 分钟连续运行:**
```
Agent 3 的能力:
├─ 规划整个应用架构
├─ 编写前后端代码
├─ 执行并测试代码
├─ 识别错误并修复
├─ 重新运行直到通过
└─ 无需人工干预
```

**自主迭代:**
```python
# 示例工作流
任务: "创建待办事项应用"

Replit Agent 3:
├─ [分析] 确定技术栈(React + Express)
├─ [生成] 创建项目结构
├─ [编写] 实现功能代码
├─ [运行] 启动开发服务器
├─ [测试] 自动测试功能
├─ [错误] 发现 API 端点 404
├─ [修复] 更正路由配置
├─ [重测] 再次验证
├─ [成功] 应用可正常使用
└─ [部署] 一键部署到生产
```

#### 2. Agent 生成器

**自定义工作流 Agent:**
```
你的描述:
"我需要一个 Agent,每天早上从 Google Sheets 读取数据,
 分析趋势,生成报告并发送到 Slack"

Replit Agent 3:
├─ 理解需求
├─ 生成专门的 Agent
├─ 配置 Google Sheets API
├─ 配置 Slack Webhook
├─ 编写分析逻辑
├─ 设置定时任务
└─ 部署运行
```

#### 3. 全栈能力

**前后端一体:**
```
支持的技术栈:
├─ 前端:React, Vue, Svelte, Next.js
├─ 后端:Node.js, Python, Go, Ruby
├─ 数据库:PostgreSQL, MongoDB, Redis
├─ 部署:一键部署到 Replit Hosting
└─ AI 模型:集成 OpenAI, Anthropic
```

### 定价(2025)

**分层定价:**

| 计划 | 价格 | Agent 使用 |
|------|------|-----------|
| **Free** | $0 | 有限 Agent 调用 |
| **Hacker** | $7/月 | 基础 Agent 功能 |
| **Pro** | $20/月 | 完整 Agent 3 能力 |
| **Team** | $40/月/用户 | 团队协作 + Agent |

### 最佳场景

```
✅ 快速 MVP 开发
✅ 全栈应用原型
✅ 教育和学习
✅ Hackathon 项目
✅ 工作流自动化 Agent
```

### 实战案例

**场景:60 分钟构建 SaaS 应用**

```
任务:创建一个链接缩短服务

用户输入:
"创建短链接服务,支持用户注册、创建短链、
 查看访问统计,使用 Next.js + Supabase"

Replit Agent 3 执行:
├─ [0-10 分钟] 项目初始化
│  ├─ 创建 Next.js 项目
│  ├─ 配置 Supabase
│  └─ 设计数据库 schema
│
├─ [10-30 分钟] 核心功能
│  ├─ 用户认证(Supabase Auth)
│  ├─ 创建短链 API
│  ├─ 重定向服务
│  └─ 前端 UI 组件
│
├─ [30-45 分钟] 统计功能
│  ├─ 访问追踪
│  ├─ 数据可视化
│  └─ 用户仪表盘
│
├─ [45-55 分钟] 测试修复
│  ├─ 运行应用
│  ├─ 发现 3 个 bug
│  └─ 自动修复
│
└─ [55-60 分钟] 部署
   └─ 部署到 Replit Hosting

结果:可用的 MVP,包含完整功能
```

---

## ⚡ Modal - 高性能函数级执行

### 核心能力

**Modal** 专注于数据和 AI 工作负载的函数级执行。

#### 1. 函数即服务

**声明式部署:**
```python
import modal

app = modal.App("my-ai-app")

@app.function(
    image=modal.Image.debian_slim().pip_install("openai"),
    gpu="A100",  # 指定 GPU
    timeout=600
)
def generate_image(prompt: str):
    import openai
    response = openai.Image.create(
        prompt=prompt,
        n=1,
        size="1024x1024"
    )
    return response['data'][0]['url']

# 本地调用,云端执行
with app.run():
    url = generate_image.remote("a cat wearing sunglasses")
    print(url)
```

#### 2. 资源优化

**成本效益:**
```
Modal 的优势:
├─ 按秒计费
├─ 自动扩展(0-1000+ 实例)
├─ GPU 资源按需分配
└─ 闲置时自动关闭

劣势:
├─ 冷启动时间:2-5 秒
├─ 不适合低延迟场景
└─ 更适合批处理任务
```

### 最佳场景

```
✅ ML 模型训练和推理
✅ 批量数据处理
✅ 定时任务和 CRON jobs
✅ GPU 密集型任务
❌ 实时 AI Agent 交互
❌ 低延迟要求的应用
```

---

## 🔐 Steprun.ai - 企业级安全 REPL

### 核心能力

**Steprun.ai** 专注于企业级安全和合规性。

#### 1. 安全特性

**多层隔离:**
```
安全架构:
├─ 容器级隔离
├─ 网络隔离
├─ 资源限制
├─ 代码审计日志
└─ 合规性报告
```

#### 2. 与 E2B/Replit 的区别

| 特性 | Steprun.ai | E2B | Replit |
|------|-----------|-----|--------|
| **企业安全** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| **合规认证** | ✅ SOC 2, ISO 27001 | ⚠️ 部分 | ⚠️ 部分 |
| **私有部署** | ✅ 支持 | ❌ 云端 only | ❌ 云端 only |
| **审计追踪** | ✅ 完整日志 | ⚠️ 基础 | ⚠️ 基础 |

### 最佳场景

```
✅ 金融、医疗等强监管行业
✅ 需要私有部署的企业
✅ 严格合规要求的项目
✅ 大型企业 AI Agent 系统
```

---

## 🏗️ SkyPilot - 自托管 LLM 沙盒

### 核心能力

**SkyPilot** 允许在自己的云账户中部署 AI 代码沙盒。

#### 1. 多云支持

**灵活部署:**
```
支持的云平台:
├─ AWS
├─ Google Cloud
├─ Azure
├─ Lambda Labs
└─ 本地 Kubernetes
```

#### 2. 成本优势

**实际成本:**
```
对比:
├─ E2B 托管:$0.10/小时
├─ SkyPilot (AWS EC2):$0.03-0.05/小时
└─ 节省:50-70%

适合:
├─ 高频使用场景
├─ 需要持续运行
└─ 预算敏感项目
```

### 最佳场景

```
✅ 需要完全控制基础设施
✅ 高使用量(成本优化)
✅ 特殊网络/安全要求
✅ 多云策略
❌ 小型项目(管理开销大)
```

---

## 📊 选择指南:决策树

```
需要 AI 代码执行环境?
    │
    ├─ 构建 AI 编程工具?
    │   └─ E2B (专为 AI Agent 设计)
    │
    ├─ 全栈应用开发?
    │   └─ Replit Agent (IDE + Runtime 一体)
    │
    ├─ ML/数据工作负载?
    │   └─ Modal (GPU 支持,函数级执行)
    │
    ├─ 企业级安全需求?
    │   └─ Steprun.ai (合规认证)
    │
    └─ 需要自托管?
        └─ SkyPilot (多云自部署)
```

---

## 🎯 实战对比:AI 代码调试工具

### 场景描述

**需求:**
构建一个工具,AI 帮用户调试代码:
1. 用户提交代码
2. AI 分析问题
3. 在沙盒中测试修复
4. 返回修复后的代码

### 各平台实现

#### E2B 实现

```typescript
async function debugCode(userCode: string) {
  const sandbox = await Sandbox.create()

  // AI 分析代码
  const analysis = await analyzeWithAI(userCode)

  // 在 E2B 中测试修复
  const testResult = await sandbox.runCode(analysis.fixedCode)

  if (testResult.error) {
    // AI 再次修复
    const secondFix = await analyzeWithAI(
      userCode,
      testResult.error
    )
    return secondFix
  }

  await sandbox.kill()
  return analysis.fixedCode
}

优势:
✅ 完全可编程
✅ 灵活的 API
✅ 快速迭代

劣势:
⚠️ 需要管理沙盒生命周期
⚠️ 需要自己构建 UI
```

#### Replit Agent 实现

```
用户体验:
1. 在 Replit 中打开项目
2. @Agent "调试这个函数,它有内存泄漏"
3. Agent 自动:
   ├─ 分析代码
   ├─ 识别问题(未关闭的连接)
   ├─ 应用修复
   ├─ 运行测试验证
   └─ 显示修复说明

优势:
✅ 零配置
✅ 完整的 IDE 体验
✅ 自动测试和验证

劣势:
⚠️ 受限于 Replit 平台
⚠️ 难以集成到外部工具
```

---

## 📌 本节核心要点

1. **E2B** - AI Agent 的云端基础设施,编程式 API
2. **Replit Agent** - 200 分钟自主开发,全栈能力
3. **Modal** - 高性能函数执行,GPU 支持,适合 ML
4. **Steprun.ai** - 企业级安全,合规认证
5. **SkyPilot** - 自托管方案,成本优化

**下一步:** [1.5 前端/全栈 AI 生成工具](./1.5-前端全栈AI生成工具.md) - 探索 v0、Bolt.new、Lovable 等快速原型工具

---

**参考资料:**
- [E2B Documentation](https://e2b.dev/)
- [Replit Agent 3 Announcement](https://www.infoq.com/news/2025/09/replit-agent-3/)
- [Modal Documentation](https://modal.com/)
- [Top Code Sandbox Platforms 2025](https://www.koyeb.com/blog/top-sandbox-code-execution-platforms-for-ai-code-execution-2025)
- [Secure Code Execution in AI Agents](https://saurabh-shukla.medium.com/secure-code-execution-in-ai-agents-d2ad84cbec97)
